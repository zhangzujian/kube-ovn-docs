{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\u200b\\-]"},"docs":[{"location":"","text":"Kube-OVN Kube-OVN \u662f\u4e00\u6b3e CNCF \u65d7\u4e0b\u7684\u4f01\u4e1a\u7ea7\u4e91\u539f\u751f\u7f51\u7edc\u7f16\u6392\u7cfb\u7edf\uff0c\u5c06 SDN \u7684\u80fd\u529b\u548c\u4e91\u539f\u751f\u7ed3\u5408\uff0c \u63d0\u4f9b\u4e30\u5bcc\u7684\u529f\u80fd\uff0c\u6781\u81f4\u7684\u6027\u80fd\u4ee5\u53ca\u826f\u597d\u7684\u53ef\u8fd0\u7ef4\u6027\u3002 \u4e30\u5bcc\u7684\u529f\u80fd\uff1a \u5982\u679c\u4f60\u6000\u5ff5 SDN \u9886\u57df\u4e30\u5bcc\u7684\u7f51\u7edc\u80fd\u529b\u5374\u5728\u4e91\u539f\u751f\u9886\u57df\u82e6\u82e6\u8ffd\u5bfb\u800c\u4e0d\u5f97\uff0c\u90a3\u4e48 Kube-OVN \u5e94\u8be5\u662f\u4f60\u7684\u6700\u4f73\u9009\u62e9\u3002 \u501f\u52a9 OVS/OVN \u5728 SDN \u9886\u57df\u6210\u719f\u7684\u80fd\u529b\uff0cKube-OVN \u5c06\u7f51\u7edc\u865a\u62df\u5316\u7684\u4e30\u5bcc\u529f\u80fd\u5e26\u5165\u4e91\u539f\u751f\u9886\u57df\u3002\u76ee\u524d\u5df2\u652f\u6301\u5b50\u7f51\u7ba1\u7406\uff0c \u9759\u6001 IP \u5206\u914d\uff0c\u5206\u5e03\u5f0f/\u96c6\u4e2d\u5f0f\u7f51\u5173\uff0cUnderlay/Overlay \u6df7\u5408\u7f51\u7edc\uff0cVPC \u591a\u79df\u6237\u7f51\u7edc\uff0c\u8de8\u96c6\u7fa4\u4e92\u8054\u7f51\u7edc\uff0cQoS \u7ba1\u7406\uff0c \u591a\u7f51\u5361\u7ba1\u7406\uff0cACL \u7f51\u7edc\u63a7\u5236\uff0c\u6d41\u91cf\u955c\u50cf\uff0cARM \u652f\u6301\uff0c Windows \u652f\u6301\u7b49\u8bf8\u591a\u529f\u80fd\u3002 \u6781\u81f4\u7684\u6027\u80fd\uff1a \u5982\u679c\u4f60\u62c5\u5fc3\u5bb9\u5668\u7f51\u7edc\u4f1a\u5e26\u6765\u989d\u5916\u7684\u6027\u80fd\u635f\u8017\uff0c\u90a3\u4e48\u6765\u770b\u4e00\u4e0b Kube-OVN \u662f\u5982\u4f55\u6781\u81f4\u7684\u4f18\u5316\u6027\u80fd\u3002 \u5728\u6570\u636e\u5e73\u9762\uff0c\u901a\u8fc7\u4e00\u7cfb\u5217\u5bf9\u6d41\u8868\u548c\u5185\u6838\u7684\u7cbe\u5fc3\u4f18\u5316\uff0c\u5e76\u501f\u52a9 eBPF\u3001DPDK\u3001\u667a\u80fd\u7f51\u5361\u5378\u8f7d\u7b49\u65b0\u5174\u6280\u672f\uff0cKube-OVN \u53ef\u4ee5\u5728\u5ef6\u8fdf\u548c\u541e\u5410\u91cf \u7b49\u65b9\u9762\u7684\u6307\u6807\u8fbe\u5230\u8fd1\u4f3c\u6216\u8d85\u51fa\u5bbf\u4e3b\u673a\u7f51\u7edc\u6027\u80fd\u7684\u6c34\u5e73\u3002 \u5728\u63a7\u5236\u5e73\u9762\uff0c\u901a\u8fc7\u5bf9 OVN \u4e0a\u6e38\u6d41\u8868\u7684\u88c1\u526a\uff0c\u5404\u79cd\u7f13\u5b58\u6280\u672f\u7684\u4f7f\u7528\u548c\u8c03\u4f18\uff0c Kube-OVN \u53ef\u4ee5\u652f\u6301\u5927\u89c4\u6a21\u4e0a\u5343\u8282\u70b9\u548c\u4e0a\u4e07 Pod \u7684\u96c6\u7fa4\u3002 \u6b64\u5916 Kube-OVN \u8fd8\u5728\u4e0d\u65ad\u4f18\u5316 CPU \u548c\u5185\u5b58\u7b49\u8d44\u6e90\u7684\u4f7f\u7528\u91cf\uff0c\u4ee5\u9002\u5e94\u8fb9\u7f18\u7b49\u8d44\u6e90\u6709\u9650\u573a\u666f\u3002 \u826f\u597d\u7684\u53ef\u8fd0\u7ef4\u6027\uff1a \u5982\u679c\u4f60\u5bf9\u5bb9\u5668\u7f51\u7edc\u7684\u8fd0\u7ef4\u5fc3\u5b58\u5fe7\u8651\uff0cKube-OVN \u5185\u7f6e\u4e86\u5927\u91cf\u7684\u5de5\u5177\u6765\u5e2e\u52a9\u4f60\u7b80\u5316\u8fd0\u7ef4\u64cd\u4f5c\u3002 Kube-OVN \u63d0\u4f9b\u4e86\u4e00\u952e\u5b89\u88c5\u811a\u672c\uff0c\u5e2e\u52a9\u7528\u6237\u8fc5\u901f\u642d\u5efa\u751f\u4ea7\u5c31\u7eea\u7684\u5bb9\u5668\u7f51\u7edc\u3002 \u540c\u65f6\u5185\u7f6e\u7684\u4e30\u5bcc\u7684\u76d1\u63a7\u6307\u6807\u548c Grafana \u9762\u677f\uff0c \u53ef\u5e2e\u52a9\u7528\u6237\u5efa\u7acb\u5b8c\u5584\u7684\u76d1\u63a7\u4f53\u7cfb\u3002\u5f3a\u5927\u7684\u547d\u4ee4\u884c\u5de5\u5177\u53ef\u4ee5\u7b80\u5316\u7528\u6237\u7684\u65e5\u5e38\u8fd0\u7ef4\u64cd\u4f5c\u3002\u901a\u8fc7\u548c Cilium \u7ed3\u5408\uff0c\u5229\u7528 eBPF \u80fd\u529b\u7528\u6237\u53ef\u4ee5 \u589e\u5f3a\u5bf9\u7f51\u7edc\u7684\u53ef\u89c2\u6d4b\u6027\u3002 \u6b64\u5916\u6d41\u91cf\u955c\u50cf\u7684\u80fd\u529b\u53ef\u4ee5\u65b9\u4fbf\u7528\u6237\u81ea\u5b9a\u4e49\u6d41\u91cf\u76d1\u63a7\uff0c\u5e76\u548c\u4f20\u7edf\u7684 NPM \u7cfb\u7edf\u5bf9\u63a5\u3002 \u8054\u7cfb\u6211\u4eec \u5982\u9700\u52a0\u5165\u5fae\u4fe1\u7528\u6237\u4ea4\u6d41\u7fa4\uff0c\u8bf7\u626b\u63cf\u4e0b\u65b9\u4e8c\u7ef4\u7801\u5e76\u586b\u5199\u8868\u5355\uff1a \u5173\u6ce8\u516c\u4f17\u53f7\u83b7\u5f97\u66f4\u591a\u6700\u65b0\u4fe1\u606f: \u5982\u9700\u83b7\u5f97\u5546\u4e1a\u652f\u6301\u548c\u54a8\u8be2\u670d\u52a1\uff0c\u8bf7\u4f7f\u7528\u4e0b\u65b9\u8fde\u63a5\u6216\u626b\u63cf\u4e8c\u7ef4\u7801\u586b\u5199\u8868\u5355\uff1a \u5546\u4e1a\u7248\u652f\u6301","title":"\u4e3b\u9875"},{"location":"#kube-ovn","text":"Kube-OVN \u662f\u4e00\u6b3e CNCF \u65d7\u4e0b\u7684\u4f01\u4e1a\u7ea7\u4e91\u539f\u751f\u7f51\u7edc\u7f16\u6392\u7cfb\u7edf\uff0c\u5c06 SDN \u7684\u80fd\u529b\u548c\u4e91\u539f\u751f\u7ed3\u5408\uff0c \u63d0\u4f9b\u4e30\u5bcc\u7684\u529f\u80fd\uff0c\u6781\u81f4\u7684\u6027\u80fd\u4ee5\u53ca\u826f\u597d\u7684\u53ef\u8fd0\u7ef4\u6027\u3002 \u4e30\u5bcc\u7684\u529f\u80fd\uff1a \u5982\u679c\u4f60\u6000\u5ff5 SDN \u9886\u57df\u4e30\u5bcc\u7684\u7f51\u7edc\u80fd\u529b\u5374\u5728\u4e91\u539f\u751f\u9886\u57df\u82e6\u82e6\u8ffd\u5bfb\u800c\u4e0d\u5f97\uff0c\u90a3\u4e48 Kube-OVN \u5e94\u8be5\u662f\u4f60\u7684\u6700\u4f73\u9009\u62e9\u3002 \u501f\u52a9 OVS/OVN \u5728 SDN \u9886\u57df\u6210\u719f\u7684\u80fd\u529b\uff0cKube-OVN \u5c06\u7f51\u7edc\u865a\u62df\u5316\u7684\u4e30\u5bcc\u529f\u80fd\u5e26\u5165\u4e91\u539f\u751f\u9886\u57df\u3002\u76ee\u524d\u5df2\u652f\u6301\u5b50\u7f51\u7ba1\u7406\uff0c \u9759\u6001 IP \u5206\u914d\uff0c\u5206\u5e03\u5f0f/\u96c6\u4e2d\u5f0f\u7f51\u5173\uff0cUnderlay/Overlay \u6df7\u5408\u7f51\u7edc\uff0cVPC \u591a\u79df\u6237\u7f51\u7edc\uff0c\u8de8\u96c6\u7fa4\u4e92\u8054\u7f51\u7edc\uff0cQoS \u7ba1\u7406\uff0c \u591a\u7f51\u5361\u7ba1\u7406\uff0cACL \u7f51\u7edc\u63a7\u5236\uff0c\u6d41\u91cf\u955c\u50cf\uff0cARM \u652f\u6301\uff0c Windows \u652f\u6301\u7b49\u8bf8\u591a\u529f\u80fd\u3002 \u6781\u81f4\u7684\u6027\u80fd\uff1a \u5982\u679c\u4f60\u62c5\u5fc3\u5bb9\u5668\u7f51\u7edc\u4f1a\u5e26\u6765\u989d\u5916\u7684\u6027\u80fd\u635f\u8017\uff0c\u90a3\u4e48\u6765\u770b\u4e00\u4e0b Kube-OVN \u662f\u5982\u4f55\u6781\u81f4\u7684\u4f18\u5316\u6027\u80fd\u3002 \u5728\u6570\u636e\u5e73\u9762\uff0c\u901a\u8fc7\u4e00\u7cfb\u5217\u5bf9\u6d41\u8868\u548c\u5185\u6838\u7684\u7cbe\u5fc3\u4f18\u5316\uff0c\u5e76\u501f\u52a9 eBPF\u3001DPDK\u3001\u667a\u80fd\u7f51\u5361\u5378\u8f7d\u7b49\u65b0\u5174\u6280\u672f\uff0cKube-OVN \u53ef\u4ee5\u5728\u5ef6\u8fdf\u548c\u541e\u5410\u91cf \u7b49\u65b9\u9762\u7684\u6307\u6807\u8fbe\u5230\u8fd1\u4f3c\u6216\u8d85\u51fa\u5bbf\u4e3b\u673a\u7f51\u7edc\u6027\u80fd\u7684\u6c34\u5e73\u3002 \u5728\u63a7\u5236\u5e73\u9762\uff0c\u901a\u8fc7\u5bf9 OVN \u4e0a\u6e38\u6d41\u8868\u7684\u88c1\u526a\uff0c\u5404\u79cd\u7f13\u5b58\u6280\u672f\u7684\u4f7f\u7528\u548c\u8c03\u4f18\uff0c Kube-OVN \u53ef\u4ee5\u652f\u6301\u5927\u89c4\u6a21\u4e0a\u5343\u8282\u70b9\u548c\u4e0a\u4e07 Pod \u7684\u96c6\u7fa4\u3002 \u6b64\u5916 Kube-OVN \u8fd8\u5728\u4e0d\u65ad\u4f18\u5316 CPU \u548c\u5185\u5b58\u7b49\u8d44\u6e90\u7684\u4f7f\u7528\u91cf\uff0c\u4ee5\u9002\u5e94\u8fb9\u7f18\u7b49\u8d44\u6e90\u6709\u9650\u573a\u666f\u3002 \u826f\u597d\u7684\u53ef\u8fd0\u7ef4\u6027\uff1a \u5982\u679c\u4f60\u5bf9\u5bb9\u5668\u7f51\u7edc\u7684\u8fd0\u7ef4\u5fc3\u5b58\u5fe7\u8651\uff0cKube-OVN \u5185\u7f6e\u4e86\u5927\u91cf\u7684\u5de5\u5177\u6765\u5e2e\u52a9\u4f60\u7b80\u5316\u8fd0\u7ef4\u64cd\u4f5c\u3002 Kube-OVN \u63d0\u4f9b\u4e86\u4e00\u952e\u5b89\u88c5\u811a\u672c\uff0c\u5e2e\u52a9\u7528\u6237\u8fc5\u901f\u642d\u5efa\u751f\u4ea7\u5c31\u7eea\u7684\u5bb9\u5668\u7f51\u7edc\u3002 \u540c\u65f6\u5185\u7f6e\u7684\u4e30\u5bcc\u7684\u76d1\u63a7\u6307\u6807\u548c Grafana \u9762\u677f\uff0c \u53ef\u5e2e\u52a9\u7528\u6237\u5efa\u7acb\u5b8c\u5584\u7684\u76d1\u63a7\u4f53\u7cfb\u3002\u5f3a\u5927\u7684\u547d\u4ee4\u884c\u5de5\u5177\u53ef\u4ee5\u7b80\u5316\u7528\u6237\u7684\u65e5\u5e38\u8fd0\u7ef4\u64cd\u4f5c\u3002\u901a\u8fc7\u548c Cilium \u7ed3\u5408\uff0c\u5229\u7528 eBPF \u80fd\u529b\u7528\u6237\u53ef\u4ee5 \u589e\u5f3a\u5bf9\u7f51\u7edc\u7684\u53ef\u89c2\u6d4b\u6027\u3002 \u6b64\u5916\u6d41\u91cf\u955c\u50cf\u7684\u80fd\u529b\u53ef\u4ee5\u65b9\u4fbf\u7528\u6237\u81ea\u5b9a\u4e49\u6d41\u91cf\u76d1\u63a7\uff0c\u5e76\u548c\u4f20\u7edf\u7684 NPM \u7cfb\u7edf\u5bf9\u63a5\u3002","title":"Kube-OVN"},{"location":"#_1","text":"\u5982\u9700\u52a0\u5165\u5fae\u4fe1\u7528\u6237\u4ea4\u6d41\u7fa4\uff0c\u8bf7\u626b\u63cf\u4e0b\u65b9\u4e8c\u7ef4\u7801\u5e76\u586b\u5199\u8868\u5355\uff1a \u5173\u6ce8\u516c\u4f17\u53f7\u83b7\u5f97\u66f4\u591a\u6700\u65b0\u4fe1\u606f: \u5982\u9700\u83b7\u5f97\u5546\u4e1a\u652f\u6301\u548c\u54a8\u8be2\u670d\u52a1\uff0c\u8bf7\u4f7f\u7528\u4e0b\u65b9\u8fde\u63a5\u6216\u626b\u63cf\u4e8c\u7ef4\u7801\u586b\u5199\u8868\u5355\uff1a \u5546\u4e1a\u7248\u652f\u6301","title":"\u8054\u7cfb\u6211\u4eec"},{"location":"contact/","text":"\u8054\u7cfb\u65b9\u5f0f \u5982\u9700\u52a0\u5165\u5fae\u4fe1\u7528\u6237\u7fa4\u5b9e\u65f6\u4ea4\u6d41\uff0c\u8bf7\u626b\u63cf\u4e0b\u65b9\u4e8c\u7ef4\u7801\u5e76\u586b\u5199\u8868\u5355\uff1a \u5173\u6ce8\u516c\u4f17\u53f7\u83b7\u5f97\u66f4\u591a\u6700\u65b0\u4fe1\u606f\uff0c\u8bf7\u626b\u63cf\u4e0b\u65b9\u4e8c\u7ef4\u7801: \u5982\u9700\u83b7\u5f97\u5546\u4e1a\u652f\u6301\u548c\u54a8\u8be2\u670d\u52a1\uff0c\u8bf7\u4f7f\u7528\u4e0b\u65b9\u8fde\u63a5\u6216\u626b\u63cf\u4e8c\u7ef4\u7801\u586b\u5199\u8868\u5355\uff1a \u5546\u4e1a\u7248\u652f\u6301","title":"\u8054\u7cfb\u65b9\u5f0f"},{"location":"contact/#_1","text":"\u5982\u9700\u52a0\u5165\u5fae\u4fe1\u7528\u6237\u7fa4\u5b9e\u65f6\u4ea4\u6d41\uff0c\u8bf7\u626b\u63cf\u4e0b\u65b9\u4e8c\u7ef4\u7801\u5e76\u586b\u5199\u8868\u5355\uff1a \u5173\u6ce8\u516c\u4f17\u53f7\u83b7\u5f97\u66f4\u591a\u6700\u65b0\u4fe1\u606f\uff0c\u8bf7\u626b\u63cf\u4e0b\u65b9\u4e8c\u7ef4\u7801: \u5982\u9700\u83b7\u5f97\u5546\u4e1a\u652f\u6301\u548c\u54a8\u8be2\u670d\u52a1\uff0c\u8bf7\u4f7f\u7528\u4e0b\u65b9\u8fde\u63a5\u6216\u626b\u63cf\u4e8c\u7ef4\u7801\u586b\u5199\u8868\u5355\uff1a \u5546\u4e1a\u7248\u652f\u6301","title":"\u8054\u7cfb\u65b9\u5f0f"},{"location":"advance/dhcp/","text":"DHCP \u8bbe\u7f6e \u5728\u4f7f\u7528 SR-IOV \u6216 DPDK \u7c7b\u578b\u7f51\u7edc\u65f6\uff0cKubeVirt \u5185\u7f6e\u7684 DHCP \u65e0\u6cd5\u5728\u8be5\u7f51\u7edc\u6a21\u5f0f\u4e0b\u5de5\u4f5c\u3002Kube-OVN \u53ef\u4ee5\u5229\u7528 OVN \u7684 DHCP \u80fd\u529b\u5728\u5b50\u7f51\u7ea7\u522b\u8bbe\u7f6e DHCP \u9009\u9879\uff0c\u4ece\u800c\u5e2e\u52a9\u8be5\u7f51\u7edc\u7c7b\u578b\u7684 KubeVirt \u865a\u673a\u6b63\u5e38\u4f7f\u7528 DHCP \u83b7\u5f97\u5206\u914d\u7684 IP \u5730\u5740\u3002Kube-OVN \u540c\u65f6\u652f\u6301 DHCPv4 \u548c DHCPv6\u3002 \u5b50\u7f51 DHCP \u7684\u914d\u7f6e\u5982\u4e0b\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: sn-dual spec: cidrBlock: \"10.0.0.0/24,240e::a00/120\" default: false disableGatewayCheck: true disableInterConnection: false excludeIps: - 10.0.0.1 - 240e::a01 gateway: 10.0.0.1,240e::a01 gatewayNode: '' gatewayType: distributed natOutgoing: false private: false protocol: Dual provider: ovn vpc: vpc-test enableDHCP: true dhcpV4Options: \"lease_time=3600,router=10.0.0.1,server_id=169.254.0.254,server_mac=00:00:00:2E:2F:B8\" dhcpV6Options: \"server_id=00:00:00:2E:2F:C5\" enableIPv6RA: true ipv6RAConfigs: \"address_mode=dhcpv6_stateful,max_interval=30,min_interval=5,send_periodic=true\" enableDHCP : \u662f\u5426\u5f00\u542f\u5b50\u7f51\u7684 DHCP \u529f\u80fd\u3002 dhcpV4Options , dhcpV6Options : \u8be5\u5b57\u6bb5\u76f4\u63a5\u66b4\u9732 ovn-nb \u5185 DHCP \u76f8\u5173\u9009\u9879\uff0c\u8bf7\u53c2\u8003 DHCP Options \u9ed8\u8ba4\u503c\u5206\u522b\u4e3a \"lease_time=3600, router=$ipv4_gateway, server_id=169.254.0.254, server_mac=$random_mac\" \u548c server_id=$random_mac \u3002 enableIPv6RA : \u662f\u5426\u5f00\u542f DHCPv6 \u7684\u8def\u7531\u5e7f\u64ad\u529f\u80fd\u3002 ipv6RAConfigs \uff1a\u8be5\u5b57\u6bb5\u76f4\u63a5\u66b4\u9732 ovn-nb \u5185 Logical_Router_Port \u76f8\u5173\u9009\u9879\uff0c\u8bf7\u53c2\u8003 Logical Router Port \u9ed8\u8ba4\u503c\u4e3a address_mode=dhcpv6_stateful, max_interval=30, min_interval=5, send_periodic=true \u3002","title":"DHCP \u8bbe\u7f6e"},{"location":"advance/dhcp/#dhcp","text":"\u5728\u4f7f\u7528 SR-IOV \u6216 DPDK \u7c7b\u578b\u7f51\u7edc\u65f6\uff0cKubeVirt \u5185\u7f6e\u7684 DHCP \u65e0\u6cd5\u5728\u8be5\u7f51\u7edc\u6a21\u5f0f\u4e0b\u5de5\u4f5c\u3002Kube-OVN \u53ef\u4ee5\u5229\u7528 OVN \u7684 DHCP \u80fd\u529b\u5728\u5b50\u7f51\u7ea7\u522b\u8bbe\u7f6e DHCP \u9009\u9879\uff0c\u4ece\u800c\u5e2e\u52a9\u8be5\u7f51\u7edc\u7c7b\u578b\u7684 KubeVirt \u865a\u673a\u6b63\u5e38\u4f7f\u7528 DHCP \u83b7\u5f97\u5206\u914d\u7684 IP \u5730\u5740\u3002Kube-OVN \u540c\u65f6\u652f\u6301 DHCPv4 \u548c DHCPv6\u3002 \u5b50\u7f51 DHCP \u7684\u914d\u7f6e\u5982\u4e0b\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: sn-dual spec: cidrBlock: \"10.0.0.0/24,240e::a00/120\" default: false disableGatewayCheck: true disableInterConnection: false excludeIps: - 10.0.0.1 - 240e::a01 gateway: 10.0.0.1,240e::a01 gatewayNode: '' gatewayType: distributed natOutgoing: false private: false protocol: Dual provider: ovn vpc: vpc-test enableDHCP: true dhcpV4Options: \"lease_time=3600,router=10.0.0.1,server_id=169.254.0.254,server_mac=00:00:00:2E:2F:B8\" dhcpV6Options: \"server_id=00:00:00:2E:2F:C5\" enableIPv6RA: true ipv6RAConfigs: \"address_mode=dhcpv6_stateful,max_interval=30,min_interval=5,send_periodic=true\" enableDHCP : \u662f\u5426\u5f00\u542f\u5b50\u7f51\u7684 DHCP \u529f\u80fd\u3002 dhcpV4Options , dhcpV6Options : \u8be5\u5b57\u6bb5\u76f4\u63a5\u66b4\u9732 ovn-nb \u5185 DHCP \u76f8\u5173\u9009\u9879\uff0c\u8bf7\u53c2\u8003 DHCP Options \u9ed8\u8ba4\u503c\u5206\u522b\u4e3a \"lease_time=3600, router=$ipv4_gateway, server_id=169.254.0.254, server_mac=$random_mac\" \u548c server_id=$random_mac \u3002 enableIPv6RA : \u662f\u5426\u5f00\u542f DHCPv6 \u7684\u8def\u7531\u5e7f\u64ad\u529f\u80fd\u3002 ipv6RAConfigs \uff1a\u8be5\u5b57\u6bb5\u76f4\u63a5\u66b4\u9732 ovn-nb \u5185 Logical_Router_Port \u76f8\u5173\u9009\u9879\uff0c\u8bf7\u53c2\u8003 Logical Router Port \u9ed8\u8ba4\u503c\u4e3a address_mode=dhcpv6_stateful, max_interval=30, min_interval=5, send_periodic=true \u3002","title":"DHCP \u8bbe\u7f6e"},{"location":"advance/dpdk/","text":"DPDK \u652f\u6301 \u8be5\u6587\u6863\u4ecb\u7ecd Kube-OVN \u5982\u4f55\u548c OVS-DPDK \u7ed3\u5408\uff0c\u7ed9 KubeVirt \u7684\u865a\u673a\u63d0\u4f9b DPDK \u7c7b\u578b\u7684\u7f51\u7edc\u63a5\u53e3\u3002 \u4e0a\u6e38\u7684 KubeVirt \u76ee\u524d\u8fd8\u672a\u652f\u6301 OVS-DPDK\uff0c\u7528\u6237\u9700\u8981\u81ea\u5df1\u901a\u8fc7\u76f8\u5173 patch Vhostuser implementation \u6784\u5efa KubeVirt \u6216 KVM Device Plugin \u6765\u4f7f\u7528 OVS-DPDK\u3002 \u524d\u63d0\u6761\u4ef6 \u8282\u70b9\u9700\u63d0\u4f9b\u4e13\u95e8\u7ed9 DPDK \u9a71\u52a8\u8fd0\u884c\u7684\u7f51\u5361\u3002 \u8282\u70b9\u9700\u5f00\u542f Hugepages\u3002 \u7f51\u5361\u8bbe\u7f6e DPDK \u9a71\u52a8 \u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 driverctl \u4e3a\u4f8b\u8fdb\u884c\u64cd\u4f5c\uff0c\u5177\u4f53\u53c2\u6570\u548c\u5176\u4ed6\u9a71\u52a8\u4f7f\u7528\u8bf7\u53c2\u8003 DPDK \u6587\u6863 \u8fdb\u884c\u64cd\u4f5c\u3002 driverctl set-override 0000:00:0b.0 uio_pci_generic \u8282\u70b9\u914d\u7f6e \u5bf9\u652f\u6301 OVS-DPDK \u7684\u8282\u70b9\u6253\u6807\u7b7e\uff0c\u4ee5\u4fbf Kube-OVN \u8fdb\u884c\u8bc6\u522b\u5904\u7406\uff1a kubectl label nodes <node> ovn.kubernetes.io/ovs_dp_type=\"userspace\" \u5728\u652f\u6301 OVS-DPDK \u8282\u70b9\u7684 /opt/ovs-config \u76ee\u5f55\u4e0b\u521b\u5efa\u914d\u7f6e\u6587\u4ef6 ovs-dpdk-config \uff1a ENCAP_IP=192.168.122.193/24 DPDK_DEV=0000:00:0b.0 ENCAP_IP : \u96a7\u9053\u7aef\u70b9\u5730\u5740\u3002 DPDK_DEV : \u8bbe\u5907\u7684 PCI ID\u3002 \u5b89\u88c5 Kube-OVN \u4e0b\u8f7d\u5b89\u88c5\u811a\u672c\uff1a wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/dist/images/install.sh \u542f\u7528 DPDK \u5b89\u88c5\u9009\u9879\u8fdb\u884c\u5b89\u88c5\uff1a bash install.sh --with-hybrid-dpdk \u4f7f\u7528\u65b9\u5f0f \u8fd9\u91cc\u6211\u4eec\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u4f7f\u7528 vhostuser \u7c7b\u578b\u7f51\u5361\u7684\u865a\u673a\u6765\u9a8c\u8bc1 OVS-DPDK \u529f\u80fd\u3002 \u5b89\u88c5 KVM Device Plugin \u6765\u521b\u5efa\u865a\u673a\uff0c\u66f4\u591a\u4f7f\u7528\u65b9\u5f0f\u8bf7\u53c2\u8003 KVM Device Plugin kubectl apply -f https://raw.githubusercontent.com/kubevirt/kubernetes-device-plugins/master/manifests/kvm-ds.yml \u521b\u5efa NetworkAttachmentDefinition\uff1a apiVersion: k8s.cni.cncf.io/v1 kind: NetworkAttachmentDefinition metadata: name: ovn-dpdk namespace: default spec: config: >- { \"cniVersion\": \"0.3.0\", \"type\": \"kube-ovn\", \"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\", \"provider\": \"ovn-dpdk.default.ovn\", \"vhost_user_socket_volume_name\": \"vhostuser-sockets\", \"vhost_user_socket_name\": \"sock\" } \u4f7f\u7528\u4e0b\u9762\u7684 Dockerfile \u521b\u5efa VM \u955c\u50cf\uff1a FROM quay.io/kubevirt/virt-launcher:v0.46.1 # wget http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2 COPY CentOS-7-x86_64-GenericCloud.qcow2 /var/lib/libvirt/images/CentOS-7-x86_64-GenericCloud.qcow2 \u521b\u5efa\u865a\u62df\u673a\uff1a apiVersion: v1 kind: ConfigMap metadata: name: vm-config data: start.sh: | chmod u+w /etc/libvirt/qemu.conf echo \"hugetlbfs_mount = \\\"/dev/hugepages\\\"\" >> /etc/libvirt/qemu.conf virtlogd & libvirtd & mkdir /var/lock sleep 5 virsh define /root/vm/vm.xml virsh start vm tail -f /dev/null vm.xml: | <domain type='kvm'> <name>vm</name> <uuid>4a9b3f53-fa2a-47f3-a757-dd87720d9d1d</uuid> <memory unit='KiB'>2097152</memory> <currentMemory unit='KiB'>2097152</currentMemory> <memoryBacking> <hugepages> <page size='2' unit='M' nodeset='0'/> </hugepages> </memoryBacking> <vcpu placement='static'>2</vcpu> <cputune> <shares>4096</shares> <vcpupin vcpu='0' cpuset='4'/> <vcpupin vcpu='1' cpuset='5'/> <emulatorpin cpuset='1,3'/> </cputune> <os> <type arch='x86_64' machine='pc'>hvm</type> <boot dev='hd'/> </os> <features> <acpi/> <apic/> </features> <cpu mode='host-model'> <model fallback='allow'/> <topology sockets='1' cores='2' threads='1'/> <numa> <cell id='0' cpus='0-1' memory='2097152' unit='KiB' memAccess='shared'/> </numa> </cpu> <on_reboot>restart</on_reboot> <devices> <emulator>/usr/libexec/qemu-kvm</emulator> <disk type='file' device='disk'> <driver name='qemu' type='qcow2' cache='none'/> <source file='/var/lib/libvirt/images/CentOS-7-x86_64-GenericCloud.qcow2'/> <target dev='vda' bus='virtio'/> </disk> <interface type='vhostuser'> <mac address='00:00:00:0A:30:89'/> <source type='unix' path='/var/run/vm/sock' mode='server'/> <model type='virtio'/> <driver queues='2'> <host mrg_rxbuf='off'/> </driver> </interface> <serial type='pty'> <target type='isa-serial' port='0'> <model name='isa-serial'/> </target> </serial> <console type='pty'> <target type='serial' port='0'/> </console> <channel type='unix'> <source mode='bind' path='/var/lib/libvirt/qemu/channel/target/domain-1-vm/org.qemu.guest_agent.0'/> <target type='virtio' name='org.qemu.guest_agent.0' state='connected'/> <alias name='channel0'/> <address type='virtio-serial' controller='0' bus='0' port='1'/> </channel> </devices> </domain> --- apiVersion: apps/v1 kind: Deployment metadata: name: vm-deployment labels: app: vm spec: replicas: 1 selector: matchLabels: app: vm template: metadata: labels: app: vm annotations: k8s.v1.cni.cncf.io/networks: default/ovn-dpdk ovn-dpdk.default.ovn.kubernetes.io/ip_address: 10.16.0.96 ovn-dpdk.default.ovn.kubernetes.io/mac_address: 00:00:00:0A:30:89 spec: nodeSelector: ovn.kubernetes.io/ovs_dp_type: userspace securityContext: runAsUser: 0 volumes: - name: vhostuser-sockets emptyDir: {} - name: xml configMap: name: vm-config - name: hugepage emptyDir: medium: HugePages-2Mi - name: libvirt-runtime emptyDir: {} containers: - name: vm image: vm-vhostuser:latest command: [\"bash\", \"/root/vm/start.sh\"] securityContext: capabilities: add: - NET_BIND_SERVICE - SYS_NICE - NET_RAW - NET_ADMIN privileged: false runAsUser: 0 resources: limits: cpu: '2' devices.kubevirt.io/kvm: '1' memory: '8784969729' hugepages-2Mi: 2Gi requests: cpu: 666m devices.kubevirt.io/kvm: '1' ephemeral-storage: 50M memory: '4490002433' volumeMounts: - name: vhostuser-sockets mountPath: /var/run/vm - name: xml mountPath: /root/vm/ - mountPath: /dev/hugepages name: hugepage - name: libvirt-runtime mountPath: /var/run/libvirt \u7b49\u5f85\u865a\u62df\u673a\u521b\u5efa\u6210\u529f\u540e\u8fdb\u5165 Pod \u8fdb\u884c\u865a\u673a\u914d\u7f6e\uff1a # virsh set-user-password vm root 12345 Password set successfully for root in vm # virsh console vm Connected to domain 'vm' Escape character is ^] (Ctrl + ]) CentOS Linux 7 (Core) Kernel 3.10.0-1127.el7.x86_64 on an x86_64 localhost login: root Password: Last login: Fri Feb 25 09:52:54 on ttyS0 \u63a5\u4e0b\u6765\u53ef\u4ee5\u767b\u5f55\u865a\u673a\u8fdb\u884c\u7f51\u7edc\u914d\u7f6e\u5e76\u6d4b\u8bd5\uff1a ip link set eth0 mtu 1400 ip addr add 10.16.0.96/16 dev eth0 ip ro add default via 10.16.0.1 ping 114.114.114.114","title":"DPDK \u652f\u6301"},{"location":"advance/dpdk/#dpdk","text":"\u8be5\u6587\u6863\u4ecb\u7ecd Kube-OVN \u5982\u4f55\u548c OVS-DPDK \u7ed3\u5408\uff0c\u7ed9 KubeVirt \u7684\u865a\u673a\u63d0\u4f9b DPDK \u7c7b\u578b\u7684\u7f51\u7edc\u63a5\u53e3\u3002 \u4e0a\u6e38\u7684 KubeVirt \u76ee\u524d\u8fd8\u672a\u652f\u6301 OVS-DPDK\uff0c\u7528\u6237\u9700\u8981\u81ea\u5df1\u901a\u8fc7\u76f8\u5173 patch Vhostuser implementation \u6784\u5efa KubeVirt \u6216 KVM Device Plugin \u6765\u4f7f\u7528 OVS-DPDK\u3002","title":"DPDK \u652f\u6301"},{"location":"advance/dpdk/#_1","text":"\u8282\u70b9\u9700\u63d0\u4f9b\u4e13\u95e8\u7ed9 DPDK \u9a71\u52a8\u8fd0\u884c\u7684\u7f51\u5361\u3002 \u8282\u70b9\u9700\u5f00\u542f Hugepages\u3002","title":"\u524d\u63d0\u6761\u4ef6"},{"location":"advance/dpdk/#dpdk_1","text":"\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 driverctl \u4e3a\u4f8b\u8fdb\u884c\u64cd\u4f5c\uff0c\u5177\u4f53\u53c2\u6570\u548c\u5176\u4ed6\u9a71\u52a8\u4f7f\u7528\u8bf7\u53c2\u8003 DPDK \u6587\u6863 \u8fdb\u884c\u64cd\u4f5c\u3002 driverctl set-override 0000:00:0b.0 uio_pci_generic","title":"\u7f51\u5361\u8bbe\u7f6e DPDK \u9a71\u52a8"},{"location":"advance/dpdk/#_2","text":"\u5bf9\u652f\u6301 OVS-DPDK \u7684\u8282\u70b9\u6253\u6807\u7b7e\uff0c\u4ee5\u4fbf Kube-OVN \u8fdb\u884c\u8bc6\u522b\u5904\u7406\uff1a kubectl label nodes <node> ovn.kubernetes.io/ovs_dp_type=\"userspace\" \u5728\u652f\u6301 OVS-DPDK \u8282\u70b9\u7684 /opt/ovs-config \u76ee\u5f55\u4e0b\u521b\u5efa\u914d\u7f6e\u6587\u4ef6 ovs-dpdk-config \uff1a ENCAP_IP=192.168.122.193/24 DPDK_DEV=0000:00:0b.0 ENCAP_IP : \u96a7\u9053\u7aef\u70b9\u5730\u5740\u3002 DPDK_DEV : \u8bbe\u5907\u7684 PCI ID\u3002","title":"\u8282\u70b9\u914d\u7f6e"},{"location":"advance/dpdk/#kube-ovn","text":"\u4e0b\u8f7d\u5b89\u88c5\u811a\u672c\uff1a wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/dist/images/install.sh \u542f\u7528 DPDK \u5b89\u88c5\u9009\u9879\u8fdb\u884c\u5b89\u88c5\uff1a bash install.sh --with-hybrid-dpdk","title":"\u5b89\u88c5 Kube-OVN"},{"location":"advance/dpdk/#_3","text":"\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u4f7f\u7528 vhostuser \u7c7b\u578b\u7f51\u5361\u7684\u865a\u673a\u6765\u9a8c\u8bc1 OVS-DPDK \u529f\u80fd\u3002 \u5b89\u88c5 KVM Device Plugin \u6765\u521b\u5efa\u865a\u673a\uff0c\u66f4\u591a\u4f7f\u7528\u65b9\u5f0f\u8bf7\u53c2\u8003 KVM Device Plugin kubectl apply -f https://raw.githubusercontent.com/kubevirt/kubernetes-device-plugins/master/manifests/kvm-ds.yml \u521b\u5efa NetworkAttachmentDefinition\uff1a apiVersion: k8s.cni.cncf.io/v1 kind: NetworkAttachmentDefinition metadata: name: ovn-dpdk namespace: default spec: config: >- { \"cniVersion\": \"0.3.0\", \"type\": \"kube-ovn\", \"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\", \"provider\": \"ovn-dpdk.default.ovn\", \"vhost_user_socket_volume_name\": \"vhostuser-sockets\", \"vhost_user_socket_name\": \"sock\" } \u4f7f\u7528\u4e0b\u9762\u7684 Dockerfile \u521b\u5efa VM \u955c\u50cf\uff1a FROM quay.io/kubevirt/virt-launcher:v0.46.1 # wget http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2 COPY CentOS-7-x86_64-GenericCloud.qcow2 /var/lib/libvirt/images/CentOS-7-x86_64-GenericCloud.qcow2 \u521b\u5efa\u865a\u62df\u673a\uff1a apiVersion: v1 kind: ConfigMap metadata: name: vm-config data: start.sh: | chmod u+w /etc/libvirt/qemu.conf echo \"hugetlbfs_mount = \\\"/dev/hugepages\\\"\" >> /etc/libvirt/qemu.conf virtlogd & libvirtd & mkdir /var/lock sleep 5 virsh define /root/vm/vm.xml virsh start vm tail -f /dev/null vm.xml: | <domain type='kvm'> <name>vm</name> <uuid>4a9b3f53-fa2a-47f3-a757-dd87720d9d1d</uuid> <memory unit='KiB'>2097152</memory> <currentMemory unit='KiB'>2097152</currentMemory> <memoryBacking> <hugepages> <page size='2' unit='M' nodeset='0'/> </hugepages> </memoryBacking> <vcpu placement='static'>2</vcpu> <cputune> <shares>4096</shares> <vcpupin vcpu='0' cpuset='4'/> <vcpupin vcpu='1' cpuset='5'/> <emulatorpin cpuset='1,3'/> </cputune> <os> <type arch='x86_64' machine='pc'>hvm</type> <boot dev='hd'/> </os> <features> <acpi/> <apic/> </features> <cpu mode='host-model'> <model fallback='allow'/> <topology sockets='1' cores='2' threads='1'/> <numa> <cell id='0' cpus='0-1' memory='2097152' unit='KiB' memAccess='shared'/> </numa> </cpu> <on_reboot>restart</on_reboot> <devices> <emulator>/usr/libexec/qemu-kvm</emulator> <disk type='file' device='disk'> <driver name='qemu' type='qcow2' cache='none'/> <source file='/var/lib/libvirt/images/CentOS-7-x86_64-GenericCloud.qcow2'/> <target dev='vda' bus='virtio'/> </disk> <interface type='vhostuser'> <mac address='00:00:00:0A:30:89'/> <source type='unix' path='/var/run/vm/sock' mode='server'/> <model type='virtio'/> <driver queues='2'> <host mrg_rxbuf='off'/> </driver> </interface> <serial type='pty'> <target type='isa-serial' port='0'> <model name='isa-serial'/> </target> </serial> <console type='pty'> <target type='serial' port='0'/> </console> <channel type='unix'> <source mode='bind' path='/var/lib/libvirt/qemu/channel/target/domain-1-vm/org.qemu.guest_agent.0'/> <target type='virtio' name='org.qemu.guest_agent.0' state='connected'/> <alias name='channel0'/> <address type='virtio-serial' controller='0' bus='0' port='1'/> </channel> </devices> </domain> --- apiVersion: apps/v1 kind: Deployment metadata: name: vm-deployment labels: app: vm spec: replicas: 1 selector: matchLabels: app: vm template: metadata: labels: app: vm annotations: k8s.v1.cni.cncf.io/networks: default/ovn-dpdk ovn-dpdk.default.ovn.kubernetes.io/ip_address: 10.16.0.96 ovn-dpdk.default.ovn.kubernetes.io/mac_address: 00:00:00:0A:30:89 spec: nodeSelector: ovn.kubernetes.io/ovs_dp_type: userspace securityContext: runAsUser: 0 volumes: - name: vhostuser-sockets emptyDir: {} - name: xml configMap: name: vm-config - name: hugepage emptyDir: medium: HugePages-2Mi - name: libvirt-runtime emptyDir: {} containers: - name: vm image: vm-vhostuser:latest command: [\"bash\", \"/root/vm/start.sh\"] securityContext: capabilities: add: - NET_BIND_SERVICE - SYS_NICE - NET_RAW - NET_ADMIN privileged: false runAsUser: 0 resources: limits: cpu: '2' devices.kubevirt.io/kvm: '1' memory: '8784969729' hugepages-2Mi: 2Gi requests: cpu: 666m devices.kubevirt.io/kvm: '1' ephemeral-storage: 50M memory: '4490002433' volumeMounts: - name: vhostuser-sockets mountPath: /var/run/vm - name: xml mountPath: /root/vm/ - mountPath: /dev/hugepages name: hugepage - name: libvirt-runtime mountPath: /var/run/libvirt \u7b49\u5f85\u865a\u62df\u673a\u521b\u5efa\u6210\u529f\u540e\u8fdb\u5165 Pod \u8fdb\u884c\u865a\u673a\u914d\u7f6e\uff1a # virsh set-user-password vm root 12345 Password set successfully for root in vm # virsh console vm Connected to domain 'vm' Escape character is ^] (Ctrl + ]) CentOS Linux 7 (Core) Kernel 3.10.0-1127.el7.x86_64 on an x86_64 localhost login: root Password: Last login: Fri Feb 25 09:52:54 on ttyS0 \u63a5\u4e0b\u6765\u53ef\u4ee5\u767b\u5f55\u865a\u673a\u8fdb\u884c\u7f51\u7edc\u914d\u7f6e\u5e76\u6d4b\u8bd5\uff1a ip link set eth0 mtu 1400 ip addr add 10.16.0.96/16 dev eth0 ip ro add default via 10.16.0.1 ping 114.114.114.114","title":"\u4f7f\u7528\u65b9\u5f0f"},{"location":"advance/external-gateway/","text":"\u5916\u90e8\u7f51\u5173\u8bbe\u7f6e \u5728\u4e00\u4e9b\u573a\u666f\u4e0b\uff0c\u5bf9\u6240\u6709\u5bb9\u5668\u8bbf\u95ee\u5916\u90e8\u7684\u6d41\u91cf\u9700\u8981\u901a\u8fc7\u4e00\u4e2a\u5916\u90e8\u7684\u7f51\u5173\u8fdb\u884c\u7edf\u4e00\u7684\u7ba1\u7406\u548c\u5ba1\u8ba1\u3002 Kube-OVN \u53ef\u4ee5\u901a\u8fc7\u5728\u5b50\u7f51\u4e2d\u8fdb\u884c\u76f8\u5e94\u7684\u8def\u7531\u914d\u7f6e\uff0c\u5c06\u51fa\u7f51\u6d41\u91cf\u8f6c\u53d1\u81f3\u5bf9\u5e94\u7684\u5916\u90e8\u7f51\u5173\u3002 \u4f7f\u7528\u65b9\u5f0f kind: Subnet apiVersion: kubeovn.io/v1 metadata: name: external spec: cidrBlock: 172.31.0.0/16 gatewayType: centralized natOutgoing: false externalEgressGateway: 192.168.0.1 policyRoutingTableID: 1000 policyRoutingPriority: 1500 natOutgoing : \u9700\u8981\u8bbe\u7f6e\u4e3a false \u3002 externalEgressGateway \uff1a\u8bbe\u7f6e\u4e3a\u5916\u90e8\u7f51\u5173\u7684\u5730\u5740\uff0c\u9700\u8981\u548c\u7f51\u5173\u8282\u70b9\u5728\u540c\u4e00\u4e2a\u4e8c\u5c42\u53ef\u8fbe\u57df\u3002 policyRoutingTableID \uff1a\u4f7f\u7528\u7684\u672c\u5730\u7b56\u7565\u8def\u7531\u8868\u7684 TableID \u6bcf\u4e2a\u5b50\u7f51\u5747\u9700\u4e0d\u540c\u4ee5\u907f\u514d\u51b2\u7a81\u3002 policyRoutingPriority \uff1a\u8def\u7531\u4f18\u5148\u7ea7\uff0c\u4e3a\u907f\u514d\u540e\u7eed\u7528\u6237\u5b9a\u5236\u5316\u7684\u5176\u4ed6\u8def\u7531\u64cd\u4f5c\u51b2\u7a81\uff0c\u8fd9\u91cc\u53ef\u4ee5\u6307\u5b9a\u8def\u7531\u4f18\u5148\u7ea7\uff0c\u82e5\u65e0\u7279\u6b8a\u9700\u6c42\u586b\u5165\u4efb\u610f\u503c\u5373\u53ef\u3002","title":"\u5916\u90e8\u7f51\u5173\u8bbe\u7f6e"},{"location":"advance/external-gateway/#_1","text":"\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\uff0c\u5bf9\u6240\u6709\u5bb9\u5668\u8bbf\u95ee\u5916\u90e8\u7684\u6d41\u91cf\u9700\u8981\u901a\u8fc7\u4e00\u4e2a\u5916\u90e8\u7684\u7f51\u5173\u8fdb\u884c\u7edf\u4e00\u7684\u7ba1\u7406\u548c\u5ba1\u8ba1\u3002 Kube-OVN \u53ef\u4ee5\u901a\u8fc7\u5728\u5b50\u7f51\u4e2d\u8fdb\u884c\u76f8\u5e94\u7684\u8def\u7531\u914d\u7f6e\uff0c\u5c06\u51fa\u7f51\u6d41\u91cf\u8f6c\u53d1\u81f3\u5bf9\u5e94\u7684\u5916\u90e8\u7f51\u5173\u3002","title":"\u5916\u90e8\u7f51\u5173\u8bbe\u7f6e"},{"location":"advance/external-gateway/#_2","text":"kind: Subnet apiVersion: kubeovn.io/v1 metadata: name: external spec: cidrBlock: 172.31.0.0/16 gatewayType: centralized natOutgoing: false externalEgressGateway: 192.168.0.1 policyRoutingTableID: 1000 policyRoutingPriority: 1500 natOutgoing : \u9700\u8981\u8bbe\u7f6e\u4e3a false \u3002 externalEgressGateway \uff1a\u8bbe\u7f6e\u4e3a\u5916\u90e8\u7f51\u5173\u7684\u5730\u5740\uff0c\u9700\u8981\u548c\u7f51\u5173\u8282\u70b9\u5728\u540c\u4e00\u4e2a\u4e8c\u5c42\u53ef\u8fbe\u57df\u3002 policyRoutingTableID \uff1a\u4f7f\u7528\u7684\u672c\u5730\u7b56\u7565\u8def\u7531\u8868\u7684 TableID \u6bcf\u4e2a\u5b50\u7f51\u5747\u9700\u4e0d\u540c\u4ee5\u907f\u514d\u51b2\u7a81\u3002 policyRoutingPriority \uff1a\u8def\u7531\u4f18\u5148\u7ea7\uff0c\u4e3a\u907f\u514d\u540e\u7eed\u7528\u6237\u5b9a\u5236\u5316\u7684\u5176\u4ed6\u8def\u7531\u64cd\u4f5c\u51b2\u7a81\uff0c\u8fd9\u91cc\u53ef\u4ee5\u6307\u5b9a\u8def\u7531\u4f18\u5148\u7ea7\uff0c\u82e5\u65e0\u7279\u6b8a\u9700\u6c42\u586b\u5165\u4efb\u610f\u503c\u5373\u53ef\u3002","title":"\u4f7f\u7528\u65b9\u5f0f"},{"location":"advance/fastpath/","text":"\u624b\u52a8\u7f16\u8bd1 FastPath \u6a21\u5757 \u7ecf\u8fc7\u6570\u636e\u5e73\u9762\u7684\u6027\u80fd Profile\uff0c Netfilter \u5728\u5bb9\u5668\u5185\u548c\u5bbf\u4e3b\u673a\u4e0a\u7684\u76f8\u5173\u5904\u7406\u6d88\u8017\u4e86 20% \u5de6\u53f3\u7684 CPU \u8d44\u6e90\uff0cFastPath \u6a21\u5757\u53ef\u4ee5\u7ed5\u8fc7 Netfilter \u4ece\u800c \u964d\u4f4e CPU \u7684\u6d88\u8017\u548c\u5ef6\u8fdf\uff0c\u5e76\u63d0\u5347\u541e\u5410\u91cf\u3002\u672c\u6587\u6863\u5c06\u4ecb\u7ecd\u5982\u4f55\u624b\u52a8\u7f16\u8bd1 FastPath \u6a21\u5757\u3002 \u4e0b\u8f7d\u76f8\u5173\u5185\u6838\u6a21\u5757\u4ee3\u7801 git clone --depth=1 https://github.com/kubeovn/kube-ovn.git \u5b89\u88c5\u4f9d\u8d56 \u8fd9\u91cc\u4ee5 CentOS \u4e3a\u4f8b\u4e0b\u8f7d\u76f8\u5173\u4f9d\u8d56 yum install -y kernel-devel-$(uname -r) gcc elfutils-libelf-devel \u7f16\u8bd1\u76f8\u5173\u6a21\u5757 \u9488\u5bf9 3.x \u7684\u5185\u6838\uff1a cd kube-ovn/fastpath make all \u9488\u5bf9 4.x \u7684\u5185\u6838 cd kube-ovn/fastpath/4.18 cp ../Makefile . make all \u5b89\u88c5\u5185\u6838\u6a21\u5757 \u5c06 kube_ovn_fastpath.ko \u590d\u5236\u5230\u6bcf\u4e2a\u9700\u8981\u6027\u80fd\u4f18\u5316\u7684\u8282\u70b9\uff0c\u6267\u884c\u4e0b\u5217\u547d\u4ee4\uff1a insmod kube_ovn_fastpath.ko \u4f7f\u7528 dmesg \u786e\u8ba4\u5b89\u88c5\u6210\u529f\uff1a # dmesg [619631.323788] init_module,kube_ovn_fastpath_local_out [619631.323798] init_module,kube_ovn_fastpath_post_routing [619631.323800] init_module,kube_ovn_fastpath_pre_routing [619631.323801] init_module,kube_ovn_fastpath_local_in \u5982\u9700\u5378\u8f7d\u6a21\u5757\uff0c\u53ef\u4f7f\u7528\u4e0b\u5217\u547d\u4ee4\uff1a rmmod kube_ovn_fastpath.ko \u8be5\u6a21\u5757\u5728\u673a\u5668\u91cd\u542f\u540e\u4e0d\u4f1a\u81ea\u52a8\u52a0\u8f7d\uff0c\u5982\u9700\u81ea\u52a8\u52a0\u8f7d\u8bf7\u6839\u636e\u7cfb\u7edf\u5f04\u914d\u7f6e\u7f16\u5199\u76f8\u5e94\u81ea\u542f\u52a8\u811a\u672c\u3002","title":"\u624b\u52a8\u7f16\u8bd1 FastPath \u6a21\u5757"},{"location":"advance/fastpath/#fastpath","text":"\u7ecf\u8fc7\u6570\u636e\u5e73\u9762\u7684\u6027\u80fd Profile\uff0c Netfilter \u5728\u5bb9\u5668\u5185\u548c\u5bbf\u4e3b\u673a\u4e0a\u7684\u76f8\u5173\u5904\u7406\u6d88\u8017\u4e86 20% \u5de6\u53f3\u7684 CPU \u8d44\u6e90\uff0cFastPath \u6a21\u5757\u53ef\u4ee5\u7ed5\u8fc7 Netfilter \u4ece\u800c \u964d\u4f4e CPU \u7684\u6d88\u8017\u548c\u5ef6\u8fdf\uff0c\u5e76\u63d0\u5347\u541e\u5410\u91cf\u3002\u672c\u6587\u6863\u5c06\u4ecb\u7ecd\u5982\u4f55\u624b\u52a8\u7f16\u8bd1 FastPath \u6a21\u5757\u3002","title":"\u624b\u52a8\u7f16\u8bd1 FastPath \u6a21\u5757"},{"location":"advance/fastpath/#_1","text":"git clone --depth=1 https://github.com/kubeovn/kube-ovn.git","title":"\u4e0b\u8f7d\u76f8\u5173\u5185\u6838\u6a21\u5757\u4ee3\u7801"},{"location":"advance/fastpath/#_2","text":"\u8fd9\u91cc\u4ee5 CentOS \u4e3a\u4f8b\u4e0b\u8f7d\u76f8\u5173\u4f9d\u8d56 yum install -y kernel-devel-$(uname -r) gcc elfutils-libelf-devel","title":"\u5b89\u88c5\u4f9d\u8d56"},{"location":"advance/fastpath/#_3","text":"\u9488\u5bf9 3.x \u7684\u5185\u6838\uff1a cd kube-ovn/fastpath make all \u9488\u5bf9 4.x \u7684\u5185\u6838 cd kube-ovn/fastpath/4.18 cp ../Makefile . make all","title":"\u7f16\u8bd1\u76f8\u5173\u6a21\u5757"},{"location":"advance/fastpath/#_4","text":"\u5c06 kube_ovn_fastpath.ko \u590d\u5236\u5230\u6bcf\u4e2a\u9700\u8981\u6027\u80fd\u4f18\u5316\u7684\u8282\u70b9\uff0c\u6267\u884c\u4e0b\u5217\u547d\u4ee4\uff1a insmod kube_ovn_fastpath.ko \u4f7f\u7528 dmesg \u786e\u8ba4\u5b89\u88c5\u6210\u529f\uff1a # dmesg [619631.323788] init_module,kube_ovn_fastpath_local_out [619631.323798] init_module,kube_ovn_fastpath_post_routing [619631.323800] init_module,kube_ovn_fastpath_pre_routing [619631.323801] init_module,kube_ovn_fastpath_local_in \u5982\u9700\u5378\u8f7d\u6a21\u5757\uff0c\u53ef\u4f7f\u7528\u4e0b\u5217\u547d\u4ee4\uff1a rmmod kube_ovn_fastpath.ko \u8be5\u6a21\u5757\u5728\u673a\u5668\u91cd\u542f\u540e\u4e0d\u4f1a\u81ea\u52a8\u52a0\u8f7d\uff0c\u5982\u9700\u81ea\u52a8\u52a0\u8f7d\u8bf7\u6839\u636e\u7cfb\u7edf\u5f04\u914d\u7f6e\u7f16\u5199\u76f8\u5e94\u81ea\u542f\u52a8\u811a\u672c\u3002","title":"\u5b89\u88c5\u5185\u6838\u6a21\u5757"},{"location":"advance/multi-nic/","text":"\u591a\u7f51\u5361\u7ba1\u7406 Kube-OVN \u53ef\u4ee5\u4e3a\u5176\u4ed6 CNI \u7f51\u7edc\u63d2\u4ef6\uff0c\u4f8b\u5982 macvlan\u3001vlan\u3001host-device \u7b49\u63d2\u4ef6\u63d0\u4f9b\u96c6\u7fa4\u7ea7\u522b\u7684 IPAM \u80fd\u529b\uff0c \u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5230 Kube-OVN \u4e2d\u5b50\u7f51\u4ee5\u53ca\u56fa\u5b9a IP \u529f\u80fd\u3002 \u5de5\u4f5c\u539f\u7406 \u901a\u8fc7\u4f7f\u7528 Multus CNI , \u6211\u4eec\u53ef\u4ee5\u7ed9\u4e00\u4e2a Pod \u6dfb\u52a0\u591a\u5757\u4e0d\u540c\u7f51\u7edc\u7684\u7f51\u5361\u3002 \u7136\u800c\u6211\u4eec\u4ecd\u7136\u7f3a\u4e4f\u5bf9\u96c6\u7fa4\u8303\u56f4\u5185\u4e0d\u540c\u7f51\u7edc\u7684 IP \u5730\u5740\u8fdb\u884c\u7ba1\u7406\u7684\u80fd\u529b\u3002\u5728 Kube-OVN \u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u80fd\u591f\u901a\u8fc7 Subnet \u548c IP \u7684 CRD \u6765\u8fdb\u884c IP \u7684\u9ad8\u7ea7\u7ba1\u7406\uff0c \u4f8b\u5982\u5b50\u7f51\u7ba1\u7406\uff0cIP \u9884\u7559\uff0c\u968f\u673a\u5206\u914d\uff0c\u56fa\u5b9a\u5206\u914d\u7b49\u3002\u73b0\u5728\u6211\u4eec\u5bf9\u5b50\u7f51\u8fdb\u884c\u6269\u5c55\uff0c\u6765\u63a5\u5165\u5176\u4ed6\u4e0d\u540c\u7684\u7f51\u7edc\u63d2\u4ef6\uff0c\u4f7f\u5f97\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kube-OVN \u7684IPAM\u529f\u80fd\u3002 \u5de5\u4f5c\u6d41\u7a0b \u4e0a\u56fe\u5c55\u793a\u4e86\u5982\u4f55\u901a\u8fc7 Kube-OVN \u6765\u7ba1\u7406\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u7684 IP \u5730\u5740\u3002\u5176\u4e2d\u5bb9\u5668\u7684 eth0 \u7f51\u5361\u63a5\u5165 OVN \u7f51\u7edc\uff0cnet1 \u7f51\u5361\u63a5\u5165\u5176\u4ed6 CNI \u7f51\u7edc\u3002 net1 \u7f51\u7edc\u7684\u7f51\u7edc\u5b9a\u4e49\u6765\u81ea\u4e8e multus-cni \u4e2d\u7684 NetworkAttachmentDefinition \u8d44\u6e90\u5b9a\u4e49\u3002 \u5f53 Pod \u521b\u5efa\u65f6\uff0c kube-ovn-controller \u4f1a\u76d1\u542c\u5230 Pod \u6dfb\u52a0\u4e8b\u4ef6\uff0c\u5e76\u6839\u636e Pod \u4e2d\u7684 annotation \u53bb\u5bfb\u627e\u5230\u5bf9\u5e94\u7684 Subnet \u5e76\u4ece\u4e2d\u8fdb\u884c IP \u7684\u5206\u914d\u548c\u7ba1\u7406\uff0c \u5e76\u5c06 Pod \u6240\u5206\u914d\u5230\u7684\u5730\u5740\u4fe1\u606f\u5199\u56de\u5230 Pod annotation \u4e2d\u3002 \u5728\u5bb9\u5668\u6240\u5728\u673a\u5668\u7684 CNI \u53ef\u4ee5\u901a\u8fc7\u5728\u914d\u7f6e\u4e2d\u914d\u7f6e kube-ovn-cni \u4f5c\u4e3a ipam \u63d2\u4ef6, kube-ovn-cni \u5c06\u4f1a\u8bfb\u53d6 Pod annotation \u5e76\u5c06\u5730\u5740\u4fe1\u606f\u901a\u8fc7CNI \u534f\u8bae\u7684\u6807\u51c6\u683c\u5f0f\u8fd4\u56de\u7ed9\u76f8\u5e94\u7684 CNI \u63d2\u4ef6\u3002 \u4f7f\u7528\u65b9\u6cd5 \u5b89\u88c5 Kube-OVN \u548c Multus \u8bf7\u53c2\u8003 Kube-OVN \u4e00\u952e\u5b89\u88c5 \u548c Multus how to use \u6765\u5b89\u88c5 Kube-OVN \u548c Multus-CNI\u3002 \u9644\u5c5e\u7f51\u5361\u4e3a\u975e Kube-OVN \u7c7b\u578b CNI \u63d0\u4f9b\u7684\u7f51\u7edc \u521b\u5efa NetworkAttachmentDefinition \u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 macvlan \u4f5c\u4e3a\u5bb9\u5668\u7f51\u7edc\u7684\u7b2c\u4e8c\u4e2a\u7f51\u7edc\uff0c\u5e76\u5c06\u5176 ipam \u8bbe\u7f6e\u4e3a kube-ovn \uff1a apiVersion: \"k8s.cni.cncf.io/v1\" kind: NetworkAttachmentDefinition metadata: name: macvlan namespace: default spec: config: '{ \"cniVersion\": \"0.3.0\", \"type\": \"macvlan\", \"master\": \"eth0\", \"mode\": \"bridge\", \"ipam\": { \"type\": \"kube-ovn\", \"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\", \"provider\": \"macvlan.default\" } }' spec.config.ipam.type : \u9700\u8981\u4e3a kube-ovn \u6765\u8c03\u7528 kube-ovn \u7684\u63d2\u4ef6\u6765\u83b7\u53d6\u5730\u5740\u4fe1\u606f\u3002 server_socket : Kube-OVN \u901a\u4fe1\u4f7f\u7528\u7684 socket \u6587\u4ef6\u3002 \u9ed8\u8ba4\u4f4d\u7f6e\u4e3a /run/openvswitch/kube-ovn-daemon.sock \u3002 provider : \u5f53\u524d NetworkAttachmentDefinition \u7684 <name>.<namespace> , Kube-OVN \u5c06\u4f1a\u4f7f\u7528\u8fd9\u4e9b\u4fe1\u606f\u627e\u5230\u5bf9\u5e94\u7684 Subnet \u8d44\u6e90\u3002 \u9644\u5c5e\u7f51\u5361\u4e3a Kube-OVN \u7c7b\u578b\u7f51\u5361 \u521b\u5efa network attachment definition, \u5e76\u5c06 provider \u7684\u540e\u7f00\u8bbe\u7f6e\u4e3a ovn apiVersion: \"k8s.cni.cncf.io/v1\" kind: NetworkAttachmentDefinition metadata: name: attachnet namespace: default spec: config: '{ \"cniVersion\": \"0.3.0\", \"type\": \"kube-ovn\", \"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\", \"provider\": \"attachnet.default.ovn\" }' spec.config.type : \u8bbe\u7f6e\u4e3a kube-ovn \u6765\u89e6\u53d1 CNI \u63d2\u4ef6\u4f7f\u7528 Kube-OVN \u5b50\u7f51\u3002 server_socket : Kube-OVN \u901a\u4fe1\u4f7f\u7528\u7684 socket \u6587\u4ef6\u3002 \u9ed8\u8ba4\u4f4d\u7f6e\u4e3a /run/openvswitch/kube-ovn-daemon.sock \u3002 provider : \u5f53\u524d NetworkAttachmentDefinition \u7684 <name>.<namespace>.ovn , Kube-OVN \u5c06\u4f1a\u4f7f\u7528\u8fd9\u4e9b\u4fe1\u606f\u627e\u5230\u5bf9\u5e94\u7684 Subnet \u8d44\u6e90\uff0c\u6ce8\u610f\u540e\u7f00\u9700\u8981\u8bbe\u7f6e\u4e3a ovn\u3002 \u521b\u5efa\u4e00\u4e2a Kube-OVN Subnet \u521b\u5efa\u4e00\u4e2a Kube-OVN Subnet,\u8bbe\u7f6e\u5bf9\u5e94\u7684 cidrBlock \u548c exclude_ips , provider \u5e94\u8be5\u8bbe\u7f6e\u4e3a\u5bf9\u5e94\u7684 NetworkAttachmentDefinition \u7684 <name>.<namespace> , \u4f8b\u5982\u7528macvlan\u63d0\u4f9b\u9644\u52a0\u7f51\u5361\uff0c\u521b\u5efasubnet\u5982\u4e0b\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: macvlan spec: protocol: IPv4 provider: macvlan.default cidrBlock: 172.17.0.0/16 gateway: 172.17.0.1 excludeIps: - 172.17.0.0..172.17.0.10 gateway , private , nat \u53ea\u5bf9 provider \u7c7b\u578b\u4e3a ovn \u7684\u7f51\u7edc\u751f\u6548\uff0c\u4e0d\u9002\u7528\u4e8e attachment network\u3002 \u5982\u679c\u4ee5 kube-ovn \u4f5c\u4e3a\u9644\u52a0\u7f51\u5361\uff0c\u5219 provider \u5e94\u8be5\u8bbe\u7f6e\u4e3a\u5bf9\u5e94\u7684 NetworkAttachmentDefinition \u7684 <name>.<namespace>.ovn \uff0c\u8981\u4ee5 ovn \u4f5c\u4e3a\u540e\u7f00\u7ed3\u675f\uff0c \u7528 kube-ovn \u63d0\u4f9b\u9644\u52a0\u7f51\u5361\uff0c\u521b\u5efa Subnet \u793a\u4f8b\u5982\u4e0b\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: attachnet spec: protocol: IPv4 provider: attachnet.default.ovn cidrBlock: 172.17.0.0/16 gateway: 172.17.0.1 excludeIps: - 172.17.0.0..172.17.0.10 \u521b\u5efa\u4e00\u4e2a\u591a\u7f51\u7edc\u7684 Pod \u5bf9\u4e8e\u5730\u5740\u968f\u673a\u5206\u914d\u7684 Pod\uff0c\u53ea\u9700\u8981\u6dfb\u52a0\u5982\u4e0b annotation k8s.v1.cni.cncf.io/networks ,\u53d6\u503c\u4e3a\u5bf9\u5e94\u7684 NetworkAttachmentDefinition \u7684 <name> \uff1a apiVersion: v1 kind: Pod metadata: name: samplepod namespace: default annotations: k8s.v1.cni.cncf.io/networks: macvlan spec: containers: - name: samplepod command: [\"/bin/ash\", \"-c\", \"trap : TERM INT; sleep infinity & wait\"] image: alpine \u521b\u5efa\u56fa\u5b9a IP \u7684 Pod \u5bf9\u4e8e\u56fa\u5b9a IP \u7684 Pod\uff0c\u6dfb\u52a0 <networkAttachmentName>.<networkAttachmentNamespace>.kubernetes.io/ip_address annotation\uff1a apiVersion: v1 kind: Pod metadata: name: static-ip namespace: default annotations: k8s.v1.cni.cncf.io/networks: macvlan ovn.kubernetes.io/ip_address: 10.16.0.15 ovn.kubernetes.io/mac_address: 00:00:00:53:6B:B6 macvlan.default.kubernetes.io/ip_address: 172.17.0.100 macvlan.default.kubernetes.io/mac_address: 00:00:00:53:6B:BB spec: containers: - name: static-ip image: nginx:alpine \u521b\u5efa\u4f7f\u7528\u56fa\u5b9a IP \u7684\u5de5\u4f5c\u8d1f\u8f7d \u5bf9\u4e8e\u4f7f\u7528 ippool \u7684\u5de5\u4f5c\u8d1f\u8f7d, \u6dfb\u52a0 <networkAttachmentName>.<networkAttachmentNamespace>.kubernetes.io/ip_pool annotations: apiVersion: apps/v1 kind: Deployment metadata: namespace: default name: static-workload labels: app: static-workload spec: replicas: 2 selector: matchLabels: app: static-workload template: metadata: labels: app: static-workload annotations: k8s.v1.cni.cncf.io/networks: macvlan ovn.kubernetes.io/ip_pool: 10.16.0.15,10.16.0.16,10.16.0.17 macvlan.default.kubernetes.io/ip_pool: 172.17.0.200,172.17.0.201,172.17.0.202 spec: containers: - name: static-workload image: nginx:alpine","title":"\u591a\u7f51\u5361\u7ba1\u7406"},{"location":"advance/multi-nic/#_1","text":"Kube-OVN \u53ef\u4ee5\u4e3a\u5176\u4ed6 CNI \u7f51\u7edc\u63d2\u4ef6\uff0c\u4f8b\u5982 macvlan\u3001vlan\u3001host-device \u7b49\u63d2\u4ef6\u63d0\u4f9b\u96c6\u7fa4\u7ea7\u522b\u7684 IPAM \u80fd\u529b\uff0c \u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5230 Kube-OVN \u4e2d\u5b50\u7f51\u4ee5\u53ca\u56fa\u5b9a IP \u529f\u80fd\u3002","title":"\u591a\u7f51\u5361\u7ba1\u7406"},{"location":"advance/multi-nic/#_2","text":"\u901a\u8fc7\u4f7f\u7528 Multus CNI , \u6211\u4eec\u53ef\u4ee5\u7ed9\u4e00\u4e2a Pod \u6dfb\u52a0\u591a\u5757\u4e0d\u540c\u7f51\u7edc\u7684\u7f51\u5361\u3002 \u7136\u800c\u6211\u4eec\u4ecd\u7136\u7f3a\u4e4f\u5bf9\u96c6\u7fa4\u8303\u56f4\u5185\u4e0d\u540c\u7f51\u7edc\u7684 IP \u5730\u5740\u8fdb\u884c\u7ba1\u7406\u7684\u80fd\u529b\u3002\u5728 Kube-OVN \u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u80fd\u591f\u901a\u8fc7 Subnet \u548c IP \u7684 CRD \u6765\u8fdb\u884c IP \u7684\u9ad8\u7ea7\u7ba1\u7406\uff0c \u4f8b\u5982\u5b50\u7f51\u7ba1\u7406\uff0cIP \u9884\u7559\uff0c\u968f\u673a\u5206\u914d\uff0c\u56fa\u5b9a\u5206\u914d\u7b49\u3002\u73b0\u5728\u6211\u4eec\u5bf9\u5b50\u7f51\u8fdb\u884c\u6269\u5c55\uff0c\u6765\u63a5\u5165\u5176\u4ed6\u4e0d\u540c\u7684\u7f51\u7edc\u63d2\u4ef6\uff0c\u4f7f\u5f97\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kube-OVN \u7684IPAM\u529f\u80fd\u3002","title":"\u5de5\u4f5c\u539f\u7406"},{"location":"advance/multi-nic/#_3","text":"\u4e0a\u56fe\u5c55\u793a\u4e86\u5982\u4f55\u901a\u8fc7 Kube-OVN \u6765\u7ba1\u7406\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u7684 IP \u5730\u5740\u3002\u5176\u4e2d\u5bb9\u5668\u7684 eth0 \u7f51\u5361\u63a5\u5165 OVN \u7f51\u7edc\uff0cnet1 \u7f51\u5361\u63a5\u5165\u5176\u4ed6 CNI \u7f51\u7edc\u3002 net1 \u7f51\u7edc\u7684\u7f51\u7edc\u5b9a\u4e49\u6765\u81ea\u4e8e multus-cni \u4e2d\u7684 NetworkAttachmentDefinition \u8d44\u6e90\u5b9a\u4e49\u3002 \u5f53 Pod \u521b\u5efa\u65f6\uff0c kube-ovn-controller \u4f1a\u76d1\u542c\u5230 Pod \u6dfb\u52a0\u4e8b\u4ef6\uff0c\u5e76\u6839\u636e Pod \u4e2d\u7684 annotation \u53bb\u5bfb\u627e\u5230\u5bf9\u5e94\u7684 Subnet \u5e76\u4ece\u4e2d\u8fdb\u884c IP \u7684\u5206\u914d\u548c\u7ba1\u7406\uff0c \u5e76\u5c06 Pod \u6240\u5206\u914d\u5230\u7684\u5730\u5740\u4fe1\u606f\u5199\u56de\u5230 Pod annotation \u4e2d\u3002 \u5728\u5bb9\u5668\u6240\u5728\u673a\u5668\u7684 CNI \u53ef\u4ee5\u901a\u8fc7\u5728\u914d\u7f6e\u4e2d\u914d\u7f6e kube-ovn-cni \u4f5c\u4e3a ipam \u63d2\u4ef6, kube-ovn-cni \u5c06\u4f1a\u8bfb\u53d6 Pod annotation \u5e76\u5c06\u5730\u5740\u4fe1\u606f\u901a\u8fc7CNI \u534f\u8bae\u7684\u6807\u51c6\u683c\u5f0f\u8fd4\u56de\u7ed9\u76f8\u5e94\u7684 CNI \u63d2\u4ef6\u3002","title":"\u5de5\u4f5c\u6d41\u7a0b"},{"location":"advance/multi-nic/#_4","text":"","title":"\u4f7f\u7528\u65b9\u6cd5"},{"location":"advance/multi-nic/#kube-ovn-multus","text":"\u8bf7\u53c2\u8003 Kube-OVN \u4e00\u952e\u5b89\u88c5 \u548c Multus how to use \u6765\u5b89\u88c5 Kube-OVN \u548c Multus-CNI\u3002","title":"\u5b89\u88c5 Kube-OVN \u548c Multus"},{"location":"advance/multi-nic/#kube-ovn-cni","text":"","title":"\u9644\u5c5e\u7f51\u5361\u4e3a\u975e Kube-OVN \u7c7b\u578b CNI \u63d0\u4f9b\u7684\u7f51\u7edc"},{"location":"advance/multi-nic/#networkattachmentdefinition","text":"\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 macvlan \u4f5c\u4e3a\u5bb9\u5668\u7f51\u7edc\u7684\u7b2c\u4e8c\u4e2a\u7f51\u7edc\uff0c\u5e76\u5c06\u5176 ipam \u8bbe\u7f6e\u4e3a kube-ovn \uff1a apiVersion: \"k8s.cni.cncf.io/v1\" kind: NetworkAttachmentDefinition metadata: name: macvlan namespace: default spec: config: '{ \"cniVersion\": \"0.3.0\", \"type\": \"macvlan\", \"master\": \"eth0\", \"mode\": \"bridge\", \"ipam\": { \"type\": \"kube-ovn\", \"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\", \"provider\": \"macvlan.default\" } }' spec.config.ipam.type : \u9700\u8981\u4e3a kube-ovn \u6765\u8c03\u7528 kube-ovn \u7684\u63d2\u4ef6\u6765\u83b7\u53d6\u5730\u5740\u4fe1\u606f\u3002 server_socket : Kube-OVN \u901a\u4fe1\u4f7f\u7528\u7684 socket \u6587\u4ef6\u3002 \u9ed8\u8ba4\u4f4d\u7f6e\u4e3a /run/openvswitch/kube-ovn-daemon.sock \u3002 provider : \u5f53\u524d NetworkAttachmentDefinition \u7684 <name>.<namespace> , Kube-OVN \u5c06\u4f1a\u4f7f\u7528\u8fd9\u4e9b\u4fe1\u606f\u627e\u5230\u5bf9\u5e94\u7684 Subnet \u8d44\u6e90\u3002","title":"\u521b\u5efa NetworkAttachmentDefinition"},{"location":"advance/multi-nic/#kube-ovn","text":"","title":"\u9644\u5c5e\u7f51\u5361\u4e3a Kube-OVN \u7c7b\u578b\u7f51\u5361"},{"location":"advance/multi-nic/#network-attachment-definition-provider-ovn","text":"apiVersion: \"k8s.cni.cncf.io/v1\" kind: NetworkAttachmentDefinition metadata: name: attachnet namespace: default spec: config: '{ \"cniVersion\": \"0.3.0\", \"type\": \"kube-ovn\", \"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\", \"provider\": \"attachnet.default.ovn\" }' spec.config.type : \u8bbe\u7f6e\u4e3a kube-ovn \u6765\u89e6\u53d1 CNI \u63d2\u4ef6\u4f7f\u7528 Kube-OVN \u5b50\u7f51\u3002 server_socket : Kube-OVN \u901a\u4fe1\u4f7f\u7528\u7684 socket \u6587\u4ef6\u3002 \u9ed8\u8ba4\u4f4d\u7f6e\u4e3a /run/openvswitch/kube-ovn-daemon.sock \u3002 provider : \u5f53\u524d NetworkAttachmentDefinition \u7684 <name>.<namespace>.ovn , Kube-OVN \u5c06\u4f1a\u4f7f\u7528\u8fd9\u4e9b\u4fe1\u606f\u627e\u5230\u5bf9\u5e94\u7684 Subnet \u8d44\u6e90\uff0c\u6ce8\u610f\u540e\u7f00\u9700\u8981\u8bbe\u7f6e\u4e3a ovn\u3002","title":"\u521b\u5efa network attachment definition, \u5e76\u5c06 provider \u7684\u540e\u7f00\u8bbe\u7f6e\u4e3a ovn"},{"location":"advance/multi-nic/#kube-ovn-subnet","text":"\u521b\u5efa\u4e00\u4e2a Kube-OVN Subnet,\u8bbe\u7f6e\u5bf9\u5e94\u7684 cidrBlock \u548c exclude_ips , provider \u5e94\u8be5\u8bbe\u7f6e\u4e3a\u5bf9\u5e94\u7684 NetworkAttachmentDefinition \u7684 <name>.<namespace> , \u4f8b\u5982\u7528macvlan\u63d0\u4f9b\u9644\u52a0\u7f51\u5361\uff0c\u521b\u5efasubnet\u5982\u4e0b\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: macvlan spec: protocol: IPv4 provider: macvlan.default cidrBlock: 172.17.0.0/16 gateway: 172.17.0.1 excludeIps: - 172.17.0.0..172.17.0.10 gateway , private , nat \u53ea\u5bf9 provider \u7c7b\u578b\u4e3a ovn \u7684\u7f51\u7edc\u751f\u6548\uff0c\u4e0d\u9002\u7528\u4e8e attachment network\u3002 \u5982\u679c\u4ee5 kube-ovn \u4f5c\u4e3a\u9644\u52a0\u7f51\u5361\uff0c\u5219 provider \u5e94\u8be5\u8bbe\u7f6e\u4e3a\u5bf9\u5e94\u7684 NetworkAttachmentDefinition \u7684 <name>.<namespace>.ovn \uff0c\u8981\u4ee5 ovn \u4f5c\u4e3a\u540e\u7f00\u7ed3\u675f\uff0c \u7528 kube-ovn \u63d0\u4f9b\u9644\u52a0\u7f51\u5361\uff0c\u521b\u5efa Subnet \u793a\u4f8b\u5982\u4e0b\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: attachnet spec: protocol: IPv4 provider: attachnet.default.ovn cidrBlock: 172.17.0.0/16 gateway: 172.17.0.1 excludeIps: - 172.17.0.0..172.17.0.10","title":"\u521b\u5efa\u4e00\u4e2a Kube-OVN Subnet"},{"location":"advance/multi-nic/#pod","text":"\u5bf9\u4e8e\u5730\u5740\u968f\u673a\u5206\u914d\u7684 Pod\uff0c\u53ea\u9700\u8981\u6dfb\u52a0\u5982\u4e0b annotation k8s.v1.cni.cncf.io/networks ,\u53d6\u503c\u4e3a\u5bf9\u5e94\u7684 NetworkAttachmentDefinition \u7684 <name> \uff1a apiVersion: v1 kind: Pod metadata: name: samplepod namespace: default annotations: k8s.v1.cni.cncf.io/networks: macvlan spec: containers: - name: samplepod command: [\"/bin/ash\", \"-c\", \"trap : TERM INT; sleep infinity & wait\"] image: alpine","title":"\u521b\u5efa\u4e00\u4e2a\u591a\u7f51\u7edc\u7684 Pod"},{"location":"advance/multi-nic/#ip-pod","text":"\u5bf9\u4e8e\u56fa\u5b9a IP \u7684 Pod\uff0c\u6dfb\u52a0 <networkAttachmentName>.<networkAttachmentNamespace>.kubernetes.io/ip_address annotation\uff1a apiVersion: v1 kind: Pod metadata: name: static-ip namespace: default annotations: k8s.v1.cni.cncf.io/networks: macvlan ovn.kubernetes.io/ip_address: 10.16.0.15 ovn.kubernetes.io/mac_address: 00:00:00:53:6B:B6 macvlan.default.kubernetes.io/ip_address: 172.17.0.100 macvlan.default.kubernetes.io/mac_address: 00:00:00:53:6B:BB spec: containers: - name: static-ip image: nginx:alpine","title":"\u521b\u5efa\u56fa\u5b9a IP \u7684 Pod"},{"location":"advance/multi-nic/#ip","text":"\u5bf9\u4e8e\u4f7f\u7528 ippool \u7684\u5de5\u4f5c\u8d1f\u8f7d, \u6dfb\u52a0 <networkAttachmentName>.<networkAttachmentNamespace>.kubernetes.io/ip_pool annotations: apiVersion: apps/v1 kind: Deployment metadata: namespace: default name: static-workload labels: app: static-workload spec: replicas: 2 selector: matchLabels: app: static-workload template: metadata: labels: app: static-workload annotations: k8s.v1.cni.cncf.io/networks: macvlan ovn.kubernetes.io/ip_pool: 10.16.0.15,10.16.0.16,10.16.0.17 macvlan.default.kubernetes.io/ip_pool: 172.17.0.200,172.17.0.201,172.17.0.202 spec: containers: - name: static-workload image: nginx:alpine","title":"\u521b\u5efa\u4f7f\u7528\u56fa\u5b9a IP \u7684\u5de5\u4f5c\u8d1f\u8f7d"},{"location":"advance/offload-corigine/","text":"\u82af\u542f\u6e90\u7f51\u5361 Offload \u652f\u6301 Kube-OVN \u5728\u6700\u7ec8\u7684\u6570\u636e\u5e73\u9762\u4f7f\u7528 OVS \u6765\u5b8c\u6210\u6d41\u91cf\u8f6c\u53d1\uff0c\u76f8\u5173\u7684\u6d41\u8868\u5339\u914d\uff0c\u96a7\u9053\u5c01\u88c5\u7b49\u529f\u80fd\u4e3a CPU \u5bc6\u96c6\u578b\uff0c\u5728\u5927\u6d41\u91cf\u4e0b\u4f1a\u6d88\u8017\u5927\u91cf CPU \u8d44\u6e90\u5e76\u5bfc\u81f4 \u5ef6\u8fdf\u4e0a\u5347\u548c\u541e\u5410\u91cf\u4e0b\u964d\u3002\u82af\u542f\u6e90\u7684 Agilio CX \u7cfb\u5217\u667a\u80fd\u7f51\u5361\u53ef\u4ee5\u5c06 OVS \u76f8\u5173\u7684\u64cd\u4f5c\u5378\u8f7d\u5230\u786c\u4ef6\u7f51\u5361\u4e2d\u6267\u884c\u3002 \u8be5\u6280\u672f\u53ef\u4ee5\u5728\u65e0\u9700\u5bf9 OVS \u63a7\u5236\u5e73\u9762\u8fdb\u884c\u4fee\u6539\u7684\u60c5\u51b5\u4e0b\uff0c\u7f29\u77ed\u6570\u636e\u8def\u5f84\uff0c\u907f\u514d\u5bf9\u4e3b\u673a CPU \u8d44\u6e90\u7684\u4f7f\u7528\uff0c\u5927\u5e45\u964d\u4f4e\u5ef6\u8fdf\u5e76\u663e\u8457\u63d0\u5347\u541e\u5410\u91cf\u3002 \u524d\u7f6e\u6761\u4ef6 \u82af\u542f\u6e90 Agilio CX \u7cfb\u5217\u7684\u786c\u4ef6\u7f51\u5361\u3002 CentOS 8 Stream \u6216\u4e0a\u6e38 Linux 5.7 \u4ee5\u4e0a\u5185\u6838\u652f\u6301\u3002 \u7531\u4e8e\u5f53\u524d\u7f51\u5361\u4e0d\u652f\u6301 dp_hash \u548c hash \u64cd\u4f5c\u5378\u8f7d\uff0c\u9700\u5173\u95ed OVN LB \u529f\u80fd\u3002 \u8bbe\u7f6e\u7f51\u5361 SR-IOV \u6a21\u5f0f \u7528\u6237\u53ef\u53c2\u8003 Agilio Open vSwitch TC User Guide \u83b7\u5f97\u8be5\u7f51\u5361\u4f7f\u7528\u7684\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\u3002 \u4fdd\u5b58\u4e0b\u5217\u811a\u672c\u7528\u4e8e\u540e\u7eed\u6267\u884c\u56fa\u4ef6\u76f8\u5173\u64cd\u4f5c\uff1a #!/bin/bash DEVICE=${1} DEFAULT_ASSY=scan ASSY=${2:-${DEFAULT_ASSY}} APP=${3:-flower} if [ \"x${DEVICE}\" = \"x\" -o ! -e /sys/class/net/${DEVICE} ]; then echo Syntax: ${0} device [ASSY] [APP] echo echo This script associates the TC Offload firmware echo with a Netronome SmartNIC. echo echo device: is the network device associated with the SmartNIC echo ASSY: defaults to ${DEFAULT_ASSY} echo APP: defaults to flower. flower-next is supported if updated echo firmware has been installed. exit 1 fi # It is recommended that the assembly be determined by inspection # The following code determines the value via the debug interface if [ \"${ASSY}x\" = \"scanx\" ]; then ethtool -W ${DEVICE} 0 DEBUG=$(ethtool -w ${DEVICE} data /dev/stdout | strings) SERIAL=$(echo \"${DEBUG}\" | grep \"^SN:\") ASSY=$(echo ${SERIAL} | grep -oE AMDA[0-9]{4}) fi PCIADDR=$(basename $(readlink -e /sys/class/net/${DEVICE}/device)) FWDIR=\"/lib/firmware/netronome\" # AMDA0081 and AMDA0097 uses the same firmware if [ \"${ASSY}\" = \"AMDA0081\" ]; then if [ ! -e ${FWDIR}/${APP}/nic_AMDA0081.nffw ]; then ln -sf nic_AMDA0097.nffw ${FWDIR}/${APP}/nic_AMDA0081.nffw fi fi FW=\"${FWDIR}/pci-${PCIADDR}.nffw\" ln -sf \"${APP}/nic_${ASSY}.nffw\" \"${FW}\" # insert distro-specific initramfs section here... \u5207\u6362\u56fa\u4ef6\u9009\u9879\u5e76\u91cd\u8f7d\u9a71\u52a8\uff1a ./agilio-tc-fw-select.sh ens47np0 scan rmmod nfp modprobe nfp \u68c0\u67e5\u53ef\u7528 VF \u6570\u91cf\uff0c\u5e76\u521b\u5efa VF\uff1a # cat /sys/class/net/ens3/device/sriov_totalvfs 65 # echo 4 > /sys/class/net/ens47/device/sriov_numvfs \u5b89\u88c5 SR-IOV Device Plugin \u7531\u4e8e\u6bcf\u4e2a\u673a\u5668\u7684 VF \u6570\u91cf\u4f18\u5148\uff0c\u6bcf\u4e2a\u4f7f\u7528\u52a0\u901f\u7684 Pod \u4f1a\u5360\u7528 VF \u8d44\u6e90\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528 SR-IOV Device Plugin \u7ba1\u7406\u76f8\u5e94\u8d44\u6e90\uff0c\u4f7f\u5f97\u8c03\u5ea6\u5668\u77e5\u9053\u5982\u4f55\u6839\u636e \u8d44\u6e90\u8fdb\u884c\u8c03\u5ea6\u3002 \u521b\u5efa SR-IOV \u76f8\u5173 Configmap\uff1a apiVersion: v1 kind: ConfigMap metadata: name: sriovdp-config namespace: kube-system data: config.json: | { \"resourceList\": [{ \"resourcePrefix\": \"corigine.com\", \"resourceName\": \"agilio_sriov\", \"selectors\": { \"vendors\": [\"19ee\"], \"devices\": [\"6003\"], \"drivers\": [\"nfp_netvf\"] } } ] } \u53c2\u8003 SR-IOV \u6587\u6863 \u8fdb\u884c\u90e8\u7f72: kubectl apply -f https://raw.githubusercontent.com/intel/sriov-network-device-plugin/master/deployments/k8s-v1.16/sriovdp-daemonset.yaml \u68c0\u67e5 SR-IOV \u8d44\u6e90\u662f\u5426\u5df2\u7ecf\u6ce8\u518c\u5230 Kubernetes Node \u4e2d\uff1a kubectl describe no containerserver | grep corigine corigine.com/agilio_sriov: 4 corigine.com/agilio_sriov: 4 corigine.com/agilio_sriov 0 0 \u5b89\u88c5 Multus-CNI SR-IOV Device Plugin \u8c03\u5ea6\u65f6\u83b7\u5f97\u7684\u8bbe\u5907 ID \u9700\u8981\u901a\u8fc7 Multus-CNI \u4f20\u9012\u7ed9 Kube-OVN\uff0c\u56e0\u6b64\u9700\u8981\u914d\u7f6e Multus-CNI \u914d\u5408\u5b8c\u6210\u76f8\u5173\u4efb\u52a1\u3002 \u53c2\u8003 Multius-CNI \u6587\u6863 \u8fdb\u884c\u90e8\u7f72\uff1a kubectl apply -f https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset.yml \u521b\u5efa NetworkAttachmentDefinition \uff1a apiVersion: \"k8s.cni.cncf.io/v1\" kind: NetworkAttachmentDefinition metadata: name: default namespace: default annotations: k8s.v1.cni.cncf.io/resourceName: corigine.com/agilio_sriov spec: config: '{ \"cniVersion\": \"0.3.1\", \"name\": \"kube-ovn\", \"plugins\":[ { \"type\":\"kube-ovn\", \"server_socket\":\"/run/openvswitch/kube-ovn-daemon.sock\", \"provider\": \"default.default.ovn\" }, { \"type\":\"portmap\", \"capabilities\":{ \"portMappings\":true } } ] }' provider : \u683c\u5f0f\u4e3a\u5f53\u524d NetworkAttachmentDefinition \u7684 {name}.{namespace}.ovn\u3002 Kube-OVN \u4e2d\u5f00\u542f\u5378\u8f7d\u6a21\u5f0f \u4e0b\u8f7d\u5b89\u88c5\u811a\u672c\uff1a wget https://raw.githubusercontent.com/alauda/kube-ovn/release-1.10/dist/images/install.sh \u4fee\u6539\u76f8\u5173\u53c2\u6570\uff0c IFACE \u9700\u8981\u4e3a\u7269\u7406\u7f51\u5361\u540d\uff0c\u8be5\u7f51\u5361\u9700\u8981\u6709\u53ef\u8def\u7531 IP\uff1a ENABLE_MIRROR=${ENABLE_MIRROR:-false} HW_OFFLOAD=${HW_OFFLOAD:-true} ENABLE_LB=${ENABLE_LB:-false} IFACE=\"ensp01\" \u5b89\u88c5 Kube-OVN\uff1a bash install.sh \u521b\u5efa\u4f7f\u7528 VF \u7f51\u5361\u7684 Pod \u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b yaml \u683c\u5f0f\u521b\u5efa\u4f7f\u7528 VF \u8fdb\u884c\u7f51\u7edc\u5378\u8f7d\u52a0\u901f\u7684 Pod: apiVersion: v1 kind: Pod metadata: name: nginx namespace: default annotations: v1.multus-cni.io/default-network: default/default spec: containers: - name: nginx image: nginx:alpine resources: requests: corigine.com/agilio_sriov: '1' limits: corigine.com/agilio_sriov: '1' v1.multus-cni.io/default-network : \u4e3a\u4e0a\u4e00\u6b65\u9aa4\u4e2d NetworkAttachmentDefinition \u7684 {namespace}/{name}\u3002 \u53ef\u901a\u8fc7\u5728 Pod \u8fd0\u884c\u8282\u70b9\u7684 ovs-ovn \u5bb9\u5668\u4e2d\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u89c2\u5bdf\u5378\u8f7d\u662f\u5426\u6210\u529f\uff1a # ovs-appctl dpctl/dump-flows -m type=offloaded ufid:91cc45de-e7e9-4935-8f82-1890430b0f66, skb_priority(0/0),skb_mark(0/0),ct_state(0/0x23),ct_zone(0/0),ct_mark(0/0),ct_label(0/0x1),recirc_id(0),dp_hash(0/0),in_port(5b45c61b307e_h),packet_type(ns=0/0,id=0/0),eth(src=00:00:00:c5:6d:4e,dst=00:00:00:e7:16:ce),eth_type(0x0800),ipv4(src=0.0.0.0/0.0.0.0,dst=0.0.0.0/0.0.0.0,proto=0/0,tos=0/0,ttl=0/0,frag=no), packets:941539, bytes:62142230, used:0.260s, offloaded:yes, dp:tc, actions:54235e5753b8_h ufid:e00768d7-e652-4d79-8182-3291d852b791, skb_priority(0/0),skb_mark(0/0),ct_state(0/0x23),ct_zone(0/0),ct_mark(0/0),ct_label(0/0x1),recirc_id(0),dp_hash(0/0),in_port(54235e5753b8_h),packet_type(ns=0/0,id=0/0),eth(src=00:00:00:e7:16:ce,dst=00:00:00:c5:6d:4e),eth_type(0x0800),ipv4(src=0.0.0.0/0.0.0.0,dst=0.0.0.0/0.0.0.0,proto=0/0,tos=0/0,ttl=0/0,frag=no), packets:82386659, bytes:115944854173, used:0.260s, offloaded:yes, dp:tc, actions:5b45c61b307e_h \u5982\u679c\u6709 offloaded:yes, dp:tc \u5185\u5bb9\u8bc1\u660e\u5378\u8f7d\u6210\u529f\u3002","title":"\u82af\u542f\u6e90\u7f51\u5361 Offload \u652f\u6301"},{"location":"advance/offload-corigine/#offload","text":"Kube-OVN \u5728\u6700\u7ec8\u7684\u6570\u636e\u5e73\u9762\u4f7f\u7528 OVS \u6765\u5b8c\u6210\u6d41\u91cf\u8f6c\u53d1\uff0c\u76f8\u5173\u7684\u6d41\u8868\u5339\u914d\uff0c\u96a7\u9053\u5c01\u88c5\u7b49\u529f\u80fd\u4e3a CPU \u5bc6\u96c6\u578b\uff0c\u5728\u5927\u6d41\u91cf\u4e0b\u4f1a\u6d88\u8017\u5927\u91cf CPU \u8d44\u6e90\u5e76\u5bfc\u81f4 \u5ef6\u8fdf\u4e0a\u5347\u548c\u541e\u5410\u91cf\u4e0b\u964d\u3002\u82af\u542f\u6e90\u7684 Agilio CX \u7cfb\u5217\u667a\u80fd\u7f51\u5361\u53ef\u4ee5\u5c06 OVS \u76f8\u5173\u7684\u64cd\u4f5c\u5378\u8f7d\u5230\u786c\u4ef6\u7f51\u5361\u4e2d\u6267\u884c\u3002 \u8be5\u6280\u672f\u53ef\u4ee5\u5728\u65e0\u9700\u5bf9 OVS \u63a7\u5236\u5e73\u9762\u8fdb\u884c\u4fee\u6539\u7684\u60c5\u51b5\u4e0b\uff0c\u7f29\u77ed\u6570\u636e\u8def\u5f84\uff0c\u907f\u514d\u5bf9\u4e3b\u673a CPU \u8d44\u6e90\u7684\u4f7f\u7528\uff0c\u5927\u5e45\u964d\u4f4e\u5ef6\u8fdf\u5e76\u663e\u8457\u63d0\u5347\u541e\u5410\u91cf\u3002","title":"\u82af\u542f\u6e90\u7f51\u5361 Offload \u652f\u6301"},{"location":"advance/offload-corigine/#_1","text":"\u82af\u542f\u6e90 Agilio CX \u7cfb\u5217\u7684\u786c\u4ef6\u7f51\u5361\u3002 CentOS 8 Stream \u6216\u4e0a\u6e38 Linux 5.7 \u4ee5\u4e0a\u5185\u6838\u652f\u6301\u3002 \u7531\u4e8e\u5f53\u524d\u7f51\u5361\u4e0d\u652f\u6301 dp_hash \u548c hash \u64cd\u4f5c\u5378\u8f7d\uff0c\u9700\u5173\u95ed OVN LB \u529f\u80fd\u3002","title":"\u524d\u7f6e\u6761\u4ef6"},{"location":"advance/offload-corigine/#sr-iov","text":"\u7528\u6237\u53ef\u53c2\u8003 Agilio Open vSwitch TC User Guide \u83b7\u5f97\u8be5\u7f51\u5361\u4f7f\u7528\u7684\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\u3002 \u4fdd\u5b58\u4e0b\u5217\u811a\u672c\u7528\u4e8e\u540e\u7eed\u6267\u884c\u56fa\u4ef6\u76f8\u5173\u64cd\u4f5c\uff1a #!/bin/bash DEVICE=${1} DEFAULT_ASSY=scan ASSY=${2:-${DEFAULT_ASSY}} APP=${3:-flower} if [ \"x${DEVICE}\" = \"x\" -o ! -e /sys/class/net/${DEVICE} ]; then echo Syntax: ${0} device [ASSY] [APP] echo echo This script associates the TC Offload firmware echo with a Netronome SmartNIC. echo echo device: is the network device associated with the SmartNIC echo ASSY: defaults to ${DEFAULT_ASSY} echo APP: defaults to flower. flower-next is supported if updated echo firmware has been installed. exit 1 fi # It is recommended that the assembly be determined by inspection # The following code determines the value via the debug interface if [ \"${ASSY}x\" = \"scanx\" ]; then ethtool -W ${DEVICE} 0 DEBUG=$(ethtool -w ${DEVICE} data /dev/stdout | strings) SERIAL=$(echo \"${DEBUG}\" | grep \"^SN:\") ASSY=$(echo ${SERIAL} | grep -oE AMDA[0-9]{4}) fi PCIADDR=$(basename $(readlink -e /sys/class/net/${DEVICE}/device)) FWDIR=\"/lib/firmware/netronome\" # AMDA0081 and AMDA0097 uses the same firmware if [ \"${ASSY}\" = \"AMDA0081\" ]; then if [ ! -e ${FWDIR}/${APP}/nic_AMDA0081.nffw ]; then ln -sf nic_AMDA0097.nffw ${FWDIR}/${APP}/nic_AMDA0081.nffw fi fi FW=\"${FWDIR}/pci-${PCIADDR}.nffw\" ln -sf \"${APP}/nic_${ASSY}.nffw\" \"${FW}\" # insert distro-specific initramfs section here... \u5207\u6362\u56fa\u4ef6\u9009\u9879\u5e76\u91cd\u8f7d\u9a71\u52a8\uff1a ./agilio-tc-fw-select.sh ens47np0 scan rmmod nfp modprobe nfp \u68c0\u67e5\u53ef\u7528 VF \u6570\u91cf\uff0c\u5e76\u521b\u5efa VF\uff1a # cat /sys/class/net/ens3/device/sriov_totalvfs 65 # echo 4 > /sys/class/net/ens47/device/sriov_numvfs","title":"\u8bbe\u7f6e\u7f51\u5361 SR-IOV \u6a21\u5f0f"},{"location":"advance/offload-corigine/#sr-iov-device-plugin","text":"\u7531\u4e8e\u6bcf\u4e2a\u673a\u5668\u7684 VF \u6570\u91cf\u4f18\u5148\uff0c\u6bcf\u4e2a\u4f7f\u7528\u52a0\u901f\u7684 Pod \u4f1a\u5360\u7528 VF \u8d44\u6e90\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528 SR-IOV Device Plugin \u7ba1\u7406\u76f8\u5e94\u8d44\u6e90\uff0c\u4f7f\u5f97\u8c03\u5ea6\u5668\u77e5\u9053\u5982\u4f55\u6839\u636e \u8d44\u6e90\u8fdb\u884c\u8c03\u5ea6\u3002 \u521b\u5efa SR-IOV \u76f8\u5173 Configmap\uff1a apiVersion: v1 kind: ConfigMap metadata: name: sriovdp-config namespace: kube-system data: config.json: | { \"resourceList\": [{ \"resourcePrefix\": \"corigine.com\", \"resourceName\": \"agilio_sriov\", \"selectors\": { \"vendors\": [\"19ee\"], \"devices\": [\"6003\"], \"drivers\": [\"nfp_netvf\"] } } ] } \u53c2\u8003 SR-IOV \u6587\u6863 \u8fdb\u884c\u90e8\u7f72: kubectl apply -f https://raw.githubusercontent.com/intel/sriov-network-device-plugin/master/deployments/k8s-v1.16/sriovdp-daemonset.yaml \u68c0\u67e5 SR-IOV \u8d44\u6e90\u662f\u5426\u5df2\u7ecf\u6ce8\u518c\u5230 Kubernetes Node \u4e2d\uff1a kubectl describe no containerserver | grep corigine corigine.com/agilio_sriov: 4 corigine.com/agilio_sriov: 4 corigine.com/agilio_sriov 0 0","title":"\u5b89\u88c5 SR-IOV Device Plugin"},{"location":"advance/offload-corigine/#multus-cni","text":"SR-IOV Device Plugin \u8c03\u5ea6\u65f6\u83b7\u5f97\u7684\u8bbe\u5907 ID \u9700\u8981\u901a\u8fc7 Multus-CNI \u4f20\u9012\u7ed9 Kube-OVN\uff0c\u56e0\u6b64\u9700\u8981\u914d\u7f6e Multus-CNI \u914d\u5408\u5b8c\u6210\u76f8\u5173\u4efb\u52a1\u3002 \u53c2\u8003 Multius-CNI \u6587\u6863 \u8fdb\u884c\u90e8\u7f72\uff1a kubectl apply -f https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset.yml \u521b\u5efa NetworkAttachmentDefinition \uff1a apiVersion: \"k8s.cni.cncf.io/v1\" kind: NetworkAttachmentDefinition metadata: name: default namespace: default annotations: k8s.v1.cni.cncf.io/resourceName: corigine.com/agilio_sriov spec: config: '{ \"cniVersion\": \"0.3.1\", \"name\": \"kube-ovn\", \"plugins\":[ { \"type\":\"kube-ovn\", \"server_socket\":\"/run/openvswitch/kube-ovn-daemon.sock\", \"provider\": \"default.default.ovn\" }, { \"type\":\"portmap\", \"capabilities\":{ \"portMappings\":true } } ] }' provider : \u683c\u5f0f\u4e3a\u5f53\u524d NetworkAttachmentDefinition \u7684 {name}.{namespace}.ovn\u3002","title":"\u5b89\u88c5 Multus-CNI"},{"location":"advance/offload-corigine/#kube-ovn","text":"\u4e0b\u8f7d\u5b89\u88c5\u811a\u672c\uff1a wget https://raw.githubusercontent.com/alauda/kube-ovn/release-1.10/dist/images/install.sh \u4fee\u6539\u76f8\u5173\u53c2\u6570\uff0c IFACE \u9700\u8981\u4e3a\u7269\u7406\u7f51\u5361\u540d\uff0c\u8be5\u7f51\u5361\u9700\u8981\u6709\u53ef\u8def\u7531 IP\uff1a ENABLE_MIRROR=${ENABLE_MIRROR:-false} HW_OFFLOAD=${HW_OFFLOAD:-true} ENABLE_LB=${ENABLE_LB:-false} IFACE=\"ensp01\" \u5b89\u88c5 Kube-OVN\uff1a bash install.sh","title":"Kube-OVN \u4e2d\u5f00\u542f\u5378\u8f7d\u6a21\u5f0f"},{"location":"advance/offload-corigine/#vf-pod","text":"\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b yaml \u683c\u5f0f\u521b\u5efa\u4f7f\u7528 VF \u8fdb\u884c\u7f51\u7edc\u5378\u8f7d\u52a0\u901f\u7684 Pod: apiVersion: v1 kind: Pod metadata: name: nginx namespace: default annotations: v1.multus-cni.io/default-network: default/default spec: containers: - name: nginx image: nginx:alpine resources: requests: corigine.com/agilio_sriov: '1' limits: corigine.com/agilio_sriov: '1' v1.multus-cni.io/default-network : \u4e3a\u4e0a\u4e00\u6b65\u9aa4\u4e2d NetworkAttachmentDefinition \u7684 {namespace}/{name}\u3002 \u53ef\u901a\u8fc7\u5728 Pod \u8fd0\u884c\u8282\u70b9\u7684 ovs-ovn \u5bb9\u5668\u4e2d\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u89c2\u5bdf\u5378\u8f7d\u662f\u5426\u6210\u529f\uff1a # ovs-appctl dpctl/dump-flows -m type=offloaded ufid:91cc45de-e7e9-4935-8f82-1890430b0f66, skb_priority(0/0),skb_mark(0/0),ct_state(0/0x23),ct_zone(0/0),ct_mark(0/0),ct_label(0/0x1),recirc_id(0),dp_hash(0/0),in_port(5b45c61b307e_h),packet_type(ns=0/0,id=0/0),eth(src=00:00:00:c5:6d:4e,dst=00:00:00:e7:16:ce),eth_type(0x0800),ipv4(src=0.0.0.0/0.0.0.0,dst=0.0.0.0/0.0.0.0,proto=0/0,tos=0/0,ttl=0/0,frag=no), packets:941539, bytes:62142230, used:0.260s, offloaded:yes, dp:tc, actions:54235e5753b8_h ufid:e00768d7-e652-4d79-8182-3291d852b791, skb_priority(0/0),skb_mark(0/0),ct_state(0/0x23),ct_zone(0/0),ct_mark(0/0),ct_label(0/0x1),recirc_id(0),dp_hash(0/0),in_port(54235e5753b8_h),packet_type(ns=0/0,id=0/0),eth(src=00:00:00:e7:16:ce,dst=00:00:00:c5:6d:4e),eth_type(0x0800),ipv4(src=0.0.0.0/0.0.0.0,dst=0.0.0.0/0.0.0.0,proto=0/0,tos=0/0,ttl=0/0,frag=no), packets:82386659, bytes:115944854173, used:0.260s, offloaded:yes, dp:tc, actions:5b45c61b307e_h \u5982\u679c\u6709 offloaded:yes, dp:tc \u5185\u5bb9\u8bc1\u660e\u5378\u8f7d\u6210\u529f\u3002","title":"\u521b\u5efa\u4f7f\u7528 VF \u7f51\u5361\u7684 Pod"},{"location":"advance/offload-mellanox/","text":"Mellanox \u7f51\u5361 Offload \u652f\u6301 Kube-OVN \u5728\u6700\u7ec8\u7684\u6570\u636e\u5e73\u9762\u4f7f\u7528 OVS \u6765\u5b8c\u6210\u6d41\u91cf\u8f6c\u53d1\uff0c\u76f8\u5173\u7684\u6d41\u8868\u5339\u914d\uff0c\u96a7\u9053\u5c01\u88c5\u7b49\u529f\u80fd\u4e3a CPU \u5bc6\u96c6\u578b\uff0c\u5728\u5927\u6d41\u91cf\u4e0b\u4f1a\u6d88\u8017\u5927\u91cf CPU \u8d44\u6e90\u5e76\u5bfc\u81f4 \u5ef6\u8fdf\u4e0a\u5347\u548c\u541e\u5410\u91cf\u4e0b\u964d\u3002Mellanox \u7684 Accelerated Switching And Packet Processing (ASAP\u00b2) \u6280\u672f\u53ef\u4ee5\u5c06 OVS \u76f8\u5173\u7684\u64cd\u4f5c\u5378\u8f7d\u5230\u786c\u4ef6\u7f51\u5361\u5185\u7684 eSwitch \u4e0a\u6267\u884c\u3002\u8be5\u6280\u672f\u53ef\u4ee5\u5728\u65e0\u9700\u5bf9 OVS \u63a7\u5236\u5e73\u9762\u8fdb\u884c\u4fee\u6539\u7684\u60c5\u51b5\u4e0b\uff0c\u7f29\u77ed\u6570\u636e\u8def\u5f84\uff0c\u907f\u514d\u5bf9\u4e3b\u673a CPU \u8d44\u6e90\u7684\u4f7f\u7528\uff0c\u5927\u5e45\u964d\u4f4e\u5ef6\u8fdf\u5e76\u663e\u8457\u63d0\u5347\u541e\u5410\u91cf\u3002 \u524d\u7f6e\u6761\u4ef6 Mellanox CX5/CX6/Bluefiled \u7b49\u652f\u6301 ASAP\u00b2 \u7684\u786c\u4ef6\u7f51\u5361\u3002 CentOS 8 Stream \u6216\u4e0a\u6e38 Linux 5.7 \u4ee5\u4e0a\u5185\u6838\u652f\u6301\u3002 \u7531\u4e8e\u5f53\u524d\u7f51\u5361\u4e0d\u652f\u6301 dp_hash \u548c hash \u64cd\u4f5c\u5378\u8f7d\uff0c\u9700\u5173\u95ed OVN LB \u529f\u80fd\u3002 \u4e3a\u4e86\u652f\u6301\u5378\u8f7d\u6a21\u5f0f\uff0c\u7f51\u5361\u4e0d\u80fd\u505a bond\u3002 \u8bbe\u7f6e\u7f51\u5361 SR-IOV \u6a21\u5f0f \u67e5\u8be2\u7f51\u5361\u7684\u8bbe\u5907 ID\uff0c\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\u4e3a 42:00.0 # lspci -nn | grep ConnectX-5 42:00.0 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5] [15b3:1017] \u6839\u636e\u8bbe\u5907 ID \u627e\u5230\u5bf9\u5e94\u7f51\u5361\uff1a # ls -l /sys/class/net/ | grep 42:00.0 lrwxrwxrwx. 1 root root 0 Jul 22 23:16 p4p1 -> ../../devices/pci0000:40/0000:40:02.0/0000:42:00.0/net/p4p1 \u68c0\u67e5\u53ef\u7528 VF \u6570\u91cf\uff1a # cat /sys/class/net/p4p1/device/sriov_totalvfs 8 \u521b\u5efa VF\uff0c\u603b\u6570\u4e0d\u8981\u8d85\u8fc7\u4e0a\u9762\u67e5\u8be2\u51fa\u7684\u6570\u91cf\uff1a # echo '4' > /sys/class/net/p4p1/device/sriov_numvfs # ip link show p4p1 10: p4p1: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000 link/ether b8:59:9f:c1:ec:12 brd ff:ff:ff:ff:ff:ff vf 0 MAC 00:00:00:00:00:00, spoof checking off, link-state auto, trust off, query_rss off vf 1 MAC 00:00:00:00:00:00, spoof checking off, link-state auto, trust off, query_rss off vf 2 MAC 00:00:00:00:00:00, spoof checking off, link-state auto, trust off, query_rss off vf 3 MAC 00:00:00:00:00:00, spoof checking off, link-state auto, trust off, query_rss off # ip link set p4p1 up \u627e\u5230\u4e0a\u8ff0 VF \u5bf9\u5e94\u7684\u8bbe\u5907 ID\uff1a # lspci -nn | grep ConnectX-5 42:00.0 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5] [15b3:1017] 42:00.1 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5] [15b3:1017] 42:00.2 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5 Virtual Function] [15b3:1018] 42:00.3 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5 Virtual Function] [15b3:1018] 42:00.4 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5 Virtual Function] [15b3:1018] 42:00.5 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5 Virtual Function] [15b3:1018] \u5c06 VF \u4ece\u9a71\u52a8\u4e2d\u89e3\u7ed1\uff1a echo 0000:42:00.2 > /sys/bus/pci/drivers/mlx5_core/unbind echo 0000:42:00.3 > /sys/bus/pci/drivers/mlx5_core/unbind echo 0000:42:00.4 > /sys/bus/pci/drivers/mlx5_core/unbind echo 0000:42:00.5 > /sys/bus/pci/drivers/mlx5_core/unbind \u5f00\u542f eSwitch \u6a21\u5f0f\uff0c\u5e76\u8bbe\u7f6e\u786c\u4ef6\u5378\u8f7d\uff1a devlink dev eswitch set pci/0000:42:00.0 mode switchdev ethtool -K enp66s0f0 hw-tc-offload on \u91cd\u65b0\u7ed1\u5b9a\u9a71\u52a8\uff0c\u5b8c\u6210 VF \u8bbe\u7f6e\uff1a echo 0000:42:00.2 > /sys/bus/pci/drivers/mlx5_core/bind echo 0000:42:00.3 > /sys/bus/pci/drivers/mlx5_core/bind echo 0000:42:00.4 > /sys/bus/pci/drivers/mlx5_core/bind echo 0000:42:00.5 > /sys/bus/pci/drivers/mlx5_core/bind NetworkManager \u7684\u4e00\u4e9b\u884c\u4e3a\u53ef\u80fd\u4f1a\u5bfc\u81f4\u9a71\u52a8\u5f02\u5e38\uff0c\u5982\u679c\u5378\u8f7d\u51fa\u73b0\u95ee\u9898\u5efa\u8bae\u5173\u95ed NetworkManager \u518d\u8fdb\u884c\u5c1d\u8bd5\uff1a systemctl stop NetworkManager systemctl disable NetworkManager \u5b89\u88c5 SR-IOV Device Plugin \u7531\u4e8e\u6bcf\u4e2a\u673a\u5668\u7684 VF \u6570\u91cf\u4f18\u5148\uff0c\u6bcf\u4e2a\u4f7f\u7528\u52a0\u901f\u7684 Pod \u4f1a\u5360\u7528 VF \u8d44\u6e90\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528 SR-IOV Device Plugin \u7ba1\u7406\u76f8\u5e94\u8d44\u6e90\uff0c\u4f7f\u5f97\u8c03\u5ea6\u5668\u77e5\u9053\u5982\u4f55\u6839\u636e \u8d44\u6e90\u8fdb\u884c\u8c03\u5ea6\u3002 \u521b\u5efa SR-IOV \u76f8\u5173 Configmap\uff1a apiVersion: v1 kind: ConfigMap metadata: name: sriovdp-config namespace: kube-system data: config.json: | { \"resourceList\": [{ \"resourcePrefix\": \"mellanox.com\", \"resourceName\": \"cx5_sriov_switchdev\", \"selectors\": { \"vendors\": [\"15b3\"], \"devices\": [\"1018\"], \"drivers\": [\"mlx5_core\"] } } ] } \u53c2\u8003 SR-IOV \u6587\u6863 \u8fdb\u884c\u90e8\u7f72: kubectl apply -f https://raw.githubusercontent.com/intel/sriov-network-device-plugin/master/deployments/k8s-v1.16/sriovdp-daemonset.yaml \u68c0\u67e5 SR-IOV \u8d44\u6e90\u662f\u5426\u5df2\u7ecf\u6ce8\u518c\u5230 Kubernetes Node \u4e2d\uff1a kubectl describe node kube-ovn-01 | grep mellanox mellanox.com/cx5_sriov_switchdev: 4 mellanox.com/cx5_sriov_switchdev: 4 mellanox.com/cx5_sriov_switchdev 0 0 \u5b89\u88c5 Multus-CNI SR-IOV Device Plugin \u8c03\u5ea6\u65f6\u83b7\u5f97\u7684\u8bbe\u5907 ID \u9700\u8981\u901a\u8fc7 Multus-CNI \u4f20\u9012\u7ed9 Kube-OVN\uff0c\u56e0\u6b64\u9700\u8981\u914d\u7f6e Multus-CNI \u914d\u5408\u5b8c\u6210\u76f8\u5173\u4efb\u52a1\u3002 \u53c2\u8003 Multius-CNI \u6587\u6863 \u8fdb\u884c\u90e8\u7f72\uff1a kubectl apply -f https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset.yml \u521b\u5efa NetworkAttachmentDefinition \uff1a apiVersion: \"k8s.cni.cncf.io/v1\" kind: NetworkAttachmentDefinition metadata: name: default namespace: default annotations: k8s.v1.cni.cncf.io/resourceName: mellanox.com/cx5_sriov_switchdev spec: config: '{ \"cniVersion\": \"0.3.1\", \"name\": \"kube-ovn\", \"plugins\":[ { \"type\":\"kube-ovn\", \"server_socket\":\"/run/openvswitch/kube-ovn-daemon.sock\", \"provider\": \"default.default.ovn\" }, { \"type\":\"portmap\", \"capabilities\":{ \"portMappings\":true } } ] }' provider : \u683c\u5f0f\u4e3a\u5f53\u524d NetworkAttachmentDefinition \u7684 {name}.{namespace}.ovn\u3002 Kube-OVN \u4e2d\u5f00\u542f\u5378\u8f7d\u6a21\u5f0f \u4e0b\u8f7d\u5b89\u88c5\u811a\u672c\uff1a wget https://raw.githubusercontent.com/alauda/kube-ovn/release-1.10/dist/images/install.sh \u4fee\u6539\u76f8\u5173\u53c2\u6570\uff0c IFACE \u9700\u8981\u4e3a\u7269\u7406\u7f51\u5361\u540d\uff0c\u8be5\u7f51\u5361\u9700\u8981\u6709\u53ef\u8def\u7531 IP\uff1a ENABLE_MIRROR=${ENABLE_MIRROR:-false} HW_OFFLOAD=${HW_OFFLOAD:-true} ENABLE_LB=${ENABLE_LB:-false} IFACE=\"ensp01\" \u5b89\u88c5 Kube-OVN\uff1a bash install.sh \u521b\u5efa\u4f7f\u7528 VF \u7f51\u5361\u7684 Pod \u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b yaml \u683c\u5f0f\u521b\u5efa\u4f7f\u7528 VF \u8fdb\u884c\u7f51\u7edc\u5378\u8f7d\u52a0\u901f\u7684 Pod: apiVersion: v1 kind: Pod metadata: name: nginx annotations: v1.multus-cni.io/default-network: default/default spec: containers: - name: nginx image: nginx:alpine resources: requests: mellanox.com/cx5_sriov_switchdev: '1' limits: mellanox.com/cx5_sriov_switchdev: '1' v1.multus-cni.io/default-network : \u4e3a\u4e0a\u4e00\u6b65\u9aa4\u4e2d NetworkAttachmentDefinition \u7684 {namespace}/{name}\u3002 \u53ef\u901a\u8fc7\u5728 Pod \u8fd0\u884c\u8282\u70b9\u7684 ovs-ovn \u5bb9\u5668\u4e2d\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u89c2\u5bdf\u5378\u8f7d\u662f\u5426\u6210\u529f\uff1a # ovs-appctl dpctl/dump-flows -m type=offloaded ufid:91cc45de-e7e9-4935-8f82-1890430b0f66, skb_priority(0/0),skb_mark(0/0),ct_state(0/0x23),ct_zone(0/0),ct_mark(0/0),ct_label(0/0x1),recirc_id(0),dp_hash(0/0),in_port(5b45c61b307e_h),packet_type(ns=0/0,id=0/0),eth(src=00:00:00:c5:6d:4e,dst=00:00:00:e7:16:ce),eth_type(0x0800),ipv4(src=0.0.0.0/0.0.0.0,dst=0.0.0.0/0.0.0.0,proto=0/0,tos=0/0,ttl=0/0,frag=no), packets:941539, bytes:62142230, used:0.260s, offloaded:yes, dp:tc, actions:54235e5753b8_h ufid:e00768d7-e652-4d79-8182-3291d852b791, skb_priority(0/0),skb_mark(0/0),ct_state(0/0x23),ct_zone(0/0),ct_mark(0/0),ct_label(0/0x1),recirc_id(0),dp_hash(0/0),in_port(54235e5753b8_h),packet_type(ns=0/0,id=0/0),eth(src=00:00:00:e7:16:ce,dst=00:00:00:c5:6d:4e),eth_type(0x0800),ipv4(src=0.0.0.0/0.0.0.0,dst=0.0.0.0/0.0.0.0,proto=0/0,tos=0/0,ttl=0/0,frag=no), packets:82386659, bytes:115944854173, used:0.260s, offloaded:yes, dp:tc, actions:5b45c61b307e_h \u5982\u679c\u6709 offloaded:yes, dp:tc \u5185\u5bb9\u8bc1\u660e\u5378\u8f7d\u6210\u529f\u3002","title":"Mellanox \u7f51\u5361 Offload \u652f\u6301"},{"location":"advance/offload-mellanox/#mellanox-offload","text":"Kube-OVN \u5728\u6700\u7ec8\u7684\u6570\u636e\u5e73\u9762\u4f7f\u7528 OVS \u6765\u5b8c\u6210\u6d41\u91cf\u8f6c\u53d1\uff0c\u76f8\u5173\u7684\u6d41\u8868\u5339\u914d\uff0c\u96a7\u9053\u5c01\u88c5\u7b49\u529f\u80fd\u4e3a CPU \u5bc6\u96c6\u578b\uff0c\u5728\u5927\u6d41\u91cf\u4e0b\u4f1a\u6d88\u8017\u5927\u91cf CPU \u8d44\u6e90\u5e76\u5bfc\u81f4 \u5ef6\u8fdf\u4e0a\u5347\u548c\u541e\u5410\u91cf\u4e0b\u964d\u3002Mellanox \u7684 Accelerated Switching And Packet Processing (ASAP\u00b2) \u6280\u672f\u53ef\u4ee5\u5c06 OVS \u76f8\u5173\u7684\u64cd\u4f5c\u5378\u8f7d\u5230\u786c\u4ef6\u7f51\u5361\u5185\u7684 eSwitch \u4e0a\u6267\u884c\u3002\u8be5\u6280\u672f\u53ef\u4ee5\u5728\u65e0\u9700\u5bf9 OVS \u63a7\u5236\u5e73\u9762\u8fdb\u884c\u4fee\u6539\u7684\u60c5\u51b5\u4e0b\uff0c\u7f29\u77ed\u6570\u636e\u8def\u5f84\uff0c\u907f\u514d\u5bf9\u4e3b\u673a CPU \u8d44\u6e90\u7684\u4f7f\u7528\uff0c\u5927\u5e45\u964d\u4f4e\u5ef6\u8fdf\u5e76\u663e\u8457\u63d0\u5347\u541e\u5410\u91cf\u3002","title":"Mellanox \u7f51\u5361 Offload \u652f\u6301"},{"location":"advance/offload-mellanox/#_1","text":"Mellanox CX5/CX6/Bluefiled \u7b49\u652f\u6301 ASAP\u00b2 \u7684\u786c\u4ef6\u7f51\u5361\u3002 CentOS 8 Stream \u6216\u4e0a\u6e38 Linux 5.7 \u4ee5\u4e0a\u5185\u6838\u652f\u6301\u3002 \u7531\u4e8e\u5f53\u524d\u7f51\u5361\u4e0d\u652f\u6301 dp_hash \u548c hash \u64cd\u4f5c\u5378\u8f7d\uff0c\u9700\u5173\u95ed OVN LB \u529f\u80fd\u3002 \u4e3a\u4e86\u652f\u6301\u5378\u8f7d\u6a21\u5f0f\uff0c\u7f51\u5361\u4e0d\u80fd\u505a bond\u3002","title":"\u524d\u7f6e\u6761\u4ef6"},{"location":"advance/offload-mellanox/#sr-iov","text":"\u67e5\u8be2\u7f51\u5361\u7684\u8bbe\u5907 ID\uff0c\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\u4e3a 42:00.0 # lspci -nn | grep ConnectX-5 42:00.0 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5] [15b3:1017] \u6839\u636e\u8bbe\u5907 ID \u627e\u5230\u5bf9\u5e94\u7f51\u5361\uff1a # ls -l /sys/class/net/ | grep 42:00.0 lrwxrwxrwx. 1 root root 0 Jul 22 23:16 p4p1 -> ../../devices/pci0000:40/0000:40:02.0/0000:42:00.0/net/p4p1 \u68c0\u67e5\u53ef\u7528 VF \u6570\u91cf\uff1a # cat /sys/class/net/p4p1/device/sriov_totalvfs 8 \u521b\u5efa VF\uff0c\u603b\u6570\u4e0d\u8981\u8d85\u8fc7\u4e0a\u9762\u67e5\u8be2\u51fa\u7684\u6570\u91cf\uff1a # echo '4' > /sys/class/net/p4p1/device/sriov_numvfs # ip link show p4p1 10: p4p1: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000 link/ether b8:59:9f:c1:ec:12 brd ff:ff:ff:ff:ff:ff vf 0 MAC 00:00:00:00:00:00, spoof checking off, link-state auto, trust off, query_rss off vf 1 MAC 00:00:00:00:00:00, spoof checking off, link-state auto, trust off, query_rss off vf 2 MAC 00:00:00:00:00:00, spoof checking off, link-state auto, trust off, query_rss off vf 3 MAC 00:00:00:00:00:00, spoof checking off, link-state auto, trust off, query_rss off # ip link set p4p1 up \u627e\u5230\u4e0a\u8ff0 VF \u5bf9\u5e94\u7684\u8bbe\u5907 ID\uff1a # lspci -nn | grep ConnectX-5 42:00.0 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5] [15b3:1017] 42:00.1 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5] [15b3:1017] 42:00.2 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5 Virtual Function] [15b3:1018] 42:00.3 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5 Virtual Function] [15b3:1018] 42:00.4 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5 Virtual Function] [15b3:1018] 42:00.5 Ethernet controller [0200]: Mellanox Technologies MT27800 Family [ConnectX-5 Virtual Function] [15b3:1018] \u5c06 VF \u4ece\u9a71\u52a8\u4e2d\u89e3\u7ed1\uff1a echo 0000:42:00.2 > /sys/bus/pci/drivers/mlx5_core/unbind echo 0000:42:00.3 > /sys/bus/pci/drivers/mlx5_core/unbind echo 0000:42:00.4 > /sys/bus/pci/drivers/mlx5_core/unbind echo 0000:42:00.5 > /sys/bus/pci/drivers/mlx5_core/unbind \u5f00\u542f eSwitch \u6a21\u5f0f\uff0c\u5e76\u8bbe\u7f6e\u786c\u4ef6\u5378\u8f7d\uff1a devlink dev eswitch set pci/0000:42:00.0 mode switchdev ethtool -K enp66s0f0 hw-tc-offload on \u91cd\u65b0\u7ed1\u5b9a\u9a71\u52a8\uff0c\u5b8c\u6210 VF \u8bbe\u7f6e\uff1a echo 0000:42:00.2 > /sys/bus/pci/drivers/mlx5_core/bind echo 0000:42:00.3 > /sys/bus/pci/drivers/mlx5_core/bind echo 0000:42:00.4 > /sys/bus/pci/drivers/mlx5_core/bind echo 0000:42:00.5 > /sys/bus/pci/drivers/mlx5_core/bind NetworkManager \u7684\u4e00\u4e9b\u884c\u4e3a\u53ef\u80fd\u4f1a\u5bfc\u81f4\u9a71\u52a8\u5f02\u5e38\uff0c\u5982\u679c\u5378\u8f7d\u51fa\u73b0\u95ee\u9898\u5efa\u8bae\u5173\u95ed NetworkManager \u518d\u8fdb\u884c\u5c1d\u8bd5\uff1a systemctl stop NetworkManager systemctl disable NetworkManager","title":"\u8bbe\u7f6e\u7f51\u5361 SR-IOV \u6a21\u5f0f"},{"location":"advance/offload-mellanox/#sr-iov-device-plugin","text":"\u7531\u4e8e\u6bcf\u4e2a\u673a\u5668\u7684 VF \u6570\u91cf\u4f18\u5148\uff0c\u6bcf\u4e2a\u4f7f\u7528\u52a0\u901f\u7684 Pod \u4f1a\u5360\u7528 VF \u8d44\u6e90\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528 SR-IOV Device Plugin \u7ba1\u7406\u76f8\u5e94\u8d44\u6e90\uff0c\u4f7f\u5f97\u8c03\u5ea6\u5668\u77e5\u9053\u5982\u4f55\u6839\u636e \u8d44\u6e90\u8fdb\u884c\u8c03\u5ea6\u3002 \u521b\u5efa SR-IOV \u76f8\u5173 Configmap\uff1a apiVersion: v1 kind: ConfigMap metadata: name: sriovdp-config namespace: kube-system data: config.json: | { \"resourceList\": [{ \"resourcePrefix\": \"mellanox.com\", \"resourceName\": \"cx5_sriov_switchdev\", \"selectors\": { \"vendors\": [\"15b3\"], \"devices\": [\"1018\"], \"drivers\": [\"mlx5_core\"] } } ] } \u53c2\u8003 SR-IOV \u6587\u6863 \u8fdb\u884c\u90e8\u7f72: kubectl apply -f https://raw.githubusercontent.com/intel/sriov-network-device-plugin/master/deployments/k8s-v1.16/sriovdp-daemonset.yaml \u68c0\u67e5 SR-IOV \u8d44\u6e90\u662f\u5426\u5df2\u7ecf\u6ce8\u518c\u5230 Kubernetes Node \u4e2d\uff1a kubectl describe node kube-ovn-01 | grep mellanox mellanox.com/cx5_sriov_switchdev: 4 mellanox.com/cx5_sriov_switchdev: 4 mellanox.com/cx5_sriov_switchdev 0 0","title":"\u5b89\u88c5 SR-IOV Device Plugin"},{"location":"advance/offload-mellanox/#multus-cni","text":"SR-IOV Device Plugin \u8c03\u5ea6\u65f6\u83b7\u5f97\u7684\u8bbe\u5907 ID \u9700\u8981\u901a\u8fc7 Multus-CNI \u4f20\u9012\u7ed9 Kube-OVN\uff0c\u56e0\u6b64\u9700\u8981\u914d\u7f6e Multus-CNI \u914d\u5408\u5b8c\u6210\u76f8\u5173\u4efb\u52a1\u3002 \u53c2\u8003 Multius-CNI \u6587\u6863 \u8fdb\u884c\u90e8\u7f72\uff1a kubectl apply -f https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset.yml \u521b\u5efa NetworkAttachmentDefinition \uff1a apiVersion: \"k8s.cni.cncf.io/v1\" kind: NetworkAttachmentDefinition metadata: name: default namespace: default annotations: k8s.v1.cni.cncf.io/resourceName: mellanox.com/cx5_sriov_switchdev spec: config: '{ \"cniVersion\": \"0.3.1\", \"name\": \"kube-ovn\", \"plugins\":[ { \"type\":\"kube-ovn\", \"server_socket\":\"/run/openvswitch/kube-ovn-daemon.sock\", \"provider\": \"default.default.ovn\" }, { \"type\":\"portmap\", \"capabilities\":{ \"portMappings\":true } } ] }' provider : \u683c\u5f0f\u4e3a\u5f53\u524d NetworkAttachmentDefinition \u7684 {name}.{namespace}.ovn\u3002","title":"\u5b89\u88c5 Multus-CNI"},{"location":"advance/offload-mellanox/#kube-ovn","text":"\u4e0b\u8f7d\u5b89\u88c5\u811a\u672c\uff1a wget https://raw.githubusercontent.com/alauda/kube-ovn/release-1.10/dist/images/install.sh \u4fee\u6539\u76f8\u5173\u53c2\u6570\uff0c IFACE \u9700\u8981\u4e3a\u7269\u7406\u7f51\u5361\u540d\uff0c\u8be5\u7f51\u5361\u9700\u8981\u6709\u53ef\u8def\u7531 IP\uff1a ENABLE_MIRROR=${ENABLE_MIRROR:-false} HW_OFFLOAD=${HW_OFFLOAD:-true} ENABLE_LB=${ENABLE_LB:-false} IFACE=\"ensp01\" \u5b89\u88c5 Kube-OVN\uff1a bash install.sh","title":"Kube-OVN \u4e2d\u5f00\u542f\u5378\u8f7d\u6a21\u5f0f"},{"location":"advance/offload-mellanox/#vf-pod","text":"\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b yaml \u683c\u5f0f\u521b\u5efa\u4f7f\u7528 VF \u8fdb\u884c\u7f51\u7edc\u5378\u8f7d\u52a0\u901f\u7684 Pod: apiVersion: v1 kind: Pod metadata: name: nginx annotations: v1.multus-cni.io/default-network: default/default spec: containers: - name: nginx image: nginx:alpine resources: requests: mellanox.com/cx5_sriov_switchdev: '1' limits: mellanox.com/cx5_sriov_switchdev: '1' v1.multus-cni.io/default-network : \u4e3a\u4e0a\u4e00\u6b65\u9aa4\u4e2d NetworkAttachmentDefinition \u7684 {namespace}/{name}\u3002 \u53ef\u901a\u8fc7\u5728 Pod \u8fd0\u884c\u8282\u70b9\u7684 ovs-ovn \u5bb9\u5668\u4e2d\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u89c2\u5bdf\u5378\u8f7d\u662f\u5426\u6210\u529f\uff1a # ovs-appctl dpctl/dump-flows -m type=offloaded ufid:91cc45de-e7e9-4935-8f82-1890430b0f66, skb_priority(0/0),skb_mark(0/0),ct_state(0/0x23),ct_zone(0/0),ct_mark(0/0),ct_label(0/0x1),recirc_id(0),dp_hash(0/0),in_port(5b45c61b307e_h),packet_type(ns=0/0,id=0/0),eth(src=00:00:00:c5:6d:4e,dst=00:00:00:e7:16:ce),eth_type(0x0800),ipv4(src=0.0.0.0/0.0.0.0,dst=0.0.0.0/0.0.0.0,proto=0/0,tos=0/0,ttl=0/0,frag=no), packets:941539, bytes:62142230, used:0.260s, offloaded:yes, dp:tc, actions:54235e5753b8_h ufid:e00768d7-e652-4d79-8182-3291d852b791, skb_priority(0/0),skb_mark(0/0),ct_state(0/0x23),ct_zone(0/0),ct_mark(0/0),ct_label(0/0x1),recirc_id(0),dp_hash(0/0),in_port(54235e5753b8_h),packet_type(ns=0/0,id=0/0),eth(src=00:00:00:e7:16:ce,dst=00:00:00:c5:6d:4e),eth_type(0x0800),ipv4(src=0.0.0.0/0.0.0.0,dst=0.0.0.0/0.0.0.0,proto=0/0,tos=0/0,ttl=0/0,frag=no), packets:82386659, bytes:115944854173, used:0.260s, offloaded:yes, dp:tc, actions:5b45c61b307e_h \u5982\u679c\u6709 offloaded:yes, dp:tc \u5185\u5bb9\u8bc1\u660e\u5378\u8f7d\u6210\u529f\u3002","title":"\u521b\u5efa\u4f7f\u7528 VF \u7f51\u5361\u7684 Pod"},{"location":"advance/performance-tuning/","text":"\u6027\u80fd\u8c03\u4f18 \u4e3a\u4e86\u4fdd\u6301\u5b89\u88c5\u7684\u7b80\u5355\u548c\u529f\u80fd\u7684\u5b8c\u5907\uff0cKube-OVN \u7684\u9ed8\u8ba4\u5b89\u88c5\u811a\u672c\u5e76\u6ca1\u6709\u5bf9\u6027\u80fd\u9488\u5bf9\u6027\u7684\u4f18\u5316\u3002\u5982\u679c\u5e94\u7528\u5bf9\u5ef6\u8fdf\u548c\u541e\u5410\u91cf\u654f\u611f\uff0c \u7ba1\u7406\u5458\u53ef\u4ee5\u901a\u8fc7\u672c\u6587\u6863\u5bf9\u6027\u80fd\u8fdb\u884c\u9488\u5bf9\u6027\u4f18\u5316\u3002 \u793e\u533a\u4f1a\u4e0d\u65ad\u8fed\u4ee3\u63a7\u5236\u9762\u677f\u548c\u4f18\u5316\u9762\u7684\u6027\u80fd\uff0c\u90e8\u5206\u901a\u7528\u6027\u80fd\u4f18\u5316\u5df2\u7ecf\u96c6\u6210\u5230\u6700\u65b0\u7248\u672c\uff0c\u5efa\u8bae\u4f7f\u7528\u6700\u65b0\u7248\u672c\u83b7\u5f97\u66f4\u597d\u7684\u9ed8\u8ba4\u6027\u80fd\u3002 \u66f4\u591a\u5173\u4e8e\u6027\u80fd\u4f18\u5316\u7684\u8fc7\u7a0b\u548c\u65b9\u6cd5\u8bba\uff0c\u53ef\u4ee5\u89c2\u770b\u89c6\u9891\u5206\u4eab\uff1a Kube-OVN \u5bb9\u5668\u6027\u80fd\u4f18\u5316\u4e4b\u65c5 \u3002 \u57fa\u51c6\u6d4b\u8bd5 \u7531\u4e8e\u8f6f\u786c\u4ef6\u73af\u5883\u7684\u5dee\u5f02\u6781\u5927\uff0c\u8fd9\u91cc\u63d0\u4f9b\u7684\u6027\u80fd\u6d4b\u8bd5\u6570\u636e\u53ea\u80fd\u4f5c\u4e3a\u53c2\u8003\uff0c\u5b9e\u9645\u6d4b\u8bd5\u7ed3\u679c\u4f1a\u548c\u5c0f\u9762\u771f\u5b9e\u7684\u7ed3\u679c\u5b58\u5728\u8f83\u5927\u5dee\u5f02\u3002 \u5efa\u8bae\u6bd4\u8f83\u4f18\u5316\u524d\u540e\u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\uff0c\u548c\u5bbf\u4e3b\u673a\u7f51\u7edc\u548c\u5bb9\u5668\u7f51\u7edc\u7684\u6027\u80fd\u6bd4\u8f83\u3002 Overlay \u4f18\u5316\u524d\u540e\u6027\u80fd\u5bf9\u6bd4 \u73af\u5883\u4fe1\u606f\uff1a - Kubernetes: 1.22.0 - OS: CentOS 7 - Kube-OVN: 1.8.0 Overlay \u6a21\u5f0f - CPU: Intel(R) Xeon(R) E-2278G - Network: 2*10Gbps, xmit_hash_policy=layer3+4 \u6211\u4eec\u4f7f\u7528 qperf -t 60 <server ip> -ub -oo msg_size:1 -vu tcp_lat tcp_bw udp_lat udp_bw \u6d4b\u8bd5 1 \u5b57\u8282\u5c0f\u5305\u4e0b tcp/udp \u7684\u5e26\u5bbd\u548c\u5ef6\u8fdf\uff0c\u5206\u522b\u6d4b\u8bd5\u4f18\u5316\u524d\uff0c\u4f18\u5316\u540e\u4ee5\u53ca\u5bbf\u4e3b\u673a\u7f51\u7edc\u7684\u6027\u80fd\uff1a Type tcp_lat (us) udp_lat (us) tcp_bw (Mb/s) udp_bw(Mb/s) Kube-OVN Default 25.7 22.9 27.1 1.59 Kube-OVN Optimized 13.9 12.9 27.6 5.57 HOST Network 13.1 12.4 28.2 6.02 Overlay\uff0c Underlay \u4ee5\u53ca Calico \u4e0d\u540c\u6a21\u5f0f\u6027\u80fd\u5bf9\u6bd4 \u4e0b\u9762\u6211\u4eec\u4f1a\u6bd4\u8f83\u4f18\u5316\u540e Kube-OVN \u5728\u4e0d\u540c\u5305\u5927\u5c0f\u4e0b\u7684 Overlay \u548c Underlay \u6027\u80fd\uff0c\u5e76\u548c Calico \u7684 IPIP Always IPIP never \u4ee5\u53ca\u5bbf\u4e3b\u673a\u7f51\u7edc\u505a\u6bd4\u8f83\u3002 Environment : - Kubernetes: 1.22.0 - OS: CentOS 7 - Kube-OVN: 1.8.0 - CPU: AMD EPYC 7402P 24-Core Processor - Network: Intel Corporation Ethernet Controller XXV710 for 25GbE SFP28 qperf -t 60 <server ip> -ub -oo msg_size:1 -vu tcp_lat tcp_bw udp_lat udp_bw Type tcp_lat (us) udp_lat (us) tcp_bw (Mb/s) udp_bw(Mb/s) Kube-OVN Overlay 15.2 14.6 23.6 2.65 Kube-OVN Underlay 14.3 13.8 24.2 3.46 Calico IPIP 21.4 20.2 23.6 1.18 Calico NoEncap 19.3 16.9 23.6 1.76 HOST Network 16.6 15.4 24.8 2.64 qperf -t 60 <server ip> -ub -oo msg_size:1K -vu tcp_lat tcp_bw udp_lat udp_bw Type tcp_lat (us) udp_lat (us) tcp_bw (Gb/s) udp_bw(Gb/s) Kube-OVN Overlay 16.5 15.8 10.2 2.77 Kube-OVN Underlay 15.9 14.5 9.6 3.22 Calico IPIP 22.5 21.5 1.45 1.14 Calico NoEncap 19.4 18.3 3.76 1.63 HOST Network 18.1 16.6 9.32 2.66 qperf -t 60 <server ip> -ub -oo msg_size:4K -vu tcp_lat tcp_bw udp_lat udp_bw Type tcp_lat (us) udp_lat (us) tcp_bw (Gb/s) udp_bw(Gb/s) Kube-OVN Overlay 34.7 41.6 16.0 9.23 Kube-OVN Underlay 32.6 44 15.1 6.71 Calico IPIP 44.8 52.9 2.94 3.26 Calico NoEncap 40 49.6 6.56 4.19 HOST Network 35.9 45.9 14.6 5.59 \u5728\u90e8\u5206\u60c5\u51b5\u4e0b\u5bb9\u5668\u7f51\u7edc\u7684\u6027\u80fd\u4f1a\u4f18\u4e8e\u5bbf\u4e3b\u673a\u7f51\u7edc\uff0c\u8fd9\u662f\u4f18\u4e8e\u7ecf\u8fc7\u4f18\u5316\u540e\u5bb9\u5668\u7f51\u7edc\u8def\u5f84\u5b8c\u5168\u7ed5\u8fc7\u4e86 netfilter\uff0c \u800c\u5bbf\u4e3b\u673a\u7f51\u7edc\u7531\u4e8e kube-proxy \u7684\u5b58\u5728\u6240\u6709\u6570\u636e\u5305\u5747\u9700\u7ecf\u8fc7 netfilter\uff0c\u4f1a\u5bfc\u81f4\u5728\u4e00\u4e9b\u73af\u5883\u4e0b\u5bb9\u5668\u7f51\u7edc \u7684\u6d88\u8017\u76f8\u5bf9\u66f4\u5c0f\uff0c\u56e0\u6b64\u4f1a\u6709\u66f4\u597d\u7684\u6027\u80fd\u8868\u73b0\u3002 \u6570\u636e\u5e73\u9762\u6027\u80fd\u4f18\u5316\u65b9\u6cd5 \u8fd9\u91cc\u4ecb\u7ecd\u7684\u4f18\u5316\u65b9\u6cd5\u548c\u8f6f\u786c\u4ef6\u73af\u5883\u4ee5\u53ca\u6240\u9700\u8981\u7684\u529f\u80fd\u76f8\u5173\uff0c\u8bf7\u4ed4\u7ec6\u4e86\u89e3\u4f18\u5316\u7684\u524d\u63d0\u6761\u4ef6\u518d\u8fdb\u884c\u5c1d\u8bd5\u3002 CPU \u6027\u80fd\u6a21\u5f0f\u8c03\u6574 \u90e8\u5206\u73af\u5883\u4e0b CPU \u8fd0\u884c\u5728\u8282\u80fd\u6a21\u5f0f\uff0c\u8be5\u6a21\u5f0f\u4e0b\u6027\u80fd\u8868\u73b0\u5c06\u4f1a\u4e0d\u7a33\u5b9a\uff0c\u5ef6\u8fdf\u4f1a\u51fa\u73b0\u660e\u663e\u589e\u52a0\uff0c\u5efa\u8bae\u4f7f\u7528 CPU \u7684\u6027\u80fd\u6a21\u5f0f\u83b7\u5f97\u66f4\u7a33\u5b9a\u7684\u6027\u80fd\u8868\u73b0\uff1a cpupower frequency-set -g performance \u7f51\u5361\u786c\u4ef6\u961f\u5217\u8c03\u6574 \u5728\u6d41\u91cf\u589e\u5927\u7684\u60c5\u51b5\u4e0b\uff0c\u7f13\u51b2\u961f\u5217\u8fc7\u77ed\u53ef\u80fd\u5bfc\u81f4\u8f83\u9ad8\u7684\u4e22\u5305\u7387\u5bfc\u81f4\u6027\u80fd\u663e\u8457\u4e0b\u964d\uff0c\u9700\u8981\u8fdb\u884c\u8c03\u6574 \u68c0\u67e5\u5f53\u524d\u7f51\u5361\u961f\u5217\u957f\u5ea6\uff1a # ethtool -g eno1 Ring parameters for eno1: Pre-set maximums: RX: 4096 RX Mini: 0 RX Jumbo: 0 TX: 4096 Current hardware settings: RX: 255 RX Mini: 0 RX Jumbo: 0 TX: 255 \u589e\u52a0\u961f\u5217\u957f\u5ea6\u81f3\u6700\u5927\u503c\uff1a ethtool -G eno1 rx 4096 ethtool -G eno1 tx 4096 \u4f7f\u7528 tuned \u4f18\u5316\u7cfb\u7edf\u53c2\u6570 tuned \u53ef\u4ee5\u4f7f\u7528\u4e00\u7cfb\u5217\u9884\u7f6e\u7684 profile \u6587\u4ef6\u4fdd\u5b58\u4e86\u9488\u5bf9\u7279\u5b9a\u573a\u666f\u7684\u4e00\u7cfb\u5217\u7cfb\u7edf\u4f18\u5316\u914d\u7f6e\u3002 \u9488\u5bf9\u5ef6\u8fdf\u4f18\u5148\u573a\u666f\uff1a tuned-adm profile network-latency \u9488\u5bf9\u541e\u5410\u91cf\u4f18\u5148\u573a\u666f\uff1a tuned-adm profile network-throughput \u4e2d\u65ad\u7ed1\u5b9a \u6211\u4eec\u63a8\u8350\u7981\u7528 irqbalance \u5e76\u5c06\u7f51\u5361\u4e2d\u65ad\u548c\u7279\u5b9a CPU \u8fdb\u884c\u7ed1\u5b9a\uff0c\u6765\u907f\u514d\u5728\u591a\u4e2a CPU \u4e4b\u95f4\u5207\u6362\u5bfc\u81f4\u7684\u6027\u80fd\u6ce2\u52a8\u3002 \u5173\u95ed OVN LB OVN \u7684 L2 LB \u5b9e\u73b0\u8fc7\u7a0b\u4e2d\u9700\u8981\u8c03\u7528\u5185\u6838\u7684 conntrack \u6a21\u5757\u5e76\u8fdb\u884c recirculate \u5bfc\u81f4\u5927\u91cf\u7684 CPU \u5f00\u9500\uff0c\u7ecf\u6d4b\u8bd5\u8be5\u529f\u80fd\u4f1a\u5e26\u6765 20% \u5de6\u53f3\u7684 CPU \u5f00\u9500\uff0c Overlay \u5982\u679c\u4f7f\u7528 kube-proxy \u6216 Cilium \u5b8c\u6210 Service \u8f6c\u53d1\u529f\u80fd\uff0c\u53ef\u4ee5\u5728 kube-ovn-controller \u4e2d\u5173\u95ed\u8be5\u529f\u80fd\uff0c\u83b7\u5f97\u66f4\u597d\u7684 Pod-to-Pod \u6027\u80fd\uff1a command: - /kube-ovn/start-controller.sh args: ... - --enable-lb=false ... Underlay \u6a21\u5f0f\u4e0b kube-proxy \u65e0\u6cd5\u4f7f\u7528 iptables \u6216 ipvs \u63a7\u5236\u5bb9\u5668\u7f51\u7edc\u6d41\u91cf\uff0c\u5982\u9700\u5173\u95ed LB \u529f\u80fd\u9700\u8981\u786e\u8ba4\u662f\u5426\u4e0d\u9700\u8981 Service \u529f\u80fd\uff0c\u6216\u53ef\u4f7f\u7528 \u5176\u4ed6 Service \u5b9e\u73b0\uff08\u4f8b\u5982 Cilium\uff09\u66ff\u4ee3\u3002 \u5185\u6838 FastPath \u6a21\u5757 \u7531\u4e8e\u5bb9\u5668\u7f51\u7edc\u548c\u5bbf\u4e3b\u673a\u7f51\u7edc\u5728\u4e0d\u540c\u7684 network ns\uff0c\u6570\u636e\u5305\u5728\u8de8\u5bbf\u4e3b\u673a\u4f20\u8f93\u65f6\u4f1a\u591a\u6b21\u7ecf\u8fc7 netfilter \u6a21\u5757\uff0c\u4f1a\u5e26\u6765\u8fd1 20% \u7684 CPU \u5f00\u9500\u3002\u7531\u4e8e\u5927\u90e8\u5206\u60c5\u51b5\u4e0b \u5bb9\u5668\u7f51\u7edc\u5185\u5e94\u7528\u65e0\u987b\u4f7f\u7528 netfilter \u6a21\u5757\u7684\u529f\u80fd\uff0c FastPath \u6a21\u5757\u53ef\u4ee5\u7ed5\u8fc7 netfilter \u964d\u4f4e CPU \u5f00\u9500\u3002 \u5982\u5bb9\u5668\u7f51\u7edc\u5185\u9700\u8981\u4f7f\u7528 netfilter \u63d0\u4f9b\u7684\u529f\u80fd\u5982 iptables\uff0cipvs\uff0cnftables \u7b49\uff0c\u8be5\u6a21\u5757\u4f1a\u4f7f\u76f8\u5173\u529f\u80fd\u5931\u6548\u3002 \u7531\u4e8e\u5185\u6838\u6a21\u5757\u548c\u5185\u6838\u7248\u672c\u76f8\u5173\uff0c\u65e0\u6cd5\u63d0\u4f9b\u4e00\u4e2a\u5355\u4e00\u9002\u5e94\u6240\u6709\u5185\u6838\u7684\u5185\u6838\u6a21\u5757\u5236\u54c1\u3002\u6211\u4eec\u9884\u5148\u7f16\u8bd1\u4e86\u90e8\u5206\u5185\u6838\u7684 FastPath \u6a21\u5757\uff0c \u53ef\u4ee5\u524d\u5f80 tunning-package \u8fdb\u884c\u4e0b\u8f7d\u3002 \u4e5f\u53ef\u4ee5\u624b\u52a8\u8fdb\u884c\u7f16\u8bd1\uff0c\u65b9\u6cd5\u53c2\u8003 \u624b\u52a8\u7f16\u8bd1 FastPath \u6a21\u5757 \u83b7\u5f97\u5185\u6838\u6a21\u5757\u540e\u53ef\u5728\u6bcf\u4e2a\u8282\u70b9\u4f7f\u7528 insmod kube_ovn_fastpath.ko \u52a0\u8f7d FastPath \u6a21\u5757\uff0c\u5e76\u4f7f\u7528 dmesg \u9a8c\u8bc1\u6a21\u5757\u52a0\u8f7d\u6210\u529f\uff1a # dmesg ... [619631.323788] init_module,kube_ovn_fastpath_local_out [619631.323798] init_module,kube_ovn_fastpath_post_routing [619631.323800] init_module,kube_ovn_fastpath_pre_routing [619631.323801] init_module,kube_ovn_fastpath_local_in ... OVS \u5185\u6838\u6a21\u5757\u4f18\u5316 OVS \u7684 flow \u5904\u7406\u5305\u62ec\u54c8\u5e0c\u8ba1\u7b97\uff0c\u5339\u914d\u7b49\u64cd\u4f5c\u4f1a\u6d88\u8017\u5927\u7ea6 10% \u5de6\u53f3\u7684 CPU \u8d44\u6e90\u3002\u73b0\u4ee3 x86 CPU \u4e0a\u7684\u4e00\u4e9b\u6307\u4ee4\u96c6\u4f8b\u5982 popcnt \u548c sse4.2 \u53ef\u4ee5 \u52a0\u901f\u76f8\u5173\u8ba1\u7b97\u8fc7\u7a0b\uff0c\u5355\u9ed8\u8ba4\u7f16\u8bd1\u672a\u5f00\u542f\u76f8\u5173\u9009\u9879\u3002\u7ecf\u6d4b\u8bd5\u5728\u5f00\u542f\u76f8\u5e94\u6307\u4ee4\u96c6\u4f18\u5316\u540e\uff0cflow \u76f8\u5173\u64cd\u4f5c CPU \u6d88\u8017\u5c06\u4f1a\u964d\u81f3 5% \u5de6\u53f3\u3002 \u548c FastPath \u6a21\u5757\u7684\u7f16\u8bd1\u7c7b\u4f3c\uff0c\u7531\u4e8e\u5185\u6838\u6a21\u5757\u548c\u5185\u6838\u7248\u672c\u76f8\u5173\uff0c\u65e0\u6cd5\u63d0\u4f9b\u4e00\u4e2a\u5355\u4e00\u9002\u5e94\u6240\u6709\u5185\u6838\u7684\u5185\u6838\u6a21\u5757\u5236\u54c1\u3002\u7528\u6237\u9700\u8981\u624b\u52a8\u7f16\u8bd1\u6216\u8005 \u524d\u5f80 tunning-package \u67e5\u770b\u662f\u5426\u6709\u4ee5\u7f16\u8bd1\u597d\u7684\u5236\u54c1\u8fdb\u884c\u4e0b\u8f7d\u3002 \u4f7f\u7528\u8be5\u5185\u6838\u6a21\u5757\u524d\u8bf7\u5148\u786e\u8ba4 CPU \u662f\u5426\u652f\u6301\u76f8\u5173\u6307\u4ee4\u96c6\uff1a cat /proc/cpuinfo | grep popcnt cat /proc/cpuinfo | grep sse4_2 CentOS \u4e0b\u7f16\u8bd1\u5b89\u88c5 \u5b89\u88c5\u76f8\u5173\u7f16\u8bd1\u4f9d\u8d56\u548c\u5185\u6838\u5934\u6587\u4ef6\uff1a yum install -y gcc kernel-devel-$(uname -r) python3 autoconf automake libtool rpm-build openssl-devel \u7f16\u8bd1 OVS \u5185\u6838\u6a21\u5757\u5e76\u751f\u6210\u5bf9\u5e94 RPM \u6587\u4ef6: git clone -b branch-2.17 --depth=1 https://github.com/openvswitch/ovs.git cd ovs curl -s https://github.com/kubeovn/ovs/commit/2d2c83c26d4217446918f39d5cd5838e9ac27b32.patch | git apply ./boot.sh ./configure --with-linux=/lib/modules/$(uname -r)/build CFLAGS=\"-g -O2 -mpopcnt -msse4.2\" make rpm-fedora-kmod cd rpm/rpmbuild/RPMS/x86_64/ \u590d\u5236 RPM \u5230\u6bcf\u4e2a\u8282\u70b9\u5e76\u8fdb\u884c\u5b89\u88c5\uff1a rpm -i openvswitch-kmod-2.15.2-1.el7.x86_64.rpm \u82e5\u4e4b\u524d\u5df2\u7ecf\u542f\u52a8\u8fc7 Kube-OVN\uff0c\u65e7\u7248\u672c OVS \u6a21\u5757\u5df2\u52a0\u8f7d\u81f3\u5185\u6838\uff0c\u5efa\u8bae\u91cd\u542f\u673a\u5668\u91cd\u65b0\u52a0\u8f7d\u65b0\u7248\u5185\u6838\u6a21\u5757\u3002 Ubuntu \u4e0b\u7f16\u8bd1\u5b89\u88c5 \u5b89\u88c5\u76f8\u5173\u7f16\u8bd1\u4f9d\u8d56\u548c\u5185\u6838\u5934\u6587\u4ef6\uff1a apt install -y autoconf automake libtool gcc build-essential libssl-dev \u7f16\u8bd1 OVS \u5185\u6838\u6a21\u5757\u5e76\u5b89\u88c5\uff1a apt install -y autoconf automake libtool gcc build-essential libssl-dev git clone -b branch-2.17 --depth=1 https://github.com/openvswitch/ovs.git cd ovs curl -s https://github.com/kubeovn/ovs/commit/2d2c83c26d4217446918f39d5cd5838e9ac27b32.patch | git apply ./boot.sh ./configure --prefix=/usr/ --localstatedir=/var --enable-ssl --with-linux=/lib/modules/$(uname -r)/build make -j `nproc` make install make modules_install cat > /etc/depmod.d/openvswitch.conf << EOF override openvswitch * extra override vport-* * extra EOF depmod -a cp debian/openvswitch-switch.init /etc/init.d/openvswitch-switch /etc/init.d/openvswitch-switch force-reload-kmod \u82e5\u4e4b\u524d\u5df2\u7ecf\u542f\u52a8\u8fc7 Kube-OVN\uff0c\u65e7\u7248\u672c OVS \u6a21\u5757\u5df2\u52a0\u8f7d\u81f3\u5185\u6838\uff0c\u5efa\u8bae\u91cd\u542f\u673a\u5668\u91cd\u65b0\u52a0\u8f7d\u65b0\u7248\u5185\u6838\u6a21\u5757\u3002 \u4f7f\u7528 STT \u7c7b\u578b\u96a7\u9053 \u5e38\u89c1\u7684\u96a7\u9053\u5c01\u88c5\u534f\u8bae\u4f8b\u5982 Geneve \u548c Vxlan \u4f7f\u7528 UDP \u534f\u8bae\u5bf9\u6570\u636e\u5305\u8fdb\u884c\u5c01\u88c5\uff0c\u5728\u5185\u6838\u4e2d\u6709\u826f\u597d\u7684\u652f\u6301\u3002\u4f46\u662f\u5f53\u4f7f\u7528 UDP \u5c01\u88c5 TCP \u6570\u636e\u5305\u65f6\uff0c \u73b0\u4ee3\u64cd\u4f5c\u7cfb\u7edf\u548c\u7f51\u5361\u9488\u5bf9 TCP \u534f\u8bae\u7684\u4f18\u5316\u548c offload \u529f\u80fd\u5c06\u65e0\u6cd5\u987a\u5229\u5de5\u4f5c\uff0c\u5bfc\u81f4 TCP \u7684\u541e\u5410\u91cf\u51fa\u73b0\u663e\u8457\u4e0b\u964d\u3002\u5728\u865a\u62df\u5316\u573a\u666f\u4e0b\u7531\u4e8e CPU \u7684\u9650\u5236\uff0c TCP \u5927\u5305\u7684\u541e\u5410\u91cf\u751a\u81f3\u53ef\u80fd\u53ea\u6709\u5bbf\u4e3b\u673a\u7f51\u7edc\u7684\u5341\u5206\u4e4b\u4e00\u3002 STT \u63d0\u4f9b\u4e86\u4e00\u79cd\u521b\u65b0\u5f0f\u7684\u4f7f\u7528 TCP \u683c\u5f0f\u6570\u636e\u5305\u8fdb\u884c\u5c01\u88c5\u7684\u96a7\u9053\u534f\u8bae\uff0c\u8be5\u5c01\u88c5\u53ea\u662f\u6a21\u62df\u4e86 TCP \u534f\u8bae\u7684\u5934\u90e8\u683c\u5f0f\uff0c\u5e76\u6ca1\u6709\u771f\u6b63\u5efa\u7acb TCP \u8fde\u63a5\uff0c\u4f46\u662f\u53ef\u4ee5 \u5145\u5206\u5229\u7528\u73b0\u4ee3\u64cd\u4f5c\u7cfb\u7edf\u548c\u7f51\u5361\u7684 TCP \u4f18\u5316\u80fd\u529b\u3002\u5728\u6211\u4eec\u7684\u6d4b\u8bd5\u4e2d TCP \u5927\u5305\u7684\u541e\u5410\u91cf\u80fd\u6709\u6570\u500d\u7684\u63d0\u5347\uff0c\u8fbe\u5230\u63a5\u8fd1\u5bbf\u4e3b\u673a\u7f51\u7edc\u7684\u6027\u80fd\u6c34\u5e73\u3002 STT \u96a7\u9053\u5e76\u6ca1\u6709\u9884\u5b89\u88c5\u5728\u5185\u6838\u5185\uff0c\u9700\u8981\u901a\u8fc7\u7f16\u8bd1 OVS \u5185\u6838\u6a21\u5757\u6765\u5b89\u88c5\uff0cOVS \u5185\u6838\u6a21\u5757\u7684\u7f16\u8bd1\u65b9\u6cd5\u53ef\u4ee5\u53c2\u8003\u4e0a\u4e00\u8282\u3002 STT \u96a7\u9053\u5f00\u542f\uff1a kubectl set env daemonset/ovs-ovn -n kube-system TUNNEL_TYPE=stt kubectl delete pod -n kube-system -lapp=ovs","title":"\u6027\u80fd\u8c03\u4f18"},{"location":"advance/performance-tuning/#_1","text":"\u4e3a\u4e86\u4fdd\u6301\u5b89\u88c5\u7684\u7b80\u5355\u548c\u529f\u80fd\u7684\u5b8c\u5907\uff0cKube-OVN \u7684\u9ed8\u8ba4\u5b89\u88c5\u811a\u672c\u5e76\u6ca1\u6709\u5bf9\u6027\u80fd\u9488\u5bf9\u6027\u7684\u4f18\u5316\u3002\u5982\u679c\u5e94\u7528\u5bf9\u5ef6\u8fdf\u548c\u541e\u5410\u91cf\u654f\u611f\uff0c \u7ba1\u7406\u5458\u53ef\u4ee5\u901a\u8fc7\u672c\u6587\u6863\u5bf9\u6027\u80fd\u8fdb\u884c\u9488\u5bf9\u6027\u4f18\u5316\u3002 \u793e\u533a\u4f1a\u4e0d\u65ad\u8fed\u4ee3\u63a7\u5236\u9762\u677f\u548c\u4f18\u5316\u9762\u7684\u6027\u80fd\uff0c\u90e8\u5206\u901a\u7528\u6027\u80fd\u4f18\u5316\u5df2\u7ecf\u96c6\u6210\u5230\u6700\u65b0\u7248\u672c\uff0c\u5efa\u8bae\u4f7f\u7528\u6700\u65b0\u7248\u672c\u83b7\u5f97\u66f4\u597d\u7684\u9ed8\u8ba4\u6027\u80fd\u3002 \u66f4\u591a\u5173\u4e8e\u6027\u80fd\u4f18\u5316\u7684\u8fc7\u7a0b\u548c\u65b9\u6cd5\u8bba\uff0c\u53ef\u4ee5\u89c2\u770b\u89c6\u9891\u5206\u4eab\uff1a Kube-OVN \u5bb9\u5668\u6027\u80fd\u4f18\u5316\u4e4b\u65c5 \u3002","title":"\u6027\u80fd\u8c03\u4f18"},{"location":"advance/performance-tuning/#_2","text":"\u7531\u4e8e\u8f6f\u786c\u4ef6\u73af\u5883\u7684\u5dee\u5f02\u6781\u5927\uff0c\u8fd9\u91cc\u63d0\u4f9b\u7684\u6027\u80fd\u6d4b\u8bd5\u6570\u636e\u53ea\u80fd\u4f5c\u4e3a\u53c2\u8003\uff0c\u5b9e\u9645\u6d4b\u8bd5\u7ed3\u679c\u4f1a\u548c\u5c0f\u9762\u771f\u5b9e\u7684\u7ed3\u679c\u5b58\u5728\u8f83\u5927\u5dee\u5f02\u3002 \u5efa\u8bae\u6bd4\u8f83\u4f18\u5316\u524d\u540e\u7684\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\uff0c\u548c\u5bbf\u4e3b\u673a\u7f51\u7edc\u548c\u5bb9\u5668\u7f51\u7edc\u7684\u6027\u80fd\u6bd4\u8f83\u3002","title":"\u57fa\u51c6\u6d4b\u8bd5"},{"location":"advance/performance-tuning/#overlay","text":"\u73af\u5883\u4fe1\u606f\uff1a - Kubernetes: 1.22.0 - OS: CentOS 7 - Kube-OVN: 1.8.0 Overlay \u6a21\u5f0f - CPU: Intel(R) Xeon(R) E-2278G - Network: 2*10Gbps, xmit_hash_policy=layer3+4 \u6211\u4eec\u4f7f\u7528 qperf -t 60 <server ip> -ub -oo msg_size:1 -vu tcp_lat tcp_bw udp_lat udp_bw \u6d4b\u8bd5 1 \u5b57\u8282\u5c0f\u5305\u4e0b tcp/udp \u7684\u5e26\u5bbd\u548c\u5ef6\u8fdf\uff0c\u5206\u522b\u6d4b\u8bd5\u4f18\u5316\u524d\uff0c\u4f18\u5316\u540e\u4ee5\u53ca\u5bbf\u4e3b\u673a\u7f51\u7edc\u7684\u6027\u80fd\uff1a Type tcp_lat (us) udp_lat (us) tcp_bw (Mb/s) udp_bw(Mb/s) Kube-OVN Default 25.7 22.9 27.1 1.59 Kube-OVN Optimized 13.9 12.9 27.6 5.57 HOST Network 13.1 12.4 28.2 6.02","title":"Overlay \u4f18\u5316\u524d\u540e\u6027\u80fd\u5bf9\u6bd4"},{"location":"advance/performance-tuning/#overlay-underlay-calico","text":"\u4e0b\u9762\u6211\u4eec\u4f1a\u6bd4\u8f83\u4f18\u5316\u540e Kube-OVN \u5728\u4e0d\u540c\u5305\u5927\u5c0f\u4e0b\u7684 Overlay \u548c Underlay \u6027\u80fd\uff0c\u5e76\u548c Calico \u7684 IPIP Always IPIP never \u4ee5\u53ca\u5bbf\u4e3b\u673a\u7f51\u7edc\u505a\u6bd4\u8f83\u3002 Environment : - Kubernetes: 1.22.0 - OS: CentOS 7 - Kube-OVN: 1.8.0 - CPU: AMD EPYC 7402P 24-Core Processor - Network: Intel Corporation Ethernet Controller XXV710 for 25GbE SFP28 qperf -t 60 <server ip> -ub -oo msg_size:1 -vu tcp_lat tcp_bw udp_lat udp_bw Type tcp_lat (us) udp_lat (us) tcp_bw (Mb/s) udp_bw(Mb/s) Kube-OVN Overlay 15.2 14.6 23.6 2.65 Kube-OVN Underlay 14.3 13.8 24.2 3.46 Calico IPIP 21.4 20.2 23.6 1.18 Calico NoEncap 19.3 16.9 23.6 1.76 HOST Network 16.6 15.4 24.8 2.64 qperf -t 60 <server ip> -ub -oo msg_size:1K -vu tcp_lat tcp_bw udp_lat udp_bw Type tcp_lat (us) udp_lat (us) tcp_bw (Gb/s) udp_bw(Gb/s) Kube-OVN Overlay 16.5 15.8 10.2 2.77 Kube-OVN Underlay 15.9 14.5 9.6 3.22 Calico IPIP 22.5 21.5 1.45 1.14 Calico NoEncap 19.4 18.3 3.76 1.63 HOST Network 18.1 16.6 9.32 2.66 qperf -t 60 <server ip> -ub -oo msg_size:4K -vu tcp_lat tcp_bw udp_lat udp_bw Type tcp_lat (us) udp_lat (us) tcp_bw (Gb/s) udp_bw(Gb/s) Kube-OVN Overlay 34.7 41.6 16.0 9.23 Kube-OVN Underlay 32.6 44 15.1 6.71 Calico IPIP 44.8 52.9 2.94 3.26 Calico NoEncap 40 49.6 6.56 4.19 HOST Network 35.9 45.9 14.6 5.59 \u5728\u90e8\u5206\u60c5\u51b5\u4e0b\u5bb9\u5668\u7f51\u7edc\u7684\u6027\u80fd\u4f1a\u4f18\u4e8e\u5bbf\u4e3b\u673a\u7f51\u7edc\uff0c\u8fd9\u662f\u4f18\u4e8e\u7ecf\u8fc7\u4f18\u5316\u540e\u5bb9\u5668\u7f51\u7edc\u8def\u5f84\u5b8c\u5168\u7ed5\u8fc7\u4e86 netfilter\uff0c \u800c\u5bbf\u4e3b\u673a\u7f51\u7edc\u7531\u4e8e kube-proxy \u7684\u5b58\u5728\u6240\u6709\u6570\u636e\u5305\u5747\u9700\u7ecf\u8fc7 netfilter\uff0c\u4f1a\u5bfc\u81f4\u5728\u4e00\u4e9b\u73af\u5883\u4e0b\u5bb9\u5668\u7f51\u7edc \u7684\u6d88\u8017\u76f8\u5bf9\u66f4\u5c0f\uff0c\u56e0\u6b64\u4f1a\u6709\u66f4\u597d\u7684\u6027\u80fd\u8868\u73b0\u3002","title":"Overlay\uff0c Underlay \u4ee5\u53ca Calico \u4e0d\u540c\u6a21\u5f0f\u6027\u80fd\u5bf9\u6bd4"},{"location":"advance/performance-tuning/#_3","text":"\u8fd9\u91cc\u4ecb\u7ecd\u7684\u4f18\u5316\u65b9\u6cd5\u548c\u8f6f\u786c\u4ef6\u73af\u5883\u4ee5\u53ca\u6240\u9700\u8981\u7684\u529f\u80fd\u76f8\u5173\uff0c\u8bf7\u4ed4\u7ec6\u4e86\u89e3\u4f18\u5316\u7684\u524d\u63d0\u6761\u4ef6\u518d\u8fdb\u884c\u5c1d\u8bd5\u3002","title":"\u6570\u636e\u5e73\u9762\u6027\u80fd\u4f18\u5316\u65b9\u6cd5"},{"location":"advance/performance-tuning/#cpu","text":"\u90e8\u5206\u73af\u5883\u4e0b CPU \u8fd0\u884c\u5728\u8282\u80fd\u6a21\u5f0f\uff0c\u8be5\u6a21\u5f0f\u4e0b\u6027\u80fd\u8868\u73b0\u5c06\u4f1a\u4e0d\u7a33\u5b9a\uff0c\u5ef6\u8fdf\u4f1a\u51fa\u73b0\u660e\u663e\u589e\u52a0\uff0c\u5efa\u8bae\u4f7f\u7528 CPU \u7684\u6027\u80fd\u6a21\u5f0f\u83b7\u5f97\u66f4\u7a33\u5b9a\u7684\u6027\u80fd\u8868\u73b0\uff1a cpupower frequency-set -g performance","title":"CPU \u6027\u80fd\u6a21\u5f0f\u8c03\u6574"},{"location":"advance/performance-tuning/#_4","text":"\u5728\u6d41\u91cf\u589e\u5927\u7684\u60c5\u51b5\u4e0b\uff0c\u7f13\u51b2\u961f\u5217\u8fc7\u77ed\u53ef\u80fd\u5bfc\u81f4\u8f83\u9ad8\u7684\u4e22\u5305\u7387\u5bfc\u81f4\u6027\u80fd\u663e\u8457\u4e0b\u964d\uff0c\u9700\u8981\u8fdb\u884c\u8c03\u6574 \u68c0\u67e5\u5f53\u524d\u7f51\u5361\u961f\u5217\u957f\u5ea6\uff1a # ethtool -g eno1 Ring parameters for eno1: Pre-set maximums: RX: 4096 RX Mini: 0 RX Jumbo: 0 TX: 4096 Current hardware settings: RX: 255 RX Mini: 0 RX Jumbo: 0 TX: 255 \u589e\u52a0\u961f\u5217\u957f\u5ea6\u81f3\u6700\u5927\u503c\uff1a ethtool -G eno1 rx 4096 ethtool -G eno1 tx 4096","title":"\u7f51\u5361\u786c\u4ef6\u961f\u5217\u8c03\u6574"},{"location":"advance/performance-tuning/#tuned","text":"tuned \u53ef\u4ee5\u4f7f\u7528\u4e00\u7cfb\u5217\u9884\u7f6e\u7684 profile \u6587\u4ef6\u4fdd\u5b58\u4e86\u9488\u5bf9\u7279\u5b9a\u573a\u666f\u7684\u4e00\u7cfb\u5217\u7cfb\u7edf\u4f18\u5316\u914d\u7f6e\u3002 \u9488\u5bf9\u5ef6\u8fdf\u4f18\u5148\u573a\u666f\uff1a tuned-adm profile network-latency \u9488\u5bf9\u541e\u5410\u91cf\u4f18\u5148\u573a\u666f\uff1a tuned-adm profile network-throughput","title":"\u4f7f\u7528 tuned \u4f18\u5316\u7cfb\u7edf\u53c2\u6570"},{"location":"advance/performance-tuning/#_5","text":"\u6211\u4eec\u63a8\u8350\u7981\u7528 irqbalance \u5e76\u5c06\u7f51\u5361\u4e2d\u65ad\u548c\u7279\u5b9a CPU \u8fdb\u884c\u7ed1\u5b9a\uff0c\u6765\u907f\u514d\u5728\u591a\u4e2a CPU \u4e4b\u95f4\u5207\u6362\u5bfc\u81f4\u7684\u6027\u80fd\u6ce2\u52a8\u3002","title":"\u4e2d\u65ad\u7ed1\u5b9a"},{"location":"advance/performance-tuning/#ovn-lb","text":"OVN \u7684 L2 LB \u5b9e\u73b0\u8fc7\u7a0b\u4e2d\u9700\u8981\u8c03\u7528\u5185\u6838\u7684 conntrack \u6a21\u5757\u5e76\u8fdb\u884c recirculate \u5bfc\u81f4\u5927\u91cf\u7684 CPU \u5f00\u9500\uff0c\u7ecf\u6d4b\u8bd5\u8be5\u529f\u80fd\u4f1a\u5e26\u6765 20% \u5de6\u53f3\u7684 CPU \u5f00\u9500\uff0c Overlay \u5982\u679c\u4f7f\u7528 kube-proxy \u6216 Cilium \u5b8c\u6210 Service \u8f6c\u53d1\u529f\u80fd\uff0c\u53ef\u4ee5\u5728 kube-ovn-controller \u4e2d\u5173\u95ed\u8be5\u529f\u80fd\uff0c\u83b7\u5f97\u66f4\u597d\u7684 Pod-to-Pod \u6027\u80fd\uff1a command: - /kube-ovn/start-controller.sh args: ... - --enable-lb=false ... Underlay \u6a21\u5f0f\u4e0b kube-proxy \u65e0\u6cd5\u4f7f\u7528 iptables \u6216 ipvs \u63a7\u5236\u5bb9\u5668\u7f51\u7edc\u6d41\u91cf\uff0c\u5982\u9700\u5173\u95ed LB \u529f\u80fd\u9700\u8981\u786e\u8ba4\u662f\u5426\u4e0d\u9700\u8981 Service \u529f\u80fd\uff0c\u6216\u53ef\u4f7f\u7528 \u5176\u4ed6 Service \u5b9e\u73b0\uff08\u4f8b\u5982 Cilium\uff09\u66ff\u4ee3\u3002","title":"\u5173\u95ed OVN LB"},{"location":"advance/performance-tuning/#fastpath","text":"\u7531\u4e8e\u5bb9\u5668\u7f51\u7edc\u548c\u5bbf\u4e3b\u673a\u7f51\u7edc\u5728\u4e0d\u540c\u7684 network ns\uff0c\u6570\u636e\u5305\u5728\u8de8\u5bbf\u4e3b\u673a\u4f20\u8f93\u65f6\u4f1a\u591a\u6b21\u7ecf\u8fc7 netfilter \u6a21\u5757\uff0c\u4f1a\u5e26\u6765\u8fd1 20% \u7684 CPU \u5f00\u9500\u3002\u7531\u4e8e\u5927\u90e8\u5206\u60c5\u51b5\u4e0b \u5bb9\u5668\u7f51\u7edc\u5185\u5e94\u7528\u65e0\u987b\u4f7f\u7528 netfilter \u6a21\u5757\u7684\u529f\u80fd\uff0c FastPath \u6a21\u5757\u53ef\u4ee5\u7ed5\u8fc7 netfilter \u964d\u4f4e CPU \u5f00\u9500\u3002 \u5982\u5bb9\u5668\u7f51\u7edc\u5185\u9700\u8981\u4f7f\u7528 netfilter \u63d0\u4f9b\u7684\u529f\u80fd\u5982 iptables\uff0cipvs\uff0cnftables \u7b49\uff0c\u8be5\u6a21\u5757\u4f1a\u4f7f\u76f8\u5173\u529f\u80fd\u5931\u6548\u3002 \u7531\u4e8e\u5185\u6838\u6a21\u5757\u548c\u5185\u6838\u7248\u672c\u76f8\u5173\uff0c\u65e0\u6cd5\u63d0\u4f9b\u4e00\u4e2a\u5355\u4e00\u9002\u5e94\u6240\u6709\u5185\u6838\u7684\u5185\u6838\u6a21\u5757\u5236\u54c1\u3002\u6211\u4eec\u9884\u5148\u7f16\u8bd1\u4e86\u90e8\u5206\u5185\u6838\u7684 FastPath \u6a21\u5757\uff0c \u53ef\u4ee5\u524d\u5f80 tunning-package \u8fdb\u884c\u4e0b\u8f7d\u3002 \u4e5f\u53ef\u4ee5\u624b\u52a8\u8fdb\u884c\u7f16\u8bd1\uff0c\u65b9\u6cd5\u53c2\u8003 \u624b\u52a8\u7f16\u8bd1 FastPath \u6a21\u5757 \u83b7\u5f97\u5185\u6838\u6a21\u5757\u540e\u53ef\u5728\u6bcf\u4e2a\u8282\u70b9\u4f7f\u7528 insmod kube_ovn_fastpath.ko \u52a0\u8f7d FastPath \u6a21\u5757\uff0c\u5e76\u4f7f\u7528 dmesg \u9a8c\u8bc1\u6a21\u5757\u52a0\u8f7d\u6210\u529f\uff1a # dmesg ... [619631.323788] init_module,kube_ovn_fastpath_local_out [619631.323798] init_module,kube_ovn_fastpath_post_routing [619631.323800] init_module,kube_ovn_fastpath_pre_routing [619631.323801] init_module,kube_ovn_fastpath_local_in ...","title":"\u5185\u6838 FastPath \u6a21\u5757"},{"location":"advance/performance-tuning/#ovs","text":"OVS \u7684 flow \u5904\u7406\u5305\u62ec\u54c8\u5e0c\u8ba1\u7b97\uff0c\u5339\u914d\u7b49\u64cd\u4f5c\u4f1a\u6d88\u8017\u5927\u7ea6 10% \u5de6\u53f3\u7684 CPU \u8d44\u6e90\u3002\u73b0\u4ee3 x86 CPU \u4e0a\u7684\u4e00\u4e9b\u6307\u4ee4\u96c6\u4f8b\u5982 popcnt \u548c sse4.2 \u53ef\u4ee5 \u52a0\u901f\u76f8\u5173\u8ba1\u7b97\u8fc7\u7a0b\uff0c\u5355\u9ed8\u8ba4\u7f16\u8bd1\u672a\u5f00\u542f\u76f8\u5173\u9009\u9879\u3002\u7ecf\u6d4b\u8bd5\u5728\u5f00\u542f\u76f8\u5e94\u6307\u4ee4\u96c6\u4f18\u5316\u540e\uff0cflow \u76f8\u5173\u64cd\u4f5c CPU \u6d88\u8017\u5c06\u4f1a\u964d\u81f3 5% \u5de6\u53f3\u3002 \u548c FastPath \u6a21\u5757\u7684\u7f16\u8bd1\u7c7b\u4f3c\uff0c\u7531\u4e8e\u5185\u6838\u6a21\u5757\u548c\u5185\u6838\u7248\u672c\u76f8\u5173\uff0c\u65e0\u6cd5\u63d0\u4f9b\u4e00\u4e2a\u5355\u4e00\u9002\u5e94\u6240\u6709\u5185\u6838\u7684\u5185\u6838\u6a21\u5757\u5236\u54c1\u3002\u7528\u6237\u9700\u8981\u624b\u52a8\u7f16\u8bd1\u6216\u8005 \u524d\u5f80 tunning-package \u67e5\u770b\u662f\u5426\u6709\u4ee5\u7f16\u8bd1\u597d\u7684\u5236\u54c1\u8fdb\u884c\u4e0b\u8f7d\u3002 \u4f7f\u7528\u8be5\u5185\u6838\u6a21\u5757\u524d\u8bf7\u5148\u786e\u8ba4 CPU \u662f\u5426\u652f\u6301\u76f8\u5173\u6307\u4ee4\u96c6\uff1a cat /proc/cpuinfo | grep popcnt cat /proc/cpuinfo | grep sse4_2","title":"OVS \u5185\u6838\u6a21\u5757\u4f18\u5316"},{"location":"advance/performance-tuning/#centos","text":"\u5b89\u88c5\u76f8\u5173\u7f16\u8bd1\u4f9d\u8d56\u548c\u5185\u6838\u5934\u6587\u4ef6\uff1a yum install -y gcc kernel-devel-$(uname -r) python3 autoconf automake libtool rpm-build openssl-devel \u7f16\u8bd1 OVS \u5185\u6838\u6a21\u5757\u5e76\u751f\u6210\u5bf9\u5e94 RPM \u6587\u4ef6: git clone -b branch-2.17 --depth=1 https://github.com/openvswitch/ovs.git cd ovs curl -s https://github.com/kubeovn/ovs/commit/2d2c83c26d4217446918f39d5cd5838e9ac27b32.patch | git apply ./boot.sh ./configure --with-linux=/lib/modules/$(uname -r)/build CFLAGS=\"-g -O2 -mpopcnt -msse4.2\" make rpm-fedora-kmod cd rpm/rpmbuild/RPMS/x86_64/ \u590d\u5236 RPM \u5230\u6bcf\u4e2a\u8282\u70b9\u5e76\u8fdb\u884c\u5b89\u88c5\uff1a rpm -i openvswitch-kmod-2.15.2-1.el7.x86_64.rpm \u82e5\u4e4b\u524d\u5df2\u7ecf\u542f\u52a8\u8fc7 Kube-OVN\uff0c\u65e7\u7248\u672c OVS \u6a21\u5757\u5df2\u52a0\u8f7d\u81f3\u5185\u6838\uff0c\u5efa\u8bae\u91cd\u542f\u673a\u5668\u91cd\u65b0\u52a0\u8f7d\u65b0\u7248\u5185\u6838\u6a21\u5757\u3002","title":"CentOS \u4e0b\u7f16\u8bd1\u5b89\u88c5"},{"location":"advance/performance-tuning/#ubuntu","text":"\u5b89\u88c5\u76f8\u5173\u7f16\u8bd1\u4f9d\u8d56\u548c\u5185\u6838\u5934\u6587\u4ef6\uff1a apt install -y autoconf automake libtool gcc build-essential libssl-dev \u7f16\u8bd1 OVS \u5185\u6838\u6a21\u5757\u5e76\u5b89\u88c5\uff1a apt install -y autoconf automake libtool gcc build-essential libssl-dev git clone -b branch-2.17 --depth=1 https://github.com/openvswitch/ovs.git cd ovs curl -s https://github.com/kubeovn/ovs/commit/2d2c83c26d4217446918f39d5cd5838e9ac27b32.patch | git apply ./boot.sh ./configure --prefix=/usr/ --localstatedir=/var --enable-ssl --with-linux=/lib/modules/$(uname -r)/build make -j `nproc` make install make modules_install cat > /etc/depmod.d/openvswitch.conf << EOF override openvswitch * extra override vport-* * extra EOF depmod -a cp debian/openvswitch-switch.init /etc/init.d/openvswitch-switch /etc/init.d/openvswitch-switch force-reload-kmod \u82e5\u4e4b\u524d\u5df2\u7ecf\u542f\u52a8\u8fc7 Kube-OVN\uff0c\u65e7\u7248\u672c OVS \u6a21\u5757\u5df2\u52a0\u8f7d\u81f3\u5185\u6838\uff0c\u5efa\u8bae\u91cd\u542f\u673a\u5668\u91cd\u65b0\u52a0\u8f7d\u65b0\u7248\u5185\u6838\u6a21\u5757\u3002","title":"Ubuntu \u4e0b\u7f16\u8bd1\u5b89\u88c5"},{"location":"advance/performance-tuning/#stt","text":"\u5e38\u89c1\u7684\u96a7\u9053\u5c01\u88c5\u534f\u8bae\u4f8b\u5982 Geneve \u548c Vxlan \u4f7f\u7528 UDP \u534f\u8bae\u5bf9\u6570\u636e\u5305\u8fdb\u884c\u5c01\u88c5\uff0c\u5728\u5185\u6838\u4e2d\u6709\u826f\u597d\u7684\u652f\u6301\u3002\u4f46\u662f\u5f53\u4f7f\u7528 UDP \u5c01\u88c5 TCP \u6570\u636e\u5305\u65f6\uff0c \u73b0\u4ee3\u64cd\u4f5c\u7cfb\u7edf\u548c\u7f51\u5361\u9488\u5bf9 TCP \u534f\u8bae\u7684\u4f18\u5316\u548c offload \u529f\u80fd\u5c06\u65e0\u6cd5\u987a\u5229\u5de5\u4f5c\uff0c\u5bfc\u81f4 TCP \u7684\u541e\u5410\u91cf\u51fa\u73b0\u663e\u8457\u4e0b\u964d\u3002\u5728\u865a\u62df\u5316\u573a\u666f\u4e0b\u7531\u4e8e CPU \u7684\u9650\u5236\uff0c TCP \u5927\u5305\u7684\u541e\u5410\u91cf\u751a\u81f3\u53ef\u80fd\u53ea\u6709\u5bbf\u4e3b\u673a\u7f51\u7edc\u7684\u5341\u5206\u4e4b\u4e00\u3002 STT \u63d0\u4f9b\u4e86\u4e00\u79cd\u521b\u65b0\u5f0f\u7684\u4f7f\u7528 TCP \u683c\u5f0f\u6570\u636e\u5305\u8fdb\u884c\u5c01\u88c5\u7684\u96a7\u9053\u534f\u8bae\uff0c\u8be5\u5c01\u88c5\u53ea\u662f\u6a21\u62df\u4e86 TCP \u534f\u8bae\u7684\u5934\u90e8\u683c\u5f0f\uff0c\u5e76\u6ca1\u6709\u771f\u6b63\u5efa\u7acb TCP \u8fde\u63a5\uff0c\u4f46\u662f\u53ef\u4ee5 \u5145\u5206\u5229\u7528\u73b0\u4ee3\u64cd\u4f5c\u7cfb\u7edf\u548c\u7f51\u5361\u7684 TCP \u4f18\u5316\u80fd\u529b\u3002\u5728\u6211\u4eec\u7684\u6d4b\u8bd5\u4e2d TCP \u5927\u5305\u7684\u541e\u5410\u91cf\u80fd\u6709\u6570\u500d\u7684\u63d0\u5347\uff0c\u8fbe\u5230\u63a5\u8fd1\u5bbf\u4e3b\u673a\u7f51\u7edc\u7684\u6027\u80fd\u6c34\u5e73\u3002 STT \u96a7\u9053\u5e76\u6ca1\u6709\u9884\u5b89\u88c5\u5728\u5185\u6838\u5185\uff0c\u9700\u8981\u901a\u8fc7\u7f16\u8bd1 OVS \u5185\u6838\u6a21\u5757\u6765\u5b89\u88c5\uff0cOVS \u5185\u6838\u6a21\u5757\u7684\u7f16\u8bd1\u65b9\u6cd5\u53ef\u4ee5\u53c2\u8003\u4e0a\u4e00\u8282\u3002 STT \u96a7\u9053\u5f00\u542f\uff1a kubectl set env daemonset/ovs-ovn -n kube-system TUNNEL_TYPE=stt kubectl delete pod -n kube-system -lapp=ovs","title":"\u4f7f\u7528 STT \u7c7b\u578b\u96a7\u9053"},{"location":"advance/vip/","text":"VIP \u9884\u7559\u8bbe\u7f6e \u5728\u4e00\u4e9b\u573a\u666f\u4e0b\u6211\u4eec\u5e0c\u671b\u52a8\u6001\u7684\u9884\u7559\u4e00\u90e8\u5206 IP \u4f46\u662f\u5e76\u4e0d\u5206\u914d\u7ed9 Pod \u800c\u662f\u5206\u914d\u7ed9\u5176\u4ed6\u7684\u57fa\u7840\u8bbe\u65bd\u542f\u7528\uff0c\u4f8b\u5982\uff1a Kubernetes \u5d4c\u5957 Kubernetes \u7684\u573a\u666f\u4e2d\u4e0a\u5c42 Kubernetes \u4f7f\u7528 Underlay \u7f51\u7edc\u4f1a\u5360\u7528\u5e95\u5c42 Subnet \u53ef\u7528\u5730\u5740\u3002 LB \u6216\u5176\u4ed6\u7f51\u7edc\u57fa\u7840\u8bbe\u65bd\u9700\u8981\u4f7f\u7528\u4e00\u4e2a Subnet \u5185\u7684 IP\uff0c\u4f46\u4e0d\u4f1a\u5355\u72ec\u8d77 Pod\u3002 \u521b\u5efa\u968f\u673a\u5730\u5740 VIP \u5982\u679c\u53ea\u662f\u4e3a\u4e86\u9884\u7559\u82e5\u5e72 IP \u800c\u5bf9 IP \u5730\u5740\u672c\u8eab\u6ca1\u6709\u8981\u6c42\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684 yaml \u8fdb\u884c\u521b\u5efa\uff1a apiVersion: kubeovn.io/v1 kind: Vip metadata: name: vip-dynamic-01 spec: subnet: ovn-default subnet : \u5c06\u4ece\u8be5 Subnet \u4e2d\u9884\u7559 IP\u3002 \u521b\u5efa\u6210\u529f\u540e\u67e5\u8be2\u8be5 VIP\uff1a # kubectl get vip NAME V4IP PV4IP MAC PMAC V6IP PV6IP SUBNET READY vip-dynamic-01 10.16.0.12 00:00:00:F0:DB:25 ovn-default true \u53ef\u89c1\u8be5 VIP \u88ab\u5206\u914d\u4e86 10.16.0.12 \u7684 IP \u5730\u5740\uff0c\u8be5\u5730\u5740\u53ef\u4ee5\u4e4b\u540e\u4f9b\u5176\u4ed6\u7f51\u7edc\u57fa\u7840\u8bbe\u65bd\u4f7f\u7528\u3002 \u521b\u5efa\u56fa\u5b9a\u5730\u5740 VIP \u5982\u5bf9\u9884\u7559\u7684 VIP \u7684 IP \u5730\u5740\u6709\u9700\u6c42\u53ef\u4f7f\u7528\u4e0b\u9762\u7684 yaml \u8fdb\u884c\u56fa\u5b9a\u5206\u914d\uff1a apiVersion: kubeovn.io/v1 kind: Vip metadata: name: static-vip01 spec: subnet: ovn-default v4Ip: \"10.16.0.121\" subnet : \u5c06\u4ece\u8be5 Subnet \u4e2d\u9884\u7559 IP\u3002 v4Ip : \u56fa\u5b9a\u5206\u914d\u7684 IP \u5730\u5740\uff0c\u8be5\u5730\u5740\u9700\u5728 subnet \u7684 CIDR \u8303\u56f4\u5185\u3002 \u521b\u5efa\u6210\u529f\u540e\u67e5\u8be2\u8be5 VIP\uff1a # kubectl get vip NAME V4IP PV4IP MAC PMAC V6IP PV6IP SUBNET READY static-vip01 10.16.0.121 00:00:00:F0:DB:26 ovn-default true \u53ef\u89c1\u8be5 VIP \u88ab\u5206\u914d\u4e86\u6240\u9884\u671f\u7684 IP \u5730\u5740\u3002","title":"VIP \u9884\u7559\u8bbe\u7f6e"},{"location":"advance/vip/#vip","text":"\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\u6211\u4eec\u5e0c\u671b\u52a8\u6001\u7684\u9884\u7559\u4e00\u90e8\u5206 IP \u4f46\u662f\u5e76\u4e0d\u5206\u914d\u7ed9 Pod \u800c\u662f\u5206\u914d\u7ed9\u5176\u4ed6\u7684\u57fa\u7840\u8bbe\u65bd\u542f\u7528\uff0c\u4f8b\u5982\uff1a Kubernetes \u5d4c\u5957 Kubernetes \u7684\u573a\u666f\u4e2d\u4e0a\u5c42 Kubernetes \u4f7f\u7528 Underlay \u7f51\u7edc\u4f1a\u5360\u7528\u5e95\u5c42 Subnet \u53ef\u7528\u5730\u5740\u3002 LB \u6216\u5176\u4ed6\u7f51\u7edc\u57fa\u7840\u8bbe\u65bd\u9700\u8981\u4f7f\u7528\u4e00\u4e2a Subnet \u5185\u7684 IP\uff0c\u4f46\u4e0d\u4f1a\u5355\u72ec\u8d77 Pod\u3002","title":"VIP \u9884\u7559\u8bbe\u7f6e"},{"location":"advance/vip/#vip_1","text":"\u5982\u679c\u53ea\u662f\u4e3a\u4e86\u9884\u7559\u82e5\u5e72 IP \u800c\u5bf9 IP \u5730\u5740\u672c\u8eab\u6ca1\u6709\u8981\u6c42\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684 yaml \u8fdb\u884c\u521b\u5efa\uff1a apiVersion: kubeovn.io/v1 kind: Vip metadata: name: vip-dynamic-01 spec: subnet: ovn-default subnet : \u5c06\u4ece\u8be5 Subnet \u4e2d\u9884\u7559 IP\u3002 \u521b\u5efa\u6210\u529f\u540e\u67e5\u8be2\u8be5 VIP\uff1a # kubectl get vip NAME V4IP PV4IP MAC PMAC V6IP PV6IP SUBNET READY vip-dynamic-01 10.16.0.12 00:00:00:F0:DB:25 ovn-default true \u53ef\u89c1\u8be5 VIP \u88ab\u5206\u914d\u4e86 10.16.0.12 \u7684 IP \u5730\u5740\uff0c\u8be5\u5730\u5740\u53ef\u4ee5\u4e4b\u540e\u4f9b\u5176\u4ed6\u7f51\u7edc\u57fa\u7840\u8bbe\u65bd\u4f7f\u7528\u3002","title":"\u521b\u5efa\u968f\u673a\u5730\u5740 VIP"},{"location":"advance/vip/#vip_2","text":"\u5982\u5bf9\u9884\u7559\u7684 VIP \u7684 IP \u5730\u5740\u6709\u9700\u6c42\u53ef\u4f7f\u7528\u4e0b\u9762\u7684 yaml \u8fdb\u884c\u56fa\u5b9a\u5206\u914d\uff1a apiVersion: kubeovn.io/v1 kind: Vip metadata: name: static-vip01 spec: subnet: ovn-default v4Ip: \"10.16.0.121\" subnet : \u5c06\u4ece\u8be5 Subnet \u4e2d\u9884\u7559 IP\u3002 v4Ip : \u56fa\u5b9a\u5206\u914d\u7684 IP \u5730\u5740\uff0c\u8be5\u5730\u5740\u9700\u5728 subnet \u7684 CIDR \u8303\u56f4\u5185\u3002 \u521b\u5efa\u6210\u529f\u540e\u67e5\u8be2\u8be5 VIP\uff1a # kubectl get vip NAME V4IP PV4IP MAC PMAC V6IP PV6IP SUBNET READY static-vip01 10.16.0.121 00:00:00:F0:DB:26 ovn-default true \u53ef\u89c1\u8be5 VIP \u88ab\u5206\u914d\u4e86\u6240\u9884\u671f\u7684 IP \u5730\u5740\u3002","title":"\u521b\u5efa\u56fa\u5b9a\u5730\u5740 VIP"},{"location":"advance/vpc-peering/","text":"VPC \u4e92\u8054 VPC \u4e92\u8054\u63d0\u4f9b\u4e86\u4e00\u79cd\u5c06\u4e24\u4e2a VPC \u7f51\u7edc\u901a\u8fc7\u903b\u8f91\u8def\u7531\u6253\u901a\u7684\u673a\u5236\uff0c\u4ece\u800c\u4f7f\u4e24\u4e2a VPC \u5185\u7684\u5de5\u4f5c\u8d1f\u8f7d\u53ef\u4ee5\u50cf\u5728\u540c\u4e00\u4e2a\u79c1\u6709\u7f51\u7edc\u4e00\u6837\uff0c \u901a\u8fc7\u79c1\u6709\u5730\u5740\u76f8\u4e92\u8bbf\u95ee\uff0c\u65e0\u9700\u901a\u8fc7\u5916\u90e8\u7f51\u5173\u8fdb\u884c NAT \u8f6c\u53d1\u3002 \u524d\u63d0\u6761\u4ef6 \u8be5\u529f\u80fd\u53ea\u9002\u7528\u4e8e\u7528\u6237\u81ea\u5b9a\u4e49 VPC\u3002 \u4e3a\u4e86\u907f\u514d\u8def\u7531\u91cd\u53e0\u4e24\u4e2a VPC \u5185\u7684\u5b50\u7f51 CIDR \u4e0d\u80fd\u91cd\u53e0\u3002 \u76ee\u524d\u53ea\u652f\u6301\u4e24\u4e2a VPC \u7684\u4e92\u8054\uff0c\u66f4\u591a\u7ec4 VPC \u4e4b\u95f4\u7684\u4e92\u8054\u6682\u4e0d\u652f\u6301\u3002 \u4f7f\u7528\u65b9\u5f0f \u9996\u5148\u521b\u5efa\u4e24\u4e2a\u4e0d\u4e92\u8054\u7684 VPC\uff0c\u6bcf\u4e2a VPC \u4e0b\u5404\u6709\u4e00\u4e2a Subnet\uff0cSubnet \u7684 CIDR \u4e92\u4e0d\u91cd\u53e0\u3002 kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: vpc-1 spec: {} --- kind: Subnet apiVersion: kubeovn.io/v1 metadata: name: net1 spec: vpc: vpc-1 cidrBlock: 10.0.0.0/16 --- kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: vpc-2 spec: {} --- kind: Subnet apiVersion: kubeovn.io/v1 metadata: name: net2 spec: vpc: vpc-2 cidrBlock: 172.31.0.0/16 \u5728\u6bcf\u4e2a VPC \u5185\u5206\u522b\u589e\u52a0 vpcPeerings \u548c\u5bf9\u5e94\u7684\u9759\u6001\u8def\u7531\uff1a kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: vpc-1 spec: vpcPeerings: - remoteVpc: vpc-2 localConnectIP: 169.254.0.1/30 staticRoutes: - cidr: 172.31.0.0/16 nextHopIP: 169.254.0.2 policy: policyDst --- kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: vpc-1 spec: vpcPeerings: - remoteVpc: vpc-2 localConnectIP: 169.254.0.2/30 staticRoutes: - cidr: 10.0.0.0/16 nextHopIP: 169.254.0.1 policy: policyDst remoteVpc : \u4e92\u8054\u7684\u53e6\u4e00\u4e2a VPC \u7684\u540d\u5b57\u3002 localConnectIP : \u4f5c\u4e3a\u4e92\u8054\u7aef\u70b9\u7684 IP \u5730\u5740\u548c CIDR\uff0c\u6ce8\u610f\u4e24\u7aef IP \u5e94\u5c5e\u4e8e\u540c\u4e00 CIDR\uff0c\u4e14\u4e0d\u80fd\u548c\u5df2\u6709\u5b50\u7f51\u51b2\u7a81\u3002 cidr \uff1a\u53e6\u4e00\u7aef Subnet \u7684 CIDR\u3002 nextHopIP \uff1a\u4e92\u8054 VPC \u53e6\u4e00\u7aef\u7684 localConnectIP \u3002","title":"VPC \u4e92\u8054"},{"location":"advance/vpc-peering/#vpc","text":"VPC \u4e92\u8054\u63d0\u4f9b\u4e86\u4e00\u79cd\u5c06\u4e24\u4e2a VPC \u7f51\u7edc\u901a\u8fc7\u903b\u8f91\u8def\u7531\u6253\u901a\u7684\u673a\u5236\uff0c\u4ece\u800c\u4f7f\u4e24\u4e2a VPC \u5185\u7684\u5de5\u4f5c\u8d1f\u8f7d\u53ef\u4ee5\u50cf\u5728\u540c\u4e00\u4e2a\u79c1\u6709\u7f51\u7edc\u4e00\u6837\uff0c \u901a\u8fc7\u79c1\u6709\u5730\u5740\u76f8\u4e92\u8bbf\u95ee\uff0c\u65e0\u9700\u901a\u8fc7\u5916\u90e8\u7f51\u5173\u8fdb\u884c NAT \u8f6c\u53d1\u3002","title":"VPC \u4e92\u8054"},{"location":"advance/vpc-peering/#_1","text":"\u8be5\u529f\u80fd\u53ea\u9002\u7528\u4e8e\u7528\u6237\u81ea\u5b9a\u4e49 VPC\u3002 \u4e3a\u4e86\u907f\u514d\u8def\u7531\u91cd\u53e0\u4e24\u4e2a VPC \u5185\u7684\u5b50\u7f51 CIDR \u4e0d\u80fd\u91cd\u53e0\u3002 \u76ee\u524d\u53ea\u652f\u6301\u4e24\u4e2a VPC \u7684\u4e92\u8054\uff0c\u66f4\u591a\u7ec4 VPC \u4e4b\u95f4\u7684\u4e92\u8054\u6682\u4e0d\u652f\u6301\u3002","title":"\u524d\u63d0\u6761\u4ef6"},{"location":"advance/vpc-peering/#_2","text":"\u9996\u5148\u521b\u5efa\u4e24\u4e2a\u4e0d\u4e92\u8054\u7684 VPC\uff0c\u6bcf\u4e2a VPC \u4e0b\u5404\u6709\u4e00\u4e2a Subnet\uff0cSubnet \u7684 CIDR \u4e92\u4e0d\u91cd\u53e0\u3002 kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: vpc-1 spec: {} --- kind: Subnet apiVersion: kubeovn.io/v1 metadata: name: net1 spec: vpc: vpc-1 cidrBlock: 10.0.0.0/16 --- kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: vpc-2 spec: {} --- kind: Subnet apiVersion: kubeovn.io/v1 metadata: name: net2 spec: vpc: vpc-2 cidrBlock: 172.31.0.0/16 \u5728\u6bcf\u4e2a VPC \u5185\u5206\u522b\u589e\u52a0 vpcPeerings \u548c\u5bf9\u5e94\u7684\u9759\u6001\u8def\u7531\uff1a kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: vpc-1 spec: vpcPeerings: - remoteVpc: vpc-2 localConnectIP: 169.254.0.1/30 staticRoutes: - cidr: 172.31.0.0/16 nextHopIP: 169.254.0.2 policy: policyDst --- kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: vpc-1 spec: vpcPeerings: - remoteVpc: vpc-2 localConnectIP: 169.254.0.2/30 staticRoutes: - cidr: 10.0.0.0/16 nextHopIP: 169.254.0.1 policy: policyDst remoteVpc : \u4e92\u8054\u7684\u53e6\u4e00\u4e2a VPC \u7684\u540d\u5b57\u3002 localConnectIP : \u4f5c\u4e3a\u4e92\u8054\u7aef\u70b9\u7684 IP \u5730\u5740\u548c CIDR\uff0c\u6ce8\u610f\u4e24\u7aef IP \u5e94\u5c5e\u4e8e\u540c\u4e00 CIDR\uff0c\u4e14\u4e0d\u80fd\u548c\u5df2\u6709\u5b50\u7f51\u51b2\u7a81\u3002 cidr \uff1a\u53e6\u4e00\u7aef Subnet \u7684 CIDR\u3002 nextHopIP \uff1a\u4e92\u8054 VPC \u53e6\u4e00\u7aef\u7684 localConnectIP \u3002","title":"\u4f7f\u7528\u65b9\u5f0f"},{"location":"advance/windows/","text":"Windows \u652f\u6301 Kube-OVN \u652f\u6301\u5305\u542b Windows \u7cfb\u7edf\u8282\u70b9\u7684 Kubernetes \u96c6\u7fa4\u7f51\u7edc\uff0c\u53ef\u4ee5\u5c06 Windows \u5bb9\u5668\u7684\u7f51\u7edc\u7edf\u4e00\u63a5\u5165\u8fdb\u884c\u7ba1\u7406\u3002 \u524d\u63d0\u6761\u4ef6 \u53c2\u8003 Adding Windows nodes \u589e\u52a0 Windows \u8282\u70b9\u3002 Windows \u8282\u70b9\u5fc5\u987b\u5b89\u88c5 KB4489899 \u8865\u4e01\u4ee5\u4f7f Overlay/VXLAN \u7f51\u7edc\u6b63\u5e38\u5de5\u4f5c\uff0c\u5efa\u8bae\u66f4\u65b0\u7cfb\u7edf\u81f3\u6700\u65b0\u7248\u672c\u3002 Windows \u8282\u70b9\u5fc5\u987b\u5b89\u88c5 Hyper-V \u53ca\u7ba1\u7406\u5de5\u5177\u3002 \u7531\u4e8e Windows \u9650\u5236\u96a7\u9053\u5c01\u88c5\u53ea\u80fd\u4f7f\u7528 Vxlan \u6a21\u5f0f\u3002 \u6682\u4e0d\u652f\u6301 SSL\uff0cIPv6\uff0c\u53cc\u6808\uff0cQoS \u529f\u80fd\u3002 \u6682\u4e0d\u652f\u6301\u52a8\u6001\u5b50\u7f51\uff0c\u52a8\u6001\u96a7\u9053\u63a5\u53e3\u529f\u80fd\uff0c\u9700\u5728\u5b89\u88c5 Windows \u8282\u70b9\u524d\u5b8c\u6210\u5b50\u7f51\u521b\u5efa\uff0c\u5e76\u56fa\u5b9a\u7f51\u7edc\u63a5\u53e3\u3002 \u4e0d\u652f\u6301\u591a\u4e2a ProviderNetwork \uff0c\u4e14\u65e0\u6cd5\u52a8\u6001\u8c03\u6574\u6865\u63a5\u63a5\u53e3\u914d\u7f6e\u3002 \u5b89\u88c5 OVS \u7531\u4e8e\u4e0a\u6e38 OVN \u548c OVS \u5bf9 Windows \u5bb9\u5668\u652f\u6301\u5b58\u5728\u4e00\u4e9b\u95ee\u9898\uff0c\u9700\u8981\u4f7f\u7528 Kube-OVN \u63d0\u4f9b\u7684\u7ecf\u8fc7\u4fee\u6539\u7684\u5b89\u88c5\u5305\u8fdb\u884c\u5b89\u88c5\u3002 \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6253\u5f00 Windows \u8282\u70b9\u7684 TESTSIGNING \u542f\u52a8\u9879\uff0c\u6267\u884c\u6210\u529f\u540e\u9700\u8981\u91cd\u542f\u7cfb\u7edf\u751f\u6548\uff1a bcdedit /set LOADOPTIONS DISABLE_INTEGRITY_CHECKS bcdedit /set TESTSIGNING ON bcdedit /set nointegritychecks ON \u5728 Windows \u8282\u70b9\u4e0b\u8f7d Windows \u5b89\u88c5\u5305 \u5e76\u89e3\u538b\u5b89\u88c5\u3002 \u5b89\u88c5\u5b8c\u6210\u540e\u786e\u8ba4\u670d\u52a1\u6b63\u5e38\u8fd0\u884c\uff1a PS > Get-Service | findstr ovs Running ovsdb-server Open vSwitch DB Service Running ovs-vswitchd Open vSwitch Service \u5b89\u88c5 Kube-OVN \u5728 Windows \u8282\u70b9\u4e0b\u8f7d\u5b89\u88c5\u811a\u672c install.ps1 \u3002 \u8865\u5145\u76f8\u5173\u53c2\u6570\u5e76\u6267\u884c\uff1a .\\install.ps1 -KubeConfig C:\\k\\admin.conf -ApiServer https://192.168.140.180:6443 -ServiceCIDR 10.96.0.0/12 \u9ed8\u8ba4\u60c5\u51b5\u4e0b, Kube-OVN \u4f7f\u7528\u8282\u70b9 IP \u6240\u5728\u7684\u7f51\u5361\u4f5c\u4e3a\u96a7\u9053\u63a5\u53e3\u3002 \u5982\u679c\u9700\u8981\u4f7f\u7528\u5176\u5b83\u7f51\u5361\uff0c\u9700\u8981\u5728\u5b89\u88c5\u524d\u7ed9\u8282\u70b9\u6dfb\u52a0\u6307\u5b9a\u7684 Annotation\uff0c\u5982 ovn.kubernetes.io/tunnel_interface=Ethernet1 \u3002","title":"Windows \u652f\u6301"},{"location":"advance/windows/#windows","text":"Kube-OVN \u652f\u6301\u5305\u542b Windows \u7cfb\u7edf\u8282\u70b9\u7684 Kubernetes \u96c6\u7fa4\u7f51\u7edc\uff0c\u53ef\u4ee5\u5c06 Windows \u5bb9\u5668\u7684\u7f51\u7edc\u7edf\u4e00\u63a5\u5165\u8fdb\u884c\u7ba1\u7406\u3002","title":"Windows \u652f\u6301"},{"location":"advance/windows/#_1","text":"\u53c2\u8003 Adding Windows nodes \u589e\u52a0 Windows \u8282\u70b9\u3002 Windows \u8282\u70b9\u5fc5\u987b\u5b89\u88c5 KB4489899 \u8865\u4e01\u4ee5\u4f7f Overlay/VXLAN \u7f51\u7edc\u6b63\u5e38\u5de5\u4f5c\uff0c\u5efa\u8bae\u66f4\u65b0\u7cfb\u7edf\u81f3\u6700\u65b0\u7248\u672c\u3002 Windows \u8282\u70b9\u5fc5\u987b\u5b89\u88c5 Hyper-V \u53ca\u7ba1\u7406\u5de5\u5177\u3002 \u7531\u4e8e Windows \u9650\u5236\u96a7\u9053\u5c01\u88c5\u53ea\u80fd\u4f7f\u7528 Vxlan \u6a21\u5f0f\u3002 \u6682\u4e0d\u652f\u6301 SSL\uff0cIPv6\uff0c\u53cc\u6808\uff0cQoS \u529f\u80fd\u3002 \u6682\u4e0d\u652f\u6301\u52a8\u6001\u5b50\u7f51\uff0c\u52a8\u6001\u96a7\u9053\u63a5\u53e3\u529f\u80fd\uff0c\u9700\u5728\u5b89\u88c5 Windows \u8282\u70b9\u524d\u5b8c\u6210\u5b50\u7f51\u521b\u5efa\uff0c\u5e76\u56fa\u5b9a\u7f51\u7edc\u63a5\u53e3\u3002 \u4e0d\u652f\u6301\u591a\u4e2a ProviderNetwork \uff0c\u4e14\u65e0\u6cd5\u52a8\u6001\u8c03\u6574\u6865\u63a5\u63a5\u53e3\u914d\u7f6e\u3002","title":"\u524d\u63d0\u6761\u4ef6"},{"location":"advance/windows/#ovs","text":"\u7531\u4e8e\u4e0a\u6e38 OVN \u548c OVS \u5bf9 Windows \u5bb9\u5668\u652f\u6301\u5b58\u5728\u4e00\u4e9b\u95ee\u9898\uff0c\u9700\u8981\u4f7f\u7528 Kube-OVN \u63d0\u4f9b\u7684\u7ecf\u8fc7\u4fee\u6539\u7684\u5b89\u88c5\u5305\u8fdb\u884c\u5b89\u88c5\u3002 \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6253\u5f00 Windows \u8282\u70b9\u7684 TESTSIGNING \u542f\u52a8\u9879\uff0c\u6267\u884c\u6210\u529f\u540e\u9700\u8981\u91cd\u542f\u7cfb\u7edf\u751f\u6548\uff1a bcdedit /set LOADOPTIONS DISABLE_INTEGRITY_CHECKS bcdedit /set TESTSIGNING ON bcdedit /set nointegritychecks ON \u5728 Windows \u8282\u70b9\u4e0b\u8f7d Windows \u5b89\u88c5\u5305 \u5e76\u89e3\u538b\u5b89\u88c5\u3002 \u5b89\u88c5\u5b8c\u6210\u540e\u786e\u8ba4\u670d\u52a1\u6b63\u5e38\u8fd0\u884c\uff1a PS > Get-Service | findstr ovs Running ovsdb-server Open vSwitch DB Service Running ovs-vswitchd Open vSwitch Service","title":"\u5b89\u88c5 OVS"},{"location":"advance/windows/#kube-ovn","text":"\u5728 Windows \u8282\u70b9\u4e0b\u8f7d\u5b89\u88c5\u811a\u672c install.ps1 \u3002 \u8865\u5145\u76f8\u5173\u53c2\u6570\u5e76\u6267\u884c\uff1a .\\install.ps1 -KubeConfig C:\\k\\admin.conf -ApiServer https://192.168.140.180:6443 -ServiceCIDR 10.96.0.0/12 \u9ed8\u8ba4\u60c5\u51b5\u4e0b, Kube-OVN \u4f7f\u7528\u8282\u70b9 IP \u6240\u5728\u7684\u7f51\u5361\u4f5c\u4e3a\u96a7\u9053\u63a5\u53e3\u3002 \u5982\u679c\u9700\u8981\u4f7f\u7528\u5176\u5b83\u7f51\u5361\uff0c\u9700\u8981\u5728\u5b89\u88c5\u524d\u7ed9\u8282\u70b9\u6dfb\u52a0\u6307\u5b9a\u7684 Annotation\uff0c\u5982 ovn.kubernetes.io/tunnel_interface=Ethernet1 \u3002","title":"\u5b89\u88c5 Kube-OVN"},{"location":"advance/with-bgp/","text":"BGP \u652f\u6301 Kube-OVN \u652f\u6301\u5c06 Pod \u6216 Subnet \u7684 IP \u5730\u5740\u901a\u8fc7 BGP \u534f\u8bae\u5411\u5916\u90e8\u8fdb\u884c\u8def\u7531\u5e7f\u64ad\uff0c\u4ece\u800c\u4f7f\u5f97 Pod IP \u53ef\u4ee5\u76f4\u63a5\u5bf9\u5916\u66b4\u9732\u3002 \u5982\u679c\u9700\u8981\u4f7f\u7528\u8be5\u529f\u80fd\uff0c\u9700\u8981\u5728\u7279\u5b9a\u8282\u70b9\u5b89\u88c5 kube-ovn-speaker \u5e76\u5bf9\u9700\u8981\u5bf9\u5916\u66b4\u9732\u7684 Pod \u6216 Subnet \u589e\u52a0\u5bf9\u5e94\u7684 annotation\u3002 \u5b89\u88c5 kube-ovn-speaker kube-ovn-speaker \u5185\u4f7f\u7528 GoBGP \u5bf9\u5916\u53d1\u5e03\u8def\u7531\u4fe1\u606f\uff0c\u5e76\u5c06\u8bbf\u95ee\u66b4\u9732\u5730\u5740\u7684\u4e0b\u4e00\u8df3\u8def\u7531\u6307\u5411\u81ea\u8eab\u3002 \u7531\u4e8e\u90e8\u7f72 kube-ovn-speaker \u7684\u8282\u70b9\u9700\u8981\u627f\u62c5\u56de\u7a0b\u6d41\u91cf\uff0c\u56e0\u6b64\u9700\u8981\u9009\u62e9\u7279\u5b9a\u8282\u70b9\u8fdb\u884c\u90e8\u7f72\uff1a kubectl label nodes speaker-node-1 ovn.kubernetes.io/bgp=true kubectl label nodes speaker-node-2 ovn.kubernetes.io/bgp=true \u5f53\u5b58\u5728\u591a\u4e2a kube-ovn-speaker \u5b9e\u4f8b\u65f6\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u90fd\u4f1a\u5bf9\u5916\u53d1\u5e03\u8def\u7531\uff0c\u4e0a\u6e38\u8def\u7531\u5668\u9700\u8981\u652f\u6301\u591a\u8def\u5f84 ECMP\u3002 \u4e0b\u8f7d\u5bf9\u5e94 yaml: wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/yamls/speaker.yaml \u4fee\u6539 yaml \u5185\u76f8\u5e94\u914d\u7f6e\uff1a --neighbor-address=10.32.32.1 --neighbor-as=65030 --cluster-as=65000 neighbor-address : BGP Peer \u7684\u5730\u5740\uff0c\u901a\u5e38\u4e3a\u8def\u7531\u5668\u7f51\u5173\u5730\u5740\u3002 neighbor-as : BGP Peer \u7684 AS \u53f7\u3002 cluster-as : \u5bb9\u5668\u7f51\u7edc\u7684 AS \u53f7\u3002 \u90e8\u7f72 yaml: kubectl apply -f speaker.yaml \u53d1\u5e03 Pod/Subnet \u8def\u7531 \u5982\u9700\u4f7f\u7528 BGP \u5bf9\u5916\u53d1\u5e03\u8def\u7531\uff0c\u9996\u5148\u9700\u8981\u5c06\u5bf9\u5e94 Subnet \u7684 natOutgoing \u8bbe\u7f6e\u4e3a false \uff0c\u4f7f\u5f97 Pod IP \u53ef\u4ee5\u76f4\u63a5\u8fdb\u5165\u5e95\u5c42\u7f51\u7edc\u3002 \u589e\u52a0 annotation \u5bf9\u5916\u53d1\u5e03\uff1a kubectl annotate pod sample ovn.kubernetes.io/bgp=true kubectl annotate subnet ovn-default ovn.kubernetes.io/bgp=true \u5220\u9664 annotation \u53d6\u6d88\u53d1\u5e03\uff1a kubectl annotate pod perf-ovn-xzvd4 ovn.kubernetes.io/bgp- kubectl annotate subnet ovn-default ovn.kubernetes.io/bgp- BGP \u9ad8\u7ea7\u9009\u9879 kube-ovn-speaker \u652f\u6301\u66f4\u591a BGP \u53c2\u6570\u8fdb\u884c\u9ad8\u7ea7\u914d\u7f6e\uff0c\u7528\u6237\u53ef\u6839\u636e\u81ea\u5df1\u7f51\u7edc\u73af\u5883\u8fdb\u884c\u8c03\u6574\uff1a announce-cluster-ip : \u662f\u5426\u5bf9\u5916\u53d1\u5e03 Service \u8def\u7531\uff0c\u9ed8\u8ba4\u4e3a false \u3002 auth-password : BGP peer \u7684\u8bbf\u95ee\u5bc6\u7801\u3002 holdtime : BGP \u90bb\u5c45\u95f4\u7684\u5fc3\u8df3\u63a2\u6d4b\u65f6\u95f4\uff0c\u8d85\u8fc7\u6539\u65f6\u95f4\u6ca1\u6709\u6d88\u606f\u7684\u90bb\u5c45\u5c06\u4f1a\u88ab\u79fb\u9664\uff0c\u9ed8\u8ba4\u4e3a 90 \u79d2\u3002 graceful-restart : \u662f\u5426\u542f\u7528 BGP Graceful Restart\u3002 graceful-restart-time : BGP Graceful restart time \u53ef\u53c2\u8003 RFC4724 3\u3002 graceful-restart-deferral-time : BGP Graceful restart deferral time \u53ef\u53c2\u8003 RFC4724 4.1\u3002","title":"BGP \u652f\u6301"},{"location":"advance/with-bgp/#bgp","text":"Kube-OVN \u652f\u6301\u5c06 Pod \u6216 Subnet \u7684 IP \u5730\u5740\u901a\u8fc7 BGP \u534f\u8bae\u5411\u5916\u90e8\u8fdb\u884c\u8def\u7531\u5e7f\u64ad\uff0c\u4ece\u800c\u4f7f\u5f97 Pod IP \u53ef\u4ee5\u76f4\u63a5\u5bf9\u5916\u66b4\u9732\u3002 \u5982\u679c\u9700\u8981\u4f7f\u7528\u8be5\u529f\u80fd\uff0c\u9700\u8981\u5728\u7279\u5b9a\u8282\u70b9\u5b89\u88c5 kube-ovn-speaker \u5e76\u5bf9\u9700\u8981\u5bf9\u5916\u66b4\u9732\u7684 Pod \u6216 Subnet \u589e\u52a0\u5bf9\u5e94\u7684 annotation\u3002","title":"BGP \u652f\u6301"},{"location":"advance/with-bgp/#kube-ovn-speaker","text":"kube-ovn-speaker \u5185\u4f7f\u7528 GoBGP \u5bf9\u5916\u53d1\u5e03\u8def\u7531\u4fe1\u606f\uff0c\u5e76\u5c06\u8bbf\u95ee\u66b4\u9732\u5730\u5740\u7684\u4e0b\u4e00\u8df3\u8def\u7531\u6307\u5411\u81ea\u8eab\u3002 \u7531\u4e8e\u90e8\u7f72 kube-ovn-speaker \u7684\u8282\u70b9\u9700\u8981\u627f\u62c5\u56de\u7a0b\u6d41\u91cf\uff0c\u56e0\u6b64\u9700\u8981\u9009\u62e9\u7279\u5b9a\u8282\u70b9\u8fdb\u884c\u90e8\u7f72\uff1a kubectl label nodes speaker-node-1 ovn.kubernetes.io/bgp=true kubectl label nodes speaker-node-2 ovn.kubernetes.io/bgp=true \u5f53\u5b58\u5728\u591a\u4e2a kube-ovn-speaker \u5b9e\u4f8b\u65f6\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u90fd\u4f1a\u5bf9\u5916\u53d1\u5e03\u8def\u7531\uff0c\u4e0a\u6e38\u8def\u7531\u5668\u9700\u8981\u652f\u6301\u591a\u8def\u5f84 ECMP\u3002 \u4e0b\u8f7d\u5bf9\u5e94 yaml: wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/yamls/speaker.yaml \u4fee\u6539 yaml \u5185\u76f8\u5e94\u914d\u7f6e\uff1a --neighbor-address=10.32.32.1 --neighbor-as=65030 --cluster-as=65000 neighbor-address : BGP Peer \u7684\u5730\u5740\uff0c\u901a\u5e38\u4e3a\u8def\u7531\u5668\u7f51\u5173\u5730\u5740\u3002 neighbor-as : BGP Peer \u7684 AS \u53f7\u3002 cluster-as : \u5bb9\u5668\u7f51\u7edc\u7684 AS \u53f7\u3002 \u90e8\u7f72 yaml: kubectl apply -f speaker.yaml","title":"\u5b89\u88c5 kube-ovn-speaker"},{"location":"advance/with-bgp/#podsubnet","text":"\u5982\u9700\u4f7f\u7528 BGP \u5bf9\u5916\u53d1\u5e03\u8def\u7531\uff0c\u9996\u5148\u9700\u8981\u5c06\u5bf9\u5e94 Subnet \u7684 natOutgoing \u8bbe\u7f6e\u4e3a false \uff0c\u4f7f\u5f97 Pod IP \u53ef\u4ee5\u76f4\u63a5\u8fdb\u5165\u5e95\u5c42\u7f51\u7edc\u3002 \u589e\u52a0 annotation \u5bf9\u5916\u53d1\u5e03\uff1a kubectl annotate pod sample ovn.kubernetes.io/bgp=true kubectl annotate subnet ovn-default ovn.kubernetes.io/bgp=true \u5220\u9664 annotation \u53d6\u6d88\u53d1\u5e03\uff1a kubectl annotate pod perf-ovn-xzvd4 ovn.kubernetes.io/bgp- kubectl annotate subnet ovn-default ovn.kubernetes.io/bgp-","title":"\u53d1\u5e03 Pod/Subnet \u8def\u7531"},{"location":"advance/with-bgp/#bgp_1","text":"kube-ovn-speaker \u652f\u6301\u66f4\u591a BGP \u53c2\u6570\u8fdb\u884c\u9ad8\u7ea7\u914d\u7f6e\uff0c\u7528\u6237\u53ef\u6839\u636e\u81ea\u5df1\u7f51\u7edc\u73af\u5883\u8fdb\u884c\u8c03\u6574\uff1a announce-cluster-ip : \u662f\u5426\u5bf9\u5916\u53d1\u5e03 Service \u8def\u7531\uff0c\u9ed8\u8ba4\u4e3a false \u3002 auth-password : BGP peer \u7684\u8bbf\u95ee\u5bc6\u7801\u3002 holdtime : BGP \u90bb\u5c45\u95f4\u7684\u5fc3\u8df3\u63a2\u6d4b\u65f6\u95f4\uff0c\u8d85\u8fc7\u6539\u65f6\u95f4\u6ca1\u6709\u6d88\u606f\u7684\u90bb\u5c45\u5c06\u4f1a\u88ab\u79fb\u9664\uff0c\u9ed8\u8ba4\u4e3a 90 \u79d2\u3002 graceful-restart : \u662f\u5426\u542f\u7528 BGP Graceful Restart\u3002 graceful-restart-time : BGP Graceful restart time \u53ef\u53c2\u8003 RFC4724 3\u3002 graceful-restart-deferral-time : BGP Graceful restart deferral time \u53ef\u53c2\u8003 RFC4724 4.1\u3002","title":"BGP \u9ad8\u7ea7\u9009\u9879"},{"location":"advance/with-cilium/","text":"Cilium \u96c6\u6210 Cilium \u662f\u4e00\u6b3e\u57fa\u4e8e eBPF \u7684\u7f51\u7edc\u548c\u5b89\u5168\u7ec4\u4ef6\uff0cKube-OVN \u5229\u7528\u5176\u4e2d\u7684 CNI Chaining \u6a21\u5f0f\u6765\u5bf9\u5df2\u6709\u529f\u80fd\u8fdb\u884c\u589e\u5f3a\u3002 \u7528\u6237\u53ef\u4ee5\u540c\u65f6\u4f7f\u7528 Kube-OVN \u4e30\u5bcc\u7684\u7f51\u7edc\u62bd\u8c61\u80fd\u529b\u548c eBPF \u5e26\u6765\u7684\u76d1\u63a7\u548c\u5b89\u5168\u80fd\u529b\u3002 \u901a\u8fc7\u96c6\u6210 Cilium\uff0cKube-OVN \u7528\u6237\u53ef\u4ee5\u83b7\u5f97\u5982\u4e0b\u589e\u76ca\uff1a \u66f4\u4e30\u5bcc\u9ad8\u6548\u7684\u5b89\u5168\u7b56\u7565 \u57fa\u4e8e Hubble \u7684\u76d1\u63a7\u89c6\u56fe \u524d\u63d0\u6761\u4ef6 Linux \u5185\u6838\u7248\u672c\u9ad8\u4e8e 4.19 \u6216\u5176\u4ed6\u517c\u5bb9\u5185\u6838\u4ee5\u83b7\u5f97\u5b8c\u6574 eBPF \u80fd\u529b\u652f\u6301 \u63d0\u524d\u90e8\u7f72 Helm \u4e3a\u5b89\u88c5 Cilium \u505a\u51c6\u5907\uff0c\u90e8\u7f72 Helm \u8bf7\u53c2\u8003 Installing Helm \u914d\u7f6e Kube-OVN \u4e3a\u4e86\u5145\u5206\u4f7f\u7528 Cilium \u7684\u5b89\u5168\u80fd\u529b\uff0c\u9700\u8981\u5173\u95ed Kube-OVN \u5185\u7684 networkpolicy \u529f\u80fd\uff0c\u5e76\u8c03\u6574 CNI \u914d\u7f6e\u4f18\u5148\u7ea7\u3002 \u5728 install.sh \u811a\u672c\u91cc\u4fee\u6539\u4e0b\u5217\u53d8\u91cf ENABLE_NP=false CNI_CONFIG_PRIORITY=10 \u82e5\u5df2\u90e8\u7f72\u5b8c\u6210\uff0c\u53ef\u901a\u8fc7\u4fee\u6539 kube-ovn-controller \u7684\u542f\u52a8\u53c2\u6570\u8fdb\u884c\u8c03\u6574 networkpolicy \uff1a args: - --enable-np=false \u4fee\u6539 kube-ovn-cni \u542f\u52a8\u53c2\u6570\u8c03\u6574 CNI \u914d\u7f6e\u4f18\u5148\u7ea7\uff1a args: - --cni-conf-name=10-kube-ovn.conflist \u5728\u6bcf\u4e2a\u8282\u70b9\u8c03\u6574 Kube-OVN \u914d\u7f6e\u6587\u4ef6\u540d\u79f0\uff0c\u4ee5\u4fbf\u4f18\u5148\u4f7f\u7528 Cilium \u8fdb\u884c\u64cd\u4f5c\uff1a mv /etc/cni/net.d/01-kube-ovn.conflist /etc/cni/net.d/10-kube-ovn.conflist \u90e8\u7f72 Cilium \u521b\u5efa chaining.yaml \u914d\u7f6e\u6587\u4ef6\uff0c\u4f7f\u7528 Cilium \u7684 generic-veth \u6a21\u5f0f\uff1a apiVersion: v1 kind: ConfigMap metadata: name: cni-configuration namespace: kube-system data: cni-config: |- { \"name\": \"generic-veth\", \"cniVersion\": \"0.3.1\", \"plugins\": [ { \"type\": \"kube-ovn\", \"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\", \"ipam\": { \"type\": \"kube-ovn\", \"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\" } }, { \"type\": \"portmap\", \"snat\": true, \"capabilities\": {\"portMappings\": true} }, { \"type\": \"cilium-cni\" } ] } \u5b89\u88c5\u914d\u7f6e\u6587\u4ef6\uff1a kubectl apply -f chaining.yaml \u4f7f\u7528 Helm \u90e8\u7f72 Cilium\uff1a helm repo add cilium https://helm.cilium.io/ helm install cilium cilium/cilium --version 1.11.6 \\ --namespace kube-system \\ --set cni.chainingMode=generic-veth \\ --set cni.customConf=true \\ --set cni.configMap=cni-configuration \\ --set tunnel=disabled \\ --set enableIPv4Masquerade=false \\ --set enableIdentityMark=false \u786e\u8ba4 Cilium \u5b89\u88c5\u6210\u529f\uff1a # cilium status /\u00af\u00af\\ /\u00af\u00af\\__/\u00af\u00af\\ Cilium: OK \\__/\u00af\u00af\\__/ Operator: OK /\u00af\u00af\\__/\u00af\u00af\\ Hubble: disabled \\__/\u00af\u00af\\__/ ClusterMesh: disabled \\__/ DaemonSet cilium Desired: 2, Ready: 2/2, Available: 2/2 Deployment cilium-operator Desired: 2, Ready: 2/2, Available: 2/2 Containers: cilium Running: 2 cilium-operator Running: 2 Cluster Pods: 8/11 managed by Cilium Image versions cilium quay.io/cilium/cilium:v1.10.5@sha256:0612218e28288db360c63677c09fafa2d17edda4f13867bcabf87056046b33bb: 2 cilium-operator quay.io/cilium/operator-generic:v1.10.5@sha256:2d2f730f219d489ff0702923bf24c0002cd93eb4b47ba344375566202f56d972: 2","title":"Cilium \u96c6\u6210"},{"location":"advance/with-cilium/#cilium","text":"Cilium \u662f\u4e00\u6b3e\u57fa\u4e8e eBPF \u7684\u7f51\u7edc\u548c\u5b89\u5168\u7ec4\u4ef6\uff0cKube-OVN \u5229\u7528\u5176\u4e2d\u7684 CNI Chaining \u6a21\u5f0f\u6765\u5bf9\u5df2\u6709\u529f\u80fd\u8fdb\u884c\u589e\u5f3a\u3002 \u7528\u6237\u53ef\u4ee5\u540c\u65f6\u4f7f\u7528 Kube-OVN \u4e30\u5bcc\u7684\u7f51\u7edc\u62bd\u8c61\u80fd\u529b\u548c eBPF \u5e26\u6765\u7684\u76d1\u63a7\u548c\u5b89\u5168\u80fd\u529b\u3002 \u901a\u8fc7\u96c6\u6210 Cilium\uff0cKube-OVN \u7528\u6237\u53ef\u4ee5\u83b7\u5f97\u5982\u4e0b\u589e\u76ca\uff1a \u66f4\u4e30\u5bcc\u9ad8\u6548\u7684\u5b89\u5168\u7b56\u7565 \u57fa\u4e8e Hubble \u7684\u76d1\u63a7\u89c6\u56fe","title":"Cilium \u96c6\u6210"},{"location":"advance/with-cilium/#_1","text":"Linux \u5185\u6838\u7248\u672c\u9ad8\u4e8e 4.19 \u6216\u5176\u4ed6\u517c\u5bb9\u5185\u6838\u4ee5\u83b7\u5f97\u5b8c\u6574 eBPF \u80fd\u529b\u652f\u6301 \u63d0\u524d\u90e8\u7f72 Helm \u4e3a\u5b89\u88c5 Cilium \u505a\u51c6\u5907\uff0c\u90e8\u7f72 Helm \u8bf7\u53c2\u8003 Installing Helm","title":"\u524d\u63d0\u6761\u4ef6"},{"location":"advance/with-cilium/#kube-ovn","text":"\u4e3a\u4e86\u5145\u5206\u4f7f\u7528 Cilium \u7684\u5b89\u5168\u80fd\u529b\uff0c\u9700\u8981\u5173\u95ed Kube-OVN \u5185\u7684 networkpolicy \u529f\u80fd\uff0c\u5e76\u8c03\u6574 CNI \u914d\u7f6e\u4f18\u5148\u7ea7\u3002 \u5728 install.sh \u811a\u672c\u91cc\u4fee\u6539\u4e0b\u5217\u53d8\u91cf ENABLE_NP=false CNI_CONFIG_PRIORITY=10 \u82e5\u5df2\u90e8\u7f72\u5b8c\u6210\uff0c\u53ef\u901a\u8fc7\u4fee\u6539 kube-ovn-controller \u7684\u542f\u52a8\u53c2\u6570\u8fdb\u884c\u8c03\u6574 networkpolicy \uff1a args: - --enable-np=false \u4fee\u6539 kube-ovn-cni \u542f\u52a8\u53c2\u6570\u8c03\u6574 CNI \u914d\u7f6e\u4f18\u5148\u7ea7\uff1a args: - --cni-conf-name=10-kube-ovn.conflist \u5728\u6bcf\u4e2a\u8282\u70b9\u8c03\u6574 Kube-OVN \u914d\u7f6e\u6587\u4ef6\u540d\u79f0\uff0c\u4ee5\u4fbf\u4f18\u5148\u4f7f\u7528 Cilium \u8fdb\u884c\u64cd\u4f5c\uff1a mv /etc/cni/net.d/01-kube-ovn.conflist /etc/cni/net.d/10-kube-ovn.conflist","title":"\u914d\u7f6e Kube-OVN"},{"location":"advance/with-cilium/#cilium_1","text":"\u521b\u5efa chaining.yaml \u914d\u7f6e\u6587\u4ef6\uff0c\u4f7f\u7528 Cilium \u7684 generic-veth \u6a21\u5f0f\uff1a apiVersion: v1 kind: ConfigMap metadata: name: cni-configuration namespace: kube-system data: cni-config: |- { \"name\": \"generic-veth\", \"cniVersion\": \"0.3.1\", \"plugins\": [ { \"type\": \"kube-ovn\", \"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\", \"ipam\": { \"type\": \"kube-ovn\", \"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\" } }, { \"type\": \"portmap\", \"snat\": true, \"capabilities\": {\"portMappings\": true} }, { \"type\": \"cilium-cni\" } ] } \u5b89\u88c5\u914d\u7f6e\u6587\u4ef6\uff1a kubectl apply -f chaining.yaml \u4f7f\u7528 Helm \u90e8\u7f72 Cilium\uff1a helm repo add cilium https://helm.cilium.io/ helm install cilium cilium/cilium --version 1.11.6 \\ --namespace kube-system \\ --set cni.chainingMode=generic-veth \\ --set cni.customConf=true \\ --set cni.configMap=cni-configuration \\ --set tunnel=disabled \\ --set enableIPv4Masquerade=false \\ --set enableIdentityMark=false \u786e\u8ba4 Cilium \u5b89\u88c5\u6210\u529f\uff1a # cilium status /\u00af\u00af\\ /\u00af\u00af\\__/\u00af\u00af\\ Cilium: OK \\__/\u00af\u00af\\__/ Operator: OK /\u00af\u00af\\__/\u00af\u00af\\ Hubble: disabled \\__/\u00af\u00af\\__/ ClusterMesh: disabled \\__/ DaemonSet cilium Desired: 2, Ready: 2/2, Available: 2/2 Deployment cilium-operator Desired: 2, Ready: 2/2, Available: 2/2 Containers: cilium Running: 2 cilium-operator Running: 2 Cluster Pods: 8/11 managed by Cilium Image versions cilium quay.io/cilium/cilium:v1.10.5@sha256:0612218e28288db360c63677c09fafa2d17edda4f13867bcabf87056046b33bb: 2 cilium-operator quay.io/cilium/operator-generic:v1.10.5@sha256:2d2f730f219d489ff0702923bf24c0002cd93eb4b47ba344375566202f56d972: 2","title":"\u90e8\u7f72 Cilium"},{"location":"advance/with-openstack/","text":"OpenStack \u96c6\u6210 \u5728\u4e00\u4e9b\u60c5\u51b5\u4e0b\uff0c\u7528\u6237\u9700\u8981\u4f7f\u7528 OpenStack \u8fd0\u884c\u865a\u62df\u673a\uff0c\u4f7f\u7528 Kubernetes \u8fd0\u884c\u5bb9\u5668\uff0c\u5e76\u9700\u8981\u5bb9\u5668\u548c\u865a\u673a\u4e4b\u95f4\u7f51\u7edc\u4e92\u901a\u5e76\u5904\u4e8e\u7edf\u4e00\u63a7\u5236\u5e73\u9762\u4e0b\u3002\u5982\u679c OpenStack Neutron \u4fa7\u540c\u6837\u4f7f\u7528 OVN \u4f5c\u4e3a\u5e95\u5c42\u7f51\u7edc\u63a7\u5236\uff0c\u90a3\u4e48 Kube-OVN \u53ef\u4ee5\u4f7f\u7528\u96c6\u7fa4\u4e92\u8054\u548c\u5171\u4eab\u5e95\u5c42 OVN \u4e24\u79cd\u65b9\u5f0f\u6253\u901a OpenStack \u548c Kubernetes \u7684\u7f51\u7edc\u3002 \u96c6\u7fa4\u4e92\u8054 \u8be5\u6a21\u5f0f\u548c \u4f7f\u7528 OVN-IC \u8fdb\u884c\u591a\u96c6\u7fa4\u4e92\u8054 \u6253\u901a\u4e24\u4e2a Kubernetes \u96c6\u7fa4\u7f51\u7edc\u65b9\u5f0f\u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7\u5c06\u96c6\u7fa4\u4e24\u7aef\u6362\u6210 OpenStack \u548c Kubernetes, \u5e95\u5c42\u901a\u7528\u5229\u7528 OVN-IC \u7684\u80fd\u529b\u8fdb\u884c\u4e92\u8054\u3002 \u524d\u63d0\u6761\u4ef6 \u81ea\u52a8\u4e92\u8054\u6a21\u5f0f\u4e0b OpenStack \u548c Kubernetes \u5185\u7684\u5b50\u7f51 CIDR \u4e0d\u80fd\u76f8\u4e92\u91cd\u53e0\u3002\u82e5\u5b58\u5728\u91cd\u53e0\u9700\u53c2\u8003\u540e\u7eed\u624b\u52a8\u4e92\u8054\u8fc7\u7a0b\uff0c\u53ea\u80fd\u5c06\u4e0d\u91cd\u53e0\u7f51\u6bb5\u6253\u901a\u3002 \u9700\u8981\u5b58\u5728\u4e00\u7ec4\u673a\u5668\u53ef\u4ee5\u88ab\u6bcf\u4e2a\u96c6\u7fa4\u901a\u8fc7\u7f51\u7edc\u8bbf\u95ee\uff0c\u7528\u6765\u90e8\u7f72\u8de8\u96c6\u7fa4\u4e92\u8054\u7684\u63a7\u5236\u5668\u3002 \u6bcf\u4e2a\u96c6\u7fa4\u9700\u8981\u6709\u4e00\u7ec4\u53ef\u4ee5\u901a\u8fc7 IP \u8fdb\u884c\u8de8\u96c6\u7fa4\u4e92\u8bbf\u7684\u673a\u5668\u4f5c\u4e3a\u4e4b\u540e\u7684\u7f51\u5173\u8282\u70b9\u3002 \u8be5\u65b9\u6848\u53ea\u6253\u901a Kubernetes \u9ed8\u8ba4\u5b50\u7f51\u548c OpenStack \u7684\u9009\u5b9a VPC\u3002 \u90e8\u7f72 OVN-IC \u6570\u636e\u5e93 \u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u542f\u52a8 OVN-IC \u6570\u636e\u5e93\uff1a docker run --name=ovn-ic-db -d --network=host -v /etc/ovn/:/etc/ovn -v /var/run/ovn:/var/run/ovn -v /var/log/ovn:/var/log/ovn kubeovn/kube-ovn:v1.10.1 bash start-ic-db.sh Kubernetes \u4fa7\u64cd\u4f5c \u5728 kube-system Namespace \u4e0b\u521b\u5efa ovn-ic-config ConfigMap\uff1a apiVersion: v1 kind: ConfigMap metadata: name: ovn-ic-config namespace: kube-system data: enable-ic: \"true\" az-name: \"az1\" ic-db-host: \"192.168.65.3\" ic-nb-port: \"6645\" ic-sb-port: \"6646\" gw-nodes: \"az1-gw\" auto-route: \"true\" enable-ic : \u662f\u5426\u5f00\u542f\u96c6\u7fa4\u4e92\u8054\u3002 az-name : \u533a\u5206\u4e0d\u540c\u96c6\u7fa4\u7684\u96c6\u7fa4\u540d\u79f0\uff0c\u6bcf\u4e2a\u4e92\u8054\u96c6\u7fa4\u9700\u4e0d\u540c\u3002 ic-db-host : \u90e8\u7f72 OVN-IC \u6570\u636e\u5e93\u7684\u8282\u70b9\u5730\u5740\u3002 ic-nb-port : OVN-IC \u5317\u5411\u6570\u636e\u5e93\uff0c\u9ed8\u8ba4\u4e3a 6645\u3002 ic-sb-port : OVN-IC \u5357\u5411\u6570\u636e\u5e93\uff0c\u9ed8\u8ba4\u4e3a 6646\u3002 gw-nodes : \u96c6\u7fa4\u4e92\u8054\u4e2d\u627f\u62c5\u7f51\u5173\u5de5\u4f5c\u7684\u8282\u70b9\u540d\uff0c\u9017\u53f7\u5206\u9694\u3002 auto-route : \u662f\u5426\u81ea\u52a8\u5bf9\u5916\u53d1\u5e03\u548c\u5b66\u4e60\u8def\u7531\u3002 OpenStack \u4fa7\u64cd\u4f5c \u521b\u5efa\u548c Kubernetes \u4e92\u8054\u7684\u903b\u8f91\u8def\u7531\u5668\uff1a # openstack router create router0 # openstack router list +--------------------------------------+---------+--------+-------+----------------------------------+ | ID | Name | Status | State | Project | +--------------------------------------+---------+--------+-------+----------------------------------+ | d5b38655-249a-4192-8046-71aa4d2b4af1 | router0 | ACTIVE | UP | 98a29ab7388347e7b5ff8bdd181ba4f9 | +--------------------------------------+---------+--------+-------+----------------------------------+ \u5728 OpenStack \u5185\u7684 OVN \u5317\u5411\u6570\u636e\u5e93\u4e2d\u8bbe\u7f6e\u53ef\u7528\u533a\u540d\u5b57\uff0c\u8be5\u540d\u79f0\u9700\u548c\u5176\u4ed6\u4e92\u8054\u96c6\u7fa4\u4e0d\u540c\uff1a ovn-nbctl set NB_Global . name=op-az \u5728\u53ef\u8bbf\u95ee OVN-IC \u6570\u636e\u5e93\u7684\u8282\u70b9\u542f\u52a8 OVN-IC \u63a7\u5236\u5668\uff1a /usr/share/ovn/scripts/ovn-ctl --ovn-ic-nb-db=tcp:192.168.65.3:6645 \\ --ovn-ic-sb-db=tcp:192.168.65.3:6646 \\ --ovn-northd-nb-db=unix:/run/ovn/ovnnb_db.sock \\ --ovn-northd-sb-db=unix:/run/ovn/ovnsb_db.sock \\ start_ic ovn-ic-nb-db \uff0c ovn-ic-sb-db : OVN-IC \u6570\u636e\u5e93\u5317\u5411\u6570\u636e\u5e93\u548c\u5357\u5411\u6570\u636e\u5e93\u5730\u5740\u3002 ovn-northd-nb-db \uff0c ovn-northd-sb-db : \u5f53\u524d\u96c6\u7fa4 OVN \u5317\u5411\u6570\u636e\u5e93\u548c\u5357\u5411\u6570\u636e\u5730\u5740\u3002 \u914d\u7f6e\u4e92\u8054\u7f51\u5173\u8282\u70b9\uff1a ovs-vsctl set open_vswitch . external_ids:ovn-is-interconn=true \u63a5\u4e0b\u6765\u9700\u8981\u5728 OpenStack \u7684 OVN \u5185\u8fdb\u884c\u64cd\u4f5c\u521b\u5efa\u903b\u8f91\u62d3\u6251\u3002 \u8fde\u63a5 ts \u4e92\u8054\u4ea4\u6362\u673a\u548c router0 \u903b\u8f91\u8def\u7531\u5668\uff0c\u5e76\u8bbe\u7f6e\u76f8\u5173\u89c4\u5219\uff1a ovn-nbctl lrp-add router0 lrp-router0-ts 00:02:ef:11:39:4f 169.254.100.73/24 ovn-nbctl lsp-add ts lsp-ts-router0 -- lsp-set-addresses lsp-ts-router0 router \\ -- lsp-set-type lsp-ts-router0 router \\ -- lsp-set-options lsp-ts-router0 router-port=lrp-router0-ts ovn-nbctl lrp-set-gateway-chassis lrp-router0-ts {gateway chassis} 1000 ovn-nbctl set NB_Global . options:ic-route-adv=true options:ic-route-learn=true \u9a8c\u8bc1\u5df2\u5b66\u4e60\u5230 Kubernetes \u8def\u7531\u89c4\u5219\uff1a # ovn-nbctl lr-route-list router0 IPv4 Routes 10.0.0.22 169.254.100.34 dst-ip (learned) 10.16.0.0/16 169.254.100.34 dst-ip (learned) \u63a5\u4e0b\u6765\u53ef\u4ee5\u5728 router0 \u7f51\u7edc\u4e0b\u521b\u5efa\u865a\u673a\u9a8c\u8bc1\u662f\u5426\u53ef\u4ee5\u548c Kubernetes \u4e0b Pod \u4e92\u901a\u3002 \u5171\u4eab\u5e95\u5c42 OVN \u5728\u8be5\u65b9\u6848\u4e0b\uff0cOpenStack \u548c Kubernetes \u5171\u4eab\u4f7f\u7528\u540c\u4e00\u4e2a OVN\uff0c\u56e0\u6b64\u53ef\u4ee5\u5c06\u4e24\u8005\u7684 VPC \u548c Subnet \u7b49\u6982\u5ff5\u62c9\u9f50\uff0c\u5b9e\u73b0\u66f4\u597d\u7684\u63a7\u5236\u548c\u4e92\u8054\u3002 \u5728\u8be5\u6a21\u5f0f\u4e0b\u6211\u4eec\u6b63\u5e38\u4f7f\u7528 Kube-OVN \u90e8\u7f72 OVN\uff0cOpenStack \u4fee\u6539 Neutron \u914d\u7f6e\u5b9e\u73b0\u8fde\u63a5\u540c\u4e00\u4e2a OVN \u6570\u636e\u5e93\u3002OpenStack \u9700\u4f7f\u7528 networking-ovn \u4f5c\u4e3a Neutron \u540e\u7aef\u5b9e\u73b0\u3002 Neutron \u914d\u7f6e\u4fee\u6539 \u4fee\u6539 Neutron \u914d\u7f6e\u6587\u4ef6 /etc/neutron/plugins/ml2/ml2_conf.ini \uff1a [ovn] ... ovn_nb_connection = tcp:[192.168.137.176]:6641,tcp:[192.168.137.177]:6641,tcp:[192.168.137.178]:6641 ovn_sb_connection = tcp:[192.168.137.176]:6642,tcp:[192.168.137.177]:6642,tcp:[192.168.137.178]:6642 ovn_l3_scheduler = OVN_L3_SCHEDULER ovn_nb_connection \uff0c ovn_sb_connection : \u5730\u5740\u9700\u4fee\u6539\u4e3a Kube-OVN \u90e8\u7f72 ovn-central \u8282\u70b9\u7684\u5730\u5740\u3002 \u4fee\u6539\u6bcf\u4e2a\u8282\u70b9\u7684 OVS \u914d\u7f6e\uff1a ovs-vsctl set open . external-ids:ovn-remote=tcp:[192.168.137.176]:6642,tcp:[192.168.137.177]:6642,tcp:[192.168.137.178]:6642 ovs-vsctl set open . external-ids:ovn-encap-type=geneve ovs-vsctl set open . external-ids:ovn-encap-ip=192.168.137.200 external-ids:ovn-remote : \u5730\u5740\u9700\u4fee\u6539\u4e3a Kube-OVN \u90e8\u7f72 ovn-central \u8282\u70b9\u7684\u5730\u5740\u3002 ovn-encap-ip : \u4fee\u6539\u4e3a\u5f53\u524d\u8282\u70b9\u7684 IP \u5730\u5740\u3002 \u5728 Kubernetes \u4e2d\u4f7f\u7528 OpenStack \u5185\u8d44\u6e90 \u63a5\u4e0b\u6765\u4ecb\u7ecd\u5982\u4f55\u5728 Kubernetes \u4e2d\u67e5\u8be2 OpenStack \u7684\u7f51\u7edc\u8d44\u6e90\u5e76\u5728 OpenStack \u7684\u5b50\u7f51\u4e2d\u521b\u5efa Pod\u3002 \u67e5\u8be2 OpenStack \u4e2d\u5df2\u6709\u7684\u7f51\u7edc\u8d44\u6e90\uff0c\u5982\u4e0b\u8d44\u6e90\u5df2\u7ecf\u9884\u5148\u521b\u5efa\u5b8c\u6210\uff1a # openstack router list +--------------------------------------+---------+--------+-------+----------------------------------+ | ID | Name | Status | State | Project | +--------------------------------------+---------+--------+-------+----------------------------------+ | 22040ed5-0598-4f77-bffd-e7fd4db47e93 | router0 | ACTIVE | UP | 62381a21d569404aa236a5dd8712449c | +--------------------------------------+---------+--------+-------+----------------------------------+ # openstack network list +--------------------------------------+----------+--------------------------------------+ | ID | Name | Subnets | +--------------------------------------+----------+--------------------------------------+ | cd59e36a-37db-4c27-b709-d35379a7920f | provider | 01d73d9f-fdaa-426c-9b60-aa34abbfacae | +--------------------------------------+----------+--------------------------------------+ # openstack subnet list +--------------------------------------+-------------+--------------------------------------+----------------+ | ID | Name | Network | Subnet | +--------------------------------------+-------------+--------------------------------------+----------------+ | 01d73d9f-fdaa-426c-9b60-aa34abbfacae | provider-v4 | cd59e36a-37db-4c27-b709-d35379a7920f | 192.168.1.0/24 | +--------------------------------------+-------------+--------------------------------------+----------------+ # openstack server list +--------------------------------------+-------------------+--------+-----------------------+--------+--------+ | ID | Name | Status | Networks | Image | Flavor | +--------------------------------------+-------------------+--------+-----------------------+--------+--------+ | 8433d622-a8d6-41a7-8b31-49abfd64f639 | provider-instance | ACTIVE | provider=192.168.1.61 | ubuntu | m1 | +--------------------------------------+-------------------+--------+-----------------------+--------+--------+ \u5728 Kubernetes \u4fa7\uff0c\u67e5\u8be2 VPC \u8d44\u6e90\uff1a # kubectl get vpc NAME STANDBY SUBNETS neutron-22040ed5-0598-4f77-bffd-e7fd4db47e93 true [\"neutron-cd59e36a-37db-4c27-b709-d35379a7920f\"] ovn-cluster true [\"join\",\"ovn-default\"] neutron-22040ed5-0598-4f77-bffd-e7fd4db47e93 \u4e3a\u4ece OpenStack \u540c\u6b65\u8fc7\u6765\u7684 VPC \u8d44\u6e90\u3002 \u63a5\u4e0b\u6765\u53ef\u4ee5\u6309\u7167 Kube-OVN \u539f\u751f\u7684 VPC \u548c Subnet \u64cd\u4f5c\u521b\u5efa Pod \u5e76\u8fd0\u884c\u3002 VPC, Subnet \u7ed1\u5b9a Namespace net2 \uff0c\u5e76\u521b\u5efa Pod: apiVersion: v1 kind: Namespace metadata: name: net2 --- apiVersion: kubeovn.io/v1 kind: Vpc metadata: creationTimestamp: \"2021-06-20T13:34:11Z\" generation: 2 labels: ovn.kubernetes.io/vpc_external: \"true\" name: neutron-22040ed5-0598-4f77-bffd-e7fd4db47e93 resourceVersion: \"583728\" uid: 18d4c654-f511-4def-a3a0-a6434d237c1e spec: namespaces: - net2 --- kind: Subnet apiVersion: kubeovn.io/v1 metadata: name: net2 spec: vpc: neutron-22040ed5-0598-4f77-bffd-e7fd4db47e93 namespaces: - net2 cidrBlock: 12.0.1.0/24 natOutgoing: false --- apiVersion: v1 kind: Pod metadata: name: ubuntu namespace: net2 spec: containers: - image: kubeovn/kube-ovn:v1.8.0 command: - \"sleep\" - \"604800\" imagePullPolicy: IfNotPresent name: ubuntu restartPolicy: Always","title":"OpenStack \u96c6\u6210"},{"location":"advance/with-openstack/#openstack","text":"\u5728\u4e00\u4e9b\u60c5\u51b5\u4e0b\uff0c\u7528\u6237\u9700\u8981\u4f7f\u7528 OpenStack \u8fd0\u884c\u865a\u62df\u673a\uff0c\u4f7f\u7528 Kubernetes \u8fd0\u884c\u5bb9\u5668\uff0c\u5e76\u9700\u8981\u5bb9\u5668\u548c\u865a\u673a\u4e4b\u95f4\u7f51\u7edc\u4e92\u901a\u5e76\u5904\u4e8e\u7edf\u4e00\u63a7\u5236\u5e73\u9762\u4e0b\u3002\u5982\u679c OpenStack Neutron \u4fa7\u540c\u6837\u4f7f\u7528 OVN \u4f5c\u4e3a\u5e95\u5c42\u7f51\u7edc\u63a7\u5236\uff0c\u90a3\u4e48 Kube-OVN \u53ef\u4ee5\u4f7f\u7528\u96c6\u7fa4\u4e92\u8054\u548c\u5171\u4eab\u5e95\u5c42 OVN \u4e24\u79cd\u65b9\u5f0f\u6253\u901a OpenStack \u548c Kubernetes \u7684\u7f51\u7edc\u3002","title":"OpenStack \u96c6\u6210"},{"location":"advance/with-openstack/#_1","text":"\u8be5\u6a21\u5f0f\u548c \u4f7f\u7528 OVN-IC \u8fdb\u884c\u591a\u96c6\u7fa4\u4e92\u8054 \u6253\u901a\u4e24\u4e2a Kubernetes \u96c6\u7fa4\u7f51\u7edc\u65b9\u5f0f\u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7\u5c06\u96c6\u7fa4\u4e24\u7aef\u6362\u6210 OpenStack \u548c Kubernetes, \u5e95\u5c42\u901a\u7528\u5229\u7528 OVN-IC \u7684\u80fd\u529b\u8fdb\u884c\u4e92\u8054\u3002","title":"\u96c6\u7fa4\u4e92\u8054"},{"location":"advance/with-openstack/#_2","text":"\u81ea\u52a8\u4e92\u8054\u6a21\u5f0f\u4e0b OpenStack \u548c Kubernetes \u5185\u7684\u5b50\u7f51 CIDR \u4e0d\u80fd\u76f8\u4e92\u91cd\u53e0\u3002\u82e5\u5b58\u5728\u91cd\u53e0\u9700\u53c2\u8003\u540e\u7eed\u624b\u52a8\u4e92\u8054\u8fc7\u7a0b\uff0c\u53ea\u80fd\u5c06\u4e0d\u91cd\u53e0\u7f51\u6bb5\u6253\u901a\u3002 \u9700\u8981\u5b58\u5728\u4e00\u7ec4\u673a\u5668\u53ef\u4ee5\u88ab\u6bcf\u4e2a\u96c6\u7fa4\u901a\u8fc7\u7f51\u7edc\u8bbf\u95ee\uff0c\u7528\u6765\u90e8\u7f72\u8de8\u96c6\u7fa4\u4e92\u8054\u7684\u63a7\u5236\u5668\u3002 \u6bcf\u4e2a\u96c6\u7fa4\u9700\u8981\u6709\u4e00\u7ec4\u53ef\u4ee5\u901a\u8fc7 IP \u8fdb\u884c\u8de8\u96c6\u7fa4\u4e92\u8bbf\u7684\u673a\u5668\u4f5c\u4e3a\u4e4b\u540e\u7684\u7f51\u5173\u8282\u70b9\u3002 \u8be5\u65b9\u6848\u53ea\u6253\u901a Kubernetes \u9ed8\u8ba4\u5b50\u7f51\u548c OpenStack \u7684\u9009\u5b9a VPC\u3002","title":"\u524d\u63d0\u6761\u4ef6"},{"location":"advance/with-openstack/#ovn-ic","text":"\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u542f\u52a8 OVN-IC \u6570\u636e\u5e93\uff1a docker run --name=ovn-ic-db -d --network=host -v /etc/ovn/:/etc/ovn -v /var/run/ovn:/var/run/ovn -v /var/log/ovn:/var/log/ovn kubeovn/kube-ovn:v1.10.1 bash start-ic-db.sh","title":"\u90e8\u7f72 OVN-IC \u6570\u636e\u5e93"},{"location":"advance/with-openstack/#kubernetes","text":"\u5728 kube-system Namespace \u4e0b\u521b\u5efa ovn-ic-config ConfigMap\uff1a apiVersion: v1 kind: ConfigMap metadata: name: ovn-ic-config namespace: kube-system data: enable-ic: \"true\" az-name: \"az1\" ic-db-host: \"192.168.65.3\" ic-nb-port: \"6645\" ic-sb-port: \"6646\" gw-nodes: \"az1-gw\" auto-route: \"true\" enable-ic : \u662f\u5426\u5f00\u542f\u96c6\u7fa4\u4e92\u8054\u3002 az-name : \u533a\u5206\u4e0d\u540c\u96c6\u7fa4\u7684\u96c6\u7fa4\u540d\u79f0\uff0c\u6bcf\u4e2a\u4e92\u8054\u96c6\u7fa4\u9700\u4e0d\u540c\u3002 ic-db-host : \u90e8\u7f72 OVN-IC \u6570\u636e\u5e93\u7684\u8282\u70b9\u5730\u5740\u3002 ic-nb-port : OVN-IC \u5317\u5411\u6570\u636e\u5e93\uff0c\u9ed8\u8ba4\u4e3a 6645\u3002 ic-sb-port : OVN-IC \u5357\u5411\u6570\u636e\u5e93\uff0c\u9ed8\u8ba4\u4e3a 6646\u3002 gw-nodes : \u96c6\u7fa4\u4e92\u8054\u4e2d\u627f\u62c5\u7f51\u5173\u5de5\u4f5c\u7684\u8282\u70b9\u540d\uff0c\u9017\u53f7\u5206\u9694\u3002 auto-route : \u662f\u5426\u81ea\u52a8\u5bf9\u5916\u53d1\u5e03\u548c\u5b66\u4e60\u8def\u7531\u3002","title":"Kubernetes \u4fa7\u64cd\u4f5c"},{"location":"advance/with-openstack/#openstack_1","text":"\u521b\u5efa\u548c Kubernetes \u4e92\u8054\u7684\u903b\u8f91\u8def\u7531\u5668\uff1a # openstack router create router0 # openstack router list +--------------------------------------+---------+--------+-------+----------------------------------+ | ID | Name | Status | State | Project | +--------------------------------------+---------+--------+-------+----------------------------------+ | d5b38655-249a-4192-8046-71aa4d2b4af1 | router0 | ACTIVE | UP | 98a29ab7388347e7b5ff8bdd181ba4f9 | +--------------------------------------+---------+--------+-------+----------------------------------+ \u5728 OpenStack \u5185\u7684 OVN \u5317\u5411\u6570\u636e\u5e93\u4e2d\u8bbe\u7f6e\u53ef\u7528\u533a\u540d\u5b57\uff0c\u8be5\u540d\u79f0\u9700\u548c\u5176\u4ed6\u4e92\u8054\u96c6\u7fa4\u4e0d\u540c\uff1a ovn-nbctl set NB_Global . name=op-az \u5728\u53ef\u8bbf\u95ee OVN-IC \u6570\u636e\u5e93\u7684\u8282\u70b9\u542f\u52a8 OVN-IC \u63a7\u5236\u5668\uff1a /usr/share/ovn/scripts/ovn-ctl --ovn-ic-nb-db=tcp:192.168.65.3:6645 \\ --ovn-ic-sb-db=tcp:192.168.65.3:6646 \\ --ovn-northd-nb-db=unix:/run/ovn/ovnnb_db.sock \\ --ovn-northd-sb-db=unix:/run/ovn/ovnsb_db.sock \\ start_ic ovn-ic-nb-db \uff0c ovn-ic-sb-db : OVN-IC \u6570\u636e\u5e93\u5317\u5411\u6570\u636e\u5e93\u548c\u5357\u5411\u6570\u636e\u5e93\u5730\u5740\u3002 ovn-northd-nb-db \uff0c ovn-northd-sb-db : \u5f53\u524d\u96c6\u7fa4 OVN \u5317\u5411\u6570\u636e\u5e93\u548c\u5357\u5411\u6570\u636e\u5730\u5740\u3002 \u914d\u7f6e\u4e92\u8054\u7f51\u5173\u8282\u70b9\uff1a ovs-vsctl set open_vswitch . external_ids:ovn-is-interconn=true \u63a5\u4e0b\u6765\u9700\u8981\u5728 OpenStack \u7684 OVN \u5185\u8fdb\u884c\u64cd\u4f5c\u521b\u5efa\u903b\u8f91\u62d3\u6251\u3002 \u8fde\u63a5 ts \u4e92\u8054\u4ea4\u6362\u673a\u548c router0 \u903b\u8f91\u8def\u7531\u5668\uff0c\u5e76\u8bbe\u7f6e\u76f8\u5173\u89c4\u5219\uff1a ovn-nbctl lrp-add router0 lrp-router0-ts 00:02:ef:11:39:4f 169.254.100.73/24 ovn-nbctl lsp-add ts lsp-ts-router0 -- lsp-set-addresses lsp-ts-router0 router \\ -- lsp-set-type lsp-ts-router0 router \\ -- lsp-set-options lsp-ts-router0 router-port=lrp-router0-ts ovn-nbctl lrp-set-gateway-chassis lrp-router0-ts {gateway chassis} 1000 ovn-nbctl set NB_Global . options:ic-route-adv=true options:ic-route-learn=true \u9a8c\u8bc1\u5df2\u5b66\u4e60\u5230 Kubernetes \u8def\u7531\u89c4\u5219\uff1a # ovn-nbctl lr-route-list router0 IPv4 Routes 10.0.0.22 169.254.100.34 dst-ip (learned) 10.16.0.0/16 169.254.100.34 dst-ip (learned) \u63a5\u4e0b\u6765\u53ef\u4ee5\u5728 router0 \u7f51\u7edc\u4e0b\u521b\u5efa\u865a\u673a\u9a8c\u8bc1\u662f\u5426\u53ef\u4ee5\u548c Kubernetes \u4e0b Pod \u4e92\u901a\u3002","title":"OpenStack \u4fa7\u64cd\u4f5c"},{"location":"advance/with-openstack/#ovn","text":"\u5728\u8be5\u65b9\u6848\u4e0b\uff0cOpenStack \u548c Kubernetes \u5171\u4eab\u4f7f\u7528\u540c\u4e00\u4e2a OVN\uff0c\u56e0\u6b64\u53ef\u4ee5\u5c06\u4e24\u8005\u7684 VPC \u548c Subnet \u7b49\u6982\u5ff5\u62c9\u9f50\uff0c\u5b9e\u73b0\u66f4\u597d\u7684\u63a7\u5236\u548c\u4e92\u8054\u3002 \u5728\u8be5\u6a21\u5f0f\u4e0b\u6211\u4eec\u6b63\u5e38\u4f7f\u7528 Kube-OVN \u90e8\u7f72 OVN\uff0cOpenStack \u4fee\u6539 Neutron \u914d\u7f6e\u5b9e\u73b0\u8fde\u63a5\u540c\u4e00\u4e2a OVN \u6570\u636e\u5e93\u3002OpenStack \u9700\u4f7f\u7528 networking-ovn \u4f5c\u4e3a Neutron \u540e\u7aef\u5b9e\u73b0\u3002","title":"\u5171\u4eab\u5e95\u5c42 OVN"},{"location":"advance/with-openstack/#neutron","text":"\u4fee\u6539 Neutron \u914d\u7f6e\u6587\u4ef6 /etc/neutron/plugins/ml2/ml2_conf.ini \uff1a [ovn] ... ovn_nb_connection = tcp:[192.168.137.176]:6641,tcp:[192.168.137.177]:6641,tcp:[192.168.137.178]:6641 ovn_sb_connection = tcp:[192.168.137.176]:6642,tcp:[192.168.137.177]:6642,tcp:[192.168.137.178]:6642 ovn_l3_scheduler = OVN_L3_SCHEDULER ovn_nb_connection \uff0c ovn_sb_connection : \u5730\u5740\u9700\u4fee\u6539\u4e3a Kube-OVN \u90e8\u7f72 ovn-central \u8282\u70b9\u7684\u5730\u5740\u3002 \u4fee\u6539\u6bcf\u4e2a\u8282\u70b9\u7684 OVS \u914d\u7f6e\uff1a ovs-vsctl set open . external-ids:ovn-remote=tcp:[192.168.137.176]:6642,tcp:[192.168.137.177]:6642,tcp:[192.168.137.178]:6642 ovs-vsctl set open . external-ids:ovn-encap-type=geneve ovs-vsctl set open . external-ids:ovn-encap-ip=192.168.137.200 external-ids:ovn-remote : \u5730\u5740\u9700\u4fee\u6539\u4e3a Kube-OVN \u90e8\u7f72 ovn-central \u8282\u70b9\u7684\u5730\u5740\u3002 ovn-encap-ip : \u4fee\u6539\u4e3a\u5f53\u524d\u8282\u70b9\u7684 IP \u5730\u5740\u3002","title":"Neutron \u914d\u7f6e\u4fee\u6539"},{"location":"advance/with-openstack/#kubernetes-openstack","text":"\u63a5\u4e0b\u6765\u4ecb\u7ecd\u5982\u4f55\u5728 Kubernetes \u4e2d\u67e5\u8be2 OpenStack \u7684\u7f51\u7edc\u8d44\u6e90\u5e76\u5728 OpenStack \u7684\u5b50\u7f51\u4e2d\u521b\u5efa Pod\u3002 \u67e5\u8be2 OpenStack \u4e2d\u5df2\u6709\u7684\u7f51\u7edc\u8d44\u6e90\uff0c\u5982\u4e0b\u8d44\u6e90\u5df2\u7ecf\u9884\u5148\u521b\u5efa\u5b8c\u6210\uff1a # openstack router list +--------------------------------------+---------+--------+-------+----------------------------------+ | ID | Name | Status | State | Project | +--------------------------------------+---------+--------+-------+----------------------------------+ | 22040ed5-0598-4f77-bffd-e7fd4db47e93 | router0 | ACTIVE | UP | 62381a21d569404aa236a5dd8712449c | +--------------------------------------+---------+--------+-------+----------------------------------+ # openstack network list +--------------------------------------+----------+--------------------------------------+ | ID | Name | Subnets | +--------------------------------------+----------+--------------------------------------+ | cd59e36a-37db-4c27-b709-d35379a7920f | provider | 01d73d9f-fdaa-426c-9b60-aa34abbfacae | +--------------------------------------+----------+--------------------------------------+ # openstack subnet list +--------------------------------------+-------------+--------------------------------------+----------------+ | ID | Name | Network | Subnet | +--------------------------------------+-------------+--------------------------------------+----------------+ | 01d73d9f-fdaa-426c-9b60-aa34abbfacae | provider-v4 | cd59e36a-37db-4c27-b709-d35379a7920f | 192.168.1.0/24 | +--------------------------------------+-------------+--------------------------------------+----------------+ # openstack server list +--------------------------------------+-------------------+--------+-----------------------+--------+--------+ | ID | Name | Status | Networks | Image | Flavor | +--------------------------------------+-------------------+--------+-----------------------+--------+--------+ | 8433d622-a8d6-41a7-8b31-49abfd64f639 | provider-instance | ACTIVE | provider=192.168.1.61 | ubuntu | m1 | +--------------------------------------+-------------------+--------+-----------------------+--------+--------+ \u5728 Kubernetes \u4fa7\uff0c\u67e5\u8be2 VPC \u8d44\u6e90\uff1a # kubectl get vpc NAME STANDBY SUBNETS neutron-22040ed5-0598-4f77-bffd-e7fd4db47e93 true [\"neutron-cd59e36a-37db-4c27-b709-d35379a7920f\"] ovn-cluster true [\"join\",\"ovn-default\"] neutron-22040ed5-0598-4f77-bffd-e7fd4db47e93 \u4e3a\u4ece OpenStack \u540c\u6b65\u8fc7\u6765\u7684 VPC \u8d44\u6e90\u3002 \u63a5\u4e0b\u6765\u53ef\u4ee5\u6309\u7167 Kube-OVN \u539f\u751f\u7684 VPC \u548c Subnet \u64cd\u4f5c\u521b\u5efa Pod \u5e76\u8fd0\u884c\u3002 VPC, Subnet \u7ed1\u5b9a Namespace net2 \uff0c\u5e76\u521b\u5efa Pod: apiVersion: v1 kind: Namespace metadata: name: net2 --- apiVersion: kubeovn.io/v1 kind: Vpc metadata: creationTimestamp: \"2021-06-20T13:34:11Z\" generation: 2 labels: ovn.kubernetes.io/vpc_external: \"true\" name: neutron-22040ed5-0598-4f77-bffd-e7fd4db47e93 resourceVersion: \"583728\" uid: 18d4c654-f511-4def-a3a0-a6434d237c1e spec: namespaces: - net2 --- kind: Subnet apiVersion: kubeovn.io/v1 metadata: name: net2 spec: vpc: neutron-22040ed5-0598-4f77-bffd-e7fd4db47e93 namespaces: - net2 cidrBlock: 12.0.1.0/24 natOutgoing: false --- apiVersion: v1 kind: Pod metadata: name: ubuntu namespace: net2 spec: containers: - image: kubeovn/kube-ovn:v1.8.0 command: - \"sleep\" - \"604800\" imagePullPolicy: IfNotPresent name: ubuntu restartPolicy: Always","title":"\u5728 Kubernetes \u4e2d\u4f7f\u7528 OpenStack \u5185\u8d44\u6e90"},{"location":"advance/with-ovn-ic/","text":"\u4f7f\u7528 OVN-IC \u8fdb\u884c\u591a\u96c6\u7fa4\u4e92\u8054 Kube-OVN \u652f\u6301\u901a\u8fc7 OVN-IC \u5c06\u4e24\u4e2a Kubernetes \u96c6\u7fa4 Pod \u7f51\u7edc\u6253\u901a\uff0c\u6253\u901a\u540e\u7684\u4e24\u4e2a\u96c6\u7fa4\u5185\u7684 Pod \u53ef\u4ee5\u901a\u8fc7 Pod IP \u8fdb\u884c\u76f4\u63a5\u901a\u4fe1\u3002 Kube-OVN \u4f7f\u7528\u96a7\u9053\u5bf9\u8de8\u96c6\u7fa4\u6d41\u91cf\u8fdb\u884c\u5c01\u88c5\uff0c\u4e24\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u53ea\u8981\u5b58\u5728\u4e00\u7ec4 IP \u53ef\u8fbe\u7684\u673a\u5668\u5373\u53ef\u5b8c\u6210\u5bb9\u5668\u7f51\u7edc\u7684\u4e92\u901a\u3002 \u8be5\u6a21\u5f0f\u7684\u591a\u96c6\u7fa4\u4e92\u8054\u4e3a Overlay \u7f51\u7edc\u529f\u80fd\uff0cUnderlay \u7f51\u7edc\u5982\u679c\u60f3\u8981\u5b9e\u73b0\u96c6\u7fa4\u4e92\u8054\u9700\u8981\u5e95\u5c42\u57fa\u7840\u8bbe\u65bd\u505a\u7f51\u7edc\u6253\u901a\u3002 \u524d\u63d0\u6761\u4ef6 \u81ea\u52a8\u4e92\u8054\u6a21\u5f0f\u4e0b\u4e0d\u540c\u96c6\u7fa4\u7684\u5b50\u7f51 CIDR \u4e0d\u80fd\u76f8\u4e92\u91cd\u53e0\uff0c\u9ed8\u8ba4\u5b50\u7f51\u9700\u5728\u5b89\u88c5\u65f6\u914d\u7f6e\u4e3a\u4e0d\u91cd\u53e0\u7684\u7f51\u6bb5\u3002\u82e5\u5b58\u5728\u91cd\u53e0\u9700\u53c2\u8003\u540e\u7eed\u624b\u52a8\u4e92\u8054\u8fc7\u7a0b\uff0c\u53ea\u80fd\u5c06\u4e0d\u91cd\u53e0\u7f51\u6bb5\u6253\u901a\u3002 \u9700\u8981\u5b58\u5728\u4e00\u7ec4\u673a\u5668\u53ef\u4ee5\u88ab\u6bcf\u4e2a\u96c6\u7fa4\u7684 kube-ovn-controller \u901a\u8fc7 IP \u8bbf\u95ee\uff0c\u7528\u6765\u90e8\u7f72\u8de8\u96c6\u7fa4\u4e92\u8054\u7684\u63a7\u5236\u5668\u3002 \u6bcf\u4e2a\u96c6\u7fa4\u9700\u8981\u6709\u4e00\u7ec4\u53ef\u4ee5\u901a\u8fc7 IP \u8fdb\u884c\u8de8\u96c6\u7fa4\u4e92\u8bbf\u7684\u673a\u5668\u4f5c\u4e3a\u4e4b\u540e\u7684\u7f51\u5173\u8282\u70b9\u3002 \u8be5\u529f\u80fd\u53ea\u5bf9\u9ed8\u8ba4 VPC \u751f\u6548\uff0c\u7528\u6237\u81ea\u5b9a\u4e49 VPC \u65e0\u6cd5\u4f7f\u7528\u4e92\u8054\u529f\u80fd\u3002 \u90e8\u7f72\u5355\u8282\u70b9 OVN-IC \u6570\u636e\u5e93 \u5728\u6bcf\u4e2a\u96c6\u7fa4 kube-ovn-controller \u53ef\u901a\u8fc7 IP \u8bbf\u95ee\u7684\u673a\u5668\u4e0a\u90e8\u7f72 OVN-IC \u6570\u636e\u5e93\uff0c\u8be5\u8282\u70b9\u5c06\u4fdd\u5b58\u5404\u4e2a\u96c6\u7fa4\u540c\u6b65\u4e0a\u6765\u7684\u7f51\u7edc\u914d\u7f6e\u4fe1\u606f\u3002 \u90e8\u7f72 docker \u7684\u73af\u5883\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u542f\u52a8 OVN-IC \u6570\u636e\u5e93\uff1a docker run --name=ovn-ic-db -d --network=host -v /etc/ovn/:/etc/ovn -v /var/run/ovn:/var/run/ovn -v /var/log/ovn:/var/log/ovn kubeovn/kube-ovn:v1.10.1 bash start-ic-db.sh \u5bf9\u4e8e\u90e8\u7f72 containerd \u53d6\u4ee3 docker \u7684\u73af\u5883\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a ctr -n k8s.io run -d --net-host --mount=\"type=bind,src=/etc/ovn/,dst=/etc/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/run/ovn,dst=/var/run/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/log/ovn,dst=/var/log/ovn,options=rbind:rw\" docker.io/kubeovn/kube-ovn:v1.10.1 ovn-ic-db bash start-ic-db.sh \u81ea\u52a8\u8def\u7531\u8bbe\u7f6e \u5728\u81ea\u52a8\u8def\u7531\u8bbe\u7f6e\u4e0b\uff0c\u6bcf\u4e2a\u96c6\u7fa4\u4f1a\u5c06\u81ea\u5df1\u9ed8\u8ba4 VPC \u4e0b Subnet \u7684 CIDR \u4fe1\u606f\u540c\u6b65\u7ed9 OVN-IC \uff0c\u56e0\u6b64\u8981\u786e\u4fdd\u4e24\u4e2a\u96c6\u7fa4\u7684 Subnet CIDR \u4e0d\u5b58\u5728\u91cd\u53e0\u3002 \u5728 kube-system Namespace \u4e0b\u521b\u5efa ovn-ic-config ConfigMap\uff1a apiVersion: v1 kind: ConfigMap metadata: name: ovn-ic-config namespace: kube-system data: enable-ic: \"true\" az-name: \"az1\" ic-db-host: \"192.168.65.3\" ic-nb-port: \"6645\" ic-sb-port: \"6646\" gw-nodes: \"az1-gw\" auto-route: \"true\" enable-ic : \u662f\u5426\u5f00\u542f\u96c6\u7fa4\u4e92\u8054\u3002 az-name : \u533a\u5206\u4e0d\u540c\u96c6\u7fa4\u7684\u96c6\u7fa4\u540d\u79f0\uff0c\u6bcf\u4e2a\u4e92\u8054\u96c6\u7fa4\u9700\u4e0d\u540c\u3002 ic-db-host : \u90e8\u7f72 OVN-IC \u6570\u636e\u5e93\u7684\u8282\u70b9\u5730\u5740\u3002 ic-nb-port : OVN-IC \u5317\u5411\u6570\u636e\u5e93\uff0c\u9ed8\u8ba4\u4e3a 6645\u3002 ic-sb-port : OVN-IC \u5357\u5411\u6570\u636e\u5e93\uff0c\u9ed8\u8ba4\u4e3a 6646\u3002 gw-nodes : \u96c6\u7fa4\u4e92\u8054\u4e2d\u627f\u62c5\u7f51\u5173\u5de5\u4f5c\u7684\u8282\u70b9\u540d\uff0c\u9017\u53f7\u5206\u9694\u3002 auto-route : \u662f\u5426\u81ea\u52a8\u5bf9\u5916\u53d1\u5e03\u548c\u5b66\u4e60\u8def\u7531\u3002 \u5728 ovn-ic \u5bb9\u5668\u5185\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u662f\u5426\u5df2\u5efa\u7acb\u4e92\u8054\u903b\u8f91\u4ea4\u6362\u673a ts \uff1a # ovn-ic-sbctl show availability-zone az1 gateway deee03e0-af16-4f45-91e9-b50c3960f809 hostname: az1-gw type: geneve ip: 192.168.42.145 port ts-az1 transit switch: ts address: [\"00:00:00:50:AC:8C 169.254.100.45/24\"] availability-zone az2 gateway e94cc831-8143-40e3-a478-90352773327b hostname: az2-gw type: geneve ip: 192.168.42.149 port ts-az2 transit switch: ts address: [\"00:00:00:07:4A:59 169.254.100.63/24\"] \u5728\u6bcf\u4e2a\u96c6\u7fa4\u89c2\u5bdf\u903b\u8f91\u8def\u7531\u662f\u5426\u6709\u5b66\u4e60\u5230\u7684\u5bf9\u7aef\u8def\u7531\uff1a # kubectl ko nbctl lr-route-list ovn-cluster IPv4 Routes 10.42.1.1 169.254.100.45 dst-ip (learned) 10.42.1.3 100.64.0.2 dst-ip 10.16.0.2 100.64.0.2 src-ip 10.16.0.3 100.64.0.2 src-ip 10.16.0.4 100.64.0.2 src-ip 10.16.0.6 100.64.0.2 src-ip 10.17.0.0/16 169.254.100.45 dst-ip (learned) 100.65.0.0/16 169.254.100.45 dst-ip (learned) \u63a5\u4e0b\u6765\u53ef\u4ee5\u5c1d\u8bd5\u5728\u96c6\u7fa4 1 \u5185\u7684\u4e00\u4e2a Pod \u5185\u76f4\u63a5 ping \u96c6\u7fa4 2 \u5185\u7684\u4e00\u4e2a Pod IP \u89c2\u5bdf\u662f\u5426\u53ef\u4ee5\u8054\u901a\u3002 \u5bf9\u4e8e\u67d0\u4e2a\u4e0d\u60f3\u5bf9\u5916\u81ea\u52a8\u53d1\u5e03\u8def\u7531\u7684\u5b50\u7f51\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 Subnet \u91cc\u7684 disableInterConnection \u6765\u7981\u6b62\u8def\u7531\u5e7f\u64ad\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: no-advertise spec: cidrBlock: 10.199.0.0/16 disableInterConnection: true \u624b\u52a8\u8def\u7531\u8bbe\u7f6e \u5bf9\u4e8e\u96c6\u7fa4\u95f4\u5b58\u5728\u91cd\u53e0 CIDR \u53ea\u5e0c\u671b\u505a\u90e8\u5206\u5b50\u7f51\u6253\u901a\u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u6b65\u9aa4\u624b\u52a8\u53d1\u5e03\u5b50\u7f51\u8def\u7531\u3002 \u5728 kube-system Namespace \u4e0b\u521b\u5efa ovn-ic-config ConfigMap\uff0c\u5e76\u5c06 auto-route \u8bbe\u7f6e\u4e3a false \uff1a apiVersion: v1 kind: ConfigMap metadata: name: ovn-ic-config namespace: kube-system data: enable-ic: \"true\" az-name: \"az1\" ic-db-host: \"192.168.65.3\" ic-nb-port: \"6645\" ic-sb-port: \"6646\" gw-nodes: \"az1-gw\" auto-route: \"true\" \u5728\u6bcf\u4e2a\u96c6\u7fa4\u5206\u522b\u67e5\u770b\u8fdc\u7aef\u903b\u8f91\u7aef\u53e3\u7684\u5730\u5740\uff0c\u7528\u4e8e\u4e4b\u540e\u624b\u52a8\u914d\u7f6e\u8def\u7531\uff1a [root@az1 ~]# kubectl ko nbctl show switch a391d3a1-14a0-4841-9836-4bd930c447fb (ts) port ts-az1 type: router router-port: az1-ts port ts-az2 type: remote addresses: [\"00:00:00:4B:E2:9F 169.254.100.31/24\"] [root@az2 ~]# kubectl ko nbctl show switch da6138b8-de81-4908-abf9-b2224ec4edf3 (ts) port ts-az2 type: router router-port: az2-ts port ts-az1 type: remote addresses: [\"00:00:00:FB:2A:F7 169.254.100.79/24\"] \u7531\u4e0a\u8f93\u51fa\u53ef\u77e5\uff0c\u96c6\u7fa4 az1 \u5230 \u96c6\u7fa4 az2 \u7684\u8fdc\u7aef\u5730\u5740\u4e3a 169.254.100.31 \uff0c az2 \u5230 az1 \u7684\u8fdc\u7aef\u5730\u5740\u4e3a 169.254.100.79 \u3002 \u4e0b\u9762\u624b\u52a8\u8bbe\u7f6e\u8def\u7531\uff0c\u5728\u8be5\u4f8b\u5b50\u4e2d\uff0c\u96c6\u7fa4 az1 \u5185\u7684\u5b50\u7f51 CIDR \u4e3a 10.16.0.0/24 \uff0c\u96c6\u7fa4 az2 \u5185\u7684\u5b50\u7f51 CIDR \u4e3a 10.17.0.0/24 \u3002 \u5728\u96c6\u7fa4 az1 \u8bbe\u7f6e\u5230\u96c6\u7fa4 az2 \u7684\u8def\u7531: kubectl ko nbctl lr-route-add ovn-cluster 10.17.0.0/24 169.254.100.31 \u5728\u96c6\u7fa4 az2 \u8bbe\u7f6e\u5230\u96c6\u7fa4 az1 \u7684\u8def\u7531: kubectl ko nbctl lr-route-add ovn-cluster 10.16.0.0/24 169.254.100.79 \u9ad8\u53ef\u7528 OVN-IC \u6570\u636e\u5e93\u90e8\u7f72 OVN-IC \u6570\u636e\u5e93\u4e4b\u95f4\u53ef\u4ee5\u901a\u8fc7 Raft \u534f\u8bae\u7ec4\u6210\u4e00\u4e2a\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u8be5\u90e8\u7f72\u6a21\u5f0f\u9700\u8981\u81f3\u5c11 3 \u4e2a\u8282\u70b9\u3002 \u9996\u5148\u5728\u7b2c\u4e00\u4e2a\u8282\u70b9\u4e0a\u542f\u52a8 OVN-IC \u6570\u636e\u5e93\u7684 leader\u3002 \u90e8\u7f72 docker \u73af\u5883\u7684\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a docker run --name=ovn-ic-db -d --network=host -v /etc/ovn/:/etc/ovn -v /var/run/ovn:/var/run/ovn -v /var/log/ovn:/var/log/ovn -e LOCAL_IP=\"192.168.65.3\" -e NODE_IPS=\"192.168.65.3,192.168.65.2,192.168.65.1\" kubeovn/kube-ovn:v1.10.1 bash start-ic-db.sh \u5982\u679c\u662f\u90e8\u7f72 containerd \u7684\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a ctr -n k8s.io run -d --net-host --mount=\"type=bind,src=/etc/ovn/,dst=/etc/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/run/ovn,dst=/var/run/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/log/ovn,dst=/var/log/ovn,options=rbind:rw\" --env=\"NODE_IPS=\"192.168.65.3,192.168.65.2,192.168.65.1\"\" --env=\"LOCAL_IP=\"192.168.65.3\"\" docker.io/kubeovn/kube-ovn:v1.10.1 ovn-ic-db bash start-ic-db.sh LOCAL_IP \uff1a \u5f53\u524d\u5bb9\u5668\u6240\u5728\u8282\u70b9 IP \u5730\u5740\u3002 NODE_IPS \uff1a \u8fd0\u884c OVN-IC \u6570\u636e\u5e93\u7684\u4e09\u4e2a\u8282\u70b9 IP \u5730\u5740\uff0c\u4f7f\u7528\u9017\u53f7\u8fdb\u884c\u5206\u9694\u3002 \u63a5\u4e0b\u6765\uff0c\u5728\u53e6\u5916\u4e24\u4e2a\u8282\u70b9\u90e8\u7f72 OVN-IC \u6570\u636e\u5e93\u7684 follower\u3002 \u90e8\u7f72 docker \u73af\u5883\u7684\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a docker run --name=ovn-ic-db -d --network=host -v /etc/ovn/:/etc/ovn -v /var/run/ovn:/var/run/ovn -v /var/log/ovn:/var/log/ovn -e LOCAL_IP=\"192.168.65.2\" -e NODE_IPS=\"192.168.65.3,192.168.65.2,192.168.65.1\" -e LEADER_IP=\"192.168.65.3\" kubeovn/kube-ovn:v1.10.1 bash start-ic-db.sh \u5982\u679c\u662f\u90e8\u7f72 containerd \u7684\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a ctr -n k8s.io run -d --net-host --mount=\"type=bind,src=/etc/ovn/,dst=/etc/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/run/ovn,dst=/var/run/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/log/ovn,dst=/var/log/ovn,options=rbind:rw\" --env=\"NODE_IPS=\"192.168.65.3,192.168.65.2,192.168.65.1\"\" --env=\"LOCAL_IP=\"192.168.65.2\"\" --env=\"LEADER_IP=\"192.168.65.3\"\" docker.io/kubeovn/kube-ovn:v1.10.1 ovn-ic-db bash start-ic-db.sh LOCAL_IP \uff1a \u5f53\u524d\u5bb9\u5668\u6240\u5728\u8282\u70b9 IP \u5730\u5740\u3002 NODE_IPS \uff1a \u8fd0\u884c OVN-IC \u6570\u636e\u5e93\u7684\u4e09\u4e2a\u8282\u70b9 IP \u5730\u5740\uff0c\u4f7f\u7528\u9017\u53f7\u8fdb\u884c\u5206\u9694\u3002 LEADER_IP : \u8fd0\u884c OVN-IC \u6570\u636e\u5e93 leader \u8282\u70b9\u7684 IP \u5730\u5740\u3002 \u5728\u6bcf\u4e2a\u96c6\u7fa4\u521b\u5efa ovn-ic-config \u65f6\u6307\u5b9a\u591a\u4e2a OVN-IC \u6570\u636e\u5e93\u8282\u70b9\u5730\u5740\uff1a apiVersion: v1 kind: ConfigMap metadata: name: ovn-ic-config namespace: kube-system data: enable-ic: \"true\" az-name: \"az1\" ic-db-host: \"192.168.65.3,192.168.65.2,192.168.65.1\" ic-nb-port: \"6645\" ic-sb-port: \"6646\" gw-nodes: \"az1-gw\" auto-route: \"false\"","title":"\u4f7f\u7528 OVN-IC \u8fdb\u884c\u591a\u96c6\u7fa4\u4e92\u8054"},{"location":"advance/with-ovn-ic/#ovn-ic","text":"Kube-OVN \u652f\u6301\u901a\u8fc7 OVN-IC \u5c06\u4e24\u4e2a Kubernetes \u96c6\u7fa4 Pod \u7f51\u7edc\u6253\u901a\uff0c\u6253\u901a\u540e\u7684\u4e24\u4e2a\u96c6\u7fa4\u5185\u7684 Pod \u53ef\u4ee5\u901a\u8fc7 Pod IP \u8fdb\u884c\u76f4\u63a5\u901a\u4fe1\u3002 Kube-OVN \u4f7f\u7528\u96a7\u9053\u5bf9\u8de8\u96c6\u7fa4\u6d41\u91cf\u8fdb\u884c\u5c01\u88c5\uff0c\u4e24\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u53ea\u8981\u5b58\u5728\u4e00\u7ec4 IP \u53ef\u8fbe\u7684\u673a\u5668\u5373\u53ef\u5b8c\u6210\u5bb9\u5668\u7f51\u7edc\u7684\u4e92\u901a\u3002 \u8be5\u6a21\u5f0f\u7684\u591a\u96c6\u7fa4\u4e92\u8054\u4e3a Overlay \u7f51\u7edc\u529f\u80fd\uff0cUnderlay \u7f51\u7edc\u5982\u679c\u60f3\u8981\u5b9e\u73b0\u96c6\u7fa4\u4e92\u8054\u9700\u8981\u5e95\u5c42\u57fa\u7840\u8bbe\u65bd\u505a\u7f51\u7edc\u6253\u901a\u3002","title":"\u4f7f\u7528 OVN-IC \u8fdb\u884c\u591a\u96c6\u7fa4\u4e92\u8054"},{"location":"advance/with-ovn-ic/#_1","text":"\u81ea\u52a8\u4e92\u8054\u6a21\u5f0f\u4e0b\u4e0d\u540c\u96c6\u7fa4\u7684\u5b50\u7f51 CIDR \u4e0d\u80fd\u76f8\u4e92\u91cd\u53e0\uff0c\u9ed8\u8ba4\u5b50\u7f51\u9700\u5728\u5b89\u88c5\u65f6\u914d\u7f6e\u4e3a\u4e0d\u91cd\u53e0\u7684\u7f51\u6bb5\u3002\u82e5\u5b58\u5728\u91cd\u53e0\u9700\u53c2\u8003\u540e\u7eed\u624b\u52a8\u4e92\u8054\u8fc7\u7a0b\uff0c\u53ea\u80fd\u5c06\u4e0d\u91cd\u53e0\u7f51\u6bb5\u6253\u901a\u3002 \u9700\u8981\u5b58\u5728\u4e00\u7ec4\u673a\u5668\u53ef\u4ee5\u88ab\u6bcf\u4e2a\u96c6\u7fa4\u7684 kube-ovn-controller \u901a\u8fc7 IP \u8bbf\u95ee\uff0c\u7528\u6765\u90e8\u7f72\u8de8\u96c6\u7fa4\u4e92\u8054\u7684\u63a7\u5236\u5668\u3002 \u6bcf\u4e2a\u96c6\u7fa4\u9700\u8981\u6709\u4e00\u7ec4\u53ef\u4ee5\u901a\u8fc7 IP \u8fdb\u884c\u8de8\u96c6\u7fa4\u4e92\u8bbf\u7684\u673a\u5668\u4f5c\u4e3a\u4e4b\u540e\u7684\u7f51\u5173\u8282\u70b9\u3002 \u8be5\u529f\u80fd\u53ea\u5bf9\u9ed8\u8ba4 VPC \u751f\u6548\uff0c\u7528\u6237\u81ea\u5b9a\u4e49 VPC \u65e0\u6cd5\u4f7f\u7528\u4e92\u8054\u529f\u80fd\u3002","title":"\u524d\u63d0\u6761\u4ef6"},{"location":"advance/with-ovn-ic/#ovn-ic_1","text":"\u5728\u6bcf\u4e2a\u96c6\u7fa4 kube-ovn-controller \u53ef\u901a\u8fc7 IP \u8bbf\u95ee\u7684\u673a\u5668\u4e0a\u90e8\u7f72 OVN-IC \u6570\u636e\u5e93\uff0c\u8be5\u8282\u70b9\u5c06\u4fdd\u5b58\u5404\u4e2a\u96c6\u7fa4\u540c\u6b65\u4e0a\u6765\u7684\u7f51\u7edc\u914d\u7f6e\u4fe1\u606f\u3002 \u90e8\u7f72 docker \u7684\u73af\u5883\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u542f\u52a8 OVN-IC \u6570\u636e\u5e93\uff1a docker run --name=ovn-ic-db -d --network=host -v /etc/ovn/:/etc/ovn -v /var/run/ovn:/var/run/ovn -v /var/log/ovn:/var/log/ovn kubeovn/kube-ovn:v1.10.1 bash start-ic-db.sh \u5bf9\u4e8e\u90e8\u7f72 containerd \u53d6\u4ee3 docker \u7684\u73af\u5883\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a ctr -n k8s.io run -d --net-host --mount=\"type=bind,src=/etc/ovn/,dst=/etc/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/run/ovn,dst=/var/run/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/log/ovn,dst=/var/log/ovn,options=rbind:rw\" docker.io/kubeovn/kube-ovn:v1.10.1 ovn-ic-db bash start-ic-db.sh","title":"\u90e8\u7f72\u5355\u8282\u70b9 OVN-IC \u6570\u636e\u5e93"},{"location":"advance/with-ovn-ic/#_2","text":"\u5728\u81ea\u52a8\u8def\u7531\u8bbe\u7f6e\u4e0b\uff0c\u6bcf\u4e2a\u96c6\u7fa4\u4f1a\u5c06\u81ea\u5df1\u9ed8\u8ba4 VPC \u4e0b Subnet \u7684 CIDR \u4fe1\u606f\u540c\u6b65\u7ed9 OVN-IC \uff0c\u56e0\u6b64\u8981\u786e\u4fdd\u4e24\u4e2a\u96c6\u7fa4\u7684 Subnet CIDR \u4e0d\u5b58\u5728\u91cd\u53e0\u3002 \u5728 kube-system Namespace \u4e0b\u521b\u5efa ovn-ic-config ConfigMap\uff1a apiVersion: v1 kind: ConfigMap metadata: name: ovn-ic-config namespace: kube-system data: enable-ic: \"true\" az-name: \"az1\" ic-db-host: \"192.168.65.3\" ic-nb-port: \"6645\" ic-sb-port: \"6646\" gw-nodes: \"az1-gw\" auto-route: \"true\" enable-ic : \u662f\u5426\u5f00\u542f\u96c6\u7fa4\u4e92\u8054\u3002 az-name : \u533a\u5206\u4e0d\u540c\u96c6\u7fa4\u7684\u96c6\u7fa4\u540d\u79f0\uff0c\u6bcf\u4e2a\u4e92\u8054\u96c6\u7fa4\u9700\u4e0d\u540c\u3002 ic-db-host : \u90e8\u7f72 OVN-IC \u6570\u636e\u5e93\u7684\u8282\u70b9\u5730\u5740\u3002 ic-nb-port : OVN-IC \u5317\u5411\u6570\u636e\u5e93\uff0c\u9ed8\u8ba4\u4e3a 6645\u3002 ic-sb-port : OVN-IC \u5357\u5411\u6570\u636e\u5e93\uff0c\u9ed8\u8ba4\u4e3a 6646\u3002 gw-nodes : \u96c6\u7fa4\u4e92\u8054\u4e2d\u627f\u62c5\u7f51\u5173\u5de5\u4f5c\u7684\u8282\u70b9\u540d\uff0c\u9017\u53f7\u5206\u9694\u3002 auto-route : \u662f\u5426\u81ea\u52a8\u5bf9\u5916\u53d1\u5e03\u548c\u5b66\u4e60\u8def\u7531\u3002 \u5728 ovn-ic \u5bb9\u5668\u5185\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u662f\u5426\u5df2\u5efa\u7acb\u4e92\u8054\u903b\u8f91\u4ea4\u6362\u673a ts \uff1a # ovn-ic-sbctl show availability-zone az1 gateway deee03e0-af16-4f45-91e9-b50c3960f809 hostname: az1-gw type: geneve ip: 192.168.42.145 port ts-az1 transit switch: ts address: [\"00:00:00:50:AC:8C 169.254.100.45/24\"] availability-zone az2 gateway e94cc831-8143-40e3-a478-90352773327b hostname: az2-gw type: geneve ip: 192.168.42.149 port ts-az2 transit switch: ts address: [\"00:00:00:07:4A:59 169.254.100.63/24\"] \u5728\u6bcf\u4e2a\u96c6\u7fa4\u89c2\u5bdf\u903b\u8f91\u8def\u7531\u662f\u5426\u6709\u5b66\u4e60\u5230\u7684\u5bf9\u7aef\u8def\u7531\uff1a # kubectl ko nbctl lr-route-list ovn-cluster IPv4 Routes 10.42.1.1 169.254.100.45 dst-ip (learned) 10.42.1.3 100.64.0.2 dst-ip 10.16.0.2 100.64.0.2 src-ip 10.16.0.3 100.64.0.2 src-ip 10.16.0.4 100.64.0.2 src-ip 10.16.0.6 100.64.0.2 src-ip 10.17.0.0/16 169.254.100.45 dst-ip (learned) 100.65.0.0/16 169.254.100.45 dst-ip (learned) \u63a5\u4e0b\u6765\u53ef\u4ee5\u5c1d\u8bd5\u5728\u96c6\u7fa4 1 \u5185\u7684\u4e00\u4e2a Pod \u5185\u76f4\u63a5 ping \u96c6\u7fa4 2 \u5185\u7684\u4e00\u4e2a Pod IP \u89c2\u5bdf\u662f\u5426\u53ef\u4ee5\u8054\u901a\u3002 \u5bf9\u4e8e\u67d0\u4e2a\u4e0d\u60f3\u5bf9\u5916\u81ea\u52a8\u53d1\u5e03\u8def\u7531\u7684\u5b50\u7f51\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 Subnet \u91cc\u7684 disableInterConnection \u6765\u7981\u6b62\u8def\u7531\u5e7f\u64ad\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: no-advertise spec: cidrBlock: 10.199.0.0/16 disableInterConnection: true","title":"\u81ea\u52a8\u8def\u7531\u8bbe\u7f6e"},{"location":"advance/with-ovn-ic/#_3","text":"\u5bf9\u4e8e\u96c6\u7fa4\u95f4\u5b58\u5728\u91cd\u53e0 CIDR \u53ea\u5e0c\u671b\u505a\u90e8\u5206\u5b50\u7f51\u6253\u901a\u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u6b65\u9aa4\u624b\u52a8\u53d1\u5e03\u5b50\u7f51\u8def\u7531\u3002 \u5728 kube-system Namespace \u4e0b\u521b\u5efa ovn-ic-config ConfigMap\uff0c\u5e76\u5c06 auto-route \u8bbe\u7f6e\u4e3a false \uff1a apiVersion: v1 kind: ConfigMap metadata: name: ovn-ic-config namespace: kube-system data: enable-ic: \"true\" az-name: \"az1\" ic-db-host: \"192.168.65.3\" ic-nb-port: \"6645\" ic-sb-port: \"6646\" gw-nodes: \"az1-gw\" auto-route: \"true\" \u5728\u6bcf\u4e2a\u96c6\u7fa4\u5206\u522b\u67e5\u770b\u8fdc\u7aef\u903b\u8f91\u7aef\u53e3\u7684\u5730\u5740\uff0c\u7528\u4e8e\u4e4b\u540e\u624b\u52a8\u914d\u7f6e\u8def\u7531\uff1a [root@az1 ~]# kubectl ko nbctl show switch a391d3a1-14a0-4841-9836-4bd930c447fb (ts) port ts-az1 type: router router-port: az1-ts port ts-az2 type: remote addresses: [\"00:00:00:4B:E2:9F 169.254.100.31/24\"] [root@az2 ~]# kubectl ko nbctl show switch da6138b8-de81-4908-abf9-b2224ec4edf3 (ts) port ts-az2 type: router router-port: az2-ts port ts-az1 type: remote addresses: [\"00:00:00:FB:2A:F7 169.254.100.79/24\"] \u7531\u4e0a\u8f93\u51fa\u53ef\u77e5\uff0c\u96c6\u7fa4 az1 \u5230 \u96c6\u7fa4 az2 \u7684\u8fdc\u7aef\u5730\u5740\u4e3a 169.254.100.31 \uff0c az2 \u5230 az1 \u7684\u8fdc\u7aef\u5730\u5740\u4e3a 169.254.100.79 \u3002 \u4e0b\u9762\u624b\u52a8\u8bbe\u7f6e\u8def\u7531\uff0c\u5728\u8be5\u4f8b\u5b50\u4e2d\uff0c\u96c6\u7fa4 az1 \u5185\u7684\u5b50\u7f51 CIDR \u4e3a 10.16.0.0/24 \uff0c\u96c6\u7fa4 az2 \u5185\u7684\u5b50\u7f51 CIDR \u4e3a 10.17.0.0/24 \u3002 \u5728\u96c6\u7fa4 az1 \u8bbe\u7f6e\u5230\u96c6\u7fa4 az2 \u7684\u8def\u7531: kubectl ko nbctl lr-route-add ovn-cluster 10.17.0.0/24 169.254.100.31 \u5728\u96c6\u7fa4 az2 \u8bbe\u7f6e\u5230\u96c6\u7fa4 az1 \u7684\u8def\u7531: kubectl ko nbctl lr-route-add ovn-cluster 10.16.0.0/24 169.254.100.79","title":"\u624b\u52a8\u8def\u7531\u8bbe\u7f6e"},{"location":"advance/with-ovn-ic/#ovn-ic_2","text":"OVN-IC \u6570\u636e\u5e93\u4e4b\u95f4\u53ef\u4ee5\u901a\u8fc7 Raft \u534f\u8bae\u7ec4\u6210\u4e00\u4e2a\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u8be5\u90e8\u7f72\u6a21\u5f0f\u9700\u8981\u81f3\u5c11 3 \u4e2a\u8282\u70b9\u3002 \u9996\u5148\u5728\u7b2c\u4e00\u4e2a\u8282\u70b9\u4e0a\u542f\u52a8 OVN-IC \u6570\u636e\u5e93\u7684 leader\u3002 \u90e8\u7f72 docker \u73af\u5883\u7684\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a docker run --name=ovn-ic-db -d --network=host -v /etc/ovn/:/etc/ovn -v /var/run/ovn:/var/run/ovn -v /var/log/ovn:/var/log/ovn -e LOCAL_IP=\"192.168.65.3\" -e NODE_IPS=\"192.168.65.3,192.168.65.2,192.168.65.1\" kubeovn/kube-ovn:v1.10.1 bash start-ic-db.sh \u5982\u679c\u662f\u90e8\u7f72 containerd \u7684\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a ctr -n k8s.io run -d --net-host --mount=\"type=bind,src=/etc/ovn/,dst=/etc/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/run/ovn,dst=/var/run/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/log/ovn,dst=/var/log/ovn,options=rbind:rw\" --env=\"NODE_IPS=\"192.168.65.3,192.168.65.2,192.168.65.1\"\" --env=\"LOCAL_IP=\"192.168.65.3\"\" docker.io/kubeovn/kube-ovn:v1.10.1 ovn-ic-db bash start-ic-db.sh LOCAL_IP \uff1a \u5f53\u524d\u5bb9\u5668\u6240\u5728\u8282\u70b9 IP \u5730\u5740\u3002 NODE_IPS \uff1a \u8fd0\u884c OVN-IC \u6570\u636e\u5e93\u7684\u4e09\u4e2a\u8282\u70b9 IP \u5730\u5740\uff0c\u4f7f\u7528\u9017\u53f7\u8fdb\u884c\u5206\u9694\u3002 \u63a5\u4e0b\u6765\uff0c\u5728\u53e6\u5916\u4e24\u4e2a\u8282\u70b9\u90e8\u7f72 OVN-IC \u6570\u636e\u5e93\u7684 follower\u3002 \u90e8\u7f72 docker \u73af\u5883\u7684\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a docker run --name=ovn-ic-db -d --network=host -v /etc/ovn/:/etc/ovn -v /var/run/ovn:/var/run/ovn -v /var/log/ovn:/var/log/ovn -e LOCAL_IP=\"192.168.65.2\" -e NODE_IPS=\"192.168.65.3,192.168.65.2,192.168.65.1\" -e LEADER_IP=\"192.168.65.3\" kubeovn/kube-ovn:v1.10.1 bash start-ic-db.sh \u5982\u679c\u662f\u90e8\u7f72 containerd \u7684\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a ctr -n k8s.io run -d --net-host --mount=\"type=bind,src=/etc/ovn/,dst=/etc/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/run/ovn,dst=/var/run/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/log/ovn,dst=/var/log/ovn,options=rbind:rw\" --env=\"NODE_IPS=\"192.168.65.3,192.168.65.2,192.168.65.1\"\" --env=\"LOCAL_IP=\"192.168.65.2\"\" --env=\"LEADER_IP=\"192.168.65.3\"\" docker.io/kubeovn/kube-ovn:v1.10.1 ovn-ic-db bash start-ic-db.sh LOCAL_IP \uff1a \u5f53\u524d\u5bb9\u5668\u6240\u5728\u8282\u70b9 IP \u5730\u5740\u3002 NODE_IPS \uff1a \u8fd0\u884c OVN-IC \u6570\u636e\u5e93\u7684\u4e09\u4e2a\u8282\u70b9 IP \u5730\u5740\uff0c\u4f7f\u7528\u9017\u53f7\u8fdb\u884c\u5206\u9694\u3002 LEADER_IP : \u8fd0\u884c OVN-IC \u6570\u636e\u5e93 leader \u8282\u70b9\u7684 IP \u5730\u5740\u3002 \u5728\u6bcf\u4e2a\u96c6\u7fa4\u521b\u5efa ovn-ic-config \u65f6\u6307\u5b9a\u591a\u4e2a OVN-IC \u6570\u636e\u5e93\u8282\u70b9\u5730\u5740\uff1a apiVersion: v1 kind: ConfigMap metadata: name: ovn-ic-config namespace: kube-system data: enable-ic: \"true\" az-name: \"az1\" ic-db-host: \"192.168.65.3,192.168.65.2,192.168.65.1\" ic-nb-port: \"6645\" ic-sb-port: \"6646\" gw-nodes: \"az1-gw\" auto-route: \"false\"","title":"\u9ad8\u53ef\u7528 OVN-IC \u6570\u636e\u5e93\u90e8\u7f72"},{"location":"advance/with-submariner/","text":"\u4f7f\u7528 Submariner \u8fdb\u884c\u591a\u96c6\u7fa4\u4e92\u8054 Submariner \u4f5c\u4e3a\u53ef\u4ee5\u6253\u901a\u591a\u4e2a Kubernetes \u96c6\u7fa4 Pod \u548c Service \u7f51\u7edc\u7684\u5f00\u6e90\u7f51\u7edc\u7ec4\u4ef6\uff0c\u80fd\u591f\u5e2e\u52a9 Kube-OVN \u5b9e\u73b0\u591a\u96c6\u7fa4\u4e92\u8054\u3002 \u76f8\u6bd4\u901a\u8fc7 OVN-IC \u6253\u901a\u591a\u96c6\u7fa4\u7f51\u7edc\u7684\u65b9\u5f0f\uff0cSubmariner \u53ef\u4ee5\u6253\u901a Kube-OVN \u548c\u975e Kube-OVN \u7684\u96c6\u7fa4\u7f51\u7edc\uff0c\u5e76 \u80fd\u63d0\u4f9b Service \u7684\u8de8\u96c6\u7fa4\u80fd\u529b\u3002\u4f46\u662f Submariner \u76ee\u524d\u53ea\u80fd\u5b9e\u73b0\u9ed8\u8ba4\u5b50\u7f51\u7684\u6253\u901a\uff0c\u65e0\u6cd5\u5b9e\u73b0\u591a\u5b50\u7f51\u9009\u62e9\u6027\u6253\u901a\u3002 \u524d\u63d0\u6761\u4ef6 \u4e24\u4e2a\u96c6\u7fa4\u7684 Service CIDR \u548c\u9ed8\u8ba4\u5b50\u7f51\u7684 CIDR \u4e0d\u80fd\u91cd\u53e0\u3002 \u90e8\u7f72 Submariner \u4e0b\u8f7d subctl \u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5e76\u90e8\u7f72\u5230\u76f8\u5e94\u8def\u5f84\uff1a curl -Ls https://get.submariner.io | bash export PATH=$PATH:~/.local/bin echo export PATH=\\$PATH:~/.local/bin >> ~/.profile \u5207\u6362 kubeconfig \u81f3\u5e0c\u671b\u90e8\u7f72 submariner-broker \u7684\u96c6\u7fa4\u8fdb\u884c\u90e8\u7f72\uff1a subctl deploy-broker \u5728\u672c\u6587\u6863\u4e2d cluster0 \u7684\u9ed8\u8ba4\u5b50\u7f51 CIDR \u4e3a 10.16.0.0/16 \uff0c cluster1 \u7684\u9ed8\u8ba4\u5b50\u7f51 CIDR \u4e3a 11.16.0.0/16 \u3002 \u5207\u6362 kubeconfig \u81f3 cluster0 \u6ce8\u518c\u96c6\u7fa4\u81f3 broker\uff0c\u5e76\u6ce8\u518c\u7f51\u5173\u8282\u70b9: subctl join broker-info.subm --clusterid cluster0 --clustercidr 10.16.0.0/16 --natt=false --cable-driver vxlan --health-check=false kubectl label nodes cluster0 submariner.io/gateway=true \u5207\u6362 kubeconfig \u81f3 cluster1 \u6ce8\u518c\u96c6\u7fa4\u81f3 broker\uff0c\u5e76\u6ce8\u518c\u7f51\u5173\u8282\u70b9: subctl join broker-info.subm --clusterid cluster1 --clustercidr 11.16.0.0/16 --natt=false --cable-driver vxlan --health-check=false kubectl label nodes cluster1 submariner.io/gateway=true \u63a5\u4e0b\u6765\u53ef\u4ee5\u5728\u4e24\u4e2a\u96c6\u7fa4\u5185\u5206\u522b\u542f\u52a8 Pod \u5e76\u5c1d\u8bd5\u4f7f\u7528 IP \u8fdb\u884c\u76f8\u4e92\u8bbf\u95ee\u3002 \u5982\u679c\u51fa\u73b0\u7f51\u7edc\u4e92\u901a\u95ee\u9898\u53ef\u901a\u8fc7 subctl \u547d\u4ee4\u8fdb\u884c\u8bca\u65ad\uff1a subctl show all subctl diagnose all \u66f4\u591a Submariner \u76f8\u5173\u64cd\u4f5c\u8bf7\u67e5\u770b Submariner \u7528\u6237\u624b\u518c \u3002","title":"\u4f7f\u7528 Submariner \u8fdb\u884c\u591a\u96c6\u7fa4\u4e92\u8054"},{"location":"advance/with-submariner/#submariner","text":"Submariner \u4f5c\u4e3a\u53ef\u4ee5\u6253\u901a\u591a\u4e2a Kubernetes \u96c6\u7fa4 Pod \u548c Service \u7f51\u7edc\u7684\u5f00\u6e90\u7f51\u7edc\u7ec4\u4ef6\uff0c\u80fd\u591f\u5e2e\u52a9 Kube-OVN \u5b9e\u73b0\u591a\u96c6\u7fa4\u4e92\u8054\u3002 \u76f8\u6bd4\u901a\u8fc7 OVN-IC \u6253\u901a\u591a\u96c6\u7fa4\u7f51\u7edc\u7684\u65b9\u5f0f\uff0cSubmariner \u53ef\u4ee5\u6253\u901a Kube-OVN \u548c\u975e Kube-OVN \u7684\u96c6\u7fa4\u7f51\u7edc\uff0c\u5e76 \u80fd\u63d0\u4f9b Service \u7684\u8de8\u96c6\u7fa4\u80fd\u529b\u3002\u4f46\u662f Submariner \u76ee\u524d\u53ea\u80fd\u5b9e\u73b0\u9ed8\u8ba4\u5b50\u7f51\u7684\u6253\u901a\uff0c\u65e0\u6cd5\u5b9e\u73b0\u591a\u5b50\u7f51\u9009\u62e9\u6027\u6253\u901a\u3002","title":"\u4f7f\u7528 Submariner \u8fdb\u884c\u591a\u96c6\u7fa4\u4e92\u8054"},{"location":"advance/with-submariner/#_1","text":"\u4e24\u4e2a\u96c6\u7fa4\u7684 Service CIDR \u548c\u9ed8\u8ba4\u5b50\u7f51\u7684 CIDR \u4e0d\u80fd\u91cd\u53e0\u3002","title":"\u524d\u63d0\u6761\u4ef6"},{"location":"advance/with-submariner/#submariner_1","text":"\u4e0b\u8f7d subctl \u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5e76\u90e8\u7f72\u5230\u76f8\u5e94\u8def\u5f84\uff1a curl -Ls https://get.submariner.io | bash export PATH=$PATH:~/.local/bin echo export PATH=\\$PATH:~/.local/bin >> ~/.profile \u5207\u6362 kubeconfig \u81f3\u5e0c\u671b\u90e8\u7f72 submariner-broker \u7684\u96c6\u7fa4\u8fdb\u884c\u90e8\u7f72\uff1a subctl deploy-broker \u5728\u672c\u6587\u6863\u4e2d cluster0 \u7684\u9ed8\u8ba4\u5b50\u7f51 CIDR \u4e3a 10.16.0.0/16 \uff0c cluster1 \u7684\u9ed8\u8ba4\u5b50\u7f51 CIDR \u4e3a 11.16.0.0/16 \u3002 \u5207\u6362 kubeconfig \u81f3 cluster0 \u6ce8\u518c\u96c6\u7fa4\u81f3 broker\uff0c\u5e76\u6ce8\u518c\u7f51\u5173\u8282\u70b9: subctl join broker-info.subm --clusterid cluster0 --clustercidr 10.16.0.0/16 --natt=false --cable-driver vxlan --health-check=false kubectl label nodes cluster0 submariner.io/gateway=true \u5207\u6362 kubeconfig \u81f3 cluster1 \u6ce8\u518c\u96c6\u7fa4\u81f3 broker\uff0c\u5e76\u6ce8\u518c\u7f51\u5173\u8282\u70b9: subctl join broker-info.subm --clusterid cluster1 --clustercidr 11.16.0.0/16 --natt=false --cable-driver vxlan --health-check=false kubectl label nodes cluster1 submariner.io/gateway=true \u63a5\u4e0b\u6765\u53ef\u4ee5\u5728\u4e24\u4e2a\u96c6\u7fa4\u5185\u5206\u522b\u542f\u52a8 Pod \u5e76\u5c1d\u8bd5\u4f7f\u7528 IP \u8fdb\u884c\u76f8\u4e92\u8bbf\u95ee\u3002 \u5982\u679c\u51fa\u73b0\u7f51\u7edc\u4e92\u901a\u95ee\u9898\u53ef\u901a\u8fc7 subctl \u547d\u4ee4\u8fdb\u884c\u8bca\u65ad\uff1a subctl show all subctl diagnose all \u66f4\u591a Submariner \u76f8\u5173\u64cd\u4f5c\u8bf7\u67e5\u770b Submariner \u7528\u6237\u624b\u518c \u3002","title":"\u90e8\u7f72 Submariner"},{"location":"guide/dual-stack/","text":"\u53cc\u6808\u4f7f\u7528 Kube-OVN \u4e2d\u4e0d\u540c\u7684\u5b50\u7f51\u53ef\u4ee5\u652f\u6301\u4e0d\u540c\u7684\u534f\u8bae\uff0c\u4e00\u4e2a\u96c6\u7fa4\u5185\u53ef\u4ee5\u540c\u65f6\u5b58\u5728 IPv4\uff0cIPv6 \u548c\u53cc\u6808\u7c7b\u578b\u7684\u5b50\u7f51\u3002 \u6211\u4eec\u63a8\u8350\u4e00\u4e2a\u96c6\u7fa4\u5185\u4f7f\u7528\u7edf\u4e00\u7684\u534f\u8bae\u7c7b\u578b\u4ee5\u7b80\u5316\u4f7f\u7528\u548c\u7ef4\u62a4\u3002 \u4e3a\u4e86\u652f\u6301\u53cc\u6808\uff0c\u9700\u8981\u4e3b\u673a\u7f51\u7edc\u6ee1\u8db3\u53cc\u6808\u5e7d\u56da\uff0c\u540c\u65f6\u9700\u8981\u5bf9 Kubernetes \u76f8\u5173\u53c2\u6570\u505a\u8c03\u6574\uff0c \u8bf7\u53c2\u8003 Kubernetes \u7684 \u53cc\u6808\u5b98\u65b9\u6307\u5bfc \u3002 \u521b\u5efa\u53cc\u6808\u5b50\u7f51 \u5728\u914d\u7f6e\u53cc\u6808\u65f6\uff0c\u53ea\u9700\u8981\u8bbe\u7f6e\u5bf9\u5e94\u5b50\u7f51 CIDR \u683c\u5f0f\u4e3a cidr=<IPv4 CIDR>,<IPv6 CIDR> \u5373\u53ef\u3002 CIDR \u987a\u5e8f\u8981\u6c42 IPv4 \u5728\u524d\uff0cIPv6 \u5728\u540e\uff0c\u5982\u4e0b\u6240\u793a\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: ovn-test spec: cidrBlock: 10.16.0.0/16,fd00:10:16::/64 excludeIps: - 10.16.0.1 - fd00:10:16::1 gateway: 10.16.0.1,fd00:10:16::1 \u5982\u679c\u9700\u8981\u5728\u5b89\u88c5\u65f6\u9ed8\u8ba4\u5b50\u7f51\u4f7f\u7528\u53cc\u6808\uff0c\u9700\u8981\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u4fee\u6539\u5982\u4e0b\u53c2\u6570\uff1a POD_CIDR=\"10.16.0.0/16,fd00:10:16::/64\" JOIN_CIDR=\"100.64.0.0/16,fd00:100:64::/64\" \u67e5\u770b Pod \u5730\u5740 \u914d\u7f6e\u53cc\u6808\u7f51\u7edc\u7684 Pod \u5c06\u4f1a\u4ece\u8be5\u5b50\u7f51\u540c\u65f6\u5206\u914d IPv4 \u548c IPv6 \u7684\u5730\u5740\uff0c\u5206\u914d\u7ed3\u679c\u4f1a\u663e\u793a\u5728 Pod \u7684 annotation \u4e2d: apiVersion: v1 kind: Pod metadata: annotations: ovn.kubernetes.io/allocated: \"true\" ovn.kubernetes.io/cidr: 10.16.0.0/16,fd00:10:16::/64 ovn.kubernetes.io/gateway: 10.16.0.1,fd00:10:16::1 ovn.kubernetes.io/ip_address: 10.16.0.9,fd00:10:16::9 ovn.kubernetes.io/logical_switch: ovn-default ovn.kubernetes.io/mac_address: 00:00:00:14:88:09 ovn.kubernetes.io/network_types: geneve ovn.kubernetes.io/routed: \"true\" ... podIP: 10.16.0.9 podIPs: - ip: 10.16.0.9 - ip: fd00:10:16::9","title":"\u53cc\u6808\u4f7f\u7528"},{"location":"guide/dual-stack/#_1","text":"Kube-OVN \u4e2d\u4e0d\u540c\u7684\u5b50\u7f51\u53ef\u4ee5\u652f\u6301\u4e0d\u540c\u7684\u534f\u8bae\uff0c\u4e00\u4e2a\u96c6\u7fa4\u5185\u53ef\u4ee5\u540c\u65f6\u5b58\u5728 IPv4\uff0cIPv6 \u548c\u53cc\u6808\u7c7b\u578b\u7684\u5b50\u7f51\u3002 \u6211\u4eec\u63a8\u8350\u4e00\u4e2a\u96c6\u7fa4\u5185\u4f7f\u7528\u7edf\u4e00\u7684\u534f\u8bae\u7c7b\u578b\u4ee5\u7b80\u5316\u4f7f\u7528\u548c\u7ef4\u62a4\u3002 \u4e3a\u4e86\u652f\u6301\u53cc\u6808\uff0c\u9700\u8981\u4e3b\u673a\u7f51\u7edc\u6ee1\u8db3\u53cc\u6808\u5e7d\u56da\uff0c\u540c\u65f6\u9700\u8981\u5bf9 Kubernetes \u76f8\u5173\u53c2\u6570\u505a\u8c03\u6574\uff0c \u8bf7\u53c2\u8003 Kubernetes \u7684 \u53cc\u6808\u5b98\u65b9\u6307\u5bfc \u3002","title":"\u53cc\u6808\u4f7f\u7528"},{"location":"guide/dual-stack/#_2","text":"\u5728\u914d\u7f6e\u53cc\u6808\u65f6\uff0c\u53ea\u9700\u8981\u8bbe\u7f6e\u5bf9\u5e94\u5b50\u7f51 CIDR \u683c\u5f0f\u4e3a cidr=<IPv4 CIDR>,<IPv6 CIDR> \u5373\u53ef\u3002 CIDR \u987a\u5e8f\u8981\u6c42 IPv4 \u5728\u524d\uff0cIPv6 \u5728\u540e\uff0c\u5982\u4e0b\u6240\u793a\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: ovn-test spec: cidrBlock: 10.16.0.0/16,fd00:10:16::/64 excludeIps: - 10.16.0.1 - fd00:10:16::1 gateway: 10.16.0.1,fd00:10:16::1 \u5982\u679c\u9700\u8981\u5728\u5b89\u88c5\u65f6\u9ed8\u8ba4\u5b50\u7f51\u4f7f\u7528\u53cc\u6808\uff0c\u9700\u8981\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u4fee\u6539\u5982\u4e0b\u53c2\u6570\uff1a POD_CIDR=\"10.16.0.0/16,fd00:10:16::/64\" JOIN_CIDR=\"100.64.0.0/16,fd00:100:64::/64\"","title":"\u521b\u5efa\u53cc\u6808\u5b50\u7f51"},{"location":"guide/dual-stack/#pod","text":"\u914d\u7f6e\u53cc\u6808\u7f51\u7edc\u7684 Pod \u5c06\u4f1a\u4ece\u8be5\u5b50\u7f51\u540c\u65f6\u5206\u914d IPv4 \u548c IPv6 \u7684\u5730\u5740\uff0c\u5206\u914d\u7ed3\u679c\u4f1a\u663e\u793a\u5728 Pod \u7684 annotation \u4e2d: apiVersion: v1 kind: Pod metadata: annotations: ovn.kubernetes.io/allocated: \"true\" ovn.kubernetes.io/cidr: 10.16.0.0/16,fd00:10:16::/64 ovn.kubernetes.io/gateway: 10.16.0.1,fd00:10:16::1 ovn.kubernetes.io/ip_address: 10.16.0.9,fd00:10:16::9 ovn.kubernetes.io/logical_switch: ovn-default ovn.kubernetes.io/mac_address: 00:00:00:14:88:09 ovn.kubernetes.io/network_types: geneve ovn.kubernetes.io/routed: \"true\" ... podIP: 10.16.0.9 podIPs: - ip: 10.16.0.9 - ip: fd00:10:16::9","title":"\u67e5\u770b Pod \u5730\u5740"},{"location":"guide/eip-snat/","text":"EIP \u548c SNAT \u914d\u7f6e \u8be5\u914d\u7f6e\u9488\u5bf9\u9ed8\u8ba4 VPC \u4e0b\u7684\u7f51\u7edc\uff0c\u7528\u6237\u81ea\u5b9a\u4e49 VPC \u8bf7\u53c2\u8003 VPC \u7f51\u5173 Kube-OVN \u652f\u6301\u5229\u7528 OVN \u4e2d\u7684 L3 Gateway \u529f\u80fd\u6765\u5b9e\u73b0 Pod \u7ea7\u522b\u7684 SNAT \u548c EIP \u529f\u80fd\u3002 \u901a\u8fc7\u4f7f\u7528 SNAT\uff0c\u4e00\u7ec4 Pod \u53ef\u4ee5\u5171\u4eab\u4e00\u4e2a IP \u5730\u5740\u5bf9\u5916\u8fdb\u884c\u8bbf\u95ee\u3002 \u901a\u8fc7 EIP \u7684\u529f\u80fd\uff0c\u4e00\u4e2a Pod \u53ef\u4ee5\u76f4\u63a5\u548c\u4e00\u4e2a\u5916\u90e8 IP \u5173\u8054\uff0c \u5916\u90e8\u670d\u52a1\u53ef\u4ee5\u901a\u8fc7 EIP \u76f4\u63a5\u8bbf\u95ee Pod\uff0cPod \u4e5f\u5c06\u901a\u8fc7\u8fd9\u4e2a EIP \u8bbf\u95ee\u5916\u90e8\u670d\u52a1\u3002 \u51c6\u5907\u5de5\u4f5c \u4e3a\u4e86\u4f7f\u7528 OVN \u7684 L3 Gateway \u80fd\u529b\uff0c\u5fc5\u987b\u5c06\u4e00\u4e2a\u5355\u72ec\u7684\u7f51\u5361\u63a5\u5165 OVS \u7f51\u6865\u4e2d\u8fdb\u884c Overlay \u548c Underlay \u7f51\u7edc\u7684\u6253\u901a\uff0c \u4e3b\u673a\u5fc5\u987b\u6709\u5176\u4ed6\u7684\u7f51\u5361\u7528\u4e8e\u8fd0\u7ef4\u7ba1\u7406\u3002 \u7531\u4e8e\u7ecf\u8fc7 NAT \u540e\u7684\u6570\u636e\u5305\u4f1a\u76f4\u63a5\u8fdb\u5165 Underlay \u7f51\u7edc\uff0c\u5fc5\u987b\u786e\u8ba4\u5f53\u524d\u7684\u7f51\u7edc\u67b6\u6784\u4e0b\u6b64\u7c7b\u6570\u636e\u5305\u53ef\u4ee5\u5b89\u5168\u901a\u8fc7\u3002 \u76ee\u524d EIP \u548c SNAT \u5730\u5740\u6ca1\u6709\u51b2\u7a81\u68c0\u6d4b\uff0c\u9700\u8981\u7ba1\u7406\u5458\u624b\u52a8\u5206\u914d\u907f\u514d\u5730\u5740\u51b2\u7a81\u3002 \u521b\u5efa\u914d\u7f6e\u6587\u4ef6 \u5728 kube-system \u4e0b\u521b\u5efa ConfigMap ovn-external-gw-config \uff1a apiVersion: v1 kind: ConfigMap metadata: name: ovn-external-gw-config namespace: kube-system data: enable-external-gw: \"true\" external-gw-nodes: \"kube-ovn-worker\" external-gw-nic: \"eth1\" external-gw-addr: \"172.56.0.1/16\" nic-ip: \"172.56.0.254/16\" nic-mac: \"16:52:f3:13:6a:25\" enable-external-gw : \u662f\u5426\u5f00\u542f SNAT \u548c EIP \u529f\u80fd\u3002 type : centrailized \u6216 distributed \uff0c \u9ed8\u8ba4\u4e3a centralized \u5982\u679c\u4f7f\u7528 distributed \uff0c\u5219\u96c6\u7fa4\u6240\u6709\u8282\u70b9\u90fd\u9700\u8981\u6709\u540c\u540d\u7f51\u5361\u6765\u627f\u62c5\u7f51\u5173\u529f\u80fd\u3002 external-gw-nodes : centralized \u6a21\u5f0f\u4e0b\uff0c\u627f\u62c5\u7f51\u5173\u4f5c\u7528\u7684\u8282\u70b9\u540d\uff0c\u9017\u53f7\u5206\u9694\u3002 external-gw-nic : \u8282\u70b9\u4e0a\u627f\u62c5\u7f51\u5173\u4f5c\u7528\u7684\u7f51\u5361\u540d\u3002 external-gw-addr : \u7269\u7406\u7f51\u7edc\u7f51\u5173\u7684 IP \u548c\u63a9\u7801\u3002 nic-ip , nic-mac : \u5206\u914d\u7ed9\u903b\u8f91\u7f51\u5173\u7aef\u53e3\u7684 IP \u548c Mac\uff0c\u9700\u4e3a\u7269\u7406\u6bb5\u672a\u88ab\u5360\u7528\u7684 IP \u548c Mac\u3002 \u89c2\u5bdf OVN \u548c OVS \u72b6\u6001\u786e\u8ba4\u914d\u7f6e\u751f\u6548 \u68c0\u67e5 OVN-NB \u72b6\u6001, \u786e\u8ba4 ovn-external \u903b\u8f91\u4ea4\u6362\u673a\u5b58\u5728\uff0c\u5e76\u4e14 ovn-cluster-ovn-external \u903b\u8f91\u8def\u7531\u5668\u7aef\u53e3\u4e0a \u7ed1\u5b9a\u4e86\u6b63\u786e\u7684\u5730\u5740\u548c chassis\u3002 # kubectl ko nbctl show switch 3de4cea7-1a71-43f3-8b62-435a57ef16a6 (ovn-external) port ln-ovn-external type: localnet addresses: [\"unknown\"] port ovn-external-ovn-cluster type: router router-port: ovn-cluster-ovn-external router e1eb83ad-34be-4ed5-9a02-fcc8b1d357c4 (ovn-cluster) port ovn-cluster-ovn-external mac: \"ac:1f:6b:2d:33:f1\" networks: [\"172.56.0.100/16\"] gateway chassis: [a5682814-2e2c-46dd-9c1c-6803ef0dab66] \u68c0\u67e5 OVS \u72b6\u6001\uff0c\u786e\u8ba4\u76f8\u5e94\u7684\u7f51\u5361\u5df2\u7ecf\u6865\u63a5\u8fdb br-external \u7f51\u6865\uff1a # kubectl ko vsctl ${gateway node name} show e7d81150-7743-4d6e-9e6f-5c688232e130 Bridge br-external Port br-external Interface br-external type: internal Port eno2 Interface eno2 Port patch-ln-ovn-external-to-br-int Interface patch-ln-ovn-external-to-br-int type: patch options: {peer=patch-br-int-to-ln-ovn-external} Pod \u914d\u7f6e EIP \u548c SNAT \u53ef\u901a\u8fc7\u5728 Pod \u4e0a\u589e\u52a0 ovn.kubernetes.io/snat \u6216 ovn.kubernetes.io/eip annotation \u6765\u5206\u522b\u914d\u7f6e SNAT \u548c EIP\uff1a apiVersion: v1 kind: Pod metadata: name: pod-gw annotations: ovn.kubernetes.io/snat: 172.56.0.200 spec: containers: - name: snat-pod image: nginx:alpine --- apiVersion: v1 kind: Pod metadata: name: pod-gw annotations: ovn.kubernetes.io/eip: 172.56.0.233 spec: containers: - name: eip-pod image: nginx:alpine \u53ef\u901a\u8fc7 kubectl \u6216\u5176\u4ed6\u5de5\u5177\u52a8\u6001\u8c03\u6574 Pod \u6240\u914d\u7f6e\u7684 EIP \u6216 SNAT \u89c4\u5219\uff0c\u66f4\u6539\u65f6\u8bf7\u6ce8\u610f\u8981\u540c\u65f6\u5220\u9664 ovn.kubernetes.io/routed annotation \u89e6\u53d1\u8def\u7531\u7684\u53d8\u66f4\uff1a kubectl annotate pod pod-gw ovn.kubernetes.io/eip=172.56.0.221 --overwrite kubectl annotate pod pod-gw ovn.kubernetes.io/routed- \u9ad8\u7ea7\u914d\u7f6e kube-ovn-controller \u7684\u90e8\u5206\u542f\u52a8\u53c2\u6570\u53ef\u5bf9 SNAT \u548c EIP \u529f\u80fd\u8fdb\u884c\u9ad8\u9636\u914d\u7f6e\uff1a --external-gateway-config-ns : Configmap ovn-external-gw-config \u6240\u5c5e Namespace\uff0c \u9ed8\u8ba4\u4e3a kube-system \u3002 --external-gateway-net : \u7269\u7406\u7f51\u5361\u6240\u6865\u63a5\u7684\u7f51\u6865\u540d\uff0c\u9ed8\u8ba4\u4e3a external \u3002 --external-gateway-vlanid : \u7269\u7406\u7f51\u7edc Vlan Tag \u53f7\uff0c\u9ed8\u8ba4\u4e3a 0\uff0c \u5373\u4e0d\u4f7f\u7528 Vlan\u3002","title":"EIP \u548c SNAT \u914d\u7f6e"},{"location":"guide/eip-snat/#eip-snat","text":"\u8be5\u914d\u7f6e\u9488\u5bf9\u9ed8\u8ba4 VPC \u4e0b\u7684\u7f51\u7edc\uff0c\u7528\u6237\u81ea\u5b9a\u4e49 VPC \u8bf7\u53c2\u8003 VPC \u7f51\u5173 Kube-OVN \u652f\u6301\u5229\u7528 OVN \u4e2d\u7684 L3 Gateway \u529f\u80fd\u6765\u5b9e\u73b0 Pod \u7ea7\u522b\u7684 SNAT \u548c EIP \u529f\u80fd\u3002 \u901a\u8fc7\u4f7f\u7528 SNAT\uff0c\u4e00\u7ec4 Pod \u53ef\u4ee5\u5171\u4eab\u4e00\u4e2a IP \u5730\u5740\u5bf9\u5916\u8fdb\u884c\u8bbf\u95ee\u3002 \u901a\u8fc7 EIP \u7684\u529f\u80fd\uff0c\u4e00\u4e2a Pod \u53ef\u4ee5\u76f4\u63a5\u548c\u4e00\u4e2a\u5916\u90e8 IP \u5173\u8054\uff0c \u5916\u90e8\u670d\u52a1\u53ef\u4ee5\u901a\u8fc7 EIP \u76f4\u63a5\u8bbf\u95ee Pod\uff0cPod \u4e5f\u5c06\u901a\u8fc7\u8fd9\u4e2a EIP \u8bbf\u95ee\u5916\u90e8\u670d\u52a1\u3002","title":"EIP \u548c SNAT \u914d\u7f6e"},{"location":"guide/eip-snat/#_1","text":"\u4e3a\u4e86\u4f7f\u7528 OVN \u7684 L3 Gateway \u80fd\u529b\uff0c\u5fc5\u987b\u5c06\u4e00\u4e2a\u5355\u72ec\u7684\u7f51\u5361\u63a5\u5165 OVS \u7f51\u6865\u4e2d\u8fdb\u884c Overlay \u548c Underlay \u7f51\u7edc\u7684\u6253\u901a\uff0c \u4e3b\u673a\u5fc5\u987b\u6709\u5176\u4ed6\u7684\u7f51\u5361\u7528\u4e8e\u8fd0\u7ef4\u7ba1\u7406\u3002 \u7531\u4e8e\u7ecf\u8fc7 NAT \u540e\u7684\u6570\u636e\u5305\u4f1a\u76f4\u63a5\u8fdb\u5165 Underlay \u7f51\u7edc\uff0c\u5fc5\u987b\u786e\u8ba4\u5f53\u524d\u7684\u7f51\u7edc\u67b6\u6784\u4e0b\u6b64\u7c7b\u6570\u636e\u5305\u53ef\u4ee5\u5b89\u5168\u901a\u8fc7\u3002 \u76ee\u524d EIP \u548c SNAT \u5730\u5740\u6ca1\u6709\u51b2\u7a81\u68c0\u6d4b\uff0c\u9700\u8981\u7ba1\u7406\u5458\u624b\u52a8\u5206\u914d\u907f\u514d\u5730\u5740\u51b2\u7a81\u3002","title":"\u51c6\u5907\u5de5\u4f5c"},{"location":"guide/eip-snat/#_2","text":"\u5728 kube-system \u4e0b\u521b\u5efa ConfigMap ovn-external-gw-config \uff1a apiVersion: v1 kind: ConfigMap metadata: name: ovn-external-gw-config namespace: kube-system data: enable-external-gw: \"true\" external-gw-nodes: \"kube-ovn-worker\" external-gw-nic: \"eth1\" external-gw-addr: \"172.56.0.1/16\" nic-ip: \"172.56.0.254/16\" nic-mac: \"16:52:f3:13:6a:25\" enable-external-gw : \u662f\u5426\u5f00\u542f SNAT \u548c EIP \u529f\u80fd\u3002 type : centrailized \u6216 distributed \uff0c \u9ed8\u8ba4\u4e3a centralized \u5982\u679c\u4f7f\u7528 distributed \uff0c\u5219\u96c6\u7fa4\u6240\u6709\u8282\u70b9\u90fd\u9700\u8981\u6709\u540c\u540d\u7f51\u5361\u6765\u627f\u62c5\u7f51\u5173\u529f\u80fd\u3002 external-gw-nodes : centralized \u6a21\u5f0f\u4e0b\uff0c\u627f\u62c5\u7f51\u5173\u4f5c\u7528\u7684\u8282\u70b9\u540d\uff0c\u9017\u53f7\u5206\u9694\u3002 external-gw-nic : \u8282\u70b9\u4e0a\u627f\u62c5\u7f51\u5173\u4f5c\u7528\u7684\u7f51\u5361\u540d\u3002 external-gw-addr : \u7269\u7406\u7f51\u7edc\u7f51\u5173\u7684 IP \u548c\u63a9\u7801\u3002 nic-ip , nic-mac : \u5206\u914d\u7ed9\u903b\u8f91\u7f51\u5173\u7aef\u53e3\u7684 IP \u548c Mac\uff0c\u9700\u4e3a\u7269\u7406\u6bb5\u672a\u88ab\u5360\u7528\u7684 IP \u548c Mac\u3002","title":"\u521b\u5efa\u914d\u7f6e\u6587\u4ef6"},{"location":"guide/eip-snat/#ovn-ovs","text":"\u68c0\u67e5 OVN-NB \u72b6\u6001, \u786e\u8ba4 ovn-external \u903b\u8f91\u4ea4\u6362\u673a\u5b58\u5728\uff0c\u5e76\u4e14 ovn-cluster-ovn-external \u903b\u8f91\u8def\u7531\u5668\u7aef\u53e3\u4e0a \u7ed1\u5b9a\u4e86\u6b63\u786e\u7684\u5730\u5740\u548c chassis\u3002 # kubectl ko nbctl show switch 3de4cea7-1a71-43f3-8b62-435a57ef16a6 (ovn-external) port ln-ovn-external type: localnet addresses: [\"unknown\"] port ovn-external-ovn-cluster type: router router-port: ovn-cluster-ovn-external router e1eb83ad-34be-4ed5-9a02-fcc8b1d357c4 (ovn-cluster) port ovn-cluster-ovn-external mac: \"ac:1f:6b:2d:33:f1\" networks: [\"172.56.0.100/16\"] gateway chassis: [a5682814-2e2c-46dd-9c1c-6803ef0dab66] \u68c0\u67e5 OVS \u72b6\u6001\uff0c\u786e\u8ba4\u76f8\u5e94\u7684\u7f51\u5361\u5df2\u7ecf\u6865\u63a5\u8fdb br-external \u7f51\u6865\uff1a # kubectl ko vsctl ${gateway node name} show e7d81150-7743-4d6e-9e6f-5c688232e130 Bridge br-external Port br-external Interface br-external type: internal Port eno2 Interface eno2 Port patch-ln-ovn-external-to-br-int Interface patch-ln-ovn-external-to-br-int type: patch options: {peer=patch-br-int-to-ln-ovn-external}","title":"\u89c2\u5bdf OVN \u548c OVS \u72b6\u6001\u786e\u8ba4\u914d\u7f6e\u751f\u6548"},{"location":"guide/eip-snat/#pod-eip-snat","text":"\u53ef\u901a\u8fc7\u5728 Pod \u4e0a\u589e\u52a0 ovn.kubernetes.io/snat \u6216 ovn.kubernetes.io/eip annotation \u6765\u5206\u522b\u914d\u7f6e SNAT \u548c EIP\uff1a apiVersion: v1 kind: Pod metadata: name: pod-gw annotations: ovn.kubernetes.io/snat: 172.56.0.200 spec: containers: - name: snat-pod image: nginx:alpine --- apiVersion: v1 kind: Pod metadata: name: pod-gw annotations: ovn.kubernetes.io/eip: 172.56.0.233 spec: containers: - name: eip-pod image: nginx:alpine \u53ef\u901a\u8fc7 kubectl \u6216\u5176\u4ed6\u5de5\u5177\u52a8\u6001\u8c03\u6574 Pod \u6240\u914d\u7f6e\u7684 EIP \u6216 SNAT \u89c4\u5219\uff0c\u66f4\u6539\u65f6\u8bf7\u6ce8\u610f\u8981\u540c\u65f6\u5220\u9664 ovn.kubernetes.io/routed annotation \u89e6\u53d1\u8def\u7531\u7684\u53d8\u66f4\uff1a kubectl annotate pod pod-gw ovn.kubernetes.io/eip=172.56.0.221 --overwrite kubectl annotate pod pod-gw ovn.kubernetes.io/routed-","title":"Pod \u914d\u7f6e EIP \u548c SNAT"},{"location":"guide/eip-snat/#_3","text":"kube-ovn-controller \u7684\u90e8\u5206\u542f\u52a8\u53c2\u6570\u53ef\u5bf9 SNAT \u548c EIP \u529f\u80fd\u8fdb\u884c\u9ad8\u9636\u914d\u7f6e\uff1a --external-gateway-config-ns : Configmap ovn-external-gw-config \u6240\u5c5e Namespace\uff0c \u9ed8\u8ba4\u4e3a kube-system \u3002 --external-gateway-net : \u7269\u7406\u7f51\u5361\u6240\u6865\u63a5\u7684\u7f51\u6865\u540d\uff0c\u9ed8\u8ba4\u4e3a external \u3002 --external-gateway-vlanid : \u7269\u7406\u7f51\u7edc Vlan Tag \u53f7\uff0c\u9ed8\u8ba4\u4e3a 0\uff0c \u5373\u4e0d\u4f7f\u7528 Vlan\u3002","title":"\u9ad8\u7ea7\u914d\u7f6e"},{"location":"guide/mirror/","text":"\u6d41\u91cf\u955c\u50cf \u6d41\u91cf\u955c\u50cf\u529f\u80fd\u53ef\u4ee5\u5c06\u8fdb\u51fa\u5bb9\u5668\u7f51\u7edc\u7684\u6570\u636e\u5305\u8fdb\u884c\u590d\u5236\u5230\u4e3b\u673a\u7684\u7279\u5b9a\u7f51\u5361\u3002\u7ba1\u7406\u5458\u6216\u5f00\u53d1\u8005 \u53ef\u4ee5\u901a\u8fc7\u76d1\u542c\u8fd9\u5757\u7f51\u5361\u83b7\u5f97\u5b8c\u6574\u7684\u5bb9\u5668\u7f51\u7edc\u6d41\u91cf\u6765\u8fdb\u4e00\u6b65\u8fdb\u884c\u5206\u6790\uff0c\u76d1\u63a7\uff0c\u5b89\u5168\u5ba1\u8ba1\u7b49\u64cd\u4f5c\u3002 \u4e5f\u53ef\u548c\u4f20\u7edf\u7684 NPM \u5bf9\u63a5\u83b7\u53d6\u66f4\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u76d1\u63a7\u3002 \u6d41\u91cf\u955c\u50cf\u529f\u80fd\u4f1a\u5e26\u6765\u4e00\u5b9a\u7684\u6027\u80fd\u635f\u5931\uff0c\u6839\u636e CPU \u6027\u80fd\u4ee5\u53ca\u6d41\u91cf\u7684\u7279\u5f81\uff0c\u4f1a\u6709 5%~10% \u7684 \u989d\u5916 CPU \u6d88\u8017\u3002 \u5168\u5c40\u6d41\u91cf\u955c\u50cf\u914d\u7f6e \u6d41\u91cf\u955c\u50cf\u529f\u80fd\u9ed8\u8ba4\u4e3a\u5173\u95ed\u72b6\u6001\uff0c\u5982\u679c\u9700\u8981\u5f00\u542f\u8bf7\u4fee\u6539 kube-ovn-cni DaemonSet \u7684\u542f\u52a8\u53c2\u6570\uff1a --enable-mirror=true \uff1a \u662f\u5426\u5f00\u542f\u6d41\u91cf\u955c\u50cf\u3002 --mirror-iface=mirror0 : \u6d41\u91cf\u955c\u50cf\u6240\u590d\u5236\u5230\u7684\u7f51\u5361\u540d\u3002\u8be5\u7f51\u5361\u53ef\u4e3a\u4e3b\u673a\u4e0a\u5df2\u5b58\u5728\u7684\u4e00\u5757\u7269\u7406\u7f51\u5361\uff0c \u6b64\u65f6\u8be5\u7f51\u5361\u4f1a\u88ab\u6865\u63a5\u8fdb br-int \u7f51\u6865\uff0c\u955c\u50cf\u6d41\u91cf\u4f1a\u76f4\u63a5\u63a5\u5165\u5e95\u5c42\u4ea4\u6362\u673a\u3002\u82e5\u7f51\u5361\u540d\u4e0d\u5b58\u5728\uff0cKube-OVN \u4f1a\u81ea\u52a8 \u521b\u5efa\u4e00\u5757\u540c\u540d\u7684\u865a\u62df\u7f51\u5361\uff0c\u7ba1\u7406\u5458\u6216\u5f00\u53d1\u8005\u53ef\u4ee5\u5728\u5bbf\u4e3b\u673a\u4e0a\u901a\u8fc7\u8be5\u7f51\u5361\u83b7\u53d6\u5f53\u524d\u8282\u70b9\u6240\u6709\u6d41\u91cf\u3002\u9ed8\u8ba4\u4e3a mirror0 \u3002 \u63a5\u4e0b\u6765\u53ef\u4ee5\u7528 tcpdump \u6216\u5176\u4ed6\u6d41\u91cf\u5206\u6790\u5de5\u5177\u76d1\u542c mirror0 \u4e0a\u7684\u6d41\u91cf\uff1a tcpdump -ni mirror0 Pod \u7ea7\u522b\u6d41\u91cf\u955c\u50cf\u914d\u7f6e \u5982\u679c\u53ea\u9700\u5bf9\u90e8\u5206 Pod \u6d41\u91cf\u8fdb\u884c\u955c\u50cf\uff0c\u5219\u9700\u8981\u5173\u95ed\u5168\u5c40\u7684\u6d41\u91cf\u955c\u50cf\u529f\u80fd\uff0c\u7136\u540e\u5728\u7279\u5b9a Pod \u4e0a\u589e\u52a0 ovn.kubernetes.io/mirror annotation \u6765\u5f00\u542f Pod \u7ea7\u522b\u6d41\u91cf\u955c\u50cf\u3002 apiVersion: v1 kind: Pod metadata: name: mirror-pod namespace: ls1 annotations: ovn.kubernetes.io/mirror: \"true\" spec: containers: - name: mirror-pod image: nginx:alpine","title":"\u6d41\u91cf\u955c\u50cf"},{"location":"guide/mirror/#_1","text":"\u6d41\u91cf\u955c\u50cf\u529f\u80fd\u53ef\u4ee5\u5c06\u8fdb\u51fa\u5bb9\u5668\u7f51\u7edc\u7684\u6570\u636e\u5305\u8fdb\u884c\u590d\u5236\u5230\u4e3b\u673a\u7684\u7279\u5b9a\u7f51\u5361\u3002\u7ba1\u7406\u5458\u6216\u5f00\u53d1\u8005 \u53ef\u4ee5\u901a\u8fc7\u76d1\u542c\u8fd9\u5757\u7f51\u5361\u83b7\u5f97\u5b8c\u6574\u7684\u5bb9\u5668\u7f51\u7edc\u6d41\u91cf\u6765\u8fdb\u4e00\u6b65\u8fdb\u884c\u5206\u6790\uff0c\u76d1\u63a7\uff0c\u5b89\u5168\u5ba1\u8ba1\u7b49\u64cd\u4f5c\u3002 \u4e5f\u53ef\u548c\u4f20\u7edf\u7684 NPM \u5bf9\u63a5\u83b7\u53d6\u66f4\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u76d1\u63a7\u3002 \u6d41\u91cf\u955c\u50cf\u529f\u80fd\u4f1a\u5e26\u6765\u4e00\u5b9a\u7684\u6027\u80fd\u635f\u5931\uff0c\u6839\u636e CPU \u6027\u80fd\u4ee5\u53ca\u6d41\u91cf\u7684\u7279\u5f81\uff0c\u4f1a\u6709 5%~10% \u7684 \u989d\u5916 CPU \u6d88\u8017\u3002","title":"\u6d41\u91cf\u955c\u50cf"},{"location":"guide/mirror/#_2","text":"\u6d41\u91cf\u955c\u50cf\u529f\u80fd\u9ed8\u8ba4\u4e3a\u5173\u95ed\u72b6\u6001\uff0c\u5982\u679c\u9700\u8981\u5f00\u542f\u8bf7\u4fee\u6539 kube-ovn-cni DaemonSet \u7684\u542f\u52a8\u53c2\u6570\uff1a --enable-mirror=true \uff1a \u662f\u5426\u5f00\u542f\u6d41\u91cf\u955c\u50cf\u3002 --mirror-iface=mirror0 : \u6d41\u91cf\u955c\u50cf\u6240\u590d\u5236\u5230\u7684\u7f51\u5361\u540d\u3002\u8be5\u7f51\u5361\u53ef\u4e3a\u4e3b\u673a\u4e0a\u5df2\u5b58\u5728\u7684\u4e00\u5757\u7269\u7406\u7f51\u5361\uff0c \u6b64\u65f6\u8be5\u7f51\u5361\u4f1a\u88ab\u6865\u63a5\u8fdb br-int \u7f51\u6865\uff0c\u955c\u50cf\u6d41\u91cf\u4f1a\u76f4\u63a5\u63a5\u5165\u5e95\u5c42\u4ea4\u6362\u673a\u3002\u82e5\u7f51\u5361\u540d\u4e0d\u5b58\u5728\uff0cKube-OVN \u4f1a\u81ea\u52a8 \u521b\u5efa\u4e00\u5757\u540c\u540d\u7684\u865a\u62df\u7f51\u5361\uff0c\u7ba1\u7406\u5458\u6216\u5f00\u53d1\u8005\u53ef\u4ee5\u5728\u5bbf\u4e3b\u673a\u4e0a\u901a\u8fc7\u8be5\u7f51\u5361\u83b7\u53d6\u5f53\u524d\u8282\u70b9\u6240\u6709\u6d41\u91cf\u3002\u9ed8\u8ba4\u4e3a mirror0 \u3002 \u63a5\u4e0b\u6765\u53ef\u4ee5\u7528 tcpdump \u6216\u5176\u4ed6\u6d41\u91cf\u5206\u6790\u5de5\u5177\u76d1\u542c mirror0 \u4e0a\u7684\u6d41\u91cf\uff1a tcpdump -ni mirror0","title":"\u5168\u5c40\u6d41\u91cf\u955c\u50cf\u914d\u7f6e"},{"location":"guide/mirror/#pod","text":"\u5982\u679c\u53ea\u9700\u5bf9\u90e8\u5206 Pod \u6d41\u91cf\u8fdb\u884c\u955c\u50cf\uff0c\u5219\u9700\u8981\u5173\u95ed\u5168\u5c40\u7684\u6d41\u91cf\u955c\u50cf\u529f\u80fd\uff0c\u7136\u540e\u5728\u7279\u5b9a Pod \u4e0a\u589e\u52a0 ovn.kubernetes.io/mirror annotation \u6765\u5f00\u542f Pod \u7ea7\u522b\u6d41\u91cf\u955c\u50cf\u3002 apiVersion: v1 kind: Pod metadata: name: mirror-pod namespace: ls1 annotations: ovn.kubernetes.io/mirror: \"true\" spec: containers: - name: mirror-pod image: nginx:alpine","title":"Pod \u7ea7\u522b\u6d41\u91cf\u955c\u50cf\u914d\u7f6e"},{"location":"guide/prometheus-grafana/","text":"\u914d\u7f6e\u76d1\u63a7\u548c\u9762\u677f Kube-OVN \u53ef\u4ee5\u5c06\u7f51\u7edc\u63a7\u5236\u5e73\u9762\u4fe1\u606f\u4ee5\u53ca\u7f51\u7edc\u6570\u636e\u5e73\u9762\u8d28\u91cf\u4fe1\u606f\u6307\u6807\u4ee5 Prometheus \u6240\u652f\u6301\u7684\u683c\u5f0f\u5bf9\u5916\u8f93\u51fa\u3002 \u6211\u4eec\u4f7f\u7528 kube-prometheus \u6240\u63d0\u4f9b\u7684 CRD \u6765\u5b9a\u4e49\u76f8\u5e94\u7684 Prometheus \u76d1\u63a7\u89c4\u5219\u3002 \u7528\u6237\u9700\u8981\u9884\u5148\u5b89\u88c5 kube-prometheus \u6765\u542f\u7528\u76f8\u5173\u7684 CRD\u3002Kube-OVN \u6240\u652f\u6301\u7684\u5168\u90e8\u76d1\u63a7\u6307\u6807\u8bf7\u53c2\u8003 Kube-OVN \u76d1\u63a7\u6307\u6807 \u3002 \u5b89\u88c5 Prometheus Monitor Kube-OVN \u4f7f\u7528 Prometheus Monitor CRD \u6765\u7ba1\u7406\u76d1\u63a7\u8f93\u51fa\uff1a # \u7f51\u54af\u8d28\u91cf\u76f8\u5173\u76d1\u63a7\u6307\u6807 kubectl apply -f https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/pinger-monitor.yaml # kube-ovn-controller \u76f8\u5173\u76d1\u63a7\u6307\u6807 kubectl apply -f https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/controller-monitor.yaml # kube-ovn-cni \u76f8\u5173\u76d1\u63a7\u6307\u6807 kubectl apply -f https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/cni-monitor.yaml # ovn \u76f8\u5173\u76d1\u63a7\u6307\u6807 kubectl apply -f https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/ovn-monitor.yaml \u52a0\u8f7d Grafana \u9762\u677f Kube-OVN \u8fd8\u63d0\u4f9b\u4e86\u9884\u5148\u5b9a\u4e49\u597d\u7684 Grafana Dashboard \u5c55\u793a\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u76f8\u5173\u4fe1\u606f\u3002 \u4e0b\u8f7d\u5bf9\u5e94 Dashboard \u6a21\u677f\uff1a # \u7f51\u7edc\u8d28\u91cf\u76f8\u5173\u9762\u677f wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/pinger-grafana.json # kube-ovn-controller \u76f8\u5173\u9762\u677f wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/controller-grafana.json # kube-ovn-cni \u76f8\u5173\u9762\u677f wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/cni-grafana.json # ovn \u76f8\u5173\u9762\u677f wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/ovn-grafana.json # ovs \u76f8\u5173\u9762\u677f wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/ovs-grafana.json \u5728 Grafana \u4e2d\u5bfc\u5165\u6a21\u677f\uff0c\u5e76\u5c06\u6570\u636e\u6e90\u8bbe\u7f6e\u4e3a\u5bf9\u5e94\u7684 Prometheus \u5373\u53ef\u770b\u5230\u5982\u4e0b Dashboard\uff1a kube-ovn-controller \u8fd0\u884c\u72b6\u51b5\u76f8\u5173\u9762\u677f\uff1a kube-ovn-pinger \u7f51\u7edc\u8d28\u91cf\u76f8\u5173\u9762\u677f\uff1a kube-ovn-cni \u8fd0\u884c\u72b6\u51b5\u76f8\u5173\u9762\u677f\uff1a","title":"\u914d\u7f6e\u76d1\u63a7\u548c\u9762\u677f"},{"location":"guide/prometheus-grafana/#_1","text":"Kube-OVN \u53ef\u4ee5\u5c06\u7f51\u7edc\u63a7\u5236\u5e73\u9762\u4fe1\u606f\u4ee5\u53ca\u7f51\u7edc\u6570\u636e\u5e73\u9762\u8d28\u91cf\u4fe1\u606f\u6307\u6807\u4ee5 Prometheus \u6240\u652f\u6301\u7684\u683c\u5f0f\u5bf9\u5916\u8f93\u51fa\u3002 \u6211\u4eec\u4f7f\u7528 kube-prometheus \u6240\u63d0\u4f9b\u7684 CRD \u6765\u5b9a\u4e49\u76f8\u5e94\u7684 Prometheus \u76d1\u63a7\u89c4\u5219\u3002 \u7528\u6237\u9700\u8981\u9884\u5148\u5b89\u88c5 kube-prometheus \u6765\u542f\u7528\u76f8\u5173\u7684 CRD\u3002Kube-OVN \u6240\u652f\u6301\u7684\u5168\u90e8\u76d1\u63a7\u6307\u6807\u8bf7\u53c2\u8003 Kube-OVN \u76d1\u63a7\u6307\u6807 \u3002","title":"\u914d\u7f6e\u76d1\u63a7\u548c\u9762\u677f"},{"location":"guide/prometheus-grafana/#prometheus-monitor","text":"Kube-OVN \u4f7f\u7528 Prometheus Monitor CRD \u6765\u7ba1\u7406\u76d1\u63a7\u8f93\u51fa\uff1a # \u7f51\u54af\u8d28\u91cf\u76f8\u5173\u76d1\u63a7\u6307\u6807 kubectl apply -f https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/pinger-monitor.yaml # kube-ovn-controller \u76f8\u5173\u76d1\u63a7\u6307\u6807 kubectl apply -f https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/controller-monitor.yaml # kube-ovn-cni \u76f8\u5173\u76d1\u63a7\u6307\u6807 kubectl apply -f https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/cni-monitor.yaml # ovn \u76f8\u5173\u76d1\u63a7\u6307\u6807 kubectl apply -f https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/ovn-monitor.yaml","title":"\u5b89\u88c5 Prometheus Monitor"},{"location":"guide/prometheus-grafana/#grafana","text":"Kube-OVN \u8fd8\u63d0\u4f9b\u4e86\u9884\u5148\u5b9a\u4e49\u597d\u7684 Grafana Dashboard \u5c55\u793a\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u76f8\u5173\u4fe1\u606f\u3002 \u4e0b\u8f7d\u5bf9\u5e94 Dashboard \u6a21\u677f\uff1a # \u7f51\u7edc\u8d28\u91cf\u76f8\u5173\u9762\u677f wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/pinger-grafana.json # kube-ovn-controller \u76f8\u5173\u9762\u677f wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/controller-grafana.json # kube-ovn-cni \u76f8\u5173\u9762\u677f wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/cni-grafana.json # ovn \u76f8\u5173\u9762\u677f wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/ovn-grafana.json # ovs \u76f8\u5173\u9762\u677f wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/monitoring/ovs-grafana.json \u5728 Grafana \u4e2d\u5bfc\u5165\u6a21\u677f\uff0c\u5e76\u5c06\u6570\u636e\u6e90\u8bbe\u7f6e\u4e3a\u5bf9\u5e94\u7684 Prometheus \u5373\u53ef\u770b\u5230\u5982\u4e0b Dashboard\uff1a kube-ovn-controller \u8fd0\u884c\u72b6\u51b5\u76f8\u5173\u9762\u677f\uff1a kube-ovn-pinger \u7f51\u7edc\u8d28\u91cf\u76f8\u5173\u9762\u677f\uff1a kube-ovn-cni \u8fd0\u884c\u72b6\u51b5\u76f8\u5173\u9762\u677f\uff1a","title":"\u52a0\u8f7d Grafana \u9762\u677f"},{"location":"guide/qos/","text":"\u5bb9\u5668\u7f51\u7edc QoS \u914d\u7f6e Kube-OVN \u652f\u6301\u4e09\u79cd\u4e0d\u540c\u7c7b\u578b\u7684 QoS \u6700\u5927\u5e26\u5bbd\u9650\u5236 QoS\u3002 linux-htb \uff0c\u57fa\u4e8e\u4f18\u5148\u7ea7\u7684 QoS\uff0c\u5f53\u5e26\u5bbd\u4e0d\u8db3\u65f6\u4f18\u5148\u7ea7\u8f83\u9ad8\u6d41\u91cf\u88ab\u9996\u5148\u6ee1\u8db3\u3002 linux-netem \uff0c\u6a21\u62df\u8bbe\u5907\u5e72\u6270\u4e22\u5305\u7b49\u7684 QoS\uff0c\u53ef\u7528\u4e8e\u6a21\u62df\u6d4b\u8bd5\u3002 \u5176\u4e2d linux-htb \u548c linux-netem \u4e24\u79cd QoS \u65e0\u6cd5\u540c\u65f6\u751f\u6548\uff0c\u82e5\u4e24\u79cd QoS \u90fd\u914d\u7f6e\u5230\u4e86\u540c\u4e00\u4e2a Pod \u4e0a\uff0c \u53ea\u6709 linux-htb \u7c7b\u578b QoS \u751f\u6548\u3002 \u57fa\u4e8e\u6700\u5927\u5e26\u5bbd\u9650\u5236\u7684 QoS \u8be5\u7c7b\u578b\u7684 QoS \u53ef\u4ee5\u901a\u8fc7 Pod annotation \u52a8\u6001\u8fdb\u884c\u914d\u7f6e\uff0c\u53ef\u4ee5\u5728\u4e0d\u4e2d\u65ad Pod \u8fd0\u884c\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u8c03\u6574\u3002 \u5e26\u5bbd\u9650\u901f\u7684\u5355\u4f4d\u4e3a Mbit/s apiVersion: v1 kind: Pod metadata: name: qos namespace: ls1 annotations: ovn.kubernetes.io/ingress_rate: \"3\" ovn.kubernetes.io/egress_rate: \"1\" spec: containers: - name: qos image: nginx:alpine \u4f7f\u7528 annotation \u52a8\u6001\u8c03\u6574 QoS\uff1a kubectl annotate --overwrite pod nginx-74d5899f46-d7qkn ovn.kubernetes.io/ingress_rate=3 \u6d4b\u8bd5 QoS \u8c03\u6574 \u90e8\u7f72\u6027\u80fd\u6d4b\u8bd5\u9700\u8981\u7684\u5bb9\u5668 kind: DaemonSet apiVersion: apps/v1 metadata: name: perf namespace: ls1 labels: app: perf spec: selector: matchLabels: app: perf template: metadata: labels: app: perf spec: containers: - name: nginx image: kubeovn/perf \u8fdb\u5165\u5176\u4e2d\u4e00\u4e2a Pod \u5e76\u5f00\u542f iperf3 server\uff1a # kubectl exec -it perf-4n4gt -n ls1 sh # iperf3 -s ----------------------------------------------------------- Server listening on 5201 ----------------------------------------------------------- \u8fdb\u5165\u53e6\u4e00\u4e2a Pod \u8bf7\u6c42\u4e4b\u524d\u7684 Pod\uff1a # kubectl exec -it perf-d4mqc -n ls1 sh # iperf3 -c 10.66.0.12 Connecting to host 10.66.0.12, port 5201 [ 4] local 10.66.0.14 port 51544 connected to 10.66.0.12 port 5201 [ ID] Interval Transfer Bandwidth Retr Cwnd [ 4] 0.00-1.00 sec 86.4 MBytes 725 Mbits/sec 3 350 KBytes [ 4] 1.00-2.00 sec 89.9 MBytes 754 Mbits/sec 118 473 KBytes [ 4] 2.00-3.00 sec 101 MBytes 848 Mbits/sec 184 586 KBytes [ 4] 3.00-4.00 sec 104 MBytes 875 Mbits/sec 217 671 KBytes [ 4] 4.00-5.00 sec 111 MBytes 935 Mbits/sec 175 772 KBytes [ 4] 5.00-6.00 sec 100 MBytes 840 Mbits/sec 658 598 KBytes [ 4] 6.00-7.00 sec 106 MBytes 890 Mbits/sec 742 668 KBytes [ 4] 7.00-8.00 sec 102 MBytes 857 Mbits/sec 764 724 KBytes [ 4] 8.00-9.00 sec 97.4 MBytes 817 Mbits/sec 1175 764 KBytes [ 4] 9.00-10.00 sec 111 MBytes 934 Mbits/sec 1083 838 KBytes - - - - - - - - - - - - - - - - - - - - - - - - - [ ID] Interval Transfer Bandwidth Retr [ 4] 0.00-10.00 sec 1010 MBytes 848 Mbits/sec 5119 sender [ 4] 0.00-10.00 sec 1008 MBytes 846 Mbits/sec receiver iperf Done. \u4fee\u6539\u7b2c\u4e00\u4e2a Pod \u7684\u5165\u53e3\u5e26\u5bbd QoS\uff1a kubectl annotate --overwrite pod perf-4n4gt -n ls1 ovn.kubernetes.io/ingress_rate=30 \u518d\u6b21\u4ece\u7b2c\u4e8c\u4e2a Pod \u6d4b\u8bd5\u7b2c\u4e00\u4e2a Pod \u5e26\u5bbd\uff1a # iperf3 -c 10.66.0.12 Connecting to host 10.66.0.12, port 5201 [ 4] local 10.66.0.14 port 52372 connected to 10.66.0.12 port 5201 [ ID] Interval Transfer Bandwidth Retr Cwnd [ 4] 0.00-1.00 sec 3.66 MBytes 30.7 Mbits/sec 2 76.1 KBytes [ 4] 1.00-2.00 sec 3.43 MBytes 28.8 Mbits/sec 0 104 KBytes [ 4] 2.00-3.00 sec 3.50 MBytes 29.4 Mbits/sec 0 126 KBytes [ 4] 3.00-4.00 sec 3.50 MBytes 29.3 Mbits/sec 0 144 KBytes [ 4] 4.00-5.00 sec 3.43 MBytes 28.8 Mbits/sec 0 160 KBytes [ 4] 5.00-6.00 sec 3.43 MBytes 28.8 Mbits/sec 0 175 KBytes [ 4] 6.00-7.00 sec 3.50 MBytes 29.3 Mbits/sec 0 212 KBytes [ 4] 7.00-8.00 sec 3.68 MBytes 30.9 Mbits/sec 0 294 KBytes [ 4] 8.00-9.00 sec 3.74 MBytes 31.4 Mbits/sec 0 398 KBytes [ 4] 9.00-10.00 sec 3.80 MBytes 31.9 Mbits/sec 0 526 KBytes - - - - - - - - - - - - - - - - - - - - - - - - - [ ID] Interval Transfer Bandwidth Retr [ 4] 0.00-10.00 sec 35.7 MBytes 29.9 Mbits/sec 2 sender [ 4] 0.00-10.00 sec 34.5 MBytes 29.0 Mbits/sec receiver iperf Done. linux-htb QoS linux-htb QoS \u662f\u57fa\u4e8e\u4f18\u5148\u7ea7\u7684 QoS \u8bbe\u7f6e\uff0c\u5f53\u51fa\u73b0\u6574\u4f53\u5e26\u5bbd\u4e0d\u8db3\u65f6\uff0c\u4f18\u5148\u7ea7\u8f83\u9ad8\u7684\u6d41\u91cf\u4f1a\u88ab\u4f18\u5148\u4fdd\u8bc1\uff0c\u5728 Kube-OVN \u4e2d\u901a\u8fc7 HtbQos \u8fdb\u884c\u8bbe\u7f6e\u3002 HtbQos \u5b9a\u4e49\u53ea\u6709\u4e00\u4e2a\u5b57\u6bb5\uff0c\u5373 .spec.priority \uff0c\u5b57\u6bb5\u53d6\u503c\u4ee3\u8868\u4e86\u4f18\u5148\u7ea7\u7684\u5927\u5c0f\u3002\u5728 Kube-OVN \u521d\u59cb\u5316\u65f6\u9884\u7f6e\u4e86\u4e09\u4e2a\u4e0d\u540c\u4f18\u5148\u7ea7\u7684\u5b9e\u4f8b\uff0c\u5206\u522b\u662f\uff1a # kubectl get htbqos NAME PRIORITY htbqos-high 100 htbqos-low 300 htbqos-medium 200 \u4f18\u5148\u7ea7\u987a\u5e8f\u662f\u76f8\u5bf9\u7684\uff0cpriority \u53d6\u503c\u8d8a\u5c0f\uff0cQoS \u4f18\u5148\u7ea7\u8d8a\u9ad8\u3002 Subnet Spec \u4e2d\u7684 HtbQos \u5b57\u6bb5\uff0c\u7528\u4e8e\u6307\u5b9a\u5f53\u524d Subnet \u7ed1\u5b9a\u7684 HtbQos \u5b9e\u4f8b\uff0c\u53c2\u8003\u5982\u4e0b: # kubectl get subnet test -o yaml apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: test spec: cidrBlock: 192.168.0.0/16 default: false gatewayType: distributed htbqos: htbqos-high ... \u5f53 Subnet \u7ed1\u5b9a\u4e86 HtbQos \u5b9e\u4f8b\u4e4b\u540e\uff0c\u8be5 Subnet \u4e0b\u7684\u6240\u6709 Pod \u90fd\u62e5\u6709\u76f8\u540c\u7684\u4f18\u5148\u7ea7\u8bbe\u7f6e\u3002 \u5982\u679c\u9700\u8981\u7ed9\u67d0\u4e2a Pod \u86cb\u5230\u6237\u8bbe\u7f6e HtbQoS \u53ef\u4ee5\u4f7f\u7528 Pod annotation ovn.kubernetes.io/priority \u3002 \u53d6\u503c\u5185\u5bb9\u4e3a\u5177\u4f53\u7684 priority \u6570\u503c\uff0c\u5982 ovn.kubernetes.io/priority: \"50\" \uff0c\u53ef\u4ee5\u7528\u4e8e\u5355\u72ec\u8bbe\u7f6e Pod \u7684 QoS \u4f18\u5148\u7ea7\u53c2\u6570\u3002 kubectl annotate --overwrite pod perf-4n4gt -n ls1 ovn.kubernetes.io/priority=50 \u5f53 Pod \u6240\u5728 Subnet \u6307\u5b9a\u4e86 HtbQos \u53c2\u6570\uff0c\u540c\u65f6 Pod \u53c8\u8bbe\u7f6e\u4e86 QoS \u4f18\u5148\u7ea7 annotation \u65f6\uff0c\u4ee5 Pod annotation \u53d6\u503c\u4e3a\u51c6\u3002 \u5bf9\u4e8e\u5e26\u5bbd\u8bbe\u7f6e\uff0c\u4ecd\u7136\u662f\u57fa\u4e8e Pod \u5355\u72ec\u8bbe\u7f6e\u7684\uff0c\u4f7f\u7528\u4e4b\u524d\u7684 annotation ovn.kubernetes.io/ingress_rate \u548c ovn.kubernetes.io/egress_rate \uff0c\u7528\u4e8e\u63a7\u5236 Pod \u7684\u53cc\u5411\u5e26\u5bbd\u3002 linux-netem QoS Pod \u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b annotation \u914d\u7f6e linux-netem \u7c7b\u578b QoS\uff1a ovn.kubernetes.io/latency \u3001 ovn.kubernetes.io/limit \u548c ovn.kubernetes.io/loss \u3002 ovn.kubernetes.io/latency \uff1a \u4e3a\u8bbe\u7f6e\u7684 Pod \u6d41\u91cf\u5ef6\u8fdf\u53c2\u6570\uff0c\u53d6\u503c\u4e3a\u6574\u5f62\u6570\u503c\uff0c\u5355\u4f4d\u4e3a ms\u3002 ovn.kubernetes.io/limit \uff1a \u4e3a qdisc \u961f\u5217\u53ef\u5bb9\u7eb3\u7684\u6700\u5927\u6570\u636e\u5305\u6570\uff0c\u53d6\u503c\u4e3a\u6574\u5f62\u6570\u503c\uff0c\u4f8b\u5982 1000\u3002 ovn.kubernetes.io/loss \uff1a \u4e3a\u8bbe\u7f6e\u7684\u62a5\u6587\u4e22\u5305\u6982\u7387\uff0c\u53d6\u503c\u4e3a float \u7c7b\u578b\uff0c\u4f8b\u5982\u53d6\u503c\u4e3a 0.2\uff0c\u5219\u4e3a\u8bbe\u7f6e 20% \u7684\u4e22\u5305\u6982\u7387\u3002","title":"\u5bb9\u5668\u7f51\u7edc QoS \u914d\u7f6e"},{"location":"guide/qos/#qos","text":"Kube-OVN \u652f\u6301\u4e09\u79cd\u4e0d\u540c\u7c7b\u578b\u7684 QoS \u6700\u5927\u5e26\u5bbd\u9650\u5236 QoS\u3002 linux-htb \uff0c\u57fa\u4e8e\u4f18\u5148\u7ea7\u7684 QoS\uff0c\u5f53\u5e26\u5bbd\u4e0d\u8db3\u65f6\u4f18\u5148\u7ea7\u8f83\u9ad8\u6d41\u91cf\u88ab\u9996\u5148\u6ee1\u8db3\u3002 linux-netem \uff0c\u6a21\u62df\u8bbe\u5907\u5e72\u6270\u4e22\u5305\u7b49\u7684 QoS\uff0c\u53ef\u7528\u4e8e\u6a21\u62df\u6d4b\u8bd5\u3002 \u5176\u4e2d linux-htb \u548c linux-netem \u4e24\u79cd QoS \u65e0\u6cd5\u540c\u65f6\u751f\u6548\uff0c\u82e5\u4e24\u79cd QoS \u90fd\u914d\u7f6e\u5230\u4e86\u540c\u4e00\u4e2a Pod \u4e0a\uff0c \u53ea\u6709 linux-htb \u7c7b\u578b QoS \u751f\u6548\u3002","title":"\u5bb9\u5668\u7f51\u7edc QoS \u914d\u7f6e"},{"location":"guide/qos/#qos_1","text":"\u8be5\u7c7b\u578b\u7684 QoS \u53ef\u4ee5\u901a\u8fc7 Pod annotation \u52a8\u6001\u8fdb\u884c\u914d\u7f6e\uff0c\u53ef\u4ee5\u5728\u4e0d\u4e2d\u65ad Pod \u8fd0\u884c\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u8c03\u6574\u3002 \u5e26\u5bbd\u9650\u901f\u7684\u5355\u4f4d\u4e3a Mbit/s apiVersion: v1 kind: Pod metadata: name: qos namespace: ls1 annotations: ovn.kubernetes.io/ingress_rate: \"3\" ovn.kubernetes.io/egress_rate: \"1\" spec: containers: - name: qos image: nginx:alpine \u4f7f\u7528 annotation \u52a8\u6001\u8c03\u6574 QoS\uff1a kubectl annotate --overwrite pod nginx-74d5899f46-d7qkn ovn.kubernetes.io/ingress_rate=3","title":"\u57fa\u4e8e\u6700\u5927\u5e26\u5bbd\u9650\u5236\u7684 QoS"},{"location":"guide/qos/#qos_2","text":"\u90e8\u7f72\u6027\u80fd\u6d4b\u8bd5\u9700\u8981\u7684\u5bb9\u5668 kind: DaemonSet apiVersion: apps/v1 metadata: name: perf namespace: ls1 labels: app: perf spec: selector: matchLabels: app: perf template: metadata: labels: app: perf spec: containers: - name: nginx image: kubeovn/perf \u8fdb\u5165\u5176\u4e2d\u4e00\u4e2a Pod \u5e76\u5f00\u542f iperf3 server\uff1a # kubectl exec -it perf-4n4gt -n ls1 sh # iperf3 -s ----------------------------------------------------------- Server listening on 5201 ----------------------------------------------------------- \u8fdb\u5165\u53e6\u4e00\u4e2a Pod \u8bf7\u6c42\u4e4b\u524d\u7684 Pod\uff1a # kubectl exec -it perf-d4mqc -n ls1 sh # iperf3 -c 10.66.0.12 Connecting to host 10.66.0.12, port 5201 [ 4] local 10.66.0.14 port 51544 connected to 10.66.0.12 port 5201 [ ID] Interval Transfer Bandwidth Retr Cwnd [ 4] 0.00-1.00 sec 86.4 MBytes 725 Mbits/sec 3 350 KBytes [ 4] 1.00-2.00 sec 89.9 MBytes 754 Mbits/sec 118 473 KBytes [ 4] 2.00-3.00 sec 101 MBytes 848 Mbits/sec 184 586 KBytes [ 4] 3.00-4.00 sec 104 MBytes 875 Mbits/sec 217 671 KBytes [ 4] 4.00-5.00 sec 111 MBytes 935 Mbits/sec 175 772 KBytes [ 4] 5.00-6.00 sec 100 MBytes 840 Mbits/sec 658 598 KBytes [ 4] 6.00-7.00 sec 106 MBytes 890 Mbits/sec 742 668 KBytes [ 4] 7.00-8.00 sec 102 MBytes 857 Mbits/sec 764 724 KBytes [ 4] 8.00-9.00 sec 97.4 MBytes 817 Mbits/sec 1175 764 KBytes [ 4] 9.00-10.00 sec 111 MBytes 934 Mbits/sec 1083 838 KBytes - - - - - - - - - - - - - - - - - - - - - - - - - [ ID] Interval Transfer Bandwidth Retr [ 4] 0.00-10.00 sec 1010 MBytes 848 Mbits/sec 5119 sender [ 4] 0.00-10.00 sec 1008 MBytes 846 Mbits/sec receiver iperf Done. \u4fee\u6539\u7b2c\u4e00\u4e2a Pod \u7684\u5165\u53e3\u5e26\u5bbd QoS\uff1a kubectl annotate --overwrite pod perf-4n4gt -n ls1 ovn.kubernetes.io/ingress_rate=30 \u518d\u6b21\u4ece\u7b2c\u4e8c\u4e2a Pod \u6d4b\u8bd5\u7b2c\u4e00\u4e2a Pod \u5e26\u5bbd\uff1a # iperf3 -c 10.66.0.12 Connecting to host 10.66.0.12, port 5201 [ 4] local 10.66.0.14 port 52372 connected to 10.66.0.12 port 5201 [ ID] Interval Transfer Bandwidth Retr Cwnd [ 4] 0.00-1.00 sec 3.66 MBytes 30.7 Mbits/sec 2 76.1 KBytes [ 4] 1.00-2.00 sec 3.43 MBytes 28.8 Mbits/sec 0 104 KBytes [ 4] 2.00-3.00 sec 3.50 MBytes 29.4 Mbits/sec 0 126 KBytes [ 4] 3.00-4.00 sec 3.50 MBytes 29.3 Mbits/sec 0 144 KBytes [ 4] 4.00-5.00 sec 3.43 MBytes 28.8 Mbits/sec 0 160 KBytes [ 4] 5.00-6.00 sec 3.43 MBytes 28.8 Mbits/sec 0 175 KBytes [ 4] 6.00-7.00 sec 3.50 MBytes 29.3 Mbits/sec 0 212 KBytes [ 4] 7.00-8.00 sec 3.68 MBytes 30.9 Mbits/sec 0 294 KBytes [ 4] 8.00-9.00 sec 3.74 MBytes 31.4 Mbits/sec 0 398 KBytes [ 4] 9.00-10.00 sec 3.80 MBytes 31.9 Mbits/sec 0 526 KBytes - - - - - - - - - - - - - - - - - - - - - - - - - [ ID] Interval Transfer Bandwidth Retr [ 4] 0.00-10.00 sec 35.7 MBytes 29.9 Mbits/sec 2 sender [ 4] 0.00-10.00 sec 34.5 MBytes 29.0 Mbits/sec receiver iperf Done.","title":"\u6d4b\u8bd5 QoS \u8c03\u6574"},{"location":"guide/qos/#linux-htb-qos","text":"linux-htb QoS \u662f\u57fa\u4e8e\u4f18\u5148\u7ea7\u7684 QoS \u8bbe\u7f6e\uff0c\u5f53\u51fa\u73b0\u6574\u4f53\u5e26\u5bbd\u4e0d\u8db3\u65f6\uff0c\u4f18\u5148\u7ea7\u8f83\u9ad8\u7684\u6d41\u91cf\u4f1a\u88ab\u4f18\u5148\u4fdd\u8bc1\uff0c\u5728 Kube-OVN \u4e2d\u901a\u8fc7 HtbQos \u8fdb\u884c\u8bbe\u7f6e\u3002 HtbQos \u5b9a\u4e49\u53ea\u6709\u4e00\u4e2a\u5b57\u6bb5\uff0c\u5373 .spec.priority \uff0c\u5b57\u6bb5\u53d6\u503c\u4ee3\u8868\u4e86\u4f18\u5148\u7ea7\u7684\u5927\u5c0f\u3002\u5728 Kube-OVN \u521d\u59cb\u5316\u65f6\u9884\u7f6e\u4e86\u4e09\u4e2a\u4e0d\u540c\u4f18\u5148\u7ea7\u7684\u5b9e\u4f8b\uff0c\u5206\u522b\u662f\uff1a # kubectl get htbqos NAME PRIORITY htbqos-high 100 htbqos-low 300 htbqos-medium 200 \u4f18\u5148\u7ea7\u987a\u5e8f\u662f\u76f8\u5bf9\u7684\uff0cpriority \u53d6\u503c\u8d8a\u5c0f\uff0cQoS \u4f18\u5148\u7ea7\u8d8a\u9ad8\u3002 Subnet Spec \u4e2d\u7684 HtbQos \u5b57\u6bb5\uff0c\u7528\u4e8e\u6307\u5b9a\u5f53\u524d Subnet \u7ed1\u5b9a\u7684 HtbQos \u5b9e\u4f8b\uff0c\u53c2\u8003\u5982\u4e0b: # kubectl get subnet test -o yaml apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: test spec: cidrBlock: 192.168.0.0/16 default: false gatewayType: distributed htbqos: htbqos-high ... \u5f53 Subnet \u7ed1\u5b9a\u4e86 HtbQos \u5b9e\u4f8b\u4e4b\u540e\uff0c\u8be5 Subnet \u4e0b\u7684\u6240\u6709 Pod \u90fd\u62e5\u6709\u76f8\u540c\u7684\u4f18\u5148\u7ea7\u8bbe\u7f6e\u3002 \u5982\u679c\u9700\u8981\u7ed9\u67d0\u4e2a Pod \u86cb\u5230\u6237\u8bbe\u7f6e HtbQoS \u53ef\u4ee5\u4f7f\u7528 Pod annotation ovn.kubernetes.io/priority \u3002 \u53d6\u503c\u5185\u5bb9\u4e3a\u5177\u4f53\u7684 priority \u6570\u503c\uff0c\u5982 ovn.kubernetes.io/priority: \"50\" \uff0c\u53ef\u4ee5\u7528\u4e8e\u5355\u72ec\u8bbe\u7f6e Pod \u7684 QoS \u4f18\u5148\u7ea7\u53c2\u6570\u3002 kubectl annotate --overwrite pod perf-4n4gt -n ls1 ovn.kubernetes.io/priority=50 \u5f53 Pod \u6240\u5728 Subnet \u6307\u5b9a\u4e86 HtbQos \u53c2\u6570\uff0c\u540c\u65f6 Pod \u53c8\u8bbe\u7f6e\u4e86 QoS \u4f18\u5148\u7ea7 annotation \u65f6\uff0c\u4ee5 Pod annotation \u53d6\u503c\u4e3a\u51c6\u3002 \u5bf9\u4e8e\u5e26\u5bbd\u8bbe\u7f6e\uff0c\u4ecd\u7136\u662f\u57fa\u4e8e Pod \u5355\u72ec\u8bbe\u7f6e\u7684\uff0c\u4f7f\u7528\u4e4b\u524d\u7684 annotation ovn.kubernetes.io/ingress_rate \u548c ovn.kubernetes.io/egress_rate \uff0c\u7528\u4e8e\u63a7\u5236 Pod \u7684\u53cc\u5411\u5e26\u5bbd\u3002","title":"linux-htb QoS"},{"location":"guide/qos/#linux-netem-qos","text":"Pod \u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b annotation \u914d\u7f6e linux-netem \u7c7b\u578b QoS\uff1a ovn.kubernetes.io/latency \u3001 ovn.kubernetes.io/limit \u548c ovn.kubernetes.io/loss \u3002 ovn.kubernetes.io/latency \uff1a \u4e3a\u8bbe\u7f6e\u7684 Pod \u6d41\u91cf\u5ef6\u8fdf\u53c2\u6570\uff0c\u53d6\u503c\u4e3a\u6574\u5f62\u6570\u503c\uff0c\u5355\u4f4d\u4e3a ms\u3002 ovn.kubernetes.io/limit \uff1a \u4e3a qdisc \u961f\u5217\u53ef\u5bb9\u7eb3\u7684\u6700\u5927\u6570\u636e\u5305\u6570\uff0c\u53d6\u503c\u4e3a\u6574\u5f62\u6570\u503c\uff0c\u4f8b\u5982 1000\u3002 ovn.kubernetes.io/loss \uff1a \u4e3a\u8bbe\u7f6e\u7684\u62a5\u6587\u4e22\u5305\u6982\u7387\uff0c\u53d6\u503c\u4e3a float \u7c7b\u578b\uff0c\u4f8b\u5982\u53d6\u503c\u4e3a 0.2\uff0c\u5219\u4e3a\u8bbe\u7f6e 20% \u7684\u4e22\u5305\u6982\u7387\u3002","title":"linux-netem QoS"},{"location":"guide/setup-options/","text":"\u5b89\u88c5\u548c\u914d\u7f6e\u9009\u9879 \u5728 \u4e00\u952e\u5b89\u88c5\u4e2d \u6211\u4eec\u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\u8fdb\u884c\u5b89\u88c5\uff0cKube-OVN \u8fd8\u652f\u6301\u66f4\u591a \u81ea\u5b9a\u4e49\u914d\u7f6e\uff0c\u53ef\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u8fdb\u884c\u914d\u7f6e\uff0c\u6216\u8005\u4e4b\u540e\u66f4\u6539\u5404\u4e2a\u7ec4\u4ef6\u7684\u53c2\u6570\u6765\u8fdb\u884c\u914d\u7f6e\u3002\u672c\u6587\u6863\u5c06\u4f1a\u4ecb\u7ecd\u8fd9\u4e9b\u81ea\u5b9a\u4e49\u9009\u9879 \u7684\u4f5c\u7528\uff0c\u4ee5\u53ca\u5982\u4f55\u8fdb\u884c\u914d\u7f6e\u3002 \u5185\u7f6e\u7f51\u7edc\u8bbe\u7f6e Kube-OVN \u5728\u5b89\u88c5\u65f6\u4f1a\u914d\u7f6e\u4e24\u4e2a\u5185\u7f6e\u5b50\u7f51\uff1a default \u5b50\u7f51\uff0c\u4f5c\u4e3a Pod \u5206\u914d IP \u4f7f\u7528\u7684\u9ed8\u8ba4\u5b50\u7f51\uff0c\u9ed8\u8ba4 CIDR \u4e3a 10.16.0.0/16 \uff0c\u7f51\u5173\u4e3a 10.16.0.1 \u3002 join \u5b50\u7f51\uff0c\u4f5c\u4e3a Node \u548c Pod \u4e4b\u95f4\u8fdb\u884c\u7f51\u7edc\u901a\u4fe1\u7684\u7279\u6b8a\u5b50\u7f51, \u9ed8\u8ba4 CIDR \u4e3a 100.64.0.0/16 \uff0c\u7f51\u5173\u4e3a 100.64.0.1 \u3002 \u5728\u5b89\u88c5\u65f6\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5\u811a\u672c\u5185\u7684\u914d\u7f6e\u8fdb\u884c\u66f4\u6539\uff1a POD_CIDR=\"10.16.0.0/16\" POD_GATEWAY=\"10.16.0.1\" JOIN_CIDR=\"100.64.0.0/16\" EXCLUDE_IPS=\"\" EXCLUDE_IP \u53ef\u8bbe\u7f6e POD_CIDR \u4e0d\u8fdb\u884c\u5206\u914d\u7684\u5730\u5740\u8303\u56f4\uff0c\u683c\u5f0f\u4e3a\uff1a 192.168.10.20..192.168.10.30 \u3002 \u9700\u8981\u6ce8\u610f Overlay \u60c5\u51b5\u4e0b\u8fd9\u4e24\u4e2a\u7f51\u7edc\u4e0d\u80fd\u548c\u5df2\u6709\u7684\u4e3b\u673a\u7f51\u7edc\u548c Service CIDR \u51b2\u7a81\u3002 \u5728\u5b89\u88c5\u540e\u53ef\u4ee5\u5bf9\u8fd9\u4e24\u4e2a\u7f51\u7edc\u7684\u5730\u5740\u8303\u56f4\u8fdb\u884c\u4fee\u6539\u8bf7\u53c2\u8003 \u4fee\u6539\u9ed8\u8ba4\u5b50\u7f51 \u548c \u4fee\u6539 Join \u5b50\u7f51 \u3002 Service \u7f51\u6bb5\u914d\u7f6e \u7531\u4e8e\u90e8\u5206 kube-proxy \u8bbe\u7f6e\u7684 iptables \u548c\u8def\u7531\u89c4\u5219\u4f1a\u548c Kube-OVN \u8bbe\u7f6e\u7684\u89c4\u5219\u4ea7\u751f\u4ea4\u96c6\uff0c\u56e0\u6b64 Kube-OVN \u9700\u8981\u77e5\u9053 Service \u7684 CIDR \u6765\u6b63\u786e\u8bbe\u7f6e\u5bf9\u5e94\u7684\u89c4\u5219\u3002 \u5728\u5b89\u88c5\u811a\u672c\u4e2d\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\uff1a SVC_CIDR=\"10.96.0.0/12\" \u6765\u8fdb\u884c\u914d\u7f6e\u3002 \u4e5f\u53ef\u4ee5\u5728\u5b89\u88c5\u540e\u901a\u8fc7\u4fee\u6539 kube-ovn-controller Deployment \u7684\u53c2\u6570\uff1a args: --service-cluster-ip-range=10.96.0.0/12 \u6765\u8fdb\u884c\u4fee\u6539\u3002 Overlay \u7f51\u5361\u9009\u62e9 \u5728\u8282\u70b9\u5b58\u5728\u591a\u5757\u7f51\u5361\u7684\u60c5\u51b5\u4e0b\uff0cKube-OVN \u9ed8\u8ba4\u4f1a\u9009\u62e9 Kubernetes Node IP \u5bf9\u5e94\u7684\u7f51\u5361\u4f5c\u4e3a\u5bb9\u5668\u95f4\u8de8\u8282\u70b9\u901a\u4fe1\u7684\u7f51\u5361\u5e76\u5efa\u7acb\u5bf9\u5e94\u7684\u96a7\u9053\u3002 \u5982\u679c\u9700\u8981\u9009\u62e9\u5176\u4ed6\u7684\u7f51\u5361\u5efa\u7acb\u5bb9\u5668\u96a7\u9053\uff0c\u53ef\u4ee5\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u4fee\u6539\uff1a IFACE=eth1 \u8be5\u9009\u9879\u652f\u6301\u4ee5\u9017\u53f7\u6240\u5206\u9694\u6b63\u5219\u8868\u8fbe\u5f0f,\u4f8b\u5982 ens[a-z0-9]*,eth[a-z0-9]* \u3002 \u5b89\u88c5\u540e\u4e5f\u53ef\u901a\u8fc7\u4fee\u6539 kube-ovn-cni DaemonSet \u7684\u53c2\u6570\u8fdb\u884c\u8c03\u6574\uff1a args: - --iface=eth1 \u5982\u679c\u6bcf\u53f0\u673a\u5668\u7684\u7f51\u5361\u540d\u5747\u4e0d\u540c\uff0c\u4e14\u6ca1\u6709\u56fa\u5b9a\u89c4\u5f8b\uff0c\u53ef\u4ee5\u4f7f\u7528\u8282\u70b9 annotation ovn.kubernetes.io/tunnel_interface \u8fdb\u884c\u6bcf\u4e2a\u8282\u70b9\u7684\u9010\u4e00\u914d\u7f6e\uff0c\u62e5\u6709\u8be5 annotation \u8282\u70b9\u4f1a\u8986\u76d6 iface \u7684\u914d\u7f6e\uff0c\u4f18\u5148\u4f7f\u7528 annotation\u3002 kubectl annotate node no1 ovn.kubernetes.io/tunnel_interface=ethx MTU \u8bbe\u7f6e \u7531\u4e8e Overlay \u5c01\u88c5\u9700\u8981\u5360\u636e\u989d\u5916\u7684\u7a7a\u95f4\uff0cKube-OVN \u5728\u521b\u5efa\u5bb9\u5668\u7f51\u5361\u65f6\u4f1a\u6839\u636e\u9009\u62e9\u7f51\u5361\u7684 MTU \u8fdb\u884c\u5bb9\u5668\u7f51\u5361\u7684 MTU \u8c03\u6574\uff0c \u9ed8\u8ba4\u60c5\u51b5\u4e0b Overlay \u5b50\u7f51\u4e0b Pod \u7f51\u5361 MTU \u4e3a\u4e3b\u673a\u7f51\u5361 MTU - 100\uff0cUnderlay \u5b50\u7f51\u4e0b\uff0cPod \u7f51\u5361\u548c\u4e3b\u673a\u7f51\u5361\u6709\u76f8\u540c MTU\u3002 \u5982\u679c\u9700\u8981\u8c03\u6574 Overlay \u5b50\u7f51\u4e0b MTU \u7684\u5927\u5c0f\uff0c\u53ef\u4ee5\u4fee\u6539 kube-ovn-cni DaemonSet \u7684\u53c2\u6570\uff1a args: - --mtu=1333 \u5168\u5c40\u6d41\u91cf\u955c\u50cf\u5f00\u542f\u8bbe\u7f6e \u5728\u5f00\u542f\u5168\u5c40\u6d41\u91cf\u955c\u50cf\u7684\u60c5\u51b5\u4e0b\uff0cKube-OVN \u4f1a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u521b\u5efa\u4e00\u5757 mirror0 \u7684\u865a\u62df\u7f51\u5361\uff0c\u590d\u5236\u5f53\u524d\u673a\u5668\u6240\u6709\u5bb9\u5668\u7f51\u7edc\u6d41\u91cf\u5230\u8be5\u7f51\u5361\u4e0a\uff0c \u7528\u6237\u53ef\u4ee5\u901a\u8fc7 tcpdump \u53ca\u5176\u4ed6\u5de5\u5177\u8fdb\u884c\u6d41\u91cf\u5206\u6790\uff0c\u8be5\u529f\u80fd\u53ef\u4ee5\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u901a\u8fc7\u4e0b\u9762\u7684\u914d\u7f6e\u5f00\u542f\uff1a ENABLE_MIRROR=tue \u4e5f\u53ef\u5728\u5b89\u88c5\u540e\u901a\u8fc7\u4fee\u6539 kube-ovn-cni DaemonSet \u7684\u53c2\u6570\u65b9\u5f0f\u8fdb\u884c\u8c03\u6574: args: - --enable-mirror=true \u6d41\u91cf\u955c\u50cf\u7684\u80fd\u529b\u5728\u9ed8\u8ba4\u5b89\u88c5\u4e2d\u4e3a\u5173\u95ed\uff0c\u5982\u679c\u9700\u8981\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u955c\u50cf\u6216\u9700\u8981\u5c06\u6d41\u91cf\u955c\u50cf\u5230\u989d\u5916\u7684\u7f51\u5361\u8bf7\u53c2\u8003 \u5bb9\u5668\u7f51\u7edc\u6d41\u91cf\u955c\u50cf \u3002 LB \u5f00\u542f\u8bbe\u7f6e Kube-OVN \u4f7f\u7528 OVN \u4e2d\u7684 L2 LB \u6765\u5b9e\u73b0 Service \u8f6c\u53d1\uff0c\u5728 Overlay \u573a\u666f\u4e2d\uff0c\u7528\u6237\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528 kube-proxy \u6765\u5b8c\u6210 Service \u6d41\u91cf\u8f6c\u53d1, \u4e5f\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528 Cilium Chain \u7684\u65b9\u5f0f\u5229\u7528 eBPF \u5b9e\u73b0 Service \u8fbe\u5230\u66f4\u597d\u7684\u6027\u80fd\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u53ef\u4ee5\u5173\u95ed Kube-OVN \u7684 LB \u529f\u80fd \u4ee5\u8fbe\u5230\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u66f4\u597d\u7684\u6027\u80fd\u3002 \u8be5\u529f\u80fd\u53ef\u4ee5\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u8fdb\u884c\u914d\u7f6e\uff1a ENABLE_LB=false \u6216\u8005\u5728\u5b89\u88c5\u540e\u901a\u8fc7\u66f4\u6539 kube-ovn-controller Deployment \u7684\u53c2\u6570\u8fdb\u884c\u914d\u7f6e\uff1a args: - --enable-lb=false LB \u7684\u529f\u80fd\u5728\u9ed8\u8ba4\u5b89\u88c5\u4e2d\u4e3a\u5f00\u542f\u3002 NetworkPolicy \u5f00\u542f\u8bbe\u7f6e Kube-OVN \u4f7f\u7528 OVN \u4e2d\u7684 ACL \u6765\u5b9e\u73b0 NetworkPolicy\uff0c\u7528\u6237\u53ef\u4ee5\u9009\u62e9\u4e0d\u9700\u8981\u4f7f\u7528 NetworkPolicy \u6216\u8005\u4f7f\u7528 Cilium Chain \u7684\u65b9\u5f0f\u5229\u7528 eBPF \u5b9e\u73b0 NetworkPolicy\uff0c \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u53ef\u4ee5\u5173\u95ed Kube-OVN \u7684 NetworkPolicy \u529f\u80fd\u4ee5\u8fbe\u5230\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u66f4\u597d\u7684\u6027\u80fd\u3002 \u8be5\u529f\u80fd\u53ef\u4ee5\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u8fdb\u884c\u914d\u7f6e\uff1a ENABLE_NP=false \u6216\u8005\u5728\u5b89\u88c5\u540e\u901a\u8fc7\u66f4\u6539 kube-ovn-controller Deployment \u7684\u53c2\u6570\u8fdb\u884c\u914d\u7f6e\uff1a args: - --enable-np=false NetworkPolicy \u7684\u80fd\u529b\u5728\u9ed8\u8ba4\u5b89\u88c5\u4e2d\u4e3a\u5f00\u542f\u3002 EIP \u548c SNAT \u5f00\u542f\u8bbe\u7f6e \u9ed8\u8ba4\u7f51\u7edc\u4e0b\u5982\u679c\u65e0\u9700\u4f7f\u7528 EIP \u548c SNAT \u7684\u80fd\u529b\uff0c\u53ef\u4ee5\u9009\u62e9\u5173\u95ed\u76f8\u5173\u529f\u80fd\uff0c\u4ee5\u51cf\u5c11 kube-ovn-controller \u5728\u521b\u5efa\u548c\u66f4\u65b0 \u7f51\u7edc\u65f6\u7684\u68c0\u67e5\u6d88\u8017\uff0c\u5728\u5927\u89c4\u6a21\u96c6\u7fa4\u73af\u5883\u4e0b\u53ef\u4ee5\u63d0\u5347\u5904\u7406\u901f\u5ea6\u3002 \u8be5\u529f\u80fd\u53ef\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u8fdb\u884c\u914d\u7f6e\uff1a ENABLE_EIP_SNAT=false \u6216\u8005\u5728\u5b89\u88c5\u540e\u901a\u8fc7\u66f4\u6539 kube-ovn-controller Deployment \u7684\u53c2\u6570\u8fdb\u884c\u914d\u7f6e\uff1a args: - --enable-eip-snat=false EIP \u548c SNAT \u7684\u80fd\u529b\u5728\u9ed8\u8ba4\u5b89\u88c5\u4e2d\u4e3a\u5f00\u542f\u3002\u8be5\u529f\u80fd\u7684\u76f8\u5173\u4f7f\u7528\u548c\u5176\u4ed6\u53ef\u914d\u53c2\u6570\u8bf7\u53c2\u8003 EIP \u548c SNAT \u914d\u7f6e \u3002 \u96c6\u4e2d\u5f0f\u7f51\u5173 ECMP \u5f00\u542f\u8bbe\u7f6e \u96c6\u4e2d\u5f0f\u7f51\u5173\u652f\u6301\u4e3b\u5907\u548c ECMP \u4e24\u79cd\u9ad8\u53ef\u7528\u6a21\u5f0f\uff0c\u5982\u679c\u9700\u8981\u542f\u7528 ECMP \u6a21\u5f0f\uff0c \u9700\u8981\u66f4\u6539 kube-ovn-controller Deployment \u7684\u53c2\u6570\u8fdb\u884c\u914d\u7f6e: args: - --enable-ecmp=true \u96c6\u4e2d\u5f0f\u7f51\u5173\u9ed8\u8ba4\u5b89\u88c5\u4e0b\u4e3a\u4e3b\u5907\u6a21\u5f0f\uff0c\u66f4\u591a\u7f51\u5173\u76f8\u5173\u5185\u5bb9\u8bf7\u53c2\u8003 \u5b50\u7f51\u4f7f\u7528 \u3002 Kubevirt VM \u56fa\u5b9a\u5730\u5740\u5f00\u542f\u8bbe\u7f6e \u9488\u5bf9 Kubevirt \u521b\u5efa\u7684 VM \u5b9e\u4f8b\uff0c kube-ovn-controller \u53ef\u4ee5\u6309\u7167\u7c7b\u4f3c StatefulSet Pod \u7684\u65b9\u5f0f\u8fdb\u884c IP \u5730\u5740\u5206\u914d\u548c\u7ba1\u7406\u3002 \u4ee5\u8fbe\u5230 VM \u5b9e\u4f8b\u5728\u751f\u547d\u5468\u671f\u5185\u542f\u505c\uff0c\u5347\u7ea7\uff0c\u8fc1\u79fb\u7b49\u64cd\u4f5c\u8fc7\u7a0b\u4e2d\u5730\u5740\u56fa\u5b9a\u4e0d\u53d8\uff0c\u66f4\u7b26\u865a\u62df\u5316\u5408\u7528\u6237\u7684\u5b9e\u9645\u4f7f\u7528\u4f53\u9a8c\u3002 \u8be5\u529f\u80fd\u9ed8\u8ba4\u5173\u95ed\uff0c\u82e5\u8981\u4f7f\u7528\u6b64\u529f\u80fd\uff0c\u9700\u8981\u5728 kube-ovn-controller Deployment \u7684\u542f\u52a8\u547d\u4ee4\u4e2d\u5f00\u542f\u5982\u4e0b\u53c2\u6570\uff1a args: - --keep-vm-ip=true CNI \u914d\u7f6e\u76f8\u5173\u8bbe\u7f6e Kube-OVN \u9ed8\u8ba4\u4f1a\u5728 /opt/cni/bin \u76ee\u5f55\u4e0b\u5b89\u88c5 CNI \u6267\u884c\u6587\u4ef6\uff0c\u5728 /etc/cni/net.d \u76ee\u5f55\u4e0b\u5b89\u88c5 CNI \u914d\u7f6e\u6587\u4ef6 01-kube-ovn.conflist \u3002 \u5982\u679c\u9700\u8981\u66f4\u6539\u5b89\u88c5\u4f4d\u7f6e\u548c CNI \u914d\u7f6e\u6587\u4ef6\u7684\u4f18\u5148\u7ea7\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5\u811a\u672c\u7684\u4e0b\u5217\u53c2\u6570\u8fdb\u884c\u8c03\u6574\uff1a CNI_CONF_DIR=\"/etc/cni/net.d\" CNI_BIN_DIR=\"/opt/cni/bin\" CNI_CONFIG_PRIORITY=\"01\" \u6216\u8005\u5728\u5b89\u88c5\u540e\u66f4\u6539 kube-ovn-cni DaemonSet \u7684 Volume \u6302\u8f7d\u548c\u542f\u52a8\u53c2\u6570\uff1a volumes: - name: cni-conf hostPath: path: \"/etc/cni/net.d\" - name: cni-bin hostPath: path:\"/opt/cni/bin\" ... args: - --cni-conf-name=01-kube-ovn.conflist \u96a7\u9053\u7c7b\u578b\u8bbe\u7f6e Kube-OVN \u9ed8\u8ba4 Overlay \u7684\u5c01\u88c5\u6a21\u5f0f\u4e3a Geneve\uff0c\u5982\u679c\u60f3\u66f4\u6362\u4e3a Vxlan \u6216 STT\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5\u811a\u672c\u7684\u4e0b\u5217\u53c2\u6570\u8fdb\u884c\u8c03\u6574\uff1a TUNNEL_TYPE=\"vxlan\" \u6216\u8005\u5728\u5b89\u88c5\u540e\u66f4\u6539 ovs-ovn DaemonSet \u7684\u73af\u5883\u53d8\u91cf\uff1a env: - name: TUNNEL_TYPE value: \"vxlan\" \u5982\u679c\u9700\u8981\u4f7f\u7528 STT \u96a7\u9053\u9700\u8981\u989d\u5916\u7f16\u8bd1 ovs \u7684\u5185\u6838\u6a21\u5757\uff0c\u8bf7\u53c2\u8003 \u6027\u80fd\u8c03\u4f18 \u3002 \u4e0d\u540c\u534f\u8bae\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\u7684\u533a\u522b\u8bf7\u53c2\u8003 \u96a7\u9053\u534f\u8bae\u8bf4\u660e \u3002 SSL \u8bbe\u7f6e OVN DB \u7684 API \u63a5\u53e3\u652f\u6301 SSL \u52a0\u5bc6\u6765\u4fdd\u8bc1\u8fde\u63a5\u5b89\u5168\uff0c\u5982\u8981\u5f00\u542f\u53ef\u8c03\u6574\u5b89\u88c5\u811a\u672c\u4e2d\u7684\u5982\u4e0b\u53c2\u6570: ENABLE_SSL=true SSL \u529f\u80fd\u9ed8\u8ba4\u5b89\u88c5\u4e0b\u4e3a\u5173\u95ed\u6a21\u5f0f\u3002","title":"\u5b89\u88c5\u548c\u914d\u7f6e\u9009\u9879"},{"location":"guide/setup-options/#_1","text":"\u5728 \u4e00\u952e\u5b89\u88c5\u4e2d \u6211\u4eec\u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\u8fdb\u884c\u5b89\u88c5\uff0cKube-OVN \u8fd8\u652f\u6301\u66f4\u591a \u81ea\u5b9a\u4e49\u914d\u7f6e\uff0c\u53ef\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u8fdb\u884c\u914d\u7f6e\uff0c\u6216\u8005\u4e4b\u540e\u66f4\u6539\u5404\u4e2a\u7ec4\u4ef6\u7684\u53c2\u6570\u6765\u8fdb\u884c\u914d\u7f6e\u3002\u672c\u6587\u6863\u5c06\u4f1a\u4ecb\u7ecd\u8fd9\u4e9b\u81ea\u5b9a\u4e49\u9009\u9879 \u7684\u4f5c\u7528\uff0c\u4ee5\u53ca\u5982\u4f55\u8fdb\u884c\u914d\u7f6e\u3002","title":"\u5b89\u88c5\u548c\u914d\u7f6e\u9009\u9879"},{"location":"guide/setup-options/#_2","text":"Kube-OVN \u5728\u5b89\u88c5\u65f6\u4f1a\u914d\u7f6e\u4e24\u4e2a\u5185\u7f6e\u5b50\u7f51\uff1a default \u5b50\u7f51\uff0c\u4f5c\u4e3a Pod \u5206\u914d IP \u4f7f\u7528\u7684\u9ed8\u8ba4\u5b50\u7f51\uff0c\u9ed8\u8ba4 CIDR \u4e3a 10.16.0.0/16 \uff0c\u7f51\u5173\u4e3a 10.16.0.1 \u3002 join \u5b50\u7f51\uff0c\u4f5c\u4e3a Node \u548c Pod \u4e4b\u95f4\u8fdb\u884c\u7f51\u7edc\u901a\u4fe1\u7684\u7279\u6b8a\u5b50\u7f51, \u9ed8\u8ba4 CIDR \u4e3a 100.64.0.0/16 \uff0c\u7f51\u5173\u4e3a 100.64.0.1 \u3002 \u5728\u5b89\u88c5\u65f6\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5\u811a\u672c\u5185\u7684\u914d\u7f6e\u8fdb\u884c\u66f4\u6539\uff1a POD_CIDR=\"10.16.0.0/16\" POD_GATEWAY=\"10.16.0.1\" JOIN_CIDR=\"100.64.0.0/16\" EXCLUDE_IPS=\"\" EXCLUDE_IP \u53ef\u8bbe\u7f6e POD_CIDR \u4e0d\u8fdb\u884c\u5206\u914d\u7684\u5730\u5740\u8303\u56f4\uff0c\u683c\u5f0f\u4e3a\uff1a 192.168.10.20..192.168.10.30 \u3002 \u9700\u8981\u6ce8\u610f Overlay \u60c5\u51b5\u4e0b\u8fd9\u4e24\u4e2a\u7f51\u7edc\u4e0d\u80fd\u548c\u5df2\u6709\u7684\u4e3b\u673a\u7f51\u7edc\u548c Service CIDR \u51b2\u7a81\u3002 \u5728\u5b89\u88c5\u540e\u53ef\u4ee5\u5bf9\u8fd9\u4e24\u4e2a\u7f51\u7edc\u7684\u5730\u5740\u8303\u56f4\u8fdb\u884c\u4fee\u6539\u8bf7\u53c2\u8003 \u4fee\u6539\u9ed8\u8ba4\u5b50\u7f51 \u548c \u4fee\u6539 Join \u5b50\u7f51 \u3002","title":"\u5185\u7f6e\u7f51\u7edc\u8bbe\u7f6e"},{"location":"guide/setup-options/#service","text":"\u7531\u4e8e\u90e8\u5206 kube-proxy \u8bbe\u7f6e\u7684 iptables \u548c\u8def\u7531\u89c4\u5219\u4f1a\u548c Kube-OVN \u8bbe\u7f6e\u7684\u89c4\u5219\u4ea7\u751f\u4ea4\u96c6\uff0c\u56e0\u6b64 Kube-OVN \u9700\u8981\u77e5\u9053 Service \u7684 CIDR \u6765\u6b63\u786e\u8bbe\u7f6e\u5bf9\u5e94\u7684\u89c4\u5219\u3002 \u5728\u5b89\u88c5\u811a\u672c\u4e2d\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539\uff1a SVC_CIDR=\"10.96.0.0/12\" \u6765\u8fdb\u884c\u914d\u7f6e\u3002 \u4e5f\u53ef\u4ee5\u5728\u5b89\u88c5\u540e\u901a\u8fc7\u4fee\u6539 kube-ovn-controller Deployment \u7684\u53c2\u6570\uff1a args: --service-cluster-ip-range=10.96.0.0/12 \u6765\u8fdb\u884c\u4fee\u6539\u3002","title":"Service \u7f51\u6bb5\u914d\u7f6e"},{"location":"guide/setup-options/#overlay","text":"\u5728\u8282\u70b9\u5b58\u5728\u591a\u5757\u7f51\u5361\u7684\u60c5\u51b5\u4e0b\uff0cKube-OVN \u9ed8\u8ba4\u4f1a\u9009\u62e9 Kubernetes Node IP \u5bf9\u5e94\u7684\u7f51\u5361\u4f5c\u4e3a\u5bb9\u5668\u95f4\u8de8\u8282\u70b9\u901a\u4fe1\u7684\u7f51\u5361\u5e76\u5efa\u7acb\u5bf9\u5e94\u7684\u96a7\u9053\u3002 \u5982\u679c\u9700\u8981\u9009\u62e9\u5176\u4ed6\u7684\u7f51\u5361\u5efa\u7acb\u5bb9\u5668\u96a7\u9053\uff0c\u53ef\u4ee5\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u4fee\u6539\uff1a IFACE=eth1 \u8be5\u9009\u9879\u652f\u6301\u4ee5\u9017\u53f7\u6240\u5206\u9694\u6b63\u5219\u8868\u8fbe\u5f0f,\u4f8b\u5982 ens[a-z0-9]*,eth[a-z0-9]* \u3002 \u5b89\u88c5\u540e\u4e5f\u53ef\u901a\u8fc7\u4fee\u6539 kube-ovn-cni DaemonSet \u7684\u53c2\u6570\u8fdb\u884c\u8c03\u6574\uff1a args: - --iface=eth1 \u5982\u679c\u6bcf\u53f0\u673a\u5668\u7684\u7f51\u5361\u540d\u5747\u4e0d\u540c\uff0c\u4e14\u6ca1\u6709\u56fa\u5b9a\u89c4\u5f8b\uff0c\u53ef\u4ee5\u4f7f\u7528\u8282\u70b9 annotation ovn.kubernetes.io/tunnel_interface \u8fdb\u884c\u6bcf\u4e2a\u8282\u70b9\u7684\u9010\u4e00\u914d\u7f6e\uff0c\u62e5\u6709\u8be5 annotation \u8282\u70b9\u4f1a\u8986\u76d6 iface \u7684\u914d\u7f6e\uff0c\u4f18\u5148\u4f7f\u7528 annotation\u3002 kubectl annotate node no1 ovn.kubernetes.io/tunnel_interface=ethx","title":"Overlay \u7f51\u5361\u9009\u62e9"},{"location":"guide/setup-options/#mtu","text":"\u7531\u4e8e Overlay \u5c01\u88c5\u9700\u8981\u5360\u636e\u989d\u5916\u7684\u7a7a\u95f4\uff0cKube-OVN \u5728\u521b\u5efa\u5bb9\u5668\u7f51\u5361\u65f6\u4f1a\u6839\u636e\u9009\u62e9\u7f51\u5361\u7684 MTU \u8fdb\u884c\u5bb9\u5668\u7f51\u5361\u7684 MTU \u8c03\u6574\uff0c \u9ed8\u8ba4\u60c5\u51b5\u4e0b Overlay \u5b50\u7f51\u4e0b Pod \u7f51\u5361 MTU \u4e3a\u4e3b\u673a\u7f51\u5361 MTU - 100\uff0cUnderlay \u5b50\u7f51\u4e0b\uff0cPod \u7f51\u5361\u548c\u4e3b\u673a\u7f51\u5361\u6709\u76f8\u540c MTU\u3002 \u5982\u679c\u9700\u8981\u8c03\u6574 Overlay \u5b50\u7f51\u4e0b MTU \u7684\u5927\u5c0f\uff0c\u53ef\u4ee5\u4fee\u6539 kube-ovn-cni DaemonSet \u7684\u53c2\u6570\uff1a args: - --mtu=1333","title":"MTU \u8bbe\u7f6e"},{"location":"guide/setup-options/#_3","text":"\u5728\u5f00\u542f\u5168\u5c40\u6d41\u91cf\u955c\u50cf\u7684\u60c5\u51b5\u4e0b\uff0cKube-OVN \u4f1a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u521b\u5efa\u4e00\u5757 mirror0 \u7684\u865a\u62df\u7f51\u5361\uff0c\u590d\u5236\u5f53\u524d\u673a\u5668\u6240\u6709\u5bb9\u5668\u7f51\u7edc\u6d41\u91cf\u5230\u8be5\u7f51\u5361\u4e0a\uff0c \u7528\u6237\u53ef\u4ee5\u901a\u8fc7 tcpdump \u53ca\u5176\u4ed6\u5de5\u5177\u8fdb\u884c\u6d41\u91cf\u5206\u6790\uff0c\u8be5\u529f\u80fd\u53ef\u4ee5\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u901a\u8fc7\u4e0b\u9762\u7684\u914d\u7f6e\u5f00\u542f\uff1a ENABLE_MIRROR=tue \u4e5f\u53ef\u5728\u5b89\u88c5\u540e\u901a\u8fc7\u4fee\u6539 kube-ovn-cni DaemonSet \u7684\u53c2\u6570\u65b9\u5f0f\u8fdb\u884c\u8c03\u6574: args: - --enable-mirror=true \u6d41\u91cf\u955c\u50cf\u7684\u80fd\u529b\u5728\u9ed8\u8ba4\u5b89\u88c5\u4e2d\u4e3a\u5173\u95ed\uff0c\u5982\u679c\u9700\u8981\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u955c\u50cf\u6216\u9700\u8981\u5c06\u6d41\u91cf\u955c\u50cf\u5230\u989d\u5916\u7684\u7f51\u5361\u8bf7\u53c2\u8003 \u5bb9\u5668\u7f51\u7edc\u6d41\u91cf\u955c\u50cf \u3002","title":"\u5168\u5c40\u6d41\u91cf\u955c\u50cf\u5f00\u542f\u8bbe\u7f6e"},{"location":"guide/setup-options/#lb","text":"Kube-OVN \u4f7f\u7528 OVN \u4e2d\u7684 L2 LB \u6765\u5b9e\u73b0 Service \u8f6c\u53d1\uff0c\u5728 Overlay \u573a\u666f\u4e2d\uff0c\u7528\u6237\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528 kube-proxy \u6765\u5b8c\u6210 Service \u6d41\u91cf\u8f6c\u53d1, \u4e5f\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528 Cilium Chain \u7684\u65b9\u5f0f\u5229\u7528 eBPF \u5b9e\u73b0 Service \u8fbe\u5230\u66f4\u597d\u7684\u6027\u80fd\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u53ef\u4ee5\u5173\u95ed Kube-OVN \u7684 LB \u529f\u80fd \u4ee5\u8fbe\u5230\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u66f4\u597d\u7684\u6027\u80fd\u3002 \u8be5\u529f\u80fd\u53ef\u4ee5\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u8fdb\u884c\u914d\u7f6e\uff1a ENABLE_LB=false \u6216\u8005\u5728\u5b89\u88c5\u540e\u901a\u8fc7\u66f4\u6539 kube-ovn-controller Deployment \u7684\u53c2\u6570\u8fdb\u884c\u914d\u7f6e\uff1a args: - --enable-lb=false LB \u7684\u529f\u80fd\u5728\u9ed8\u8ba4\u5b89\u88c5\u4e2d\u4e3a\u5f00\u542f\u3002","title":"LB \u5f00\u542f\u8bbe\u7f6e"},{"location":"guide/setup-options/#networkpolicy","text":"Kube-OVN \u4f7f\u7528 OVN \u4e2d\u7684 ACL \u6765\u5b9e\u73b0 NetworkPolicy\uff0c\u7528\u6237\u53ef\u4ee5\u9009\u62e9\u4e0d\u9700\u8981\u4f7f\u7528 NetworkPolicy \u6216\u8005\u4f7f\u7528 Cilium Chain \u7684\u65b9\u5f0f\u5229\u7528 eBPF \u5b9e\u73b0 NetworkPolicy\uff0c \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u53ef\u4ee5\u5173\u95ed Kube-OVN \u7684 NetworkPolicy \u529f\u80fd\u4ee5\u8fbe\u5230\u63a7\u5236\u9762\u548c\u6570\u636e\u9762\u66f4\u597d\u7684\u6027\u80fd\u3002 \u8be5\u529f\u80fd\u53ef\u4ee5\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u8fdb\u884c\u914d\u7f6e\uff1a ENABLE_NP=false \u6216\u8005\u5728\u5b89\u88c5\u540e\u901a\u8fc7\u66f4\u6539 kube-ovn-controller Deployment \u7684\u53c2\u6570\u8fdb\u884c\u914d\u7f6e\uff1a args: - --enable-np=false NetworkPolicy \u7684\u80fd\u529b\u5728\u9ed8\u8ba4\u5b89\u88c5\u4e2d\u4e3a\u5f00\u542f\u3002","title":"NetworkPolicy \u5f00\u542f\u8bbe\u7f6e"},{"location":"guide/setup-options/#eip-snat","text":"\u9ed8\u8ba4\u7f51\u7edc\u4e0b\u5982\u679c\u65e0\u9700\u4f7f\u7528 EIP \u548c SNAT \u7684\u80fd\u529b\uff0c\u53ef\u4ee5\u9009\u62e9\u5173\u95ed\u76f8\u5173\u529f\u80fd\uff0c\u4ee5\u51cf\u5c11 kube-ovn-controller \u5728\u521b\u5efa\u548c\u66f4\u65b0 \u7f51\u7edc\u65f6\u7684\u68c0\u67e5\u6d88\u8017\uff0c\u5728\u5927\u89c4\u6a21\u96c6\u7fa4\u73af\u5883\u4e0b\u53ef\u4ee5\u63d0\u5347\u5904\u7406\u901f\u5ea6\u3002 \u8be5\u529f\u80fd\u53ef\u5728\u5b89\u88c5\u811a\u672c\u4e2d\u8fdb\u884c\u914d\u7f6e\uff1a ENABLE_EIP_SNAT=false \u6216\u8005\u5728\u5b89\u88c5\u540e\u901a\u8fc7\u66f4\u6539 kube-ovn-controller Deployment \u7684\u53c2\u6570\u8fdb\u884c\u914d\u7f6e\uff1a args: - --enable-eip-snat=false EIP \u548c SNAT \u7684\u80fd\u529b\u5728\u9ed8\u8ba4\u5b89\u88c5\u4e2d\u4e3a\u5f00\u542f\u3002\u8be5\u529f\u80fd\u7684\u76f8\u5173\u4f7f\u7528\u548c\u5176\u4ed6\u53ef\u914d\u53c2\u6570\u8bf7\u53c2\u8003 EIP \u548c SNAT \u914d\u7f6e \u3002","title":"EIP \u548c SNAT \u5f00\u542f\u8bbe\u7f6e"},{"location":"guide/setup-options/#ecmp","text":"\u96c6\u4e2d\u5f0f\u7f51\u5173\u652f\u6301\u4e3b\u5907\u548c ECMP \u4e24\u79cd\u9ad8\u53ef\u7528\u6a21\u5f0f\uff0c\u5982\u679c\u9700\u8981\u542f\u7528 ECMP \u6a21\u5f0f\uff0c \u9700\u8981\u66f4\u6539 kube-ovn-controller Deployment \u7684\u53c2\u6570\u8fdb\u884c\u914d\u7f6e: args: - --enable-ecmp=true \u96c6\u4e2d\u5f0f\u7f51\u5173\u9ed8\u8ba4\u5b89\u88c5\u4e0b\u4e3a\u4e3b\u5907\u6a21\u5f0f\uff0c\u66f4\u591a\u7f51\u5173\u76f8\u5173\u5185\u5bb9\u8bf7\u53c2\u8003 \u5b50\u7f51\u4f7f\u7528 \u3002","title":"\u96c6\u4e2d\u5f0f\u7f51\u5173 ECMP \u5f00\u542f\u8bbe\u7f6e"},{"location":"guide/setup-options/#kubevirt-vm","text":"\u9488\u5bf9 Kubevirt \u521b\u5efa\u7684 VM \u5b9e\u4f8b\uff0c kube-ovn-controller \u53ef\u4ee5\u6309\u7167\u7c7b\u4f3c StatefulSet Pod \u7684\u65b9\u5f0f\u8fdb\u884c IP \u5730\u5740\u5206\u914d\u548c\u7ba1\u7406\u3002 \u4ee5\u8fbe\u5230 VM \u5b9e\u4f8b\u5728\u751f\u547d\u5468\u671f\u5185\u542f\u505c\uff0c\u5347\u7ea7\uff0c\u8fc1\u79fb\u7b49\u64cd\u4f5c\u8fc7\u7a0b\u4e2d\u5730\u5740\u56fa\u5b9a\u4e0d\u53d8\uff0c\u66f4\u7b26\u865a\u62df\u5316\u5408\u7528\u6237\u7684\u5b9e\u9645\u4f7f\u7528\u4f53\u9a8c\u3002 \u8be5\u529f\u80fd\u9ed8\u8ba4\u5173\u95ed\uff0c\u82e5\u8981\u4f7f\u7528\u6b64\u529f\u80fd\uff0c\u9700\u8981\u5728 kube-ovn-controller Deployment \u7684\u542f\u52a8\u547d\u4ee4\u4e2d\u5f00\u542f\u5982\u4e0b\u53c2\u6570\uff1a args: - --keep-vm-ip=true","title":"Kubevirt VM \u56fa\u5b9a\u5730\u5740\u5f00\u542f\u8bbe\u7f6e"},{"location":"guide/setup-options/#cni","text":"Kube-OVN \u9ed8\u8ba4\u4f1a\u5728 /opt/cni/bin \u76ee\u5f55\u4e0b\u5b89\u88c5 CNI \u6267\u884c\u6587\u4ef6\uff0c\u5728 /etc/cni/net.d \u76ee\u5f55\u4e0b\u5b89\u88c5 CNI \u914d\u7f6e\u6587\u4ef6 01-kube-ovn.conflist \u3002 \u5982\u679c\u9700\u8981\u66f4\u6539\u5b89\u88c5\u4f4d\u7f6e\u548c CNI \u914d\u7f6e\u6587\u4ef6\u7684\u4f18\u5148\u7ea7\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5\u811a\u672c\u7684\u4e0b\u5217\u53c2\u6570\u8fdb\u884c\u8c03\u6574\uff1a CNI_CONF_DIR=\"/etc/cni/net.d\" CNI_BIN_DIR=\"/opt/cni/bin\" CNI_CONFIG_PRIORITY=\"01\" \u6216\u8005\u5728\u5b89\u88c5\u540e\u66f4\u6539 kube-ovn-cni DaemonSet \u7684 Volume \u6302\u8f7d\u548c\u542f\u52a8\u53c2\u6570\uff1a volumes: - name: cni-conf hostPath: path: \"/etc/cni/net.d\" - name: cni-bin hostPath: path:\"/opt/cni/bin\" ... args: - --cni-conf-name=01-kube-ovn.conflist","title":"CNI \u914d\u7f6e\u76f8\u5173\u8bbe\u7f6e"},{"location":"guide/setup-options/#_4","text":"Kube-OVN \u9ed8\u8ba4 Overlay \u7684\u5c01\u88c5\u6a21\u5f0f\u4e3a Geneve\uff0c\u5982\u679c\u60f3\u66f4\u6362\u4e3a Vxlan \u6216 STT\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5\u811a\u672c\u7684\u4e0b\u5217\u53c2\u6570\u8fdb\u884c\u8c03\u6574\uff1a TUNNEL_TYPE=\"vxlan\" \u6216\u8005\u5728\u5b89\u88c5\u540e\u66f4\u6539 ovs-ovn DaemonSet \u7684\u73af\u5883\u53d8\u91cf\uff1a env: - name: TUNNEL_TYPE value: \"vxlan\" \u5982\u679c\u9700\u8981\u4f7f\u7528 STT \u96a7\u9053\u9700\u8981\u989d\u5916\u7f16\u8bd1 ovs \u7684\u5185\u6838\u6a21\u5757\uff0c\u8bf7\u53c2\u8003 \u6027\u80fd\u8c03\u4f18 \u3002 \u4e0d\u540c\u534f\u8bae\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\u7684\u533a\u522b\u8bf7\u53c2\u8003 \u96a7\u9053\u534f\u8bae\u8bf4\u660e \u3002","title":"\u96a7\u9053\u7c7b\u578b\u8bbe\u7f6e"},{"location":"guide/setup-options/#ssl","text":"OVN DB \u7684 API \u63a5\u53e3\u652f\u6301 SSL \u52a0\u5bc6\u6765\u4fdd\u8bc1\u8fde\u63a5\u5b89\u5168\uff0c\u5982\u8981\u5f00\u542f\u53ef\u8c03\u6574\u5b89\u88c5\u811a\u672c\u4e2d\u7684\u5982\u4e0b\u53c2\u6570: ENABLE_SSL=true SSL \u529f\u80fd\u9ed8\u8ba4\u5b89\u88c5\u4e0b\u4e3a\u5173\u95ed\u6a21\u5f0f\u3002","title":"SSL \u8bbe\u7f6e"},{"location":"guide/static-ip-mac/","text":"\u56fa\u5b9a\u5730\u5740 Kube-OVN \u9ed8\u8ba4\u4f1a\u6839\u636e Pod \u6240\u5728 Namespace \u6240\u5c5e\u7684\u5b50\u7f51\u4e2d\u968f\u673a\u5206\u914d IP \u548c Mac\u3002 \u9488\u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u9700\u8981\u56fa\u5b9a\u5730\u5740\u7684\u60c5\u51b5\uff0cKube-OVN \u6839\u636e\u4e0d\u540c\u7684\u573a\u666f\uff0c\u63d0\u4f9b\u4e86\u591a\u4e2d\u56fa\u5b9a\u5730\u5740\u7684\u65b9\u6cd5\uff1a \u5355\u4e2a Pod \u56fa\u5b9a IP/Mac\u3002 Workload \u901a\u7528 IP Pool \u65b9\u5f0f\u6307\u5b9a\u56fa\u5b9a\u5730\u5740\u8303\u56f4\u3002 StatefulSet \u56fa\u5b9a\u5730\u5740\u3002 Kubevirt VM \u56fa\u5b9a\u5730\u5740\u3002 \u5355\u4e2a Pod \u56fa\u5b9a IP \u548c Mac \u53ef\u4ee5\u5728\u521b\u5efa Pod \u65f6\u901a\u8fc7 annotation \u6765\u6307\u5b9a Pod \u8fd0\u884c\u65f6\u6240\u9700\u7684 IP/Mac, kube-ovn-controller \u8fd0\u884c\u65f6\u5c06\u4f1a\u8df3\u8fc7\u5730\u5740\u968f\u673a\u5206\u914d\u9636\u6bb5\uff0c\u7ecf\u8fc7\u51b2\u7a81\u68c0\u6d4b\u540e\u76f4\u63a5\u4f7f\u7528\u6307\u5b9a\u5730\u5740\uff0c\u5982\u4e0b\u6240\u793a\uff1a apiVersion: v1 kind: Pod metadata: name: static-ip namespace: ls1 annotations: ovn.kubernetes.io/ip_address: 10.16.0.15 ovn.kubernetes.io/mac_address: 00:00:00:53:6B:B6 spec: containers: - name: static-ip image: nginx:alpine \u5728\u4f7f\u7528 annotation \u5b9a\u4e49\u5355\u4e2a Pod IP/Mac \u65f6\u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u51e0\u70b9\uff1a \u6240\u4f7f\u7528\u7684 IP/Mac \u4e0d\u80fd\u548c\u5df2\u6709\u7684 IP/Mac \u51b2\u7a81\u3002 IP \u5fc5\u987b\u5728\u6240\u5c5e\u5b50\u7f51\u7684 CIDR \u5185\u3002 \u53ef\u4ee5\u53ea\u6307\u5b9a IP \u6216 Mac\uff0c\u53ea\u6307\u5b9a\u4e00\u4e2a\u65f6\uff0c\u53e6\u4e00\u4e2a\u4f1a\u968f\u673a\u5206\u914d\u3002 Workload \u901a\u7528 IP Pool \u56fa\u5b9a\u5730\u5740 Kube-OVN \u652f\u6301\u901a\u8fc7 annotation ovn.kubernetes.io/ip_pool \u7ed9 Workload\uff08Deployment/StatefulSet/DaemonSet/Job/CronJob\uff09\u8bbe\u7f6e\u56fa\u5b9a IP\u3002 kube-ovn-controllerr \u4f1a\u81ea\u52a8\u9009\u62e9 ovn.kubernetes.io/ip_pool \u4e2d\u6307\u5b9a\u7684 IP \u5e76\u8fdb\u884c\u51b2\u7a81\u68c0\u6d4b\u3002 IP Pool \u7684 Annotation \u9700\u8981\u52a0\u5728 template \u5185\u7684 annotation \u5b57\u6bb5\uff0c\u9664\u4e86 Kubernetes \u5185\u7f6e\u7684 Workload \u7c7b\u578b\uff0c \u5176\u4ed6\u7528\u6237\u81ea\u5b9a\u4e49\u7684 Workload \u4e5f\u53ef\u4ee5\u4f7f\u7528\u540c\u6837\u7684\u65b9\u5f0f\u8fdb\u884c\u56fa\u5b9a\u5730\u5740\u5206\u914d\uff0c Deployment \u56fa\u5b9a IP \u793a\u4f8b apiVersion: apps/v1 kind: Deployment metadata: namespace: ls1 name: starter-backend labels: app: starter-backend spec: replicas: 2 selector: matchLabels: app: starter-backend template: metadata: labels: app: starter-backend annotations: ovn.kubernetes.io/ip_pool: 10.16.0.15,10.16.0.16,10.16.0.17 spec: containers: - name: backend image: nginx:alpine \u5bf9 Workload \u4f7f\u7528\u56fa\u5b9a IP \u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u51e0\u70b9\uff1a ovn.kubernetes.io/ip_pool \u4e2d\u7684 IP \u5e94\u8be5\u5c5e\u4e8e\u6240\u5728\u5b50\u7f51\u7684 CIDR \u5185\u3002 ovn.kubernetes.io/ip_pool \u4e2d\u7684 IP \u4e0d\u80fd\u548c\u5df2\u4f7f\u7528\u7684 IP \u51b2\u7a81\u3002 \u5f53 ovn.kubernetes.io/ip_pool \u4e2d\u7684 IP \u6570\u91cf\u5c0f\u4e8e replicas \u6570\u91cf\u65f6\uff0c\u591a\u51fa\u7684 Pod \u5c06\u65e0\u6cd5\u521b\u5efa\u3002\u4f60\u9700\u8981\u6839\u636e Workload \u7684\u66f4\u65b0\u7b56\u7565\u4ee5\u53ca\u6269\u5bb9\u89c4\u5212\u8c03\u6574 ovn.kubernetes.io/ip_pool \u4e2d IP \u7684\u6570\u91cf\u3002 StatefulSet \u56fa\u5b9a\u5730\u5740 StatefulSet \u548c\u5176\u4ed6 Workload \u76f8\u540c\u53ef\u4ee5\u4f7f\u7528 ovn.kubernetes.io/ip_pool \u6765\u6307\u5b9a Pod \u4f7f\u7528\u7684 IP\u3002 \u7531\u4e8e StatefulSet \u591a\u7528\u4e8e\u6709\u72b6\u6001\u670d\u52a1\uff0c\u5bf9\u7f51\u7edc\u6807\u793a\u7684\u56fa\u5b9a\u6709\u66f4\u9ad8\u7684\u8981\u6c42\uff0cKube-OVN \u505a\u4e86\u7279\u6b8a\u7684\u5f3a\u5316\uff1a Pod \u4f1a\u6309\u987a\u5e8f\u5206\u914d ovn.kubernetes.io/ip_pool \u4e2d\u7684 IP\u3002\u4f8b\u5982 StatefulSet \u7684\u540d\u5b57\u4e3a web\uff0c\u5219 web-0 \u4f1a\u4f7f\u7528 ovn.kubernetes.io/ip_pool \u4e2d\u7684\u7b2c\u4e00\u4e2a IP\uff0c web-1 \u4f1a\u4f7f\u7528\u7b2c\u4e8c\u4e2a IP\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002 StatefulSet Pod \u5728\u66f4\u65b0\u6216\u5220\u9664\u7684\u8fc7\u7a0b\u4e2d OVN \u4e2d\u7684 logical_switch_port \u4e0d\u4f1a\u5220\u9664\uff0c\u65b0\u751f\u6210\u7684 Pod \u76f4\u63a5\u590d\u7528\u65e7\u7684 interface \u4fe1\u606f\u3002\u56e0\u6b64 Pod \u53ef\u4ee5\u590d\u7528 IP/Mac \u53ca\u5176\u4ed6\u7f51\u7edc\u4fe1\u606f\uff0c\u8fbe\u5230\u548c StatefulSet Volume \u7c7b\u4f3c\u7684\u72b6\u6001\u4fdd\u7559\u529f\u80fd\u3002 \u57fa\u4e8e 2 \u7684\u80fd\u529b\uff0c\u5bf9\u4e8e\u6ca1\u6709 ovn.kubernetes.io/ip_pool \u6ce8\u89e3\u7684 StatefulSet\uff0cPod \u7b2c\u4e00\u6b21\u751f\u6210\u65f6\u4f1a\u968f\u673a\u5206\u914d IP/Mac\uff0c\u4e4b\u540e\u5728\u6574\u4e2a StatefulSet \u7684\u751f\u547d\u5468\u671f\u5185\uff0c\u7f51\u7edc\u4fe1\u606f\u90fd\u4f1a\u4fdd\u6301\u56fa\u5b9a\u3002 StatefulSet \u793a\u4f8b apiVersion: apps/v1 kind: StatefulSet metadata: name: web spec: serviceName: \"nginx\" replicas: 2 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:alpine ports: - containerPort: 80 name: web \u53ef\u4ee5\u5c1d\u8bd5\u5220\u9664 StatefulSet \u4e0b Pod \u89c2\u5bdf Pod IP \u53d8\u5316\u4fe1\u606f\u3002 Kubevirt VM \u56fa\u5b9a\u5730\u5740 \u9488\u5bf9 Kubevirt \u521b\u5efa\u7684 VM \u5b9e\u4f8b\uff0c kube-ovn-controller \u53ef\u4ee5\u6309\u7167\u7c7b\u4f3c StatefulSet Pod \u7684\u65b9\u5f0f\u8fdb\u884c IP \u5730\u5740\u5206\u914d\u548c\u7ba1\u7406\u3002 \u4ee5\u8fbe\u5230 VM \u5b9e\u4f8b\u5728\u751f\u547d\u5468\u671f\u5185\u542f\u505c\uff0c\u5347\u7ea7\uff0c\u8fc1\u79fb\u7b49\u64cd\u4f5c\u8fc7\u7a0b\u4e2d\u5730\u5740\u56fa\u5b9a\u4e0d\u53d8\uff0c\u66f4\u7b26\u865a\u62df\u5316\u5408\u7528\u6237\u7684\u5b9e\u9645\u4f7f\u7528\u4f53\u9a8c\u3002 \u8be5\u529f\u80fd\u9ed8\u8ba4\u5173\u95ed\uff0c\u82e5\u8981\u4f7f\u7528\u6b64\u529f\u80fd\uff0c\u9700\u8981\u5728 kube-ovn-controller \u7684\u542f\u52a8\u547d\u4ee4\u4e2d\u5f00\u542f\u5982\u4e0b\u53c2\u6570\uff1a args: - --keep-vm-ip=true","title":"\u56fa\u5b9a\u5730\u5740"},{"location":"guide/static-ip-mac/#_1","text":"Kube-OVN \u9ed8\u8ba4\u4f1a\u6839\u636e Pod \u6240\u5728 Namespace \u6240\u5c5e\u7684\u5b50\u7f51\u4e2d\u968f\u673a\u5206\u914d IP \u548c Mac\u3002 \u9488\u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u9700\u8981\u56fa\u5b9a\u5730\u5740\u7684\u60c5\u51b5\uff0cKube-OVN \u6839\u636e\u4e0d\u540c\u7684\u573a\u666f\uff0c\u63d0\u4f9b\u4e86\u591a\u4e2d\u56fa\u5b9a\u5730\u5740\u7684\u65b9\u6cd5\uff1a \u5355\u4e2a Pod \u56fa\u5b9a IP/Mac\u3002 Workload \u901a\u7528 IP Pool \u65b9\u5f0f\u6307\u5b9a\u56fa\u5b9a\u5730\u5740\u8303\u56f4\u3002 StatefulSet \u56fa\u5b9a\u5730\u5740\u3002 Kubevirt VM \u56fa\u5b9a\u5730\u5740\u3002","title":"\u56fa\u5b9a\u5730\u5740"},{"location":"guide/static-ip-mac/#pod-ip-mac","text":"\u53ef\u4ee5\u5728\u521b\u5efa Pod \u65f6\u901a\u8fc7 annotation \u6765\u6307\u5b9a Pod \u8fd0\u884c\u65f6\u6240\u9700\u7684 IP/Mac, kube-ovn-controller \u8fd0\u884c\u65f6\u5c06\u4f1a\u8df3\u8fc7\u5730\u5740\u968f\u673a\u5206\u914d\u9636\u6bb5\uff0c\u7ecf\u8fc7\u51b2\u7a81\u68c0\u6d4b\u540e\u76f4\u63a5\u4f7f\u7528\u6307\u5b9a\u5730\u5740\uff0c\u5982\u4e0b\u6240\u793a\uff1a apiVersion: v1 kind: Pod metadata: name: static-ip namespace: ls1 annotations: ovn.kubernetes.io/ip_address: 10.16.0.15 ovn.kubernetes.io/mac_address: 00:00:00:53:6B:B6 spec: containers: - name: static-ip image: nginx:alpine \u5728\u4f7f\u7528 annotation \u5b9a\u4e49\u5355\u4e2a Pod IP/Mac \u65f6\u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u51e0\u70b9\uff1a \u6240\u4f7f\u7528\u7684 IP/Mac \u4e0d\u80fd\u548c\u5df2\u6709\u7684 IP/Mac \u51b2\u7a81\u3002 IP \u5fc5\u987b\u5728\u6240\u5c5e\u5b50\u7f51\u7684 CIDR \u5185\u3002 \u53ef\u4ee5\u53ea\u6307\u5b9a IP \u6216 Mac\uff0c\u53ea\u6307\u5b9a\u4e00\u4e2a\u65f6\uff0c\u53e6\u4e00\u4e2a\u4f1a\u968f\u673a\u5206\u914d\u3002","title":"\u5355\u4e2a Pod \u56fa\u5b9a IP \u548c Mac"},{"location":"guide/static-ip-mac/#workload-ip-pool","text":"Kube-OVN \u652f\u6301\u901a\u8fc7 annotation ovn.kubernetes.io/ip_pool \u7ed9 Workload\uff08Deployment/StatefulSet/DaemonSet/Job/CronJob\uff09\u8bbe\u7f6e\u56fa\u5b9a IP\u3002 kube-ovn-controllerr \u4f1a\u81ea\u52a8\u9009\u62e9 ovn.kubernetes.io/ip_pool \u4e2d\u6307\u5b9a\u7684 IP \u5e76\u8fdb\u884c\u51b2\u7a81\u68c0\u6d4b\u3002 IP Pool \u7684 Annotation \u9700\u8981\u52a0\u5728 template \u5185\u7684 annotation \u5b57\u6bb5\uff0c\u9664\u4e86 Kubernetes \u5185\u7f6e\u7684 Workload \u7c7b\u578b\uff0c \u5176\u4ed6\u7528\u6237\u81ea\u5b9a\u4e49\u7684 Workload \u4e5f\u53ef\u4ee5\u4f7f\u7528\u540c\u6837\u7684\u65b9\u5f0f\u8fdb\u884c\u56fa\u5b9a\u5730\u5740\u5206\u914d\uff0c","title":"Workload \u901a\u7528 IP Pool \u56fa\u5b9a\u5730\u5740"},{"location":"guide/static-ip-mac/#deployment-ip","text":"apiVersion: apps/v1 kind: Deployment metadata: namespace: ls1 name: starter-backend labels: app: starter-backend spec: replicas: 2 selector: matchLabels: app: starter-backend template: metadata: labels: app: starter-backend annotations: ovn.kubernetes.io/ip_pool: 10.16.0.15,10.16.0.16,10.16.0.17 spec: containers: - name: backend image: nginx:alpine \u5bf9 Workload \u4f7f\u7528\u56fa\u5b9a IP \u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u51e0\u70b9\uff1a ovn.kubernetes.io/ip_pool \u4e2d\u7684 IP \u5e94\u8be5\u5c5e\u4e8e\u6240\u5728\u5b50\u7f51\u7684 CIDR \u5185\u3002 ovn.kubernetes.io/ip_pool \u4e2d\u7684 IP \u4e0d\u80fd\u548c\u5df2\u4f7f\u7528\u7684 IP \u51b2\u7a81\u3002 \u5f53 ovn.kubernetes.io/ip_pool \u4e2d\u7684 IP \u6570\u91cf\u5c0f\u4e8e replicas \u6570\u91cf\u65f6\uff0c\u591a\u51fa\u7684 Pod \u5c06\u65e0\u6cd5\u521b\u5efa\u3002\u4f60\u9700\u8981\u6839\u636e Workload \u7684\u66f4\u65b0\u7b56\u7565\u4ee5\u53ca\u6269\u5bb9\u89c4\u5212\u8c03\u6574 ovn.kubernetes.io/ip_pool \u4e2d IP \u7684\u6570\u91cf\u3002","title":"Deployment \u56fa\u5b9a IP \u793a\u4f8b"},{"location":"guide/static-ip-mac/#statefulset","text":"StatefulSet \u548c\u5176\u4ed6 Workload \u76f8\u540c\u53ef\u4ee5\u4f7f\u7528 ovn.kubernetes.io/ip_pool \u6765\u6307\u5b9a Pod \u4f7f\u7528\u7684 IP\u3002 \u7531\u4e8e StatefulSet \u591a\u7528\u4e8e\u6709\u72b6\u6001\u670d\u52a1\uff0c\u5bf9\u7f51\u7edc\u6807\u793a\u7684\u56fa\u5b9a\u6709\u66f4\u9ad8\u7684\u8981\u6c42\uff0cKube-OVN \u505a\u4e86\u7279\u6b8a\u7684\u5f3a\u5316\uff1a Pod \u4f1a\u6309\u987a\u5e8f\u5206\u914d ovn.kubernetes.io/ip_pool \u4e2d\u7684 IP\u3002\u4f8b\u5982 StatefulSet \u7684\u540d\u5b57\u4e3a web\uff0c\u5219 web-0 \u4f1a\u4f7f\u7528 ovn.kubernetes.io/ip_pool \u4e2d\u7684\u7b2c\u4e00\u4e2a IP\uff0c web-1 \u4f1a\u4f7f\u7528\u7b2c\u4e8c\u4e2a IP\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002 StatefulSet Pod \u5728\u66f4\u65b0\u6216\u5220\u9664\u7684\u8fc7\u7a0b\u4e2d OVN \u4e2d\u7684 logical_switch_port \u4e0d\u4f1a\u5220\u9664\uff0c\u65b0\u751f\u6210\u7684 Pod \u76f4\u63a5\u590d\u7528\u65e7\u7684 interface \u4fe1\u606f\u3002\u56e0\u6b64 Pod \u53ef\u4ee5\u590d\u7528 IP/Mac \u53ca\u5176\u4ed6\u7f51\u7edc\u4fe1\u606f\uff0c\u8fbe\u5230\u548c StatefulSet Volume \u7c7b\u4f3c\u7684\u72b6\u6001\u4fdd\u7559\u529f\u80fd\u3002 \u57fa\u4e8e 2 \u7684\u80fd\u529b\uff0c\u5bf9\u4e8e\u6ca1\u6709 ovn.kubernetes.io/ip_pool \u6ce8\u89e3\u7684 StatefulSet\uff0cPod \u7b2c\u4e00\u6b21\u751f\u6210\u65f6\u4f1a\u968f\u673a\u5206\u914d IP/Mac\uff0c\u4e4b\u540e\u5728\u6574\u4e2a StatefulSet \u7684\u751f\u547d\u5468\u671f\u5185\uff0c\u7f51\u7edc\u4fe1\u606f\u90fd\u4f1a\u4fdd\u6301\u56fa\u5b9a\u3002","title":"StatefulSet \u56fa\u5b9a\u5730\u5740"},{"location":"guide/static-ip-mac/#statefulset_1","text":"apiVersion: apps/v1 kind: StatefulSet metadata: name: web spec: serviceName: \"nginx\" replicas: 2 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:alpine ports: - containerPort: 80 name: web \u53ef\u4ee5\u5c1d\u8bd5\u5220\u9664 StatefulSet \u4e0b Pod \u89c2\u5bdf Pod IP \u53d8\u5316\u4fe1\u606f\u3002","title":"StatefulSet \u793a\u4f8b"},{"location":"guide/static-ip-mac/#kubevirt-vm","text":"\u9488\u5bf9 Kubevirt \u521b\u5efa\u7684 VM \u5b9e\u4f8b\uff0c kube-ovn-controller \u53ef\u4ee5\u6309\u7167\u7c7b\u4f3c StatefulSet Pod \u7684\u65b9\u5f0f\u8fdb\u884c IP \u5730\u5740\u5206\u914d\u548c\u7ba1\u7406\u3002 \u4ee5\u8fbe\u5230 VM \u5b9e\u4f8b\u5728\u751f\u547d\u5468\u671f\u5185\u542f\u505c\uff0c\u5347\u7ea7\uff0c\u8fc1\u79fb\u7b49\u64cd\u4f5c\u8fc7\u7a0b\u4e2d\u5730\u5740\u56fa\u5b9a\u4e0d\u53d8\uff0c\u66f4\u7b26\u865a\u62df\u5316\u5408\u7528\u6237\u7684\u5b9e\u9645\u4f7f\u7528\u4f53\u9a8c\u3002 \u8be5\u529f\u80fd\u9ed8\u8ba4\u5173\u95ed\uff0c\u82e5\u8981\u4f7f\u7528\u6b64\u529f\u80fd\uff0c\u9700\u8981\u5728 kube-ovn-controller \u7684\u542f\u52a8\u547d\u4ee4\u4e2d\u5f00\u542f\u5982\u4e0b\u53c2\u6570\uff1a args: - --keep-vm-ip=true","title":"Kubevirt VM \u56fa\u5b9a\u5730\u5740"},{"location":"guide/subnet/","text":"\u5b50\u7f51\u4f7f\u7528 \u5b50\u7f51\u662f Kube-OVN \u4e2d\u7684\u4e00\u4e2a\u6838\u5fc3\u6982\u5ff5\u548c\u57fa\u672c\u4f7f\u7528\u5355\u5143\uff0cKube-OVN \u4f1a\u4ee5\u5b50\u7f51\u6765\u7ec4\u7ec7 IP \u548c\u7f51\u7edc\u914d\u7f6e\uff0c\u6bcf\u4e2a Namespace \u53ef\u4ee5\u5f52\u5c5e\u4e8e\u7279\u5b9a\u7684\u5b50\u7f51\uff0c Namespace \u4e0b\u7684 Pod \u4f1a\u81ea\u52a8\u4ece\u6240\u5c5e\u7684\u5b50\u7f51\u4e2d\u83b7\u53d6 IP \u5e76\u5171\u4eab\u5b50\u7f51\u7684\u7f51\u7edc\u914d\u7f6e\uff08CIDR\uff0c\u7f51\u5173\u7c7b\u578b\uff0c\u8bbf\u95ee\u63a7\u5236\uff0cNAT\u63a7\u5236\u7b49\uff09\u3002 \u548c\u5176\u4ed6 CNI \u7684\u6bcf\u4e2a\u8282\u70b9\u7ed1\u5b9a\u4e00\u4e2a\u5b50\u7f51\u7684\u5b9e\u73b0\u4e0d\u540c\uff0c\u5728 Kube-OVN \u4e2d\u5b50\u7f51\u4e3a\u4e00\u4e2a\u5168\u5c40\u7684\u865a\u62df\u7f51\u7edc\u914d\u7f6e\uff0c\u540c\u4e00\u4e2a\u5b50\u7f51\u7684\u5730\u5740\u53ef\u4ee5\u5206\u5e03\u5728\u4efb\u610f\u4e00\u4e2a\u8282\u70b9\u4e0a\u3002 Overlay \u548c Underlay \u7684\u5b50\u7f51\u5728\u4f7f\u7528\u548c\u914d\u7f6e\u4e0a\u5b58\u5728\u4e00\u4e9b\u5dee\u5f02\uff0c\u672c\u6587\u6863\u5c06\u4f1a\u4ecb\u7ecd\u4e0d\u540c\u7c7b\u578b\u5b50\u7f51\u7684\u4e00\u4e9b\u5171\u540c\u914d\u7f6e\u548c\u5dee\u5f02\u5316\u529f\u80fd\u3002 \u9ed8\u8ba4\u5b50\u7f51 \u4e3a\u4e86\u65b9\u4fbf\u7528\u6237\u7684\u5feb\u901f\u4e0a\u624b\u4f7f\u7528\uff0cKube-OVN \u5185\u7f6e\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u5b50\u7f51\uff0c\u6240\u6709\u672a\u663e\u5f0f\u58f0\u660e\u5b50\u7f51\u5f52\u5c5e\u7684 Namespace \u4f1a\u81ea\u52a8\u4ece\u9ed8\u8ba4\u5b50\u7f51\u4e2d\u5206\u914d IP\uff0c \u5e76\u4f7f\u7528\u9ed8\u8ba4\u5b50\u7f51\u7684\u7f51\u7edc\u4fe1\u606f\u3002\u8be5\u5b50\u7f51\u7684\u914d\u7f6e\u4e3a\u5b89\u88c5\u65f6\u6307\u5b9a\uff0c\u53ef\u4ee5\u53c2\u8003 \u5185\u7f6e\u7f51\u7edc\u8bbe\u7f6e \uff0c \u5982\u679c\u8981\u5728\u5b89\u88c5\u540e\u4fee\u6539\u9ed8\u8ba4\u7f51\u7edc\u7684 CIDR \u8bf7\u53c2\u8003 \u4fee\u6539\u9ed8\u8ba4\u7f51\u7edc \u3002 \u5728 Overlay \u6a21\u5f0f\u4e0b\uff0c\u9ed8\u8ba4\u5b50\u7f51\u4f7f\u7528\u4e86\u5206\u5e03\u5f0f\u7f51\u5173\u5e76\u5bf9\u51fa\u7f51\u6d41\u91cf\u8fdb\u884c NAT \u8f6c\u6362\uff0c\u5176\u884c\u4e3a\u548c Flannel \u7684\u9ed8\u8ba4\u884c\u4e3a\u57fa\u672c\u4e00\u81f4\uff0c \u7528\u6237\u65e0\u9700\u989d\u5916\u7684\u914d\u7f6e\u5373\u53ef\u4f7f\u7528\u5230\u5927\u90e8\u5206\u7684\u7f51\u7edc\u529f\u80fd\u3002 \u5728 Underlay \u6a21\u5f0f\u4e0b\uff0c\u9ed8\u8ba4\u5b50\u7f51\u4f7f\u7528\u7269\u7406\u7f51\u5173\u4f5c\u4e3a\u51fa\u7f51\u7f51\u5173\uff0c\u5e76\u5f00\u542f arping \u68c0\u67e5\u7f51\u7edc\u8fde\u901a\u6027\u3002 \u67e5\u770b\u9ed8\u8ba4\u5b50\u7f51 \u9ed8\u8ba4\u5b50\u7f51 spec \u4e2d\u7684 default \u5b57\u6bb5\u4e3a true\uff0c\u4e00\u4e2a\u96c6\u7fa4\u4e0b\u53ea\u6709\u4e00\u4e2a\u9ed8\u8ba4\u5b50\u7f51\uff0c\u9ed8\u8ba4\u540d\u4e3a ovn-default \u3002 \u67e5\u770b\u9ed8\u8ba4\u5b50\u7f51\uff1a # kubectl get subnet ovn-default -o yaml apiVersion: kubeovn.io/v1 kind: Subnet metadata: creationTimestamp: \"2019-08-06T09:33:43Z\" generation: 1 name: ovn-default resourceVersion: \"1571334\" selfLink: /apis/kubeovn.io/v1/subnets/ovn-default uid: 7e2451f8-fb44-4f7f-b3e0-cfd27f6fd5d6 spec: cidrBlock: 10.16.0.0/16 default: true excludeIps: - 10.16.0.1 gateway: 10.16.0.1 gatewayType: distributed natOutgoing: true private: false protocol: IPv4 Join \u5b50\u7f51 \u5728 Kubernetes \u7684\u7f51\u7edc\u89c4\u8303\u4e2d\uff0c\u8981\u6c42 Node \u53ef\u4ee5\u548c\u6240\u6709\u7684 Pod \u76f4\u63a5\u901a\u4fe1\u3002 \u4e3a\u4e86\u5728 Overlay \u7f51\u7edc\u6a21\u5f0f\u4e0b\u8fbe\u5230\u8fd9\u4e2a\u76ee\u7684\uff0c Kube-OVN \u521b\u5efa\u4e86\u4e00\u4e2a join \u5b50\u7f51\uff0c \u5e76\u5728\u6bcf\u4e2a Node \u8282\u70b9\u521b\u5efa\u4e86\u4e00\u5757\u865a\u62df\u7f51\u5361 ovn0 \u63a5\u5165 join \u5b50\u7f51\uff0c\u901a\u8fc7\u8be5\u7f51\u7edc\u5b8c\u6210\u8282\u70b9\u548c Pod \u4e4b\u95f4\u7684\u7f51\u7edc\u4e92\u901a\u3002 \u8be5\u5b50\u7f51\u7684\u914d\u7f6e\u4e3a\u5b89\u88c5\u65f6\u6307\u5b9a\uff0c\u53ef\u4ee5\u53c2\u8003 \u5185\u7f6e\u7f51\u7edc\u8bbe\u7f6e \uff0c\u5982\u679c\u8981\u5728\u5b89\u88c5\u540e\u4fee\u6539\u3002 join \u5b50\u7f51\u7684 CIDR \u8bf7\u53c2\u8003 \u4fee\u6539 Join \u5b50\u7f51 \u67e5\u770b Join \u5b50\u7f51 \u8be5\u5b50\u7f51\u9ed8\u8ba4\u540d\u4e3a join \u4e00\u822c\u65e0\u9700\u5bf9\u8be5\u5b50\u7f51 CIDR \u5916\u7684\u5176\u4ed6\u7f51\u7edc\u914d\u7f6e\u8fdb\u884c\u4fee\u6539\u3002 # kubectl get subnet join -o yaml apiVersion: kubeovn.io/v1 kind: Subnet metadata: creationTimestamp: \"2019-08-06T09:33:43Z\" generation: 1 name: join resourceVersion: \"1571333\" selfLink: /apis/kubeovn.io/v1/subnets/join uid: 9c744810-c678-4d50-8a7d-b8ec12ef91b8 spec: cidrBlock: 100.64.0.0/16 default: false excludeIps: - 100.64.0.1 gateway: 100.64.0.1 gatewayNode: \"\" gatewayType: \"\" natOutgoing: false private: false protocol: IPv4 \u5728 node \u8282\u70b9\u67e5\u770b ovn0 \u7f51\u5361\uff1a # ifconfig ovn0 ovn0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST> mtu 1420 inet 100.64.0.4 netmask 255.255.0.0 broadcast 100.64.255.255 inet6 fe80::800:ff:fe40:5 prefixlen 64 scopeid 0x20<link> ether 0a:00:00:40:00:05 txqueuelen 1000 (Ethernet) RX packets 18 bytes 1428 (1.3 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 19 bytes 1810 (1.7 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 \u521b\u5efa\u81ea\u5b9a\u4e49\u5b50\u7f51 \u8fd9\u91cc\u6211\u4eec\u4ecb\u7ecd\u521b\u5efa\u4e00\u4e2a\u5b50\u7f51\uff0c\u5e76\u5c06\u5176\u548c\u67d0\u4e2a Namespace \u505a\u5173\u8054\u7684\u57fa\u672c\u64cd\u4f5c\uff0c\u66f4\u591a\u9ad8\u7ea7\u914d\u7f6e\u8bf7\u53c2\u8003\u540e\u7eed\u5185\u5bb9\u3002 \u521b\u5efa\u5b50\u7f51 cat <<EOF | kubectl create -f - apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: subnet1 spec: cidrBlock: 10.66.0.0/16 excludeIps: - 10.66.0.1..10.66.0.10 - 10.66.0.101..10.66.0.151 gateway: 10.66.0.1 namespaces: - ns1 - ns2 EOF cidrBlock : \u5b50\u7f51 CIDR \u8303\u56f4\uff0c\u540c\u4e00\u4e2a VPC \u4e0b\u7684\u4e0d\u540c Subnet CIDR \u4e0d\u80fd\u91cd\u53e0\u3002 excludeIps : \u4fdd\u7559\u5730\u5740\u5217\u8868\uff0c\u5bb9\u5668\u7f51\u7edc\u5c06\u4e0d\u4f1a\u81ea\u52a8\u5206\u914d\u5217\u8868\u5185\u7684\u5730\u5740\uff0c\u53ef\u7528\u505a\u56fa\u5b9a IP \u5730\u5740\u5206\u914d\u6bb5\uff0c\u4e5f\u53ef\u5728 Underlay \u6a21\u5f0f\u4e0b\u907f\u514d\u548c\u7269\u7406\u7f51\u7edc\u4e2d\u5df2\u6709\u8bbe\u5907\u51b2\u7a81\u3002 gateway \uff1a\u8be5\u5b50\u7f51\u7f51\u5173\u5730\u5740\uff0cOverlay \u6a21\u5f0f\u4e0b Kube-OVN \u4f1a\u81ea\u52a8\u5206\u914d\u5bf9\u5e94\u7684\u903b\u8f91\u7f51\u5173\uff0cUnderlay \u6a21\u5f0f\u4e0b\u8be5\u5730\u5740\u9700\u4e3a\u5e95\u5c42\u7269\u7406\u7f51\u5173\u5730\u5740\u3002 namespaces : \u7ed1\u5b9a\u8be5\u5b50\u7f51\u7684 Namespace \u5217\u8868\uff0c\u7ed1\u5b9a\u540e Namespace \u4e0b\u7684 Pod \u5c06\u4f1a\u4ece\u5f53\u524d\u5b50\u7f51\u5206\u914d\u5730\u5740\u3002 \u9a8c\u8bc1\u5b50\u7f51\u7ed1\u5b9a\u751f\u6548 # kubectl create ns ls1 namespace/ls1 created # kubectl run nginx --image=nginx:alpine -n ls1 deployment.apps/nginx created # kubectl get pod -n ls1 -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-74d5899f46-n8wtg 1/1 Running 0 10s 10.66.0.11 node1 <none> <none> Overlay \u5b50\u7f51\u7f51\u5173\u914d\u7f6e \u8be5\u529f\u80fd\u53ea\u5bf9 Overlay \u6a21\u5f0f\u5b50\u7f51\u751f\u6548\uff0cUnderlay \u7c7b\u578b\u5b50\u7f51\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u9700\u8981\u501f\u52a9\u5e95\u5c42\u7269\u7406\u7f51\u5173\u3002 Overlay \u5b50\u7f51\u4e0b\u7684 Pod \u9700\u8981\u901a\u8fc7\u7f51\u5173\u6765\u8bbf\u95ee\u96c6\u7fa4\u5916\u90e8\u7f51\u7edc\uff0cKube-OVN \u76ee\u524d\u652f\u6301\u4e24\u79cd\u7c7b\u578b\u7684\u7f51\u5173\uff1a \u5206\u5e03\u5f0f\u7f51\u5173\u548c\u96c6\u4e2d\u5f0f\u7f51\u5173\uff0c\u7528\u6237\u53ef\u4ee5\u5728\u5b50\u7f51\u4e2d\u5bf9\u7f51\u5173\u7684\u7c7b\u578b\u8fdb\u884c\u8c03\u6574\u3002 \u4e24\u79cd\u7c7b\u578b\u7f51\u5173\u5747\u652f\u6301 natOutgoing \u8bbe\u7f6e\uff0c\u7528\u6237\u53ef\u4ee5\u9009\u62e9 Pod \u8bbf\u95ee\u5916\u7f51\u65f6\u662f\u5426\u9700\u8981\u8fdb\u884c snat\u3002 \u5206\u5e03\u5f0f\u7f51\u5173 \u5b50\u7f51\u7684\u9ed8\u8ba4\u7c7b\u578b\u7f51\u5173\uff0c\u6bcf\u4e2a node \u4f1a\u4f5c\u4e3a\u5f53\u524d node \u4e0a pod \u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u7684\u7f51\u5173\u3002 \u6570\u636e\u5305\u4f1a\u901a\u8fc7\u672c\u673a\u7684 ovn0 \u7f51\u5361\u6d41\u5165\u4e3b\u673a\u7f51\u7edc\u6808\uff0c\u518d\u6839\u636e\u4e3b\u673a\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u51fa\u7f51\u3002 \u5f53 natOutgoing \u4e3a true \u65f6\uff0cPod \u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u5c06\u4f1a\u4f7f\u7528\u5f53\u524d\u6240\u5728\u5bbf\u4e3b\u673a\u7684 IP\u3002 \u5b50\u7f51\u793a\u4f8b\uff0c\u5176\u4e2d gatewayType \u5b57\u6bb5\u4e3a distributed \uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: distributed spec: cidrBlock: 10.166.0.0/16 default: false excludeIps: - 10.166.0.1 gateway: 10.166.0.1 gatewayType: distributed natOutgoing: true \u96c6\u4e2d\u5f0f\u7f51\u5173 \u5982\u679c\u5e0c\u671b\u5b50\u7f51\u5185\u6d41\u91cf\u8bbf\u95ee\u5916\u7f51\u4f7f\u7528\u56fa\u5b9a\u7684 IP\uff0c\u4ee5\u4fbf\u5ba1\u8ba1\u548c\u767d\u540d\u5355\u7b49\u5b89\u5168\u64cd\u4f5c\uff0c\u53ef\u4ee5\u5728\u5b50\u7f51\u4e2d\u8bbe\u7f6e\u7f51\u5173\u7c7b\u578b\u4e3a\u96c6\u4e2d\u5f0f\u7f51\u5173\u3002 \u5728\u96c6\u4e2d\u5f0f\u7f51\u5173\u6a21\u5f0f\u4e0b\uff0cPod \u8bbf\u95ee\u5916\u7f51\u7684\u6570\u636e\u5305\u4f1a\u9996\u5148\u88ab\u8def\u7531\u5230\u7279\u5b9a\u8282\u70b9\u7684 ovn0 \u7f51\u5361\uff0c\u518d\u901a\u8fc7\u4e3b\u673a\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u51fa\u7f51\u3002 \u5f53 natOutgoing \u4e3a true \u65f6\uff0cPod \u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u5c06\u4f1a\u4f7f\u7528\u7279\u5b9a\u5bbf\u4e3b\u673a\u7684 IP\u3002 \u5b50\u7f51\u793a\u4f8b\uff0c\u5176\u4e2dgatewayType \u5b57\u6bb5\u4e3a centralized\uff0cgatewayNode \u4e3a\u7279\u5b9a\u673a\u5668\u5728 Kubernetes \u4e2d\u7684 node name\u3002 \u5176\u4e2dgatewayNode\u5b57\u6bb5\u53ef\u4ee5\u4e3a\u9017\u53f7\u5206\u9694\u7684\u591a\u53f0\u4e3b\u673a\u3002 apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: centralized spec: cidrBlock: 10.166.0.0/16 default: false excludeIps: - 10.166.0.1 gateway: 10.166.0.1 gatewayType: centralized gatewayNode: \"node1,node2\" natOutgoing: true \u96c6\u4e2d\u5f0f\u7f51\u5173\u5982\u679c\u5e0c\u671b\u6307\u5b9a\u673a\u5668\u7684\u7279\u5b9a\u7f51\u5361\u8fdb\u884c\u51fa\u7f51\uff0c gatewayNode \u53ef\u66f4\u6539\u4e3a kube-ovn-worker:172.18.0.2, kube-ovn-control-plane:172.18.0.3 \u683c\u5f0f\u3002 \u96c6\u4e2d\u5f0f\u7f51\u5173\u9ed8\u8ba4\u4e3a\u4e3b\u5907\u6a21\u5f0f\uff0c\u53ea\u6709\u4e3b\u8282\u70b9\u8fdb\u884c\u6d41\u91cf\u8f6c\u53d1\uff0c \u5982\u679c\u9700\u8981\u5207\u6362\u4e3a ECMP \u6a21\u5f0f\uff0c\u8bf7\u53c2\u8003 \u96c6\u4e2d\u5f0f\u7f51\u5173 ECMP \u5f00\u542f\u8bbe\u7f6e \u3002 \u5b50\u7f51 ACL \u8bbe\u7f6e \u5bf9\u4e8e\u6709\u7ec6\u7c92\u5ea6 ACL \u63a7\u5236\u7684\u573a\u666f\uff0cKube-OVN \u7684 Subnet \u63d0\u4f9b\u4e86 ACL \u89c4\u5219\u7684\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u5b9e\u73b0\u7f51\u7edc\u89c4\u5219\u7684\u7cbe\u7ec6\u63a7\u5236\u3002 Subnet \u4e2d\u7684 ACL \u89c4\u5219\u548c OVN \u7684 ACL \u89c4\u5219\u4e00\u81f4\uff0c\u76f8\u5173\u5b57\u6bb5\u5185\u5bb9\u53ef\u4ee5\u53c2\u8003 ovn-nb ACL Table \uff0c match \u5b57\u6bb5\u652f\u6301\u7684\u5b57\u6bb5\u53ef\u53c2\u8003 ovn-sb Logical Flow Table \u3002 \u5141\u8bb8 IP \u5730\u5740\u4e3a 10.10.0.2 \u7684 Pod \u8bbf\u95ee\u6240\u6709\u5730\u5740\uff0c\u4f46\u4e0d\u5141\u8bb8\u5176\u4ed6\u5730\u5740\u4e3b\u52a8\u8bbf\u95ee\u81ea\u5df1\u7684 ACL \u89c4\u5219\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: acl spec: acls: - action: drop direction: to-lport match: ip4.dst == 10.10.0.2 && ip priority: 1002 - action: allow-related direction: from-lport match: ip4.src == 10.10.0.2 && ip priority: 1002 cidrBlock: 10.10.0.0/24 \u5b50\u7f51\u9694\u79bb\u8bbe\u7f6e \u5b50\u7f51 ACL \u7684\u529f\u80fd\u53ef\u4ee5\u8986\u76d6\u5b50\u7f51\u9694\u79bb\u7684\u529f\u80fd\uff0c\u5e76\u6709\u66f4\u597d\u7684\u7075\u6d3b\u6027\uff0c\u6211\u4eec\u63a8\u8350\u4f7f\u7528\u5b50\u7f51 ACL \u6765\u505a\u76f8\u5e94\u7684\u914d\u7f6e\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b Kube-OVN \u521b\u5efa\u7684\u5b50\u7f51\u4e4b\u95f4\u53ef\u4ee5\u76f8\u4e92\u901a\u4fe1\uff0cPod \u4e5f\u53ef\u4ee5\u901a\u8fc7\u7f51\u5173\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u3002 \u5982\u9700\u5bf9\u5b50\u7f51\u95f4\u7684\u8bbf\u95ee\u8fdb\u884c\u63a7\u5236\uff0c\u53ef\u4ee5\u5728\u5b50\u7f51 CRD \u4e2d\u5c06 private \u8bbe\u7f6e\u4e3a true\uff0c\u5219\u8be5\u5b50\u7f51\u5c06\u548c\u5176\u4ed6\u5b50\u7f51\u4ee5\u53ca\u5916\u90e8\u7f51\u7edc\u9694\u79bb\uff0c \u53ea\u80fd\u8fdb\u884c\u5b50\u7f51\u5185\u90e8\u7684\u901a\u4fe1\u3002\u5982\u9700\u5f00\u767d\u540d\u5355\uff0c\u53ef\u4ee5\u901a\u8fc7 allowSubnets \u8fdb\u884c\u8bbe\u7f6e\u3002 allowSubnets \u5185\u7684\u7f51\u6bb5\u548c\u8be5\u5b50\u7f51\u53ef\u4ee5\u53cc\u5411\u4e92\u8bbf\u3002 \u5f00\u542f\u8bbf\u95ee\u63a7\u5236\u7684\u5b50\u7f51\u793a\u4f8b apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: private spec: protocol: IPv4 default: false namespaces: - ns1 - ns2 cidrBlock: 10.69.0.0/16 private: true allowSubnets: - 10.16.0.0/16 - 10.18.0.0/16 Underlay \u76f8\u5173\u9009\u9879 \u8be5\u90e8\u5206\u529f\u80fd\u53ea\u5bf9 Underlay \u7c7b\u578b\u5b50\u7f51\u751f\u6548\u3002 vlan : \u5982\u679c\u4f7f\u7528 Underlay \u7f51\u7edc\uff0c\u8be5\u5b57\u6bb5\u7528\u6765\u63a7\u5236\u8be5 Subnet \u548c\u54ea\u4e2a Vlan CR \u8fdb\u884c\u7ed1\u5b9a\u3002\u8be5\u9009\u9879\u9ed8\u8ba4\u4e3a\u7a7a\u5b57\u7b26\u4e32\uff0c\u5373\u4e0d\u4f7f\u7528 Underlay \u7f51\u7edc\u3002 logicalGateway : \u4e00\u4e9b Underlay \u73af\u5883\u4e3a\u7eaf\u4e8c\u5c42\u7f51\u7edc\uff0c\u4e0d\u5b58\u5728\u7269\u7406\u7684\u4e09\u5c42\u7f51\u5173\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u53ef\u4ee5\u501f\u52a9 OVN \u672c\u8eab\u7684\u80fd\u529b\u8bbe\u7f6e\u4e00\u4e2a\u865a\u62df\u7f51\u5173\uff0c\u5c06 Underlay \u548c Overlay \u7f51\u7edc\u6253\u901a\u3002\u9ed8\u8ba4\u503c\u4e3a\uff1a false \u3002 \u7f51\u5173\u68c0\u67e5\u8bbe\u7f6e \u9ed8\u8ba4\u60c5\u51b5\u4e0b kube-ovn-cni \u5728\u542f\u52a8 Pod \u540e\u4f1a\u4f7f\u7528 ICMP \u6216 ARP \u534f\u8bae\u8bf7\u6c42\u7f51\u5173\u5e76\u7b49\u5f85\u8fd4\u56de\uff0c \u4ee5\u9a8c\u8bc1\u7f51\u7edc\u5de5\u4f5c\u6b63\u5e38\uff0c\u5728\u90e8\u5206 Underlay \u73af\u5883\u7f51\u5173\u65e0\u6cd5\u54cd\u5e94 ARP \u8bf7\u6c42\uff0c\u6216\u65e0\u9700\u7f51\u7edc\u5916\u90e8\u8054\u901a\u7684\u573a\u666f \u53ef\u4ee5\u5173\u95ed\u7f51\u5173\u68c0\u67e5\u3002 apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: disable-gw-check spec: disableGatewayCheck: true \u5176\u4ed6\u9ad8\u7ea7\u8bbe\u7f6e QoS \u8bbe\u7f6e \u591a\u7f51\u7edc\u7ba1\u7406\uff0c\u901a\u7528 CNI IPAM \u7ba1\u7406 DHCP \u9009\u9879 \u5916\u90e8\u7f51\u5173\u8bbe\u7f6e \u96c6\u7fa4\u4e92\u8054\u8bbe\u7f6e \u865a\u62df IP \u8bbe\u7f6e","title":"\u5b50\u7f51\u4f7f\u7528"},{"location":"guide/subnet/#_1","text":"\u5b50\u7f51\u662f Kube-OVN \u4e2d\u7684\u4e00\u4e2a\u6838\u5fc3\u6982\u5ff5\u548c\u57fa\u672c\u4f7f\u7528\u5355\u5143\uff0cKube-OVN \u4f1a\u4ee5\u5b50\u7f51\u6765\u7ec4\u7ec7 IP \u548c\u7f51\u7edc\u914d\u7f6e\uff0c\u6bcf\u4e2a Namespace \u53ef\u4ee5\u5f52\u5c5e\u4e8e\u7279\u5b9a\u7684\u5b50\u7f51\uff0c Namespace \u4e0b\u7684 Pod \u4f1a\u81ea\u52a8\u4ece\u6240\u5c5e\u7684\u5b50\u7f51\u4e2d\u83b7\u53d6 IP \u5e76\u5171\u4eab\u5b50\u7f51\u7684\u7f51\u7edc\u914d\u7f6e\uff08CIDR\uff0c\u7f51\u5173\u7c7b\u578b\uff0c\u8bbf\u95ee\u63a7\u5236\uff0cNAT\u63a7\u5236\u7b49\uff09\u3002 \u548c\u5176\u4ed6 CNI \u7684\u6bcf\u4e2a\u8282\u70b9\u7ed1\u5b9a\u4e00\u4e2a\u5b50\u7f51\u7684\u5b9e\u73b0\u4e0d\u540c\uff0c\u5728 Kube-OVN \u4e2d\u5b50\u7f51\u4e3a\u4e00\u4e2a\u5168\u5c40\u7684\u865a\u62df\u7f51\u7edc\u914d\u7f6e\uff0c\u540c\u4e00\u4e2a\u5b50\u7f51\u7684\u5730\u5740\u53ef\u4ee5\u5206\u5e03\u5728\u4efb\u610f\u4e00\u4e2a\u8282\u70b9\u4e0a\u3002 Overlay \u548c Underlay \u7684\u5b50\u7f51\u5728\u4f7f\u7528\u548c\u914d\u7f6e\u4e0a\u5b58\u5728\u4e00\u4e9b\u5dee\u5f02\uff0c\u672c\u6587\u6863\u5c06\u4f1a\u4ecb\u7ecd\u4e0d\u540c\u7c7b\u578b\u5b50\u7f51\u7684\u4e00\u4e9b\u5171\u540c\u914d\u7f6e\u548c\u5dee\u5f02\u5316\u529f\u80fd\u3002","title":"\u5b50\u7f51\u4f7f\u7528"},{"location":"guide/subnet/#_2","text":"\u4e3a\u4e86\u65b9\u4fbf\u7528\u6237\u7684\u5feb\u901f\u4e0a\u624b\u4f7f\u7528\uff0cKube-OVN \u5185\u7f6e\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u5b50\u7f51\uff0c\u6240\u6709\u672a\u663e\u5f0f\u58f0\u660e\u5b50\u7f51\u5f52\u5c5e\u7684 Namespace \u4f1a\u81ea\u52a8\u4ece\u9ed8\u8ba4\u5b50\u7f51\u4e2d\u5206\u914d IP\uff0c \u5e76\u4f7f\u7528\u9ed8\u8ba4\u5b50\u7f51\u7684\u7f51\u7edc\u4fe1\u606f\u3002\u8be5\u5b50\u7f51\u7684\u914d\u7f6e\u4e3a\u5b89\u88c5\u65f6\u6307\u5b9a\uff0c\u53ef\u4ee5\u53c2\u8003 \u5185\u7f6e\u7f51\u7edc\u8bbe\u7f6e \uff0c \u5982\u679c\u8981\u5728\u5b89\u88c5\u540e\u4fee\u6539\u9ed8\u8ba4\u7f51\u7edc\u7684 CIDR \u8bf7\u53c2\u8003 \u4fee\u6539\u9ed8\u8ba4\u7f51\u7edc \u3002 \u5728 Overlay \u6a21\u5f0f\u4e0b\uff0c\u9ed8\u8ba4\u5b50\u7f51\u4f7f\u7528\u4e86\u5206\u5e03\u5f0f\u7f51\u5173\u5e76\u5bf9\u51fa\u7f51\u6d41\u91cf\u8fdb\u884c NAT \u8f6c\u6362\uff0c\u5176\u884c\u4e3a\u548c Flannel \u7684\u9ed8\u8ba4\u884c\u4e3a\u57fa\u672c\u4e00\u81f4\uff0c \u7528\u6237\u65e0\u9700\u989d\u5916\u7684\u914d\u7f6e\u5373\u53ef\u4f7f\u7528\u5230\u5927\u90e8\u5206\u7684\u7f51\u7edc\u529f\u80fd\u3002 \u5728 Underlay \u6a21\u5f0f\u4e0b\uff0c\u9ed8\u8ba4\u5b50\u7f51\u4f7f\u7528\u7269\u7406\u7f51\u5173\u4f5c\u4e3a\u51fa\u7f51\u7f51\u5173\uff0c\u5e76\u5f00\u542f arping \u68c0\u67e5\u7f51\u7edc\u8fde\u901a\u6027\u3002","title":"\u9ed8\u8ba4\u5b50\u7f51"},{"location":"guide/subnet/#_3","text":"\u9ed8\u8ba4\u5b50\u7f51 spec \u4e2d\u7684 default \u5b57\u6bb5\u4e3a true\uff0c\u4e00\u4e2a\u96c6\u7fa4\u4e0b\u53ea\u6709\u4e00\u4e2a\u9ed8\u8ba4\u5b50\u7f51\uff0c\u9ed8\u8ba4\u540d\u4e3a ovn-default \u3002 \u67e5\u770b\u9ed8\u8ba4\u5b50\u7f51\uff1a # kubectl get subnet ovn-default -o yaml apiVersion: kubeovn.io/v1 kind: Subnet metadata: creationTimestamp: \"2019-08-06T09:33:43Z\" generation: 1 name: ovn-default resourceVersion: \"1571334\" selfLink: /apis/kubeovn.io/v1/subnets/ovn-default uid: 7e2451f8-fb44-4f7f-b3e0-cfd27f6fd5d6 spec: cidrBlock: 10.16.0.0/16 default: true excludeIps: - 10.16.0.1 gateway: 10.16.0.1 gatewayType: distributed natOutgoing: true private: false protocol: IPv4","title":"\u67e5\u770b\u9ed8\u8ba4\u5b50\u7f51"},{"location":"guide/subnet/#join","text":"\u5728 Kubernetes \u7684\u7f51\u7edc\u89c4\u8303\u4e2d\uff0c\u8981\u6c42 Node \u53ef\u4ee5\u548c\u6240\u6709\u7684 Pod \u76f4\u63a5\u901a\u4fe1\u3002 \u4e3a\u4e86\u5728 Overlay \u7f51\u7edc\u6a21\u5f0f\u4e0b\u8fbe\u5230\u8fd9\u4e2a\u76ee\u7684\uff0c Kube-OVN \u521b\u5efa\u4e86\u4e00\u4e2a join \u5b50\u7f51\uff0c \u5e76\u5728\u6bcf\u4e2a Node \u8282\u70b9\u521b\u5efa\u4e86\u4e00\u5757\u865a\u62df\u7f51\u5361 ovn0 \u63a5\u5165 join \u5b50\u7f51\uff0c\u901a\u8fc7\u8be5\u7f51\u7edc\u5b8c\u6210\u8282\u70b9\u548c Pod \u4e4b\u95f4\u7684\u7f51\u7edc\u4e92\u901a\u3002 \u8be5\u5b50\u7f51\u7684\u914d\u7f6e\u4e3a\u5b89\u88c5\u65f6\u6307\u5b9a\uff0c\u53ef\u4ee5\u53c2\u8003 \u5185\u7f6e\u7f51\u7edc\u8bbe\u7f6e \uff0c\u5982\u679c\u8981\u5728\u5b89\u88c5\u540e\u4fee\u6539\u3002 join \u5b50\u7f51\u7684 CIDR \u8bf7\u53c2\u8003 \u4fee\u6539 Join \u5b50\u7f51","title":"Join \u5b50\u7f51"},{"location":"guide/subnet/#join_1","text":"\u8be5\u5b50\u7f51\u9ed8\u8ba4\u540d\u4e3a join \u4e00\u822c\u65e0\u9700\u5bf9\u8be5\u5b50\u7f51 CIDR \u5916\u7684\u5176\u4ed6\u7f51\u7edc\u914d\u7f6e\u8fdb\u884c\u4fee\u6539\u3002 # kubectl get subnet join -o yaml apiVersion: kubeovn.io/v1 kind: Subnet metadata: creationTimestamp: \"2019-08-06T09:33:43Z\" generation: 1 name: join resourceVersion: \"1571333\" selfLink: /apis/kubeovn.io/v1/subnets/join uid: 9c744810-c678-4d50-8a7d-b8ec12ef91b8 spec: cidrBlock: 100.64.0.0/16 default: false excludeIps: - 100.64.0.1 gateway: 100.64.0.1 gatewayNode: \"\" gatewayType: \"\" natOutgoing: false private: false protocol: IPv4 \u5728 node \u8282\u70b9\u67e5\u770b ovn0 \u7f51\u5361\uff1a # ifconfig ovn0 ovn0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST> mtu 1420 inet 100.64.0.4 netmask 255.255.0.0 broadcast 100.64.255.255 inet6 fe80::800:ff:fe40:5 prefixlen 64 scopeid 0x20<link> ether 0a:00:00:40:00:05 txqueuelen 1000 (Ethernet) RX packets 18 bytes 1428 (1.3 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 19 bytes 1810 (1.7 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0","title":"\u67e5\u770b Join \u5b50\u7f51"},{"location":"guide/subnet/#_4","text":"\u8fd9\u91cc\u6211\u4eec\u4ecb\u7ecd\u521b\u5efa\u4e00\u4e2a\u5b50\u7f51\uff0c\u5e76\u5c06\u5176\u548c\u67d0\u4e2a Namespace \u505a\u5173\u8054\u7684\u57fa\u672c\u64cd\u4f5c\uff0c\u66f4\u591a\u9ad8\u7ea7\u914d\u7f6e\u8bf7\u53c2\u8003\u540e\u7eed\u5185\u5bb9\u3002","title":"\u521b\u5efa\u81ea\u5b9a\u4e49\u5b50\u7f51"},{"location":"guide/subnet/#_5","text":"cat <<EOF | kubectl create -f - apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: subnet1 spec: cidrBlock: 10.66.0.0/16 excludeIps: - 10.66.0.1..10.66.0.10 - 10.66.0.101..10.66.0.151 gateway: 10.66.0.1 namespaces: - ns1 - ns2 EOF cidrBlock : \u5b50\u7f51 CIDR \u8303\u56f4\uff0c\u540c\u4e00\u4e2a VPC \u4e0b\u7684\u4e0d\u540c Subnet CIDR \u4e0d\u80fd\u91cd\u53e0\u3002 excludeIps : \u4fdd\u7559\u5730\u5740\u5217\u8868\uff0c\u5bb9\u5668\u7f51\u7edc\u5c06\u4e0d\u4f1a\u81ea\u52a8\u5206\u914d\u5217\u8868\u5185\u7684\u5730\u5740\uff0c\u53ef\u7528\u505a\u56fa\u5b9a IP \u5730\u5740\u5206\u914d\u6bb5\uff0c\u4e5f\u53ef\u5728 Underlay \u6a21\u5f0f\u4e0b\u907f\u514d\u548c\u7269\u7406\u7f51\u7edc\u4e2d\u5df2\u6709\u8bbe\u5907\u51b2\u7a81\u3002 gateway \uff1a\u8be5\u5b50\u7f51\u7f51\u5173\u5730\u5740\uff0cOverlay \u6a21\u5f0f\u4e0b Kube-OVN \u4f1a\u81ea\u52a8\u5206\u914d\u5bf9\u5e94\u7684\u903b\u8f91\u7f51\u5173\uff0cUnderlay \u6a21\u5f0f\u4e0b\u8be5\u5730\u5740\u9700\u4e3a\u5e95\u5c42\u7269\u7406\u7f51\u5173\u5730\u5740\u3002 namespaces : \u7ed1\u5b9a\u8be5\u5b50\u7f51\u7684 Namespace \u5217\u8868\uff0c\u7ed1\u5b9a\u540e Namespace \u4e0b\u7684 Pod \u5c06\u4f1a\u4ece\u5f53\u524d\u5b50\u7f51\u5206\u914d\u5730\u5740\u3002","title":"\u521b\u5efa\u5b50\u7f51"},{"location":"guide/subnet/#_6","text":"# kubectl create ns ls1 namespace/ls1 created # kubectl run nginx --image=nginx:alpine -n ls1 deployment.apps/nginx created # kubectl get pod -n ls1 -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-74d5899f46-n8wtg 1/1 Running 0 10s 10.66.0.11 node1 <none> <none>","title":"\u9a8c\u8bc1\u5b50\u7f51\u7ed1\u5b9a\u751f\u6548"},{"location":"guide/subnet/#overlay","text":"\u8be5\u529f\u80fd\u53ea\u5bf9 Overlay \u6a21\u5f0f\u5b50\u7f51\u751f\u6548\uff0cUnderlay \u7c7b\u578b\u5b50\u7f51\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u9700\u8981\u501f\u52a9\u5e95\u5c42\u7269\u7406\u7f51\u5173\u3002 Overlay \u5b50\u7f51\u4e0b\u7684 Pod \u9700\u8981\u901a\u8fc7\u7f51\u5173\u6765\u8bbf\u95ee\u96c6\u7fa4\u5916\u90e8\u7f51\u7edc\uff0cKube-OVN \u76ee\u524d\u652f\u6301\u4e24\u79cd\u7c7b\u578b\u7684\u7f51\u5173\uff1a \u5206\u5e03\u5f0f\u7f51\u5173\u548c\u96c6\u4e2d\u5f0f\u7f51\u5173\uff0c\u7528\u6237\u53ef\u4ee5\u5728\u5b50\u7f51\u4e2d\u5bf9\u7f51\u5173\u7684\u7c7b\u578b\u8fdb\u884c\u8c03\u6574\u3002 \u4e24\u79cd\u7c7b\u578b\u7f51\u5173\u5747\u652f\u6301 natOutgoing \u8bbe\u7f6e\uff0c\u7528\u6237\u53ef\u4ee5\u9009\u62e9 Pod \u8bbf\u95ee\u5916\u7f51\u65f6\u662f\u5426\u9700\u8981\u8fdb\u884c snat\u3002","title":"Overlay \u5b50\u7f51\u7f51\u5173\u914d\u7f6e"},{"location":"guide/subnet/#_7","text":"\u5b50\u7f51\u7684\u9ed8\u8ba4\u7c7b\u578b\u7f51\u5173\uff0c\u6bcf\u4e2a node \u4f1a\u4f5c\u4e3a\u5f53\u524d node \u4e0a pod \u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u7684\u7f51\u5173\u3002 \u6570\u636e\u5305\u4f1a\u901a\u8fc7\u672c\u673a\u7684 ovn0 \u7f51\u5361\u6d41\u5165\u4e3b\u673a\u7f51\u7edc\u6808\uff0c\u518d\u6839\u636e\u4e3b\u673a\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u51fa\u7f51\u3002 \u5f53 natOutgoing \u4e3a true \u65f6\uff0cPod \u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u5c06\u4f1a\u4f7f\u7528\u5f53\u524d\u6240\u5728\u5bbf\u4e3b\u673a\u7684 IP\u3002 \u5b50\u7f51\u793a\u4f8b\uff0c\u5176\u4e2d gatewayType \u5b57\u6bb5\u4e3a distributed \uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: distributed spec: cidrBlock: 10.166.0.0/16 default: false excludeIps: - 10.166.0.1 gateway: 10.166.0.1 gatewayType: distributed natOutgoing: true","title":"\u5206\u5e03\u5f0f\u7f51\u5173"},{"location":"guide/subnet/#_8","text":"\u5982\u679c\u5e0c\u671b\u5b50\u7f51\u5185\u6d41\u91cf\u8bbf\u95ee\u5916\u7f51\u4f7f\u7528\u56fa\u5b9a\u7684 IP\uff0c\u4ee5\u4fbf\u5ba1\u8ba1\u548c\u767d\u540d\u5355\u7b49\u5b89\u5168\u64cd\u4f5c\uff0c\u53ef\u4ee5\u5728\u5b50\u7f51\u4e2d\u8bbe\u7f6e\u7f51\u5173\u7c7b\u578b\u4e3a\u96c6\u4e2d\u5f0f\u7f51\u5173\u3002 \u5728\u96c6\u4e2d\u5f0f\u7f51\u5173\u6a21\u5f0f\u4e0b\uff0cPod \u8bbf\u95ee\u5916\u7f51\u7684\u6570\u636e\u5305\u4f1a\u9996\u5148\u88ab\u8def\u7531\u5230\u7279\u5b9a\u8282\u70b9\u7684 ovn0 \u7f51\u5361\uff0c\u518d\u901a\u8fc7\u4e3b\u673a\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u51fa\u7f51\u3002 \u5f53 natOutgoing \u4e3a true \u65f6\uff0cPod \u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u5c06\u4f1a\u4f7f\u7528\u7279\u5b9a\u5bbf\u4e3b\u673a\u7684 IP\u3002 \u5b50\u7f51\u793a\u4f8b\uff0c\u5176\u4e2dgatewayType \u5b57\u6bb5\u4e3a centralized\uff0cgatewayNode \u4e3a\u7279\u5b9a\u673a\u5668\u5728 Kubernetes \u4e2d\u7684 node name\u3002 \u5176\u4e2dgatewayNode\u5b57\u6bb5\u53ef\u4ee5\u4e3a\u9017\u53f7\u5206\u9694\u7684\u591a\u53f0\u4e3b\u673a\u3002 apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: centralized spec: cidrBlock: 10.166.0.0/16 default: false excludeIps: - 10.166.0.1 gateway: 10.166.0.1 gatewayType: centralized gatewayNode: \"node1,node2\" natOutgoing: true \u96c6\u4e2d\u5f0f\u7f51\u5173\u5982\u679c\u5e0c\u671b\u6307\u5b9a\u673a\u5668\u7684\u7279\u5b9a\u7f51\u5361\u8fdb\u884c\u51fa\u7f51\uff0c gatewayNode \u53ef\u66f4\u6539\u4e3a kube-ovn-worker:172.18.0.2, kube-ovn-control-plane:172.18.0.3 \u683c\u5f0f\u3002 \u96c6\u4e2d\u5f0f\u7f51\u5173\u9ed8\u8ba4\u4e3a\u4e3b\u5907\u6a21\u5f0f\uff0c\u53ea\u6709\u4e3b\u8282\u70b9\u8fdb\u884c\u6d41\u91cf\u8f6c\u53d1\uff0c \u5982\u679c\u9700\u8981\u5207\u6362\u4e3a ECMP \u6a21\u5f0f\uff0c\u8bf7\u53c2\u8003 \u96c6\u4e2d\u5f0f\u7f51\u5173 ECMP \u5f00\u542f\u8bbe\u7f6e \u3002","title":"\u96c6\u4e2d\u5f0f\u7f51\u5173"},{"location":"guide/subnet/#acl","text":"\u5bf9\u4e8e\u6709\u7ec6\u7c92\u5ea6 ACL \u63a7\u5236\u7684\u573a\u666f\uff0cKube-OVN \u7684 Subnet \u63d0\u4f9b\u4e86 ACL \u89c4\u5219\u7684\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u5b9e\u73b0\u7f51\u7edc\u89c4\u5219\u7684\u7cbe\u7ec6\u63a7\u5236\u3002 Subnet \u4e2d\u7684 ACL \u89c4\u5219\u548c OVN \u7684 ACL \u89c4\u5219\u4e00\u81f4\uff0c\u76f8\u5173\u5b57\u6bb5\u5185\u5bb9\u53ef\u4ee5\u53c2\u8003 ovn-nb ACL Table \uff0c match \u5b57\u6bb5\u652f\u6301\u7684\u5b57\u6bb5\u53ef\u53c2\u8003 ovn-sb Logical Flow Table \u3002 \u5141\u8bb8 IP \u5730\u5740\u4e3a 10.10.0.2 \u7684 Pod \u8bbf\u95ee\u6240\u6709\u5730\u5740\uff0c\u4f46\u4e0d\u5141\u8bb8\u5176\u4ed6\u5730\u5740\u4e3b\u52a8\u8bbf\u95ee\u81ea\u5df1\u7684 ACL \u89c4\u5219\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: acl spec: acls: - action: drop direction: to-lport match: ip4.dst == 10.10.0.2 && ip priority: 1002 - action: allow-related direction: from-lport match: ip4.src == 10.10.0.2 && ip priority: 1002 cidrBlock: 10.10.0.0/24","title":"\u5b50\u7f51 ACL \u8bbe\u7f6e"},{"location":"guide/subnet/#_9","text":"\u5b50\u7f51 ACL \u7684\u529f\u80fd\u53ef\u4ee5\u8986\u76d6\u5b50\u7f51\u9694\u79bb\u7684\u529f\u80fd\uff0c\u5e76\u6709\u66f4\u597d\u7684\u7075\u6d3b\u6027\uff0c\u6211\u4eec\u63a8\u8350\u4f7f\u7528\u5b50\u7f51 ACL \u6765\u505a\u76f8\u5e94\u7684\u914d\u7f6e\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b Kube-OVN \u521b\u5efa\u7684\u5b50\u7f51\u4e4b\u95f4\u53ef\u4ee5\u76f8\u4e92\u901a\u4fe1\uff0cPod \u4e5f\u53ef\u4ee5\u901a\u8fc7\u7f51\u5173\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u3002 \u5982\u9700\u5bf9\u5b50\u7f51\u95f4\u7684\u8bbf\u95ee\u8fdb\u884c\u63a7\u5236\uff0c\u53ef\u4ee5\u5728\u5b50\u7f51 CRD \u4e2d\u5c06 private \u8bbe\u7f6e\u4e3a true\uff0c\u5219\u8be5\u5b50\u7f51\u5c06\u548c\u5176\u4ed6\u5b50\u7f51\u4ee5\u53ca\u5916\u90e8\u7f51\u7edc\u9694\u79bb\uff0c \u53ea\u80fd\u8fdb\u884c\u5b50\u7f51\u5185\u90e8\u7684\u901a\u4fe1\u3002\u5982\u9700\u5f00\u767d\u540d\u5355\uff0c\u53ef\u4ee5\u901a\u8fc7 allowSubnets \u8fdb\u884c\u8bbe\u7f6e\u3002 allowSubnets \u5185\u7684\u7f51\u6bb5\u548c\u8be5\u5b50\u7f51\u53ef\u4ee5\u53cc\u5411\u4e92\u8bbf\u3002","title":"\u5b50\u7f51\u9694\u79bb\u8bbe\u7f6e"},{"location":"guide/subnet/#_10","text":"apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: private spec: protocol: IPv4 default: false namespaces: - ns1 - ns2 cidrBlock: 10.69.0.0/16 private: true allowSubnets: - 10.16.0.0/16 - 10.18.0.0/16","title":"\u5f00\u542f\u8bbf\u95ee\u63a7\u5236\u7684\u5b50\u7f51\u793a\u4f8b"},{"location":"guide/subnet/#underlay","text":"\u8be5\u90e8\u5206\u529f\u80fd\u53ea\u5bf9 Underlay \u7c7b\u578b\u5b50\u7f51\u751f\u6548\u3002 vlan : \u5982\u679c\u4f7f\u7528 Underlay \u7f51\u7edc\uff0c\u8be5\u5b57\u6bb5\u7528\u6765\u63a7\u5236\u8be5 Subnet \u548c\u54ea\u4e2a Vlan CR \u8fdb\u884c\u7ed1\u5b9a\u3002\u8be5\u9009\u9879\u9ed8\u8ba4\u4e3a\u7a7a\u5b57\u7b26\u4e32\uff0c\u5373\u4e0d\u4f7f\u7528 Underlay \u7f51\u7edc\u3002 logicalGateway : \u4e00\u4e9b Underlay \u73af\u5883\u4e3a\u7eaf\u4e8c\u5c42\u7f51\u7edc\uff0c\u4e0d\u5b58\u5728\u7269\u7406\u7684\u4e09\u5c42\u7f51\u5173\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u53ef\u4ee5\u501f\u52a9 OVN \u672c\u8eab\u7684\u80fd\u529b\u8bbe\u7f6e\u4e00\u4e2a\u865a\u62df\u7f51\u5173\uff0c\u5c06 Underlay \u548c Overlay \u7f51\u7edc\u6253\u901a\u3002\u9ed8\u8ba4\u503c\u4e3a\uff1a false \u3002","title":"Underlay \u76f8\u5173\u9009\u9879"},{"location":"guide/subnet/#_11","text":"\u9ed8\u8ba4\u60c5\u51b5\u4e0b kube-ovn-cni \u5728\u542f\u52a8 Pod \u540e\u4f1a\u4f7f\u7528 ICMP \u6216 ARP \u534f\u8bae\u8bf7\u6c42\u7f51\u5173\u5e76\u7b49\u5f85\u8fd4\u56de\uff0c \u4ee5\u9a8c\u8bc1\u7f51\u7edc\u5de5\u4f5c\u6b63\u5e38\uff0c\u5728\u90e8\u5206 Underlay \u73af\u5883\u7f51\u5173\u65e0\u6cd5\u54cd\u5e94 ARP \u8bf7\u6c42\uff0c\u6216\u65e0\u9700\u7f51\u7edc\u5916\u90e8\u8054\u901a\u7684\u573a\u666f \u53ef\u4ee5\u5173\u95ed\u7f51\u5173\u68c0\u67e5\u3002 apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: disable-gw-check spec: disableGatewayCheck: true","title":"\u7f51\u5173\u68c0\u67e5\u8bbe\u7f6e"},{"location":"guide/subnet/#_12","text":"QoS \u8bbe\u7f6e \u591a\u7f51\u7edc\u7ba1\u7406\uff0c\u901a\u7528 CNI IPAM \u7ba1\u7406 DHCP \u9009\u9879 \u5916\u90e8\u7f51\u5173\u8bbe\u7f6e \u96c6\u7fa4\u4e92\u8054\u8bbe\u7f6e \u865a\u62df IP \u8bbe\u7f6e","title":"\u5176\u4ed6\u9ad8\u7ea7\u8bbe\u7f6e"},{"location":"guide/vpc/","text":"VPC \u4f7f\u7528 Kube-OVN \u652f\u6301\u591a\u79df\u6237\u9694\u79bb\u7ea7\u522b\u7684 VPC \u7f51\u7edc\u3002\u4e0d\u540c VPC \u7f51\u7edc\u76f8\u4e92\u72ec\u7acb\uff0c\u53ef\u4ee5\u5206\u522b\u914d\u7f6e Subnet \u7f51\u6bb5\uff0c \u8def\u7531\u7b56\u7565\uff0c\u5b89\u5168\u7b56\u7565\uff0c\u51fa\u7f51\u7f51\u5173\uff0cEIP \u7b49\u914d\u7f6e\u3002 VPC \u4e3b\u8981\u7528\u4e8e\u6709\u591a\u79df\u6237\u7f51\u7edc\u5f3a\u9694\u79bb\u7684\u573a\u666f\uff0c\u90e8\u5206 Kubernetes \u7f51\u7edc\u529f\u80fd\u5728\u591a\u79df\u6237\u7f51\u7edc\u4e0b\u5b58\u5728\u51b2\u7a81\u3002 \u4f8b\u5982\u8282\u70b9\u548c Pod \u4e92\u8bbf\uff0cNodePort \u529f\u80fd\uff0c\u57fa\u4e8e\u7f51\u7edc\u8bbf\u95ee\u7684\u5065\u5eb7\u68c0\u67e5\u548c DNS \u80fd\u529b\u5728\u591a\u79df\u6237\u7f51\u7edc\u573a\u666f\u6682\u4e0d\u652f\u6301\u3002 \u4e3a\u4e86\u65b9\u4fbf\u5e38\u89c1 Kubernetes \u7684\u4f7f\u7528\u573a\u666f\uff0cKube-OVN \u9ed8\u8ba4 VPC \u505a\u4e86\u7279\u6b8a\u8bbe\u8ba1\uff0c\u8be5 VPC \u4e0b\u7684 Subnet \u53ef\u4ee5\u6ee1\u8db3 Kubernetes \u89c4\u8303\u3002\u7528\u6237\u81ea\u5b9a\u4e49 VPC \u652f\u6301\u672c\u6587\u6863\u4ecb\u7ecd\u7684\u9759\u6001\u8def\u7531\uff0cEIP \u548c NAT \u7f51\u5173\u7b49\u529f\u80fd\u3002 \u5e38\u89c1\u9694\u79bb\u9700\u6c42\u53ef\u901a\u8fc7\u9ed8\u8ba4 VPC \u4e0b\u7684\u7f51\u7edc\u7b56\u7565\u548c\u5b50\u7f51 ACL \u5b9e\u73b0\uff0c\u5728\u4f7f\u7528\u81ea\u5b9a\u4e49 VPC \u524d\u8bf7\u660e\u786e\u662f\u5426\u9700\u8981 VPC \u7ea7\u522b\u7684\u9694\u79bb\uff0c\u5e76\u4e86\u89e3\u81ea\u5b9a\u4e49 VPC \u4e0b\u7684\u9650\u5236\u3002 \u521b\u5efa\u81ea\u5b9a\u4e49 VPC \u521b\u5efa\u4e24\u4e2a VPC\uff1a kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: test-vpc-1 spec: namespaces: - ns1 --- kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: test-vpc-2 spec: {} namespaces \u53ef\u4ee5\u9650\u5b9a\u53ea\u6709\u54ea\u4e9b Namespace \u53ef\u4ee5\u4f7f\u7528\u5f53\u524d VPC\uff0c\u82e5\u4e3a\u7a7a\u5219\u4e0d\u9650\u5b9a\u3002 \u521b\u5efa\u4e24\u4e2a\u5b50\u7f51\uff0c\u5206\u5c5e\u4e24\u4e2a\u4e0d\u540c\u7684 VPC \u5e76\u6709\u76f8\u540c\u7684 CIDR: kind: Subnet apiVersion: kubeovn.io/v1 metadata: name: net1 spec: vpc: test-vpc-1 cidrBlock: 10.0.1.0/24 protocol: IPv4 namespaces: - ns1 --- kind: Subnet apiVersion: kubeovn.io/v1 metadata: name: net2 spec: vpc: test-vpc-2 cidrBlock: 10.0.1.0/24 protocol: IPv4 namespaces: - ns2 \u5206\u522b\u5728\u4e24\u4e2a Namespace \u4e0b\u521b\u5efa Pod: apiVersion: v1 kind: Pod metadata: annotations: ovn.kubernetes.io/logical_switch: net1 namespace: ns1 name: vpc1-pod spec: containers: - name: vpc1-pod image: nginx:alpine --- apiVersion: v1 kind: Pod metadata: annotations: ovn.kubernetes.io/logical_switch: net2 namespace: ns2 name: vpc2-pod spec: containers: - name: vpc2-pod image: nginx:alpine \u8fd0\u884c\u6210\u529f\u540e\u53ef\u89c2\u5bdf\u4e24\u4e2a Pod \u5730\u5740\u5c5e\u4e8e\u540c\u4e00\u4e2a CIDR\uff0c\u4f46\u7531\u4e8e\u8fd0\u884c\u5728\u4e0d\u540c\u7684\u79df\u6237 VPC\uff0c\u4e24\u4e2a Pod \u65e0\u6cd5\u76f8\u4e92\u8bbf\u95ee\u3002 \u521b\u5efa VPC \u7f51\u5173 \u81ea\u5b9a\u4e49 VPC \u4e0b\u7684\u5b50\u7f51\u4e0d\u652f\u6301\u9ed8\u8ba4 VPC \u4e0b\u7684\u5206\u5e03\u5f0f\u7f51\u5173\u548c\u96c6\u4e2d\u5f0f\u7f51\u5173 VPC \u5185\u5bb9\u5668\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u9700\u8981\u901a\u8fc7 VPC \u7f51\u5173\uff0cVPC \u7f51\u5173\u53ef\u4ee5\u6253\u901a\u7269\u7406\u7f51\u7edc\u548c\u79df\u6237\u7f51\u7edc\uff0c\u5e76\u63d0\u4f9b \u6d6e\u52a8 IP\uff0cSNAT \u548c DNAT \u529f\u80fd\u3002 VPC \u7f51\u5173\u529f\u80fd\u4f9d\u8d56 Multus-CNI \u7684\u591a\u7f51\u5361\u529f\u80fd\uff0c\u5b89\u88c5\u8bf7\u53c2\u8003 multus-cni \u3002 \u914d\u7f6e\u5916\u90e8\u7f51\u7edc apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: ovn-vpc-external-network spec: protocol: IPv4 provider: ovn-vpc-external-network.kube-system cidrBlock: 192.168.0.0/24 gateway: 192.168.0.1 # IP address of the physical gateway excludeIps: - 192.168.0.1..192.168.0.10 --- apiVersion: \"k8s.cni.cncf.io/v1\" kind: NetworkAttachmentDefinition metadata: name: ovn-vpc-external-network namespace: kube-system spec: config: '{ \"cniVersion\": \"0.3.0\", \"type\": \"macvlan\", \"master\": \"eth1\", \"mode\": \"bridge\", \"ipam\": { \"type\": \"kube-ovn\", \"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\", \"provider\": \"ovn-vpc-external-network.kube-system\" } }' \u8be5 Subnet \u7528\u6765\u7ba1\u7406\u53ef\u7528\u7684\u5916\u90e8\u5730\u5740\uff0c\u8bf7\u548c\u7f51\u7edc\u7ba1\u7406\u6c9f\u901a\u7ed9\u51fa\u53ef\u7528\u7684\u7269\u7406\u6bb5 IP\u3002 VPC \u7f51\u5173\u4f7f\u7528 Macvlan \u505a\u7269\u7406\u7f51\u7edc\u914d\u7f6e\uff0c NetworkAttachmentDefinition \u7684 master \u9700\u4e3a\u5bf9\u5e94\u7269\u7406\u7f51\u8def\u7f51\u5361\u7684\u7f51\u5361\u540d\u3002 provider \u683c\u5f0f\u4e3a <NetworkAttachmentDefinition Name>.<NetworkAttachmentDefinition Namespace> \u3002 name \u5fc5\u987b\u4e3a ovn-vpc-external-network\uff0c\u8fd9\u91cc\u4ee3\u7801\u4e2d\u505a\u4e86\u786c\u7f16\u7801\u3002 \u5f00\u542f VPC \u7f51\u5173\u529f\u80fd VPC \u7f51\u5173\u529f\u80fd\u9700\u8981\u901a\u8fc7 kube-system \u4e0b\u7684 ovn-vpc-nat-gw-config \u5f00\u542f\uff1a kind: ConfigMap apiVersion: v1 metadata: name: ovn-vpc-nat-gw-config namespace: kube-system data: image: 'kubeovn/vpc-nat-gateway:v1.10.1' enable-vpc-nat-gw: 'true' image : \u7f51\u5173 Pod \u6240\u4f7f\u7528\u7684\u955c\u50cf\u3002 enable-vpc-nat-gw \uff1a \u63a7\u5236\u662f\u5426\u542f\u7528 VPC \u7f51\u5173\u529f\u80fd\u3002 \u521b\u5efa VPC \u7f51\u5173\u5e76\u914d\u7f6e\u9ed8\u8ba4\u8def\u7531 kind: VpcNatGateway apiVersion: kubeovn.io/v1 metadata: name: gw1 spec: vpc: test-vpc-1 subnet: net1 lanIp: 10.0.1.254 selector: - \"kubernetes.io/hostname: kube-ovn-worker\" - \"kubernetes.io/os: linux\" staticRoutes: - cidr: 0.0.0.0/0 nextHopIP: 10.0.1.254 policy: policyDst subnet \uff1a \u4e3a VPC \u5185\u67d0\u4e2a Subnet \u540d\uff0cVPC \u7f51\u5173 Pod \u4f1a\u5728\u8be5\u5b50\u7f51\u4e0b\u7528 lanIp \u6765\u8fde\u63a5\u79df\u6237\u7f51\u7edc\u3002 lanIp \uff1a subnet \u5185\u67d0\u4e2a\u672a\u88ab\u4f7f\u7528\u7684 IP\uff0cVPC \u7f51\u5173 Pod \u6700\u7ec8\u4f1a\u4f7f\u7528\u8be5 Pod\u3002 selector : VPC \u7f51\u5173 Pod \u7684\u8282\u70b9\u9009\u62e9\u5668\u3002 nextHopIP \uff1a\u9700\u548c lanIp \u76f8\u540c\u3002 \u521b\u5efa EIP EIP \u4e3a\u5916\u90e8\u7f51\u7edc\u6bb5\u7684\u67d0\u4e2a IP \u5206\u914d\u7ed9 VPC \u7f51\u5173\u540e\u53ef\u8fdb\u884c\u6d6e\u52a8IP\uff0cSNAT \u548c DNAT \u64cd\u4f5c\u3002 \u968f\u673a\u5206\u914d\u4e00\u4e2a\u5730\u5740\u7ed9 EIP\uff1a kind: IptablesEIP apiVersion: kubeovn.io/v1 metadata: name: eip-random spec: natGwDp: gw1 \u56fa\u5b9a EIP \u5730\u5740\u5206\u914d\uff1a kind: IptablesEIP apiVersion: kubeovn.io/v1 metadata: name: eip-static spec: natGwDp: gw1 v4ip: 10.0.1.111 \u521b\u5efa DNAT \u89c4\u5219 kind: IptablesEIP apiVersion: kubeovn.io/v1 metadata: name: eipd01 spec: natGwDp: gw1 --- kind: IptablesDnatRule apiVersion: kubeovn.io/v1 metadata: name: dnat01 spec: eip: eipd01 externalPort: '8888' internalIp: 10.0.1.10 internalPort: '80' protocol: tcp \u521b\u5efa SNAT \u89c4\u5219 --- kind: IptablesEIP apiVersion: kubeovn.io/v1 metadata: name: eips01 spec: natGwDp: gw1 --- kind: IptablesSnatRule apiVersion: kubeovn.io/v1 metadata: name: snat01 spec eip: eips01 internalCIDR: 10.0.1.0/24 \u521b\u5efa\u6d6e\u52a8 IP --- kind: IptablesEIP apiVersion: kubeovn.io/v1 metadata: name: eipf01 spec: natGwDp: gw1 --- kind: IptablesFIPRule apiVersion: kubeovn.io/v1 metadata: name: fip01 spec: eip: eipf01 internalIp: 10.0.1.5 \u81ea\u5b9a\u4e49\u8def\u7531 \u5728\u81ea\u5b9a\u4e49 VPC \u5185\uff0c\u7528\u6237\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7f51\u7edc\u5185\u90e8\u7684\u8def\u7531\u89c4\u5219\uff0c\u7ed3\u5408\u7f51\u5173\u5b9e\u73b0\u66f4\u7075\u6d3b\u7684\u8f6c\u53d1\u3002 Kube-OVN \u652f\u6301\u9759\u6001\u8def\u7531\u548c\u66f4\u4e3a\u7075\u6d3b\u7684\u7b56\u7565\u8def\u7531\u3002 \u9759\u6001\u8def\u7531 kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: test-vpc-1 spec: staticRoutes: - cidr: 0.0.0.0/0 nextHopIP: 10.0.1.254 policy: policyDst - cidr: 172.31.0.0/24 nextHopIP: 10.0.1.253 policy: policySrc policy : \u652f\u6301\u76ee\u7684\u5730\u5740\u8def\u7531 policyDst \u548c\u6e90\u5730\u5740\u8def\u7531 policySrc \u3002 \u5f53\u8def\u7531\u89c4\u5219\u5b58\u5728\u91cd\u53e0\u65f6\uff0cCIDR \u63a9\u7801\u8f83\u957f\u7684\u89c4\u5219\u4f18\u5148\u7ea7\u66f4\u9ad8\uff0c\u82e5\u63a9\u7801\u957f\u5ea6\u76f8\u540c\u5219\u76ee\u7684\u5730\u5740\u8def\u7531\u4f18\u5148\u4e8e\u6e90\u5730\u5740\u8def\u7531\u3002 \u7b56\u7565\u8def\u7531 \u9488\u5bf9\u9759\u6001\u8def\u7531\u5339\u914d\u7684\u6d41\u91cf\uff0c\u53ef\u901a\u8fc7\u7b56\u7565\u8def\u7531\u8fdb\u884c\u66f4\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\u3002\u7b56\u7565\u8def\u7531\u63d0\u4f9b\u4e86\u66f4\u7cbe\u786e\u7684\u5339\u914d\u89c4\u5219\uff0c\u4f18\u5148\u7ea7\u63a7\u5236 \u548c\u66f4\u591a\u7684\u8f6c\u53d1\u52a8\u4f5c\u3002\u8be5\u529f\u80fd\u4e3a OVN \u5185\u90e8\u903b\u8f91\u8def\u7531\u5668\u7b56\u7565\u529f\u80fd\u7684\u4e00\u4e2a\u5bf9\u5916\u66b4\u9732\uff0c\u66f4\u591a\u4f7f\u7528\u4fe1\u606f\u8bf7\u53c2\u8003 Logical Router Policy \u3002 \u7b80\u5355\u793a\u4f8b\u5982\u4e0b\uff1a kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: test-vpc-1 spec: policyRoutes: - action: drop match: ip4.src==10.0.1.0/24 && ip4.dst==10.0.1.250 priority: 11 - action: reroute match: ip4.src==10.0.1.0/24 nextHopIP: 10.0.1.252 priority: 10","title":"VPC \u4f7f\u7528"},{"location":"guide/vpc/#vpc","text":"Kube-OVN \u652f\u6301\u591a\u79df\u6237\u9694\u79bb\u7ea7\u522b\u7684 VPC \u7f51\u7edc\u3002\u4e0d\u540c VPC \u7f51\u7edc\u76f8\u4e92\u72ec\u7acb\uff0c\u53ef\u4ee5\u5206\u522b\u914d\u7f6e Subnet \u7f51\u6bb5\uff0c \u8def\u7531\u7b56\u7565\uff0c\u5b89\u5168\u7b56\u7565\uff0c\u51fa\u7f51\u7f51\u5173\uff0cEIP \u7b49\u914d\u7f6e\u3002 VPC \u4e3b\u8981\u7528\u4e8e\u6709\u591a\u79df\u6237\u7f51\u7edc\u5f3a\u9694\u79bb\u7684\u573a\u666f\uff0c\u90e8\u5206 Kubernetes \u7f51\u7edc\u529f\u80fd\u5728\u591a\u79df\u6237\u7f51\u7edc\u4e0b\u5b58\u5728\u51b2\u7a81\u3002 \u4f8b\u5982\u8282\u70b9\u548c Pod \u4e92\u8bbf\uff0cNodePort \u529f\u80fd\uff0c\u57fa\u4e8e\u7f51\u7edc\u8bbf\u95ee\u7684\u5065\u5eb7\u68c0\u67e5\u548c DNS \u80fd\u529b\u5728\u591a\u79df\u6237\u7f51\u7edc\u573a\u666f\u6682\u4e0d\u652f\u6301\u3002 \u4e3a\u4e86\u65b9\u4fbf\u5e38\u89c1 Kubernetes \u7684\u4f7f\u7528\u573a\u666f\uff0cKube-OVN \u9ed8\u8ba4 VPC \u505a\u4e86\u7279\u6b8a\u8bbe\u8ba1\uff0c\u8be5 VPC \u4e0b\u7684 Subnet \u53ef\u4ee5\u6ee1\u8db3 Kubernetes \u89c4\u8303\u3002\u7528\u6237\u81ea\u5b9a\u4e49 VPC \u652f\u6301\u672c\u6587\u6863\u4ecb\u7ecd\u7684\u9759\u6001\u8def\u7531\uff0cEIP \u548c NAT \u7f51\u5173\u7b49\u529f\u80fd\u3002 \u5e38\u89c1\u9694\u79bb\u9700\u6c42\u53ef\u901a\u8fc7\u9ed8\u8ba4 VPC \u4e0b\u7684\u7f51\u7edc\u7b56\u7565\u548c\u5b50\u7f51 ACL \u5b9e\u73b0\uff0c\u5728\u4f7f\u7528\u81ea\u5b9a\u4e49 VPC \u524d\u8bf7\u660e\u786e\u662f\u5426\u9700\u8981 VPC \u7ea7\u522b\u7684\u9694\u79bb\uff0c\u5e76\u4e86\u89e3\u81ea\u5b9a\u4e49 VPC \u4e0b\u7684\u9650\u5236\u3002","title":"VPC \u4f7f\u7528"},{"location":"guide/vpc/#vpc_1","text":"\u521b\u5efa\u4e24\u4e2a VPC\uff1a kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: test-vpc-1 spec: namespaces: - ns1 --- kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: test-vpc-2 spec: {} namespaces \u53ef\u4ee5\u9650\u5b9a\u53ea\u6709\u54ea\u4e9b Namespace \u53ef\u4ee5\u4f7f\u7528\u5f53\u524d VPC\uff0c\u82e5\u4e3a\u7a7a\u5219\u4e0d\u9650\u5b9a\u3002 \u521b\u5efa\u4e24\u4e2a\u5b50\u7f51\uff0c\u5206\u5c5e\u4e24\u4e2a\u4e0d\u540c\u7684 VPC \u5e76\u6709\u76f8\u540c\u7684 CIDR: kind: Subnet apiVersion: kubeovn.io/v1 metadata: name: net1 spec: vpc: test-vpc-1 cidrBlock: 10.0.1.0/24 protocol: IPv4 namespaces: - ns1 --- kind: Subnet apiVersion: kubeovn.io/v1 metadata: name: net2 spec: vpc: test-vpc-2 cidrBlock: 10.0.1.0/24 protocol: IPv4 namespaces: - ns2 \u5206\u522b\u5728\u4e24\u4e2a Namespace \u4e0b\u521b\u5efa Pod: apiVersion: v1 kind: Pod metadata: annotations: ovn.kubernetes.io/logical_switch: net1 namespace: ns1 name: vpc1-pod spec: containers: - name: vpc1-pod image: nginx:alpine --- apiVersion: v1 kind: Pod metadata: annotations: ovn.kubernetes.io/logical_switch: net2 namespace: ns2 name: vpc2-pod spec: containers: - name: vpc2-pod image: nginx:alpine \u8fd0\u884c\u6210\u529f\u540e\u53ef\u89c2\u5bdf\u4e24\u4e2a Pod \u5730\u5740\u5c5e\u4e8e\u540c\u4e00\u4e2a CIDR\uff0c\u4f46\u7531\u4e8e\u8fd0\u884c\u5728\u4e0d\u540c\u7684\u79df\u6237 VPC\uff0c\u4e24\u4e2a Pod \u65e0\u6cd5\u76f8\u4e92\u8bbf\u95ee\u3002","title":"\u521b\u5efa\u81ea\u5b9a\u4e49 VPC"},{"location":"guide/vpc/#vpc_2","text":"\u81ea\u5b9a\u4e49 VPC \u4e0b\u7684\u5b50\u7f51\u4e0d\u652f\u6301\u9ed8\u8ba4 VPC \u4e0b\u7684\u5206\u5e03\u5f0f\u7f51\u5173\u548c\u96c6\u4e2d\u5f0f\u7f51\u5173 VPC \u5185\u5bb9\u5668\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u9700\u8981\u901a\u8fc7 VPC \u7f51\u5173\uff0cVPC \u7f51\u5173\u53ef\u4ee5\u6253\u901a\u7269\u7406\u7f51\u7edc\u548c\u79df\u6237\u7f51\u7edc\uff0c\u5e76\u63d0\u4f9b \u6d6e\u52a8 IP\uff0cSNAT \u548c DNAT \u529f\u80fd\u3002 VPC \u7f51\u5173\u529f\u80fd\u4f9d\u8d56 Multus-CNI \u7684\u591a\u7f51\u5361\u529f\u80fd\uff0c\u5b89\u88c5\u8bf7\u53c2\u8003 multus-cni \u3002","title":"\u521b\u5efa VPC \u7f51\u5173"},{"location":"guide/vpc/#_1","text":"apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: ovn-vpc-external-network spec: protocol: IPv4 provider: ovn-vpc-external-network.kube-system cidrBlock: 192.168.0.0/24 gateway: 192.168.0.1 # IP address of the physical gateway excludeIps: - 192.168.0.1..192.168.0.10 --- apiVersion: \"k8s.cni.cncf.io/v1\" kind: NetworkAttachmentDefinition metadata: name: ovn-vpc-external-network namespace: kube-system spec: config: '{ \"cniVersion\": \"0.3.0\", \"type\": \"macvlan\", \"master\": \"eth1\", \"mode\": \"bridge\", \"ipam\": { \"type\": \"kube-ovn\", \"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\", \"provider\": \"ovn-vpc-external-network.kube-system\" } }' \u8be5 Subnet \u7528\u6765\u7ba1\u7406\u53ef\u7528\u7684\u5916\u90e8\u5730\u5740\uff0c\u8bf7\u548c\u7f51\u7edc\u7ba1\u7406\u6c9f\u901a\u7ed9\u51fa\u53ef\u7528\u7684\u7269\u7406\u6bb5 IP\u3002 VPC \u7f51\u5173\u4f7f\u7528 Macvlan \u505a\u7269\u7406\u7f51\u7edc\u914d\u7f6e\uff0c NetworkAttachmentDefinition \u7684 master \u9700\u4e3a\u5bf9\u5e94\u7269\u7406\u7f51\u8def\u7f51\u5361\u7684\u7f51\u5361\u540d\u3002 provider \u683c\u5f0f\u4e3a <NetworkAttachmentDefinition Name>.<NetworkAttachmentDefinition Namespace> \u3002 name \u5fc5\u987b\u4e3a ovn-vpc-external-network\uff0c\u8fd9\u91cc\u4ee3\u7801\u4e2d\u505a\u4e86\u786c\u7f16\u7801\u3002","title":"\u914d\u7f6e\u5916\u90e8\u7f51\u7edc"},{"location":"guide/vpc/#vpc_3","text":"VPC \u7f51\u5173\u529f\u80fd\u9700\u8981\u901a\u8fc7 kube-system \u4e0b\u7684 ovn-vpc-nat-gw-config \u5f00\u542f\uff1a kind: ConfigMap apiVersion: v1 metadata: name: ovn-vpc-nat-gw-config namespace: kube-system data: image: 'kubeovn/vpc-nat-gateway:v1.10.1' enable-vpc-nat-gw: 'true' image : \u7f51\u5173 Pod \u6240\u4f7f\u7528\u7684\u955c\u50cf\u3002 enable-vpc-nat-gw \uff1a \u63a7\u5236\u662f\u5426\u542f\u7528 VPC \u7f51\u5173\u529f\u80fd\u3002","title":"\u5f00\u542f VPC \u7f51\u5173\u529f\u80fd"},{"location":"guide/vpc/#vpc_4","text":"kind: VpcNatGateway apiVersion: kubeovn.io/v1 metadata: name: gw1 spec: vpc: test-vpc-1 subnet: net1 lanIp: 10.0.1.254 selector: - \"kubernetes.io/hostname: kube-ovn-worker\" - \"kubernetes.io/os: linux\" staticRoutes: - cidr: 0.0.0.0/0 nextHopIP: 10.0.1.254 policy: policyDst subnet \uff1a \u4e3a VPC \u5185\u67d0\u4e2a Subnet \u540d\uff0cVPC \u7f51\u5173 Pod \u4f1a\u5728\u8be5\u5b50\u7f51\u4e0b\u7528 lanIp \u6765\u8fde\u63a5\u79df\u6237\u7f51\u7edc\u3002 lanIp \uff1a subnet \u5185\u67d0\u4e2a\u672a\u88ab\u4f7f\u7528\u7684 IP\uff0cVPC \u7f51\u5173 Pod \u6700\u7ec8\u4f1a\u4f7f\u7528\u8be5 Pod\u3002 selector : VPC \u7f51\u5173 Pod \u7684\u8282\u70b9\u9009\u62e9\u5668\u3002 nextHopIP \uff1a\u9700\u548c lanIp \u76f8\u540c\u3002","title":"\u521b\u5efa VPC \u7f51\u5173\u5e76\u914d\u7f6e\u9ed8\u8ba4\u8def\u7531"},{"location":"guide/vpc/#eip","text":"EIP \u4e3a\u5916\u90e8\u7f51\u7edc\u6bb5\u7684\u67d0\u4e2a IP \u5206\u914d\u7ed9 VPC \u7f51\u5173\u540e\u53ef\u8fdb\u884c\u6d6e\u52a8IP\uff0cSNAT \u548c DNAT \u64cd\u4f5c\u3002 \u968f\u673a\u5206\u914d\u4e00\u4e2a\u5730\u5740\u7ed9 EIP\uff1a kind: IptablesEIP apiVersion: kubeovn.io/v1 metadata: name: eip-random spec: natGwDp: gw1 \u56fa\u5b9a EIP \u5730\u5740\u5206\u914d\uff1a kind: IptablesEIP apiVersion: kubeovn.io/v1 metadata: name: eip-static spec: natGwDp: gw1 v4ip: 10.0.1.111","title":"\u521b\u5efa EIP"},{"location":"guide/vpc/#dnat","text":"kind: IptablesEIP apiVersion: kubeovn.io/v1 metadata: name: eipd01 spec: natGwDp: gw1 --- kind: IptablesDnatRule apiVersion: kubeovn.io/v1 metadata: name: dnat01 spec: eip: eipd01 externalPort: '8888' internalIp: 10.0.1.10 internalPort: '80' protocol: tcp","title":"\u521b\u5efa DNAT \u89c4\u5219"},{"location":"guide/vpc/#snat","text":"--- kind: IptablesEIP apiVersion: kubeovn.io/v1 metadata: name: eips01 spec: natGwDp: gw1 --- kind: IptablesSnatRule apiVersion: kubeovn.io/v1 metadata: name: snat01 spec eip: eips01 internalCIDR: 10.0.1.0/24","title":"\u521b\u5efa SNAT \u89c4\u5219"},{"location":"guide/vpc/#ip","text":"--- kind: IptablesEIP apiVersion: kubeovn.io/v1 metadata: name: eipf01 spec: natGwDp: gw1 --- kind: IptablesFIPRule apiVersion: kubeovn.io/v1 metadata: name: fip01 spec: eip: eipf01 internalIp: 10.0.1.5","title":"\u521b\u5efa\u6d6e\u52a8 IP"},{"location":"guide/vpc/#_2","text":"\u5728\u81ea\u5b9a\u4e49 VPC \u5185\uff0c\u7528\u6237\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7f51\u7edc\u5185\u90e8\u7684\u8def\u7531\u89c4\u5219\uff0c\u7ed3\u5408\u7f51\u5173\u5b9e\u73b0\u66f4\u7075\u6d3b\u7684\u8f6c\u53d1\u3002 Kube-OVN \u652f\u6301\u9759\u6001\u8def\u7531\u548c\u66f4\u4e3a\u7075\u6d3b\u7684\u7b56\u7565\u8def\u7531\u3002","title":"\u81ea\u5b9a\u4e49\u8def\u7531"},{"location":"guide/vpc/#_3","text":"kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: test-vpc-1 spec: staticRoutes: - cidr: 0.0.0.0/0 nextHopIP: 10.0.1.254 policy: policyDst - cidr: 172.31.0.0/24 nextHopIP: 10.0.1.253 policy: policySrc policy : \u652f\u6301\u76ee\u7684\u5730\u5740\u8def\u7531 policyDst \u548c\u6e90\u5730\u5740\u8def\u7531 policySrc \u3002 \u5f53\u8def\u7531\u89c4\u5219\u5b58\u5728\u91cd\u53e0\u65f6\uff0cCIDR \u63a9\u7801\u8f83\u957f\u7684\u89c4\u5219\u4f18\u5148\u7ea7\u66f4\u9ad8\uff0c\u82e5\u63a9\u7801\u957f\u5ea6\u76f8\u540c\u5219\u76ee\u7684\u5730\u5740\u8def\u7531\u4f18\u5148\u4e8e\u6e90\u5730\u5740\u8def\u7531\u3002","title":"\u9759\u6001\u8def\u7531"},{"location":"guide/vpc/#_4","text":"\u9488\u5bf9\u9759\u6001\u8def\u7531\u5339\u914d\u7684\u6d41\u91cf\uff0c\u53ef\u901a\u8fc7\u7b56\u7565\u8def\u7531\u8fdb\u884c\u66f4\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\u3002\u7b56\u7565\u8def\u7531\u63d0\u4f9b\u4e86\u66f4\u7cbe\u786e\u7684\u5339\u914d\u89c4\u5219\uff0c\u4f18\u5148\u7ea7\u63a7\u5236 \u548c\u66f4\u591a\u7684\u8f6c\u53d1\u52a8\u4f5c\u3002\u8be5\u529f\u80fd\u4e3a OVN \u5185\u90e8\u903b\u8f91\u8def\u7531\u5668\u7b56\u7565\u529f\u80fd\u7684\u4e00\u4e2a\u5bf9\u5916\u66b4\u9732\uff0c\u66f4\u591a\u4f7f\u7528\u4fe1\u606f\u8bf7\u53c2\u8003 Logical Router Policy \u3002 \u7b80\u5355\u793a\u4f8b\u5982\u4e0b\uff1a kind: Vpc apiVersion: kubeovn.io/v1 metadata: name: test-vpc-1 spec: policyRoutes: - action: drop match: ip4.src==10.0.1.0/24 && ip4.dst==10.0.1.250 priority: 11 - action: reroute match: ip4.src==10.0.1.0/24 nextHopIP: 10.0.1.252 priority: 10","title":"\u7b56\u7565\u8def\u7531"},{"location":"guide/webhook/","text":"Webhook \u4f7f\u7528 \u4f7f\u7528 Webhook \u53ef\u4ee5\u5bf9 Kube-OVN \u5185\u7684 CRD \u8d44\u6e90\u8fdb\u884c\u6821\u9a8c\uff0c\u76ee\u524d Webhook \u4e3b\u8981\u5b8c\u6210 \u56fa\u5b9a IP \u5730\u5740\u51b2\u7a81\u68c0\u6d4b\u548c Subnet CIDR \u7684\u51b2\u7a81\u68c0\u6d4b\uff0c\u5e76\u5728\u8fd9\u7c7b\u8d44\u6e90\u521b\u5efa\u51b2\u7a81\u65f6\u63d0\u793a\u9519\u8bef\u3002 \u7531\u4e8e Webhook \u4f1a\u62e6\u622a\u6240\u6709\u7684 Subnet \u548c Pod \u521b\u5efa\u7684\u8bf7\u6c42\uff0c\u56e0\u6b64\u9700\u8981\u5148\u90e8\u7f72 Kube-OVN \u540e\u90e8\u7f72 Webhook \u907f\u514d\u65e0\u6cd5\u521b\u5efa Pod\u3002 Cert-Manager \u5b89\u88c5 Webhook \u90e8\u7f72\u9700\u8981\u76f8\u5173\u8bc1\u4e66\u52a0\u5bc6\uff0c\u6211\u4eec\u4f7f\u7528 cert-manager \u751f\u6210\u76f8\u5173\u8bc1\u4e66\uff0c\u6211\u4eec\u9700\u8981\u5728\u90e8\u7f72 Webhook \u524d\u5148\u90e8\u7f72 cert-manager\u3002 \u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u90e8\u7f72 cert-manager kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.8.0/cert-manager.yaml \u66f4\u591a cert-manager \u4f7f\u7528\u8bf7\u53c2\u8003 cert-manager \u6587\u6863 \u3002 \u5b89\u88c5 Webhook \u4e0b\u8f7d Webhook \u5bf9\u5e94\u7684 yaml \u8fdb\u884c\u5b89\u88c5 # kubectl apply -f https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/yamls/webhook.yaml deployment.apps/kube-ovn-webhook created service/kube-ovn-webhook created validatingwebhookconfiguration.admissionregistration.k8s.io/kube-ovn-webhook created certificate.cert-manager.io/kube-ovn-webhook-serving-cert created issuer.cert-manager.io/kube-ovn-webhook-selfsigned-issuer created \u9a8c\u8bc1 Webhook \u751f\u6548 \u67e5\u770b\u5df2\u8fd0\u884c Pod\uff0c\u5f97\u5230 Pod IP 10.16.0.15 \uff1a # kubectl get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES static-7584848b74-fw9dm 1/1 Running 0 2d13h 10.16.0.15 kube-ovn-worker <none> \u7f16\u5199 yaml \u521b\u5efa\u76f8\u540c IP \u7684 Pod\uff1a apiVersion: v1 kind: Pod metadata: annotations: ovn.kubernetes.io/ip_address: 10.16.0.15 ovn.kubernetes.io/mac_address: 00:00:00:53:6B:B6 labels: app: static managedFields: name: staticip-pod namespace: default spec: containers: - image: qaimages:helloworld imagePullPolicy: IfNotPresent name: qatest \u4f7f\u7528\u4ee5\u4e0a yaml \u521b\u5efa\u9759\u6001\u5730\u5740 Pod \u7684\u65f6\u5019\uff0c\u63d0\u793a IP \u5730\u5740\u51b2\u7a81\uff1a # kubectl apply -f pod-static.yaml Error from server (annotation ip address 10.16.0.15 is conflict with ip crd static-7584848b74-fw9dm.default 10.16.0.15): error when creating \"pod-static.yaml\": admission webhook \"pod-ip-validaing.kube-ovn.io\" denied the request: annotation ip address 10.16.0.15 is conflict with ip crd static-7584848b74-fw9dm.default 10.16.0.15","title":"Webhook \u4f7f\u7528"},{"location":"guide/webhook/#webhook","text":"\u4f7f\u7528 Webhook \u53ef\u4ee5\u5bf9 Kube-OVN \u5185\u7684 CRD \u8d44\u6e90\u8fdb\u884c\u6821\u9a8c\uff0c\u76ee\u524d Webhook \u4e3b\u8981\u5b8c\u6210 \u56fa\u5b9a IP \u5730\u5740\u51b2\u7a81\u68c0\u6d4b\u548c Subnet CIDR \u7684\u51b2\u7a81\u68c0\u6d4b\uff0c\u5e76\u5728\u8fd9\u7c7b\u8d44\u6e90\u521b\u5efa\u51b2\u7a81\u65f6\u63d0\u793a\u9519\u8bef\u3002 \u7531\u4e8e Webhook \u4f1a\u62e6\u622a\u6240\u6709\u7684 Subnet \u548c Pod \u521b\u5efa\u7684\u8bf7\u6c42\uff0c\u56e0\u6b64\u9700\u8981\u5148\u90e8\u7f72 Kube-OVN \u540e\u90e8\u7f72 Webhook \u907f\u514d\u65e0\u6cd5\u521b\u5efa Pod\u3002","title":"Webhook \u4f7f\u7528"},{"location":"guide/webhook/#cert-manager","text":"Webhook \u90e8\u7f72\u9700\u8981\u76f8\u5173\u8bc1\u4e66\u52a0\u5bc6\uff0c\u6211\u4eec\u4f7f\u7528 cert-manager \u751f\u6210\u76f8\u5173\u8bc1\u4e66\uff0c\u6211\u4eec\u9700\u8981\u5728\u90e8\u7f72 Webhook \u524d\u5148\u90e8\u7f72 cert-manager\u3002 \u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u90e8\u7f72 cert-manager kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.8.0/cert-manager.yaml \u66f4\u591a cert-manager \u4f7f\u7528\u8bf7\u53c2\u8003 cert-manager \u6587\u6863 \u3002","title":"Cert-Manager \u5b89\u88c5"},{"location":"guide/webhook/#webhook_1","text":"\u4e0b\u8f7d Webhook \u5bf9\u5e94\u7684 yaml \u8fdb\u884c\u5b89\u88c5 # kubectl apply -f https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/yamls/webhook.yaml deployment.apps/kube-ovn-webhook created service/kube-ovn-webhook created validatingwebhookconfiguration.admissionregistration.k8s.io/kube-ovn-webhook created certificate.cert-manager.io/kube-ovn-webhook-serving-cert created issuer.cert-manager.io/kube-ovn-webhook-selfsigned-issuer created","title":"\u5b89\u88c5 Webhook"},{"location":"guide/webhook/#webhook_2","text":"\u67e5\u770b\u5df2\u8fd0\u884c Pod\uff0c\u5f97\u5230 Pod IP 10.16.0.15 \uff1a # kubectl get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES static-7584848b74-fw9dm 1/1 Running 0 2d13h 10.16.0.15 kube-ovn-worker <none> \u7f16\u5199 yaml \u521b\u5efa\u76f8\u540c IP \u7684 Pod\uff1a apiVersion: v1 kind: Pod metadata: annotations: ovn.kubernetes.io/ip_address: 10.16.0.15 ovn.kubernetes.io/mac_address: 00:00:00:53:6B:B6 labels: app: static managedFields: name: staticip-pod namespace: default spec: containers: - image: qaimages:helloworld imagePullPolicy: IfNotPresent name: qatest \u4f7f\u7528\u4ee5\u4e0a yaml \u521b\u5efa\u9759\u6001\u5730\u5740 Pod \u7684\u65f6\u5019\uff0c\u63d0\u793a IP \u5730\u5740\u51b2\u7a81\uff1a # kubectl apply -f pod-static.yaml Error from server (annotation ip address 10.16.0.15 is conflict with ip crd static-7584848b74-fw9dm.default 10.16.0.15): error when creating \"pod-static.yaml\": admission webhook \"pod-ip-validaing.kube-ovn.io\" denied the request: annotation ip address 10.16.0.15 is conflict with ip crd static-7584848b74-fw9dm.default 10.16.0.15","title":"\u9a8c\u8bc1 Webhook \u751f\u6548"},{"location":"ops/change-default-subnet/","text":"\u4fee\u6539\u5b50\u7f51 CIDR \u82e5\u53d1\u73b0\u521b\u5efa\u7684\u5b50\u7f51 CIDR \u51b2\u7a81\u6216\u4e0d\u7b26\u5408\u9884\u671f\uff0c\u53ef\u4ee5\u901a\u8fc7\u672c\u6587\u6863\u8fdb\u884c\u4fee\u6539\u3002 \u4fee\u6539\u5b50\u7f51 CIDR \u540e\u4e4b\u524d\u521b\u5efa\u7684 Pod \u5c06\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\u7f51\u7edc\u9700\u8981\u8fdb\u884c\u91cd\u5efa\u3002 \u5efa\u8bae\u64cd\u4f5c\u524d\u614e\u91cd\u8003\u8651\u3002\u672c\u6587\u53ea\u9488\u5bf9\u4e1a\u52a1\u5b50\u7f51 CIDR \u66f4\u6539\u8fdb\u884c\u64cd\u4f5c\uff0c\u5982\u9700 \u66f4\u6539 Join \u5b50\u7f51 CIDR \u8bf7\u53c2\u8003 \u66f4\u6539 Join \u5b50\u7f51 CIDR \u7f16\u8f91\u5b50\u7f51 \u4f7f\u7528 kubectl edit \u4fee\u6539\u5b50\u7f51 cidrBlock \uff0c gateway \u548c excludeIps kubectl edit subnet test-subnet \u91cd\u5efa\u8be5\u5b50\u7f51\u7ed1\u5b9a\u7684 Namespace \u4e0b\u6240\u6709 Pod \u4ee5\u5b50\u7f51\u7ed1\u5b9a test Namespace \u4e3a\u4f8b\uff1a for pod in $(kubectl get pod --no-headers -n \"$ns\" --field-selector spec.restartPolicy=Always -o custom-columns=NAME:.metadata.name,HOST:spec.hostNetwork | awk '{if ($2!=\"true\") print $1}'); do kubectl delete pod \"$pod\" -n test --ignore-not-found done \u82e5\u53ea\u4f7f\u7528\u4e86\u9ed8\u8ba4\u5b50\u7f51\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u5217\u547d\u4ee4\u5220\u9664\u6240\u6709\u975e host \u7f51\u7edc\u6a21\u5f0f\u7684 Pod\uff1a for ns in $(kubectl get ns --no-headers -o custom-columns=NAME:.metadata.name); do for pod in $(kubectl get pod --no-headers -n \"$ns\" --field-selector spec.restartPolicy=Always -o custom-columns=NAME:.metadata.name,HOST:spec.hostNetwork | awk '{if ($2!=\"true\") print $1}'); do kubectl delete pod \"$pod\" -n \"$ns\" --ignore-not-found done done \u66f4\u6539\u9ed8\u8ba4\u5b50\u7f51\u914d\u7f6e \u82e5\u4fee\u6539\u7684\u4e3a\u9ed8\u8ba4\u5b50\u7f51\u7684 CIDR \u8fd8\u9700\u8981\u66f4\u6539 kube-ovn-controller Deployment \u7684\u542f\u52a8\u53c2\u6570\uff1a args: - --default-cidr=10.17.0.0/16 - --default-gateway=10.17.0.1 - --default-exclude-ips=10.17.0.1","title":"\u4fee\u6539\u5b50\u7f51 CIDR"},{"location":"ops/change-default-subnet/#cidr","text":"\u82e5\u53d1\u73b0\u521b\u5efa\u7684\u5b50\u7f51 CIDR \u51b2\u7a81\u6216\u4e0d\u7b26\u5408\u9884\u671f\uff0c\u53ef\u4ee5\u901a\u8fc7\u672c\u6587\u6863\u8fdb\u884c\u4fee\u6539\u3002 \u4fee\u6539\u5b50\u7f51 CIDR \u540e\u4e4b\u524d\u521b\u5efa\u7684 Pod \u5c06\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\u7f51\u7edc\u9700\u8981\u8fdb\u884c\u91cd\u5efa\u3002 \u5efa\u8bae\u64cd\u4f5c\u524d\u614e\u91cd\u8003\u8651\u3002\u672c\u6587\u53ea\u9488\u5bf9\u4e1a\u52a1\u5b50\u7f51 CIDR \u66f4\u6539\u8fdb\u884c\u64cd\u4f5c\uff0c\u5982\u9700 \u66f4\u6539 Join \u5b50\u7f51 CIDR \u8bf7\u53c2\u8003 \u66f4\u6539 Join \u5b50\u7f51 CIDR","title":"\u4fee\u6539\u5b50\u7f51 CIDR"},{"location":"ops/change-default-subnet/#_1","text":"\u4f7f\u7528 kubectl edit \u4fee\u6539\u5b50\u7f51 cidrBlock \uff0c gateway \u548c excludeIps kubectl edit subnet test-subnet","title":"\u7f16\u8f91\u5b50\u7f51"},{"location":"ops/change-default-subnet/#namespace-pod","text":"\u4ee5\u5b50\u7f51\u7ed1\u5b9a test Namespace \u4e3a\u4f8b\uff1a for pod in $(kubectl get pod --no-headers -n \"$ns\" --field-selector spec.restartPolicy=Always -o custom-columns=NAME:.metadata.name,HOST:spec.hostNetwork | awk '{if ($2!=\"true\") print $1}'); do kubectl delete pod \"$pod\" -n test --ignore-not-found done \u82e5\u53ea\u4f7f\u7528\u4e86\u9ed8\u8ba4\u5b50\u7f51\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u5217\u547d\u4ee4\u5220\u9664\u6240\u6709\u975e host \u7f51\u7edc\u6a21\u5f0f\u7684 Pod\uff1a for ns in $(kubectl get ns --no-headers -o custom-columns=NAME:.metadata.name); do for pod in $(kubectl get pod --no-headers -n \"$ns\" --field-selector spec.restartPolicy=Always -o custom-columns=NAME:.metadata.name,HOST:spec.hostNetwork | awk '{if ($2!=\"true\") print $1}'); do kubectl delete pod \"$pod\" -n \"$ns\" --ignore-not-found done done","title":"\u91cd\u5efa\u8be5\u5b50\u7f51\u7ed1\u5b9a\u7684 Namespace \u4e0b\u6240\u6709 Pod"},{"location":"ops/change-default-subnet/#_2","text":"\u82e5\u4fee\u6539\u7684\u4e3a\u9ed8\u8ba4\u5b50\u7f51\u7684 CIDR \u8fd8\u9700\u8981\u66f4\u6539 kube-ovn-controller Deployment \u7684\u542f\u52a8\u53c2\u6570\uff1a args: - --default-cidr=10.17.0.0/16 - --default-gateway=10.17.0.1 - --default-exclude-ips=10.17.0.1","title":"\u66f4\u6539\u9ed8\u8ba4\u5b50\u7f51\u914d\u7f6e"},{"location":"ops/change-join-subnet/","text":"\u4fee\u6539 Join \u5b50\u7f51 CIDR \u82e5\u53d1\u73b0\u521b\u5efa\u7684 Join \u5b50\u7f51 CIDR \u51b2\u7a81\u6216\u4e0d\u7b26\u5408\u9884\u671f\uff0c\u53ef\u4ee5\u901a\u8fc7\u672c\u6587\u6863\u8fdb\u884c\u4fee\u6539\u3002 \u4fee\u6539 Join \u5b50\u7f51 CIDR \u540e\u4e4b\u524d\u521b\u5efa\u7684 Pod \u5c06\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\uff0c\u9700\u8981\u7b49\u91cd\u5efa\u5b8c\u6210, \u5efa\u8bae\u524d\u64cd\u4f5c\u65f6\u614e\u91cd\u8003\u8651\u3002 \u5220\u9664 Join \u5b50\u7f51 kubectl patch subnet join --type='json' -p '[{\"op\": \"replace\", \"path\": \"/metadata/finalizers\", \"value\": []}]' kubectl delete subnet join \u6e05\u7406\u76f8\u5173\u5206\u914d\u4fe1\u606f kubectl annotate node ovn.kubernetes.io/allocated=false --all --overwrite \u4fee\u6539 Join \u5b50\u7f51\u76f8\u5173\u4fe1\u606f \u4fee\u6539 kube-ovn-controller \u5185 Join \u5b50\u7f51\u76f8\u5173\u4fe1\u606f\uff1a kubectl edit deployment -n kube-system kube-ovn-controller \u4fee\u6539\u4e0b\u5217\u53c2\u6570 args: - --node-switch-cidr=100.51.0.0/16 \u91cd\u542f kube-ovn-controller \u91cd\u5efa join \u5b50\u7f51\uff1a kubectl delete pod -n kube-system -lapp=kube-ovn-controller \u67e5\u770b\u65b0\u7684 Join \u5b50\u7f51\u4fe1\u606f\uff1a # kubectl get subnet NAME PROVIDER VPC PROTOCOL CIDR PRIVATE NAT DEFAULT GATEWAYTYPE V4USED V4AVAILABLE V6USED V6AVAILABLE EXCLUDEIPS join ovn ovn-cluster IPv4 100.51.0.0/16 false false false distributed 2 65531 0 0 [\"100.51.0.1\"] ovn-default ovn ovn-cluster IPv4 10.17.0.0/16 false true true distributed 5 65528 0 0 [\"10.17.0.1\"] \u91cd\u65b0\u914d\u7f6e ovn0 \u7f51\u5361\u5730\u5740 \u6bcf\u4e2a\u8282\u70b9\u7684 ovn0 \u7f51\u5361\u4fe1\u606f\u9700\u8981\u91cd\u65b0\u66f4\u65b0\uff0c\u53ef\u901a\u8fc7\u91cd\u542f kube-ovn-cni \u6765\u5b8c\u6210\uff1a kubectl delete pod -n kube-system -l app=kube-ovn-cni","title":"\u4fee\u6539 Join \u5b50\u7f51 CIDR"},{"location":"ops/change-join-subnet/#join-cidr","text":"\u82e5\u53d1\u73b0\u521b\u5efa\u7684 Join \u5b50\u7f51 CIDR \u51b2\u7a81\u6216\u4e0d\u7b26\u5408\u9884\u671f\uff0c\u53ef\u4ee5\u901a\u8fc7\u672c\u6587\u6863\u8fdb\u884c\u4fee\u6539\u3002 \u4fee\u6539 Join \u5b50\u7f51 CIDR \u540e\u4e4b\u524d\u521b\u5efa\u7684 Pod \u5c06\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\uff0c\u9700\u8981\u7b49\u91cd\u5efa\u5b8c\u6210, \u5efa\u8bae\u524d\u64cd\u4f5c\u65f6\u614e\u91cd\u8003\u8651\u3002","title":"\u4fee\u6539 Join \u5b50\u7f51 CIDR"},{"location":"ops/change-join-subnet/#join","text":"kubectl patch subnet join --type='json' -p '[{\"op\": \"replace\", \"path\": \"/metadata/finalizers\", \"value\": []}]' kubectl delete subnet join","title":"\u5220\u9664 Join \u5b50\u7f51"},{"location":"ops/change-join-subnet/#_1","text":"kubectl annotate node ovn.kubernetes.io/allocated=false --all --overwrite","title":"\u6e05\u7406\u76f8\u5173\u5206\u914d\u4fe1\u606f"},{"location":"ops/change-join-subnet/#join_1","text":"\u4fee\u6539 kube-ovn-controller \u5185 Join \u5b50\u7f51\u76f8\u5173\u4fe1\u606f\uff1a kubectl edit deployment -n kube-system kube-ovn-controller \u4fee\u6539\u4e0b\u5217\u53c2\u6570 args: - --node-switch-cidr=100.51.0.0/16 \u91cd\u542f kube-ovn-controller \u91cd\u5efa join \u5b50\u7f51\uff1a kubectl delete pod -n kube-system -lapp=kube-ovn-controller \u67e5\u770b\u65b0\u7684 Join \u5b50\u7f51\u4fe1\u606f\uff1a # kubectl get subnet NAME PROVIDER VPC PROTOCOL CIDR PRIVATE NAT DEFAULT GATEWAYTYPE V4USED V4AVAILABLE V6USED V6AVAILABLE EXCLUDEIPS join ovn ovn-cluster IPv4 100.51.0.0/16 false false false distributed 2 65531 0 0 [\"100.51.0.1\"] ovn-default ovn ovn-cluster IPv4 10.17.0.0/16 false true true distributed 5 65528 0 0 [\"10.17.0.1\"]","title":"\u4fee\u6539 Join \u5b50\u7f51\u76f8\u5173\u4fe1\u606f"},{"location":"ops/change-join-subnet/#ovn0","text":"\u6bcf\u4e2a\u8282\u70b9\u7684 ovn0 \u7f51\u5361\u4fe1\u606f\u9700\u8981\u91cd\u65b0\u66f4\u65b0\uff0c\u53ef\u901a\u8fc7\u91cd\u542f kube-ovn-cni \u6765\u5b8c\u6210\uff1a kubectl delete pod -n kube-system -l app=kube-ovn-cni","title":"\u91cd\u65b0\u914d\u7f6e ovn0 \u7f51\u5361\u5730\u5740"},{"location":"ops/change-ovn-central-node/","text":"\u66f4\u6362 ovn-central \u8282\u70b9 \u7531\u4e8e ovn-central \u5185\u7684 ovn-nb \u548c ovn-sb \u5206\u522b\u5efa\u7acb\u4e86\u7c7b\u4f3c etcd \u7684 raft \u96c6\u7fa4\uff0c\u56e0\u6b64\u66f4\u6362 ovn-central \u8282\u70b9\u9700\u8981\u989d\u5916\u7684\u64cd\u4f5c\uff0c\u4fdd\u8bc1\u96c6\u7fa4\u72b6\u6001\u7684\u6b63\u786e\u548c\u6570\u636e\u7684\u4e00\u81f4\u3002\u5efa\u8bae\u6bcf\u6b21\u53ea\u5bf9\u4e00\u4e2a\u8282\u70b9\u8fdb\u884c\u4e0a\u4e0b\u7ebf\u5904\u7406\uff0c\u4ee5\u907f\u514d\u96c6\u7fa4\u8fdb\u5165\u4e0d\u53ef\u7528 \u72b6\u6001\uff0c\u5f71\u54cd\u96c6\u7fa4\u6574\u4f53\u7f51\u7edc\u3002 ovn-central \u8282\u70b9\u4e0b\u7ebf \u672c\u6587\u6863\u9488\u5bf9\u5982\u4e0b\u7684\u96c6\u7fa4\u60c5\u51b5\uff0c\u4ee5\u4e0b\u7ebf kube-ovn-control-plane2 \u8282\u70b9\u4e3a\u4f8b\uff0c\u4ecb\u7ecd\u5982\u4f55\u5c06\u5176\u4ece ovn-central \u96c6\u7fa4\u4e2d\u79fb\u9664\u3002 # kubectl -n kube-system get pod -o wide | grep central ovn-central-6bf58cbc97-2cdhg 1/1 Running 0 21m 172.18.0.3 kube-ovn-control-plane <none> <none> ovn-central-6bf58cbc97-crmfp 1/1 Running 0 21m 172.18.0.5 kube-ovn-control-plane2 <none> <none> ovn-central-6bf58cbc97-lxmpl 1/1 Running 0 21m 172.18.0.4 kube-ovn-control-plane3 <none> <none> \u4e0b\u7ebf ovn-nb \u96c6\u7fa4\u5185\u5bf9\u5e94\u8282\u70b9 \u9996\u5148\u67e5\u770b\u8282\u70b9\u5728\u96c6\u7fa4\u5185\u7684 ID\uff0c\u4ee5\u4fbf\u540e\u7eed\u64cd\u4f5c\u3002 # kubectl ko nb status 1b9a Name: OVN_Northbound Cluster ID: 32ca (32ca07fb-739b-4257-b510-12fa18e7cce8) Server ID: 1b9a (1b9a5d76-e69b-410c-8085-39943d0cd38c) Address: tcp:[172.18.0.3]:6643 Status: cluster member Role: leader Term: 1 Leader: self Vote: self Last Election started 2135194 ms ago, reason: timeout Last Election won: 2135188 ms ago Election timer: 5000 Log: [135, 135] Entries not yet committed: 0 Entries not yet applied: 0 Connections: <-d64b ->d64b <-4984 ->4984 Disconnections: 0 Servers: 4984 (4984 at tcp:[172.18.0.4]:6643) next_index=135 match_index=134 last msg 1084 ms ago 1b9a (1b9a at tcp:[172.18.0.3]:6643) (self) next_index=2 match_index=134 d64b (d64b at tcp:[172.18.0.5]:6643) next_index=135 match_index=134 last msg 1084 ms ago status: ok kube-ovn-control-plane2 \u5bf9\u5e94\u8282\u70b9 IP \u4e3a 172.18.0.5 \uff0c\u96c6\u7fa4\u5185\u5bf9\u5e94\u7684 ID \u4e3a d64b \u3002\u63a5\u4e0b\u6765\u4ece ovn-nb \u96c6\u7fa4\u4e2d\u8e22\u51fa\u8be5\u8282\u70b9\uff1a # kubectl ko nb kick d64b started removal \u786e\u8ba4\u8282\u70b9\u8e22\u51fa\u6210\u529f\uff1a # kubectl ko nb status 1b9a Name: OVN_Northbound Cluster ID: 32ca (32ca07fb-739b-4257-b510-12fa18e7cce8) Server ID: 1b9a (1b9a5d76-e69b-410c-8085-39943d0cd38c) Address: tcp:[172.18.0.3]:6643 Status: cluster member Role: leader Term: 1 Leader: self Vote: self Last Election started 2297649 ms ago, reason: timeout Last Election won: 2297643 ms ago Election timer: 5000 Log: [136, 136] Entries not yet committed: 0 Entries not yet applied: 0 Connections: <-4984 ->4984 Disconnections: 2 Servers: 4984 (4984 at tcp:[172.18.0.4]:6643) next_index=136 match_index=135 last msg 1270 ms ago 1b9a (1b9a at tcp:[172.18.0.3]:6643) (self) next_index=2 match_index=135 status: ok \u4e0b\u7ebf ovn-sb \u96c6\u7fa4\u5185\u5bf9\u5e94\u8282\u70b9 \u63a5\u4e0b\u6765\u9700\u8981\u5bf9 ovn-sb \u96c6\u7fa4\uff0c\u9996\u5148\u67e5\u770b\u8282\u70b9\u5728\u96c6\u7fa4\u5185\u7684 ID\uff0c\u4ee5\u4fbf\u540e\u7eed\u64cd\u4f5c\uff1a kubectl ko sb status 3722 Name: OVN_Southbound Cluster ID: d4bd (d4bd37a4-0400-499f-b4df-b4fd389780f0) Server ID: 3722 (3722d5ae-2ced-4820-a6b2-8b744d11fb3e) Address: tcp:[172.18.0.3]:6644 Status: cluster member Role: leader Term: 1 Leader: self Vote: self Last Election started 2395317 ms ago, reason: timeout Last Election won: 2395316 ms ago Election timer: 5000 Log: [130, 130] Entries not yet committed: 0 Entries not yet applied: 0 Connections: <-e9f7 ->e9f7 <-6e84 ->6e84 Disconnections: 0 Servers: e9f7 (e9f7 at tcp:[172.18.0.5]:6644) next_index=130 match_index=129 last msg 1006 ms ago 6e84 (6e84 at tcp:[172.18.0.4]:6644) next_index=130 match_index=129 last msg 1004 ms ago 3722 (3722 at tcp:[172.18.0.3]:6644) (self) next_index=2 match_index=129 status: ok kube-ovn-control-plane2 \u5bf9\u5e94\u8282\u70b9 IP \u4e3a 172.18.0.5 \uff0c\u96c6\u7fa4\u5185\u5bf9\u5e94\u7684 ID \u4e3a e9f7 \u3002\u63a5\u4e0b\u6765\u4ece ovn-sb \u96c6\u7fa4\u4e2d\u8e22\u51fa\u8be5\u8282\u70b9\uff1a # kubectl ko sb kick e9f7 started removal \u786e\u8ba4\u8282\u70b9\u8e22\u51fa\u6210\u529f\uff1a # kubectl ko sb status 3722 Name: OVN_Southbound Cluster ID: d4bd (d4bd37a4-0400-499f-b4df-b4fd389780f0) Server ID: 3722 (3722d5ae-2ced-4820-a6b2-8b744d11fb3e) Address: tcp:[172.18.0.3]:6644 Status: cluster member Role: leader Term: 1 Leader: self Vote: self Last Election started 2481636 ms ago, reason: timeout Last Election won: 2481635 ms ago Election timer: 5000 Log: [131, 131] Entries not yet committed: 0 Entries not yet applied: 0 Connections: <-6e84 ->6e84 Disconnections: 2 Servers: 6e84 (6e84 at tcp:[172.18.0.4]:6644) next_index=131 match_index=130 last msg 642 ms ago 3722 (3722 at tcp:[172.18.0.3]:6644) (self) next_index=2 match_index=130 status: ok \u5220\u9664\u8282\u70b9\u6807\u7b7e\uff0c\u5e76\u7f29\u5bb9 ovn-central \u6ce8\u610f\u9700\u5728 ovn-central \u73af\u5883\u53d8\u91cf NODE_IPS \u7684\u8282\u70b9\u5730\u5740\u4e2d\u5220\u9664\u4e0b\u7ebf\u8282\u70b9\u3002 kubectl label node kube-ovn-control-plane2 kube-ovn/role- kubectl scale deployment -n kube-system ovn-central --replicas=2 kubectl set env deployment/ovn-central -n kube-system NODE_IPS=\"172.18.0.3,172.18.0.4\" kubectl rollout status deployment/ovn-central -n kube-system \u4fee\u6539\u5176\u4ed6\u7ec4\u4ef6\u8fde\u63a5 ovn-central \u5730\u5740 \u4fee\u6539 ovs-ovn \u5185\u8fde\u63a5\u4fe1\u606f\uff0c\u5220\u9664\u4e0b\u7ebf\u8282\u70b9\u5730\u5740\u3002 # kubectl set env daemonset/ovs-ovn -n kube-system OVN_DB_IPS=\"172.18.0.3,172.18.0.4\" daemonset.apps/ovs-ovn env updated # kubectl delete pod -n kube-system -lapp=ovs pod \"ovs-ovn-4f6jc\" deleted pod \"ovs-ovn-csn2w\" deleted pod \"ovs-ovn-mpbmb\" deleted \u4fee\u6539 kube-ovn-controller \u5185\u8fde\u63a5\u4fe1\u606f\uff0c\u5220\u9664\u4e0b\u7ebf\u8282\u70b9\u5730\u5740\u3002 # kubectl set env deployment/kube-ovn-controller -n kube-system OVN_DB_IPS=\"172.18.0.3,172.18.0.4\" deployment.apps/kube-ovn-controller env updated # kubectl rollout status deployment/kube-ovn-controller -n kube-system Waiting for deployment \"kube-ovn-controller\" rollout to finish: 1 of 3 updated replicas are available... Waiting for deployment \"kube-ovn-controller\" rollout to finish: 2 of 3 updated replicas are available... deployment \"kube-ovn-controller\" successfully rolled out \u6e05\u7406\u8282\u70b9 \u5220\u9664 kube-ovn-control-plane2 \u8282\u70b9\u5185\u7684\u6570\u636e\u5e93\u6587\u4ef6\uff0c\u907f\u514d\u91cd\u590d\u6dfb\u52a0\u8282\u70b9\u65f6\u53d1\u751f\u5f02\u5e38 rm -rf /etc/origin/ovn \u5982\u9700\u5c06\u8282\u70b9\u4ece\u6574\u4e2a Kubernetes \u96c6\u7fa4\u4e0b\u7ebf\uff0c\u8fd8\u9700\u7ee7\u7eed\u53c2\u8003 \u5220\u9664\u5de5\u4f5c\u8282\u70b9 \u8fdb\u884c\u64cd\u4f5c\u3002 ovn-central \u8282\u70b9\u4e0a\u7ebf \u4e0b\u5217\u6b65\u9aa4\u4f1a\u5c06\u4e00\u4e2a\u65b0\u7684 Kubernetes \u8282\u70b9\u52a0\u5165 ovn-central \u96c6\u7fa4\u3002 \u76ee\u5f55\u68c0\u67e5 \u68c0\u67e5\u65b0\u589e\u8282\u70b9\u7684 /etc/origin/ovn \u76ee\u5f55\u4e2d\u662f\u5426\u5b58\u5728 ovnnb_db.db \u6216 ovnsb_db.db \u6587\u4ef6\uff0c\u82e5\u5b58\u5728\u9700\u63d0\u524d\u5220\u9664\uff1a rm -rf /etc/origin/ovn \u786e\u8ba4\u5f53\u524d ovn-central \u96c6\u7fa4\u72b6\u6001\u6b63\u5e38 \u82e5\u5f53\u524d ovn-central \u96c6\u7fa4\u72b6\u6001\u5df2\u7ecf\u5f02\u5e38\uff0c\u65b0\u589e\u8282\u70b9\u53ef\u80fd\u5bfc\u81f4\u6295\u7968\u9009\u4e3e\u65e0\u6cd5\u8fc7\u534a\u6570\uff0c\u5f71\u54cd\u540e\u7eed\u64cd\u4f5c\u3002 # kubectl ko nb status 1b9a Name: OVN_Northbound Cluster ID: 32ca (32ca07fb-739b-4257-b510-12fa18e7cce8) Server ID: 1b9a (1b9a5d76-e69b-410c-8085-39943d0cd38c) Address: tcp:[172.18.0.3]:6643 Status: cluster member Role: leader Term: 44 Leader: self Vote: self Last Election started 1855739 ms ago, reason: timeout Last Election won: 1855729 ms ago Election timer: 5000 Log: [147, 147] Entries not yet committed: 0 Entries not yet applied: 0 Connections: ->4984 <-4984 Disconnections: 0 Servers: 4984 (4984 at tcp:[172.18.0.4]:6643) next_index=147 match_index=146 last msg 367 ms ago 1b9a (1b9a at tcp:[172.18.0.3]:6643) (self) next_index=140 match_index=146 status: ok # kubectl ko sb status 3722 Name: OVN_Southbound Cluster ID: d4bd (d4bd37a4-0400-499f-b4df-b4fd389780f0) Server ID: 3722 (3722d5ae-2ced-4820-a6b2-8b744d11fb3e) Address: tcp:[172.18.0.3]:6644 Status: cluster member Role: leader Term: 33 Leader: self Vote: self Last Election started 1868589 ms ago, reason: timeout Last Election won: 1868579 ms ago Election timer: 5000 Log: [142, 142] Entries not yet committed: 0 Entries not yet applied: 0 Connections: ->6e84 <-6e84 Disconnections: 0 Servers: 6e84 (6e84 at tcp:[172.18.0.4]:6644) next_index=142 match_index=141 last msg 728 ms ago 3722 (3722 at tcp:[172.18.0.3]:6644) (self) next_index=134 match_index=141 status: ok \u7ed9\u8282\u70b9\u589e\u52a0\u6807\u7b7e\u5e76\u6269\u5bb9 \u6ce8\u610f\u9700\u5728 ovn-central \u73af\u5883\u53d8\u91cf NODE_IPS \u7684\u8282\u70b9\u5730\u5740\u4e2d\u589e\u52a0\u4e0a\u7ebf\u8282\u70b9\u5730\u5740\u3002 kubectl label node kube-ovn-control-plane2 kube-ovn/role=master kubectl scale deployment -n kube-system ovn-central --replicas=3 kubectl set env deployment/ovn-central -n kube-system NODE_IPS=\"172.18.0.3,172.18.0.4,172.18.0.5\" kubectl rollout status deployment/ovn-central -n kube-system \u4fee\u6539\u5176\u4ed6\u7ec4\u4ef6\u8fde\u63a5 ovn-central \u5730\u5740 \u4fee\u6539 ovs-ovn \u5185\u8fde\u63a5\u4fe1\u606f\uff0c\u589e\u52a0\u4e0a\u7ebf\u8282\u70b9\u5730\u5740\uff1a # kubectl set env daemonset/ovs-ovn -n kube-system OVN_DB_IPS=\"172.18.0.3,172.18.0.4,172.18.0.5\" daemonset.apps/ovs-ovn env updated # kubectl delete pod -n kube-system -lapp=ovs pod \"ovs-ovn-4f6jc\" deleted pod \"ovs-ovn-csn2w\" deleted pod \"ovs-ovn-mpbmb\" deleted \u4fee\u6539 kube-ovn-controller \u5185\u8fde\u63a5\u4fe1\u606f\uff0c\u589e\u52a0\u4e0a\u7ebf\u8282\u70b9\u5730\u5740\uff1a # kubectl set env deployment/kube-ovn-controller -n kube-system OVN_DB_IPS=\"172.18.0.3,172.18.0.4,172.18.0.5\" deployment.apps/kube-ovn-controller env updated # kubectl rollout status deployment/kube-ovn-controller -n kube-system Waiting for deployment \"kube-ovn-controller\" rollout to finish: 1 of 3 updated replicas are available... Waiting for deployment \"kube-ovn-controller\" rollout to finish: 2 of 3 updated replicas are available... deployment \"kube-ovn-controller\" successfully rolled out","title":"\u66f4\u6362 ovn-central \u8282\u70b9"},{"location":"ops/change-ovn-central-node/#ovn-central","text":"\u7531\u4e8e ovn-central \u5185\u7684 ovn-nb \u548c ovn-sb \u5206\u522b\u5efa\u7acb\u4e86\u7c7b\u4f3c etcd \u7684 raft \u96c6\u7fa4\uff0c\u56e0\u6b64\u66f4\u6362 ovn-central \u8282\u70b9\u9700\u8981\u989d\u5916\u7684\u64cd\u4f5c\uff0c\u4fdd\u8bc1\u96c6\u7fa4\u72b6\u6001\u7684\u6b63\u786e\u548c\u6570\u636e\u7684\u4e00\u81f4\u3002\u5efa\u8bae\u6bcf\u6b21\u53ea\u5bf9\u4e00\u4e2a\u8282\u70b9\u8fdb\u884c\u4e0a\u4e0b\u7ebf\u5904\u7406\uff0c\u4ee5\u907f\u514d\u96c6\u7fa4\u8fdb\u5165\u4e0d\u53ef\u7528 \u72b6\u6001\uff0c\u5f71\u54cd\u96c6\u7fa4\u6574\u4f53\u7f51\u7edc\u3002","title":"\u66f4\u6362 ovn-central \u8282\u70b9"},{"location":"ops/change-ovn-central-node/#ovn-central_1","text":"\u672c\u6587\u6863\u9488\u5bf9\u5982\u4e0b\u7684\u96c6\u7fa4\u60c5\u51b5\uff0c\u4ee5\u4e0b\u7ebf kube-ovn-control-plane2 \u8282\u70b9\u4e3a\u4f8b\uff0c\u4ecb\u7ecd\u5982\u4f55\u5c06\u5176\u4ece ovn-central \u96c6\u7fa4\u4e2d\u79fb\u9664\u3002 # kubectl -n kube-system get pod -o wide | grep central ovn-central-6bf58cbc97-2cdhg 1/1 Running 0 21m 172.18.0.3 kube-ovn-control-plane <none> <none> ovn-central-6bf58cbc97-crmfp 1/1 Running 0 21m 172.18.0.5 kube-ovn-control-plane2 <none> <none> ovn-central-6bf58cbc97-lxmpl 1/1 Running 0 21m 172.18.0.4 kube-ovn-control-plane3 <none> <none>","title":"ovn-central \u8282\u70b9\u4e0b\u7ebf"},{"location":"ops/change-ovn-central-node/#ovn-nb","text":"\u9996\u5148\u67e5\u770b\u8282\u70b9\u5728\u96c6\u7fa4\u5185\u7684 ID\uff0c\u4ee5\u4fbf\u540e\u7eed\u64cd\u4f5c\u3002 # kubectl ko nb status 1b9a Name: OVN_Northbound Cluster ID: 32ca (32ca07fb-739b-4257-b510-12fa18e7cce8) Server ID: 1b9a (1b9a5d76-e69b-410c-8085-39943d0cd38c) Address: tcp:[172.18.0.3]:6643 Status: cluster member Role: leader Term: 1 Leader: self Vote: self Last Election started 2135194 ms ago, reason: timeout Last Election won: 2135188 ms ago Election timer: 5000 Log: [135, 135] Entries not yet committed: 0 Entries not yet applied: 0 Connections: <-d64b ->d64b <-4984 ->4984 Disconnections: 0 Servers: 4984 (4984 at tcp:[172.18.0.4]:6643) next_index=135 match_index=134 last msg 1084 ms ago 1b9a (1b9a at tcp:[172.18.0.3]:6643) (self) next_index=2 match_index=134 d64b (d64b at tcp:[172.18.0.5]:6643) next_index=135 match_index=134 last msg 1084 ms ago status: ok kube-ovn-control-plane2 \u5bf9\u5e94\u8282\u70b9 IP \u4e3a 172.18.0.5 \uff0c\u96c6\u7fa4\u5185\u5bf9\u5e94\u7684 ID \u4e3a d64b \u3002\u63a5\u4e0b\u6765\u4ece ovn-nb \u96c6\u7fa4\u4e2d\u8e22\u51fa\u8be5\u8282\u70b9\uff1a # kubectl ko nb kick d64b started removal \u786e\u8ba4\u8282\u70b9\u8e22\u51fa\u6210\u529f\uff1a # kubectl ko nb status 1b9a Name: OVN_Northbound Cluster ID: 32ca (32ca07fb-739b-4257-b510-12fa18e7cce8) Server ID: 1b9a (1b9a5d76-e69b-410c-8085-39943d0cd38c) Address: tcp:[172.18.0.3]:6643 Status: cluster member Role: leader Term: 1 Leader: self Vote: self Last Election started 2297649 ms ago, reason: timeout Last Election won: 2297643 ms ago Election timer: 5000 Log: [136, 136] Entries not yet committed: 0 Entries not yet applied: 0 Connections: <-4984 ->4984 Disconnections: 2 Servers: 4984 (4984 at tcp:[172.18.0.4]:6643) next_index=136 match_index=135 last msg 1270 ms ago 1b9a (1b9a at tcp:[172.18.0.3]:6643) (self) next_index=2 match_index=135 status: ok","title":"\u4e0b\u7ebf ovn-nb \u96c6\u7fa4\u5185\u5bf9\u5e94\u8282\u70b9"},{"location":"ops/change-ovn-central-node/#ovn-sb","text":"\u63a5\u4e0b\u6765\u9700\u8981\u5bf9 ovn-sb \u96c6\u7fa4\uff0c\u9996\u5148\u67e5\u770b\u8282\u70b9\u5728\u96c6\u7fa4\u5185\u7684 ID\uff0c\u4ee5\u4fbf\u540e\u7eed\u64cd\u4f5c\uff1a kubectl ko sb status 3722 Name: OVN_Southbound Cluster ID: d4bd (d4bd37a4-0400-499f-b4df-b4fd389780f0) Server ID: 3722 (3722d5ae-2ced-4820-a6b2-8b744d11fb3e) Address: tcp:[172.18.0.3]:6644 Status: cluster member Role: leader Term: 1 Leader: self Vote: self Last Election started 2395317 ms ago, reason: timeout Last Election won: 2395316 ms ago Election timer: 5000 Log: [130, 130] Entries not yet committed: 0 Entries not yet applied: 0 Connections: <-e9f7 ->e9f7 <-6e84 ->6e84 Disconnections: 0 Servers: e9f7 (e9f7 at tcp:[172.18.0.5]:6644) next_index=130 match_index=129 last msg 1006 ms ago 6e84 (6e84 at tcp:[172.18.0.4]:6644) next_index=130 match_index=129 last msg 1004 ms ago 3722 (3722 at tcp:[172.18.0.3]:6644) (self) next_index=2 match_index=129 status: ok kube-ovn-control-plane2 \u5bf9\u5e94\u8282\u70b9 IP \u4e3a 172.18.0.5 \uff0c\u96c6\u7fa4\u5185\u5bf9\u5e94\u7684 ID \u4e3a e9f7 \u3002\u63a5\u4e0b\u6765\u4ece ovn-sb \u96c6\u7fa4\u4e2d\u8e22\u51fa\u8be5\u8282\u70b9\uff1a # kubectl ko sb kick e9f7 started removal \u786e\u8ba4\u8282\u70b9\u8e22\u51fa\u6210\u529f\uff1a # kubectl ko sb status 3722 Name: OVN_Southbound Cluster ID: d4bd (d4bd37a4-0400-499f-b4df-b4fd389780f0) Server ID: 3722 (3722d5ae-2ced-4820-a6b2-8b744d11fb3e) Address: tcp:[172.18.0.3]:6644 Status: cluster member Role: leader Term: 1 Leader: self Vote: self Last Election started 2481636 ms ago, reason: timeout Last Election won: 2481635 ms ago Election timer: 5000 Log: [131, 131] Entries not yet committed: 0 Entries not yet applied: 0 Connections: <-6e84 ->6e84 Disconnections: 2 Servers: 6e84 (6e84 at tcp:[172.18.0.4]:6644) next_index=131 match_index=130 last msg 642 ms ago 3722 (3722 at tcp:[172.18.0.3]:6644) (self) next_index=2 match_index=130 status: ok","title":"\u4e0b\u7ebf ovn-sb \u96c6\u7fa4\u5185\u5bf9\u5e94\u8282\u70b9"},{"location":"ops/change-ovn-central-node/#ovn-central_2","text":"\u6ce8\u610f\u9700\u5728 ovn-central \u73af\u5883\u53d8\u91cf NODE_IPS \u7684\u8282\u70b9\u5730\u5740\u4e2d\u5220\u9664\u4e0b\u7ebf\u8282\u70b9\u3002 kubectl label node kube-ovn-control-plane2 kube-ovn/role- kubectl scale deployment -n kube-system ovn-central --replicas=2 kubectl set env deployment/ovn-central -n kube-system NODE_IPS=\"172.18.0.3,172.18.0.4\" kubectl rollout status deployment/ovn-central -n kube-system","title":"\u5220\u9664\u8282\u70b9\u6807\u7b7e\uff0c\u5e76\u7f29\u5bb9 ovn-central"},{"location":"ops/change-ovn-central-node/#ovn-central_3","text":"\u4fee\u6539 ovs-ovn \u5185\u8fde\u63a5\u4fe1\u606f\uff0c\u5220\u9664\u4e0b\u7ebf\u8282\u70b9\u5730\u5740\u3002 # kubectl set env daemonset/ovs-ovn -n kube-system OVN_DB_IPS=\"172.18.0.3,172.18.0.4\" daemonset.apps/ovs-ovn env updated # kubectl delete pod -n kube-system -lapp=ovs pod \"ovs-ovn-4f6jc\" deleted pod \"ovs-ovn-csn2w\" deleted pod \"ovs-ovn-mpbmb\" deleted \u4fee\u6539 kube-ovn-controller \u5185\u8fde\u63a5\u4fe1\u606f\uff0c\u5220\u9664\u4e0b\u7ebf\u8282\u70b9\u5730\u5740\u3002 # kubectl set env deployment/kube-ovn-controller -n kube-system OVN_DB_IPS=\"172.18.0.3,172.18.0.4\" deployment.apps/kube-ovn-controller env updated # kubectl rollout status deployment/kube-ovn-controller -n kube-system Waiting for deployment \"kube-ovn-controller\" rollout to finish: 1 of 3 updated replicas are available... Waiting for deployment \"kube-ovn-controller\" rollout to finish: 2 of 3 updated replicas are available... deployment \"kube-ovn-controller\" successfully rolled out","title":"\u4fee\u6539\u5176\u4ed6\u7ec4\u4ef6\u8fde\u63a5 ovn-central \u5730\u5740"},{"location":"ops/change-ovn-central-node/#_1","text":"\u5220\u9664 kube-ovn-control-plane2 \u8282\u70b9\u5185\u7684\u6570\u636e\u5e93\u6587\u4ef6\uff0c\u907f\u514d\u91cd\u590d\u6dfb\u52a0\u8282\u70b9\u65f6\u53d1\u751f\u5f02\u5e38 rm -rf /etc/origin/ovn \u5982\u9700\u5c06\u8282\u70b9\u4ece\u6574\u4e2a Kubernetes \u96c6\u7fa4\u4e0b\u7ebf\uff0c\u8fd8\u9700\u7ee7\u7eed\u53c2\u8003 \u5220\u9664\u5de5\u4f5c\u8282\u70b9 \u8fdb\u884c\u64cd\u4f5c\u3002","title":"\u6e05\u7406\u8282\u70b9"},{"location":"ops/change-ovn-central-node/#ovn-central_4","text":"\u4e0b\u5217\u6b65\u9aa4\u4f1a\u5c06\u4e00\u4e2a\u65b0\u7684 Kubernetes \u8282\u70b9\u52a0\u5165 ovn-central \u96c6\u7fa4\u3002","title":"ovn-central \u8282\u70b9\u4e0a\u7ebf"},{"location":"ops/change-ovn-central-node/#_2","text":"\u68c0\u67e5\u65b0\u589e\u8282\u70b9\u7684 /etc/origin/ovn \u76ee\u5f55\u4e2d\u662f\u5426\u5b58\u5728 ovnnb_db.db \u6216 ovnsb_db.db \u6587\u4ef6\uff0c\u82e5\u5b58\u5728\u9700\u63d0\u524d\u5220\u9664\uff1a rm -rf /etc/origin/ovn","title":"\u76ee\u5f55\u68c0\u67e5"},{"location":"ops/change-ovn-central-node/#ovn-central_5","text":"\u82e5\u5f53\u524d ovn-central \u96c6\u7fa4\u72b6\u6001\u5df2\u7ecf\u5f02\u5e38\uff0c\u65b0\u589e\u8282\u70b9\u53ef\u80fd\u5bfc\u81f4\u6295\u7968\u9009\u4e3e\u65e0\u6cd5\u8fc7\u534a\u6570\uff0c\u5f71\u54cd\u540e\u7eed\u64cd\u4f5c\u3002 # kubectl ko nb status 1b9a Name: OVN_Northbound Cluster ID: 32ca (32ca07fb-739b-4257-b510-12fa18e7cce8) Server ID: 1b9a (1b9a5d76-e69b-410c-8085-39943d0cd38c) Address: tcp:[172.18.0.3]:6643 Status: cluster member Role: leader Term: 44 Leader: self Vote: self Last Election started 1855739 ms ago, reason: timeout Last Election won: 1855729 ms ago Election timer: 5000 Log: [147, 147] Entries not yet committed: 0 Entries not yet applied: 0 Connections: ->4984 <-4984 Disconnections: 0 Servers: 4984 (4984 at tcp:[172.18.0.4]:6643) next_index=147 match_index=146 last msg 367 ms ago 1b9a (1b9a at tcp:[172.18.0.3]:6643) (self) next_index=140 match_index=146 status: ok # kubectl ko sb status 3722 Name: OVN_Southbound Cluster ID: d4bd (d4bd37a4-0400-499f-b4df-b4fd389780f0) Server ID: 3722 (3722d5ae-2ced-4820-a6b2-8b744d11fb3e) Address: tcp:[172.18.0.3]:6644 Status: cluster member Role: leader Term: 33 Leader: self Vote: self Last Election started 1868589 ms ago, reason: timeout Last Election won: 1868579 ms ago Election timer: 5000 Log: [142, 142] Entries not yet committed: 0 Entries not yet applied: 0 Connections: ->6e84 <-6e84 Disconnections: 0 Servers: 6e84 (6e84 at tcp:[172.18.0.4]:6644) next_index=142 match_index=141 last msg 728 ms ago 3722 (3722 at tcp:[172.18.0.3]:6644) (self) next_index=134 match_index=141 status: ok","title":"\u786e\u8ba4\u5f53\u524d ovn-central \u96c6\u7fa4\u72b6\u6001\u6b63\u5e38"},{"location":"ops/change-ovn-central-node/#_3","text":"\u6ce8\u610f\u9700\u5728 ovn-central \u73af\u5883\u53d8\u91cf NODE_IPS \u7684\u8282\u70b9\u5730\u5740\u4e2d\u589e\u52a0\u4e0a\u7ebf\u8282\u70b9\u5730\u5740\u3002 kubectl label node kube-ovn-control-plane2 kube-ovn/role=master kubectl scale deployment -n kube-system ovn-central --replicas=3 kubectl set env deployment/ovn-central -n kube-system NODE_IPS=\"172.18.0.3,172.18.0.4,172.18.0.5\" kubectl rollout status deployment/ovn-central -n kube-system","title":"\u7ed9\u8282\u70b9\u589e\u52a0\u6807\u7b7e\u5e76\u6269\u5bb9"},{"location":"ops/change-ovn-central-node/#ovn-central_6","text":"\u4fee\u6539 ovs-ovn \u5185\u8fde\u63a5\u4fe1\u606f\uff0c\u589e\u52a0\u4e0a\u7ebf\u8282\u70b9\u5730\u5740\uff1a # kubectl set env daemonset/ovs-ovn -n kube-system OVN_DB_IPS=\"172.18.0.3,172.18.0.4,172.18.0.5\" daemonset.apps/ovs-ovn env updated # kubectl delete pod -n kube-system -lapp=ovs pod \"ovs-ovn-4f6jc\" deleted pod \"ovs-ovn-csn2w\" deleted pod \"ovs-ovn-mpbmb\" deleted \u4fee\u6539 kube-ovn-controller \u5185\u8fde\u63a5\u4fe1\u606f\uff0c\u589e\u52a0\u4e0a\u7ebf\u8282\u70b9\u5730\u5740\uff1a # kubectl set env deployment/kube-ovn-controller -n kube-system OVN_DB_IPS=\"172.18.0.3,172.18.0.4,172.18.0.5\" deployment.apps/kube-ovn-controller env updated # kubectl rollout status deployment/kube-ovn-controller -n kube-system Waiting for deployment \"kube-ovn-controller\" rollout to finish: 1 of 3 updated replicas are available... Waiting for deployment \"kube-ovn-controller\" rollout to finish: 2 of 3 updated replicas are available... deployment \"kube-ovn-controller\" successfully rolled out","title":"\u4fee\u6539\u5176\u4ed6\u7ec4\u4ef6\u8fde\u63a5 ovn-central \u5730\u5740"},{"location":"ops/delete-worker-node/","text":"\u5220\u9664\u5de5\u4f5c\u8282\u70b9 \u7531\u4e8e\u8282\u70b9\u4e0a ovs-ovn \u4e2d\u8fd0\u884c\u7684 ovn-controller \u8fdb\u7a0b\u4f1a\u5b9a\u671f\u8fde\u63a5 ovn-central \u5e76\u6ce8\u518c\u76f8\u5173\u7f51\u7edc\u4fe1\u606f\uff0c\u4f1a\u5bfc\u81f4\u989d\u5916 \u6d6a\u8d39\u8d44\u6e90\u5f00\u9500\u5e76\u6709\u6f5c\u5728\u7684\u89c4\u5219\u51b2\u7a81\u98ce\u9669\u3002\u56e0\u6b64\u5728\u4ece Kubernetes \u5185\u5220\u9664\u8282\u70b9\u65f6\uff0c\u8bf7\u6309\u7167\u4e0b\u9762\u7684\u6b65\u9aa4\u6765\u4fdd\u8bc1\u7f51\u7edc\u4fe1\u606f\u53ef\u4ee5\u6b63\u5e38\u88ab\u6e05\u7406\u3002 \u8be5\u6587\u6863\u4ecb\u7ecd\u5220\u9664\u5de5\u4f5c\u8282\u70b9\u7684\u6b65\u9aa4\uff0c\u5982\u9700\u66f4\u6362 ovn-central \u6240\u5728\u8282\u70b9\uff0c\u8bf7\u53c2\u8003 \u66f4\u6362 ovn-central \u8282\u70b9 \u9a71\u9010\u8282\u70b9\u4e0a\u6240\u6709\u5bb9\u5668 # kubectl drain kube-ovn-worker --ignore-daemonsets --force node/kube-ovn-worker cordoned WARNING: ignoring DaemonSet-managed Pods: kube-system/kube-ovn-cni-zt74b, kube-system/kube-ovn-pinger-5rxfs, kube-system/kube-proxy-jpmnm, kube-system/ovs-ovn-v2kll evicting pod kube-system/coredns-64897985d-qsgpt evicting pod local-path-storage/local-path-provisioner-5ddd94ff66-llss6 evicting pod kube-system/kube-ovn-controller-8459db5ff4-94lxb pod/kube-ovn-controller-8459db5ff4-94lxb evicted pod/coredns-64897985d-qsgpt evicted pod/local-path-provisioner-5ddd94ff66-llss6 evicted node/kube-ovn-worker drained \u767b\u5f55\u5bf9\u5e94\u8282\u70b9\u5e76\u505c\u6b62 kubelet \u548c docker \u5df2\u505c\u6b62\u5bf9\u5e94 DaemonSet pod\uff0c \u8be5\u6b65\u9aa4\u4f1a\u505c\u6b62 ovs-ovn \u5bb9\u5668\uff0c\u907f\u514d\u5411 ovn-central \u8fdb\u884c\u6ce8\u518c\uff1a systemctl stop kubelet systemctl stop docker \u6e05\u7406 node \u4e0a\u7684 ovs/ovn \u6b8b\u7559\u6570\u636e rm -rf /var/run/openvswitch rm -rf /var/run/ovn rm -rf /etc/origin/openvswitch/ rm -rf /etc/origin/ovn/ rm -rf /etc/cni/net.d/00-kube-ovn.conflist rm -rf /etc/cni/net.d/01-kube-ovn.conflist rm -rf /var/log/openvswitch rm -rf /var/log/ovn \u4f7f\u7528 kubectl \u5220\u9664\u8282\u70b9 kubectl delete no kube-ovn-01 \u68c0\u67e5\u5bf9\u5e94\u8282\u70b9\u662f\u5426\u4ece ovn-sb \u4e2d\u5220\u9664 \u4e0b\u9762\u7684\u793a\u4f8b\u4e3a kube-ovn-worker \u4f9d\u7136\u672a\u88ab\u5220\u9664\uff1a # kubectl ko sbctl show Chassis \"b0564934-5a0d-4804-a4c0-476c93596a17\" hostname: kube-ovn-worker Encap geneve ip: \"172.18.0.2\" options: {csum=\"true\"} Port_Binding kube-ovn-pinger-5rxfs.kube-system Chassis \"6a29de7e-d731-4eaf-bacd-2f239ee52b28\" hostname: kube-ovn-control-plane Encap geneve ip: \"172.18.0.3\" options: {csum=\"true\"} Port_Binding coredns-64897985d-nbfln.kube-system Port_Binding node-kube-ovn-control-plane Port_Binding local-path-provisioner-5ddd94ff66-h4tn9.local-path-storage Port_Binding kube-ovn-pinger-hf2p6.kube-system Port_Binding coredns-64897985d-fhwlw.kube-system \u82e5\u8282\u70b9\u5bf9\u5e94\u7684 chassis \u4f9d\u7136\u5b58\u5728\uff0c\u624b\u52a8\u8fdb\u884c\u5220\u9664 uuid \u4e3a\u4e4b\u524d\u547d\u4ee4\u6240\u67e5\u51fa\u7684 Chassis \u5bf9\u5e94 id\uff1a # kubectl ko sbctl chassis-del b0564934-5a0d-4804-a4c0-476c93596a17 # kubectl ko sbctl show Chassis \"6a29de7e-d731-4eaf-bacd-2f239ee52b28\" hostname: kube-ovn-control-plane Encap geneve ip: \"172.18.0.3\" options: {csum=\"true\"} Port_Binding coredns-64897985d-nbfln.kube-system Port_Binding node-kube-ovn-control-plane Port_Binding local-path-provisioner-5ddd94ff66-h4tn9.local-path-storage Port_Binding kube-ovn-pinger-hf2p6.kube-system Port_Binding coredns-64897985d-fhwlw.kube-system","title":"\u5220\u9664\u5de5\u4f5c\u8282\u70b9"},{"location":"ops/delete-worker-node/#_1","text":"\u7531\u4e8e\u8282\u70b9\u4e0a ovs-ovn \u4e2d\u8fd0\u884c\u7684 ovn-controller \u8fdb\u7a0b\u4f1a\u5b9a\u671f\u8fde\u63a5 ovn-central \u5e76\u6ce8\u518c\u76f8\u5173\u7f51\u7edc\u4fe1\u606f\uff0c\u4f1a\u5bfc\u81f4\u989d\u5916 \u6d6a\u8d39\u8d44\u6e90\u5f00\u9500\u5e76\u6709\u6f5c\u5728\u7684\u89c4\u5219\u51b2\u7a81\u98ce\u9669\u3002\u56e0\u6b64\u5728\u4ece Kubernetes \u5185\u5220\u9664\u8282\u70b9\u65f6\uff0c\u8bf7\u6309\u7167\u4e0b\u9762\u7684\u6b65\u9aa4\u6765\u4fdd\u8bc1\u7f51\u7edc\u4fe1\u606f\u53ef\u4ee5\u6b63\u5e38\u88ab\u6e05\u7406\u3002 \u8be5\u6587\u6863\u4ecb\u7ecd\u5220\u9664\u5de5\u4f5c\u8282\u70b9\u7684\u6b65\u9aa4\uff0c\u5982\u9700\u66f4\u6362 ovn-central \u6240\u5728\u8282\u70b9\uff0c\u8bf7\u53c2\u8003 \u66f4\u6362 ovn-central \u8282\u70b9","title":"\u5220\u9664\u5de5\u4f5c\u8282\u70b9"},{"location":"ops/delete-worker-node/#_2","text":"# kubectl drain kube-ovn-worker --ignore-daemonsets --force node/kube-ovn-worker cordoned WARNING: ignoring DaemonSet-managed Pods: kube-system/kube-ovn-cni-zt74b, kube-system/kube-ovn-pinger-5rxfs, kube-system/kube-proxy-jpmnm, kube-system/ovs-ovn-v2kll evicting pod kube-system/coredns-64897985d-qsgpt evicting pod local-path-storage/local-path-provisioner-5ddd94ff66-llss6 evicting pod kube-system/kube-ovn-controller-8459db5ff4-94lxb pod/kube-ovn-controller-8459db5ff4-94lxb evicted pod/coredns-64897985d-qsgpt evicted pod/local-path-provisioner-5ddd94ff66-llss6 evicted node/kube-ovn-worker drained","title":"\u9a71\u9010\u8282\u70b9\u4e0a\u6240\u6709\u5bb9\u5668"},{"location":"ops/delete-worker-node/#kubelet-docker-daemonset-pod","text":"\u8be5\u6b65\u9aa4\u4f1a\u505c\u6b62 ovs-ovn \u5bb9\u5668\uff0c\u907f\u514d\u5411 ovn-central \u8fdb\u884c\u6ce8\u518c\uff1a systemctl stop kubelet systemctl stop docker","title":"\u767b\u5f55\u5bf9\u5e94\u8282\u70b9\u5e76\u505c\u6b62 kubelet \u548c docker \u5df2\u505c\u6b62\u5bf9\u5e94 DaemonSet pod\uff0c"},{"location":"ops/delete-worker-node/#node-ovsovn","text":"rm -rf /var/run/openvswitch rm -rf /var/run/ovn rm -rf /etc/origin/openvswitch/ rm -rf /etc/origin/ovn/ rm -rf /etc/cni/net.d/00-kube-ovn.conflist rm -rf /etc/cni/net.d/01-kube-ovn.conflist rm -rf /var/log/openvswitch rm -rf /var/log/ovn","title":"\u6e05\u7406 node \u4e0a\u7684 ovs/ovn \u6b8b\u7559\u6570\u636e"},{"location":"ops/delete-worker-node/#kubectl","text":"kubectl delete no kube-ovn-01","title":"\u4f7f\u7528 kubectl \u5220\u9664\u8282\u70b9"},{"location":"ops/delete-worker-node/#ovn-sb","text":"\u4e0b\u9762\u7684\u793a\u4f8b\u4e3a kube-ovn-worker \u4f9d\u7136\u672a\u88ab\u5220\u9664\uff1a # kubectl ko sbctl show Chassis \"b0564934-5a0d-4804-a4c0-476c93596a17\" hostname: kube-ovn-worker Encap geneve ip: \"172.18.0.2\" options: {csum=\"true\"} Port_Binding kube-ovn-pinger-5rxfs.kube-system Chassis \"6a29de7e-d731-4eaf-bacd-2f239ee52b28\" hostname: kube-ovn-control-plane Encap geneve ip: \"172.18.0.3\" options: {csum=\"true\"} Port_Binding coredns-64897985d-nbfln.kube-system Port_Binding node-kube-ovn-control-plane Port_Binding local-path-provisioner-5ddd94ff66-h4tn9.local-path-storage Port_Binding kube-ovn-pinger-hf2p6.kube-system Port_Binding coredns-64897985d-fhwlw.kube-system","title":"\u68c0\u67e5\u5bf9\u5e94\u8282\u70b9\u662f\u5426\u4ece ovn-sb \u4e2d\u5220\u9664"},{"location":"ops/delete-worker-node/#chassis","text":"uuid \u4e3a\u4e4b\u524d\u547d\u4ee4\u6240\u67e5\u51fa\u7684 Chassis \u5bf9\u5e94 id\uff1a # kubectl ko sbctl chassis-del b0564934-5a0d-4804-a4c0-476c93596a17 # kubectl ko sbctl show Chassis \"6a29de7e-d731-4eaf-bacd-2f239ee52b28\" hostname: kube-ovn-control-plane Encap geneve ip: \"172.18.0.3\" options: {csum=\"true\"} Port_Binding coredns-64897985d-nbfln.kube-system Port_Binding node-kube-ovn-control-plane Port_Binding local-path-provisioner-5ddd94ff66-h4tn9.local-path-storage Port_Binding kube-ovn-pinger-hf2p6.kube-system Port_Binding coredns-64897985d-fhwlw.kube-system","title":"\u82e5\u8282\u70b9\u5bf9\u5e94\u7684 chassis \u4f9d\u7136\u5b58\u5728\uff0c\u624b\u52a8\u8fdb\u884c\u5220\u9664"},{"location":"ops/faq/","text":"\u5176\u4ed6\u5e38\u89c1\u95ee\u9898 \u9e92\u9e9f ARM \u7cfb\u7edf\u8de8\u4e3b\u673a\u5bb9\u5668\u8bbf\u95ee\u95f4\u6b47\u5931\u8d25 \u73b0\u8c61 \u9e92\u9e9f ARM \u7cfb\u7edf\u548c\u90e8\u5206\u56fd\u4ea7\u5316\u7f51\u5361 offload \u914d\u5408\u5b58\u5728\u95ee\u9898\uff0c\u4f1a\u5bfc\u81f4\u5bb9\u5668\u7f51\u7edc\u95f4\u6b47\u6545\u969c\u3002 \u4f7f\u7528 netstat \u786e\u8ba4\u95ee\u9898\uff1a # netstat -us IcmpMsg: InType0: 22 InType3: 24 InType8: 117852 OutType0: 117852 OutType3: 29 OutType8: 22 Udp: 3040636 packets received 0 packets to unknown port received. 4 packet receive errors 602 packets sent 0 receive buffer errors 0 send buffer errors InCsumErrors: 4 UdpLite: IpExt: InBcastPkts: 10244 InOctets: 4446320361 OutOctets: 1496815600 InBcastOctets: 3095950 InNoECTPkts: 7683903 \u82e5\u5b58\u5728 InCsumErrors \uff0c\u4e14\u968f\u7740\u8bbf\u95ee\u5931\u8d25\u589e\u52a0\uff0c\u53ef\u786e\u8ba4\u662f\u8be5\u95ee\u9898\u3002 \u89e3\u51b3\u65b9\u6cd5 \u6839\u672c\u89e3\u51b3\u9700\u8981\u548c\u9e92\u9e9f\u4ee5\u53ca\u5bf9\u5e94\u7f51\u5361\u5382\u5546\u6c9f\u901a\uff0c\u66f4\u65b0\u7cfb\u7edf\u548c\u9a71\u52a8\u3002\u4e34\u65f6\u89e3\u51b3\u53ef\u5148\u5173\u95ed\u7269\u7406 \u7f51\u5361\u7684 tx offload \u4f46\u662f\u4f1a\u5bfc\u81f4 tcp \u6027\u80fd\u6709\u8f83\u660e\u663e\u4e0b\u964d\u3002 ethtool -K eth0 tx off Pod \u8bbf\u95ee Service \u4e0d\u901a \u73b0\u8c61 Pod \u5185\u65e0\u6cd5\u8bbf\u95ee Service \u5bf9\u5e94\u7684\u670d\u52a1\uff0c dmesg \u663e\u793a\u5f02\u5e38\uff1a netlink\uff1aUnknown conntrack attr (type=6, max=5) openvswitch: netlink: Flow actions may not be safe on all matching packets. \u8be5\u65e5\u5fd7\u8bf4\u660e\u5185\u6838\u5185 OVS \u7248\u672c\u8fc7\u4f4e\u4e0d\u652f\u6301\u5bf9\u5e94 NAT \u64cd\u4f5c\u3002 \u89e3\u51b3\u65b9\u6cd5 \u5347\u7ea7\u5185\u6838\u6a21\u5757\u6216\u624b\u52a8\u7f16\u8bd1 OVS \u5185\u6838\u6a21\u5757\u3002 \u82e5\u53ea\u4f7f\u7528 Overlay \u7f51\u7edc\u53ef\u4ee5\u66f4\u6539 kube-ovn-controller \u542f\u52a8\u53c2\u6570\u8bbe\u7f6e --enable-lb=false \u5173\u95ed OVN LB \u4f7f\u7528 kube-proxy \u8fdb\u884c Service \u8f6c\u53d1\u3002","title":"\u5176\u4ed6\u5e38\u89c1\u95ee\u9898"},{"location":"ops/faq/#_1","text":"","title":"\u5176\u4ed6\u5e38\u89c1\u95ee\u9898"},{"location":"ops/faq/#arm","text":"","title":"\u9e92\u9e9f ARM \u7cfb\u7edf\u8de8\u4e3b\u673a\u5bb9\u5668\u8bbf\u95ee\u95f4\u6b47\u5931\u8d25"},{"location":"ops/faq/#_2","text":"\u9e92\u9e9f ARM \u7cfb\u7edf\u548c\u90e8\u5206\u56fd\u4ea7\u5316\u7f51\u5361 offload \u914d\u5408\u5b58\u5728\u95ee\u9898\uff0c\u4f1a\u5bfc\u81f4\u5bb9\u5668\u7f51\u7edc\u95f4\u6b47\u6545\u969c\u3002 \u4f7f\u7528 netstat \u786e\u8ba4\u95ee\u9898\uff1a # netstat -us IcmpMsg: InType0: 22 InType3: 24 InType8: 117852 OutType0: 117852 OutType3: 29 OutType8: 22 Udp: 3040636 packets received 0 packets to unknown port received. 4 packet receive errors 602 packets sent 0 receive buffer errors 0 send buffer errors InCsumErrors: 4 UdpLite: IpExt: InBcastPkts: 10244 InOctets: 4446320361 OutOctets: 1496815600 InBcastOctets: 3095950 InNoECTPkts: 7683903 \u82e5\u5b58\u5728 InCsumErrors \uff0c\u4e14\u968f\u7740\u8bbf\u95ee\u5931\u8d25\u589e\u52a0\uff0c\u53ef\u786e\u8ba4\u662f\u8be5\u95ee\u9898\u3002","title":"\u73b0\u8c61"},{"location":"ops/faq/#_3","text":"\u6839\u672c\u89e3\u51b3\u9700\u8981\u548c\u9e92\u9e9f\u4ee5\u53ca\u5bf9\u5e94\u7f51\u5361\u5382\u5546\u6c9f\u901a\uff0c\u66f4\u65b0\u7cfb\u7edf\u548c\u9a71\u52a8\u3002\u4e34\u65f6\u89e3\u51b3\u53ef\u5148\u5173\u95ed\u7269\u7406 \u7f51\u5361\u7684 tx offload \u4f46\u662f\u4f1a\u5bfc\u81f4 tcp \u6027\u80fd\u6709\u8f83\u660e\u663e\u4e0b\u964d\u3002 ethtool -K eth0 tx off","title":"\u89e3\u51b3\u65b9\u6cd5"},{"location":"ops/faq/#pod-service","text":"","title":"Pod \u8bbf\u95ee Service \u4e0d\u901a"},{"location":"ops/faq/#_4","text":"Pod \u5185\u65e0\u6cd5\u8bbf\u95ee Service \u5bf9\u5e94\u7684\u670d\u52a1\uff0c dmesg \u663e\u793a\u5f02\u5e38\uff1a netlink\uff1aUnknown conntrack attr (type=6, max=5) openvswitch: netlink: Flow actions may not be safe on all matching packets. \u8be5\u65e5\u5fd7\u8bf4\u660e\u5185\u6838\u5185 OVS \u7248\u672c\u8fc7\u4f4e\u4e0d\u652f\u6301\u5bf9\u5e94 NAT \u64cd\u4f5c\u3002","title":"\u73b0\u8c61"},{"location":"ops/faq/#_5","text":"\u5347\u7ea7\u5185\u6838\u6a21\u5757\u6216\u624b\u52a8\u7f16\u8bd1 OVS \u5185\u6838\u6a21\u5757\u3002 \u82e5\u53ea\u4f7f\u7528 Overlay \u7f51\u7edc\u53ef\u4ee5\u66f4\u6539 kube-ovn-controller \u542f\u52a8\u53c2\u6570\u8bbe\u7f6e --enable-lb=false \u5173\u95ed OVN LB \u4f7f\u7528 kube-proxy \u8fdb\u884c Service \u8f6c\u53d1\u3002","title":"\u89e3\u51b3\u65b9\u6cd5"},{"location":"ops/from-calico/","text":"\u5378\u8f7d Calico \u5b89\u88c5 Kube-OVN \u82e5 Kubernetes \u96c6\u7fa4\u5df2\u5b89\u88c5 Calico \u9700\u8981\u53d8\u66f4\u4e3a Kube-OVN \u53ef\u4ee5\u53c2\u8003\u672c\u6587\u6863\u3002 \u7531\u4e8e Calico \u5404\u4e2a\u7248\u672c\u7684\u5b89\u88c5\u53ef\u80fd\u5b58\u5728\u5dee\u5f02\uff0c\u5e76\u4e14\u66f4\u6362\u8fc7\u7a0b\u4e2d\u5df2\u6709 Pod \u7f51\u7edc \u4f1a\u4e2d\u65ad\uff0c\u5efa\u8bae\u63d0\u524d\u505a\u597d\u89c4\u5212\uff0c\u5e76\u53c2\u7167\u4e0d\u540c\u7248\u672c Calico \u5b89\u88c5\u5dee\u5f02\u8fdb\u884c\u8c03\u6574\u3002 \u5378\u8f7d Calico \u7ec4\u4ef6 Operator \u5b89\u88c5\u6a21\u5f0f Calico \u5378\u8f7d\uff1a kubectl delete -f https://projectcalico.docs.tigera.io/manifests/tigera-operator.yaml kubectl delete -f https://projectcalico.docs.tigera.io/manifests/custom-resources.yaml Manifest \u5b89\u88c5\u6a21\u5f0f Calico \u5378\u8f7d\uff1a kubectl delete -f https://projectcalico.docs.tigera.io/manifests/calico.yaml \u6b8b\u7559\u914d\u7f6e\u6e05\u7406 \u6839\u636e\u73af\u5883\u5177\u4f53\u60c5\u51b5\uff0c\u5728\u6bcf\u53f0\u673a\u5668\u5220\u9664 CNI \u76f8\u5173\u914d\u7f6e\u6587\u4ef6\uff1a rm -f /etc/cni/net.d/10-calico.conflist rm -f /etc/cni/net.d/calico-kubeconfig Calico \u4f9d\u7136\u4f1a\u5728\u8282\u70b9\u4e0a\u6b8b\u7559\u8def\u7531\u89c4\u5219\uff0ciptables \u89c4\u5219\uff0cveth \u7f51\u7edc\u63a5\u53e3\u7b49\u914d\u7f6e\u4fe1\u606f\uff0c \u5efa\u8bae\u91cd\u542f\u8282\u70b9\u6e05\u7406\u76f8\u5173\u914d\u7f6e\uff0c\u907f\u514d\u51fa\u73b0\u96be\u4ee5\u6392\u67e5\u7684\u95ee\u9898\u3002 \u5b89\u88c5 Kube-OVN \u53ef\u53c2\u8003 \u4e00\u952e\u5b89\u88c5 \u6b63\u5e38\u8fdb\u884c\u5b89\u88c5\u3002","title":"\u5378\u8f7d Calico \u5b89\u88c5 Kube-OVN"},{"location":"ops/from-calico/#calico-kube-ovn","text":"\u82e5 Kubernetes \u96c6\u7fa4\u5df2\u5b89\u88c5 Calico \u9700\u8981\u53d8\u66f4\u4e3a Kube-OVN \u53ef\u4ee5\u53c2\u8003\u672c\u6587\u6863\u3002 \u7531\u4e8e Calico \u5404\u4e2a\u7248\u672c\u7684\u5b89\u88c5\u53ef\u80fd\u5b58\u5728\u5dee\u5f02\uff0c\u5e76\u4e14\u66f4\u6362\u8fc7\u7a0b\u4e2d\u5df2\u6709 Pod \u7f51\u7edc \u4f1a\u4e2d\u65ad\uff0c\u5efa\u8bae\u63d0\u524d\u505a\u597d\u89c4\u5212\uff0c\u5e76\u53c2\u7167\u4e0d\u540c\u7248\u672c Calico \u5b89\u88c5\u5dee\u5f02\u8fdb\u884c\u8c03\u6574\u3002","title":"\u5378\u8f7d Calico \u5b89\u88c5 Kube-OVN"},{"location":"ops/from-calico/#calico","text":"Operator \u5b89\u88c5\u6a21\u5f0f Calico \u5378\u8f7d\uff1a kubectl delete -f https://projectcalico.docs.tigera.io/manifests/tigera-operator.yaml kubectl delete -f https://projectcalico.docs.tigera.io/manifests/custom-resources.yaml Manifest \u5b89\u88c5\u6a21\u5f0f Calico \u5378\u8f7d\uff1a kubectl delete -f https://projectcalico.docs.tigera.io/manifests/calico.yaml","title":"\u5378\u8f7d Calico \u7ec4\u4ef6"},{"location":"ops/from-calico/#_1","text":"\u6839\u636e\u73af\u5883\u5177\u4f53\u60c5\u51b5\uff0c\u5728\u6bcf\u53f0\u673a\u5668\u5220\u9664 CNI \u76f8\u5173\u914d\u7f6e\u6587\u4ef6\uff1a rm -f /etc/cni/net.d/10-calico.conflist rm -f /etc/cni/net.d/calico-kubeconfig Calico \u4f9d\u7136\u4f1a\u5728\u8282\u70b9\u4e0a\u6b8b\u7559\u8def\u7531\u89c4\u5219\uff0ciptables \u89c4\u5219\uff0cveth \u7f51\u7edc\u63a5\u53e3\u7b49\u914d\u7f6e\u4fe1\u606f\uff0c \u5efa\u8bae\u91cd\u542f\u8282\u70b9\u6e05\u7406\u76f8\u5173\u914d\u7f6e\uff0c\u907f\u514d\u51fa\u73b0\u96be\u4ee5\u6392\u67e5\u7684\u95ee\u9898\u3002","title":"\u6b8b\u7559\u914d\u7f6e\u6e05\u7406"},{"location":"ops/from-calico/#kube-ovn","text":"\u53ef\u53c2\u8003 \u4e00\u952e\u5b89\u88c5 \u6b63\u5e38\u8fdb\u884c\u5b89\u88c5\u3002","title":"\u5b89\u88c5 Kube-OVN"},{"location":"ops/kubectl-ko/","text":"kubectl \u63d2\u4ef6\u4f7f\u7528 \u4e3a\u4e86\u65b9\u4fbf\u65e5\u5e38\u7684\u8fd0\u7ef4\u64cd\u4f5c\uff0cKube-OVN \u63d0\u4f9b\u4e86 kubectl \u63d2\u4ef6\u5de5\u5177\uff0c\u7f51\u7edc\u7ba1\u7406\u5458 \u53ef\u4ee5\u901a\u8fc7\u8be5\u547d\u4ee4\u8fdb\u884c\u65e5\u5e38\u64cd\u4f5c\uff0c\u4f8b\u5982\uff1a\u67e5\u770b OVN \u6570\u636e\u5e93\u4fe1\u606f\u548c\u72b6\u6001\uff0cOVN \u6570\u636e\u5e93 \u5907\u4efd\u548c\u6062\u590d\uff0cOVS \u76f8\u5173\u4fe1\u606f\u67e5\u770b\uff0ctcpdump \u7279\u5b9a\u5bb9\u5668\uff0c\u7279\u5b9a\u94fe\u8def\u903b\u8f91\u62d3\u6251\u5c55\u793a\uff0c \u7f51\u7edc\u95ee\u9898\u8bca\u65ad\u548c\u6027\u80fd\u4f18\u5316\u3002 \u63d2\u4ef6\u5b89\u88c5 Kube-OVN \u5b89\u88c5\u65f6\u9ed8\u8ba4\u4f1a\u90e8\u7f72\u63d2\u4ef6\u5230\u6bcf\u4e2a\u8282\u70b9\uff0c\u82e5\u6267\u884c kubectl \u7684\u673a\u5668\u4e0d\u5728\u96c6\u7fa4\u5185\uff0c \u6216\u9700\u8981\u91cd\u88c5\u63d2\u4ef6\uff0c\u53ef\u53c2\u8003\u4e0b\u9762\u7684\u6b65\u9aa4\uff1a \u4e0b\u8f7d kubectl-ko \u6587\u4ef6\uff1a wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/dist/images/kubectl-ko \u5c06\u8be5\u6587\u4ef6\u79fb\u52a8\u81f3 $PATH \u76ee\u5f55\u4e0b\uff1a mv kubectl-ko /usr/local/bin/kubectl-ko \u589e\u52a0\u53ef\u6267\u884c\u6743\u9650\uff1a chmod +x /usr/local/bin/kubectl-ko \u68c0\u67e5\u63d2\u4ef6\u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u4f7f\u7528\uff1a # kubectl plugin list The following compatible plugins are available: /usr/local/bin/kubectl-ko \u63d2\u4ef6\u4f7f\u7528 \u8fd0\u884c kubectl ko \u4f1a\u5c55\u793a\u8be5\u63d2\u4ef6\u6240\u6709\u53ef\u7528\u7684\u547d\u4ee4\u548c\u7528\u6cd5\u63cf\u8ff0\uff0c\u5982\u4e0b\u6240\u793a\uff1a # kubectl ko kubectl ko {subcommand} [option...] Available Subcommands: [nb|sb] [status|kick|backup|dbstatus|restore] ovn-db operations show cluster status, kick stale server, backup database, get db consistency status or restore ovn nb db when met 'inconsistent data' error nbctl [ovn-nbctl options ...] invoke ovn-nbctl sbctl [ovn-sbctl options ...] invoke ovn-sbctl vsctl {nodeName} [ovs-vsctl options ...] invoke ovs-vsctl on the specified node ofctl {nodeName} [ovs-ofctl options ...] invoke ovs-ofctl on the specified node dpctl {nodeName} [ovs-dpctl options ...] invoke ovs-dpctl on the specified node appctl {nodeName} [ovs-appctl options ...] invoke ovs-appctl on the specified node tcpdump {namespace/podname} [tcpdump options ...] capture pod traffic trace {namespace/podname} {target ip address} {icmp|tcp|udp} [target tcp or udp port] trace ovn microflow of specific packet diagnose {all|node} [nodename] diagnose connectivity of all nodes or a specific node tuning {install-fastpath|local-install-fastpath|remove-fastpath|install-stt|local-install-stt|remove-stt} {centos7|centos8}} [kernel-devel-version] deploy kernel optimisation components to the system reload restart all kube-ovn components \u4e0b\u9762\u5c06\u4ecb\u7ecd\u6bcf\u4e2a\u547d\u4ee4\u7684\u5177\u4f53\u529f\u80fd\u548c\u4f7f\u7528\u3002 [nb | sb] [status | kick | backup | dbstatus | restore] \u8be5\u5b50\u547d\u4ee4\u4e3b\u8981\u5bf9 OVN \u5317\u5411\u6216\u5357\u5411\u6570\u636e\u5e93\u8fdb\u884c\u64cd\u4f5c\uff0c\u5305\u62ec\u6570\u636e\u5e93\u96c6\u7fa4\u72b6\u6001\u67e5\u770b\uff0c\u6570\u636e\u5e93\u8282\u70b9\u4e0b\u7ebf\uff0c \u6570\u636e\u5e93\u5907\u4efd\uff0c\u6570\u636e\u5e93\u5b58\u50a8\u72b6\u6001\u67e5\u770b\u548c\u6570\u636e\u5e93\u4fee\u590d\u3002 \u6570\u636e\u5e93\u96c6\u7fa4\u72b6\u6001\u67e5\u770b \u8be5\u547d\u4ee4\u4f1a\u5728\u5bf9\u5e94 OVN \u6570\u636e\u5e93\u7684 leader \u8282\u70b9\u6267\u884c ovs-appctl cluster/status \u5c55\u793a\u96c6\u7fa4\u72b6\u6001: # kubectl ko nb status 306b Name: OVN_Northbound Cluster ID: 9a87 (9a872522-3e7d-47ca-83a3-d74333e1a7ca) Server ID: 306b (306b256b-b5e1-4eb0-be91-4ca96adf6bad) Address: tcp:[172.18.0.2]:6643 Status: cluster member Role: leader Term: 1 Leader: self Vote: self Last Election started 280309 ms ago, reason: timeout Last Election won: 280309 ms ago Election timer: 5000 Log: [139, 139] Entries not yet committed: 0 Entries not yet applied: 0 Connections: <-8723 ->8723 <-85d6 ->85d6 Disconnections: 0 Servers: 85d6 (85d6 at tcp:[172.18.0.4]:6643) next_index=139 match_index=138 last msg 763 ms ago 8723 (8723 at tcp:[172.18.0.3]:6643) next_index=139 match_index=138 last msg 763 ms ago 306b (306b at tcp:[172.18.0.2]:6643) (self) next_index=2 match_index=138 status: ok \u82e5 Server \u4e0b\u7684 match_index \u51fa\u73b0\u8f83\u5927\u5dee\u522b\uff0c\u4e14 last msg \u65f6\u95f4\u8f83\u957f\u5219\u5bf9\u5e94 Server \u53ef\u80fd\u957f\u65f6\u95f4\u6ca1\u6709\u54cd\u5e94\uff0c \u9700\u8981\u8fdb\u4e00\u6b65\u67e5\u770b\u3002 \u6570\u636e\u5e93\u8282\u70b9\u4e0b\u7ebf \u8be5\u547d\u4ee4\u4f1a\u5c06\u67d0\u4e2a\u8282\u70b9\u4ece OVN \u6570\u636e\u5e93\u4e2d\u79fb\u9664\uff0c\u5728\u8282\u70b9\u4e0b\u7ebf\u6216\u66f4\u6362\u8282\u70b9\u65f6\u9700\u8981\u7528\u5230\u3002 \u4e0b\u9762\u5c06\u4ee5\u4e0a\u4e00\u6761\u547d\u4ee4\u6240\u67e5\u770b\u5230\u7684\u96c6\u7fa4\u72b6\u6001\u4e3a\u4f8b\uff0c\u4e0b\u7ebf 172.18.0.3 \u8282\u70b9: # kubectl ko nb kick 8723 started removal \u518d\u6b21\u67e5\u770b\u6570\u636e\u5e93\u96c6\u7fa4\u72b6\u6001\u786e\u8ba4\u8282\u70b9\u5df2\u79fb\u9664\uff1a # kubectl ko nb status 306b Name: OVN_Northbound Cluster ID: 9a87 (9a872522-3e7d-47ca-83a3-d74333e1a7ca) Server ID: 306b (306b256b-b5e1-4eb0-be91-4ca96adf6bad) Address: tcp:[172.18.0.2]:6643 Status: cluster member Role: leader Term: 1 Leader: self Vote: self Last Election started 324356 ms ago, reason: timeout Last Election won: 324356 ms ago Election timer: 5000 Log: [140, 140] Entries not yet committed: 0 Entries not yet applied: 0 Connections: <-85d6 ->85d6 Disconnections: 2 Servers: 85d6 (85d6 at tcp:[172.18.0.4]:6643) next_index=140 match_index=139 last msg 848 ms ago 306b (306b at tcp:[172.18.0.2]:6643) (self) next_index=2 match_index=139 status: ok \u6570\u636e\u5e93\u5907\u4efd \u8be5\u5b50\u547d\u4ee4\u4f1a\u5907\u4efd\u5f53\u524d OVN \u6570\u636e\u5e93\u81f3\u672c\u5730\uff0c\u53ef\u7528\u4e8e\u707e\u5907\u548c\u6062\u590d\uff1a # kubectl ko nb backup tar: Removing leading `/' from member names backup ovn-nb db to /root/ovnnb_db.060223191654183154.backup \u6570\u636e\u5e93\u5b58\u50a8\u72b6\u6001\u67e5\u770b \u8be5\u547d\u4ee4\u7528\u6765\u67e5\u770b\u6570\u636e\u5e93\u6587\u4ef6\u662f\u5426\u5b58\u5728\u635f\u574f\uff1a # kubectl ko nb dbstatus status: ok \u82e5\u5f02\u5e38\u5219\u663e\u793a inconsistent data \u9700\u8981\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c\u4fee\u590d\u3002 \u6570\u636e\u5e93\u4fee\u590d \u82e5\u6570\u636e\u5e93\u72b6\u6001\u8fdb\u5165 inconsistent data \u53ef\u4f7f\u7528\u8be5\u547d\u4ee4\u8fdb\u884c\u4fee\u590d\uff1a # kubectl ko nb restore deployment.apps/ovn-central scaled ovn-central original replicas is 3 first nodeIP is 172.18.0.5 ovs-ovn pod on node 172.18.0.5 is ovs-ovn-8jxv9 ovs-ovn pod on node 172.18.0.3 is ovs-ovn-sjzb6 ovs-ovn pod on node 172.18.0.4 is ovs-ovn-t87zk backup nb db file restore nb db file, operate in pod ovs-ovn-8jxv9 deployment.apps/ovn-central scaled finish restore nb db file and ovn-central replicas recreate ovs-ovn pods pod \"ovs-ovn-8jxv9\" deleted pod \"ovs-ovn-sjzb6\" deleted pod \"ovs-ovn-t87zk\" deleted [nbctl | sbctl] [options ...] \u8be5\u5b50\u547d\u4ee4\u4f1a\u76f4\u63a5\u8fdb\u5165 OVN \u5317\u5411\u6570\u636e\u5e93\u6216\u5357\u5411\u6570\u636e\u5e93 \u7684 leader \u8282\u70b9\u5206\u522b\u6267\u884c ovn-nbctl \u548c ovn-sbctl \u547d\u4ee4\u3002 \u66f4\u591a\u8be5\u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u8bf7\u67e5\u8be2\u4e0a\u6e38 OVN \u7684\u5b98\u65b9\u6587\u6863 ovn-nbctl(8) \u548c ovn-sbctl(8) \u3002 # kubectl ko nbctl show switch c7cd17e8-ceee-4a91-9bb3-e5a313fe1ece (snat) port snat-ovn-cluster type: router router-port: ovn-cluster-snat switch 20e0c6d0-023a-4756-aec5-200e0c60f95d (join) port node-liumengxin-ovn3-192.168.137.178 addresses: [\"00:00:00:64:FF:A8 100.64.0.4\"] port node-liumengxin-ovn1-192.168.137.176 addresses: [\"00:00:00:AF:98:62 100.64.0.2\"] port node-liumengxin-ovn2-192.168.137.177 addresses: [\"00:00:00:D9:58:B8 100.64.0.3\"] port join-ovn-cluster type: router router-port: ovn-cluster-join switch 0191705c-f827-427b-9de3-3c3b7d971ba5 (central) port central-ovn-cluster type: router router-port: ovn-cluster-central switch 2a45ff05-388d-4f85-9daf-e6fccd5833dc (ovn-default) port alertmanager-main-0.monitoring addresses: [\"00:00:00:6C:DF:A3 10.16.0.19\"] port kube-state-metrics-5d6885d89-4nf8h.monitoring addresses: [\"00:00:00:6F:02:1C 10.16.0.15\"] port fake-kubelet-67c55dfd89-pv86k.kube-system addresses: [\"00:00:00:5C:12:E8 10.16.19.177\"] port ovn-default-ovn-cluster type: router router-port: ovn-cluster-ovn-default router 212f73dd-d63d-4d72-864b-a537e9afbee1 (ovn-cluster) port ovn-cluster-snat mac: \"00:00:00:7A:82:8F\" networks: [\"172.22.0.1/16\"] port ovn-cluster-join mac: \"00:00:00:F8:18:5A\" networks: [\"100.64.0.1/16\"] port ovn-cluster-central mac: \"00:00:00:4D:8C:F5\" networks: [\"192.101.0.1/16\"] port ovn-cluster-ovn-default mac: \"00:00:00:A3:F8:18\" networks: [\"10.16.0.1/16\"] vsctl {nodeName} [options ...] \u8be5\u547d\u4ee4\u4f1a\u8fdb\u5165\u5bf9\u5e94 nodeName \u4e0a\u7684 ovs-ovn \u5bb9\u5668\uff0c\u5e76\u6267\u884c\u76f8\u5e94\u7684 ovs-vsctl \u547d\u4ee4\uff0c\u67e5\u8be2\u5e76\u914d\u7f6e vswitchd \u3002 \u66f4\u591a\u8be5\u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u8bf7\u67e5\u8be2\u4e0a\u6e38 OVS \u7684\u5b98\u65b9\u6587\u6863 ovs-vsctl(8) \u3002 # kubectl ko vsctl kube-ovn-01 show 0d4c4675-c9cc-440a-8c1a-878e17f81b88 Bridge br-int fail_mode: secure datapath_type: system Port a2c1a8a8b83a_h Interface a2c1a8a8b83a_h Port \"4fa5c4cbb1a5_h\" Interface \"4fa5c4cbb1a5_h\" Port ovn-eef07d-0 Interface ovn-eef07d-0 type: stt options: {csum=\"true\", key=flow, remote_ip=\"192.168.137.178\"} Port ovn0 Interface ovn0 type: internal Port mirror0 Interface mirror0 type: internal Port ovn-efa253-0 Interface ovn-efa253-0 type: stt options: {csum=\"true\", key=flow, remote_ip=\"192.168.137.177\"} Port br-int Interface br-int type: internal ovs_version: \"2.17.2\" ofctl {nodeName} [options ...] \u8be5\u547d\u4ee4\u4f1a\u8fdb\u5165\u5bf9\u5e94 nodeName \u4e0a\u7684 ovs-ovn \u5bb9\u5668\uff0c\u5e76\u6267\u884c\u76f8\u5e94\u7684 ovs-ofctl \u547d\u4ee4\uff0c\u67e5\u8be2\u6216\u7ba1\u7406 OpenFlow\u3002 \u66f4\u591a\u8be5\u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u8bf7\u67e5\u8be2\u4e0a\u6e38 OVS \u7684\u5b98\u65b9\u6587\u6863 ovs-ofctl(8) \u3002 # kubectl ko ofctl kube-ovn-01 dump-flows br-int NXST_FLOW reply (xid=0x4): flags=[more] cookie=0xcf3429e6, duration=671791.432s, table=0, n_packets=0, n_bytes=0, idle_age=65534, hard_age=65534, priority=100,in_port=2 actions=load:0x4->NXM_NX_REG13[],load:0x9->NXM_NX_REG11[],load:0xb->NXM_NX_REG12[],load:0x4->OXM_OF_METADATA[],load:0x1->NXM_NX_REG14[],resubmit(,8) cookie=0xc91413c6, duration=671791.431s, table=0, n_packets=907489, n_bytes=99978275, idle_age=0, hard_age=65534, priority=100,in_port=7 actions=load:0x1->NXM_NX_REG13[],load:0x9->NXM_NX_REG11[],load:0xb->NXM_NX_REG12[],load:0x4->OXM_OF_METADATA[],load:0x4->NXM_NX_REG14[],resubmit(,8) cookie=0xf180459, duration=671791.431s, table=0, n_packets=17348582, n_bytes=2667811214, idle_age=0, hard_age=65534, priority=100,in_port=6317 actions=load:0xa->NXM_NX_REG13[],load:0x9->NXM_NX_REG11[],load:0xb->NXM_NX_REG12[],load:0x4->OXM_OF_METADATA[],load:0x9->NXM_NX_REG14[],resubmit(,8) cookie=0x7806dd90, duration=671791.431s, table=0, n_packets=3235428, n_bytes=833821312, idle_age=0, hard_age=65534, priority=100,in_port=1 actions=load:0xd->NXM_NX_REG13[],load:0x9->NXM_NX_REG11[],load:0xb->NXM_NX_REG12[],load:0x4->OXM_OF_METADATA[],load:0x3->NXM_NX_REG14[],resubmit(,8) ... dpctl {nodeName} [options ...] \u8be5\u547d\u4ee4\u4f1a\u8fdb\u5165\u5bf9\u5e94 nodeName \u4e0a\u7684 ovs-ovn \u5bb9\u5668\uff0c\u5e76\u6267\u884c\u76f8\u5e94\u7684 ovs-dpctl \u547d\u4ee4\uff0c\u67e5\u8be2\u6216\u7ba1\u7406 OVS datapath\u3002 \u66f4\u591a\u8be5\u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u8bf7\u67e5\u8be2\u4e0a\u6e38 OVS \u7684\u5b98\u65b9\u6587\u6863 ovs-dpctl(8) \u3002 # kubectl ko dpctl kube-ovn-01 show system@ovs-system: lookups: hit:350805055 missed:21983648 lost:73 flows: 105 masks: hit:1970748791 total:22 hit/pkt:5.29 port 0: ovs-system (internal) port 1: ovn0 (internal) port 2: mirror0 (internal) port 3: br-int (internal) port 4: stt_sys_7471 (stt: packet_type=ptap) port 5: eeb4d9e51b5d_h port 6: a2c1a8a8b83a_h port 7: 4fa5c4cbb1a5_h appctl {nodeName} [options ...] \u8be5\u547d\u4ee4\u4f1a\u8fdb\u5165\u5bf9\u5e94 nodeName \u4e0a\u7684 ovs-ovn \u5bb9\u5668\uff0c\u5e76\u6267\u884c\u76f8\u5e94\u7684 ovs-appctl \u547d\u4ee4\uff0c\u6765\u64cd\u4f5c\u76f8\u5173 daemon \u8fdb\u7a0b\u3002 \u66f4\u591a\u8be5\u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u8bf7\u67e5\u8be2\u4e0a\u6e38 OVS \u7684\u5b98\u65b9\u6587\u6863 ovs-appctl(8) \u3002 # kubectl ko appctl kube-ovn-01 vlog/list console syslog file ------- ------ ------ backtrace OFF ERR INFO bfd OFF ERR INFO bond OFF ERR INFO bridge OFF ERR INFO bundle OFF ERR INFO bundles OFF ERR INFO ... tcpdump {namespace/podname} [tcpdump options ...] \u8be5\u547d\u4ee4\u4f1a\u8fdb\u5165 namespace/podname \u6240\u5728\u673a\u5668\u7684 kube-ovn-cni \u5bb9\u5668\uff0c\u5e76\u6267\u884c tcpdump \u6293\u53d6\u5bf9\u5e94\u5bb9\u5668 veth \u7f51\u5361 \u7aef\u7684\u6d41\u91cf\uff0c\u53ef\u4ee5\u65b9\u4fbf\u6392\u67e5\u7f51\u7edc\u76f8\u5173\u95ee\u9898\uff0c\u5982\u4e0b\u6240\u793a\uff1a # kubectl ko tcpdump default/ds1-l6n7p icmp + kubectl exec -it kube-ovn-cni-wlg4s -n kube-ovn -- tcpdump -nn -i d7176fe7b4e0_h icmp tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on d7176fe7b4e0_h, link-type EN10MB (Ethernet), capture size 262144 bytes 06:52:36.619688 IP 100.64.0.3 > 10.16.0.4: ICMP echo request, id 2, seq 1, length 64 06:52:36.619746 IP 10.16.0.4 > 100.64.0.3: ICMP echo reply, id 2, seq 1, length 64 06:52:37.619588 IP 100.64.0.3 > 10.16.0.4: ICMP echo request, id 2, seq 2, length 64 06:52:37.619630 IP 10.16.0.4 > 100.64.0.3: ICMP echo reply, id 2, seq 2, length 64 06:52:38.619933 IP 100.64.0.3 > 10.16.0.4: ICMP echo request, id 2, seq 3, length 64 06:52:38.619973 IP 10.16.0.4 > 100.64.0.3: ICMP echo reply, id 2, seq 3, length 64 trace {namespace/podname} {target ip address} {icmp|tcp|udp} [target tcp or udp port] \u8be5\u547d\u4ee4\u5c06\u4f1a\u6253\u5370 Pod \u901a\u8fc7\u7279\u5b9a\u534f\u8bae\u8bbf\u95ee\u67d0\u5730\u5740\u65f6\u5bf9\u5e94\u7684 OVN \u903b\u8f91\u6d41\u8868\u548c\u6700\u7ec8\u7684 Openflow \u6d41\u8868\uff0c \u65b9\u4fbf\u5f00\u53d1\u6216\u8fd0\u7ef4\u65f6\u5b9a\u4f4d\u6d41\u8868\u76f8\u5173\u95ee\u9898\u3002 # kubectl ko trace default/ds1-l6n7p 8.8.8.8 icmp + kubectl exec ovn-central-5bc494cb5-np9hm -n kube-ovn -- ovn-trace --ct=new ovn-default 'inport == \"ds1-l6n7p.default\" && ip.ttl == 64 && icmp && eth.src == 0a:00:00:10:00:05 && ip4.src == 10.16.0.4 && eth.dst == 00:00:00:B8:CA:43 && ip4.dst == 8.8.8.8' # icmp,reg14=0xf,vlan_tci=0x0000,dl_src=0a:00:00:10:00:05,dl_dst=00:00:00:b8:ca:43,nw_src=10.16.0.4,nw_dst=8.8.8.8,nw_tos=0,nw_ecn=0,nw_ttl=64,icmp_type=0,icmp_code=0 ingress(dp=\"ovn-default\", inport=\"ds1-l6n7p.default\") ----------------------------------------------------- 0. ls_in_port_sec_l2 (ovn-northd.c:4143): inport == \"ds1-l6n7p.default\" && eth.src == {0a:00:00:10:00:05}, priority 50, uuid 39453393 next; 1. ls_in_port_sec_ip (ovn-northd.c:2898): inport == \"ds1-l6n7p.default\" && eth.src == 0a:00:00:10:00:05 && ip4.src == {10.16.0.4}, priority 90, uuid 81bcd485 next; 3. ls_in_pre_acl (ovn-northd.c:3269): ip, priority 100, uuid 7b4f4971 reg0[0] = 1; next; 5. ls_in_pre_stateful (ovn-northd.c:3396): reg0[0] == 1, priority 100, uuid 36cdd577 ct_next; ct_next(ct_state=new|trk) ------------------------- 6. ls_in_acl (ovn-northd.c:3759): ip && (!ct.est || (ct.est && ct_label.blocked == 1)), priority 1, uuid 7608af5b reg0[1] = 1; next; 10. ls_in_stateful (ovn-northd.c:3995): reg0[1] == 1, priority 100, uuid 2aba1b90 ct_commit(ct_label=0/0x1); next; 16. ls_in_l2_lkup (ovn-northd.c:4470): eth.dst == 00:00:00:b8:ca:43, priority 50, uuid 5c9c3c9f outport = \"ovn-default-ovn-cluster\"; output; ... diagnose {all|node} [nodename] \u8bca\u65ad\u96c6\u7fa4\u7f51\u7edc\u7ec4\u4ef6\u72b6\u6001\uff0c\u5e76\u53bb\u5bf9\u5e94\u8282\u70b9\u7684 kube-ovn-pinger \u68c0\u6d4b\u5f53\u524d\u8282\u70b9\u5230\u5176\u4ed6\u8282\u70b9\u548c\u5173\u952e\u670d\u52a1\u7684\u8fde\u901a\u6027\u548c\u7f51\u7edc\u5ef6\u8fdf\uff1a # kubectl ko diagnose all switch c7cd17e8-ceee-4a91-9bb3-e5a313fe1ece (snat) port snat-ovn-cluster type: router router-port: ovn-cluster-snat switch 20e0c6d0-023a-4756-aec5-200e0c60f95d (join) port node-liumengxin-ovn3-192.168.137.178 addresses: [\"00:00:00:64:FF:A8 100.64.0.4\"] port node-liumengxin-ovn1-192.168.137.176 addresses: [\"00:00:00:AF:98:62 100.64.0.2\"] port join-ovn-cluster type: router router-port: ovn-cluster-join switch 0191705c-f827-427b-9de3-3c3b7d971ba5 (central) port central-ovn-cluster type: router router-port: ovn-cluster-central switch 2a45ff05-388d-4f85-9daf-e6fccd5833dc (ovn-default) port ovn-default-ovn-cluster type: router router-port: ovn-cluster-ovn-default port prometheus-k8s-1.monitoring addresses: [\"00:00:00:AA:37:DF 10.16.0.23\"] router 212f73dd-d63d-4d72-864b-a537e9afbee1 (ovn-cluster) port ovn-cluster-snat mac: \"00:00:00:7A:82:8F\" networks: [\"172.22.0.1/16\"] port ovn-cluster-join mac: \"00:00:00:F8:18:5A\" networks: [\"100.64.0.1/16\"] port ovn-cluster-central mac: \"00:00:00:4D:8C:F5\" networks: [\"192.101.0.1/16\"] port ovn-cluster-ovn-default mac: \"00:00:00:A3:F8:18\" networks: [\"10.16.0.1/16\"] Routing Policies 31000 ip4.dst == 10.16.0.0/16 allow 31000 ip4.dst == 100.64.0.0/16 allow 30000 ip4.dst == 192.168.137.177 reroute 100.64.0.3 30000 ip4.dst == 192.168.137.178 reroute 100.64.0.4 29000 ip4.src == $ovn.default.fake.6_ip4 reroute 100.64.0.22 29000 ip4.src == $ovn.default.fake.7_ip4 reroute 100.64.0.21 29000 ip4.src == $ovn.default.fake.8_ip4 reroute 100.64.0.23 29000 ip4.src == $ovn.default.liumengxin.ovn3.192.168.137.178_ip4 reroute 100.64.0.4 20000 ip4.src == $ovn.default.liumengxin.ovn1.192.168.137.176_ip4 && ip4.dst != $ovn.cluster.overlay.subnets.IPv4 reroute 100.64.0.2 20000 ip4.src == $ovn.default.liumengxin.ovn2.192.168.137.177_ip4 && ip4.dst != $ovn.cluster.overlay.subnets.IPv4 reroute 100.64.0.3 20000 ip4.src == $ovn.default.liumengxin.ovn3.192.168.137.178_ip4 && ip4.dst != $ovn.cluster.overlay.subnets.IPv4 reroute 100.64.0.4 IPv4 Routes Route Table <main>: 0.0.0.0/0 100.64.0.1 dst-ip UUID LB PROTO VIP IPs e9bcfd9d-793e-4431-9073-6dec96b75d71 cluster-tcp-load tcp 10.100.209.132:10660 192.168.137.176:10660 tcp 10.101.239.192:6641 192.168.137.177:6641 tcp 10.101.240.101:3000 10.16.0.7:3000 tcp 10.103.184.186:6642 192.168.137.177:6642 35d2b7a5-e3a7-485a-a4b7-b4970eb0e63b cluster-tcp-sess tcp 10.100.158.128:8080 10.16.0.10:8080,10.16.0.5:8080,10.16.63.30:8080 tcp 10.107.26.215:8080 10.16.0.19:8080,10.16.0.20:8080,10.16.0.21:8080 tcp 10.107.26.215:9093 10.16.0.19:9093,10.16.0.20:9093,10.16.0.21:9093 tcp 10.98.187.99:8080 10.16.0.22:8080,10.16.0.23:8080 tcp 10.98.187.99:9090 10.16.0.22:9090,10.16.0.23:9090 f43303e4-89aa-4d3e-a3dc-278a552fe27b cluster-udp-load udp 10.96.0.10:53 10.16.0.4:53,10.16.0.9:53 _uuid : 06776304-5a96-43ed-90c4-c4854c251699 addresses : [] external_ids : {vendor=kube-ovn} name : node_liumengxin_ovn2_192.168.137.177_underlay_v6 _uuid : 62690625-87d5-491c-8675-9fd83b1f433c addresses : [] external_ids : {vendor=kube-ovn} name : node_liumengxin_ovn1_192.168.137.176_underlay_v6 _uuid : b03a9bae-94d5-4562-b34c-b5f6198e180b addresses : [\"10.16.0.0/16\", \"100.64.0.0/16\", \"172.22.0.0/16\", \"192.101.0.0/16\"] external_ids : {vendor=kube-ovn} name : ovn.cluster.overlay.subnets.IPv4 _uuid : e1056f3a-24cc-4666-8a91-75ee6c3c2426 addresses : [] external_ids : {vendor=kube-ovn} name : ovn.cluster.overlay.subnets.IPv6 _uuid : 3e5d5fff-e670-47b2-a2f5-a39f4698a8c5 addresses : [] external_ids : {vendor=kube-ovn} name : node_liumengxin_ovn3_192.168.137.178_underlay_v6 _uuid : 2d85dbdc-d0db-4abe-b19e-cc806d32b492 action : drop direction : from-lport external_ids : {} label : 0 log : false match : \"inport==@ovn.sg.kubeovn_deny_all && ip\" meter : [] name : [] options : {} priority : 2003 severity : [] _uuid : de790cc8-f155-405f-bb32-5a51f30c545f action : drop direction : to-lport external_ids : {} label : 0 log : false match : \"outport==@ovn.sg.kubeovn_deny_all && ip\" meter : [] name : [] options : {} priority : 2003 severity : [] Chassis \"e15ed4d4-1780-4d50-b09e-ea8372ed48b8\" hostname: liumengxin-ovn1-192.168.137.176 Encap stt ip: \"192.168.137.176\" options: {csum=\"true\"} Port_Binding node-liumengxin-ovn1-192.168.137.176 Port_Binding perf-6vxkn.default Port_Binding kube-state-metrics-5d6885d89-4nf8h.monitoring Port_Binding alertmanager-main-0.monitoring Port_Binding kube-ovn-pinger-6ftdf.kube-system Port_Binding fake-kubelet-67c55dfd89-pv86k.kube-system Port_Binding prometheus-k8s-0.monitoring Chassis \"eef07da1-f8ad-4775-b14d-bd6a3b4eb0d5\" hostname: liumengxin-ovn3-192.168.137.178 Encap stt ip: \"192.168.137.178\" options: {csum=\"true\"} Port_Binding kube-ovn-pinger-7twb4.kube-system Port_Binding prometheus-adapter-86df476d87-rl88g.monitoring Port_Binding prometheus-k8s-1.monitoring Port_Binding node-liumengxin-ovn3-192.168.137.178 Port_Binding perf-ff475.default Port_Binding alertmanager-main-1.monitoring Port_Binding blackbox-exporter-676d976865-tvsjd.monitoring Chassis \"efa253c9-494d-4719-83ae-b48ab0f11c03\" hostname: liumengxin-ovn2-192.168.137.177 Encap stt ip: \"192.168.137.177\" options: {csum=\"true\"} Port_Binding grafana-6c4c6b8fb7-pzd2c.monitoring Port_Binding node-liumengxin-ovn2-192.168.137.177 Port_Binding alertmanager-main-2.monitoring Port_Binding coredns-6789c94dd8-9jqsz.kube-system Port_Binding coredns-6789c94dd8-25d4r.kube-system Port_Binding prometheus-operator-7bbc99fc8b-wgjm4.monitoring Port_Binding prometheus-adapter-86df476d87-gdxmc.monitoring Port_Binding perf-fjnws.default Port_Binding kube-ovn-pinger-vh2xg.kube-system ds kube-proxy ready kube-proxy ready deployment ovn-central ready deployment kube-ovn-controller ready ds kube-ovn-cni ready ds ovs-ovn ready deployment coredns ready ovn-nb leader check ok ovn-sb leader check ok ovn-northd leader check ok ### kube-ovn-controller recent log ### start to diagnose node liumengxin-ovn1-192.168.137.176 #### ovn-controller log: 2022-06-03T00:56:44.897Z|16722|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T01:06:44.912Z|16723|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T01:16:44.925Z|16724|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T01:26:44.936Z|16725|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T01:36:44.959Z|16726|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T01:46:44.974Z|16727|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T01:56:44.988Z|16728|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T02:06:45.001Z|16729|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T02:16:45.025Z|16730|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T02:26:45.040Z|16731|inc_proc_eng|INFO|User triggered force recompute. #### ovs-vswitchd log: 2022-06-02T23:03:00.137Z|00079|dpif(handler1)|WARN|system@ovs-system: execute ct(commit,zone=14,label=0/0x1,nat(src)),8 failed (Invalid argument) on packet icmp,vlan_tci=0x0000,dl_src=00:00:00:f8:07:c8,dl_dst=00:00:00:fa:1e:50,nw_src=10.16.0.5,nw_dst=10.16.0.10,nw_tos=0,nw_ecn=0,nw_ttl=64,icmp_type=8,icmp_code=0 icmp_csum:f9d1 with metadata skb_priority(0),tunnel(tun_id=0x160017000004,src=192.168.137.177,dst=192.168.137.176,ttl=64,tp_src=38881,tp_dst=7471,flags(csum|key)),skb_mark(0),ct_state(0x21),ct_zone(0xe),ct_tuple4(src=10.16.0.5,dst=10.16.0.10,proto=1,tp_src=8,tp_dst=0),in_port(4) mtu 0 2022-06-02T23:23:31.840Z|00080|dpif(handler1)|WARN|system@ovs-system: execute ct(commit,zone=14,label=0/0x1,nat(src)),8 failed (Invalid argument) on packet icmp,vlan_tci=0x0000,dl_src=00:00:00:f8:07:c8,dl_dst=00:00:00:fa:1e:50,nw_src=10.16.0.5,nw_dst=10.16.0.10,nw_tos=0,nw_ecn=0,nw_ttl=64,icmp_type=8,icmp_code=0 icmp_csum:15b2 with metadata skb_priority(0),tunnel(tun_id=0x160017000004,src=192.168.137.177,dst=192.168.137.176,ttl=64,tp_src=38881,tp_dst=7471,flags(csum|key)),skb_mark(0),ct_state(0x21),ct_zone(0xe),ct_tuple4(src=10.16.0.5,dst=10.16.0.10,proto=1,tp_src=8,tp_dst=0),in_port(4) mtu 0 2022-06-03T00:09:15.659Z|00081|dpif(handler1)|WARN|system@ovs-system: execute ct(commit,zone=14,label=0/0x1,nat(src)),8 failed (Invalid argument) on packet icmp,vlan_tci=0x0000,dl_src=00:00:00:dc:e3:63,dl_dst=00:00:00:fa:1e:50,nw_src=10.16.63.30,nw_dst=10.16.0.10,nw_tos=0,nw_ecn=0,nw_ttl=64,icmp_type=8,icmp_code=0 icmp_csum:e5a5 with metadata skb_priority(0),tunnel(tun_id=0x150017000004,src=192.168.137.178,dst=192.168.137.176,ttl=64,tp_src=9239,tp_dst=7471,flags(csum|key)),skb_mark(0),ct_state(0x21),ct_zone(0xe),ct_tuple4(src=10.16.63.30,dst=10.16.0.10,proto=1,tp_src=8,tp_dst=0),in_port(4) mtu 0 2022-06-03T00:30:13.409Z|00064|dpif(handler2)|WARN|system@ovs-system: execute ct(commit,zone=14,label=0/0x1,nat(src)),8 failed (Invalid argument) on packet icmp,vlan_tci=0x0000,dl_src=00:00:00:f8:07:c8,dl_dst=00:00:00:fa:1e:50,nw_src=10.16.0.5,nw_dst=10.16.0.10,nw_tos=0,nw_ecn=0,nw_ttl=64,icmp_type=8,icmp_code=0 icmp_csum:6b4a with metadata skb_priority(0),tunnel(tun_id=0x160017000004,src=192.168.137.177,dst=192.168.137.176,ttl=64,tp_src=38881,tp_dst=7471,flags(csum|key)),skb_mark(0),ct_state(0x21),ct_zone(0xe),ct_tuple4(src=10.16.0.5,dst=10.16.0.10,proto=1,tp_src=8,tp_dst=0),in_port(4) mtu 0 2022-06-03T02:02:33.832Z|00082|dpif(handler1)|WARN|system@ovs-system: execute ct(commit,zone=14,label=0/0x1,nat(src)),8 failed (Invalid argument) on packet icmp,vlan_tci=0x0000,dl_src=00:00:00:f8:07:c8,dl_dst=00:00:00:fa:1e:50,nw_src=10.16.0.5,nw_dst=10.16.0.10,nw_tos=0,nw_ecn=0,nw_ttl=64,icmp_type=8,icmp_code=0 icmp_csum:a819 with metadata skb_priority(0),tunnel(tun_id=0x160017000004,src=192.168.137.177,dst=192.168.137.176,ttl=64,tp_src=38881,tp_dst=7471,flags(csum|key)),skb_mark(0),ct_state(0x21),ct_zone(0xe),ct_tuple4(src=10.16.0.5,dst=10.16.0.10,proto=1,tp_src=8,tp_dst=0),in_port(4) mtu 0 #### ovs-vsctl show results: 0d4c4675-c9cc-440a-8c1a-878e17f81b88 Bridge br-int fail_mode: secure datapath_type: system Port a2c1a8a8b83a_h Interface a2c1a8a8b83a_h Port \"4fa5c4cbb1a5_h\" Interface \"4fa5c4cbb1a5_h\" Port ovn-eef07d-0 Interface ovn-eef07d-0 type: stt options: {csum=\"true\", key=flow, remote_ip=\"192.168.137.178\"} Port ovn0 Interface ovn0 type: internal Port \"04d03360e9a0_h\" Interface \"04d03360e9a0_h\" Port eeb4d9e51b5d_h Interface eeb4d9e51b5d_h Port mirror0 Interface mirror0 type: internal Port \"8e5d887ccd80_h\" Interface \"8e5d887ccd80_h\" Port ovn-efa253-0 Interface ovn-efa253-0 type: stt options: {csum=\"true\", key=flow, remote_ip=\"192.168.137.177\"} Port \"17512d5be1f1_h\" Interface \"17512d5be1f1_h\" Port br-int Interface br-int type: internal ovs_version: \"2.17.2\" #### pinger diagnose results: I0603 10:35:04.349404 17619 pinger.go:19] ------------------------------------------------------------------------------- Kube-OVN: Version: v1.10.1 Build: 2022-04-24_08:02:50 Commit: git-73f9d15 Go Version: go1.17.8 Arch: amd64 ------------------------------------------------------------------------------- I0603 10:35:04.376797 17619 config.go:166] pinger config is &{KubeConfigFile: KubeClient:0xc000493380 Port:8080 DaemonSetNamespace:kube-system DaemonSetName:kube-ovn-pinger Interval:5 Mode:job ExitCode:0 InternalDNS:kubernetes.default ExternalDNS: NodeName:liumengxin-ovn1-192.168.137.176 HostIP:192.168.137.176 PodName:kube-ovn-pinger-6ftdf PodIP:10.16.0.10 PodProtocols:[IPv4] ExternalAddress: NetworkMode:kube-ovn PollTimeout:2 PollInterval:15 SystemRunDir:/var/run/openvswitch DatabaseVswitchName:Open_vSwitch DatabaseVswitchSocketRemote:unix:/var/run/openvswitch/db.sock DatabaseVswitchFileDataPath:/etc/openvswitch/conf.db DatabaseVswitchFileLogPath:/var/log/openvswitch/ovsdb-server.log DatabaseVswitchFilePidPath:/var/run/openvswitch/ovsdb-server.pid DatabaseVswitchFileSystemIDPath:/etc/openvswitch/system-id.conf ServiceVswitchdFileLogPath:/var/log/openvswitch/ovs-vswitchd.log ServiceVswitchdFilePidPath:/var/run/openvswitch/ovs-vswitchd.pid ServiceOvnControllerFileLogPath:/var/log/ovn/ovn-controller.log ServiceOvnControllerFilePidPath:/var/run/ovn/ovn-controller.pid} I0603 10:35:04.449166 17619 exporter.go:75] liumengxin-ovn1-192.168.137.176: exporter connect successfully I0603 10:35:04.554011 17619 ovn.go:21] ovs-vswitchd and ovsdb are up I0603 10:35:04.651293 17619 ovn.go:33] ovn_controller is up I0603 10:35:04.651342 17619 ovn.go:39] start to check port binding I0603 10:35:04.749613 17619 ovn.go:135] chassis id is 1d7f3d6c-eec5-4b3c-adca-2969d9cdfd80 I0603 10:35:04.763487 17619 ovn.go:49] port in sb is [node-liumengxin-ovn1-192.168.137.176 perf-6vxkn.default kube-state-metrics-5d6885d89-4nf8h.monitoring alertmanager-main-0.monitoring kube-ovn-pinger-6ftdf.kube-system fake-kubelet-67c55dfd89-pv86k.kube-system prometheus-k8s-0.monitoring] I0603 10:35:04.763583 17619 ovn.go:61] ovs and ovn-sb binding check passed I0603 10:35:05.049309 17619 ping.go:259] start to check apiserver connectivity I0603 10:35:05.053666 17619 ping.go:268] connect to apiserver success in 4.27ms I0603 10:35:05.053786 17619 ping.go:129] start to check pod connectivity I0603 10:35:05.249590 17619 ping.go:159] ping pod: kube-ovn-pinger-6ftdf 10.16.0.10, count: 3, loss count 0, average rtt 16.30ms I0603 10:35:05.354135 17619 ping.go:159] ping pod: kube-ovn-pinger-7twb4 10.16.63.30, count: 3, loss count 0, average rtt 1.81ms I0603 10:35:05.458460 17619 ping.go:159] ping pod: kube-ovn-pinger-vh2xg 10.16.0.5, count: 3, loss count 0, average rtt 1.92ms I0603 10:35:05.458523 17619 ping.go:83] start to check node connectivity tuning {install-fastpath|local-install-fastpath|remove-fastpath|install-stt|local-install-stt|remove-stt} {centos7|centos8}} [kernel-devel-version] \u8be5\u547d\u4ee4\u6267\u884c\u6027\u80fd\u8c03\u4f18\u76f8\u5173\u64cd\u4f5c\uff0c\u5177\u4f53\u4f7f\u7528\u8bf7\u53c2\u8003 \u6027\u80fd\u8c03\u4f18 reload \u8be5\u547d\u4ee4\u91cd\u542f\u6240\u6709 Kube-OVN \u76f8\u5173\u7ec4\u4ef6 # kubectl ko reload pod \"ovn-central-8684dd94bd-vzgcr\" deleted Waiting for deployment \"ovn-central\" rollout to finish: 0 of 1 updated replicas are available... deployment \"ovn-central\" successfully rolled out pod \"ovs-ovn-bsnvz\" deleted pod \"ovs-ovn-m9b98\" deleted pod \"kube-ovn-controller-8459db5ff4-64c62\" deleted Waiting for deployment \"kube-ovn-controller\" rollout to finish: 0 of 1 updated replicas are available... deployment \"kube-ovn-controller\" successfully rolled out pod \"kube-ovn-cni-2klnh\" deleted pod \"kube-ovn-cni-t2jz4\" deleted Waiting for daemon set \"kube-ovn-cni\" rollout to finish: 0 of 2 updated pods are available... Waiting for daemon set \"kube-ovn-cni\" rollout to finish: 1 of 2 updated pods are available... daemon set \"kube-ovn-cni\" successfully rolled out pod \"kube-ovn-pinger-ln72z\" deleted pod \"kube-ovn-pinger-w8lrk\" deleted Waiting for daemon set \"kube-ovn-pinger\" rollout to finish: 0 of 2 updated pods are available... Waiting for daemon set \"kube-ovn-pinger\" rollout to finish: 1 of 2 updated pods are available... daemon set \"kube-ovn-pinger\" successfully rolled out pod \"kube-ovn-monitor-7fb67d5488-7q6zb\" deleted Waiting for deployment \"kube-ovn-monitor\" rollout to finish: 0 of 1 updated replicas are available... deployment \"kube-ovn-monitor\" successfully rolled out","title":"kubectl \u63d2\u4ef6\u4f7f\u7528"},{"location":"ops/kubectl-ko/#kubectl","text":"\u4e3a\u4e86\u65b9\u4fbf\u65e5\u5e38\u7684\u8fd0\u7ef4\u64cd\u4f5c\uff0cKube-OVN \u63d0\u4f9b\u4e86 kubectl \u63d2\u4ef6\u5de5\u5177\uff0c\u7f51\u7edc\u7ba1\u7406\u5458 \u53ef\u4ee5\u901a\u8fc7\u8be5\u547d\u4ee4\u8fdb\u884c\u65e5\u5e38\u64cd\u4f5c\uff0c\u4f8b\u5982\uff1a\u67e5\u770b OVN \u6570\u636e\u5e93\u4fe1\u606f\u548c\u72b6\u6001\uff0cOVN \u6570\u636e\u5e93 \u5907\u4efd\u548c\u6062\u590d\uff0cOVS \u76f8\u5173\u4fe1\u606f\u67e5\u770b\uff0ctcpdump \u7279\u5b9a\u5bb9\u5668\uff0c\u7279\u5b9a\u94fe\u8def\u903b\u8f91\u62d3\u6251\u5c55\u793a\uff0c \u7f51\u7edc\u95ee\u9898\u8bca\u65ad\u548c\u6027\u80fd\u4f18\u5316\u3002","title":"kubectl \u63d2\u4ef6\u4f7f\u7528"},{"location":"ops/kubectl-ko/#_1","text":"Kube-OVN \u5b89\u88c5\u65f6\u9ed8\u8ba4\u4f1a\u90e8\u7f72\u63d2\u4ef6\u5230\u6bcf\u4e2a\u8282\u70b9\uff0c\u82e5\u6267\u884c kubectl \u7684\u673a\u5668\u4e0d\u5728\u96c6\u7fa4\u5185\uff0c \u6216\u9700\u8981\u91cd\u88c5\u63d2\u4ef6\uff0c\u53ef\u53c2\u8003\u4e0b\u9762\u7684\u6b65\u9aa4\uff1a \u4e0b\u8f7d kubectl-ko \u6587\u4ef6\uff1a wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/dist/images/kubectl-ko \u5c06\u8be5\u6587\u4ef6\u79fb\u52a8\u81f3 $PATH \u76ee\u5f55\u4e0b\uff1a mv kubectl-ko /usr/local/bin/kubectl-ko \u589e\u52a0\u53ef\u6267\u884c\u6743\u9650\uff1a chmod +x /usr/local/bin/kubectl-ko \u68c0\u67e5\u63d2\u4ef6\u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u4f7f\u7528\uff1a # kubectl plugin list The following compatible plugins are available: /usr/local/bin/kubectl-ko","title":"\u63d2\u4ef6\u5b89\u88c5"},{"location":"ops/kubectl-ko/#_2","text":"\u8fd0\u884c kubectl ko \u4f1a\u5c55\u793a\u8be5\u63d2\u4ef6\u6240\u6709\u53ef\u7528\u7684\u547d\u4ee4\u548c\u7528\u6cd5\u63cf\u8ff0\uff0c\u5982\u4e0b\u6240\u793a\uff1a # kubectl ko kubectl ko {subcommand} [option...] Available Subcommands: [nb|sb] [status|kick|backup|dbstatus|restore] ovn-db operations show cluster status, kick stale server, backup database, get db consistency status or restore ovn nb db when met 'inconsistent data' error nbctl [ovn-nbctl options ...] invoke ovn-nbctl sbctl [ovn-sbctl options ...] invoke ovn-sbctl vsctl {nodeName} [ovs-vsctl options ...] invoke ovs-vsctl on the specified node ofctl {nodeName} [ovs-ofctl options ...] invoke ovs-ofctl on the specified node dpctl {nodeName} [ovs-dpctl options ...] invoke ovs-dpctl on the specified node appctl {nodeName} [ovs-appctl options ...] invoke ovs-appctl on the specified node tcpdump {namespace/podname} [tcpdump options ...] capture pod traffic trace {namespace/podname} {target ip address} {icmp|tcp|udp} [target tcp or udp port] trace ovn microflow of specific packet diagnose {all|node} [nodename] diagnose connectivity of all nodes or a specific node tuning {install-fastpath|local-install-fastpath|remove-fastpath|install-stt|local-install-stt|remove-stt} {centos7|centos8}} [kernel-devel-version] deploy kernel optimisation components to the system reload restart all kube-ovn components \u4e0b\u9762\u5c06\u4ecb\u7ecd\u6bcf\u4e2a\u547d\u4ee4\u7684\u5177\u4f53\u529f\u80fd\u548c\u4f7f\u7528\u3002","title":"\u63d2\u4ef6\u4f7f\u7528"},{"location":"ops/kubectl-ko/#nb-sb-status-kick-backup-dbstatus-restore","text":"\u8be5\u5b50\u547d\u4ee4\u4e3b\u8981\u5bf9 OVN \u5317\u5411\u6216\u5357\u5411\u6570\u636e\u5e93\u8fdb\u884c\u64cd\u4f5c\uff0c\u5305\u62ec\u6570\u636e\u5e93\u96c6\u7fa4\u72b6\u6001\u67e5\u770b\uff0c\u6570\u636e\u5e93\u8282\u70b9\u4e0b\u7ebf\uff0c \u6570\u636e\u5e93\u5907\u4efd\uff0c\u6570\u636e\u5e93\u5b58\u50a8\u72b6\u6001\u67e5\u770b\u548c\u6570\u636e\u5e93\u4fee\u590d\u3002","title":"[nb | sb] [status | kick | backup | dbstatus | restore]"},{"location":"ops/kubectl-ko/#_3","text":"\u8be5\u547d\u4ee4\u4f1a\u5728\u5bf9\u5e94 OVN \u6570\u636e\u5e93\u7684 leader \u8282\u70b9\u6267\u884c ovs-appctl cluster/status \u5c55\u793a\u96c6\u7fa4\u72b6\u6001: # kubectl ko nb status 306b Name: OVN_Northbound Cluster ID: 9a87 (9a872522-3e7d-47ca-83a3-d74333e1a7ca) Server ID: 306b (306b256b-b5e1-4eb0-be91-4ca96adf6bad) Address: tcp:[172.18.0.2]:6643 Status: cluster member Role: leader Term: 1 Leader: self Vote: self Last Election started 280309 ms ago, reason: timeout Last Election won: 280309 ms ago Election timer: 5000 Log: [139, 139] Entries not yet committed: 0 Entries not yet applied: 0 Connections: <-8723 ->8723 <-85d6 ->85d6 Disconnections: 0 Servers: 85d6 (85d6 at tcp:[172.18.0.4]:6643) next_index=139 match_index=138 last msg 763 ms ago 8723 (8723 at tcp:[172.18.0.3]:6643) next_index=139 match_index=138 last msg 763 ms ago 306b (306b at tcp:[172.18.0.2]:6643) (self) next_index=2 match_index=138 status: ok \u82e5 Server \u4e0b\u7684 match_index \u51fa\u73b0\u8f83\u5927\u5dee\u522b\uff0c\u4e14 last msg \u65f6\u95f4\u8f83\u957f\u5219\u5bf9\u5e94 Server \u53ef\u80fd\u957f\u65f6\u95f4\u6ca1\u6709\u54cd\u5e94\uff0c \u9700\u8981\u8fdb\u4e00\u6b65\u67e5\u770b\u3002","title":"\u6570\u636e\u5e93\u96c6\u7fa4\u72b6\u6001\u67e5\u770b"},{"location":"ops/kubectl-ko/#_4","text":"\u8be5\u547d\u4ee4\u4f1a\u5c06\u67d0\u4e2a\u8282\u70b9\u4ece OVN \u6570\u636e\u5e93\u4e2d\u79fb\u9664\uff0c\u5728\u8282\u70b9\u4e0b\u7ebf\u6216\u66f4\u6362\u8282\u70b9\u65f6\u9700\u8981\u7528\u5230\u3002 \u4e0b\u9762\u5c06\u4ee5\u4e0a\u4e00\u6761\u547d\u4ee4\u6240\u67e5\u770b\u5230\u7684\u96c6\u7fa4\u72b6\u6001\u4e3a\u4f8b\uff0c\u4e0b\u7ebf 172.18.0.3 \u8282\u70b9: # kubectl ko nb kick 8723 started removal \u518d\u6b21\u67e5\u770b\u6570\u636e\u5e93\u96c6\u7fa4\u72b6\u6001\u786e\u8ba4\u8282\u70b9\u5df2\u79fb\u9664\uff1a # kubectl ko nb status 306b Name: OVN_Northbound Cluster ID: 9a87 (9a872522-3e7d-47ca-83a3-d74333e1a7ca) Server ID: 306b (306b256b-b5e1-4eb0-be91-4ca96adf6bad) Address: tcp:[172.18.0.2]:6643 Status: cluster member Role: leader Term: 1 Leader: self Vote: self Last Election started 324356 ms ago, reason: timeout Last Election won: 324356 ms ago Election timer: 5000 Log: [140, 140] Entries not yet committed: 0 Entries not yet applied: 0 Connections: <-85d6 ->85d6 Disconnections: 2 Servers: 85d6 (85d6 at tcp:[172.18.0.4]:6643) next_index=140 match_index=139 last msg 848 ms ago 306b (306b at tcp:[172.18.0.2]:6643) (self) next_index=2 match_index=139 status: ok","title":"\u6570\u636e\u5e93\u8282\u70b9\u4e0b\u7ebf"},{"location":"ops/kubectl-ko/#_5","text":"\u8be5\u5b50\u547d\u4ee4\u4f1a\u5907\u4efd\u5f53\u524d OVN \u6570\u636e\u5e93\u81f3\u672c\u5730\uff0c\u53ef\u7528\u4e8e\u707e\u5907\u548c\u6062\u590d\uff1a # kubectl ko nb backup tar: Removing leading `/' from member names backup ovn-nb db to /root/ovnnb_db.060223191654183154.backup","title":"\u6570\u636e\u5e93\u5907\u4efd"},{"location":"ops/kubectl-ko/#_6","text":"\u8be5\u547d\u4ee4\u7528\u6765\u67e5\u770b\u6570\u636e\u5e93\u6587\u4ef6\u662f\u5426\u5b58\u5728\u635f\u574f\uff1a # kubectl ko nb dbstatus status: ok \u82e5\u5f02\u5e38\u5219\u663e\u793a inconsistent data \u9700\u8981\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c\u4fee\u590d\u3002","title":"\u6570\u636e\u5e93\u5b58\u50a8\u72b6\u6001\u67e5\u770b"},{"location":"ops/kubectl-ko/#_7","text":"\u82e5\u6570\u636e\u5e93\u72b6\u6001\u8fdb\u5165 inconsistent data \u53ef\u4f7f\u7528\u8be5\u547d\u4ee4\u8fdb\u884c\u4fee\u590d\uff1a # kubectl ko nb restore deployment.apps/ovn-central scaled ovn-central original replicas is 3 first nodeIP is 172.18.0.5 ovs-ovn pod on node 172.18.0.5 is ovs-ovn-8jxv9 ovs-ovn pod on node 172.18.0.3 is ovs-ovn-sjzb6 ovs-ovn pod on node 172.18.0.4 is ovs-ovn-t87zk backup nb db file restore nb db file, operate in pod ovs-ovn-8jxv9 deployment.apps/ovn-central scaled finish restore nb db file and ovn-central replicas recreate ovs-ovn pods pod \"ovs-ovn-8jxv9\" deleted pod \"ovs-ovn-sjzb6\" deleted pod \"ovs-ovn-t87zk\" deleted","title":"\u6570\u636e\u5e93\u4fee\u590d"},{"location":"ops/kubectl-ko/#nbctl-sbctl-options","text":"\u8be5\u5b50\u547d\u4ee4\u4f1a\u76f4\u63a5\u8fdb\u5165 OVN \u5317\u5411\u6570\u636e\u5e93\u6216\u5357\u5411\u6570\u636e\u5e93 \u7684 leader \u8282\u70b9\u5206\u522b\u6267\u884c ovn-nbctl \u548c ovn-sbctl \u547d\u4ee4\u3002 \u66f4\u591a\u8be5\u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u8bf7\u67e5\u8be2\u4e0a\u6e38 OVN \u7684\u5b98\u65b9\u6587\u6863 ovn-nbctl(8) \u548c ovn-sbctl(8) \u3002 # kubectl ko nbctl show switch c7cd17e8-ceee-4a91-9bb3-e5a313fe1ece (snat) port snat-ovn-cluster type: router router-port: ovn-cluster-snat switch 20e0c6d0-023a-4756-aec5-200e0c60f95d (join) port node-liumengxin-ovn3-192.168.137.178 addresses: [\"00:00:00:64:FF:A8 100.64.0.4\"] port node-liumengxin-ovn1-192.168.137.176 addresses: [\"00:00:00:AF:98:62 100.64.0.2\"] port node-liumengxin-ovn2-192.168.137.177 addresses: [\"00:00:00:D9:58:B8 100.64.0.3\"] port join-ovn-cluster type: router router-port: ovn-cluster-join switch 0191705c-f827-427b-9de3-3c3b7d971ba5 (central) port central-ovn-cluster type: router router-port: ovn-cluster-central switch 2a45ff05-388d-4f85-9daf-e6fccd5833dc (ovn-default) port alertmanager-main-0.monitoring addresses: [\"00:00:00:6C:DF:A3 10.16.0.19\"] port kube-state-metrics-5d6885d89-4nf8h.monitoring addresses: [\"00:00:00:6F:02:1C 10.16.0.15\"] port fake-kubelet-67c55dfd89-pv86k.kube-system addresses: [\"00:00:00:5C:12:E8 10.16.19.177\"] port ovn-default-ovn-cluster type: router router-port: ovn-cluster-ovn-default router 212f73dd-d63d-4d72-864b-a537e9afbee1 (ovn-cluster) port ovn-cluster-snat mac: \"00:00:00:7A:82:8F\" networks: [\"172.22.0.1/16\"] port ovn-cluster-join mac: \"00:00:00:F8:18:5A\" networks: [\"100.64.0.1/16\"] port ovn-cluster-central mac: \"00:00:00:4D:8C:F5\" networks: [\"192.101.0.1/16\"] port ovn-cluster-ovn-default mac: \"00:00:00:A3:F8:18\" networks: [\"10.16.0.1/16\"]","title":"[nbctl | sbctl] [options ...]"},{"location":"ops/kubectl-ko/#vsctl-nodename-options","text":"\u8be5\u547d\u4ee4\u4f1a\u8fdb\u5165\u5bf9\u5e94 nodeName \u4e0a\u7684 ovs-ovn \u5bb9\u5668\uff0c\u5e76\u6267\u884c\u76f8\u5e94\u7684 ovs-vsctl \u547d\u4ee4\uff0c\u67e5\u8be2\u5e76\u914d\u7f6e vswitchd \u3002 \u66f4\u591a\u8be5\u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u8bf7\u67e5\u8be2\u4e0a\u6e38 OVS \u7684\u5b98\u65b9\u6587\u6863 ovs-vsctl(8) \u3002 # kubectl ko vsctl kube-ovn-01 show 0d4c4675-c9cc-440a-8c1a-878e17f81b88 Bridge br-int fail_mode: secure datapath_type: system Port a2c1a8a8b83a_h Interface a2c1a8a8b83a_h Port \"4fa5c4cbb1a5_h\" Interface \"4fa5c4cbb1a5_h\" Port ovn-eef07d-0 Interface ovn-eef07d-0 type: stt options: {csum=\"true\", key=flow, remote_ip=\"192.168.137.178\"} Port ovn0 Interface ovn0 type: internal Port mirror0 Interface mirror0 type: internal Port ovn-efa253-0 Interface ovn-efa253-0 type: stt options: {csum=\"true\", key=flow, remote_ip=\"192.168.137.177\"} Port br-int Interface br-int type: internal ovs_version: \"2.17.2\"","title":"vsctl {nodeName} [options ...]"},{"location":"ops/kubectl-ko/#ofctl-nodename-options","text":"\u8be5\u547d\u4ee4\u4f1a\u8fdb\u5165\u5bf9\u5e94 nodeName \u4e0a\u7684 ovs-ovn \u5bb9\u5668\uff0c\u5e76\u6267\u884c\u76f8\u5e94\u7684 ovs-ofctl \u547d\u4ee4\uff0c\u67e5\u8be2\u6216\u7ba1\u7406 OpenFlow\u3002 \u66f4\u591a\u8be5\u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u8bf7\u67e5\u8be2\u4e0a\u6e38 OVS \u7684\u5b98\u65b9\u6587\u6863 ovs-ofctl(8) \u3002 # kubectl ko ofctl kube-ovn-01 dump-flows br-int NXST_FLOW reply (xid=0x4): flags=[more] cookie=0xcf3429e6, duration=671791.432s, table=0, n_packets=0, n_bytes=0, idle_age=65534, hard_age=65534, priority=100,in_port=2 actions=load:0x4->NXM_NX_REG13[],load:0x9->NXM_NX_REG11[],load:0xb->NXM_NX_REG12[],load:0x4->OXM_OF_METADATA[],load:0x1->NXM_NX_REG14[],resubmit(,8) cookie=0xc91413c6, duration=671791.431s, table=0, n_packets=907489, n_bytes=99978275, idle_age=0, hard_age=65534, priority=100,in_port=7 actions=load:0x1->NXM_NX_REG13[],load:0x9->NXM_NX_REG11[],load:0xb->NXM_NX_REG12[],load:0x4->OXM_OF_METADATA[],load:0x4->NXM_NX_REG14[],resubmit(,8) cookie=0xf180459, duration=671791.431s, table=0, n_packets=17348582, n_bytes=2667811214, idle_age=0, hard_age=65534, priority=100,in_port=6317 actions=load:0xa->NXM_NX_REG13[],load:0x9->NXM_NX_REG11[],load:0xb->NXM_NX_REG12[],load:0x4->OXM_OF_METADATA[],load:0x9->NXM_NX_REG14[],resubmit(,8) cookie=0x7806dd90, duration=671791.431s, table=0, n_packets=3235428, n_bytes=833821312, idle_age=0, hard_age=65534, priority=100,in_port=1 actions=load:0xd->NXM_NX_REG13[],load:0x9->NXM_NX_REG11[],load:0xb->NXM_NX_REG12[],load:0x4->OXM_OF_METADATA[],load:0x3->NXM_NX_REG14[],resubmit(,8) ...","title":"ofctl {nodeName} [options ...]"},{"location":"ops/kubectl-ko/#dpctl-nodename-options","text":"\u8be5\u547d\u4ee4\u4f1a\u8fdb\u5165\u5bf9\u5e94 nodeName \u4e0a\u7684 ovs-ovn \u5bb9\u5668\uff0c\u5e76\u6267\u884c\u76f8\u5e94\u7684 ovs-dpctl \u547d\u4ee4\uff0c\u67e5\u8be2\u6216\u7ba1\u7406 OVS datapath\u3002 \u66f4\u591a\u8be5\u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u8bf7\u67e5\u8be2\u4e0a\u6e38 OVS \u7684\u5b98\u65b9\u6587\u6863 ovs-dpctl(8) \u3002 # kubectl ko dpctl kube-ovn-01 show system@ovs-system: lookups: hit:350805055 missed:21983648 lost:73 flows: 105 masks: hit:1970748791 total:22 hit/pkt:5.29 port 0: ovs-system (internal) port 1: ovn0 (internal) port 2: mirror0 (internal) port 3: br-int (internal) port 4: stt_sys_7471 (stt: packet_type=ptap) port 5: eeb4d9e51b5d_h port 6: a2c1a8a8b83a_h port 7: 4fa5c4cbb1a5_h","title":"dpctl {nodeName} [options ...]"},{"location":"ops/kubectl-ko/#appctl-nodename-options","text":"\u8be5\u547d\u4ee4\u4f1a\u8fdb\u5165\u5bf9\u5e94 nodeName \u4e0a\u7684 ovs-ovn \u5bb9\u5668\uff0c\u5e76\u6267\u884c\u76f8\u5e94\u7684 ovs-appctl \u547d\u4ee4\uff0c\u6765\u64cd\u4f5c\u76f8\u5173 daemon \u8fdb\u7a0b\u3002 \u66f4\u591a\u8be5\u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u8bf7\u67e5\u8be2\u4e0a\u6e38 OVS \u7684\u5b98\u65b9\u6587\u6863 ovs-appctl(8) \u3002 # kubectl ko appctl kube-ovn-01 vlog/list console syslog file ------- ------ ------ backtrace OFF ERR INFO bfd OFF ERR INFO bond OFF ERR INFO bridge OFF ERR INFO bundle OFF ERR INFO bundles OFF ERR INFO ...","title":"appctl {nodeName} [options ...]"},{"location":"ops/kubectl-ko/#tcpdump-namespacepodname-tcpdump-options","text":"\u8be5\u547d\u4ee4\u4f1a\u8fdb\u5165 namespace/podname \u6240\u5728\u673a\u5668\u7684 kube-ovn-cni \u5bb9\u5668\uff0c\u5e76\u6267\u884c tcpdump \u6293\u53d6\u5bf9\u5e94\u5bb9\u5668 veth \u7f51\u5361 \u7aef\u7684\u6d41\u91cf\uff0c\u53ef\u4ee5\u65b9\u4fbf\u6392\u67e5\u7f51\u7edc\u76f8\u5173\u95ee\u9898\uff0c\u5982\u4e0b\u6240\u793a\uff1a # kubectl ko tcpdump default/ds1-l6n7p icmp + kubectl exec -it kube-ovn-cni-wlg4s -n kube-ovn -- tcpdump -nn -i d7176fe7b4e0_h icmp tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on d7176fe7b4e0_h, link-type EN10MB (Ethernet), capture size 262144 bytes 06:52:36.619688 IP 100.64.0.3 > 10.16.0.4: ICMP echo request, id 2, seq 1, length 64 06:52:36.619746 IP 10.16.0.4 > 100.64.0.3: ICMP echo reply, id 2, seq 1, length 64 06:52:37.619588 IP 100.64.0.3 > 10.16.0.4: ICMP echo request, id 2, seq 2, length 64 06:52:37.619630 IP 10.16.0.4 > 100.64.0.3: ICMP echo reply, id 2, seq 2, length 64 06:52:38.619933 IP 100.64.0.3 > 10.16.0.4: ICMP echo request, id 2, seq 3, length 64 06:52:38.619973 IP 10.16.0.4 > 100.64.0.3: ICMP echo reply, id 2, seq 3, length 64","title":"tcpdump {namespace/podname} [tcpdump options ...]"},{"location":"ops/kubectl-ko/#trace-namespacepodname-target-ip-address-icmptcpudp-target-tcp-or-udp-port","text":"\u8be5\u547d\u4ee4\u5c06\u4f1a\u6253\u5370 Pod \u901a\u8fc7\u7279\u5b9a\u534f\u8bae\u8bbf\u95ee\u67d0\u5730\u5740\u65f6\u5bf9\u5e94\u7684 OVN \u903b\u8f91\u6d41\u8868\u548c\u6700\u7ec8\u7684 Openflow \u6d41\u8868\uff0c \u65b9\u4fbf\u5f00\u53d1\u6216\u8fd0\u7ef4\u65f6\u5b9a\u4f4d\u6d41\u8868\u76f8\u5173\u95ee\u9898\u3002 # kubectl ko trace default/ds1-l6n7p 8.8.8.8 icmp + kubectl exec ovn-central-5bc494cb5-np9hm -n kube-ovn -- ovn-trace --ct=new ovn-default 'inport == \"ds1-l6n7p.default\" && ip.ttl == 64 && icmp && eth.src == 0a:00:00:10:00:05 && ip4.src == 10.16.0.4 && eth.dst == 00:00:00:B8:CA:43 && ip4.dst == 8.8.8.8' # icmp,reg14=0xf,vlan_tci=0x0000,dl_src=0a:00:00:10:00:05,dl_dst=00:00:00:b8:ca:43,nw_src=10.16.0.4,nw_dst=8.8.8.8,nw_tos=0,nw_ecn=0,nw_ttl=64,icmp_type=0,icmp_code=0 ingress(dp=\"ovn-default\", inport=\"ds1-l6n7p.default\") ----------------------------------------------------- 0. ls_in_port_sec_l2 (ovn-northd.c:4143): inport == \"ds1-l6n7p.default\" && eth.src == {0a:00:00:10:00:05}, priority 50, uuid 39453393 next; 1. ls_in_port_sec_ip (ovn-northd.c:2898): inport == \"ds1-l6n7p.default\" && eth.src == 0a:00:00:10:00:05 && ip4.src == {10.16.0.4}, priority 90, uuid 81bcd485 next; 3. ls_in_pre_acl (ovn-northd.c:3269): ip, priority 100, uuid 7b4f4971 reg0[0] = 1; next; 5. ls_in_pre_stateful (ovn-northd.c:3396): reg0[0] == 1, priority 100, uuid 36cdd577 ct_next; ct_next(ct_state=new|trk) ------------------------- 6. ls_in_acl (ovn-northd.c:3759): ip && (!ct.est || (ct.est && ct_label.blocked == 1)), priority 1, uuid 7608af5b reg0[1] = 1; next; 10. ls_in_stateful (ovn-northd.c:3995): reg0[1] == 1, priority 100, uuid 2aba1b90 ct_commit(ct_label=0/0x1); next; 16. ls_in_l2_lkup (ovn-northd.c:4470): eth.dst == 00:00:00:b8:ca:43, priority 50, uuid 5c9c3c9f outport = \"ovn-default-ovn-cluster\"; output; ...","title":"trace {namespace/podname} {target ip address} {icmp|tcp|udp} [target tcp or udp port]"},{"location":"ops/kubectl-ko/#diagnose-allnode-nodename","text":"\u8bca\u65ad\u96c6\u7fa4\u7f51\u7edc\u7ec4\u4ef6\u72b6\u6001\uff0c\u5e76\u53bb\u5bf9\u5e94\u8282\u70b9\u7684 kube-ovn-pinger \u68c0\u6d4b\u5f53\u524d\u8282\u70b9\u5230\u5176\u4ed6\u8282\u70b9\u548c\u5173\u952e\u670d\u52a1\u7684\u8fde\u901a\u6027\u548c\u7f51\u7edc\u5ef6\u8fdf\uff1a # kubectl ko diagnose all switch c7cd17e8-ceee-4a91-9bb3-e5a313fe1ece (snat) port snat-ovn-cluster type: router router-port: ovn-cluster-snat switch 20e0c6d0-023a-4756-aec5-200e0c60f95d (join) port node-liumengxin-ovn3-192.168.137.178 addresses: [\"00:00:00:64:FF:A8 100.64.0.4\"] port node-liumengxin-ovn1-192.168.137.176 addresses: [\"00:00:00:AF:98:62 100.64.0.2\"] port join-ovn-cluster type: router router-port: ovn-cluster-join switch 0191705c-f827-427b-9de3-3c3b7d971ba5 (central) port central-ovn-cluster type: router router-port: ovn-cluster-central switch 2a45ff05-388d-4f85-9daf-e6fccd5833dc (ovn-default) port ovn-default-ovn-cluster type: router router-port: ovn-cluster-ovn-default port prometheus-k8s-1.monitoring addresses: [\"00:00:00:AA:37:DF 10.16.0.23\"] router 212f73dd-d63d-4d72-864b-a537e9afbee1 (ovn-cluster) port ovn-cluster-snat mac: \"00:00:00:7A:82:8F\" networks: [\"172.22.0.1/16\"] port ovn-cluster-join mac: \"00:00:00:F8:18:5A\" networks: [\"100.64.0.1/16\"] port ovn-cluster-central mac: \"00:00:00:4D:8C:F5\" networks: [\"192.101.0.1/16\"] port ovn-cluster-ovn-default mac: \"00:00:00:A3:F8:18\" networks: [\"10.16.0.1/16\"] Routing Policies 31000 ip4.dst == 10.16.0.0/16 allow 31000 ip4.dst == 100.64.0.0/16 allow 30000 ip4.dst == 192.168.137.177 reroute 100.64.0.3 30000 ip4.dst == 192.168.137.178 reroute 100.64.0.4 29000 ip4.src == $ovn.default.fake.6_ip4 reroute 100.64.0.22 29000 ip4.src == $ovn.default.fake.7_ip4 reroute 100.64.0.21 29000 ip4.src == $ovn.default.fake.8_ip4 reroute 100.64.0.23 29000 ip4.src == $ovn.default.liumengxin.ovn3.192.168.137.178_ip4 reroute 100.64.0.4 20000 ip4.src == $ovn.default.liumengxin.ovn1.192.168.137.176_ip4 && ip4.dst != $ovn.cluster.overlay.subnets.IPv4 reroute 100.64.0.2 20000 ip4.src == $ovn.default.liumengxin.ovn2.192.168.137.177_ip4 && ip4.dst != $ovn.cluster.overlay.subnets.IPv4 reroute 100.64.0.3 20000 ip4.src == $ovn.default.liumengxin.ovn3.192.168.137.178_ip4 && ip4.dst != $ovn.cluster.overlay.subnets.IPv4 reroute 100.64.0.4 IPv4 Routes Route Table <main>: 0.0.0.0/0 100.64.0.1 dst-ip UUID LB PROTO VIP IPs e9bcfd9d-793e-4431-9073-6dec96b75d71 cluster-tcp-load tcp 10.100.209.132:10660 192.168.137.176:10660 tcp 10.101.239.192:6641 192.168.137.177:6641 tcp 10.101.240.101:3000 10.16.0.7:3000 tcp 10.103.184.186:6642 192.168.137.177:6642 35d2b7a5-e3a7-485a-a4b7-b4970eb0e63b cluster-tcp-sess tcp 10.100.158.128:8080 10.16.0.10:8080,10.16.0.5:8080,10.16.63.30:8080 tcp 10.107.26.215:8080 10.16.0.19:8080,10.16.0.20:8080,10.16.0.21:8080 tcp 10.107.26.215:9093 10.16.0.19:9093,10.16.0.20:9093,10.16.0.21:9093 tcp 10.98.187.99:8080 10.16.0.22:8080,10.16.0.23:8080 tcp 10.98.187.99:9090 10.16.0.22:9090,10.16.0.23:9090 f43303e4-89aa-4d3e-a3dc-278a552fe27b cluster-udp-load udp 10.96.0.10:53 10.16.0.4:53,10.16.0.9:53 _uuid : 06776304-5a96-43ed-90c4-c4854c251699 addresses : [] external_ids : {vendor=kube-ovn} name : node_liumengxin_ovn2_192.168.137.177_underlay_v6 _uuid : 62690625-87d5-491c-8675-9fd83b1f433c addresses : [] external_ids : {vendor=kube-ovn} name : node_liumengxin_ovn1_192.168.137.176_underlay_v6 _uuid : b03a9bae-94d5-4562-b34c-b5f6198e180b addresses : [\"10.16.0.0/16\", \"100.64.0.0/16\", \"172.22.0.0/16\", \"192.101.0.0/16\"] external_ids : {vendor=kube-ovn} name : ovn.cluster.overlay.subnets.IPv4 _uuid : e1056f3a-24cc-4666-8a91-75ee6c3c2426 addresses : [] external_ids : {vendor=kube-ovn} name : ovn.cluster.overlay.subnets.IPv6 _uuid : 3e5d5fff-e670-47b2-a2f5-a39f4698a8c5 addresses : [] external_ids : {vendor=kube-ovn} name : node_liumengxin_ovn3_192.168.137.178_underlay_v6 _uuid : 2d85dbdc-d0db-4abe-b19e-cc806d32b492 action : drop direction : from-lport external_ids : {} label : 0 log : false match : \"inport==@ovn.sg.kubeovn_deny_all && ip\" meter : [] name : [] options : {} priority : 2003 severity : [] _uuid : de790cc8-f155-405f-bb32-5a51f30c545f action : drop direction : to-lport external_ids : {} label : 0 log : false match : \"outport==@ovn.sg.kubeovn_deny_all && ip\" meter : [] name : [] options : {} priority : 2003 severity : [] Chassis \"e15ed4d4-1780-4d50-b09e-ea8372ed48b8\" hostname: liumengxin-ovn1-192.168.137.176 Encap stt ip: \"192.168.137.176\" options: {csum=\"true\"} Port_Binding node-liumengxin-ovn1-192.168.137.176 Port_Binding perf-6vxkn.default Port_Binding kube-state-metrics-5d6885d89-4nf8h.monitoring Port_Binding alertmanager-main-0.monitoring Port_Binding kube-ovn-pinger-6ftdf.kube-system Port_Binding fake-kubelet-67c55dfd89-pv86k.kube-system Port_Binding prometheus-k8s-0.monitoring Chassis \"eef07da1-f8ad-4775-b14d-bd6a3b4eb0d5\" hostname: liumengxin-ovn3-192.168.137.178 Encap stt ip: \"192.168.137.178\" options: {csum=\"true\"} Port_Binding kube-ovn-pinger-7twb4.kube-system Port_Binding prometheus-adapter-86df476d87-rl88g.monitoring Port_Binding prometheus-k8s-1.monitoring Port_Binding node-liumengxin-ovn3-192.168.137.178 Port_Binding perf-ff475.default Port_Binding alertmanager-main-1.monitoring Port_Binding blackbox-exporter-676d976865-tvsjd.monitoring Chassis \"efa253c9-494d-4719-83ae-b48ab0f11c03\" hostname: liumengxin-ovn2-192.168.137.177 Encap stt ip: \"192.168.137.177\" options: {csum=\"true\"} Port_Binding grafana-6c4c6b8fb7-pzd2c.monitoring Port_Binding node-liumengxin-ovn2-192.168.137.177 Port_Binding alertmanager-main-2.monitoring Port_Binding coredns-6789c94dd8-9jqsz.kube-system Port_Binding coredns-6789c94dd8-25d4r.kube-system Port_Binding prometheus-operator-7bbc99fc8b-wgjm4.monitoring Port_Binding prometheus-adapter-86df476d87-gdxmc.monitoring Port_Binding perf-fjnws.default Port_Binding kube-ovn-pinger-vh2xg.kube-system ds kube-proxy ready kube-proxy ready deployment ovn-central ready deployment kube-ovn-controller ready ds kube-ovn-cni ready ds ovs-ovn ready deployment coredns ready ovn-nb leader check ok ovn-sb leader check ok ovn-northd leader check ok ### kube-ovn-controller recent log ### start to diagnose node liumengxin-ovn1-192.168.137.176 #### ovn-controller log: 2022-06-03T00:56:44.897Z|16722|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T01:06:44.912Z|16723|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T01:16:44.925Z|16724|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T01:26:44.936Z|16725|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T01:36:44.959Z|16726|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T01:46:44.974Z|16727|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T01:56:44.988Z|16728|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T02:06:45.001Z|16729|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T02:16:45.025Z|16730|inc_proc_eng|INFO|User triggered force recompute. 2022-06-03T02:26:45.040Z|16731|inc_proc_eng|INFO|User triggered force recompute. #### ovs-vswitchd log: 2022-06-02T23:03:00.137Z|00079|dpif(handler1)|WARN|system@ovs-system: execute ct(commit,zone=14,label=0/0x1,nat(src)),8 failed (Invalid argument) on packet icmp,vlan_tci=0x0000,dl_src=00:00:00:f8:07:c8,dl_dst=00:00:00:fa:1e:50,nw_src=10.16.0.5,nw_dst=10.16.0.10,nw_tos=0,nw_ecn=0,nw_ttl=64,icmp_type=8,icmp_code=0 icmp_csum:f9d1 with metadata skb_priority(0),tunnel(tun_id=0x160017000004,src=192.168.137.177,dst=192.168.137.176,ttl=64,tp_src=38881,tp_dst=7471,flags(csum|key)),skb_mark(0),ct_state(0x21),ct_zone(0xe),ct_tuple4(src=10.16.0.5,dst=10.16.0.10,proto=1,tp_src=8,tp_dst=0),in_port(4) mtu 0 2022-06-02T23:23:31.840Z|00080|dpif(handler1)|WARN|system@ovs-system: execute ct(commit,zone=14,label=0/0x1,nat(src)),8 failed (Invalid argument) on packet icmp,vlan_tci=0x0000,dl_src=00:00:00:f8:07:c8,dl_dst=00:00:00:fa:1e:50,nw_src=10.16.0.5,nw_dst=10.16.0.10,nw_tos=0,nw_ecn=0,nw_ttl=64,icmp_type=8,icmp_code=0 icmp_csum:15b2 with metadata skb_priority(0),tunnel(tun_id=0x160017000004,src=192.168.137.177,dst=192.168.137.176,ttl=64,tp_src=38881,tp_dst=7471,flags(csum|key)),skb_mark(0),ct_state(0x21),ct_zone(0xe),ct_tuple4(src=10.16.0.5,dst=10.16.0.10,proto=1,tp_src=8,tp_dst=0),in_port(4) mtu 0 2022-06-03T00:09:15.659Z|00081|dpif(handler1)|WARN|system@ovs-system: execute ct(commit,zone=14,label=0/0x1,nat(src)),8 failed (Invalid argument) on packet icmp,vlan_tci=0x0000,dl_src=00:00:00:dc:e3:63,dl_dst=00:00:00:fa:1e:50,nw_src=10.16.63.30,nw_dst=10.16.0.10,nw_tos=0,nw_ecn=0,nw_ttl=64,icmp_type=8,icmp_code=0 icmp_csum:e5a5 with metadata skb_priority(0),tunnel(tun_id=0x150017000004,src=192.168.137.178,dst=192.168.137.176,ttl=64,tp_src=9239,tp_dst=7471,flags(csum|key)),skb_mark(0),ct_state(0x21),ct_zone(0xe),ct_tuple4(src=10.16.63.30,dst=10.16.0.10,proto=1,tp_src=8,tp_dst=0),in_port(4) mtu 0 2022-06-03T00:30:13.409Z|00064|dpif(handler2)|WARN|system@ovs-system: execute ct(commit,zone=14,label=0/0x1,nat(src)),8 failed (Invalid argument) on packet icmp,vlan_tci=0x0000,dl_src=00:00:00:f8:07:c8,dl_dst=00:00:00:fa:1e:50,nw_src=10.16.0.5,nw_dst=10.16.0.10,nw_tos=0,nw_ecn=0,nw_ttl=64,icmp_type=8,icmp_code=0 icmp_csum:6b4a with metadata skb_priority(0),tunnel(tun_id=0x160017000004,src=192.168.137.177,dst=192.168.137.176,ttl=64,tp_src=38881,tp_dst=7471,flags(csum|key)),skb_mark(0),ct_state(0x21),ct_zone(0xe),ct_tuple4(src=10.16.0.5,dst=10.16.0.10,proto=1,tp_src=8,tp_dst=0),in_port(4) mtu 0 2022-06-03T02:02:33.832Z|00082|dpif(handler1)|WARN|system@ovs-system: execute ct(commit,zone=14,label=0/0x1,nat(src)),8 failed (Invalid argument) on packet icmp,vlan_tci=0x0000,dl_src=00:00:00:f8:07:c8,dl_dst=00:00:00:fa:1e:50,nw_src=10.16.0.5,nw_dst=10.16.0.10,nw_tos=0,nw_ecn=0,nw_ttl=64,icmp_type=8,icmp_code=0 icmp_csum:a819 with metadata skb_priority(0),tunnel(tun_id=0x160017000004,src=192.168.137.177,dst=192.168.137.176,ttl=64,tp_src=38881,tp_dst=7471,flags(csum|key)),skb_mark(0),ct_state(0x21),ct_zone(0xe),ct_tuple4(src=10.16.0.5,dst=10.16.0.10,proto=1,tp_src=8,tp_dst=0),in_port(4) mtu 0 #### ovs-vsctl show results: 0d4c4675-c9cc-440a-8c1a-878e17f81b88 Bridge br-int fail_mode: secure datapath_type: system Port a2c1a8a8b83a_h Interface a2c1a8a8b83a_h Port \"4fa5c4cbb1a5_h\" Interface \"4fa5c4cbb1a5_h\" Port ovn-eef07d-0 Interface ovn-eef07d-0 type: stt options: {csum=\"true\", key=flow, remote_ip=\"192.168.137.178\"} Port ovn0 Interface ovn0 type: internal Port \"04d03360e9a0_h\" Interface \"04d03360e9a0_h\" Port eeb4d9e51b5d_h Interface eeb4d9e51b5d_h Port mirror0 Interface mirror0 type: internal Port \"8e5d887ccd80_h\" Interface \"8e5d887ccd80_h\" Port ovn-efa253-0 Interface ovn-efa253-0 type: stt options: {csum=\"true\", key=flow, remote_ip=\"192.168.137.177\"} Port \"17512d5be1f1_h\" Interface \"17512d5be1f1_h\" Port br-int Interface br-int type: internal ovs_version: \"2.17.2\" #### pinger diagnose results: I0603 10:35:04.349404 17619 pinger.go:19] ------------------------------------------------------------------------------- Kube-OVN: Version: v1.10.1 Build: 2022-04-24_08:02:50 Commit: git-73f9d15 Go Version: go1.17.8 Arch: amd64 ------------------------------------------------------------------------------- I0603 10:35:04.376797 17619 config.go:166] pinger config is &{KubeConfigFile: KubeClient:0xc000493380 Port:8080 DaemonSetNamespace:kube-system DaemonSetName:kube-ovn-pinger Interval:5 Mode:job ExitCode:0 InternalDNS:kubernetes.default ExternalDNS: NodeName:liumengxin-ovn1-192.168.137.176 HostIP:192.168.137.176 PodName:kube-ovn-pinger-6ftdf PodIP:10.16.0.10 PodProtocols:[IPv4] ExternalAddress: NetworkMode:kube-ovn PollTimeout:2 PollInterval:15 SystemRunDir:/var/run/openvswitch DatabaseVswitchName:Open_vSwitch DatabaseVswitchSocketRemote:unix:/var/run/openvswitch/db.sock DatabaseVswitchFileDataPath:/etc/openvswitch/conf.db DatabaseVswitchFileLogPath:/var/log/openvswitch/ovsdb-server.log DatabaseVswitchFilePidPath:/var/run/openvswitch/ovsdb-server.pid DatabaseVswitchFileSystemIDPath:/etc/openvswitch/system-id.conf ServiceVswitchdFileLogPath:/var/log/openvswitch/ovs-vswitchd.log ServiceVswitchdFilePidPath:/var/run/openvswitch/ovs-vswitchd.pid ServiceOvnControllerFileLogPath:/var/log/ovn/ovn-controller.log ServiceOvnControllerFilePidPath:/var/run/ovn/ovn-controller.pid} I0603 10:35:04.449166 17619 exporter.go:75] liumengxin-ovn1-192.168.137.176: exporter connect successfully I0603 10:35:04.554011 17619 ovn.go:21] ovs-vswitchd and ovsdb are up I0603 10:35:04.651293 17619 ovn.go:33] ovn_controller is up I0603 10:35:04.651342 17619 ovn.go:39] start to check port binding I0603 10:35:04.749613 17619 ovn.go:135] chassis id is 1d7f3d6c-eec5-4b3c-adca-2969d9cdfd80 I0603 10:35:04.763487 17619 ovn.go:49] port in sb is [node-liumengxin-ovn1-192.168.137.176 perf-6vxkn.default kube-state-metrics-5d6885d89-4nf8h.monitoring alertmanager-main-0.monitoring kube-ovn-pinger-6ftdf.kube-system fake-kubelet-67c55dfd89-pv86k.kube-system prometheus-k8s-0.monitoring] I0603 10:35:04.763583 17619 ovn.go:61] ovs and ovn-sb binding check passed I0603 10:35:05.049309 17619 ping.go:259] start to check apiserver connectivity I0603 10:35:05.053666 17619 ping.go:268] connect to apiserver success in 4.27ms I0603 10:35:05.053786 17619 ping.go:129] start to check pod connectivity I0603 10:35:05.249590 17619 ping.go:159] ping pod: kube-ovn-pinger-6ftdf 10.16.0.10, count: 3, loss count 0, average rtt 16.30ms I0603 10:35:05.354135 17619 ping.go:159] ping pod: kube-ovn-pinger-7twb4 10.16.63.30, count: 3, loss count 0, average rtt 1.81ms I0603 10:35:05.458460 17619 ping.go:159] ping pod: kube-ovn-pinger-vh2xg 10.16.0.5, count: 3, loss count 0, average rtt 1.92ms I0603 10:35:05.458523 17619 ping.go:83] start to check node connectivity","title":"diagnose {all|node} [nodename]"},{"location":"ops/kubectl-ko/#tuning-install-fastpathlocal-install-fastpathremove-fastpathinstall-sttlocal-install-sttremove-stt-centos7centos8-kernel-devel-version","text":"\u8be5\u547d\u4ee4\u6267\u884c\u6027\u80fd\u8c03\u4f18\u76f8\u5173\u64cd\u4f5c\uff0c\u5177\u4f53\u4f7f\u7528\u8bf7\u53c2\u8003 \u6027\u80fd\u8c03\u4f18","title":"tuning {install-fastpath|local-install-fastpath|remove-fastpath|install-stt|local-install-stt|remove-stt} {centos7|centos8}} [kernel-devel-version]"},{"location":"ops/kubectl-ko/#reload","text":"\u8be5\u547d\u4ee4\u91cd\u542f\u6240\u6709 Kube-OVN \u76f8\u5173\u7ec4\u4ef6 # kubectl ko reload pod \"ovn-central-8684dd94bd-vzgcr\" deleted Waiting for deployment \"ovn-central\" rollout to finish: 0 of 1 updated replicas are available... deployment \"ovn-central\" successfully rolled out pod \"ovs-ovn-bsnvz\" deleted pod \"ovs-ovn-m9b98\" deleted pod \"kube-ovn-controller-8459db5ff4-64c62\" deleted Waiting for deployment \"kube-ovn-controller\" rollout to finish: 0 of 1 updated replicas are available... deployment \"kube-ovn-controller\" successfully rolled out pod \"kube-ovn-cni-2klnh\" deleted pod \"kube-ovn-cni-t2jz4\" deleted Waiting for daemon set \"kube-ovn-cni\" rollout to finish: 0 of 2 updated pods are available... Waiting for daemon set \"kube-ovn-cni\" rollout to finish: 1 of 2 updated pods are available... daemon set \"kube-ovn-cni\" successfully rolled out pod \"kube-ovn-pinger-ln72z\" deleted pod \"kube-ovn-pinger-w8lrk\" deleted Waiting for daemon set \"kube-ovn-pinger\" rollout to finish: 0 of 2 updated pods are available... Waiting for daemon set \"kube-ovn-pinger\" rollout to finish: 1 of 2 updated pods are available... daemon set \"kube-ovn-pinger\" successfully rolled out pod \"kube-ovn-monitor-7fb67d5488-7q6zb\" deleted Waiting for deployment \"kube-ovn-monitor\" rollout to finish: 0 of 1 updated replicas are available... deployment \"kube-ovn-monitor\" successfully rolled out","title":"reload"},{"location":"ops/recover-db/","text":"OVN \u6570\u636e\u5e93\u5907\u4efd\u548c\u6062\u590d \u672c\u6587\u6863\u4ecb\u7ecd\u5982\u4f55\u8fdb\u884c\u6570\u636e\u5e93\u5907\u4efd\uff0c\u4ee5\u53ca\u5728\u4e0d\u540c\u60c5\u51b5\u4e0b\u5982\u4f55\u901a\u8fc7\u5df2\u6709\u7684\u6570\u636e\u5e93\u6587\u4ef6\u8fdb\u884c\u96c6\u7fa4\u6062\u590d\u3002 \u6570\u636e\u5e93\u5907\u4efd \u5229\u7528 kubectl \u63d2\u4ef6\u7684 backup \u547d\u4ee4\u53ef\u4ee5\u5bf9\u6570\u636e\u5e93\u6587\u4ef6\u8fdb\u884c\u5907\u4efd\uff0c\u4ee5\u7528\u4e8e\u6545\u969c\u65f6\u6062\u590d\uff1a # kubectl ko nb backup tar: Removing leading `/' from member names backup ovn-nb db to /root/ovnnb_db.060223191654183154.backup # kubectl ko sb backup tar: Removing leading `/' from member names backup ovn-nb db to /root/ovnsb_db.060223191654183154.backup \u96c6\u7fa4\u90e8\u5206\u6545\u969c\u6062\u590d \u82e5\u96c6\u7fa4\u4e2d\u5b58\u5728\u90e8\u5206\u8282\u70b9\u56e0\u4e3a\u65ad\u7535\uff0c\u6587\u4ef6\u7cfb\u7edf\u6545\u969c\u6216\u78c1\u76d8\u7a7a\u95f4\u4e0d\u8db3\u5bfc\u81f4\u5de5\u4f5c\u5f02\u5e38\uff0c \u4f46\u662f\u96c6\u7fa4\u4ecd\u53ef\u6b63\u5e38\u5de5\u4f5c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u6b65\u9aa4\u8fdb\u884c\u6062\u590d\u3002 \u67e5\u770b\u65e5\u5fd7\u786e\u8ba4\u72b6\u6001\u5f02\u5e38 \u67e5\u770b\u5bf9\u5e94\u8282\u70b9 /var/log/ovn/ovn-northd.log \uff0c\u82e5\u63d0\u793a\u7c7b\u4f3c\u9519\u8bef\u5219\u53ef\u5224\u65ad\u6570\u636e\u5e93\u5b58\u5728\u5f02\u5e38 * ovn-northd is not running ovsdb-server: ovsdb error: error reading record 2739 from OVN_Northbound log: record 2739 advances commit index to 6308 but last log index is 6307 * Starting ovsdb-nb \u4ece\u96c6\u7fa4\u4e2d\u8e22\u51fa\u5bf9\u5e94\u8282\u70b9 \u6839\u636e\u65e5\u5fd7\u63d0\u793a\u662f OVN_Northboun d \u8fd8\u662f OVN_Southbound \u9009\u62e9\u5bf9\u5e94\u7684\u6570\u636e\u5e93\u8fdb\u884c\u64cd\u4f5c\u3002 \u4e0a\u8ff0\u65e5\u5fd7\u63d0\u793a\u4e3a OVN_Northbound \u5219\u5bf9 ovn-nb \u8fdb\u884c\u64cd\u4f5c\uff1a # kubectl ko nb status 9182 Name: OVN_Northbound Cluster ID: e75f (e75fa340-49ed-45ab-990e-26cb865ebc85) Server ID: 9182 (9182e8dd-b5b0-4dd8-8518-598cc1e374f3) Address: tcp:[10.0.128.61]:6643 Status: cluster member Role: leader Term: 1454 Leader: self Vote: self Last Election started 1732603 ms ago, reason: timeout Last Election won: 1732587 ms ago Election timer: 1000 Log: [7332, 12512] Entries not yet committed: 1 Entries not yet applied: 1 Connections: ->f080 <-f080 <-e631 ->e631 Disconnections: 1 Servers: f080 (f080 at tcp:[10.0.129.139]:6643) next_index=12512 match_index=12510 last msg 63 ms ago 9182 (9182 at tcp:[10.0.128.61]:6643) (self) next_index=10394 match_index=12510 e631 (e631 at tcp:[10.0.131.173]:6643) next_index=12512 match_index=0 \u4ece\u96c6\u7fa4\u4e2d\u8e22\u51fa\u72b6\u6001\u5f02\u5e38\u8282\u70b9\uff1a kubectl ko nb kick e631 \u767b\u5f55\u5f02\u5e38\u8282\u70b9\uff0c\u5220\u9664\u5bf9\u5e94\u7684\u6570\u636e\u5e93\u6587\u4ef6\uff1a mv /etc/origin/ovn/ovnnb_db.db /tmp \u5220\u9664\u5bf9\u5e94\u8282\u70b9\u7684 ovn-central Pod \u96c6\u7fa4\u5373\u53ef\u81ea\u52a8\u6062\u590d\uff1a kubectl delete pod -n kube-system ovn-central-xxxx \u96c6\u7fa4\u4e0d\u80fd\u6b63\u5e38\u5de5\u4f5c\u4e0b\u7684\u6062\u590d \u82e5\u96c6\u7fa4\u591a\u6570\u8282\u70b9\u53d7\u635f\u65e0\u6cd5\u9009\u4e3e\u51fa leader\uff0c\u8bf7\u53c2\u7167\u4e0b\u9762\u7684\u6b65\u9aa4\u8fdb\u884c\u6062\u590d\u3002 \u505c\u6b62 ovn-central \u8bb0\u5f55\u5f53\u524d ovn-central \u526f\u672c\u6570\u91cf\uff0c\u5e76\u505c\u6b62 ovn-central \u907f\u514d\u65b0\u7684\u6570\u636e\u5e93\u53d8\u66f4\u5f71\u54cd\u6062\u590d\uff1a kubectl scale deployment -n kube-system ovn-central --replicas=0 \u9009\u62e9\u5907\u4efd \u7531\u4e8e\u591a\u6570\u8282\u70b9\u53d7\u635f\uff0c\u9700\u8981\u4ece\u67d0\u4e2a\u6570\u636e\u5e93\u6587\u4ef6\u8fdb\u884c\u6062\u590d\u91cd\u5efa\u96c6\u7fa4\u3002\u5982\u679c\u4e4b\u524d\u5907\u4efd\u8fc7\u6570\u636e\u5e93 \u53ef\u4f7f\u7528\u4e4b\u524d\u7684\u5907\u4efd\u6587\u4ef6\u8fdb\u884c\u6062\u590d\u3002\u5982\u679c\u6ca1\u6709\u8fdb\u884c\u8fc7\u5907\u4efd\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u6b65\u9aa4\u4ece\u5df2\u6709\u7684\u6587\u4ef6 \u4e2d\u751f\u6210\u4e00\u4e2a\u53ef\u91cd\u5efa\u6570\u636e\u5e93\u7684\u5907\u4efd\u3002 \u7531\u4e8e\u9ed8\u8ba4\u6587\u4ef6\u5939\u4e0b\u7684\u6570\u636e\u5e93\u6587\u4ef6\u4e3a\u96c6\u7fa4\u683c\u5f0f\u6570\u636e\u5e93\u6587\u4ef6\uff0c\u5305\u542b\u5f53\u524d\u96c6\u7fa4\u7684\u4fe1\u606f\uff0c\u65e0\u6cd5\u76f4\u63a5 \u7528\u8be5\u6587\u4ef6\u91cd\u5efa\u6570\u636e\u5e93\uff0c\u9700\u8981\u4f7f\u7528 ovsdb-tool cluster-to-standalone \u8fdb\u884c\u683c\u5f0f\u8f6c\u6362 \u9009\u62e9 ovn-central \u73af\u5883\u53d8\u91cf NODE_IPS \u4e2d\u6392\u7b2c\u4e00\u7684\u8282\u70b9\u6062\u590d\u6570\u636e\u5e93\u6587\u4ef6\uff0c \u5982\u679c\u7b2c\u4e00\u4e2a\u8282\u70b9\u6570\u636e\u5e93\u6587\u4ef6\u5df2\u635f\u574f\uff0c\u4ece\u5176\u4ed6\u673a\u5668 /etc/origin/ovn \u4e0b\u590d\u5236\u6587\u4ef6\u5230\u7b2c\u4e00\u53f0\u673a\u5668 \uff0c \u6267\u884c\u4e0b\u5217\u547d\u4ee4\u751f\u6210\u6570\u636e\u5e93\u6587\u4ef6\u5907\u4efd\u3002 docker run -it -v /etc/origin/ovn:/etc/ovn kubeovn/kube-ovn:v1.10.1 bash cd /etc/ovn/ ovsdb-tool cluster-to-standalone ovnnb_db_standalone.db ovnnb_db.db ovsdb-tool cluster-to-standalone ovnsb_db_standalone.db ovnsb_db.db \u5220\u9664\u6bcf\u4e2a ovn-central \u8282\u70b9\u4e0a\u7684\u6570\u636e\u5e93\u6587\u4ef6 \u4e3a\u4e86\u907f\u514d\u91cd\u5efa\u96c6\u7fa4\u65f6\u4f7f\u7528\u5230\u9519\u8bef\u7684\u6570\u636e\uff0c\u9700\u8981\u5bf9\u5df2\u6709\u6570\u636e\u5e93\u6587\u4ef6\u8fdb\u884c\u6e05\u7406\uff1a mv /etc/origin/ovn/ovnnb_db.db /tmp mv /etc/origin/ovn/ovnsb_db.db /tmp \u6062\u590d\u6570\u636e\u5e93\u96c6\u7fa4 \u5c06\u5907\u4efd\u6570\u636e\u5e93\u5206\u522b\u91cd\u547d\u540d\u4e3a ovnnb_db.db \u548c ovnsb_db.db \u81f3\u4e8e ovn-central \u73af\u5883\u53d8\u91cf NODE_IPS \u4e2d\u6392\u7b2c\u4e00\u673a\u5668\u7684 /etc/origin/ovn/ \u76ee\u5f55\u4e0b\uff1a mv /etc/origin/ovn/ovnnb_db_standalone.db /etc/origin/ovn/ovnnb_db.db mv /etc/origin/ovn/ovnsb_db_standalone.db /etc/origin/ovn/ovnsb_db.db \u6062\u590d ovn-central \u7684\u526f\u672c\u6570\uff1a kubectl scale deployment -n kube-system ovn-central --replicas=3 kubectl rollout status deployment/ovn-central -n kube-system","title":"OVN \u6570\u636e\u5e93\u5907\u4efd\u548c\u6062\u590d"},{"location":"ops/recover-db/#ovn","text":"\u672c\u6587\u6863\u4ecb\u7ecd\u5982\u4f55\u8fdb\u884c\u6570\u636e\u5e93\u5907\u4efd\uff0c\u4ee5\u53ca\u5728\u4e0d\u540c\u60c5\u51b5\u4e0b\u5982\u4f55\u901a\u8fc7\u5df2\u6709\u7684\u6570\u636e\u5e93\u6587\u4ef6\u8fdb\u884c\u96c6\u7fa4\u6062\u590d\u3002","title":"OVN \u6570\u636e\u5e93\u5907\u4efd\u548c\u6062\u590d"},{"location":"ops/recover-db/#_1","text":"\u5229\u7528 kubectl \u63d2\u4ef6\u7684 backup \u547d\u4ee4\u53ef\u4ee5\u5bf9\u6570\u636e\u5e93\u6587\u4ef6\u8fdb\u884c\u5907\u4efd\uff0c\u4ee5\u7528\u4e8e\u6545\u969c\u65f6\u6062\u590d\uff1a # kubectl ko nb backup tar: Removing leading `/' from member names backup ovn-nb db to /root/ovnnb_db.060223191654183154.backup # kubectl ko sb backup tar: Removing leading `/' from member names backup ovn-nb db to /root/ovnsb_db.060223191654183154.backup","title":"\u6570\u636e\u5e93\u5907\u4efd"},{"location":"ops/recover-db/#_2","text":"\u82e5\u96c6\u7fa4\u4e2d\u5b58\u5728\u90e8\u5206\u8282\u70b9\u56e0\u4e3a\u65ad\u7535\uff0c\u6587\u4ef6\u7cfb\u7edf\u6545\u969c\u6216\u78c1\u76d8\u7a7a\u95f4\u4e0d\u8db3\u5bfc\u81f4\u5de5\u4f5c\u5f02\u5e38\uff0c \u4f46\u662f\u96c6\u7fa4\u4ecd\u53ef\u6b63\u5e38\u5de5\u4f5c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u6b65\u9aa4\u8fdb\u884c\u6062\u590d\u3002","title":"\u96c6\u7fa4\u90e8\u5206\u6545\u969c\u6062\u590d"},{"location":"ops/recover-db/#_3","text":"\u67e5\u770b\u5bf9\u5e94\u8282\u70b9 /var/log/ovn/ovn-northd.log \uff0c\u82e5\u63d0\u793a\u7c7b\u4f3c\u9519\u8bef\u5219\u53ef\u5224\u65ad\u6570\u636e\u5e93\u5b58\u5728\u5f02\u5e38 * ovn-northd is not running ovsdb-server: ovsdb error: error reading record 2739 from OVN_Northbound log: record 2739 advances commit index to 6308 but last log index is 6307 * Starting ovsdb-nb","title":"\u67e5\u770b\u65e5\u5fd7\u786e\u8ba4\u72b6\u6001\u5f02\u5e38"},{"location":"ops/recover-db/#_4","text":"\u6839\u636e\u65e5\u5fd7\u63d0\u793a\u662f OVN_Northboun d \u8fd8\u662f OVN_Southbound \u9009\u62e9\u5bf9\u5e94\u7684\u6570\u636e\u5e93\u8fdb\u884c\u64cd\u4f5c\u3002 \u4e0a\u8ff0\u65e5\u5fd7\u63d0\u793a\u4e3a OVN_Northbound \u5219\u5bf9 ovn-nb \u8fdb\u884c\u64cd\u4f5c\uff1a # kubectl ko nb status 9182 Name: OVN_Northbound Cluster ID: e75f (e75fa340-49ed-45ab-990e-26cb865ebc85) Server ID: 9182 (9182e8dd-b5b0-4dd8-8518-598cc1e374f3) Address: tcp:[10.0.128.61]:6643 Status: cluster member Role: leader Term: 1454 Leader: self Vote: self Last Election started 1732603 ms ago, reason: timeout Last Election won: 1732587 ms ago Election timer: 1000 Log: [7332, 12512] Entries not yet committed: 1 Entries not yet applied: 1 Connections: ->f080 <-f080 <-e631 ->e631 Disconnections: 1 Servers: f080 (f080 at tcp:[10.0.129.139]:6643) next_index=12512 match_index=12510 last msg 63 ms ago 9182 (9182 at tcp:[10.0.128.61]:6643) (self) next_index=10394 match_index=12510 e631 (e631 at tcp:[10.0.131.173]:6643) next_index=12512 match_index=0 \u4ece\u96c6\u7fa4\u4e2d\u8e22\u51fa\u72b6\u6001\u5f02\u5e38\u8282\u70b9\uff1a kubectl ko nb kick e631 \u767b\u5f55\u5f02\u5e38\u8282\u70b9\uff0c\u5220\u9664\u5bf9\u5e94\u7684\u6570\u636e\u5e93\u6587\u4ef6\uff1a mv /etc/origin/ovn/ovnnb_db.db /tmp \u5220\u9664\u5bf9\u5e94\u8282\u70b9\u7684 ovn-central Pod \u96c6\u7fa4\u5373\u53ef\u81ea\u52a8\u6062\u590d\uff1a kubectl delete pod -n kube-system ovn-central-xxxx","title":"\u4ece\u96c6\u7fa4\u4e2d\u8e22\u51fa\u5bf9\u5e94\u8282\u70b9"},{"location":"ops/recover-db/#_5","text":"\u82e5\u96c6\u7fa4\u591a\u6570\u8282\u70b9\u53d7\u635f\u65e0\u6cd5\u9009\u4e3e\u51fa leader\uff0c\u8bf7\u53c2\u7167\u4e0b\u9762\u7684\u6b65\u9aa4\u8fdb\u884c\u6062\u590d\u3002","title":"\u96c6\u7fa4\u4e0d\u80fd\u6b63\u5e38\u5de5\u4f5c\u4e0b\u7684\u6062\u590d"},{"location":"ops/recover-db/#ovn-central","text":"\u8bb0\u5f55\u5f53\u524d ovn-central \u526f\u672c\u6570\u91cf\uff0c\u5e76\u505c\u6b62 ovn-central \u907f\u514d\u65b0\u7684\u6570\u636e\u5e93\u53d8\u66f4\u5f71\u54cd\u6062\u590d\uff1a kubectl scale deployment -n kube-system ovn-central --replicas=0","title":"\u505c\u6b62 ovn-central"},{"location":"ops/recover-db/#_6","text":"\u7531\u4e8e\u591a\u6570\u8282\u70b9\u53d7\u635f\uff0c\u9700\u8981\u4ece\u67d0\u4e2a\u6570\u636e\u5e93\u6587\u4ef6\u8fdb\u884c\u6062\u590d\u91cd\u5efa\u96c6\u7fa4\u3002\u5982\u679c\u4e4b\u524d\u5907\u4efd\u8fc7\u6570\u636e\u5e93 \u53ef\u4f7f\u7528\u4e4b\u524d\u7684\u5907\u4efd\u6587\u4ef6\u8fdb\u884c\u6062\u590d\u3002\u5982\u679c\u6ca1\u6709\u8fdb\u884c\u8fc7\u5907\u4efd\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u6b65\u9aa4\u4ece\u5df2\u6709\u7684\u6587\u4ef6 \u4e2d\u751f\u6210\u4e00\u4e2a\u53ef\u91cd\u5efa\u6570\u636e\u5e93\u7684\u5907\u4efd\u3002 \u7531\u4e8e\u9ed8\u8ba4\u6587\u4ef6\u5939\u4e0b\u7684\u6570\u636e\u5e93\u6587\u4ef6\u4e3a\u96c6\u7fa4\u683c\u5f0f\u6570\u636e\u5e93\u6587\u4ef6\uff0c\u5305\u542b\u5f53\u524d\u96c6\u7fa4\u7684\u4fe1\u606f\uff0c\u65e0\u6cd5\u76f4\u63a5 \u7528\u8be5\u6587\u4ef6\u91cd\u5efa\u6570\u636e\u5e93\uff0c\u9700\u8981\u4f7f\u7528 ovsdb-tool cluster-to-standalone \u8fdb\u884c\u683c\u5f0f\u8f6c\u6362 \u9009\u62e9 ovn-central \u73af\u5883\u53d8\u91cf NODE_IPS \u4e2d\u6392\u7b2c\u4e00\u7684\u8282\u70b9\u6062\u590d\u6570\u636e\u5e93\u6587\u4ef6\uff0c \u5982\u679c\u7b2c\u4e00\u4e2a\u8282\u70b9\u6570\u636e\u5e93\u6587\u4ef6\u5df2\u635f\u574f\uff0c\u4ece\u5176\u4ed6\u673a\u5668 /etc/origin/ovn \u4e0b\u590d\u5236\u6587\u4ef6\u5230\u7b2c\u4e00\u53f0\u673a\u5668 \uff0c \u6267\u884c\u4e0b\u5217\u547d\u4ee4\u751f\u6210\u6570\u636e\u5e93\u6587\u4ef6\u5907\u4efd\u3002 docker run -it -v /etc/origin/ovn:/etc/ovn kubeovn/kube-ovn:v1.10.1 bash cd /etc/ovn/ ovsdb-tool cluster-to-standalone ovnnb_db_standalone.db ovnnb_db.db ovsdb-tool cluster-to-standalone ovnsb_db_standalone.db ovnsb_db.db","title":"\u9009\u62e9\u5907\u4efd"},{"location":"ops/recover-db/#ovn-central_1","text":"\u4e3a\u4e86\u907f\u514d\u91cd\u5efa\u96c6\u7fa4\u65f6\u4f7f\u7528\u5230\u9519\u8bef\u7684\u6570\u636e\uff0c\u9700\u8981\u5bf9\u5df2\u6709\u6570\u636e\u5e93\u6587\u4ef6\u8fdb\u884c\u6e05\u7406\uff1a mv /etc/origin/ovn/ovnnb_db.db /tmp mv /etc/origin/ovn/ovnsb_db.db /tmp","title":"\u5220\u9664\u6bcf\u4e2a ovn-central \u8282\u70b9\u4e0a\u7684\u6570\u636e\u5e93\u6587\u4ef6"},{"location":"ops/recover-db/#_7","text":"\u5c06\u5907\u4efd\u6570\u636e\u5e93\u5206\u522b\u91cd\u547d\u540d\u4e3a ovnnb_db.db \u548c ovnsb_db.db \u81f3\u4e8e ovn-central \u73af\u5883\u53d8\u91cf NODE_IPS \u4e2d\u6392\u7b2c\u4e00\u673a\u5668\u7684 /etc/origin/ovn/ \u76ee\u5f55\u4e0b\uff1a mv /etc/origin/ovn/ovnnb_db_standalone.db /etc/origin/ovn/ovnnb_db.db mv /etc/origin/ovn/ovnsb_db_standalone.db /etc/origin/ovn/ovnsb_db.db \u6062\u590d ovn-central \u7684\u526f\u672c\u6570\uff1a kubectl scale deployment -n kube-system ovn-central --replicas=3 kubectl rollout status deployment/ovn-central -n kube-system","title":"\u6062\u590d\u6570\u636e\u5e93\u96c6\u7fa4"},{"location":"reference/api/","text":"","title":"Api"},{"location":"reference/architecture/","text":"\u603b\u4f53\u67b6\u6784 \u672c\u6587\u6863\u5c06\u4ecb\u7ecd Kube-OVN \u7684\u603b\u4f53\u67b6\u6784\uff0c\u548c\u5404\u4e2a\u7ec4\u4ef6\u7684\u529f\u80fd\u4ee5\u53ca\u5176\u4e4b\u95f4\u7684\u4ea4\u4e92\u3002 \u603b\u4f53\u6765\u770b\uff0cKube-OVN \u4f5c\u4e3a Kubernetes \u548c OVN \u4e4b\u95f4\u7684\u4e00\u4e2a\u6865\u6881\uff0c\u5c06\u6210\u719f\u7684 SDN \u548c\u4e91\u539f\u751f\u76f8\u7ed3\u5408\u3002 \u8fd9\u610f\u5473\u7740 Kube-OVN \u4e0d\u4ec5\u901a\u8fc7 OVN \u5b9e\u73b0\u4e86 Kubernetes \u4e0b\u7684\u7f51\u7edc\u89c4\u8303\uff0c\u4f8b\u5982 CNI\uff0cService \u548c Networkpolicy\uff0c\u8fd8\u5c06\u5927\u91cf\u7684 SDN \u9886\u57df\u80fd\u529b\u5e26\u5165\u4e91\u539f\u751f\uff0c\u4f8b\u5982\u903b\u8f91\u4ea4\u6362\u673a\uff0c\u903b\u8f91\u8def\u7531\u5668\uff0cVPC\uff0c\u7f51\u5173\uff0cQoS\uff0cACL \u548c\u6d41\u91cf\u955c\u50cf\u3002 \u540c\u65f6 Kube-OVN \u8fd8\u4fdd\u6301\u4e86\u826f\u597d\u7684\u5f00\u653e\u6027\u53ef\u4ee5\u548c\u8bf8\u591a\u6280\u672f\u65b9\u6848\u96c6\u6210\uff0c\u4f8b\u5982 Cilium\uff0cSubmariner\uff0cPrometheus\uff0cKubeVirt \u7b49\u7b49\u3002 \u7ec4\u4ef6\u4ecb\u7ecd Kube-OVN \u7684\u7ec4\u4ef6\u53ef\u4ee5\u5927\u81f4\u5206\u4e3a\u4e09\u7c7b\uff1a * \u4e0a\u6e38 OVN/OVS \u7ec4\u4ef6\u3002 * \u6838\u5fc3\u63a7\u5236\u5668\u548c Agent\u3002 * \u76d1\u63a7\uff0c\u8fd0\u7ef4\u5de5\u5177\u548c\u6269\u5c55\u7ec4\u4ef6\u3002 \u4e0a\u6e38 OVN/OVS \u7ec4\u4ef6 \u8be5\u7c7b\u578b\u7ec4\u4ef6\u6765\u81ea OVN/OVS \u793e\u533a\uff0c\u5e76\u9488\u5bf9 Kube-OVN \u7684\u4f7f\u7528\u573a\u666f\u505a\u4e86\u7279\u5b9a\u4fee\u6539\u3002 OVN/OVS \u672c\u8eab\u662f\u4e00\u5957\u6210\u719f\u7684\u7ba1\u7406\u865a\u673a\u548c\u5bb9\u5668\u7684 SDN \u7cfb\u7edf\uff0c\u6211\u4eec\u5f3a\u70c8\u5efa\u8bae \u5bf9 Kube-OVN \u5b9e\u73b0\u611f\u5174\u8da3\u7684\u7528\u6237\u5148\u53bb\u8bfb\u4e00\u4e0b ovn-architecture(7) \u6765\u4e86\u89e3\u4ec0\u4e48\u662f OVN \u4ee5\u53ca \u5982\u4f55\u548c\u5b83\u8fdb\u884c\u96c6\u6210\u3002Kube-OVN \u4f7f\u7528 OVN \u7684\u5317\u5411\u63a5\u53e3\u521b\u5efa\u548c\u8c03\u6574\u865a\u62df\u7f51\u7edc\uff0c\u5e76\u5c06\u5176\u4e2d\u7684\u7f51\u7edc\u6982\u5ff5\u6620\u5c04\u5230 Kubernetes \u4e4b\u5185\u3002 \u6240\u6709 OVN/OVS \u76f8\u5173\u7ec4\u4ef6\u90fd\u5df2\u6253\u5305\u6210\u5bf9\u5e94\u955c\u50cf\uff0c\u5e76\u53ef\u5728 Kubernetes \u4e2d\u8fd0\u884c\u3002 ovn-central ovn-central Deployment \u8fd0\u884c OVN \u7684\u7ba1\u7406\u5e73\u9762\u7ec4\u4ef6\uff0c\u5305\u62ec ovn-nb , ovn-sb , \u548c ovn-northd \u3002 ovn-nb \uff1a \u4fdd\u5b58\u865a\u62df\u7f51\u7edc\u914d\u7f6e\uff0c\u5e76\u63d0\u4f9b API \u8fdb\u884c\u865a\u62df\u7f51\u7edc\u7ba1\u7406\u3002 kube-ovn-controller \u5c06\u4f1a\u4e3b\u8981\u548c ovn-nb \u8fdb\u884c\u4ea4\u4e92\u914d\u7f6e\u865a\u62df\u7f51\u7edc\u3002 ovn-sb \uff1a \u4fdd\u5b58\u4ece ovn-nb \u7684\u903b\u8f91\u7f51\u7edc\u751f\u6210\u7684\u903b\u8f91\u6d41\u8868\uff0c\u4ee5\u53ca\u5404\u4e2a\u8282\u70b9\u7684\u5b9e\u9645\u7269\u7406\u7f51\u7edc\u72b6\u6001\u3002 ovn-northd \uff1a\u5c06 ovn-nb \u7684\u865a\u62df\u7f51\u7edc\u7ffb\u8bd1\u6210 ovn-sb \u4e2d\u7684\u903b\u8f91\u6d41\u8868\u3002 \u591a\u4e2a ovn-central \u5b9e\u4f8b\u4f1a\u901a\u8fc7 Raft \u534f\u8bae\u540c\u6b65\u6570\u636e\u4fdd\u8bc1\u9ad8\u53ef\u7528\u3002 ovs-ovn ovs-ovn \u4ee5 DaemonSet \u5f62\u5f0f\u8fd0\u884c\u5728\u6bcf\u4e2a\u8282\u70b9\uff0c\u5728 Pod \u5185\u8fd0\u884c\u4e86 openvswitch , ovsdb , \u548c ovn-controller \u3002\u8fd9\u4e9b\u7ec4\u4ef6\u4f5c\u4e3a ovn-central \u7684 Agent \u5c06\u903b\u8f91\u6d41\u8868\u7ffb\u8bd1\u6210\u771f\u5b9e\u7684\u7f51\u7edc\u914d\u7f6e\u3002 \u6838\u5fc3\u63a7\u5236\u5668\u548c Agent \u8be5\u90e8\u5206\u4e3a Kube-OVN \u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u4f5c\u4e3a OVN \u548c Kubernetes \u4e4b\u95f4\u7684\u4e00\u4e2a\u6865\u6881\uff0c\u5c06\u4e24\u4e2a\u7cfb\u7edf\u6253\u901a\u5e76\u5c06\u7f51\u7edc\u6982\u5ff5\u8fdb\u884c\u76f8\u4e92\u8f6c\u6362\u3002 \u5927\u90e8\u5206\u7684\u6838\u5fc3\u529f\u80fd\u90fd\u5728\u8be5\u90e8\u5206\u7ec4\u4ef6\u4e2d\u5b9e\u73b0\u3002 kube-ovn-controller \u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a Deployment \u6267\u884c\u6240\u6709 Kubernetes \u5185\u8d44\u6e90\u5230 OVN \u8d44\u6e90\u7684\u7ffb\u8bd1\u5de5\u4f5c\uff0c\u5176\u4f5c\u7528\u76f8\u5f53\u4e8e\u6574\u4e2a Kube-OVN \u7cfb\u7edf\u7684\u63a7\u5236\u5e73\u9762\u3002 kube-ovn-controller \u76d1\u542c\u4e86\u6240\u6709\u548c\u7f51\u7edc\u529f\u80fd\u76f8\u5173\u8d44\u6e90\u7684\u4e8b\u4ef6\uff0c\u5e76\u6839\u636e\u8d44\u6e90\u53d8\u5316\u60c5\u51b5\u66f4\u65b0 OVN \u5185\u7684\u903b\u8f91\u7f51\u7edc\u3002\u4e3b\u8981\u76d1\u542c\u7684\u8d44\u6e90\u5305\u62ec\uff1a Pod\uff0cService\uff0cEndpoint\uff0cNode\uff0cNetworkPolicy\uff0cVPC\uff0cSubnet\uff0cVlan\uff0cProviderNetwork\u3002 \u4ee5 Pod \u4e8b\u4ef6\u4e3a\u4f8b\uff0c kube-ovn-controller \u76d1\u542c\u5230 Pod \u521b\u5efa\u4e8b\u4ef6\u540e\uff0c\u901a\u8fc7\u5185\u7f6e\u7684\u5185\u5b58 IPAM \u529f\u80fd\u5206\u914d\u5730\u5740\uff0c\u5e76\u8c03\u7528 ovn-central \u521b\u5efa \u903b\u8f91\u7aef\u53e3\uff0c\u9759\u6001\u8def\u7531\u548c\u53ef\u80fd\u7684 ACL \u89c4\u5219\u3002\u63a5\u4e0b\u6765 kube-ovn-controller \u5c06\u5206\u914d\u5230\u7684\u5730\u5740\uff0c\u548c\u5b50\u7f51\u4fe1\u606f\u4f8b\u5982 CIDR\uff0c\u7f51\u5173\uff0c\u8def\u7531\u7b49\u4fe1\u606f\u5199\u4f1a\u5230 Pod \u7684 annotation \u4e2d\u3002\u8be5 annotation \u540e\u7eed\u4f1a\u88ab kube-ovn-cni \u8bfb\u53d6\u7528\u6765\u914d\u7f6e\u672c\u5730\u7f51\u7edc\u3002 kube-ovn-cni \u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a DaemonSet \u8fd0\u884c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\uff0c\u5b9e\u73b0 CNI \u63a5\u53e3\uff0c\u5e76\u64cd\u4f5c\u672c\u5730\u7684 OVS \u914d\u7f6e\u5355\u673a\u7f51\u7edc\u3002 \u8be5 DaemonSet \u4f1a\u590d\u5236 kube-ovn \u4e8c\u8fdb\u5236\u6587\u4ef6\u5230\u6bcf\u53f0\u673a\u5668\uff0c\u4f5c\u4e3a kubelet \u548c kube-ovn-cni \u4e4b\u95f4\u7684\u4ea4\u4e92\u5de5\u5177\uff0c\u5c06\u76f8\u5e94 CNI \u8bf7\u6c42 \u53d1\u9001\u7ed9 kube-ovn-cni \u6267\u884c\u3002\u8be5\u4e8c\u8fdb\u5236\u6587\u4ef6\u9ed8\u8ba4\u4f1a\u88ab\u590d\u5236\u5230 /opt/cni/bin \u76ee\u5f55\u4e0b\u3002 kube-ovn-cni \u4f1a\u914d\u7f6e\u5177\u4f53\u7684\u7f51\u7edc\u6765\u6267\u884c\u76f8\u5e94\u6d41\u91cf\u64cd\u4f5c\uff0c\u4e3b\u8981\u5de5\u4f5c\u5305\u62ec\uff1a 1. \u914d\u7f6e ovn-controller \u548c vswitchd \u3002 2. \u5904\u7406 CNI add/del \u8bf7\u6c42\uff1a 1. \u521b\u5efa\u5220\u9664 veth \u5e76\u548c OVS \u7aef\u53e3\u7ed1\u5b9a\u3002 2. \u914d\u7f6e OVS \u7aef\u53e3\u4fe1\u606f\u3002 3. \u66f4\u65b0\u5bbf\u4e3b\u673a\u7684 iptables/ipset/route \u7b49\u89c4\u5219\u3002 3. \u52a8\u6001\u66f4\u65b0\u5bb9\u5668 QoS. 4. \u521b\u5efa\u5e76\u914d\u7f6e ovn0 \u7f51\u5361\u8054\u901a\u5bb9\u5668\u7f51\u7edc\u548c\u4e3b\u673a\u7f51\u7edc\u3002 5. \u914d\u7f6e\u4e3b\u673a\u7f51\u5361\u6765\u5b9e\u73b0 Vlan/Underlay/EIP \u7b49\u529f\u80fd\u3002 6. \u52a8\u6001\u914d\u7f6e\u96c6\u7fa4\u4e92\u8054\u7f51\u5173\u3002 \u76d1\u63a7\uff0c\u8fd0\u7ef4\u5de5\u5177\u548c\u6269\u5c55\u7ec4\u4ef6 \u8be5\u90e8\u5206\u7ec4\u4ef6\u4e3b\u8981\u63d0\u4f9b\u76d1\u63a7\uff0c\u8bca\u65ad\uff0c\u8fd0\u7ef4\u64cd\u4f5c\u4ee5\u53ca\u548c\u5916\u90e8\u8fdb\u884c\u5bf9\u63a5\uff0c\u5bf9 Kube-OVN \u7684\u6838\u5fc3\u7f51\u7edc\u80fd\u529b\u8fdb\u884c\u6269\u5c55\uff0c\u5e76\u7b80\u5316\u65e5\u5e38\u8fd0\u7ef4\u64cd\u4f5c\u3002 kube-ovn-speaker \u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a DaemonSet \u8fd0\u884c\u5728\u7279\u5b9a\u6807\u7b7e\u7684\u8282\u70b9\u4e0a\uff0c\u5bf9\u5916\u53d1\u5e03\u5bb9\u5668\u7f51\u7edc\u7684\u8def\u7531\uff0c\u4f7f\u5f97\u5916\u90e8\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 Pod IP \u8bbf\u95ee\u5bb9\u5668\u3002 \u66f4\u591a\u76f8\u5173\u4f7f\u7528\u65b9\u5f0f\u8bf7\u53c2\u8003 BGP \u652f\u6301 \u3002 kube-ovn-pinger \u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a DaemonSet \u8fd0\u884c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u6536\u96c6 OVS \u8fd0\u884c\u4fe1\u606f\uff0c\u8282\u70b9\u7f51\u7edc\u8d28\u91cf\uff0c\u7f51\u7edc\u5ef6\u8fdf\u7b49\u4fe1\u606f\uff0c\u6536\u96c6\u7684\u76d1\u63a7\u6307\u6807\u53ef\u53c2\u8003 Kube-OVN \u76d1\u63a7\u6307\u6807 \u3002 kube-ovn-monitor \u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a Deployment \u6536\u96c6 OVN \u7684\u8fd0\u884c\u4fe1\u606f\uff0c\u6536\u96c6\u7684\u76d1\u63a7\u6307\u6807\u53ef\u53c2\u8003 Kube-OVN \u76d1\u63a7\u6307\u6807 \u3002 kubectl-ko \u8be5\u7ec4\u4ef6\u4e3a kubectl \u63d2\u4ef6\uff0c\u53ef\u4ee5\u5feb\u901f\u8fd0\u884c\u5e38\u89c1\u8fd0\u7ef4\u64cd\u4f5c\uff0c\u66f4\u591a\u4f7f\u7528\u8bf7\u53c2\u8003 kubectl \u63d2\u4ef6\u4f7f\u7528 \u3002","title":"\u603b\u4f53\u67b6\u6784"},{"location":"reference/architecture/#_1","text":"\u672c\u6587\u6863\u5c06\u4ecb\u7ecd Kube-OVN \u7684\u603b\u4f53\u67b6\u6784\uff0c\u548c\u5404\u4e2a\u7ec4\u4ef6\u7684\u529f\u80fd\u4ee5\u53ca\u5176\u4e4b\u95f4\u7684\u4ea4\u4e92\u3002 \u603b\u4f53\u6765\u770b\uff0cKube-OVN \u4f5c\u4e3a Kubernetes \u548c OVN \u4e4b\u95f4\u7684\u4e00\u4e2a\u6865\u6881\uff0c\u5c06\u6210\u719f\u7684 SDN \u548c\u4e91\u539f\u751f\u76f8\u7ed3\u5408\u3002 \u8fd9\u610f\u5473\u7740 Kube-OVN \u4e0d\u4ec5\u901a\u8fc7 OVN \u5b9e\u73b0\u4e86 Kubernetes \u4e0b\u7684\u7f51\u7edc\u89c4\u8303\uff0c\u4f8b\u5982 CNI\uff0cService \u548c Networkpolicy\uff0c\u8fd8\u5c06\u5927\u91cf\u7684 SDN \u9886\u57df\u80fd\u529b\u5e26\u5165\u4e91\u539f\u751f\uff0c\u4f8b\u5982\u903b\u8f91\u4ea4\u6362\u673a\uff0c\u903b\u8f91\u8def\u7531\u5668\uff0cVPC\uff0c\u7f51\u5173\uff0cQoS\uff0cACL \u548c\u6d41\u91cf\u955c\u50cf\u3002 \u540c\u65f6 Kube-OVN \u8fd8\u4fdd\u6301\u4e86\u826f\u597d\u7684\u5f00\u653e\u6027\u53ef\u4ee5\u548c\u8bf8\u591a\u6280\u672f\u65b9\u6848\u96c6\u6210\uff0c\u4f8b\u5982 Cilium\uff0cSubmariner\uff0cPrometheus\uff0cKubeVirt \u7b49\u7b49\u3002","title":"\u603b\u4f53\u67b6\u6784"},{"location":"reference/architecture/#_2","text":"Kube-OVN \u7684\u7ec4\u4ef6\u53ef\u4ee5\u5927\u81f4\u5206\u4e3a\u4e09\u7c7b\uff1a * \u4e0a\u6e38 OVN/OVS \u7ec4\u4ef6\u3002 * \u6838\u5fc3\u63a7\u5236\u5668\u548c Agent\u3002 * \u76d1\u63a7\uff0c\u8fd0\u7ef4\u5de5\u5177\u548c\u6269\u5c55\u7ec4\u4ef6\u3002","title":"\u7ec4\u4ef6\u4ecb\u7ecd"},{"location":"reference/architecture/#ovnovs","text":"\u8be5\u7c7b\u578b\u7ec4\u4ef6\u6765\u81ea OVN/OVS \u793e\u533a\uff0c\u5e76\u9488\u5bf9 Kube-OVN \u7684\u4f7f\u7528\u573a\u666f\u505a\u4e86\u7279\u5b9a\u4fee\u6539\u3002 OVN/OVS \u672c\u8eab\u662f\u4e00\u5957\u6210\u719f\u7684\u7ba1\u7406\u865a\u673a\u548c\u5bb9\u5668\u7684 SDN \u7cfb\u7edf\uff0c\u6211\u4eec\u5f3a\u70c8\u5efa\u8bae \u5bf9 Kube-OVN \u5b9e\u73b0\u611f\u5174\u8da3\u7684\u7528\u6237\u5148\u53bb\u8bfb\u4e00\u4e0b ovn-architecture(7) \u6765\u4e86\u89e3\u4ec0\u4e48\u662f OVN \u4ee5\u53ca \u5982\u4f55\u548c\u5b83\u8fdb\u884c\u96c6\u6210\u3002Kube-OVN \u4f7f\u7528 OVN \u7684\u5317\u5411\u63a5\u53e3\u521b\u5efa\u548c\u8c03\u6574\u865a\u62df\u7f51\u7edc\uff0c\u5e76\u5c06\u5176\u4e2d\u7684\u7f51\u7edc\u6982\u5ff5\u6620\u5c04\u5230 Kubernetes \u4e4b\u5185\u3002 \u6240\u6709 OVN/OVS \u76f8\u5173\u7ec4\u4ef6\u90fd\u5df2\u6253\u5305\u6210\u5bf9\u5e94\u955c\u50cf\uff0c\u5e76\u53ef\u5728 Kubernetes \u4e2d\u8fd0\u884c\u3002","title":"\u4e0a\u6e38 OVN/OVS \u7ec4\u4ef6"},{"location":"reference/architecture/#ovn-central","text":"ovn-central Deployment \u8fd0\u884c OVN \u7684\u7ba1\u7406\u5e73\u9762\u7ec4\u4ef6\uff0c\u5305\u62ec ovn-nb , ovn-sb , \u548c ovn-northd \u3002 ovn-nb \uff1a \u4fdd\u5b58\u865a\u62df\u7f51\u7edc\u914d\u7f6e\uff0c\u5e76\u63d0\u4f9b API \u8fdb\u884c\u865a\u62df\u7f51\u7edc\u7ba1\u7406\u3002 kube-ovn-controller \u5c06\u4f1a\u4e3b\u8981\u548c ovn-nb \u8fdb\u884c\u4ea4\u4e92\u914d\u7f6e\u865a\u62df\u7f51\u7edc\u3002 ovn-sb \uff1a \u4fdd\u5b58\u4ece ovn-nb \u7684\u903b\u8f91\u7f51\u7edc\u751f\u6210\u7684\u903b\u8f91\u6d41\u8868\uff0c\u4ee5\u53ca\u5404\u4e2a\u8282\u70b9\u7684\u5b9e\u9645\u7269\u7406\u7f51\u7edc\u72b6\u6001\u3002 ovn-northd \uff1a\u5c06 ovn-nb \u7684\u865a\u62df\u7f51\u7edc\u7ffb\u8bd1\u6210 ovn-sb \u4e2d\u7684\u903b\u8f91\u6d41\u8868\u3002 \u591a\u4e2a ovn-central \u5b9e\u4f8b\u4f1a\u901a\u8fc7 Raft \u534f\u8bae\u540c\u6b65\u6570\u636e\u4fdd\u8bc1\u9ad8\u53ef\u7528\u3002","title":"ovn-central"},{"location":"reference/architecture/#ovs-ovn","text":"ovs-ovn \u4ee5 DaemonSet \u5f62\u5f0f\u8fd0\u884c\u5728\u6bcf\u4e2a\u8282\u70b9\uff0c\u5728 Pod \u5185\u8fd0\u884c\u4e86 openvswitch , ovsdb , \u548c ovn-controller \u3002\u8fd9\u4e9b\u7ec4\u4ef6\u4f5c\u4e3a ovn-central \u7684 Agent \u5c06\u903b\u8f91\u6d41\u8868\u7ffb\u8bd1\u6210\u771f\u5b9e\u7684\u7f51\u7edc\u914d\u7f6e\u3002","title":"ovs-ovn"},{"location":"reference/architecture/#agent","text":"\u8be5\u90e8\u5206\u4e3a Kube-OVN \u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u4f5c\u4e3a OVN \u548c Kubernetes \u4e4b\u95f4\u7684\u4e00\u4e2a\u6865\u6881\uff0c\u5c06\u4e24\u4e2a\u7cfb\u7edf\u6253\u901a\u5e76\u5c06\u7f51\u7edc\u6982\u5ff5\u8fdb\u884c\u76f8\u4e92\u8f6c\u6362\u3002 \u5927\u90e8\u5206\u7684\u6838\u5fc3\u529f\u80fd\u90fd\u5728\u8be5\u90e8\u5206\u7ec4\u4ef6\u4e2d\u5b9e\u73b0\u3002","title":"\u6838\u5fc3\u63a7\u5236\u5668\u548c Agent"},{"location":"reference/architecture/#kube-ovn-controller","text":"\u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a Deployment \u6267\u884c\u6240\u6709 Kubernetes \u5185\u8d44\u6e90\u5230 OVN \u8d44\u6e90\u7684\u7ffb\u8bd1\u5de5\u4f5c\uff0c\u5176\u4f5c\u7528\u76f8\u5f53\u4e8e\u6574\u4e2a Kube-OVN \u7cfb\u7edf\u7684\u63a7\u5236\u5e73\u9762\u3002 kube-ovn-controller \u76d1\u542c\u4e86\u6240\u6709\u548c\u7f51\u7edc\u529f\u80fd\u76f8\u5173\u8d44\u6e90\u7684\u4e8b\u4ef6\uff0c\u5e76\u6839\u636e\u8d44\u6e90\u53d8\u5316\u60c5\u51b5\u66f4\u65b0 OVN \u5185\u7684\u903b\u8f91\u7f51\u7edc\u3002\u4e3b\u8981\u76d1\u542c\u7684\u8d44\u6e90\u5305\u62ec\uff1a Pod\uff0cService\uff0cEndpoint\uff0cNode\uff0cNetworkPolicy\uff0cVPC\uff0cSubnet\uff0cVlan\uff0cProviderNetwork\u3002 \u4ee5 Pod \u4e8b\u4ef6\u4e3a\u4f8b\uff0c kube-ovn-controller \u76d1\u542c\u5230 Pod \u521b\u5efa\u4e8b\u4ef6\u540e\uff0c\u901a\u8fc7\u5185\u7f6e\u7684\u5185\u5b58 IPAM \u529f\u80fd\u5206\u914d\u5730\u5740\uff0c\u5e76\u8c03\u7528 ovn-central \u521b\u5efa \u903b\u8f91\u7aef\u53e3\uff0c\u9759\u6001\u8def\u7531\u548c\u53ef\u80fd\u7684 ACL \u89c4\u5219\u3002\u63a5\u4e0b\u6765 kube-ovn-controller \u5c06\u5206\u914d\u5230\u7684\u5730\u5740\uff0c\u548c\u5b50\u7f51\u4fe1\u606f\u4f8b\u5982 CIDR\uff0c\u7f51\u5173\uff0c\u8def\u7531\u7b49\u4fe1\u606f\u5199\u4f1a\u5230 Pod \u7684 annotation \u4e2d\u3002\u8be5 annotation \u540e\u7eed\u4f1a\u88ab kube-ovn-cni \u8bfb\u53d6\u7528\u6765\u914d\u7f6e\u672c\u5730\u7f51\u7edc\u3002","title":"kube-ovn-controller"},{"location":"reference/architecture/#kube-ovn-cni","text":"\u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a DaemonSet \u8fd0\u884c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\uff0c\u5b9e\u73b0 CNI \u63a5\u53e3\uff0c\u5e76\u64cd\u4f5c\u672c\u5730\u7684 OVS \u914d\u7f6e\u5355\u673a\u7f51\u7edc\u3002 \u8be5 DaemonSet \u4f1a\u590d\u5236 kube-ovn \u4e8c\u8fdb\u5236\u6587\u4ef6\u5230\u6bcf\u53f0\u673a\u5668\uff0c\u4f5c\u4e3a kubelet \u548c kube-ovn-cni \u4e4b\u95f4\u7684\u4ea4\u4e92\u5de5\u5177\uff0c\u5c06\u76f8\u5e94 CNI \u8bf7\u6c42 \u53d1\u9001\u7ed9 kube-ovn-cni \u6267\u884c\u3002\u8be5\u4e8c\u8fdb\u5236\u6587\u4ef6\u9ed8\u8ba4\u4f1a\u88ab\u590d\u5236\u5230 /opt/cni/bin \u76ee\u5f55\u4e0b\u3002 kube-ovn-cni \u4f1a\u914d\u7f6e\u5177\u4f53\u7684\u7f51\u7edc\u6765\u6267\u884c\u76f8\u5e94\u6d41\u91cf\u64cd\u4f5c\uff0c\u4e3b\u8981\u5de5\u4f5c\u5305\u62ec\uff1a 1. \u914d\u7f6e ovn-controller \u548c vswitchd \u3002 2. \u5904\u7406 CNI add/del \u8bf7\u6c42\uff1a 1. \u521b\u5efa\u5220\u9664 veth \u5e76\u548c OVS \u7aef\u53e3\u7ed1\u5b9a\u3002 2. \u914d\u7f6e OVS \u7aef\u53e3\u4fe1\u606f\u3002 3. \u66f4\u65b0\u5bbf\u4e3b\u673a\u7684 iptables/ipset/route \u7b49\u89c4\u5219\u3002 3. \u52a8\u6001\u66f4\u65b0\u5bb9\u5668 QoS. 4. \u521b\u5efa\u5e76\u914d\u7f6e ovn0 \u7f51\u5361\u8054\u901a\u5bb9\u5668\u7f51\u7edc\u548c\u4e3b\u673a\u7f51\u7edc\u3002 5. \u914d\u7f6e\u4e3b\u673a\u7f51\u5361\u6765\u5b9e\u73b0 Vlan/Underlay/EIP \u7b49\u529f\u80fd\u3002 6. \u52a8\u6001\u914d\u7f6e\u96c6\u7fa4\u4e92\u8054\u7f51\u5173\u3002","title":"kube-ovn-cni"},{"location":"reference/architecture/#_3","text":"\u8be5\u90e8\u5206\u7ec4\u4ef6\u4e3b\u8981\u63d0\u4f9b\u76d1\u63a7\uff0c\u8bca\u65ad\uff0c\u8fd0\u7ef4\u64cd\u4f5c\u4ee5\u53ca\u548c\u5916\u90e8\u8fdb\u884c\u5bf9\u63a5\uff0c\u5bf9 Kube-OVN \u7684\u6838\u5fc3\u7f51\u7edc\u80fd\u529b\u8fdb\u884c\u6269\u5c55\uff0c\u5e76\u7b80\u5316\u65e5\u5e38\u8fd0\u7ef4\u64cd\u4f5c\u3002","title":"\u76d1\u63a7\uff0c\u8fd0\u7ef4\u5de5\u5177\u548c\u6269\u5c55\u7ec4\u4ef6"},{"location":"reference/architecture/#kube-ovn-speaker","text":"\u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a DaemonSet \u8fd0\u884c\u5728\u7279\u5b9a\u6807\u7b7e\u7684\u8282\u70b9\u4e0a\uff0c\u5bf9\u5916\u53d1\u5e03\u5bb9\u5668\u7f51\u7edc\u7684\u8def\u7531\uff0c\u4f7f\u5f97\u5916\u90e8\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 Pod IP \u8bbf\u95ee\u5bb9\u5668\u3002 \u66f4\u591a\u76f8\u5173\u4f7f\u7528\u65b9\u5f0f\u8bf7\u53c2\u8003 BGP \u652f\u6301 \u3002","title":"kube-ovn-speaker"},{"location":"reference/architecture/#kube-ovn-pinger","text":"\u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a DaemonSet \u8fd0\u884c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u6536\u96c6 OVS \u8fd0\u884c\u4fe1\u606f\uff0c\u8282\u70b9\u7f51\u7edc\u8d28\u91cf\uff0c\u7f51\u7edc\u5ef6\u8fdf\u7b49\u4fe1\u606f\uff0c\u6536\u96c6\u7684\u76d1\u63a7\u6307\u6807\u53ef\u53c2\u8003 Kube-OVN \u76d1\u63a7\u6307\u6807 \u3002","title":"kube-ovn-pinger"},{"location":"reference/architecture/#kube-ovn-monitor","text":"\u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a Deployment \u6536\u96c6 OVN \u7684\u8fd0\u884c\u4fe1\u606f\uff0c\u6536\u96c6\u7684\u76d1\u63a7\u6307\u6807\u53ef\u53c2\u8003 Kube-OVN \u76d1\u63a7\u6307\u6807 \u3002","title":"kube-ovn-monitor"},{"location":"reference/architecture/#kubectl-ko","text":"\u8be5\u7ec4\u4ef6\u4e3a kubectl \u63d2\u4ef6\uff0c\u53ef\u4ee5\u5feb\u901f\u8fd0\u884c\u5e38\u89c1\u8fd0\u7ef4\u64cd\u4f5c\uff0c\u66f4\u591a\u4f7f\u7528\u8bf7\u53c2\u8003 kubectl \u63d2\u4ef6\u4f7f\u7528 \u3002","title":"kubectl-ko"},{"location":"reference/dev-env/","text":"\u5f00\u53d1\u73af\u5883\u6784\u5efa \u73af\u5883\u51c6\u5907: Kube-OVN \u4f7f\u7528 Go 1.17 \u5f00\u53d1\u5e76\u4f7f\u7528 Go Modules \u7ba1\u7406\u4f9d\u8d56\uff0c \u8bf7\u786e\u8ba4\u73af\u5883\u53d8\u91cf GO111MODULE=\"on\" \u3002 gosec \u88ab\u7528\u6765\u626b\u63cf\u4ee3\u7801\u5b89\u5168\u76f8\u5173\u95ee\u9898\uff0c\u9700\u8981\u5728\u5f00\u53d1\u73af\u5883\u5b89\u88c5\uff1a go get github.com/securego/gosec/v2/cmd/gosec \u4e3a\u4e86\u964d\u4f4e\u6700\u7ec8\u751f\u6210\u955c\u50cf\u5927\u5c0f\uff0cKube-OVN \u4f7f\u7528\u4e86\u90e8\u5206 Docker buildx \u8bd5\u9a8c\u7279\u6027\uff0c\u8bf7\u66f4\u65b0 Docker \u81f3\u6700\u65b0\u7248\u672c \u5e76\u5f00\u542f buildx: docker buildx create --use \u6784\u5efa\u955c\u50cf \u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e0b\u8f7d\u4ee3\u7801\uff0c\u5e76\u751f\u6210\u8fd0\u884c Kube-OVN \u6240\u9700\u955c\u50cf\uff1a git clone https://github.com/kubeovn/kube-ovn.git cd kube-ovn make release \u5982\u9700\u6784\u5efa\u5728 ARM \u73af\u5883\u4e0b\u8fd0\u884c\u7684\u955c\u50cf\uff0c\u8bf7\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a make release-arm \u8fd0\u884c E2E Kube-OVN \u4f7f\u7528 KIND \u6784\u5efa\u672c\u5730 Kubernetes \u96c6\u7fa4\uff0c j2cli \u6e32\u67d3\u6a21\u677f\uff0c Ginkgo \u6765\u8fd0\u884c\u6d4b\u8bd5\u4ee3\u7801\u3002\u8bf7\u53c2\u8003\u76f8\u5173\u6587\u6863\u8fdb\u884c\u4f9d\u8d56\u5b89\u88c5\u3002 \u672c\u5730\u6267\u884c E2E \u6d4b\u8bd5\uff1a make kind-init make kind-install make e2e \u5982\u9700\u8fd0\u884c Underlay E2E \u6d4b\u8bd5\uff0c\u6267\u884c\u4e0b\u5217\u547d\u4ee4\uff1a make kind-init make kind-install-underlay make e2e-underlay-single-nic","title":"\u5f00\u53d1\u73af\u5883\u6784\u5efa"},{"location":"reference/dev-env/#_1","text":"","title":"\u5f00\u53d1\u73af\u5883\u6784\u5efa"},{"location":"reference/dev-env/#_2","text":"Kube-OVN \u4f7f\u7528 Go 1.17 \u5f00\u53d1\u5e76\u4f7f\u7528 Go Modules \u7ba1\u7406\u4f9d\u8d56\uff0c \u8bf7\u786e\u8ba4\u73af\u5883\u53d8\u91cf GO111MODULE=\"on\" \u3002 gosec \u88ab\u7528\u6765\u626b\u63cf\u4ee3\u7801\u5b89\u5168\u76f8\u5173\u95ee\u9898\uff0c\u9700\u8981\u5728\u5f00\u53d1\u73af\u5883\u5b89\u88c5\uff1a go get github.com/securego/gosec/v2/cmd/gosec \u4e3a\u4e86\u964d\u4f4e\u6700\u7ec8\u751f\u6210\u955c\u50cf\u5927\u5c0f\uff0cKube-OVN \u4f7f\u7528\u4e86\u90e8\u5206 Docker buildx \u8bd5\u9a8c\u7279\u6027\uff0c\u8bf7\u66f4\u65b0 Docker \u81f3\u6700\u65b0\u7248\u672c \u5e76\u5f00\u542f buildx: docker buildx create --use","title":"\u73af\u5883\u51c6\u5907:"},{"location":"reference/dev-env/#_3","text":"\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e0b\u8f7d\u4ee3\u7801\uff0c\u5e76\u751f\u6210\u8fd0\u884c Kube-OVN \u6240\u9700\u955c\u50cf\uff1a git clone https://github.com/kubeovn/kube-ovn.git cd kube-ovn make release \u5982\u9700\u6784\u5efa\u5728 ARM \u73af\u5883\u4e0b\u8fd0\u884c\u7684\u955c\u50cf\uff0c\u8bf7\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a make release-arm","title":"\u6784\u5efa\u955c\u50cf"},{"location":"reference/dev-env/#e2e","text":"Kube-OVN \u4f7f\u7528 KIND \u6784\u5efa\u672c\u5730 Kubernetes \u96c6\u7fa4\uff0c j2cli \u6e32\u67d3\u6a21\u677f\uff0c Ginkgo \u6765\u8fd0\u884c\u6d4b\u8bd5\u4ee3\u7801\u3002\u8bf7\u53c2\u8003\u76f8\u5173\u6587\u6863\u8fdb\u884c\u4f9d\u8d56\u5b89\u88c5\u3002 \u672c\u5730\u6267\u884c E2E \u6d4b\u8bd5\uff1a make kind-init make kind-install make e2e \u5982\u9700\u8fd0\u884c Underlay E2E \u6d4b\u8bd5\uff0c\u6267\u884c\u4e0b\u5217\u547d\u4ee4\uff1a make kind-init make kind-install-underlay make e2e-underlay-single-nic","title":"\u8fd0\u884c E2E"},{"location":"reference/metrics/","text":"Kube-OVN \u76d1\u63a7\u6307\u6807 \u672c\u6587\u6863\u5217\u4e3e Kube-OVN \u6240\u63d0\u4f9b\u7684\u76d1\u63a7\u6307\u6807\u3002 ovn-monitor OVN \u81ea\u8eab\u72b6\u6001\u76d1\u63a7\u6307\u6807\uff1a Type Metric Description Gauge ovn_status OVN Health Status. The values are: (2) for standby or follower, (1) for active or leader, (0) for unhealthy. Gauge ovn_info This metric provides basic information about OVN. It is always set to 1. Gauge failed_req_count The number of failed requests to OVN stack. Gauge log_file_size The size of a log file associated with an OVN component. Gauge db_file_size The size of a database file associated with an OVN component. Gauge chassis_info Whether the OVN chassis is up (1) or down (0), together with additional information about the chassis. Gauge db_status The status of OVN NB/SB DB, (1) for healthy, (0) for unhealthy. Gauge logical_switch_info The information about OVN logical switch. This metric is always up (1). Gauge logical_switch_external_id Provides the external IDs and values associated with OVN logical switches. This metric is always up (1). Gauge logical_switch_port_binding Provides the association between a logical switch and a logical switch port. This metric is always up (1). Gauge logical_switch_tunnel_key The value of the tunnel key associated with the logical switch. Gauge logical_switch_ports_num The number of logical switch ports connected to the OVN logical switch. Gauge logical_switch_port_info The information about OVN logical switch port. This metric is always up (1). Gauge logical_switch_port_tunnel_key The value of the tunnel key associated with the logical switch port. Gauge cluster_enabled Is OVN clustering enabled (1) or not (0). Gauge cluster_role A metric with a constant '1' value labeled by server role. Gauge cluster_status A metric with a constant '1' value labeled by server status. Gauge cluster_term The current raft term known by this server. Gauge cluster_leader_self Is this server consider itself a leader (1) or not (0). Gauge cluster_vote_self Is this server voted itself as a leader (1) or not (0). Gauge cluster_election_timer The current election timer value. Gauge cluster_log_not_committed The number of log entries not yet committed by this server. Gauge cluster_log_not_applied The number of log entries not yet applied by this server. Gauge cluster_log_index_start The log entry index start value associated with this server. Gauge cluster_log_index_next The log entry index next value associated with this server. Gauge cluster_inbound_connections_total The total number of inbound connections to the server. Gauge cluster_outbound_connections_total The total number of outbound connections from the server. Gauge cluster_inbound_connections_error_total The total number of failed inbound connections to the server. Gauge cluster_outbound_connections_error_total The total number of failed outbound connections from the server. ovs-monitor ovsdb \u548c vswitchd \u81ea\u8eab\u72b6\u6001\u76d1\u63a7\u6307\u6807\uff1a Type Metric Description Gauge ovs_status OVS Health Status. The values are: health(1), unhealthy(0). Gauge ovs_info This metric provides basic information about OVS. It is always set to 1. Gauge failed_req_count The number of failed requests to OVS stack. Gauge log_file_size The size of a log file associated with an OVS component. Gauge db_file_size The size of a database file associated with an OVS component. Gauge datapath Represents an existing datapath. This metrics is always 1. Gauge dp_total Represents total number of datapaths on the system. Gauge dp_if Represents an existing datapath interface. This metrics is always 1. Gauge dp_if_total Represents the number of ports connected to the datapath. Gauge dp_flows_total The number of flows in a datapath. Gauge dp_flows_lookup_hit The number of incoming packets in a datapath matching existing flows in the datapath. Gauge dp_flows_lookup_missed The number of incoming packets in a datapath not matching any existing flow in the datapath. Gauge dp_flows_lookup_lost The number of incoming packets in a datapath destined for userspace process but subsequently dropped before reaching userspace. Gauge dp_masks_hit The total number of masks visited for matching incoming packets. Gauge dp_masks_total The number of masks in a datapath. Gauge dp_masks_hit_ratio The average number of masks visited per packet. It is the ration between hit and total number of packets processed by a datapath. Gauge interface Represents OVS interface. This is the primary metric for all other interface metrics. This metrics is always 1. Gauge interface_admin_state The administrative state of the physical network link of OVS interface. The values are: down(0), up(1), other(2). Gauge interface_link_state The state of the physical network link of OVS interface. The values are: down(0), up(1), other(2). Gauge interface_mac_in_use The MAC address in use by OVS interface. Gauge interface_mtu The currently configured MTU for OVS interface. Gauge interface_of_port Represents the OpenFlow port ID associated with OVS interface. Gauge interface_if_index Represents the interface index associated with OVS interface. Gauge interface_tx_packets Represents the number of transmitted packets by OVS interface. Gauge interface_tx_bytes Represents the number of transmitted bytes by OVS interface. Gauge interface_rx_packets Represents the number of received packets by OVS interface. Gauge interface_rx_bytes Represents the number of received bytes by OVS interface. Gauge interface_rx_crc_err Represents the number of CRC errors for the packets received by OVS interface. Gauge interface_rx_dropped Represents the number of input packets dropped by OVS interface. Gauge interface_rx_errors Represents the total number of packets with errors received by OVS interface. Gauge interface_rx_frame_err Represents the number of frame alignment errors on the packets received by OVS interface. Gauge interface_rx_missed_err Represents the number of packets with RX missed received by OVS interface. Gauge interface_rx_over_err Represents the number of packets with RX overrun received by OVS interface. Gauge interface_tx_dropped Represents the number of output packets dropped by OVS interface. Gauge interface_tx_errors Represents the total number of transmit errors by OVS interface. Gauge interface_collisions Represents the number of collisions on OVS interface. kube-ovn-pinger \u7f51\u7edc\u8d28\u91cf\u76f8\u5173\u76d1\u63a7\u6307\u6807\uff1a | | Type | Metric | Description | | ------------------- | ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- | | Gauge | pinger_ovs_up | If the ovs on the node is up | | Gauge | pinger_ovs_down | If the ovs on the node is down | | Gauge | pinger_ovn_controller_up | If the ovn_controller on the node is up | | Gauge | pinger_ovn_controller_down | If the ovn_controller on the node is down | | Gauge | pinger_inconsistent_port_binding | The number of mismatch port bindings between ovs and ovn-sb | | Gauge | pinger_apiserver_healthy | If the apiserver request is healthy on this node | | Gauge | pinger_apiserver_unhealthy | If the apiserver request is unhealthy on this node | | Histogram | pinger_apiserver_latency_ms | The latency ms histogram the node request apiserver | | Gauge | pinger_internal_dns_healthy | If the internal dns request is unhealthy on this node | | Gauge | pinger_internal_dns_unhealthy | If the internal dns request is unhealthy on this node | | Histogram | pinger_internal_dns_latency_ms | The latency ms histogram the node request internal dns | | Gauge | pinger_external_dns_health | If the external dns request is healthy on this node | | Gauge | pinger_external_dns_unhealthy | If the external dns request is unhealthy on this node | | Histogram | pinger_external_dns_latency_ms | The latency ms histogram the node request external dns | | Histogram | pinger_pod_ping_latency_ms | The latency ms histogram for pod peer ping | | Gauge | pinger_pod_ping_lost_total | The lost count for pod peer ping | | Gauge | pinger_pod_ping_count_total | The total count for pod peer ping | | Histogram | pinger_node_ping_latency_ms | The latency ms histogram for pod ping node | | Gauge | pinger_node_ping_lost_total | The lost count for pod ping node | | Gauge | pinger_node_ping_count_total | The total count for pod ping node | | Histogram | pinger_external_ping_latency_ms | The latency ms histogram for pod ping external address | | Gauge | pinger_node_external_lost_total | The lost count for pod ping external address kube-ovn-controller kube-ovn-controller \u76f8\u5173\u76d1\u63a7\u6307\u6807\uff1a | Type | Metric | Description | | ------------------- | ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- || | Histogram | rest_client_request_latency_seconds | Request latency in seconds. Broken down by verb and URL | | Counter | rest_client_requests_total | Number of HTTP requests, partitioned by status code, method, and host | | Counter | lists_total | Total number of API lists done by the reflectors | | Summary | list_duration_seconds | How long an API list takes to return and decode for the reflectors | | Summary | items_per_list | How many items an API list returns to the reflectors | | Counter | watches_total | Total number of API watches done by the reflectors | | Counter | short_watches_total | Total number of short API watches done by the reflectors | | Summary | watch_duration_seconds | How long an API watch takes to return and decode for the reflectors | | Summary | items_per_watch | How many items an API watch returns to the reflectors | | Gauge | last_resource_version | Last resource version seen for the reflectors | | Histogram | ovs_client_request_latency_milliseconds | The latency histogram for ovs request | | Gauge | subnet_available_ip_count | The available num of ip address in subnet | | Gauge | subnet_used_ip_count | The used num of ip address in subnet | kube-ovn-cni kube-ovn-cni \u76f8\u5173\u76d1\u63a7\u6307\u6807 Type Metric Description Histogram cni_op_latency_seconds The latency seconds for cni operations Counter cni_wait_address_seconds_total Latency that cni wait controller to assign an address Counter cni_wait_connectivity_seconds_total Latency that cni wait address ready in overlay network Counter cni_wait_route_seconds_total Latency that cni wait controller to add routed annotation to pod Histogram rest_client_request_latency_seconds Request latency in seconds. Broken down by verb and URL Counter rest_client_requests_total Number of HTTP requests, partitioned by status code, method, and host Counter lists_total Total number of API lists done by the reflectors Summary list_duration_seconds How long an API list takes to return and decode for the reflectors Summary items_per_list How many items an API list returns to the reflectors Counter watches_total Total number of API watches done by the reflectors Counter short_watches_total Total number of short API watches done by the reflectors Summary watch_duration_seconds How long an API watch takes to return and decode for the reflectors Summary items_per_watch How many items an API watch returns to the reflectors Gauge last_resource_version Last resource version seen for the reflectors Histogram ovs_client_request_latency_milliseconds The latency histogram for ovs request","title":"Kube-OVN \u76d1\u63a7\u6307\u6807"},{"location":"reference/metrics/#kube-ovn","text":"\u672c\u6587\u6863\u5217\u4e3e Kube-OVN \u6240\u63d0\u4f9b\u7684\u76d1\u63a7\u6307\u6807\u3002","title":"Kube-OVN \u76d1\u63a7\u6307\u6807"},{"location":"reference/metrics/#ovn-monitor","text":"OVN \u81ea\u8eab\u72b6\u6001\u76d1\u63a7\u6307\u6807\uff1a Type Metric Description Gauge ovn_status OVN Health Status. The values are: (2) for standby or follower, (1) for active or leader, (0) for unhealthy. Gauge ovn_info This metric provides basic information about OVN. It is always set to 1. Gauge failed_req_count The number of failed requests to OVN stack. Gauge log_file_size The size of a log file associated with an OVN component. Gauge db_file_size The size of a database file associated with an OVN component. Gauge chassis_info Whether the OVN chassis is up (1) or down (0), together with additional information about the chassis. Gauge db_status The status of OVN NB/SB DB, (1) for healthy, (0) for unhealthy. Gauge logical_switch_info The information about OVN logical switch. This metric is always up (1). Gauge logical_switch_external_id Provides the external IDs and values associated with OVN logical switches. This metric is always up (1). Gauge logical_switch_port_binding Provides the association between a logical switch and a logical switch port. This metric is always up (1). Gauge logical_switch_tunnel_key The value of the tunnel key associated with the logical switch. Gauge logical_switch_ports_num The number of logical switch ports connected to the OVN logical switch. Gauge logical_switch_port_info The information about OVN logical switch port. This metric is always up (1). Gauge logical_switch_port_tunnel_key The value of the tunnel key associated with the logical switch port. Gauge cluster_enabled Is OVN clustering enabled (1) or not (0). Gauge cluster_role A metric with a constant '1' value labeled by server role. Gauge cluster_status A metric with a constant '1' value labeled by server status. Gauge cluster_term The current raft term known by this server. Gauge cluster_leader_self Is this server consider itself a leader (1) or not (0). Gauge cluster_vote_self Is this server voted itself as a leader (1) or not (0). Gauge cluster_election_timer The current election timer value. Gauge cluster_log_not_committed The number of log entries not yet committed by this server. Gauge cluster_log_not_applied The number of log entries not yet applied by this server. Gauge cluster_log_index_start The log entry index start value associated with this server. Gauge cluster_log_index_next The log entry index next value associated with this server. Gauge cluster_inbound_connections_total The total number of inbound connections to the server. Gauge cluster_outbound_connections_total The total number of outbound connections from the server. Gauge cluster_inbound_connections_error_total The total number of failed inbound connections to the server. Gauge cluster_outbound_connections_error_total The total number of failed outbound connections from the server.","title":"ovn-monitor"},{"location":"reference/metrics/#ovs-monitor","text":"ovsdb \u548c vswitchd \u81ea\u8eab\u72b6\u6001\u76d1\u63a7\u6307\u6807\uff1a Type Metric Description Gauge ovs_status OVS Health Status. The values are: health(1), unhealthy(0). Gauge ovs_info This metric provides basic information about OVS. It is always set to 1. Gauge failed_req_count The number of failed requests to OVS stack. Gauge log_file_size The size of a log file associated with an OVS component. Gauge db_file_size The size of a database file associated with an OVS component. Gauge datapath Represents an existing datapath. This metrics is always 1. Gauge dp_total Represents total number of datapaths on the system. Gauge dp_if Represents an existing datapath interface. This metrics is always 1. Gauge dp_if_total Represents the number of ports connected to the datapath. Gauge dp_flows_total The number of flows in a datapath. Gauge dp_flows_lookup_hit The number of incoming packets in a datapath matching existing flows in the datapath. Gauge dp_flows_lookup_missed The number of incoming packets in a datapath not matching any existing flow in the datapath. Gauge dp_flows_lookup_lost The number of incoming packets in a datapath destined for userspace process but subsequently dropped before reaching userspace. Gauge dp_masks_hit The total number of masks visited for matching incoming packets. Gauge dp_masks_total The number of masks in a datapath. Gauge dp_masks_hit_ratio The average number of masks visited per packet. It is the ration between hit and total number of packets processed by a datapath. Gauge interface Represents OVS interface. This is the primary metric for all other interface metrics. This metrics is always 1. Gauge interface_admin_state The administrative state of the physical network link of OVS interface. The values are: down(0), up(1), other(2). Gauge interface_link_state The state of the physical network link of OVS interface. The values are: down(0), up(1), other(2). Gauge interface_mac_in_use The MAC address in use by OVS interface. Gauge interface_mtu The currently configured MTU for OVS interface. Gauge interface_of_port Represents the OpenFlow port ID associated with OVS interface. Gauge interface_if_index Represents the interface index associated with OVS interface. Gauge interface_tx_packets Represents the number of transmitted packets by OVS interface. Gauge interface_tx_bytes Represents the number of transmitted bytes by OVS interface. Gauge interface_rx_packets Represents the number of received packets by OVS interface. Gauge interface_rx_bytes Represents the number of received bytes by OVS interface. Gauge interface_rx_crc_err Represents the number of CRC errors for the packets received by OVS interface. Gauge interface_rx_dropped Represents the number of input packets dropped by OVS interface. Gauge interface_rx_errors Represents the total number of packets with errors received by OVS interface. Gauge interface_rx_frame_err Represents the number of frame alignment errors on the packets received by OVS interface. Gauge interface_rx_missed_err Represents the number of packets with RX missed received by OVS interface. Gauge interface_rx_over_err Represents the number of packets with RX overrun received by OVS interface. Gauge interface_tx_dropped Represents the number of output packets dropped by OVS interface. Gauge interface_tx_errors Represents the total number of transmit errors by OVS interface. Gauge interface_collisions Represents the number of collisions on OVS interface.","title":"ovs-monitor"},{"location":"reference/metrics/#kube-ovn-pinger","text":"\u7f51\u7edc\u8d28\u91cf\u76f8\u5173\u76d1\u63a7\u6307\u6807\uff1a | | Type | Metric | Description | | ------------------- | ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- | | Gauge | pinger_ovs_up | If the ovs on the node is up | | Gauge | pinger_ovs_down | If the ovs on the node is down | | Gauge | pinger_ovn_controller_up | If the ovn_controller on the node is up | | Gauge | pinger_ovn_controller_down | If the ovn_controller on the node is down | | Gauge | pinger_inconsistent_port_binding | The number of mismatch port bindings between ovs and ovn-sb | | Gauge | pinger_apiserver_healthy | If the apiserver request is healthy on this node | | Gauge | pinger_apiserver_unhealthy | If the apiserver request is unhealthy on this node | | Histogram | pinger_apiserver_latency_ms | The latency ms histogram the node request apiserver | | Gauge | pinger_internal_dns_healthy | If the internal dns request is unhealthy on this node | | Gauge | pinger_internal_dns_unhealthy | If the internal dns request is unhealthy on this node | | Histogram | pinger_internal_dns_latency_ms | The latency ms histogram the node request internal dns | | Gauge | pinger_external_dns_health | If the external dns request is healthy on this node | | Gauge | pinger_external_dns_unhealthy | If the external dns request is unhealthy on this node | | Histogram | pinger_external_dns_latency_ms | The latency ms histogram the node request external dns | | Histogram | pinger_pod_ping_latency_ms | The latency ms histogram for pod peer ping | | Gauge | pinger_pod_ping_lost_total | The lost count for pod peer ping | | Gauge | pinger_pod_ping_count_total | The total count for pod peer ping | | Histogram | pinger_node_ping_latency_ms | The latency ms histogram for pod ping node | | Gauge | pinger_node_ping_lost_total | The lost count for pod ping node | | Gauge | pinger_node_ping_count_total | The total count for pod ping node | | Histogram | pinger_external_ping_latency_ms | The latency ms histogram for pod ping external address | | Gauge | pinger_node_external_lost_total | The lost count for pod ping external address","title":"kube-ovn-pinger"},{"location":"reference/metrics/#kube-ovn-controller","text":"kube-ovn-controller \u76f8\u5173\u76d1\u63a7\u6307\u6807\uff1a | Type | Metric | Description | | ------------------- | ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- || | Histogram | rest_client_request_latency_seconds | Request latency in seconds. Broken down by verb and URL | | Counter | rest_client_requests_total | Number of HTTP requests, partitioned by status code, method, and host | | Counter | lists_total | Total number of API lists done by the reflectors | | Summary | list_duration_seconds | How long an API list takes to return and decode for the reflectors | | Summary | items_per_list | How many items an API list returns to the reflectors | | Counter | watches_total | Total number of API watches done by the reflectors | | Counter | short_watches_total | Total number of short API watches done by the reflectors | | Summary | watch_duration_seconds | How long an API watch takes to return and decode for the reflectors | | Summary | items_per_watch | How many items an API watch returns to the reflectors | | Gauge | last_resource_version | Last resource version seen for the reflectors | | Histogram | ovs_client_request_latency_milliseconds | The latency histogram for ovs request | | Gauge | subnet_available_ip_count | The available num of ip address in subnet | | Gauge | subnet_used_ip_count | The used num of ip address in subnet |","title":"kube-ovn-controller"},{"location":"reference/metrics/#kube-ovn-cni","text":"kube-ovn-cni \u76f8\u5173\u76d1\u63a7\u6307\u6807 Type Metric Description Histogram cni_op_latency_seconds The latency seconds for cni operations Counter cni_wait_address_seconds_total Latency that cni wait controller to assign an address Counter cni_wait_connectivity_seconds_total Latency that cni wait address ready in overlay network Counter cni_wait_route_seconds_total Latency that cni wait controller to add routed annotation to pod Histogram rest_client_request_latency_seconds Request latency in seconds. Broken down by verb and URL Counter rest_client_requests_total Number of HTTP requests, partitioned by status code, method, and host Counter lists_total Total number of API lists done by the reflectors Summary list_duration_seconds How long an API list takes to return and decode for the reflectors Summary items_per_list How many items an API list returns to the reflectors Counter watches_total Total number of API watches done by the reflectors Counter short_watches_total Total number of short API watches done by the reflectors Summary watch_duration_seconds How long an API watch takes to return and decode for the reflectors Summary items_per_watch How many items an API watch returns to the reflectors Gauge last_resource_version Last resource version seen for the reflectors Histogram ovs_client_request_latency_milliseconds The latency histogram for ovs request","title":"kube-ovn-cni"},{"location":"reference/ovs-ovn-customized/","text":"\u5bf9\u4e0a\u6e38 OVS/OVN \u4fee\u6539 \u4e0a\u6e38 OVN/OVS \u6700\u521d\u8bbe\u8ba1\u76ee\u6807\u4e3a\u901a\u7528 SDN \u63a7\u5236\u5668\u548c\u6570\u636e\u5e73\u9762\u3002\u7531\u4e8e Kubernetes \u7f51\u7edc\u5b58\u5728\u4e00\u4e9b\u7279\u6b8a\u7684\u7528\u6cd5\uff0c \u5e76\u4e14 Kube-OVN \u53ea\u91cd\u70b9\u4f7f\u7528\u4e86\u90e8\u5206\u529f\u80fd\uff0c\u4e3a\u4e86 \u8fbe\u5230\u66f4\u597d\u7684\u6027\u80fd\u3001\u7a33\u5b9a\u6027\u548c\u7279\u5b9a\u7684\u529f\u80fd\uff0cKube-OVN \u5bf9\u4e0a\u6e38 OVN/OVS \u505a\u4e86\u90e8\u5206\u4fee\u6539\u3002\u7528\u6237\u5982\u679c\u4f7f\u7528\u81ea\u5df1\u7684 OVN/OVS \u914d\u5408 Kube-OVN \u7684\u63a7\u5236\u5668\u8fdb\u884c\u5de5\u4f5c\u65f6\u9700\u8981 \u6ce8\u610f \u4e0b\u8ff0\u7684\u6539\u52a8\u53ef\u80fd\u9020\u6210\u7684\u5f71\u54cd\u3002 \u672a\u5408\u5e76\u5165\u4e0a\u6e38\u4fee\u6539\uff1a 22ea22c40b \u8c03\u6574\u9009\u4e3e timer\uff0c\u907f\u514d\u5927\u89c4\u6a21\u96c6\u7fa4\u9009\u4e3e\u6296\u52a8\u3002 d26ae4de0a \u76ee\u7684\u5730\u5740\u975e Service \u6d41\u91cf\u7ed5\u8fc7 conntrack \u4ee5\u63d0\u9ad8\u7279\u5b9a\u6570\u636e\u94fe\u8def\u6027\u80fd\u3002 ab923b2522 ECMP \u7b97\u6cd5\u7531 dp_hash \u8c03\u6574\u4e3a hash\uff0c\u907f\u514d\u90e8\u5206\u5185\u6838\u51fa\u73b0\u7684\u54c8\u5e0c\u9519\u8bef\u95ee\u9898\u3002 64383c14a9 \u4fee\u590d Windows \u4e0b\u5185\u6838 Crash \u95ee\u9898\u3002 08a95db2ca \u652f\u6301 Windows \u4e0b\u7684 github action \u6784\u5efa\u3002 680e77a190 Windows \u4e0b\u9ed8\u8ba4\u4f7f\u7528 tcp \u76d1\u542c\u3002 94b73d939c DNAT \u540e\u66ff\u6362 Mac \u5730\u5740\u4e3a\u76ee\u6807\u5730\u5740\uff0c\u51cf\u5c11\u989d\u5916\u6027\u80fd\u5f00\u9500\u3002 \u5df2\u5408\u5165\u4e0a\u6e38\u4fee\u6539\uff1a - 20626ea909 \u7ec4\u64ad\u6d41\u91cf\u7ed5\u8fc7 LB \u548c ACL \u5904\u7406\u9636\u6bb5\uff0c\u4ee5\u63d0\u9ad8\u7279\u5b9a\u6570\u636e\u94fe\u8def\u6027\u80fd\u3002 - a2d9ff3ccd Deb \u6784\u5efa\u589e\u52a0\u7f16\u8bd1\u4f18\u5316\u9009\u9879\u3002","title":"\u5bf9\u4e0a\u6e38 OVS/OVN \u4fee\u6539"},{"location":"reference/ovs-ovn-customized/#ovsovn","text":"\u4e0a\u6e38 OVN/OVS \u6700\u521d\u8bbe\u8ba1\u76ee\u6807\u4e3a\u901a\u7528 SDN \u63a7\u5236\u5668\u548c\u6570\u636e\u5e73\u9762\u3002\u7531\u4e8e Kubernetes \u7f51\u7edc\u5b58\u5728\u4e00\u4e9b\u7279\u6b8a\u7684\u7528\u6cd5\uff0c \u5e76\u4e14 Kube-OVN \u53ea\u91cd\u70b9\u4f7f\u7528\u4e86\u90e8\u5206\u529f\u80fd\uff0c\u4e3a\u4e86 \u8fbe\u5230\u66f4\u597d\u7684\u6027\u80fd\u3001\u7a33\u5b9a\u6027\u548c\u7279\u5b9a\u7684\u529f\u80fd\uff0cKube-OVN \u5bf9\u4e0a\u6e38 OVN/OVS \u505a\u4e86\u90e8\u5206\u4fee\u6539\u3002\u7528\u6237\u5982\u679c\u4f7f\u7528\u81ea\u5df1\u7684 OVN/OVS \u914d\u5408 Kube-OVN \u7684\u63a7\u5236\u5668\u8fdb\u884c\u5de5\u4f5c\u65f6\u9700\u8981 \u6ce8\u610f \u4e0b\u8ff0\u7684\u6539\u52a8\u53ef\u80fd\u9020\u6210\u7684\u5f71\u54cd\u3002 \u672a\u5408\u5e76\u5165\u4e0a\u6e38\u4fee\u6539\uff1a 22ea22c40b \u8c03\u6574\u9009\u4e3e timer\uff0c\u907f\u514d\u5927\u89c4\u6a21\u96c6\u7fa4\u9009\u4e3e\u6296\u52a8\u3002 d26ae4de0a \u76ee\u7684\u5730\u5740\u975e Service \u6d41\u91cf\u7ed5\u8fc7 conntrack \u4ee5\u63d0\u9ad8\u7279\u5b9a\u6570\u636e\u94fe\u8def\u6027\u80fd\u3002 ab923b2522 ECMP \u7b97\u6cd5\u7531 dp_hash \u8c03\u6574\u4e3a hash\uff0c\u907f\u514d\u90e8\u5206\u5185\u6838\u51fa\u73b0\u7684\u54c8\u5e0c\u9519\u8bef\u95ee\u9898\u3002 64383c14a9 \u4fee\u590d Windows \u4e0b\u5185\u6838 Crash \u95ee\u9898\u3002 08a95db2ca \u652f\u6301 Windows \u4e0b\u7684 github action \u6784\u5efa\u3002 680e77a190 Windows \u4e0b\u9ed8\u8ba4\u4f7f\u7528 tcp \u76d1\u542c\u3002 94b73d939c DNAT \u540e\u66ff\u6362 Mac \u5730\u5740\u4e3a\u76ee\u6807\u5730\u5740\uff0c\u51cf\u5c11\u989d\u5916\u6027\u80fd\u5f00\u9500\u3002 \u5df2\u5408\u5165\u4e0a\u6e38\u4fee\u6539\uff1a - 20626ea909 \u7ec4\u64ad\u6d41\u91cf\u7ed5\u8fc7 LB \u548c ACL \u5904\u7406\u9636\u6bb5\uff0c\u4ee5\u63d0\u9ad8\u7279\u5b9a\u6570\u636e\u94fe\u8def\u6027\u80fd\u3002 - a2d9ff3ccd Deb \u6784\u5efa\u589e\u52a0\u7f16\u8bd1\u4f18\u5316\u9009\u9879\u3002","title":"\u5bf9\u4e0a\u6e38 OVS/OVN \u4fee\u6539"},{"location":"reference/tunnel-protocol/","text":"\u96a7\u9053\u534f\u8bae\u8bf4\u660e Kube-OVN \u4f7f\u7528 OVN/OVS \u4f5c\u4e3a\u6570\u636e\u5e73\u9762\u5b9e\u73b0\uff0c\u76ee\u524d\u652f\u6301 Geneve \uff0c Vxlan \u548c STT \u4e09\u79cd\u96a7\u9053\u5c01\u88c5\u534f\u8bae\u3002 \u8fd9\u4e09\u79cd\u534f\u8bae\u5728\u529f\u80fd\uff0c\u6027\u80fd\u548c\u6613\u7528\u6027\u4e0a\u5b58\u5728\u7740\u533a\u522b\uff0c\u672c\u6587\u6863\u5c06\u4ecb\u7ecd\u4e09\u79cd\u534f\u8bae\u5728\u4f7f\u7528\u4e2d\u7684\u5dee\u5f02\uff0c\u7528\u6237\u53ef\u6839\u636e\u81ea\u5df1\u7684\u60c5\u51b5\u8fdb\u884c\u9009\u62e9\u3002 Geneve Geneve \u534f\u8bae\u4e3a Kube-OVN \u90e8\u7f72\u65f6\u9009\u62e9\u7684\u9ed8\u8ba4\u96a7\u9053\u534f\u8bae\uff0c\u4e5f\u662f OVN \u9ed8\u8ba4\u63a8\u8350\u7684\u96a7\u9053\u534f\u8bae\u3002\u8be5\u534f\u8bae\u5728\u5185\u6838\u4e2d\u5f97\u5230\u4e86\u5e7f\u6cdb\u7684\u652f\u6301\uff0c \u5e76\u53ef\u4ee5\u5229\u7528\u73b0\u4ee3\u7f51\u5361\u7684\u901a\u7528 Offload \u80fd\u529b\u8fdb\u884c\u52a0\u901f\u3002\u7531\u4e8e Geneve \u6709\u7740\u8f83\u957f\u7684\u5934\u90e8\uff0c\u53ef\u4ee5\u4f7f\u7528 24bit \u7a7a\u95f4\u6765\u6807\u5fd7\u4e0d\u540c\u7684 datapath \u7528\u6237\u53ef\u4ee5\u521b\u5efa\u66f4\u591a\u6570\u91cf\u7684\u865a\u62df\u7f51\u7edc\u3002 \u5982\u679c\u4f7f\u7528 Mellanox \u6216\u82af\u542f\u6e90\u7684\u667a\u80fd\u7f51\u5361 OVS \u5378\u8f7d\uff0c Geneve \u9700\u8981\u8f83\u9ad8\u7248\u672c\u7684\u5185\u6838\u652f\u6301\uff0c\u9700\u8981\u9009\u62e9 5.4 \u4ee5\u4e0a\u7684\u4e0a\u6e38\u5185\u6838\uff0c \u6216 backport \u4e86\u8be5\u529f\u80fd\u7684\u5176\u4ed6\u517c\u5bb9\u5185\u6838\u3002 \u7531\u4e8e\u4f7f\u7528 UDP \u8fdb\u884c\u5c01\u88c5\uff0c\u8be5\u534f\u8bae\u5728\u5904\u7406 TCP over UDP \u65f6\u4e0d\u80fd\u5f88\u597d\u7684\u5229\u7528\u73b0\u4ee3\u7f51\u5361\u7684 TCP \u76f8\u5173\u5378\u8f7d\uff0c\u5728\u5904\u7406\u5927\u5305\u65f6\u4f1a\u6d88\u8017\u8f83\u591a CPU \u8d44\u6e90\u3002 Vxlan Vxlan \u4e3a\u4e0a\u6e38 OVN \u8fd1\u671f\u652f\u6301\u7684\u534f\u8bae\uff0c\u8be5\u534f\u8bae\u5728\u5185\u6838\u4e2d\u5f97\u5230\u4e86\u5e7f\u6cdb\u7684\u652f\u6301\uff0c \u5e76\u53ef\u4ee5\u5229\u7528\u73b0\u4ee3\u7f51\u5361\u7684\u901a\u7528 Offload \u80fd\u529b\u8fdb\u884c\u52a0\u901f\u3002 \u7531\u4e8e\u8be5\u534f\u8bae\u5934\u90e8\u6709\u9650\uff0c\u5e76\u4e14 OVN \u9700\u8981\u4f7f\u7528\u989d\u5916\u7684\u7a7a\u95f4\u8fdb\u884c\u7f16\u6392\uff0cdatapath \u7684\u6570\u91cf\u5b58\u5728\u9650\u5236\uff0c\u6700\u591a\u53ea\u80fd\u521b\u5efa 4096 \u4e2a datapath\uff0c \u6bcf\u4e2a datapath \u4e0b\u6700\u591a 4096 \u4e2a\u7aef\u53e3\u3002\u540c\u65f6\u7531\u4e8e\u7a7a\u95f4\u6709\u9650\uff0c\u57fa\u4e8e inport \u7684 ACL \u6ca1\u6709\u8fdb\u884c\u652f\u6301\u3002 \u5982\u679c\u4f7f\u7528 Mellanox \u6216\u82af\u542f\u6e90\u7684\u667a\u80fd\u7f51\u5361 OVS \u5378\u8f7d\uff0c Vxlan \u7684\u5378\u8f7d\u5728\u5e38\u89c1\u5185\u6838\u4e2d\u5df2\u83b7\u5f97\u652f\u6301\u3002 \u7531\u4e8e\u4f7f\u7528 UDP \u8fdb\u884c\u5c01\u88c5\uff0c\u8be5\u534f\u8bae\u5728\u5904\u7406 TCP over UDP \u65f6\u4e0d\u80fd\u5f88\u597d\u7684\u5229\u7528\u73b0\u4ee3\u7f51\u5361\u7684 TCP \u76f8\u5173\u5378\u8f7d\uff0c\u5728\u5904\u7406\u5927\u5305\u65f6\u4f1a\u6d88\u8017\u8f83\u591a CPU \u8d44\u6e90\u3002 STT STT \u534f\u8bae\u4e3a OVN \u8f83\u65e9\u652f\u6301\u7684\u96a7\u9053\u534f\u8bae\uff0c\u8be5\u534f\u8bae\u4f7f\u7528\u7c7b TCP \u7684\u5934\u90e8\uff0c\u53ef\u4ee5\u5145\u5206\u5229\u7528\u73b0\u4ee3\u7f51\u5361\u901a\u7528\u7684 TCP \u5378\u8f7d\u80fd\u529b\uff0c\u5927\u5e45\u63d0\u5347 TCP \u7684\u541e\u5410\u91cf\u3002\u540c\u65f6\u8be5\u534f\u8bae\u5934\u90e8\u8f83\u957f\u53ef\u652f\u6301\u5b8c\u6574\u7684 OVN \u80fd\u529b\u548c\u5927\u89c4\u6a21\u7684 datapath\u3002 \u8be5\u534f\u8bae\u672a\u5728\u5185\u6838\u4e2d\u652f\u6301\uff0c\u82e5\u8981\u4f7f\u7528\u9700\u8981\u989d\u5916\u7f16\u8bd1 OVS \u5185\u6838\u6a21\u5757\uff0c\u5e76\u5728\u5347\u7ea7\u5185\u6838\u65f6\u5bf9\u5e94\u518d\u6b21\u7f16\u8bd1\u65b0\u7248\u672c\u5185\u6838\u6a21\u5757\u3002 \u8be5\u534f\u8bae\u76ee\u524d\u672a\u88ab\u667a\u80fd\u7f51\u5361\u652f\u6301\uff0c\u65e0\u6cd5\u4f7f\u7528 OVS \u7684\u5378\u8f7d\u80fd\u529b\u3002 \u53c2\u8003\u8d44\u6599 https://ipwithease.com/vxlan-vs-geneve-understand-the-difference/ OVN FAQ What is Geneve","title":"\u96a7\u9053\u534f\u8bae\u8bf4\u660e"},{"location":"reference/tunnel-protocol/#_1","text":"Kube-OVN \u4f7f\u7528 OVN/OVS \u4f5c\u4e3a\u6570\u636e\u5e73\u9762\u5b9e\u73b0\uff0c\u76ee\u524d\u652f\u6301 Geneve \uff0c Vxlan \u548c STT \u4e09\u79cd\u96a7\u9053\u5c01\u88c5\u534f\u8bae\u3002 \u8fd9\u4e09\u79cd\u534f\u8bae\u5728\u529f\u80fd\uff0c\u6027\u80fd\u548c\u6613\u7528\u6027\u4e0a\u5b58\u5728\u7740\u533a\u522b\uff0c\u672c\u6587\u6863\u5c06\u4ecb\u7ecd\u4e09\u79cd\u534f\u8bae\u5728\u4f7f\u7528\u4e2d\u7684\u5dee\u5f02\uff0c\u7528\u6237\u53ef\u6839\u636e\u81ea\u5df1\u7684\u60c5\u51b5\u8fdb\u884c\u9009\u62e9\u3002","title":"\u96a7\u9053\u534f\u8bae\u8bf4\u660e"},{"location":"reference/tunnel-protocol/#geneve","text":"Geneve \u534f\u8bae\u4e3a Kube-OVN \u90e8\u7f72\u65f6\u9009\u62e9\u7684\u9ed8\u8ba4\u96a7\u9053\u534f\u8bae\uff0c\u4e5f\u662f OVN \u9ed8\u8ba4\u63a8\u8350\u7684\u96a7\u9053\u534f\u8bae\u3002\u8be5\u534f\u8bae\u5728\u5185\u6838\u4e2d\u5f97\u5230\u4e86\u5e7f\u6cdb\u7684\u652f\u6301\uff0c \u5e76\u53ef\u4ee5\u5229\u7528\u73b0\u4ee3\u7f51\u5361\u7684\u901a\u7528 Offload \u80fd\u529b\u8fdb\u884c\u52a0\u901f\u3002\u7531\u4e8e Geneve \u6709\u7740\u8f83\u957f\u7684\u5934\u90e8\uff0c\u53ef\u4ee5\u4f7f\u7528 24bit \u7a7a\u95f4\u6765\u6807\u5fd7\u4e0d\u540c\u7684 datapath \u7528\u6237\u53ef\u4ee5\u521b\u5efa\u66f4\u591a\u6570\u91cf\u7684\u865a\u62df\u7f51\u7edc\u3002 \u5982\u679c\u4f7f\u7528 Mellanox \u6216\u82af\u542f\u6e90\u7684\u667a\u80fd\u7f51\u5361 OVS \u5378\u8f7d\uff0c Geneve \u9700\u8981\u8f83\u9ad8\u7248\u672c\u7684\u5185\u6838\u652f\u6301\uff0c\u9700\u8981\u9009\u62e9 5.4 \u4ee5\u4e0a\u7684\u4e0a\u6e38\u5185\u6838\uff0c \u6216 backport \u4e86\u8be5\u529f\u80fd\u7684\u5176\u4ed6\u517c\u5bb9\u5185\u6838\u3002 \u7531\u4e8e\u4f7f\u7528 UDP \u8fdb\u884c\u5c01\u88c5\uff0c\u8be5\u534f\u8bae\u5728\u5904\u7406 TCP over UDP \u65f6\u4e0d\u80fd\u5f88\u597d\u7684\u5229\u7528\u73b0\u4ee3\u7f51\u5361\u7684 TCP \u76f8\u5173\u5378\u8f7d\uff0c\u5728\u5904\u7406\u5927\u5305\u65f6\u4f1a\u6d88\u8017\u8f83\u591a CPU \u8d44\u6e90\u3002","title":"Geneve"},{"location":"reference/tunnel-protocol/#vxlan","text":"Vxlan \u4e3a\u4e0a\u6e38 OVN \u8fd1\u671f\u652f\u6301\u7684\u534f\u8bae\uff0c\u8be5\u534f\u8bae\u5728\u5185\u6838\u4e2d\u5f97\u5230\u4e86\u5e7f\u6cdb\u7684\u652f\u6301\uff0c \u5e76\u53ef\u4ee5\u5229\u7528\u73b0\u4ee3\u7f51\u5361\u7684\u901a\u7528 Offload \u80fd\u529b\u8fdb\u884c\u52a0\u901f\u3002 \u7531\u4e8e\u8be5\u534f\u8bae\u5934\u90e8\u6709\u9650\uff0c\u5e76\u4e14 OVN \u9700\u8981\u4f7f\u7528\u989d\u5916\u7684\u7a7a\u95f4\u8fdb\u884c\u7f16\u6392\uff0cdatapath \u7684\u6570\u91cf\u5b58\u5728\u9650\u5236\uff0c\u6700\u591a\u53ea\u80fd\u521b\u5efa 4096 \u4e2a datapath\uff0c \u6bcf\u4e2a datapath \u4e0b\u6700\u591a 4096 \u4e2a\u7aef\u53e3\u3002\u540c\u65f6\u7531\u4e8e\u7a7a\u95f4\u6709\u9650\uff0c\u57fa\u4e8e inport \u7684 ACL \u6ca1\u6709\u8fdb\u884c\u652f\u6301\u3002 \u5982\u679c\u4f7f\u7528 Mellanox \u6216\u82af\u542f\u6e90\u7684\u667a\u80fd\u7f51\u5361 OVS \u5378\u8f7d\uff0c Vxlan \u7684\u5378\u8f7d\u5728\u5e38\u89c1\u5185\u6838\u4e2d\u5df2\u83b7\u5f97\u652f\u6301\u3002 \u7531\u4e8e\u4f7f\u7528 UDP \u8fdb\u884c\u5c01\u88c5\uff0c\u8be5\u534f\u8bae\u5728\u5904\u7406 TCP over UDP \u65f6\u4e0d\u80fd\u5f88\u597d\u7684\u5229\u7528\u73b0\u4ee3\u7f51\u5361\u7684 TCP \u76f8\u5173\u5378\u8f7d\uff0c\u5728\u5904\u7406\u5927\u5305\u65f6\u4f1a\u6d88\u8017\u8f83\u591a CPU \u8d44\u6e90\u3002","title":"Vxlan"},{"location":"reference/tunnel-protocol/#stt","text":"STT \u534f\u8bae\u4e3a OVN \u8f83\u65e9\u652f\u6301\u7684\u96a7\u9053\u534f\u8bae\uff0c\u8be5\u534f\u8bae\u4f7f\u7528\u7c7b TCP \u7684\u5934\u90e8\uff0c\u53ef\u4ee5\u5145\u5206\u5229\u7528\u73b0\u4ee3\u7f51\u5361\u901a\u7528\u7684 TCP \u5378\u8f7d\u80fd\u529b\uff0c\u5927\u5e45\u63d0\u5347 TCP \u7684\u541e\u5410\u91cf\u3002\u540c\u65f6\u8be5\u534f\u8bae\u5934\u90e8\u8f83\u957f\u53ef\u652f\u6301\u5b8c\u6574\u7684 OVN \u80fd\u529b\u548c\u5927\u89c4\u6a21\u7684 datapath\u3002 \u8be5\u534f\u8bae\u672a\u5728\u5185\u6838\u4e2d\u652f\u6301\uff0c\u82e5\u8981\u4f7f\u7528\u9700\u8981\u989d\u5916\u7f16\u8bd1 OVS \u5185\u6838\u6a21\u5757\uff0c\u5e76\u5728\u5347\u7ea7\u5185\u6838\u65f6\u5bf9\u5e94\u518d\u6b21\u7f16\u8bd1\u65b0\u7248\u672c\u5185\u6838\u6a21\u5757\u3002 \u8be5\u534f\u8bae\u76ee\u524d\u672a\u88ab\u667a\u80fd\u7f51\u5361\u652f\u6301\uff0c\u65e0\u6cd5\u4f7f\u7528 OVS \u7684\u5378\u8f7d\u80fd\u529b\u3002","title":"STT"},{"location":"reference/tunnel-protocol/#_2","text":"https://ipwithease.com/vxlan-vs-geneve-understand-the-difference/ OVN FAQ What is Geneve","title":"\u53c2\u8003\u8d44\u6599"},{"location":"reference/underlay-topology/","text":"\u6d41\u91cf\u62d3\u6251 \u901a\u8fc7 Pod IP \u8bbf\u95ee \u540c\u8282\u70b9\u540c\u5b50\u7f51 \u5185\u90e8\u903b\u8f91\u4ea4\u6362\u673a\u76f4\u63a5\u4ea4\u6362\u6570\u636e\u5305\uff0c\u4e0d\u8fdb\u5165\u5916\u90e8\u7f51\u7edc\u3002 \u8de8\u8282\u70b9\u540c\u5b50\u7f51 \u6570\u636e\u5305\u7ecf\u7531\u8282\u70b9\u7f51\u5361\u8fdb\u5165\u5916\u90e8\u4ea4\u6362\u673a\uff0c\u7531\u5916\u90e8\u4ea4\u6362\u673a\u8fdb\u884c\u4ea4\u6362\u3002 \u540c\u8282\u70b9\u4e0d\u540c\u5b50\u7f51 \u6570\u636e\u5305\u7ecf\u7531\u8282\u70b9\u7f51\u5361\u8fdb\u5165\u5916\u90e8\u7f51\u7edc\uff0c\u7531\u5916\u90e8\u4ea4\u6362\u673a\u53ca\u8def\u7531\u5668\u8fdb\u884c\u4ea4\u6362\u548c\u8def\u7531\u8f6c\u53d1\u3002 \u6b64\u5904 br-provider-1 \u548c br-provider-2 \u53ef\u4ee5\u662f\u540c\u4e00\u4e2a OVS \u7f51\u6865\uff0c\u5373\u591a\u4e2a\u4e0d\u540c\u5b50\u7f51\u53ef\u4ee5\u4f7f\u7528\u540c\u4e00\u4e2a Provider Network\u3002 \u8de8\u8282\u70b9\u4e0d\u540c\u5b50\u7f51 \u6570\u636e\u5305\u7ecf\u7531\u8282\u70b9\u7f51\u5361\u8fdb\u5165\u5916\u90e8\u7f51\u7edc\uff0c\u7531\u5916\u90e8\u4ea4\u6362\u673a\u53ca\u8def\u7531\u5668\u8fdb\u884c\u4ea4\u6362\u548c\u8def\u7531\u8f6c\u53d1\u3002 \u5916\u90e8\u8bbf\u95ee \u6570\u636e\u5305\u7ecf\u7531\u8282\u70b9\u7f51\u5361\u8fdb\u5165\u5916\u90e8\u7f51\u7edc\uff0c\u7531\u5916\u90e8\u4ea4\u6362\u673a\u53ca\u8def\u7531\u5668\u8fdb\u884c\u4ea4\u6362\u548c\u8def\u7531\u8f6c\u53d1\u3002 \u8282\u70b9\u4e0e Pod \u4e4b\u95f4\u7684\u901a\u4fe1\u5927\u4f53\u4e0a\u4e5f\u9075\u5faa\u6b64\u903b\u8f91\u3002 \u603b\u89c8 VLAN \u603b\u89c8 \u901a\u8fc7 Service IP \u8bbf\u95ee Kube-OVN \u4e3a\u6bcf\u4e2a Kubernetes Service \u5728\u6bcf\u4e2a\u5b50\u7f51\u7684\u903b\u8f91\u4ea4\u6362\u673a\u4e0a\u914d\u7f6e\u4e86\u8d1f\u8f7d\u5747\u8861\u3002\u5f53 Pod \u901a\u8fc7\u8bbf\u95ee Service IP \u8bbf\u95ee\u5176\u5b83 Pod \u65f6\uff0c\u4f1a\u6784\u9020\u4e00\u4e2a\u76ee\u7684\u5730\u5740\u4e3a Service IP\u3001\u76ee\u7684 MAC \u5730\u5740\u4e3a\u7f51\u5173 MAC \u5730\u5740\u7684\u7f51\u7edc\u5305\u3002\u7f51\u7edc\u5305\u8fdb\u5165\u903b\u8f91\u4ea4\u6362\u673a\u540e\uff0c\u8d1f\u8f7d\u5747\u8861\u4f1a\u5bf9\u7f51\u7edc\u5305\u8fdb\u884c\u62e6\u622a\u548c DNAT \u5904\u7406\uff0c\u5c06\u76ee\u7684 IP \u548c\u7aef\u53e3\u4fee\u6539\u4e3a Service \u5bf9\u5e94\u7684\u67d0\u4e2a Endpoint \u7684 IP \u548c\u7aef\u53e3\u3002\u7531\u4e8e\u903b\u8f91\u4ea4\u6362\u673a\u5e76\u672a\u4fee\u6539\u7f51\u7edc\u5305\u7684\u4e8c\u5c42\u76ee\u7684 MAC \u5730\u5740\uff0c\u7f51\u7edc\u5305\u5728\u8fdb\u5165\u5916\u90e8\u4ea4\u6362\u673a\u540e\u4ecd\u7136\u4f1a\u9001\u5230\u5916\u90e8\u7f51\u5173\uff0c\u6b64\u65f6\u9700\u8981\u5916\u90e8\u7f51\u5173\u5bf9\u7f51\u7edc\u5305\u8fdb\u884c\u8f6c\u53d1\u3002 \u540c\u8282\u70b9\u540c\u5b50\u7f51 \u540c\u8282\u70b9\u4e0d\u540c\u5b50\u7f51","title":"Underlay \u6d41\u91cf\u62d3\u6251"},{"location":"reference/underlay-topology/#_1","text":"","title":"\u6d41\u91cf\u62d3\u6251"},{"location":"reference/underlay-topology/#pod-ip","text":"","title":"\u901a\u8fc7 Pod IP \u8bbf\u95ee"},{"location":"reference/underlay-topology/#_2","text":"\u5185\u90e8\u903b\u8f91\u4ea4\u6362\u673a\u76f4\u63a5\u4ea4\u6362\u6570\u636e\u5305\uff0c\u4e0d\u8fdb\u5165\u5916\u90e8\u7f51\u7edc\u3002","title":"\u540c\u8282\u70b9\u540c\u5b50\u7f51"},{"location":"reference/underlay-topology/#_3","text":"\u6570\u636e\u5305\u7ecf\u7531\u8282\u70b9\u7f51\u5361\u8fdb\u5165\u5916\u90e8\u4ea4\u6362\u673a\uff0c\u7531\u5916\u90e8\u4ea4\u6362\u673a\u8fdb\u884c\u4ea4\u6362\u3002","title":"\u8de8\u8282\u70b9\u540c\u5b50\u7f51"},{"location":"reference/underlay-topology/#_4","text":"\u6570\u636e\u5305\u7ecf\u7531\u8282\u70b9\u7f51\u5361\u8fdb\u5165\u5916\u90e8\u7f51\u7edc\uff0c\u7531\u5916\u90e8\u4ea4\u6362\u673a\u53ca\u8def\u7531\u5668\u8fdb\u884c\u4ea4\u6362\u548c\u8def\u7531\u8f6c\u53d1\u3002 \u6b64\u5904 br-provider-1 \u548c br-provider-2 \u53ef\u4ee5\u662f\u540c\u4e00\u4e2a OVS \u7f51\u6865\uff0c\u5373\u591a\u4e2a\u4e0d\u540c\u5b50\u7f51\u53ef\u4ee5\u4f7f\u7528\u540c\u4e00\u4e2a Provider Network\u3002","title":"\u540c\u8282\u70b9\u4e0d\u540c\u5b50\u7f51"},{"location":"reference/underlay-topology/#_5","text":"\u6570\u636e\u5305\u7ecf\u7531\u8282\u70b9\u7f51\u5361\u8fdb\u5165\u5916\u90e8\u7f51\u7edc\uff0c\u7531\u5916\u90e8\u4ea4\u6362\u673a\u53ca\u8def\u7531\u5668\u8fdb\u884c\u4ea4\u6362\u548c\u8def\u7531\u8f6c\u53d1\u3002","title":"\u8de8\u8282\u70b9\u4e0d\u540c\u5b50\u7f51"},{"location":"reference/underlay-topology/#_6","text":"\u6570\u636e\u5305\u7ecf\u7531\u8282\u70b9\u7f51\u5361\u8fdb\u5165\u5916\u90e8\u7f51\u7edc\uff0c\u7531\u5916\u90e8\u4ea4\u6362\u673a\u53ca\u8def\u7531\u5668\u8fdb\u884c\u4ea4\u6362\u548c\u8def\u7531\u8f6c\u53d1\u3002 \u8282\u70b9\u4e0e Pod \u4e4b\u95f4\u7684\u901a\u4fe1\u5927\u4f53\u4e0a\u4e5f\u9075\u5faa\u6b64\u903b\u8f91\u3002","title":"\u5916\u90e8\u8bbf\u95ee"},{"location":"reference/underlay-topology/#_7","text":"","title":"\u603b\u89c8"},{"location":"reference/underlay-topology/#vlan","text":"","title":"VLAN \u603b\u89c8"},{"location":"reference/underlay-topology/#service-ip","text":"Kube-OVN \u4e3a\u6bcf\u4e2a Kubernetes Service \u5728\u6bcf\u4e2a\u5b50\u7f51\u7684\u903b\u8f91\u4ea4\u6362\u673a\u4e0a\u914d\u7f6e\u4e86\u8d1f\u8f7d\u5747\u8861\u3002\u5f53 Pod \u901a\u8fc7\u8bbf\u95ee Service IP \u8bbf\u95ee\u5176\u5b83 Pod \u65f6\uff0c\u4f1a\u6784\u9020\u4e00\u4e2a\u76ee\u7684\u5730\u5740\u4e3a Service IP\u3001\u76ee\u7684 MAC \u5730\u5740\u4e3a\u7f51\u5173 MAC \u5730\u5740\u7684\u7f51\u7edc\u5305\u3002\u7f51\u7edc\u5305\u8fdb\u5165\u903b\u8f91\u4ea4\u6362\u673a\u540e\uff0c\u8d1f\u8f7d\u5747\u8861\u4f1a\u5bf9\u7f51\u7edc\u5305\u8fdb\u884c\u62e6\u622a\u548c DNAT \u5904\u7406\uff0c\u5c06\u76ee\u7684 IP \u548c\u7aef\u53e3\u4fee\u6539\u4e3a Service \u5bf9\u5e94\u7684\u67d0\u4e2a Endpoint \u7684 IP \u548c\u7aef\u53e3\u3002\u7531\u4e8e\u903b\u8f91\u4ea4\u6362\u673a\u5e76\u672a\u4fee\u6539\u7f51\u7edc\u5305\u7684\u4e8c\u5c42\u76ee\u7684 MAC \u5730\u5740\uff0c\u7f51\u7edc\u5305\u5728\u8fdb\u5165\u5916\u90e8\u4ea4\u6362\u673a\u540e\u4ecd\u7136\u4f1a\u9001\u5230\u5916\u90e8\u7f51\u5173\uff0c\u6b64\u65f6\u9700\u8981\u5916\u90e8\u7f51\u5173\u5bf9\u7f51\u7edc\u5305\u8fdb\u884c\u8f6c\u53d1\u3002","title":"\u901a\u8fc7 Service IP \u8bbf\u95ee"},{"location":"reference/underlay-topology/#_8","text":"","title":"\u540c\u8282\u70b9\u540c\u5b50\u7f51"},{"location":"reference/underlay-topology/#_9","text":"","title":"\u540c\u8282\u70b9\u4e0d\u540c\u5b50\u7f51"},{"location":"start/one-step-install/","text":"\u4e00\u952e\u5b89\u88c5 Kube-OVN \u63d0\u4f9b\u4e86\u4e00\u952e\u5b89\u88c5\u811a\u672c\uff0c\u53ef\u4ee5\u5e2e\u52a9\u4f60\u5feb\u901f\u5b89\u88c5\u4e00\u4e2a\u9ad8\u53ef\u7528\uff0c\u751f\u4ea7\u5c31\u7eea\u7684 Kube-OVN \u5bb9\u5668\u7f51\u7edc\uff0c\u9ed8\u8ba4\u90e8\u7f72\u4e3a overlay \u7c7b\u578b\u7f51\u7edc\u3002 \u5982\u679c\u9ed8\u8ba4\u7f51\u7edc\u9700\u8981\u642d\u5efa Underlay/Vlan \u7f51\u7edc\uff0c\u8bf7\u53c2\u8003 Underlay \u7f51\u7edc\u652f\u6301 \u5b89\u88c5\u524d\u8bf7\u53c2\u8003 \u51c6\u5907\u5de5\u4f5c \u786e\u8ba4\u73af\u5883\u914d\u7f6e\u6b63\u786e\u3002 \u4e0b\u8f7d\u5b89\u88c5\u811a\u672c \u6211\u4eec\u63a8\u8350\u5728\u751f\u4ea7\u73af\u5883\u4f7f\u7528\u7a33\u5b9a\u7684 release \u7248\u672c\uff0c\u8bf7\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e0b\u8f7d\u7a33\u5b9a\u7248\u672c\u5b89\u88c5\u811a\u672c wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/dist/images/install.sh \u5982\u679c\u5bf9 master \u5206\u652f\u7684\u6700\u65b0\u529f\u80fd\u611f\u5174\u8da3\uff0c\u60f3\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e0b\u8f7d\u5f00\u53d1\u7248\u672c\u90e8\u7f72\u811a\u672c wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/images/install.sh \u4fee\u6539\u914d\u7f6e\u53c2\u6570 \u4f7f\u7528\u7f16\u8f91\u5668\u6253\u5f00\u811a\u672c\uff0c\u5e76\u4fee\u6539\u4e0b\u5217\u53d8\u91cf\u4e3a\u9884\u671f\u503c REGISTRY=\"kubeovn\" # \u955c\u50cf\u4ed3\u5e93\u5730\u5740 VERSION=\"v1.10.1\" # \u955c\u50cf\u7248\u672c/Tag POD_CIDR=\"10.16.0.0/16\" # \u9ed8\u8ba4\u5b50\u7f51 CIDR \u4e0d\u8981\u548c SVC/NODE/JOIN CIDR \u91cd\u53e0 SVC_CIDR=\"10.96.0.0/12\" # \u9700\u8981\u548c apiserver \u7684 service-cluster-ip-range \u4fdd\u6301\u4e00\u81f4 JOIN_CIDR=\"100.64.0.0/16\" # Pod \u548c\u4e3b\u673a\u901a\u4fe1\u7f51\u7edc CIDR\uff0c\u4e0d\u8981\u548c SVC/NODE/POD CIDR \u91cd\u53e0 LABEL=\"node-role.kubernetes.io/master\" # \u90e8\u7f72 OVN DB \u8282\u70b9\u7684\u6807\u7b7e IFACE=\"\" # \u5bb9\u5668\u7f51\u7edc\u6240\u4f7f\u7528\u7684\u7684\u5bbf\u4e3b\u673a\u7f51\u5361\u540d\uff0c\u5982\u679c\u4e3a\u7a7a\u5219\u4f7f\u7528 Kubernetes \u4e2d\u7684 Node IP \u6240\u5728\u7f51\u5361 TUNNEL_TYPE=\"geneve\" # \u96a7\u9053\u5c01\u88c5\u534f\u8bae\uff0c\u53ef\u9009 geneve, vxlan \u6216 stt\uff0cstt \u9700\u8981\u5355\u72ec\u7f16\u8bd1 ovs \u5185\u6838\u6a21\u5757 \u53ef\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u6765\u5339\u914d\u7f51\u5361\u540d\uff0c\u4f8b\u5982 IFACE=enp6s0f0,eth.* \u6267\u884c\u5b89\u88c5\u811a\u672c bash install.sh \u7b49\u5f85\u5b89\u88c5\u5b8c\u6210\u3002","title":"\u4e00\u952e\u5b89\u88c5"},{"location":"start/one-step-install/#_1","text":"Kube-OVN \u63d0\u4f9b\u4e86\u4e00\u952e\u5b89\u88c5\u811a\u672c\uff0c\u53ef\u4ee5\u5e2e\u52a9\u4f60\u5feb\u901f\u5b89\u88c5\u4e00\u4e2a\u9ad8\u53ef\u7528\uff0c\u751f\u4ea7\u5c31\u7eea\u7684 Kube-OVN \u5bb9\u5668\u7f51\u7edc\uff0c\u9ed8\u8ba4\u90e8\u7f72\u4e3a overlay \u7c7b\u578b\u7f51\u7edc\u3002 \u5982\u679c\u9ed8\u8ba4\u7f51\u7edc\u9700\u8981\u642d\u5efa Underlay/Vlan \u7f51\u7edc\uff0c\u8bf7\u53c2\u8003 Underlay \u7f51\u7edc\u652f\u6301 \u5b89\u88c5\u524d\u8bf7\u53c2\u8003 \u51c6\u5907\u5de5\u4f5c \u786e\u8ba4\u73af\u5883\u914d\u7f6e\u6b63\u786e\u3002","title":"\u4e00\u952e\u5b89\u88c5"},{"location":"start/one-step-install/#_2","text":"\u6211\u4eec\u63a8\u8350\u5728\u751f\u4ea7\u73af\u5883\u4f7f\u7528\u7a33\u5b9a\u7684 release \u7248\u672c\uff0c\u8bf7\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e0b\u8f7d\u7a33\u5b9a\u7248\u672c\u5b89\u88c5\u811a\u672c wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/dist/images/install.sh \u5982\u679c\u5bf9 master \u5206\u652f\u7684\u6700\u65b0\u529f\u80fd\u611f\u5174\u8da3\uff0c\u60f3\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e0b\u8f7d\u5f00\u53d1\u7248\u672c\u90e8\u7f72\u811a\u672c wget https://raw.githubusercontent.com/kubeovn/kube-ovn/master/dist/images/install.sh","title":"\u4e0b\u8f7d\u5b89\u88c5\u811a\u672c"},{"location":"start/one-step-install/#_3","text":"\u4f7f\u7528\u7f16\u8f91\u5668\u6253\u5f00\u811a\u672c\uff0c\u5e76\u4fee\u6539\u4e0b\u5217\u53d8\u91cf\u4e3a\u9884\u671f\u503c REGISTRY=\"kubeovn\" # \u955c\u50cf\u4ed3\u5e93\u5730\u5740 VERSION=\"v1.10.1\" # \u955c\u50cf\u7248\u672c/Tag POD_CIDR=\"10.16.0.0/16\" # \u9ed8\u8ba4\u5b50\u7f51 CIDR \u4e0d\u8981\u548c SVC/NODE/JOIN CIDR \u91cd\u53e0 SVC_CIDR=\"10.96.0.0/12\" # \u9700\u8981\u548c apiserver \u7684 service-cluster-ip-range \u4fdd\u6301\u4e00\u81f4 JOIN_CIDR=\"100.64.0.0/16\" # Pod \u548c\u4e3b\u673a\u901a\u4fe1\u7f51\u7edc CIDR\uff0c\u4e0d\u8981\u548c SVC/NODE/POD CIDR \u91cd\u53e0 LABEL=\"node-role.kubernetes.io/master\" # \u90e8\u7f72 OVN DB \u8282\u70b9\u7684\u6807\u7b7e IFACE=\"\" # \u5bb9\u5668\u7f51\u7edc\u6240\u4f7f\u7528\u7684\u7684\u5bbf\u4e3b\u673a\u7f51\u5361\u540d\uff0c\u5982\u679c\u4e3a\u7a7a\u5219\u4f7f\u7528 Kubernetes \u4e2d\u7684 Node IP \u6240\u5728\u7f51\u5361 TUNNEL_TYPE=\"geneve\" # \u96a7\u9053\u5c01\u88c5\u534f\u8bae\uff0c\u53ef\u9009 geneve, vxlan \u6216 stt\uff0cstt \u9700\u8981\u5355\u72ec\u7f16\u8bd1 ovs \u5185\u6838\u6a21\u5757 \u53ef\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u6765\u5339\u914d\u7f51\u5361\u540d\uff0c\u4f8b\u5982 IFACE=enp6s0f0,eth.*","title":"\u4fee\u6539\u914d\u7f6e\u53c2\u6570"},{"location":"start/one-step-install/#_4","text":"bash install.sh \u7b49\u5f85\u5b89\u88c5\u5b8c\u6210\u3002","title":"\u6267\u884c\u5b89\u88c5\u811a\u672c"},{"location":"start/prepare/","text":"\u51c6\u5907\u5de5\u4f5c Kube-OVN \u662f\u4e00\u4e2a\u7b26\u5408 CNI \u89c4\u8303\u7684\u7f51\u7edc\u7ec4\u4ef6\uff0c\u5176\u8fd0\u884c\u9700\u8981\u4f9d\u8d56 Kubernetes \u73af\u5883\u53ca\u5bf9\u5e94\u7684\u5185\u6838\u7f51\u7edc\u6a21\u5757\u3002 \u4ee5\u4e0b\u662f\u901a\u8fc7\u6d4b\u8bd5\u7684\u64cd\u4f5c\u7cfb\u7edf\u548c\u8f6f\u4ef6\u7248\u672c\uff0c\u73af\u5883\u914d\u7f6e\u548c\u6240\u9700\u8981\u5f00\u653e\u7684\u7aef\u53e3\u4fe1\u606f\u3002 \u8f6f\u4ef6\u7248\u672c Kubernetes >= 1.16\uff0c\u63a8\u8350 1.19 \u4ee5\u4e0a\u7248\u672c\u3002 Docker >= 1.12.6, Containerd >= 1.3.4\u3002 \u64cd\u4f5c\u7cfb\u7edf: CentOS 7/8, Ubuntu 16.04/18.04/20.04\u3002 \u5176\u4ed6 Linux \u53d1\u884c\u7248\uff0c\u9700\u8981\u68c0\u67e5\u4e00\u4e0b\u5185\u6838\u6a21\u5757\u662f\u5426\u5b58\u5728 geneve , openvswitch , ip_tables \u548c iptable_nat \uff0cKube-OVN \u6b63\u5e38\u5de5\u4f5c\u4f9d\u8d56\u4e0a\u8ff0\u6a21\u5757\u3002 \u6ce8\u610f\u4e8b\u9879 \uff1a \u5982\u679c\u5185\u6838\u7248\u672c\u4e3a 3.10.0-862 \u5185\u6838 netfilter \u6a21\u5757\u5b58\u5728 bug \u4f1a\u5bfc\u81f4 Kube-OVN \u5185\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668\u65e0\u6cd5\u5de5\u4f5c\uff0c\u9700\u8981\u5bf9\u5185\u6838\u5347\u7ea7\uff0c\u5efa\u8bae\u4f7f\u7528 CentOS \u5b98\u65b9\u5bf9\u5e94\u7248\u672c\u6700\u65b0\u5185\u6838\u4fdd\u8bc1\u7cfb\u7edf\u7684\u5b89\u5168\u3002\u76f8\u5173\u5185\u6838 bug \u53c2\u8003 Floating IPs broken after kernel upgrade to Centos/RHEL 7.5 - DNAT not working \u3002 \u5982\u679c\u5185\u6838\u7248\u672c\u4e3a 4.4 \u5219\u5bf9\u5e94\u7684\u5185\u6838 openvswitch \u6a21\u5757\u5b58\u5728\u95ee\u9898\uff0c\u5efa\u8bae\u5347\u7ea7\u6216\u624b\u52a8\u7f16\u8bd1 openvswitch \u65b0\u7248\u672c\u6a21\u5757\u8fdb\u884c\u66f4\u65b0 Geneve \u96a7\u9053\u5efa\u7acb\u9700\u8981\u68c0\u67e5 IPv6\uff0c\u53ef\u901a\u8fc7 cat /proc/cmdline \u68c0\u67e5\u5185\u6838\u542f\u52a8\u53c2\u6570\uff0c \u76f8\u5173\u5185\u6838 bug \u8bf7\u53c2\u8003 Geneve tunnels don't work when ipv6 is disabled \u73af\u5883\u914d\u7f6e Kernel \u542f\u52a8\u9700\u8981\u5f00\u542f ipv6, \u5982\u679c kernel \u542f\u52a8\u53c2\u6570\u5305\u542b ipv6.disable=1 \u9700\u8981\u5c06\u5176\u8bbe\u7f6e\u4e3a 0\u3002 kube-proxy \u6b63\u5e38\u5de5\u4f5c\uff0cKube-OVN \u53ef\u4ee5\u901a\u8fc7 SVC IP \u8bbf\u95ee\u5230 kube-apiserver \u3002 \u786e\u8ba4 kubelet \u914d\u7f6e\u53c2\u6570\u5f00\u542f\u4e86 CNI\uff0c\u5e76\u4e14\u914d\u7f6e\u5728\u6807\u51c6\u8def\u5f84\u4e0b, kubelet \u542f\u52a8\u65f6\u5e94\u5305\u542b\u5982\u4e0b\u53c2\u6570 --network-plugin=cni --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d \u3002 \u786e\u8ba4\u672a\u5b89\u88c5\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\uff0c\u6216\u8005\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u5df2\u7ecf\u88ab\u6e05\u9664\uff0c\u68c0\u67e5 /etc/cni/net.d/ \u8def\u5f84\u4e0b\u65e0\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u914d\u7f6e\u6587\u4ef6\u3002\u5982\u679c\u4e4b\u524d\u5b89\u88c5\u8fc7\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\uff0c\u5efa\u8bae\u5220\u9664\u540e\u91cd\u542f\u673a\u5668\u6e05\u7406\u6b8b\u7559\u7f51\u7edc\u8d44\u6e90\u3002 \u7aef\u53e3\u4fe1\u606f \u7ec4\u4ef6 \u7aef\u53e3 \u7528\u9014 ovn-central 6641/tcp, 6642/tcp, 6643/tcp, 6644/tcp ovn-db \u548c raft server \u76d1\u542c\u7aef\u53e3 ovs-ovn Geneve 6081/udp, STT 7471/tcp, Vxlan 4789/udp \u96a7\u9053\u7aef\u53e3 kube-ovn-controller 10660/tcp \u76d1\u63a7\u76d1\u542c\u7aef\u53e3 kube-ovn-daemon 10665/tcp \u76d1\u63a7\u76d1\u542c\u7aef\u53e3 kube-ovn-monitor 10661/tcp \u76d1\u63a7\u76d1\u542c\u7aef\u53e3","title":"\u51c6\u5907\u5de5\u4f5c"},{"location":"start/prepare/#_1","text":"Kube-OVN \u662f\u4e00\u4e2a\u7b26\u5408 CNI \u89c4\u8303\u7684\u7f51\u7edc\u7ec4\u4ef6\uff0c\u5176\u8fd0\u884c\u9700\u8981\u4f9d\u8d56 Kubernetes \u73af\u5883\u53ca\u5bf9\u5e94\u7684\u5185\u6838\u7f51\u7edc\u6a21\u5757\u3002 \u4ee5\u4e0b\u662f\u901a\u8fc7\u6d4b\u8bd5\u7684\u64cd\u4f5c\u7cfb\u7edf\u548c\u8f6f\u4ef6\u7248\u672c\uff0c\u73af\u5883\u914d\u7f6e\u548c\u6240\u9700\u8981\u5f00\u653e\u7684\u7aef\u53e3\u4fe1\u606f\u3002","title":"\u51c6\u5907\u5de5\u4f5c"},{"location":"start/prepare/#_2","text":"Kubernetes >= 1.16\uff0c\u63a8\u8350 1.19 \u4ee5\u4e0a\u7248\u672c\u3002 Docker >= 1.12.6, Containerd >= 1.3.4\u3002 \u64cd\u4f5c\u7cfb\u7edf: CentOS 7/8, Ubuntu 16.04/18.04/20.04\u3002 \u5176\u4ed6 Linux \u53d1\u884c\u7248\uff0c\u9700\u8981\u68c0\u67e5\u4e00\u4e0b\u5185\u6838\u6a21\u5757\u662f\u5426\u5b58\u5728 geneve , openvswitch , ip_tables \u548c iptable_nat \uff0cKube-OVN \u6b63\u5e38\u5de5\u4f5c\u4f9d\u8d56\u4e0a\u8ff0\u6a21\u5757\u3002 \u6ce8\u610f\u4e8b\u9879 \uff1a \u5982\u679c\u5185\u6838\u7248\u672c\u4e3a 3.10.0-862 \u5185\u6838 netfilter \u6a21\u5757\u5b58\u5728 bug \u4f1a\u5bfc\u81f4 Kube-OVN \u5185\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668\u65e0\u6cd5\u5de5\u4f5c\uff0c\u9700\u8981\u5bf9\u5185\u6838\u5347\u7ea7\uff0c\u5efa\u8bae\u4f7f\u7528 CentOS \u5b98\u65b9\u5bf9\u5e94\u7248\u672c\u6700\u65b0\u5185\u6838\u4fdd\u8bc1\u7cfb\u7edf\u7684\u5b89\u5168\u3002\u76f8\u5173\u5185\u6838 bug \u53c2\u8003 Floating IPs broken after kernel upgrade to Centos/RHEL 7.5 - DNAT not working \u3002 \u5982\u679c\u5185\u6838\u7248\u672c\u4e3a 4.4 \u5219\u5bf9\u5e94\u7684\u5185\u6838 openvswitch \u6a21\u5757\u5b58\u5728\u95ee\u9898\uff0c\u5efa\u8bae\u5347\u7ea7\u6216\u624b\u52a8\u7f16\u8bd1 openvswitch \u65b0\u7248\u672c\u6a21\u5757\u8fdb\u884c\u66f4\u65b0 Geneve \u96a7\u9053\u5efa\u7acb\u9700\u8981\u68c0\u67e5 IPv6\uff0c\u53ef\u901a\u8fc7 cat /proc/cmdline \u68c0\u67e5\u5185\u6838\u542f\u52a8\u53c2\u6570\uff0c \u76f8\u5173\u5185\u6838 bug \u8bf7\u53c2\u8003 Geneve tunnels don't work when ipv6 is disabled","title":"\u8f6f\u4ef6\u7248\u672c"},{"location":"start/prepare/#_3","text":"Kernel \u542f\u52a8\u9700\u8981\u5f00\u542f ipv6, \u5982\u679c kernel \u542f\u52a8\u53c2\u6570\u5305\u542b ipv6.disable=1 \u9700\u8981\u5c06\u5176\u8bbe\u7f6e\u4e3a 0\u3002 kube-proxy \u6b63\u5e38\u5de5\u4f5c\uff0cKube-OVN \u53ef\u4ee5\u901a\u8fc7 SVC IP \u8bbf\u95ee\u5230 kube-apiserver \u3002 \u786e\u8ba4 kubelet \u914d\u7f6e\u53c2\u6570\u5f00\u542f\u4e86 CNI\uff0c\u5e76\u4e14\u914d\u7f6e\u5728\u6807\u51c6\u8def\u5f84\u4e0b, kubelet \u542f\u52a8\u65f6\u5e94\u5305\u542b\u5982\u4e0b\u53c2\u6570 --network-plugin=cni --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d \u3002 \u786e\u8ba4\u672a\u5b89\u88c5\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\uff0c\u6216\u8005\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u5df2\u7ecf\u88ab\u6e05\u9664\uff0c\u68c0\u67e5 /etc/cni/net.d/ \u8def\u5f84\u4e0b\u65e0\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u914d\u7f6e\u6587\u4ef6\u3002\u5982\u679c\u4e4b\u524d\u5b89\u88c5\u8fc7\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\uff0c\u5efa\u8bae\u5220\u9664\u540e\u91cd\u542f\u673a\u5668\u6e05\u7406\u6b8b\u7559\u7f51\u7edc\u8d44\u6e90\u3002","title":"\u73af\u5883\u914d\u7f6e"},{"location":"start/prepare/#_4","text":"\u7ec4\u4ef6 \u7aef\u53e3 \u7528\u9014 ovn-central 6641/tcp, 6642/tcp, 6643/tcp, 6644/tcp ovn-db \u548c raft server \u76d1\u542c\u7aef\u53e3 ovs-ovn Geneve 6081/udp, STT 7471/tcp, Vxlan 4789/udp \u96a7\u9053\u7aef\u53e3 kube-ovn-controller 10660/tcp \u76d1\u63a7\u76d1\u542c\u7aef\u53e3 kube-ovn-daemon 10665/tcp \u76d1\u63a7\u76d1\u542c\u7aef\u53e3 kube-ovn-monitor 10661/tcp \u76d1\u63a7\u76d1\u542c\u7aef\u53e3","title":"\u7aef\u53e3\u4fe1\u606f"},{"location":"start/underlay/","text":"Underlay \u7f51\u7edc\u5b89\u88c5 \u9ed8\u8ba4\u60c5\u51b5\u4e0b Kube-OVN \u7684\u9ed8\u8ba4\u5b50\u7f51\u4f7f\u7528 Geneve \u5bf9\u8de8\u4e3b\u673a\u6d41\u91cf\u8fdb\u884c\u5c01\u88c5\uff0c\u5728\u57fa\u7840\u8bbe\u65bd\u4e4b\u4e0a\u62bd\u8c61\u51fa\u4e00\u5c42\u865a\u62df\u7684 Overlay \u7f51\u7edc\u3002 \u5bf9\u4e8e\u5e0c\u671b\u5bb9\u5668\u7f51\u7edc\u76f4\u63a5\u4f7f\u7528\u7269\u7406\u7f51\u7edc\u5730\u5740\u6bb5\u60c5\u51b5\uff0c\u53ef\u4ee5\u5c06 Kube-OVN \u7684\u9ed8\u8ba4\u5b50\u7f51\u5de5\u4f5c\u5728 Underlay \u6a21\u5f0f\uff0c\u53ef\u4ee5\u76f4\u63a5\u7ed9\u5bb9\u5668\u5206\u914d\u7269\u7406\u7f51\u7edc\u4e2d\u7684\u5730\u5740\u8d44\u6e90\uff0c\u8fbe\u5230\u66f4\u597d\u7684\u6027\u80fd\u4ee5\u53ca\u548c\u7269\u7406\u7f51\u7edc\u7684\u8fde\u901a\u6027\u3002 \u529f\u80fd\u9650\u5236 \u8be5\u6a21\u5f0f\u4e0b Kube-OVN \u7f51\u7edc\u8868\u73b0\u548c Macvlan \u7c7b\u4f3c\uff0c\u4f46\u76f8\u6bd4 Macvlan \u63d0\u4f9b\u4e86\u5730\u5740\u7ba1\u7406\uff0c\u56fa\u5b9aIP\uff0c\u670d\u52a1\u53d1\u73b0\uff0c\u7f51\u7edc\u7b56\u7565\u548c QoS \u7b49\u529f\u80fd\u3002 \u4f46\u7531\u4e8e\u8be5\u6a21\u5f0f\u4e0b\u5bb9\u5668\u7f51\u7edc\u76f4\u63a5\u4f7f\u7528\u7269\u7406\u7f51\u7edc\u8d44\u6e90\u8fdb\u884c\u5305\u8f6c\u53d1\uff0cOverlay \u6a21\u5f0f\u4e0b\u7684 SNAT/EIP\uff0c \u5206\u5e03\u5f0f\u7f51\u5173/\u96c6\u4e2d\u5f0f\u7f51\u5173\u7b49 L3 \u529f\u80fd\u65e0\u6cd5\u4f7f\u7528\u3002 \u548c Macvlan \u6bd4\u8f83 Kube-OVN \u7684 Underlay \u6a21\u5f0f\u548c Macvlan \u5de5\u4f5c\u6a21\u5f0f\u5341\u5206\u7c7b\u4f3c\uff0c\u5728\u529f\u80fd\u548c\u6027\u80fd\u4e0a\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u4e2a\u533a\u522b\uff1a \u7531\u4e8e Macvlan \u7684\u5185\u6838\u8def\u5f84\u66f4\u77ed\uff0c\u5e76\u4e14\u4e0d\u9700\u8981 OVS \u5bf9\u6570\u636e\u5305\u8fdb\u884c\u5904\u7406\uff0cMacvlan \u5728\u541e\u5410\u91cf\u548c\u5ef6\u8fdf\u6027\u80fd\u6307\u6807\u4e0a\u8868\u73b0\u4f1a\u66f4\u597d\u3002 Kube-OVN \u901a\u8fc7\u6d41\u8868\u63d0\u4f9b\u4e86 arp-proxy \u529f\u80fd\uff0c\u53ef\u4ee5\u7f13\u89e3\u5927\u89c4\u6a21\u7f51\u7edc\u4e0b\u7684 arp \u5e7f\u64ad\u98ce\u66b4\u98ce\u9669\u3002 \u7531\u4e8e Macvlan \u5de5\u4f5c\u5728\u5185\u6838\u5e95\u5c42\uff0c\u4f1a\u7ed5\u8fc7\u5bbf\u4e3b\u673a\u7684 netfilter\uff0cService \u548c NetworkPolicy \u529f\u80fd\u9700\u8981\u989d\u5916\u5f00\u53d1\u3002Kube-OVN \u901a\u8fc7 OVS \u6d41\u8868\u63d0\u4f9b\u4e86 Service \u548c NetworkPolicy \u7684\u80fd\u529b\u3002 \u786c\u4ef6\u73af\u5883\u8981\u6c42 \u5728 Underlay \u6a21\u5f0f\u4e0b\uff0c OVS \u5c06\u4f1a\u6865\u63a5\u4e00\u4e2a\u8282\u70b9\u7f51\u5361\u5230 OVS \u7f51\u6865\uff0c\u5e76\u5c06\u6570\u636e\u5305\u76f4\u63a5\u901a\u8fc7\u8be5\u8282\u70b9\u7f51\u5361\u5bf9\u5916\u53d1\u9001\uff0cL2/L3 \u5c42\u9762\u7684\u8f6c\u53d1\u80fd\u529b\u9700\u8981\u4f9d\u8d56\u5e95\u5c42\u7f51\u7edc\u8bbe\u5907\u3002 \u9700\u8981\u9884\u5148\u5728\u5e95\u5c42\u7f51\u7edc\u8bbe\u5907\u914d\u7f6e\u5bf9\u5e94\u7684\u7f51\u5173\u3001Vlan \u548c\u5b89\u5168\u7b56\u7565\u7b49\u914d\u7f6e\u3002 \u5bf9\u4e8e OpenStack \u7684 VM \u73af\u5883\uff0c\u9700\u8981\u5c06\u5bf9\u5e94\u7f51\u7edc\u7aef\u53e3\u7684 PortSecurity \u5173\u95ed\u3002 \u5bf9\u4e8e VMware \u7684 vswtich \u7f51\u7edc\uff0c\u9700\u8981\u5c06 MAC Address Changes , Forged Transmits \u548c Promiscuous Mode Operation \u8bbe\u7f6e\u4e3a allow \u3002 \u516c\u6709\u4e91\uff0c\u4f8b\u5982 AWS\u3001GCE\u3001\u963f\u91cc\u4e91\u7b49\u7531\u4e8e\u4e0d\u652f\u6301\u7528\u6237\u81ea\u5b9a\u4e49 Mac \u65e0\u6cd5\u652f\u6301 Underlay \u6a21\u5f0f\u7f51\u7edc\u3002 \u5bf9\u4e8e Service \u8bbf\u95ee\u6d41\u91cf\uff0cPod \u4f1a\u5c06\u6570\u636e\u5305\u9996\u5148\u53d1\u9001\u81f3\u7f51\u5173\uff0c\u7f51\u5173\u9700\u8981\u6709\u80fd\u5c06\u6570\u636e\u5305\u8f6c\u53d1\u56de\u672c\u7f51\u6bb5\u7684\u80fd\u529b\u3002 \u5bf9\u4e8e\u7ba1\u7406\u7f51\u548c\u5bb9\u5668\u7f51\u4f7f\u7528\u540c\u4e00\u4e2a\u7f51\u5361\u7684\u60c5\u51b5\u4e0b\uff0cKube-OVN \u4f1a\u5c06\u7f51\u5361\u7684 Mac \u5730\u5740\u3001IP \u5730\u5740\u3001\u8def\u7531\u4ee5\u53ca MTU \u5c06\u8f6c\u79fb\u6216\u590d\u5236\u81f3\u5bf9\u5e94\u7684 OVS Bridge\uff0c \u4ee5\u652f\u6301\u5355\u7f51\u5361\u90e8\u7f72 Underlay \u7f51\u7edc\u3002OVS Bridge \u540d\u79f0\u683c\u5f0f\u4e3a br-PROVIDER_NAME \uff0c PROVIDER_NAME \u4e3a Provider \u7f51\u7edc\u540d\u79f0\uff08\u9ed8\u8ba4\u4e3a provider\uff09\u3002 \u5b89\u88c5\u65b9\u5f0f \u90e8\u7f72\u65f6\u6307\u5b9a\u7f51\u7edc\u6a21\u5f0f \u8be5\u90e8\u7f72\u6a21\u5f0f\u5c06\u9ed8\u8ba4\u5b50\u7f51\u8bbe\u7f6e\u4e3a Underlay \u6a21\u5f0f\uff0c\u6240\u6709\u672a\u6307\u5b9a\u5b50\u7f51\u7684 Pod \u5747\u4f1a\u9ed8\u8ba4\u8fd0\u884c\u5728 Underlay \u7f51\u7edc\u4e2d \u4e0b\u8f7d\u5b89\u88c5\u811a\u672c wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/dist/images/install.sh \u4fee\u6539\u811a\u672c\u4e2d\u76f8\u5e94\u914d\u7f6e NETWORK_TYPE # \u8bbe\u7f6e\u4e3a vlan VLAN_INTERFACE_NAME # \u8bbe\u7f6e\u4e3a\u5bbf\u4e3b\u673a\u4e0a\u627f\u62c5\u5bb9\u5668\u6d41\u91cf\u7684\u7f51\u5361\uff0c\u4f8b\u5982 eth1 VLAN_ID # \u4ea4\u6362\u673a\u6240\u63a5\u53d7\u7684 VLAN Tag\uff0c\u82e5\u8bbe\u7f6e\u4e3a 0 \u5219\u4e0d\u505a VLAN \u5c01\u88c5 POD_CIDR # \u8bbe\u7f6e\u4e3a\u7269\u7406\u7f51\u7edc CIDR\uff0c \u4f8b\u5982 192.168.1.0/24 POD_GATEWAY # \u8bbe\u7f6e\u4e3a\u7269\u7406\u7f51\u7edc\u7f51\u5173\uff0c\u4f8b\u5982192.168.1.1 EXCLUDE_IPS # \u6392\u9664\u8303\u56f4\uff0c\u907f\u514d\u5bb9\u5668\u7f51\u6bb5\u548c\u7269\u7406\u7f51\u7edc\u5df2\u7528 IP \u51b2\u7a81\uff0c\u4f8b\u5982 192.168.1.1..192.168.1.100 \u8fd0\u884c\u5b89\u88c5\u811a\u672c bash install.sh \u901a\u8fc7 CRD \u52a8\u6001\u521b\u5efa Underlay \u7f51\u7edc \u8be5\u65b9\u5f0f\u53ef\u5728\u5b89\u88c5\u540e\u52a8\u6001\u7684\u521b\u5efa\u67d0\u4e2a Underlay \u5b50\u7f51\u4f9b Pod \u4f7f\u7528\u3002 \u521b\u5efa ProviderNetwork \u521b\u5efa\u5982\u4e0b ProviderNetwork \u5e76\u5e94\u7528: apiVersion: kubeovn.io/v1 kind: ProviderNetwork metadata: name: net1 spec: defaultInterface: eth1 customInterfaces: - interface: eth2 nodes: - node1 excludeNodes: - node2 \u6ce8\u610f\uff1aProviderNetwork \u8d44\u6e90\u540d\u79f0\u7684\u957f\u5ea6\u4e0d\u5f97\u8d85\u8fc7 12\u3002 defaultInterface \u4e3a\u9ed8\u8ba4\u4f7f\u7528\u7684\u8282\u70b9\u7f51\u5361\u540d\u79f0\uff1b customInterfaces \u4e3a\u53ef\u9009\u9879\uff0c\u53ef\u9488\u5bf9\u7279\u5b9a\u8282\u70b9\u6307\u5b9a\u9700\u8981\u4f7f\u7528\u7684\u7f51\u5361\uff1b excludeNodes \u4e5f\u662f\u53ef\u9009\u9879\uff0c\u7528\u4e8e\u6307\u5b9a\u4e0d\u6865\u63a5\u7f51\u5361\u7684\u8282\u70b9\u3002 ProviderNetwork \u521b\u5efa\u6210\u529f\u540e\uff0c\u5404\u8282\u70b9\uff08\u9664 excludeNodes \u5916\uff09\u4e2d\u4f1a\u521b\u5efa\u540d\u4e3a br-net1\uff08\u683c\u5f0f\u4e3a br-NAME \uff09\u7684 OVS \u7f51\u6865\uff0c\u5e76\u5c06\u6307\u5b9a\u7684\u8282\u70b9\u7f51\u5361\u6865\u63a5\u81f3\u6b64\u7f51\u6865\u3002 excludeNodes \u4e2d\u7684\u8282\u70b9\u4f1a\u88ab\u6dfb\u52a0 net1.provider-network.ovn.kubernetes.io/exclude=true \u6807\u7b7e\uff0c\u5176\u5b83\u8282\u70b9\u4f1a\u88ab\u6dfb\u52a0\u5982\u4e0b\u6807\u7b7e\uff1a Key Value \u63cf\u8ff0 net1.provider-network.ovn.kubernetes.io/ready true \u8282\u70b9\u4e2d\u7684\u6865\u63a5\u5de5\u4f5c\u5df2\u5b8c\u6210\uff0cProviderNetwork \u5728\u8282\u70b9\u4e2d\u53ef\u7528 net1.provider-network.ovn.kubernetes.io/interface eth1 \u8282\u70b9\u4e2d\u88ab\u6865\u63a5\u7684\u7f51\u5361\u7684\u540d\u79f0 net1.provider-network.ovn.kubernetes.io/mtu 1500 \u8282\u70b9\u4e2d\u88ab\u6865\u63a5\u7684\u7f51\u5361\u7684 MTU \u5982\u679c\u8282\u70b9\u7f51\u5361\u4e0a\u5df2\u7ecf\u914d\u7f6e\u4e86 IP\uff0c\u5219 IP \u5730\u5740\u548c\u7f51\u5361\u4e0a\u7684\u8def\u7531\u4f1a\u88ab\u8f6c\u79fb\u81f3\u5bf9\u5e94\u7684 OVS \u7f51\u6865\u3002 \u521b\u5efa VLAN \u521b\u5efa\u5982\u4e0b VLAN \u5e76\u5e94\u7528\uff1a apiVersion: kubeovn.io/v1 kind: Vlan metadata: name: vlan1 spec: id: 0 provider: net1 id \u4e3a VLAN ID/Tag\uff0c provider \u4e3a\u9700\u8981\u4f7f\u7528\u7684 ProviderNetwork \u7684\u540d\u79f0\u3002\u591a\u4e2a VLAN \u53ef\u4ee5\u5f15\u7528\u540c\u4e00\u4e2a ProviderNetwork\u3002 \u521b\u5efa Subnet \u793a\u4f8b\u5982\u4e0b\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: subnet1 spec: cidrBlock: 172.17.0.0/16 gateway: 172.17.0.1 vlan: vlan1 \u5c06 vlan \u7684\u503c\u6307\u5b9a\u4e3a\u9700\u8981\u4f7f\u7528\u7684 VLAN \u540d\u79f0\u5373\u53ef\u3002\u591a\u4e2a Subnet \u53ef\u4ee5\u5f15\u7528\u540c\u4e00\u4e2a VLAN\u3002 \u5bb9\u5668\u521b\u5efa \u53ef\u6309\u6b63\u5e38\u5bb9\u5668\u521b\u5efa\u65b9\u5f0f\u8fdb\u884c\u521b\u5efa\uff0c\u67e5\u770b\u5bb9\u5668 IP \u662f\u5426\u5728\u89c4\u5b9a\u8303\u56f4\u5185\uff0c\u4ee5\u53ca\u5bb9\u5668\u662f\u5426\u53ef\u4ee5\u548c\u7269\u7406\u7f51\u7edc\u4e92\u901a\u3002 \u5982\u6709\u56fa\u5b9a IP \u9700\u6c42\uff0c\u53ef\u53c2\u8003 Pod \u56fa\u5b9a IP \u548c Mac \u4f7f\u7528\u903b\u8f91\u7f51\u5173 \u5bf9\u4e8e\u7269\u7406\u7f51\u7edc\u4e0d\u5b58\u5728\u7f51\u5173\u7684\u60c5\u51b5\uff0cKube-OVN \u652f\u6301\u5728 Underlay \u6a21\u5f0f\u7684\u5b50\u7f51\u4e2d\u914d\u7f6e\u4f7f\u7528\u903b\u8f91\u7f51\u5173\u3002 \u82e5\u8981\u4f7f\u7528\u6b64\u529f\u80fd\uff0c\u8bbe\u7f6e\u5b50\u7f51\u7684 spec.logicalGateway \u4e3a true \u5373\u53ef\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: subnet1 spec: cidrBlock: 172.17.0.0/16 gateway: 172.17.0.1 vlan: vlan1 logicalGateway: true \u5f00\u542f\u6b64\u529f\u80fd\u540e\uff0cPod \u4e0d\u4f7f\u7528\u5916\u90e8\u7f51\u5173\uff0c\u800c\u662f\u4f7f\u7528 Kube-OVN \u521b\u5efa\u7684\u903b\u8f91\u8def\u7531\u5668\uff08Logical Router\uff09\u3002\u5bf9\u4e8e\u8de8\u7f51\u6bb5\u901a\u4fe1\uff0c\u7531\u903b\u8f91\u8def\u7531\u5668\u8fdb\u884c\u8f6c\u53d1\u3002","title":"Underlay \u7f51\u7edc\u5b89\u88c5"},{"location":"start/underlay/#underlay","text":"\u9ed8\u8ba4\u60c5\u51b5\u4e0b Kube-OVN \u7684\u9ed8\u8ba4\u5b50\u7f51\u4f7f\u7528 Geneve \u5bf9\u8de8\u4e3b\u673a\u6d41\u91cf\u8fdb\u884c\u5c01\u88c5\uff0c\u5728\u57fa\u7840\u8bbe\u65bd\u4e4b\u4e0a\u62bd\u8c61\u51fa\u4e00\u5c42\u865a\u62df\u7684 Overlay \u7f51\u7edc\u3002 \u5bf9\u4e8e\u5e0c\u671b\u5bb9\u5668\u7f51\u7edc\u76f4\u63a5\u4f7f\u7528\u7269\u7406\u7f51\u7edc\u5730\u5740\u6bb5\u60c5\u51b5\uff0c\u53ef\u4ee5\u5c06 Kube-OVN \u7684\u9ed8\u8ba4\u5b50\u7f51\u5de5\u4f5c\u5728 Underlay \u6a21\u5f0f\uff0c\u53ef\u4ee5\u76f4\u63a5\u7ed9\u5bb9\u5668\u5206\u914d\u7269\u7406\u7f51\u7edc\u4e2d\u7684\u5730\u5740\u8d44\u6e90\uff0c\u8fbe\u5230\u66f4\u597d\u7684\u6027\u80fd\u4ee5\u53ca\u548c\u7269\u7406\u7f51\u7edc\u7684\u8fde\u901a\u6027\u3002","title":"Underlay \u7f51\u7edc\u5b89\u88c5"},{"location":"start/underlay/#_1","text":"\u8be5\u6a21\u5f0f\u4e0b Kube-OVN \u7f51\u7edc\u8868\u73b0\u548c Macvlan \u7c7b\u4f3c\uff0c\u4f46\u76f8\u6bd4 Macvlan \u63d0\u4f9b\u4e86\u5730\u5740\u7ba1\u7406\uff0c\u56fa\u5b9aIP\uff0c\u670d\u52a1\u53d1\u73b0\uff0c\u7f51\u7edc\u7b56\u7565\u548c QoS \u7b49\u529f\u80fd\u3002 \u4f46\u7531\u4e8e\u8be5\u6a21\u5f0f\u4e0b\u5bb9\u5668\u7f51\u7edc\u76f4\u63a5\u4f7f\u7528\u7269\u7406\u7f51\u7edc\u8d44\u6e90\u8fdb\u884c\u5305\u8f6c\u53d1\uff0cOverlay \u6a21\u5f0f\u4e0b\u7684 SNAT/EIP\uff0c \u5206\u5e03\u5f0f\u7f51\u5173/\u96c6\u4e2d\u5f0f\u7f51\u5173\u7b49 L3 \u529f\u80fd\u65e0\u6cd5\u4f7f\u7528\u3002","title":"\u529f\u80fd\u9650\u5236"},{"location":"start/underlay/#macvlan","text":"Kube-OVN \u7684 Underlay \u6a21\u5f0f\u548c Macvlan \u5de5\u4f5c\u6a21\u5f0f\u5341\u5206\u7c7b\u4f3c\uff0c\u5728\u529f\u80fd\u548c\u6027\u80fd\u4e0a\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u4e2a\u533a\u522b\uff1a \u7531\u4e8e Macvlan \u7684\u5185\u6838\u8def\u5f84\u66f4\u77ed\uff0c\u5e76\u4e14\u4e0d\u9700\u8981 OVS \u5bf9\u6570\u636e\u5305\u8fdb\u884c\u5904\u7406\uff0cMacvlan \u5728\u541e\u5410\u91cf\u548c\u5ef6\u8fdf\u6027\u80fd\u6307\u6807\u4e0a\u8868\u73b0\u4f1a\u66f4\u597d\u3002 Kube-OVN \u901a\u8fc7\u6d41\u8868\u63d0\u4f9b\u4e86 arp-proxy \u529f\u80fd\uff0c\u53ef\u4ee5\u7f13\u89e3\u5927\u89c4\u6a21\u7f51\u7edc\u4e0b\u7684 arp \u5e7f\u64ad\u98ce\u66b4\u98ce\u9669\u3002 \u7531\u4e8e Macvlan \u5de5\u4f5c\u5728\u5185\u6838\u5e95\u5c42\uff0c\u4f1a\u7ed5\u8fc7\u5bbf\u4e3b\u673a\u7684 netfilter\uff0cService \u548c NetworkPolicy \u529f\u80fd\u9700\u8981\u989d\u5916\u5f00\u53d1\u3002Kube-OVN \u901a\u8fc7 OVS \u6d41\u8868\u63d0\u4f9b\u4e86 Service \u548c NetworkPolicy \u7684\u80fd\u529b\u3002","title":"\u548c Macvlan \u6bd4\u8f83"},{"location":"start/underlay/#_2","text":"\u5728 Underlay \u6a21\u5f0f\u4e0b\uff0c OVS \u5c06\u4f1a\u6865\u63a5\u4e00\u4e2a\u8282\u70b9\u7f51\u5361\u5230 OVS \u7f51\u6865\uff0c\u5e76\u5c06\u6570\u636e\u5305\u76f4\u63a5\u901a\u8fc7\u8be5\u8282\u70b9\u7f51\u5361\u5bf9\u5916\u53d1\u9001\uff0cL2/L3 \u5c42\u9762\u7684\u8f6c\u53d1\u80fd\u529b\u9700\u8981\u4f9d\u8d56\u5e95\u5c42\u7f51\u7edc\u8bbe\u5907\u3002 \u9700\u8981\u9884\u5148\u5728\u5e95\u5c42\u7f51\u7edc\u8bbe\u5907\u914d\u7f6e\u5bf9\u5e94\u7684\u7f51\u5173\u3001Vlan \u548c\u5b89\u5168\u7b56\u7565\u7b49\u914d\u7f6e\u3002 \u5bf9\u4e8e OpenStack \u7684 VM \u73af\u5883\uff0c\u9700\u8981\u5c06\u5bf9\u5e94\u7f51\u7edc\u7aef\u53e3\u7684 PortSecurity \u5173\u95ed\u3002 \u5bf9\u4e8e VMware \u7684 vswtich \u7f51\u7edc\uff0c\u9700\u8981\u5c06 MAC Address Changes , Forged Transmits \u548c Promiscuous Mode Operation \u8bbe\u7f6e\u4e3a allow \u3002 \u516c\u6709\u4e91\uff0c\u4f8b\u5982 AWS\u3001GCE\u3001\u963f\u91cc\u4e91\u7b49\u7531\u4e8e\u4e0d\u652f\u6301\u7528\u6237\u81ea\u5b9a\u4e49 Mac \u65e0\u6cd5\u652f\u6301 Underlay \u6a21\u5f0f\u7f51\u7edc\u3002 \u5bf9\u4e8e Service \u8bbf\u95ee\u6d41\u91cf\uff0cPod \u4f1a\u5c06\u6570\u636e\u5305\u9996\u5148\u53d1\u9001\u81f3\u7f51\u5173\uff0c\u7f51\u5173\u9700\u8981\u6709\u80fd\u5c06\u6570\u636e\u5305\u8f6c\u53d1\u56de\u672c\u7f51\u6bb5\u7684\u80fd\u529b\u3002 \u5bf9\u4e8e\u7ba1\u7406\u7f51\u548c\u5bb9\u5668\u7f51\u4f7f\u7528\u540c\u4e00\u4e2a\u7f51\u5361\u7684\u60c5\u51b5\u4e0b\uff0cKube-OVN \u4f1a\u5c06\u7f51\u5361\u7684 Mac \u5730\u5740\u3001IP \u5730\u5740\u3001\u8def\u7531\u4ee5\u53ca MTU \u5c06\u8f6c\u79fb\u6216\u590d\u5236\u81f3\u5bf9\u5e94\u7684 OVS Bridge\uff0c \u4ee5\u652f\u6301\u5355\u7f51\u5361\u90e8\u7f72 Underlay \u7f51\u7edc\u3002OVS Bridge \u540d\u79f0\u683c\u5f0f\u4e3a br-PROVIDER_NAME \uff0c PROVIDER_NAME \u4e3a Provider \u7f51\u7edc\u540d\u79f0\uff08\u9ed8\u8ba4\u4e3a provider\uff09\u3002","title":"\u786c\u4ef6\u73af\u5883\u8981\u6c42"},{"location":"start/underlay/#_3","text":"","title":"\u5b89\u88c5\u65b9\u5f0f"},{"location":"start/underlay/#_4","text":"\u8be5\u90e8\u7f72\u6a21\u5f0f\u5c06\u9ed8\u8ba4\u5b50\u7f51\u8bbe\u7f6e\u4e3a Underlay \u6a21\u5f0f\uff0c\u6240\u6709\u672a\u6307\u5b9a\u5b50\u7f51\u7684 Pod \u5747\u4f1a\u9ed8\u8ba4\u8fd0\u884c\u5728 Underlay \u7f51\u7edc\u4e2d","title":"\u90e8\u7f72\u65f6\u6307\u5b9a\u7f51\u7edc\u6a21\u5f0f"},{"location":"start/underlay/#_5","text":"wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.10/dist/images/install.sh","title":"\u4e0b\u8f7d\u5b89\u88c5\u811a\u672c"},{"location":"start/underlay/#_6","text":"NETWORK_TYPE # \u8bbe\u7f6e\u4e3a vlan VLAN_INTERFACE_NAME # \u8bbe\u7f6e\u4e3a\u5bbf\u4e3b\u673a\u4e0a\u627f\u62c5\u5bb9\u5668\u6d41\u91cf\u7684\u7f51\u5361\uff0c\u4f8b\u5982 eth1 VLAN_ID # \u4ea4\u6362\u673a\u6240\u63a5\u53d7\u7684 VLAN Tag\uff0c\u82e5\u8bbe\u7f6e\u4e3a 0 \u5219\u4e0d\u505a VLAN \u5c01\u88c5 POD_CIDR # \u8bbe\u7f6e\u4e3a\u7269\u7406\u7f51\u7edc CIDR\uff0c \u4f8b\u5982 192.168.1.0/24 POD_GATEWAY # \u8bbe\u7f6e\u4e3a\u7269\u7406\u7f51\u7edc\u7f51\u5173\uff0c\u4f8b\u5982192.168.1.1 EXCLUDE_IPS # \u6392\u9664\u8303\u56f4\uff0c\u907f\u514d\u5bb9\u5668\u7f51\u6bb5\u548c\u7269\u7406\u7f51\u7edc\u5df2\u7528 IP \u51b2\u7a81\uff0c\u4f8b\u5982 192.168.1.1..192.168.1.100","title":"\u4fee\u6539\u811a\u672c\u4e2d\u76f8\u5e94\u914d\u7f6e"},{"location":"start/underlay/#_7","text":"bash install.sh","title":"\u8fd0\u884c\u5b89\u88c5\u811a\u672c"},{"location":"start/underlay/#crd-underlay","text":"\u8be5\u65b9\u5f0f\u53ef\u5728\u5b89\u88c5\u540e\u52a8\u6001\u7684\u521b\u5efa\u67d0\u4e2a Underlay \u5b50\u7f51\u4f9b Pod \u4f7f\u7528\u3002","title":"\u901a\u8fc7 CRD \u52a8\u6001\u521b\u5efa Underlay \u7f51\u7edc"},{"location":"start/underlay/#providernetwork","text":"\u521b\u5efa\u5982\u4e0b ProviderNetwork \u5e76\u5e94\u7528: apiVersion: kubeovn.io/v1 kind: ProviderNetwork metadata: name: net1 spec: defaultInterface: eth1 customInterfaces: - interface: eth2 nodes: - node1 excludeNodes: - node2 \u6ce8\u610f\uff1aProviderNetwork \u8d44\u6e90\u540d\u79f0\u7684\u957f\u5ea6\u4e0d\u5f97\u8d85\u8fc7 12\u3002 defaultInterface \u4e3a\u9ed8\u8ba4\u4f7f\u7528\u7684\u8282\u70b9\u7f51\u5361\u540d\u79f0\uff1b customInterfaces \u4e3a\u53ef\u9009\u9879\uff0c\u53ef\u9488\u5bf9\u7279\u5b9a\u8282\u70b9\u6307\u5b9a\u9700\u8981\u4f7f\u7528\u7684\u7f51\u5361\uff1b excludeNodes \u4e5f\u662f\u53ef\u9009\u9879\uff0c\u7528\u4e8e\u6307\u5b9a\u4e0d\u6865\u63a5\u7f51\u5361\u7684\u8282\u70b9\u3002 ProviderNetwork \u521b\u5efa\u6210\u529f\u540e\uff0c\u5404\u8282\u70b9\uff08\u9664 excludeNodes \u5916\uff09\u4e2d\u4f1a\u521b\u5efa\u540d\u4e3a br-net1\uff08\u683c\u5f0f\u4e3a br-NAME \uff09\u7684 OVS \u7f51\u6865\uff0c\u5e76\u5c06\u6307\u5b9a\u7684\u8282\u70b9\u7f51\u5361\u6865\u63a5\u81f3\u6b64\u7f51\u6865\u3002 excludeNodes \u4e2d\u7684\u8282\u70b9\u4f1a\u88ab\u6dfb\u52a0 net1.provider-network.ovn.kubernetes.io/exclude=true \u6807\u7b7e\uff0c\u5176\u5b83\u8282\u70b9\u4f1a\u88ab\u6dfb\u52a0\u5982\u4e0b\u6807\u7b7e\uff1a Key Value \u63cf\u8ff0 net1.provider-network.ovn.kubernetes.io/ready true \u8282\u70b9\u4e2d\u7684\u6865\u63a5\u5de5\u4f5c\u5df2\u5b8c\u6210\uff0cProviderNetwork \u5728\u8282\u70b9\u4e2d\u53ef\u7528 net1.provider-network.ovn.kubernetes.io/interface eth1 \u8282\u70b9\u4e2d\u88ab\u6865\u63a5\u7684\u7f51\u5361\u7684\u540d\u79f0 net1.provider-network.ovn.kubernetes.io/mtu 1500 \u8282\u70b9\u4e2d\u88ab\u6865\u63a5\u7684\u7f51\u5361\u7684 MTU \u5982\u679c\u8282\u70b9\u7f51\u5361\u4e0a\u5df2\u7ecf\u914d\u7f6e\u4e86 IP\uff0c\u5219 IP \u5730\u5740\u548c\u7f51\u5361\u4e0a\u7684\u8def\u7531\u4f1a\u88ab\u8f6c\u79fb\u81f3\u5bf9\u5e94\u7684 OVS \u7f51\u6865\u3002","title":"\u521b\u5efa ProviderNetwork"},{"location":"start/underlay/#vlan","text":"\u521b\u5efa\u5982\u4e0b VLAN \u5e76\u5e94\u7528\uff1a apiVersion: kubeovn.io/v1 kind: Vlan metadata: name: vlan1 spec: id: 0 provider: net1 id \u4e3a VLAN ID/Tag\uff0c provider \u4e3a\u9700\u8981\u4f7f\u7528\u7684 ProviderNetwork \u7684\u540d\u79f0\u3002\u591a\u4e2a VLAN \u53ef\u4ee5\u5f15\u7528\u540c\u4e00\u4e2a ProviderNetwork\u3002","title":"\u521b\u5efa VLAN"},{"location":"start/underlay/#subnet","text":"\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: subnet1 spec: cidrBlock: 172.17.0.0/16 gateway: 172.17.0.1 vlan: vlan1 \u5c06 vlan \u7684\u503c\u6307\u5b9a\u4e3a\u9700\u8981\u4f7f\u7528\u7684 VLAN \u540d\u79f0\u5373\u53ef\u3002\u591a\u4e2a Subnet \u53ef\u4ee5\u5f15\u7528\u540c\u4e00\u4e2a VLAN\u3002","title":"\u521b\u5efa Subnet"},{"location":"start/underlay/#_8","text":"\u53ef\u6309\u6b63\u5e38\u5bb9\u5668\u521b\u5efa\u65b9\u5f0f\u8fdb\u884c\u521b\u5efa\uff0c\u67e5\u770b\u5bb9\u5668 IP \u662f\u5426\u5728\u89c4\u5b9a\u8303\u56f4\u5185\uff0c\u4ee5\u53ca\u5bb9\u5668\u662f\u5426\u53ef\u4ee5\u548c\u7269\u7406\u7f51\u7edc\u4e92\u901a\u3002 \u5982\u6709\u56fa\u5b9a IP \u9700\u6c42\uff0c\u53ef\u53c2\u8003 Pod \u56fa\u5b9a IP \u548c Mac","title":"\u5bb9\u5668\u521b\u5efa"},{"location":"start/underlay/#_9","text":"\u5bf9\u4e8e\u7269\u7406\u7f51\u7edc\u4e0d\u5b58\u5728\u7f51\u5173\u7684\u60c5\u51b5\uff0cKube-OVN \u652f\u6301\u5728 Underlay \u6a21\u5f0f\u7684\u5b50\u7f51\u4e2d\u914d\u7f6e\u4f7f\u7528\u903b\u8f91\u7f51\u5173\u3002 \u82e5\u8981\u4f7f\u7528\u6b64\u529f\u80fd\uff0c\u8bbe\u7f6e\u5b50\u7f51\u7684 spec.logicalGateway \u4e3a true \u5373\u53ef\uff1a apiVersion: kubeovn.io/v1 kind: Subnet metadata: name: subnet1 spec: cidrBlock: 172.17.0.0/16 gateway: 172.17.0.1 vlan: vlan1 logicalGateway: true \u5f00\u542f\u6b64\u529f\u80fd\u540e\uff0cPod \u4e0d\u4f7f\u7528\u5916\u90e8\u7f51\u5173\uff0c\u800c\u662f\u4f7f\u7528 Kube-OVN \u521b\u5efa\u7684\u903b\u8f91\u8def\u7531\u5668\uff08Logical Router\uff09\u3002\u5bf9\u4e8e\u8de8\u7f51\u6bb5\u901a\u4fe1\uff0c\u7531\u903b\u8f91\u8def\u7531\u5668\u8fdb\u884c\u8f6c\u53d1\u3002","title":"\u4f7f\u7528\u903b\u8f91\u7f51\u5173"},{"location":"start/uninstall/","text":"\u5378\u8f7d \u5982\u679c\u9700\u8981\u5220\u9664 Kube-OVN \u5e76\u66f4\u6362\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\uff0c\u8bf7\u6309\u7167\u4e0b\u5217\u7684\u6b65\u9aa4\u5220\u9664\u5bf9\u5e94\u7684 Kube-OVN \u7ec4\u4ef6\u4ee5\u53ca OVS \u914d\u7f6e\uff0c\u4ee5\u907f\u514d\u5bf9\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u4ea7\u751f\u5e72\u6270\u3002 \u4e5f\u6b22\u8fce\u63d0 issue \u8054\u7cfb\u6211\u4eec\u53cd\u9988\u4e0d\u4f7f\u7528 Kube-OVN \u7684\u539f\u56e0\u5e2e\u52a9\u6211\u4eec\u6539\u8fdb\u3002 \u5220\u9664\u5728 Kubernetes \u4e2d\u521b\u5efa\u7684\u8d44\u6e90 \u4e0b\u8f7d\u4e0b\u9762\u7684\u811a\u672c\uff0c\u6267\u884c\u811a\u672c\u5220\u9664\u5728 Kubernetes \u4e2d\u521b\u5efa\u7684\u8d44\u6e90\uff1a wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.9/dist/images/cleanup.sh bash cleanup.sh \u6e05\u7406\u4e3b\u673a\u4e0a\u7684\u65e5\u5fd7\u548c\u914d\u7f6e\u6587\u4ef6 \u5728\u6bcf\u53f0\u673a\u5668\u4e0a\u6267\u884c\u4e0b\u5217\u64cd\u4f5c\uff0c\u6e05\u7406 ovsdb \u4ee5\u53ca openvswitch \u4fdd\u5b58\u7684\u914d\u7f6e\uff1a rm -rf /var/run/openvswitch rm -rf /var/run/ovn rm -rf /etc/origin/openvswitch/ rm -rf /etc/origin/ovn/ rm -rf /etc/cni/net.d/00-kube-ovn.conflist rm -rf /etc/cni/net.d/01-kube-ovn.conflist rm -rf /var/log/openvswitch rm -rf /var/log/ovn \u91cd\u542f\u8282\u70b9 \u91cd\u542f\u673a\u5668\u786e\u4fdd\u5bf9\u5e94\u7684\u7f51\u5361\u4fe1\u606f\uff0ciptable/ipset \u89c4\u5219\u5f97\u4ee5\u6e05\u9664\uff0c\u907f\u514d\u5bf9\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u7684\u5f71\u54cd\uff1a reboot","title":"\u5378\u8f7d"},{"location":"start/uninstall/#_1","text":"\u5982\u679c\u9700\u8981\u5220\u9664 Kube-OVN \u5e76\u66f4\u6362\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\uff0c\u8bf7\u6309\u7167\u4e0b\u5217\u7684\u6b65\u9aa4\u5220\u9664\u5bf9\u5e94\u7684 Kube-OVN \u7ec4\u4ef6\u4ee5\u53ca OVS \u914d\u7f6e\uff0c\u4ee5\u907f\u514d\u5bf9\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u4ea7\u751f\u5e72\u6270\u3002 \u4e5f\u6b22\u8fce\u63d0 issue \u8054\u7cfb\u6211\u4eec\u53cd\u9988\u4e0d\u4f7f\u7528 Kube-OVN \u7684\u539f\u56e0\u5e2e\u52a9\u6211\u4eec\u6539\u8fdb\u3002","title":"\u5378\u8f7d"},{"location":"start/uninstall/#kubernetes","text":"\u4e0b\u8f7d\u4e0b\u9762\u7684\u811a\u672c\uff0c\u6267\u884c\u811a\u672c\u5220\u9664\u5728 Kubernetes \u4e2d\u521b\u5efa\u7684\u8d44\u6e90\uff1a wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.9/dist/images/cleanup.sh bash cleanup.sh","title":"\u5220\u9664\u5728 Kubernetes \u4e2d\u521b\u5efa\u7684\u8d44\u6e90"},{"location":"start/uninstall/#_2","text":"\u5728\u6bcf\u53f0\u673a\u5668\u4e0a\u6267\u884c\u4e0b\u5217\u64cd\u4f5c\uff0c\u6e05\u7406 ovsdb \u4ee5\u53ca openvswitch \u4fdd\u5b58\u7684\u914d\u7f6e\uff1a rm -rf /var/run/openvswitch rm -rf /var/run/ovn rm -rf /etc/origin/openvswitch/ rm -rf /etc/origin/ovn/ rm -rf /etc/cni/net.d/00-kube-ovn.conflist rm -rf /etc/cni/net.d/01-kube-ovn.conflist rm -rf /var/log/openvswitch rm -rf /var/log/ovn","title":"\u6e05\u7406\u4e3b\u673a\u4e0a\u7684\u65e5\u5fd7\u548c\u914d\u7f6e\u6587\u4ef6"},{"location":"start/uninstall/#_3","text":"\u91cd\u542f\u673a\u5668\u786e\u4fdd\u5bf9\u5e94\u7684\u7f51\u5361\u4fe1\u606f\uff0ciptable/ipset \u89c4\u5219\u5f97\u4ee5\u6e05\u9664\uff0c\u907f\u514d\u5bf9\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u7684\u5f71\u54cd\uff1a reboot","title":"\u91cd\u542f\u8282\u70b9"}]}